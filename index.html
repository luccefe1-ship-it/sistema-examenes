<!DOCTYPE html>
<html lang="es">
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
</head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de ExÃ¡menes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .title {
            font-size: 2rem;
            font-weight: bold;
            color: #2d3748;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            margin: 5px;
        }

        .btn-primary { background: #4f46e5; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-info { background: #0ea5e9; color: white; }

        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

        .nav-tabs {
            display: flex;
            margin-bottom: 30px;
            background: #f8fafc;
            border-radius: 12px;
            padding: 5px;
        }

        .nav-tab {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: white;
            color: #4f46e5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            font-weight: 500;
            margin-bottom: 5px;
            color: #374151;
            display: block;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .success { 
            background: #d1fae5; 
            color: #065f46; 
            border-color: #10b981; 
        }

        .error { 
            background: #fee2e2; 
            color: #991b1b; 
            border-color: #ef4444; 
        }

        .three-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .column {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e2e8f0;
        }

        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
        }

        /* Nuevos estilos para checkboxes personalizados */
        .custom-checkbox {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .custom-checkbox:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .custom-checkbox.selected {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .custom-checkbox input[type="checkbox"] {
            transform: scale(1.3);
            accent-color: #3b82f6;
        }

        @media (max-width: 768px) {
            .three-column {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Variables globales
        let state = {
            currentUser: null,
            currentTab: 'upload',
            apiKey: localStorage.getItem('anthropic_api_key') || '',
            questions: JSON.parse(localStorage.getItem('questions') || '[]'),
            topics: JSON.parse(localStorage.getItem('topics') || '[]'),
            selectedImages: [],
            transcribedText: '',
            cleanedText: '',
            selectedTopicForNewQuestions: null,
            selectedTopicFilter: 'all',
            currentTest: null,
            testResults: JSON.parse(localStorage.getItem('testResults') || '[]'),
            currentViewingResult: null
        };

        const users = {
            'demo': { password: 'demo123', name: 'Usuario Demo' }
        };

        // FunciÃ³n principal de renderizado
        function render() {
            const app = document.getElementById('app');
            
            if (!state.currentUser) {
                app.innerHTML = `
                    <div class="container">
                        <div class="login-form">
                            <h2 style="text-align: center; margin-bottom: 30px;">Iniciar SesiÃ³n</h2>
                            <div class="form-group">
                                <label class="form-label">Usuario</label>
                                <input type="text" id="username" class="form-input" placeholder="demo">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ContraseÃ±a</label>
                                <input type="password" id="password" class="form-input" placeholder="demo123">
                            </div>
                            <button onclick="login()" class="btn btn-primary" style="width: 100%;">
                                Iniciar SesiÃ³n
                            </button>
                            <div style="text-align: center; margin-top: 15px; color: #6b7280; font-size: 14px;">
                                Usuario: demo | ContraseÃ±a: demo123
                            </div>
                        </div>
                    </div>
                `;
            } else {
                app.innerHTML = `
                    <div class="container">
                        <div class="header">
                            <div class="title">${state.currentTab === 'questions' ? 'Banco de Preguntas' : (state.currentTab === 'results' ? 'Resultados del Test' : 'Sistema de ExÃ¡menes')}</div>
                            <div>
                                <span style="color: ${state.apiKey ? '#10b981' : '#ef4444'};">
                                    ${state.apiKey ? 'âœ… API Configurada' : 'âŒ Sin API'}
                                </span>
                                <button onclick="configureAPI()" class="btn btn-secondary">API</button>
                                <span style="color: #f59e0b;">ðŸ‘¤ ${state.currentUser.name}</span>
                                <button onclick="logout()" class="btn btn-danger">Salir</button>
                            </div>
                        </div>

                        <div class="nav-tabs">
                            <button class="nav-tab ${state.currentTab === 'upload' ? 'active' : ''}" onclick="setTab('upload')">
                                ðŸ“¤ Subir Test
                            </button>
                            <button class="nav-tab ${state.currentTab === 'questions' ? 'active' : ''}" onclick="setTab('questions')">
                                ðŸ“‹ Banco de Preguntas (${getFilteredQuestions().length})
                            </button>
                            <button class="nav-tab ${state.currentTab === 'test' ? 'active' : ''}" onclick="setTab('test')">
                                ðŸŽ¯ Test Aleatorio
                            </button>
                            <button class="nav-tab ${state.currentTab === 'results' ? 'active' : ''}" onclick="setTab('results')">
                                ðŸ“Š Resultados (${state.testResults.length})
                            </button>
                        </div>

                        <div id="messages"></div>

                        ${renderTabContent()}
                    </div>
                `;
            }
        }

        function renderTabContent() {
            switch(state.currentTab) {
                case 'upload':
                    return renderUploadTab();
                case 'questions':
                    return renderQuestionsTab();
                case 'test':
                    return renderTestTab();
                case 'results':
                    return renderResultsTab();
                default:
                    return '<div>Error: PestaÃ±a no encontrada</div>';
            }
        }

        function renderUploadTab() {
            return `
                <div class="three-column">
                    <div class="column">
                        <h3 style="margin-bottom: 15px;">ðŸ“¤ Subir ImÃ¡genes</h3>
                        <div class="upload-area" onclick="document.getElementById('imageInput').click()">
                            <div>ðŸ“ Seleccionar imÃ¡genes</div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Hasta 10 imÃ¡genes</div>
                            <div style="margin-top: 10px; color: #4f46e5; font-weight: 500;">
                                ${state.selectedImages.length}/10 archivos
                            </div>
                        </div>
                        <input type="file" id="imageInput" style="display: none;" accept="image/*" multiple>
                        
                        ${state.selectedImages.length > 0 ? `
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                                ${state.selectedImages.map((file, i) => `
                                    <div style="position: relative; text-align: center; padding: 10px; background: #f3f4f6; border-radius: 8px;">
                                        <button onclick="removeImage(${i})" style="position: absolute; top: 5px; right: 5px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer;">Ã—</button>
                                        <div style="font-size: 10px; word-break: break-all;">${file.name}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <button onclick="transcribeImages()" class="btn btn-primary" style="width: 100%;" ${state.selectedImages.length === 0 || !state.apiKey ? 'disabled' : ''}>
                            ðŸ¤– 1. Transcribir y Procesar
                        </button>
                        
                        ${state.transcribedText && !state.cleanedText ? `
                            <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; text-align: center;">
                                <span style="color: #92400e;">ðŸ”„ Procesando texto automÃ¡ticamente...</span>
                            </div>
                        ` : ''}
                    </div>

                    <div class="column">
                        <h3 style="margin-bottom: 15px;">ðŸ“ Texto Transcrito</h3>
                        <textarea id="cleanedText" class="textarea" placeholder="El texto procesado aparecerÃ¡ aquÃ­..." readonly>${state.cleanedText}</textarea>
                        
                        <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px;">
                            <h4 style="color: #92400e; margin-bottom: 10px;">ðŸ·ï¸ GestiÃ³n de Temas</h4>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <button onclick="createTopic()" class="btn btn-info" style="width: 100%; padding: 8px; font-size: 13px;">
                                    ðŸ†• Crear Tema
                                </button>
                                
                                <div style="position: relative;">
                                    <select id="topic-selector" onchange="updateSelectedTopic()" style="width: 100%; padding: 8px; border: none; background: #f59e0b; color: white; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer;" ${state.topics.length === 0 ? 'disabled' : ''}>
                                        <option value="">ðŸ·ï¸ Seleccionar Tema</option>
                                        ${state.topics.map(topic => `
                                            <option value="${topic.id}" ${state.selectedTopicForNewQuestions === topic.id ? 'selected' : ''}>
                                                ${topic.name} (${getTopicQuestionCount(topic.id)})
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            ${state.topics.length === 0 ? `
                                <div style="font-size: 12px; color: #78350f; font-style: italic; text-align: center;">
                                    Crea un tema para organizar tus preguntas
                                </div>
                            ` : ''}
                        </div>
                        
                        <button onclick="addToQuestions()" class="btn btn-success" style="width: 100%; margin-top: 10px;" ${!state.cleanedText ? 'disabled' : ''}>
                            ${getAddButtonText()}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderQuestionsTab() {
            const filteredQuestions = getFilteredQuestions();
            
            function getQuestionsTitle() {
                if (state.selectedTopicFilter === 'all') {
                    return 'TODAS LAS PREGUNTAS DEL BANCO';
                } else {
                    const topic = state.topics.find(t => t.id == state.selectedTopicFilter);
                    if (topic) {
                        return `PREGUNTAS ${topic.name.toUpperCase()}`;
                    } else {
                        return 'PREGUNTAS DEL TEMA SELECCIONADO';
                    }
                }
            }
            
            return `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>${getQuestionsTitle()} (${filteredQuestions.length})</h2>
                    <button onclick="clearQuestions()" class="btn btn-danger">Limpiar Todo</button>
                </div>

                ${state.topics.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <label style="margin-right: 10px; font-weight: 500;">Filtrar por tema:</label>
                        <select onchange="filterByTopic(this.value)" style="padding: 8px; border-radius: 6px; border: 1px solid #d1d5db;">
                            <option value="all" ${state.selectedTopicFilter === 'all' ? 'selected' : ''}>Todos los temas (${state.questions.length})</option>
                            ${state.topics.map(topic => `
                                <option value="${topic.id}" ${state.selectedTopicFilter == topic.id ? 'selected' : ''}>
                                    ${topic.name} (${getTopicQuestionCount(topic.id)})
                                </option>
                            `).join('')}
                        </select>
                    </div>
                ` : ''}

                ${state.topics.length > 0 && state.selectedTopicFilter === 'all' ? 
                    renderQuestionsByTopic() : 
                    renderQuestionsFiltered(filteredQuestions)
                }
            `;
        }

        function renderQuestionsByTopic() {
            const questionsWithoutTopic = state.questions.filter(q => !q.topicId);
            
            let html = '';
            
            // Mostrar preguntas por cada tema que TENGA preguntas
            state.topics.forEach(topic => {
                const topicQuestions = state.questions.filter(q => q.topicId && q.topicId.toString() === topic.id.toString());
                if (topicQuestions.length > 0) {
                    html += `
                        <div style="margin-bottom: 30px;">
                            <h3 style="background: #4f46e5; color: white; padding: 10px 15px; border-radius: 8px 8px 0 0; margin: 0; display: flex; justify-content: space-between; align-items: center;">
                                <span>ðŸ“ ${topic.name}</span>
                                <span style="font-size: 14px; opacity: 0.9;">${topicQuestions.length} preguntas</span>
                            </h3>
                            <div style="border: 1px solid #4f46e5; border-top: none; border-radius: 0 0 8px 8px; background: white;">
                                ${topicQuestions.map(q => {
                                    const actualIndex = state.questions.findIndex(question => question.id === q.id);
                                    return renderSingleQuestion(q, actualIndex);
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
            });
            
            // Mostrar preguntas sin tema asignado SI existen
            if (questionsWithoutTopic.length > 0) {
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="background: #6b7280; color: white; padding: 10px 15px; border-radius: 8px 8px 0 0; margin: 0; display: flex; justify-content: space-between; align-items: center;">
                            <span>ðŸ“‚ Sin tema asignado</span>
                            <span style="font-size: 14px; opacity: 0.9;">${questionsWithoutTopic.length} preguntas</span>
                        </h3>
                        <div style="border: 1px solid #6b7280; border-top: none; border-radius: 0 0 8px 8px; background: white;">
                            ${questionsWithoutTopic.map(q => {
                                const actualIndex = state.questions.findIndex(question => question.id === q.id);
                                return renderSingleQuestion(q, actualIndex);
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Si no hay preguntas en absoluto
            if (html === '') {
                return '<div style="padding: 40px; text-align: center; color: #9ca3af;">No hay preguntas disponibles en el banco</div>';
            }
            
            return html;
        }

        function renderQuestionsFiltered(filteredQuestions) {
            return `
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; background: white;">
                    ${filteredQuestions.length === 0 ? 
                        '<div style="padding: 40px; text-align: center; color: #9ca3af;">No hay preguntas disponibles</div>' :
                        filteredQuestions.map(q => {
                            const actualIndex = state.questions.findIndex(question => question.id === q.id);
                            return renderSingleQuestion(q, actualIndex);
                        }).join('')
                    }
                </div>
            `;
        }

        function renderSingleQuestion(q, actualIndex) {
            const topicName = q.topicId ? getTopicName(q.topicId) : null;
            
            return `
                <div style="padding: 15px; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between;">
                    <div style="flex: 1; display: flex; gap: 8px;">
                        ${q.isVerified ? '<span style="color: #3b82f6; font-size: 16px; filter: drop-shadow(0 0 2px rgba(59, 130, 246, 0.5)); flex-shrink: 0; margin-top: 2px;" title="Pregunta verificada">â­</span>' : '<span style="width: 16px; flex-shrink: 0;"></span>'}
                        <div style="flex: 1;">
                            <div style="font-weight: 500; margin-bottom: 8px;">
                                ${q.question}
                                ${topicName && state.selectedTopicFilter === 'all' && state.selectedTopicFilter !== q.topicId ? `<span style="background: #e0e7ff; color: #4f46e5; padding: 2px 6px; border-radius: 8px; font-size: 11px; margin-left: 8px;">${topicName}</span>` : ''}
                            </div>
                            <ul style="list-style: none; margin: 0; padding: 0;">
                                ${q.options.map((opt, optIndex) => `
                                    <li style="padding: 2px 0; color: ${q.correctAnswer === optIndex ? '#059669' : '#6b7280'}; ${q.correctAnswer === optIndex ? 'font-weight: 500;' : ''}">
                                        ${String.fromCharCode(97 + optIndex)}) ${opt}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                    <div style="display: flex; gap: 5px; align-items: flex-start;">
                        <button onclick="toggleVerified(${actualIndex})" class="btn ${q.isVerified ? 'btn-primary' : 'btn-secondary'}" style="padding: 4px 8px; font-size: 14px; ${q.isVerified ? 'background: linear-gradient(135deg, #3b82f6, #1d4ed8);' : ''}" title="${q.isVerified ? 'Pregunta verificada - Click para desmarcar' : 'Marcar como verificada'}">
                            ${q.isVerified ? 'â­' : 'â˜†'}
                        </button>
                        <button onclick="editQuestion(${actualIndex})" class="btn btn-warning" style="padding: 5px 10px; font-size: 12px;">Editar</button>
                        <button onclick="deleteQuestion(${actualIndex})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">Eliminar</button>
                    </div>
                </div>
            `;
        }

        function renderTestTab() {
            if (state.questions.length === 0) {
                return '<div style="text-align: center; padding: 40px;">AÃ±ade preguntas al banco para generar tests</div>';
            }

            if (!state.currentTest) {
                return `
                    <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="color: #0c4a6e; margin-bottom: 15px;">ðŸŽ¯ ConfiguraciÃ³n del Test</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">NÃºmero de preguntas:</label>
                                <select id="test-questions-count" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <option value="5">5 preguntas</option>
                                    <option value="10" selected>10 preguntas</option>
                                    <option value="15">15 preguntas</option>
                                    <option value="20">20 preguntas</option>
                                    <option value="all">Todas las preguntas disponibles</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">DuraciÃ³n:</label>
                                <select id="test-duration" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <option value="300">5 minutos</option>
                                    <option value="600" selected>10 minutos</option>
                                    <option value="900">15 minutos</option>
                                    <option value="1200">20 minutos</option>
                                    <option value="1800">30 minutos</option>
                                    <option value="0">Sin lÃ­mite de tiempo</option>
                                </select>
                            </div>
                        </div>

                        ${state.topics.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 15px; font-weight: 500;">SelecciÃ³n de temas:</label>
                                <div style="display: grid; gap: 8px;">
                                    <div class="custom-checkbox" onclick="toggleGeneralTest()">
                                        <input type="checkbox" id="test-general" onchange="handleGeneralTestChange(this)" checked>
                                        <span style="font-weight: 500;">Test General (${state.questions.length} preguntas)</span>
                                    </div>
                                    ${state.topics.map(topic => `
                                        <div class="custom-checkbox" onclick="toggleTopicTest('${topic.id}')">
                                            <input type="checkbox" class="topic-checkbox" data-topic-id="${topic.id}" onchange="handleTopicChange()">
                                            <span>${topic.name} (${getTopicQuestionCount(topic.id)} preguntas)</span>
                                        </div>
                                    `).join('')}
                                </div>
                                <div style="margin-top: 15px; padding: 10px; background: #f3f4f6; border-radius: 6px; font-size: 14px; color: #6b7280;">
                                    ðŸ’¡ <strong>Consejo:</strong> Puedes seleccionar mÃºltiples temas para crear un test combinado, o elegir "Test General" para incluir todas las preguntas.
                                </div>
                            </div>
                        ` : ''}

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Nombre del test:</label>
                            <input type="text" id="test-name" placeholder="Ej: Test de MatemÃ¡ticas - SesiÃ³n 1" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                            <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                                Si no especificas un nombre, se generarÃ¡ automÃ¡ticamente
                            </div>
                        </div>
                    </div>

                    <div style="text-align: center; padding: 40px;">
                        <button onclick="startTest()" class="btn btn-primary" style="font-size: 1.2rem; padding: 15px 30px;">
                            ðŸŽ¯ Comenzar Test
                        </button>
                    </div>
                `;
            }

            return renderCurrentTest();
        }

        function renderCurrentTest() {
            const duration = state.currentTest.duration;
            const hasTimer = duration > 0;
            
            return `
                <div style="max-width: 1000px; margin: 0 auto; position: relative;">
                    ${hasTimer ? `
                        <div id="timer" style="position: fixed; top: 20px; right: 20px; background: white; padding: 15px 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: bold; color: #ef4444; font-size: 1.2rem; z-index: 1000; border: 2px solid #fecaca;">
                            â±ï¸ ${formatTime(state.currentTest.timeLeft)}
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 20px; background: #f8fafc; border-radius: 12px;">
                        <div>
                            <h2 style="margin: 0; color: #1f2937;">${state.currentTest.name}</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280; font-size: 14px;">${state.currentTest.questions.length} preguntas</p>
                            <p style="margin: 5px 0 0 0; color: #6b7280; font-size: 14px;">${state.currentTest.testTypeText}</p>
                        </div>
                        ${hasTimer ? `<div style="color: #6b7280; font-size: 14px;">El tiempo se muestra arriba a la derecha</div>` : ''}
                    </div>
                    
                    <form id="test-form">
                        ${state.currentTest.questions.map((question, questionIndex) => `
                            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; color: #1f2937; flex-wrap: nowrap;">
                                    <span style="color: #4f46e5; flex-shrink: 0;">#${questionIndex + 1}</span>
                                    <span style="flex: 1; min-width: 0;">${question.question}</span>
                                    ${question.isVerified ? '<span style="color: #3b82f6; font-size: 16px; filter: drop-shadow(0 0 2px rgba(59, 130, 246, 0.5)); flex-shrink: 0;" title="Pregunta verificada">â­</span>' : ''}
                                    ${question.topicId && state.currentTest.testType !== question.topicId.toString() ? `<span style="background: #f3f4f6; color: #6b7280; padding: 2px 6px; border-radius: 6px; font-size: 11px; font-weight: 400; flex-shrink: 0; white-space: nowrap;" title="Tema de la pregunta">${getTopicName(question.topicId)}</span>` : ''}
                                </div>
                                
                                <div style="display: grid; gap: 12px;">
                                    ${question.options.map((option, optionIndex) => `
                                        <label style="display: flex; align-items: center; gap: 12px; padding: 15px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 15px;" 
                                               onmouseover="this.style.backgroundColor='#f3f4f6'; this.style.borderColor='#d1d5db';" 
                                               onmouseout="this.style.backgroundColor='#f9fafb'; this.style.borderColor='#e5e7eb';">
                                            <input type="radio" name="question-${questionIndex}" value="${optionIndex}" style="transform: scale(1.2);">
                                            <span><strong>${String.fromCharCode(97 + optionIndex)})</strong> ${option}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </form>
                    
                    <div style="text-align: center; padding: 30px;">
                        <button onclick="finishTest()" class="btn btn-primary" style="font-size: 1.2rem; padding: 15px 40px;">
                            ðŸ Finalizar Test
                        </button>
                    </div>
                </div>
            `;
        }

        function renderResultsTab() {
            if (state.currentViewingResult) {
                // Mostrar resultado especÃ­fico
                return renderSpecificResult(state.currentViewingResult);
            }

            // Mostrar lista de resultados
            if (state.testResults.length === 0) {
                return `
                    <div style="text-align: center; padding: 60px; color: #9ca3af;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">ðŸ“Š</div>
                        <h3 style="color: #6b7280; margin-bottom: 10px;">No hay resultados disponibles</h3>
                        <p style="color: #9ca3af;">Realiza tu primer test para ver los resultados aquÃ­</p>
                    </div>
                `;
            }

            return `
                <div style="max-width: 1000px; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="color: #1f2937; margin: 0;">ðŸ“Š Historial de Tests (${state.testResults.length})</h2>
                        <button onclick="clearTestHistory()" class="btn btn-danger">
                            ðŸ—‘ï¸ Limpiar Historial
                        </button>
                    </div>

                    <div style="display: grid; gap: 20px;">
                        ${state.testResults.map((result, index) => {
                            const percentage = Math.round((result.correct / result.total) * 100);
                            let scoreColor = '#ef4444';
                            let scoreIcon = 'ðŸ“‰';
                            
                            if (percentage >= 90) {
                                scoreColor = '#059669';
                                scoreIcon = 'ðŸŒŸ';
                            } else if (percentage >= 70) {
                                scoreColor = '#0ea5e9';
                                scoreIcon = 'ðŸ‘';
                            } else if (percentage >= 50) {
                                scoreColor = '#f59e0b';
                                scoreIcon = 'âš¡';
                            }

                            return `
                                <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative;" 
                                     onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" 
                                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                                    
                                    <!-- BotÃ³n eliminar individual -->
                                    <button onclick="event.stopPropagation(); deleteIndividualTest(${index})" 
                                            style="position: absolute; top: 10px; right: 10px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.7; transition: opacity 0.2s;" 
                                            onmouseover="this.style.opacity='1'" 
                                            onmouseout="this.style.opacity='0.7'" 
                                            title="Eliminar este test">Ã—</button>
                                    
                                    <div onclick="viewTestResult(${index})" style="width: 100%;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                            <h3 style="margin: 0; color: #1f2937; display: flex; align-items: center; gap: 10px; padding-right: 30px;">
                                                <span style="font-size: 1.2em;">${scoreIcon}</span>
                                                ${result.name}
                                            </h3>
                                            <div style="background: ${scoreColor}; color: white; padding: 6px 12px; border-radius: 20px; font-weight: bold; font-size: 1.1rem;">
                                                ${percentage}%
                                            </div>
                                        </div>

                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                            <div style="text-align: center;">
                                                <div style="font-size: 1.5rem; font-weight: bold; color: #059669;">${result.correct}</div>
                                                <div style="font-size: 12px; color: #6b7280;">Correctas</div>
                                            </div>
                                            <div style="text-align: center;">
                                                <div style="font-size: 1.5rem; font-weight: bold; color: #ef4444;">${result.incorrect}</div>
                                                <div style="font-size: 12px; color: #6b7280;">Incorrectas</div>
                                            </div>
                                            <div style="text-align: center;">
                                                <div style="font-size: 1.5rem; font-weight: bold; color: #f59e0b;">${result.unanswered}</div>
                                                <div style="font-size: 12px; color: #6b7280;">Sin responder</div>
                                            </div>
                                            <div style="text-align: center;">
                                                <div style="font-size: 1.5rem; font-weight: bold; color: #6b7280;">${result.total}</div>
                                                <div style="font-size: 12px; color: #6b7280;">Total</div>
                                            </div>
                                        </div>

                                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: #6b7280;">
                                            <span>${result.testType}</span>
                                            <span>${result.date}</span>
                                        </div>
                                        
                                        ${result.timeUsedText ? `
                                            <div style="font-size: 12px; color: #9ca3af; margin-top: 5px; text-align: right;">
                                                ${result.timeUsedText}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).reverse().join('')}
                    </div>
                </div>
            `;
        }

        function renderSpecificResult(result) {
            const percentage = Math.round((result.correct / result.total) * 100);
            
            // Determinar color y mensaje segÃºn porcentaje
            let scoreColor = '#ef4444'; // Rojo por defecto
            let scoreMessage = 'Â¡Sigue practicando! ðŸ’ª';
            let scoreIcon = 'ðŸ“‰';
            
            if (percentage >= 90) {
                scoreColor = '#059669';
                scoreMessage = 'Â¡Excelente trabajo! ðŸ†';
                scoreIcon = 'ðŸŒŸ';
            } else if (percentage >= 70) {
                scoreColor = '#0ea5e9';
                scoreMessage = 'Â¡Buen desempeÃ±o! ðŸ‘';
                scoreIcon = 'ðŸ‘';
            } else if (percentage >= 50) {
                scoreColor = '#f59e0b';
                scoreMessage = 'Â¡Puedes mejorar! ðŸ“š';
                scoreIcon = 'âš¡';
            }

            return `
                <div style="max-width: 1000px; margin: 0 auto;">
                    <!-- BotÃ³n Volver -->
                    <div style="margin-bottom: 20px;">
                        <button onclick="state.currentViewingResult = null; render();" class="btn btn-secondary">
                            â† Volver al Historial
                        </button>
                    </div>

                    <!-- Header de Resultados -->
                    <div style="text-align: center; background: linear-gradient(135deg, ${scoreColor}15, ${scoreColor}05); border: 2px solid ${scoreColor}30; border-radius: 20px; padding: 40px; margin-bottom: 30px;">
                        <div style="font-size: 4rem; margin-bottom: 15px;">${scoreIcon}</div>
                        <h1 style="color: ${scoreColor}; font-size: 2.5rem; margin: 0 0 10px 0;">${percentage}%</h1>
                        <p style="color: ${scoreColor}; font-size: 1.3rem; font-weight: 600; margin: 0 0 15px 0;">${scoreMessage}</p>
                        <h2 style="color: #6b7280; font-size: 1.2rem; margin: 0;">${result.name}</h2>
                        <p style="color: #6b7280; font-size: 1rem; margin: 5px 0 0 0;">${result.testType}</p>
                        ${result.timeUsedText ? `<p style="color: #6b7280; font-size: 0.9rem; margin: 5px 0 0 0;">${result.timeUsedText}</p>` : ''}
                        <p style="color: #9ca3af; font-size: 0.85rem; margin: 10px 0 0 0;">${result.date}</p>
                    </div>

                    <!-- MÃ©tricas Generales -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="font-size: 2rem; color: #0ea5e9; margin-bottom: 10px;">âœ…</div>
                            <div style="font-size: 1.8rem; font-weight: bold; color: #0c4a6e; margin-bottom: 5px;">${result.correct}</div>
                            <div style="color: #0369a1; font-weight: 500;">Correctas</div>
                        </div>

                        <div style="background: #fef2f2; border: 2px solid #ef4444; border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="font-size: 2rem; color: #ef4444; margin-bottom: 10px;">âŒ</div>
                            <div style="font-size: 1.8rem; font-weight: bold; color: #991b1b; margin-bottom: 5px;">${result.incorrect}</div>
                            <div style="color: #dc2626; font-weight: 500;">Incorrectas</div>
                        </div>

                        <div style="background: #fffbeb; border: 2px solid #f59e0b; border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="font-size: 2rem; color: #f59e0b; margin-bottom: 10px;">â­ï¸</div>
                            <div style="font-size: 1.8rem; font-weight: bold; color: #92400e; margin-bottom: 5px;">${result.unanswered}</div>
                            <div style="color: #d97706; font-weight: 500;">Sin responder</div>
                        </div>

                        <div style="background: #f0fdf4; border: 2px solid #22c55e; border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="font-size: 2rem; color: #22c55e; margin-bottom: 10px;">ðŸ“Š</div>
                            <div style="font-size: 1.8rem; font-weight: bold; color: #166534; margin-bottom: 5px;">${result.total}</div>
                            <div style="color: #16a34a; font-weight: 500;">Total</div>
                        </div>
                    </div>

                    <!-- Barra de Progreso Visual -->
                    <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px; margin-bottom: 30px;">
                        <h3 style="margin: 0 0 20px 0; color: #374151;">ðŸ“ˆ DistribuciÃ³n de Respuestas</h3>
                        <div style="background: #f3f4f6; border-radius: 10px; overflow: hidden; height: 30px; display: flex; margin-bottom: 15px;">
                            <div style="background: #22c55e; width: ${(result.correct/result.total)*100}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
                                ${result.correct > 0 ? `${result.correct}âœ“` : ''}
                            </div>
                            <div style="background: #ef4444; width: ${(result.incorrect/result.total)*100}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
                                ${result.incorrect > 0 ? `${result.incorrect}âœ—` : ''}
                            </div>
                            <div style="background: #f59e0b; width: ${(result.unanswered/result.total)*100}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
                                ${result.unanswered > 0 ? `${result.unanswered}?` : ''}
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 14px; color: #6b7280;">
                            <span>0%</span>
                            <span>50%</span>
                            <span>100%</span>
                        </div>
                    </div>

                    <!-- RevisiÃ³n Detallada -->
                    <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px; margin-bottom: 30px;">
                        <h3 style="margin: 0 0 20px 0; color: #374151;">ðŸ” RevisiÃ³n Detallada</h3>
                        ${result.detailedResults.map((resultItem, index) => `
                            <div style="border: 2px solid ${resultItem.isCorrect ? '#22c55e' : (resultItem.userAnswer !== null ? '#ef4444' : '#f59e0b')}; border-radius: 8px; margin-bottom: 15px; overflow: hidden;">
                                <div style="background: ${resultItem.isCorrect ? '#22c55e' : (resultItem.userAnswer !== null ? '#ef4444' : '#f59e0b')}; color: white; padding: 12px 15px; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 1.1em;">
                                        ${resultItem.isCorrect ? 'âœ…' : (resultItem.userAnswer !== null ? 'âŒ' : 'â­ï¸')}
                                    </span>
                                    <span>Pregunta ${index + 1}</span>
                                    ${resultItem.question.isVerified ? '<span style="filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.8));" title="Pregunta verificada">â­</span>' : ''}
                                </div>
                                <div style="padding: 15px;">
                                    <p style="font-weight: 500; margin: 0 0 15px 0; color: #374151;">${resultItem.question.question}</p>
                                    <div style="display: grid; gap: 8px;">
                                        ${resultItem.question.options.map((option, optIndex) => {
                                            let bgColor = '#f9fafb';
                                            let textColor = '#374151';
                                            let border = '#e5e7eb';
                                            let prefix = '';
                                            
                                            if (optIndex === resultItem.question.correctAnswer) {
                                                bgColor = '#dcfce7';
                                                textColor = '#166534';
                                                border = '#22c55e';
                                                prefix = 'âœ“ ';
                                            }
                                            
                                            if (resultItem.userAnswer === optIndex && optIndex !== resultItem.question.correctAnswer) {
                                                bgColor = '#fee2e2';
                                                textColor = '#991b1b';
                                                border = '#ef4444';
                                                prefix = 'âœ— ';
                                            }
                                            
                                            return `
                                                <div style="background: ${bgColor}; border: 1px solid ${border}; border-radius: 6px; padding: 10px; color: ${textColor};">
                                                    <strong>${String.fromCharCode(97 + optIndex)})</strong> ${prefix}${option}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                    ${resultItem.userAnswer === null ? `
                                        <div style="background: #fffbeb; border: 1px solid #f59e0b; border-radius: 6px; padding: 10px; margin-top: 10px; color: #92400e; text-align: center; font-style: italic;">
                                            No respondida
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Acciones -->
                    <div style="text-align: center; padding: 20px;">
                        <button onclick="startNewTest()" class="btn btn-primary" style="font-size: 1.1rem; padding: 15px 30px; margin: 0 10px;">
                            ðŸŽ¯ Nuevo Test
                        </button>
                        <button onclick="state.currentViewingResult = null; render();" class="btn btn-secondary" style="font-size: 1.1rem; padding: 15px 30px; margin: 0 10px;">
                            ðŸ“Š Ver Historial
                        </button>
                    </div>
                </div>
            `;
        }

        // Event handlers
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (users[username] && users[username].password === password) {
                state.currentUser = users[username];
                render();
                showMessage(`Bienvenido ${users[username].name}`, 'success');
            } else {
                showMessage('Usuario o contraseÃ±a incorrectos', 'error');
            }
        }

        function logout() {
            state.currentUser = null;
            state.currentTab = 'upload';
            render();
        }

        function configureAPI() {
            const key = prompt('Ingresa tu API key de Anthropic:');
            if (key && key.trim()) {
                state.apiKey = key.trim();
                localStorage.setItem('anthropic_api_key', key.trim());
                render();
                showMessage('API key configurada correctamente', 'success');
            }
        }

        function setTab(tab) {
            state.currentTab = tab;
            state.currentViewingResult = null;
            render();
        }

        function createTopic() {
            const name = prompt('Nombre del nuevo tema:');
            if (name && name.trim()) {
                const newTopic = {
                    id: Date.now() + Math.random(),
                    name: name.trim(),
                    createdAt: new Date().toISOString()
                };
                
                state.topics.push(newTopic);
                localStorage.setItem('topics', JSON.stringify(state.topics));
                render();
                showMessage(`Tema "${name}" creado exitosamente`, 'success');
            }
        }

        function updateSelectedTopic() {
            const selector = document.getElementById('topic-selector');
            if (selector && selector.value) {
                // Convertir el valor del selector al tipo correcto
                const selectedValue = selector.value;
                // Buscar el tema para obtener el ID en su formato original
                const selectedTopic = state.topics.find(t => t.id == selectedValue);
                if (selectedTopic) {
                    state.selectedTopicForNewQuestions = selectedTopic.id;
                    showMessage(`Tema "${selectedTopic.name}" seleccionado`, 'success');
                } else {
                    state.selectedTopicForNewQuestions = selectedValue;
                }
            } else {
                state.selectedTopicForNewQuestions = null;
            }
            render();
        }

        function getAddButtonText() {
            if (!state.selectedTopicForNewQuestions) {
                return 'âœ… 2. AÃ±adir al Banco';
            } else {
                const topicName = getTopicName(state.selectedTopicForNewQuestions);
                return `âœ… 2. Asignar a "${topicName}"`;
            }
        }

        function removeImage(index) {
            state.selectedImages.splice(index, 1);
            render();
            
        }

        async function transcribeImages() {
            if (!state.apiKey) {
                showMessage('Configura tu API key primero', 'error');
                return;
            }

            if (state.selectedImages.length === 0) {
                showMessage('Selecciona al menos una imagen', 'error');
                return;
            }

            showMessage('Transcribiendo imÃ¡genes...', 'success');
            
            try {
                let allTranscriptions = [];
                
                const batchSize = 5;
                for (let i = 0; i < state.selectedImages.length; i += batchSize) {
                    const batch = state.selectedImages.slice(i, i + batchSize);
                    
                    const imageContents = await Promise.all(
                        batch.map(async (file) => {
                            const base64 = await fileToBase64(file);
                            return {
                                type: "image",
                                source: {
                                    type: "base64",
                                    media_type: file.type,
                                    data: base64
                                }
                            };
                        })
                    );

                    const messageContent = [
                        ...imageContents,
                        {
                            type: "text",
                            text: `ActÃºa como un transcriptor de texto para una persona ciega. Analiza ${batch.length > 1 ? 'estas imÃ¡genes' : 'esta imagen'} y extrae todo el texto visible de manera secuencial.

INSTRUCCIONES CRÃTICAS:
- Solo dicta las palabras que ves, como si estuvieras hablando en voz alta
- Encuentra las preguntas numeradas y sus opciones de respuesta
- CONSERVA y DESCRIBE todos los sÃ­mbolos visuales de respuesta correcta que veas
- MANTÃ‰N sÃ­mbolos como: âœ“, âœ”, checkmarks, asteriscos, viÃ±etas, flechas
- DESCRIBE elementos visuales importantes: "opciÃ³n marcada en verde", "con tick", "con check", "respuesta correcta", "marcada"
- PRESERVA cualquier indicaciÃ³n visual de que una opciÃ³n es la correcta
- Si hay mÃºltiples imÃ¡genes, procesa cada una en orden
- Separa claramente el contenido de cada imagen

IMPORTANTE: NO elimines sÃ­mbolos de respuesta correcta - los necesitamos para el siguiente paso.

Responde con el texto extraÃ­do conservando TODOS los sÃ­mbolos y marcas visuales.`
                        }
                    ];

                    const response = await fetch("/api/anthropic", {
    method: "POST",
    headers: {
        "Content-Type": "application/json",
        "x-api-key": state.apiKey,
    },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 4000,
                            messages: [{
                                role: "user",
                                content: messageContent
                            }]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Error ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    allTranscriptions.push(data.content[0].text);
                }

                state.transcribedText = allTranscriptions.join('\n\n--- SIGUIENTE IMAGEN ---\n\n');
                
                render();
                showMessage(`TranscripciÃ³n completada. Procesando texto...`, 'success');
                
                // AutomÃ¡ticamente limpiar el texto despuÃ©s de transcribir
                await cleanText();
                
            } catch (error) {
                showMessage(`Error en la transcripciÃ³n: ${error.message}`, 'error');
            }
        }

        async function cleanText() {
            if (!state.transcribedText) {
                showMessage('Primero transcribe las imÃ¡genes', 'error');
                return;
            }

            if (!state.apiKey) {
                showMessage('Configura tu API key primero', 'error');
                return;
            }

            render(); // Mostrar el indicador de procesamiento
            
            try {
                const response = await fetch("/api/anthropic", {
    method: "POST",
    headers: {
        "Content-Type": "application/json",
        "x-api-key": state.apiKey,
    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 4000,
                        messages: [{
                            role: "user",
                            content: `Limpia este texto extraÃ­do de mÃºltiples imÃ¡genes y conviÃ©rtelo en formato de preguntas para banco de preguntas:

TEXTO A LIMPIAR:
${state.transcribedText}

INSTRUCCIONES CRÃTICAS PARA DETECTAR RESPUESTAS CORRECTAS:
- Busca sÃ­mbolos visuales: âœ“, âœ”, *, â€¢, â†’, >, checkmarks, ticks
- Busca descripciones: "marcada", "marcada en verde", "respuesta correcta", "con tick", "con check"
- Busca colores mencionados: "verde", "resaltada", "seleccionada"
- MARCA EN NEGRITA las opciones que tengan cualquiera de estos indicadores usando **texto**
- Elimina los sÃ­mbolos y descripciones visuales DESPUÃ‰S de identificar las correctas
- Extrae solo las preguntas y opciones de respuesta
- Numera las preguntas secuencialmente

FORMATO DE SALIDA ESTRICTO:
PREGUNTA: [texto de la pregunta]
OPCION_A: [opciÃ³n a normal]
OPCION_B: **[opciÃ³n b si tiene sÃ­mbolo/marca de correcta]**
OPCION_C: [opciÃ³n c normal]
OPCION_D: **[opciÃ³n d si tiene sÃ­mbolo/marca de correcta]**

IMPORTANTE: Cualquier opciÃ³n con sÃ­mbolo, marca visual, color verde, o descripciÃ³n de "correcta" debe ir en **negritas**.`
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                state.cleanedText = data.content[0].text;
                
                render();
                showMessage('Â¡Texto procesado y listo para aÃ±adir al banco!', 'success');
                
            } catch (error) {
                showMessage(`Error en la limpieza: ${error.message}`, 'error');
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        function addToQuestions() {
            if (!state.cleanedText) {
                showMessage('Primero procesa el texto', 'error');
                return;
            }

            try {
                const newQuestions = parseCleanedText(state.cleanedText);
                if (newQuestions.length === 0) {
                    showMessage('No se pudieron extraer preguntas del texto limpio', 'error');
                    return;
                }

                if (state.selectedTopicForNewQuestions) {
                    newQuestions.forEach(question => {
                        question.topicId = state.selectedTopicForNewQuestions;
                    });
                    const topicName = getTopicName(state.selectedTopicForNewQuestions);
                    showMessage(`Â¡Se aÃ±adieron ${newQuestions.length} preguntas al tema "${topicName}"!`, 'success');
                } else {
                    showMessage(`Â¡Se aÃ±adieron ${newQuestions.length} preguntas al banco!`, 'success');
                }

                state.questions.push(...newQuestions);
                localStorage.setItem('questions', JSON.stringify(state.questions));
                
                state.selectedImages = [];
                state.transcribedText = '';
                state.cleanedText = '';
                state.selectedTopicForNewQuestions = null;
                
                render();
                
            } catch (error) {
                showMessage(`Error al procesar preguntas: ${error.message}`, 'error');
            }
        }

        function parseCleanedText(text) {
            const questions = [];
            const sections = text.split(/PREGUNTA:/i).filter(section => section.trim());
            
            sections.forEach(section => {
                const lines = section.trim().split('\n').filter(line => line.trim());
                if (lines.length === 0) return;
                
                const questionText = lines[0].trim();
                const options = [];
                let correctAnswer = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line.match(/^OPCION_[A-D]:/i)) {
                        let optionText = line.replace(/^OPCION_[A-D]:/i, '').trim();
                        
                        if (optionText.startsWith('**') && optionText.endsWith('**')) {
                            optionText = optionText.slice(2, -2);
                            correctAnswer = options.length;
                        }
                        
                        if (optionText) {
                            options.push(optionText);
                        }
                    }
                }
                
                if (questionText && options.length >= 2) {
                    questions.push({
                        id: Date.now() + Math.random(),
                        question: questionText,
                        options: options,
                        correctAnswer: correctAnswer,
                        topicId: null
                    });
                }
            });
            
            return questions;
        }

        function toggleVerified(index) {
            if (state.questions[index]) {
                state.questions[index].isVerified = !state.questions[index].isVerified;
                localStorage.setItem('questions', JSON.stringify(state.questions));
                render();
                showMessage(`Pregunta ${state.questions[index].isVerified ? 'verificada' : 'sin verificar'}`, 'success');
            }
        }

        function clearQuestions() {
            if (confirm('Â¿Eliminar todas las preguntas?')) {
                state.questions = [];
                localStorage.setItem('questions', JSON.stringify(state.questions));
                render();
            }
        }

        function deleteQuestion(index) {
            if (confirm('Â¿Eliminar esta pregunta?')) {
                state.questions.splice(index, 1);
                localStorage.setItem('questions', JSON.stringify(state.questions));
                render();
                showMessage('Pregunta eliminada', 'success');
            }
        }

        function editQuestion(index) {
            const question = state.questions[index];
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); display: flex; justify-content: center;
                align-items: center; z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 20px;">Editar Pregunta</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Pregunta:</label>
                        <textarea id="edit-question" style="width: 100%; height: 60px; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">${question.question}</textarea>
                    </div>
                    
                    ${state.topics.length > 0 ? `
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Tema:</label>
                            <select id="edit-topic" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="">Sin tema</option>
                                ${state.topics.map(topic => `
                                    <option value="${topic.id}" ${question.topicId === topic.id ? 'selected' : ''}>
                                        ${topic.name}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 500;">Opciones:</label>
                        ${question.options.map((option, i) => `
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <input type="radio" name="correct" value="${i}" ${question.correctAnswer === i ? 'checked' : ''}>
                                <span style="font-weight: 500; min-width: 20px;">${String.fromCharCode(97 + i)})</span>
                                <input type="text" id="edit-option-${i}" value="${option}" style="flex: 1; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" style="padding: 10px 20px; border: none; background: #6b7280; color: white; border-radius: 6px; cursor: pointer;">
                            Cancelar
                        </button>
                        <button onclick="saveEdit(${index})" style="padding: 10px 20px; border: none; background: #4f46e5; color: white; border-radius: 6px; cursor: pointer;">
                            Guardar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            window.saveEdit = function(qIndex) {
                try {
                    const newQuestion = document.getElementById('edit-question').value.trim();
                    const newOptions = [];
                    
                    for (let i = 0; i < question.options.length; i++) {
                        const optInput = document.getElementById(`edit-option-${i}`);
                        if (optInput && optInput.value.trim()) {
                            newOptions.push(optInput.value.trim());
                        }
                    }
                    
                    const correctRadio = modal.querySelector('input[name="correct"]:checked');
                    const newCorrect = correctRadio ? parseInt(correctRadio.value) : 0;
                    
                    let newTopicId = null;
                    const topicSelect = modal.querySelector('#edit-topic');
                    if (topicSelect && topicSelect.value) {
                        newTopicId = topicSelect.value;
                    }
                    
                    if (!newQuestion || newOptions.length < 2) {
                        alert('Completa todos los campos requeridos');
                        return;
                    }
                    
                    state.questions[qIndex] = {
                        ...state.questions[qIndex],
                        question: newQuestion,
                        options: newOptions,
                        correctAnswer: newCorrect,
                        topicId: newTopicId
                    };
                    
                    localStorage.setItem('questions', JSON.stringify(state.questions));
                    modal.remove();
                    render();
                    showMessage('Pregunta actualizada', 'success');
                    
                } catch (error) {
                    showMessage('Error al guardar: ' + error.message, 'error');
                }
            };
        }

        function filterByTopic(topicId) {
            state.selectedTopicFilter = topicId;
            render(); // Importante: re-renderizar para actualizar el tÃ­tulo
        }

        function getFilteredQuestions() {
            if (state.selectedTopicFilter === 'all') {
                return state.questions;
            }
            return state.questions.filter(q => q.topicId && q.topicId.toString() === state.selectedTopicFilter.toString());
        }

        function getTopicName(topicId) {
            if (!topicId) return 'Sin tema';
            const topic = state.topics.find(t => t.id.toString() === topicId.toString());
            return topic ? topic.name : 'Tema no encontrado';
        }

        function getTopicQuestionCount(topicId) {
            return state.questions.filter(q => q.topicId && q.topicId.toString() === topicId.toString()).length;
        }

        // Nuevas funciones para manejar la selecciÃ³n mÃºltiple de temas
        function toggleGeneralTest() {
            const generalCheckbox = document.getElementById('test-general');
            const topicCheckboxes = document.querySelectorAll('.topic-checkbox');
            
            if (generalCheckbox.checked) {
                // Si se marca "Test General", desmarcar todos los temas
                topicCheckboxes.forEach(cb => {
                    cb.checked = false;
                    cb.closest('.custom-checkbox').classList.remove('selected');
                });
                generalCheckbox.closest('.custom-checkbox').classList.add('selected');
            } else {
                generalCheckbox.closest('.custom-checkbox').classList.remove('selected');
            }
        }

        function toggleTopicTest(topicId) {
            const topicCheckbox = document.querySelector(`.topic-checkbox[data-topic-id="${topicId}"]`);
            const generalCheckbox = document.getElementById('test-general');
            
            if (topicCheckbox.checked) {
                topicCheckbox.checked = false;
                topicCheckbox.closest('.custom-checkbox').classList.remove('selected');
            } else {
                topicCheckbox.checked = true;
                topicCheckbox.closest('.custom-checkbox').classList.add('selected');
                // Si se marca algÃºn tema, desmarcar "Test General"
                if (generalCheckbox.checked) {
                    generalCheckbox.checked = false;
                    generalCheckbox.closest('.custom-checkbox').classList.remove('selected');
                }
            }
        }

        function handleGeneralTestChange(checkbox) {
            const topicCheckboxes = document.querySelectorAll('.topic-checkbox');
            
            if (checkbox.checked) {
                // Si se marca "Test General", desmarcar todos los temas
                topicCheckboxes.forEach(cb => {
                    cb.checked = false;
                    cb.closest('.custom-checkbox').classList.remove('selected');
                });
                checkbox.closest('.custom-checkbox').classList.add('selected');
            } else {
                checkbox.closest('.custom-checkbox').classList.remove('selected');
            }
        }

        function handleTopicChange() {
            const topicCheckboxes = document.querySelectorAll('.topic-checkbox');
            const generalCheckbox = document.getElementById('test-general');
            const anyTopicSelected = Array.from(topicCheckboxes).some(cb => cb.checked);
            
            // Actualizar estilos visuales para cada checkbox de tema
            topicCheckboxes.forEach(cb => {
                if (cb.checked) {
                    cb.closest('.custom-checkbox').classList.add('selected');
                } else {
                    cb.closest('.custom-checkbox').classList.remove('selected');
                }
            });
            
            // Si hay algÃºn tema seleccionado, desmarcar "Test General"
            if (anyTopicSelected && generalCheckbox.checked) {
                generalCheckbox.checked = false;
                generalCheckbox.closest('.custom-checkbox').classList.remove('selected');
            }
        }

        function startTest() {
            const generalCheckbox = document.getElementById('test-general');
            const topicCheckboxes = document.querySelectorAll('.topic-checkbox');
            
            let availableQuestions = [];
            let testTypeText = '';
            let selectedTopics = [];
            
            if (generalCheckbox && generalCheckbox.checked) {
                // Test general
                availableQuestions = state.questions;
                testTypeText = 'Test General';
            } else {
                // Test de temas especÃ­ficos
                const selectedTopicIds = Array.from(topicCheckboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.getAttribute('data-topic-id'));
                
                if (selectedTopicIds.length === 0) {
                    showMessage('Selecciona al menos un tema o marca "Test General"', 'error');
                    return;
                }
                
                selectedTopics = selectedTopicIds.map(id => getTopicName(id));
                
                // Filtrar preguntas por los temas seleccionados
                availableQuestions = state.questions.filter(q => 
                    q.topicId && selectedTopicIds.includes(q.topicId.toString())
                );
                
                if (selectedTopics.length === 1) {
                    testTypeText = `Test de ${selectedTopics[0]}`;
                } else {
                    testTypeText = `Test Combinado: ${selectedTopics.join(', ')}`;
                }
            }

            if (availableQuestions.length === 0) {
                showMessage('No hay preguntas disponibles para la selecciÃ³n actual', 'error');
                return;
            }

            // Obtener configuraciones
            const questionsCountSelect = document.getElementById('test-questions-count');
            const durationSelect = document.getElementById('test-duration');
            const testNameInput = document.getElementById('test-name');
            
            const questionsCount = questionsCountSelect.value === 'all' ? availableQuestions.length : parseInt(questionsCountSelect.value);
            const duration = parseInt(durationSelect.value);

            // Generar nombre del test
            let testName = testNameInput.value.trim();
            if (!testName) {
                const now = new Date();
                const dateStr = now.toLocaleDateString('es-ES');
                const timeStr = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                
                if (selectedTopics.length === 1) {
                    testName = `Test ${selectedTopics[0]} - ${dateStr} ${timeStr}`;
                } else if (selectedTopics.length > 1) {
                    testName = `Test Combinado - ${dateStr} ${timeStr}`;
                } else {
                    testName = `Test General - ${dateStr} ${timeStr}`;
                }
            }

            const finalQuestionsCount = Math.min(questionsCount, availableQuestions.length);
            const shuffled = [...availableQuestions].sort(() => Math.random() - 0.5);
            
            state.currentTest = {
                name: testName,
                questions: shuffled.slice(0, finalQuestionsCount),
                answers: {},
                duration: duration,
                timeLeft: duration,
                timer: null,
                testType: generalCheckbox && generalCheckbox.checked ? 'all' : 'multiple',
                testTypeText: testTypeText,
                selectedTopics: selectedTopics,
                startTime: Date.now()
            };
            
            // Solo iniciar timer si hay duraciÃ³n
            if (duration > 0) {
                state.currentTest.timer = setInterval(() => {
                    state.currentTest.timeLeft--;
                    if (state.currentTest.timeLeft <= 0) {
                        finishTest();
                    } else {
                        const timerElement = document.getElementById('timer');
                        if (timerElement) {
                            timerElement.textContent = `â±ï¸ ${formatTime(state.currentTest.timeLeft)}`;
                        }
                    }
                }, 1000);
            }
            
            render();
        }

        function finishTest() {
            if (!state.currentTest) return;
            
            // Detener timer si existe
            if (state.currentTest.timer) {
                clearInterval(state.currentTest.timer);
            }
            
            // Recoger respuestas del formulario
            const form = document.getElementById('test-form');
            let correct = 0;
            let incorrect = 0;
            let unanswered = 0;
            const answers = {};
            const detailedResults = [];
            
            state.currentTest.questions.forEach((question, index) => {
                const selectedOption = form.querySelector(`input[name="question-${index}"]:checked`);
                let userAnswer = null;
                let isCorrect = false;
                
                if (selectedOption) {
                    userAnswer = parseInt(selectedOption.value);
                    answers[index] = userAnswer;
                    if (userAnswer === question.correctAnswer) {
                        correct++;
                        isCorrect = true;
                    } else {
                        incorrect++;
                    }
                } else {
                    unanswered++;
                }
                
                detailedResults.push({
                    question: question,
                    userAnswer: userAnswer,
                    isCorrect: isCorrect
                });
            });
            
            const totalQuestions = state.currentTest.questions.length;
            
            // Calcular tiempo usado
            let timeUsedText = '';
            if (state.currentTest.duration > 0) {
                const timeUsed = state.currentTest.duration - state.currentTest.timeLeft;
                timeUsedText = `Tiempo empleado: ${formatTime(timeUsed)} de ${formatTime(state.currentTest.duration)}`;
            }
            
            // Crear objeto de resultado
            const testResult = {
                name: state.currentTest.name,
                correct: correct,
                incorrect: incorrect,
                unanswered: unanswered,
                total: totalQuestions,
                testType: state.currentTest.testTypeText,
                timeUsedText: timeUsedText,
                detailedResults: detailedResults,
                date: new Date().toLocaleString('es-ES'),
                id: Date.now()
            };
            
            // AÃ±adir al historial
            state.testResults.push(testResult);
            localStorage.setItem('testResults', JSON.stringify(state.testResults));
            
            // Mostrar el resultado especÃ­fico
            state.currentViewingResult = testResult;
            
            // Limpiar test actual y cambiar a pestaÃ±a de resultados
            state.currentTest = null;
            state.currentTab = 'results';
            render();
            
            // Hacer scroll al inicio de la pÃ¡gina despuÃ©s de renderizar
            setTimeout(() => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 100);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function startNewTest() {
            state.currentTab = 'test';
            state.currentViewingResult = null;
            render();
        }

        function viewTestResult(index) {
            state.currentViewingResult = state.testResults[index];
            render();
        }

        function clearTestHistory() {
            if (confirm('Â¿Eliminar todo el historial de tests? Esta acciÃ³n no se puede deshacer.')) {
                state.testResults = [];
                state.currentViewingResult = null;
                localStorage.setItem('testResults', JSON.stringify(state.testResults));
                render();
                showMessage('Historial de tests eliminado', 'success');
            }
        }

        function deleteIndividualTest(index) {
            const testName = state.testResults[index].name;
            if (confirm(`Â¿Eliminar el test "${testName}"? Esta acciÃ³n no se puede deshacer.`)) {
                state.testResults.splice(index, 1);
                localStorage.setItem('testResults', JSON.stringify(state.testResults));
                
                // Si estÃ¡bamos viendo el test que se eliminÃ³, volver al historial
                if (state.currentViewingResult && state.currentViewingResult.id === state.testResults[index]?.id) {
                    state.currentViewingResult = null;
                }
                
                render();
                showMessage('Test eliminado correctamente', 'success');
            }
        }

        function showMessage(message, type) {
            const messagesDiv = document.getElementById('messages');
            if (messagesDiv) {
                messagesDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
                setTimeout(() => {
                    messagesDiv.innerHTML = '';
                }, 5000);
            }
        }

        function initializeApp() {
            console.log('Sistema iniciando...');
            
            document.addEventListener('change', function(e) {
                if (e.target && e.target.id === 'imageInput') {
                    const files = Array.from(e.target.files);
                    const imageFiles = files.filter(file => file.type.startsWith('image/')).slice(0, 10);
                    
                    if (imageFiles.length > 0) {
                        state.selectedImages = imageFiles;
                        render();
                        showMessage(`${imageFiles.length} imagen(es) seleccionada(s)`, 'success');
                    }
                }
            });
            
            render();
            console.log('Sistema cargado correctamente');
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
    <!-- 
PARCHE PARA PREGUNTAS FALLADAS
AÃ±adir este cÃ³digo al final del archivo index.html, justo antes de </body>
Sin tocar nada del cÃ³digo existente
-->

<script>
    // ========== PARCHE: SISTEMA DE PREGUNTAS FALLADAS ==========
    
    // FunciÃ³n para actualizar preguntas falladas (sin tocar cÃ³digo original)
    function updateFailedQuestionsData() {
        const failedQuestions = [];
        
        state.testResults.forEach(result => {
            if (result.detailedResults) {
                result.detailedResults.forEach(detail => {
                    if (!detail.isCorrect && detail.userAnswer !== null) {
                        const questionId = detail.question.id;
                        
                        let existingFailed = failedQuestions.find(fq => fq.questionId === questionId);
                        
                        if (!existingFailed) {
                            existingFailed = {
                                questionId: questionId,
                                question: detail.question,
                                failedCount: 0,
                                lastFailedDate: null,
                                isResolved: false
                            };
                            failedQuestions.push(existingFailed);
                        }
                        
                        existingFailed.failedCount++;
                        existingFailed.lastFailedDate = result.date;
                    }
                });
            }
        });

        // Verificar preguntas resueltas
        failedQuestions.forEach(failedQ => {
            const laterResults = state.testResults
                .filter(result => new Date(result.date) > new Date(failedQ.lastFailedDate))
                .reverse();

            for (let result of laterResults) {
                if (result.detailedResults) {
                    const correctAnswer = result.detailedResults.find(detail => 
                        detail.question.id === failedQ.questionId && detail.isCorrect
                    );
                    
                    if (correctAnswer) {
                        failedQ.isResolved = true;
                        break;
                    }
                }
            }
        });

        return failedQuestions;
    }

    // FunciÃ³n para obtener preguntas falladas no resueltas
    function getUnresolvedFailedQuestions() {
        const failedQuestions = updateFailedQuestionsData();
        return failedQuestions.filter(fq => !fq.isResolved);
    }

    // FunciÃ³n para iniciar test de preguntas falladas
    function startFailedQuestionsTest() {
        const unresolvedFailed = getUnresolvedFailedQuestions();
        
        if (unresolvedFailed.length === 0) {
            showMessage('No tienes preguntas falladas para repasar ðŸŽ‰', 'success');
            return;
        }

        const questions = unresolvedFailed.map(fq => fq.question);
        const duration = Math.max(300, questions.length * 60);
        
        const now = new Date();
        const dateStr = now.toLocaleDateString('es-ES');
        const timeStr = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        const testName = `Test de Repaso - ${dateStr} ${timeStr}`;

        state.currentTest = {
            name: testName,
            questions: questions,
            answers: {},
            duration: duration,
            timeLeft: duration,
            timer: null,
            testType: 'failed',
            testTypeText: `Repaso de Preguntas Falladas (${questions.length} preguntas)`,
            startTime: Date.now(),
            isFailedQuestionsTest: true
        };
        
        // Iniciar timer
        state.currentTest.timer = setInterval(() => {
            state.currentTest.timeLeft--;
            if (state.currentTest.timeLeft <= 0) {
                finishTest();
            } else {
                const timerElement = document.getElementById('timer');
                if (timerElement) {
                    timerElement.textContent = `â±ï¸ ${formatTime(state.currentTest.timeLeft)}`;
                }
            }
        }, 1000);
        
        render();
        showMessage(`Test de repaso iniciado con ${questions.length} preguntas`, 'success');
    }

    // Extender la funciÃ³n renderTestTab original
    const originalRenderTestTab = renderTestTab;
    renderTestTab = function() {
        if (state.questions.length === 0) {
            return '<div style="text-align: center; padding: 40px;">AÃ±ade preguntas al banco para generar tests</div>';
        }

        if (!state.currentTest) {
            const unresolvedFailed = getUnresolvedFailedQuestions();
            
            return `
                <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #0c4a6e; margin-bottom: 15px;">ðŸŽ¯ ConfiguraciÃ³n del Test</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">NÃºmero de preguntas:</label>
                            <select id="test-questions-count" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="5">5 preguntas</option>
                                <option value="10" selected>10 preguntas</option>
                                <option value="15">15 preguntas</option>
                                <option value="20">20 preguntas</option>
                                <option value="all">Todas las preguntas disponibles</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">DuraciÃ³n:</label>
                            <select id="test-duration" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="300">5 minutos</option>
                                <option value="600" selected>10 minutos</option>
                                <option value="900">15 minutos</option>
                                <option value="1200">20 minutos</option>
                                <option value="1800">30 minutos</option>
                                <option value="0">Sin lÃ­mite de tiempo</option>
                            </select>
                        </div>
                    </div>

                    ${state.topics.length > 0 ? `
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 15px; font-weight: 500;">SelecciÃ³n de temas:</label>
                            <div style="display: grid; gap: 8px;">
                                <div class="custom-checkbox" onclick="toggleGeneralTest()">
                                    <input type="checkbox" id="test-general" onchange="handleGeneralTestChange(this)" checked>
                                    <span style="font-weight: 500;">Test General (${state.questions.length} preguntas)</span>
                                </div>
                                ${state.topics.map(topic => `
                                    <div class="custom-checkbox" onclick="toggleTopicTest('${topic.id}')">
                                        <input type="checkbox" class="topic-checkbox" data-topic-id="${topic.id}" onchange="handleTopicChange()">
                                        <span>${topic.name} (${getTopicQuestionCount(topic.id)} preguntas)</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div style="margin-top: 15px; padding: 10px; background: #f3f4f6; border-radius: 6px; font-size: 14px; color: #6b7280;">
                                ðŸ’¡ <strong>Consejo:</strong> Puedes seleccionar mÃºltiples temas para crear un test combinado, o elegir "Test General" para incluir todas las preguntas.
                            </div>
                        </div>
                    ` : ''}

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Nombre del test:</label>
                        <input type="text" id="test-name" placeholder="Ej: Test de MatemÃ¡ticas - SesiÃ³n 1" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                        <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                            Si no especificas un nombre, se generarÃ¡ automÃ¡ticamente
                        </div>
                    </div>
                </div>

                ${unresolvedFailed.length > 0 ? `
                    <div style="background: #fef2f2; border: 2px solid #ef4444; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="color: #dc2626; margin-bottom: 15px;">ðŸ”„ Test de Repaso Disponible</h3>
                        <p style="color: #991b1b; margin-bottom: 15px;">
                            Tienes <strong>${unresolvedFailed.length} pregunta${unresolvedFailed.length === 1 ? '' : 's'}</strong> fallada${unresolvedFailed.length === 1 ? '' : 's'} esperando repaso.
                        </p>
                        <div style="text-align: center;">
                            <button onclick="startFailedQuestionsTest()" class="btn btn-danger" style="font-size: 1.1rem; padding: 12px 25px;">
                                ðŸ”„ Test de Repaso (${unresolvedFailed.length} preguntas)
                            </button>
                        </div>
                        <div style="margin-top: 10px; font-size: 12px; color: #6b7280; text-align: center;">
                            Repasa solo las preguntas que has fallado anteriormente
                        </div>
                    </div>
                ` : ''}

                <div style="text-align: center; padding: 40px;">
                    <button onclick="startTest()" class="btn btn-primary" style="font-size: 1.2rem; padding: 15px 30px;">
                        ðŸŽ¯ Comenzar Test
                    </button>
                </div>
            `;
        }

        return renderCurrentTest();
    };

    // Extender la funciÃ³n finishTest para manejar tests de repaso
    const originalFinishTest = finishTest;
    finishTest = function() {
        if (!state.currentTest) return;
        
        // Detener timer si existe
        if (state.currentTest.timer) {
            clearInterval(state.currentTest.timer);
        }
        
        // Recoger respuestas del formulario
        const form = document.getElementById('test-form');
        let correct = 0;
        let incorrect = 0;
        let unanswered = 0;
        const answers = {};
        const detailedResults = [];
        
        state.currentTest.questions.forEach((question, index) => {
            const selectedOption = form.querySelector(`input[name="question-${index}"]:checked`);
            let userAnswer = null;
            let isCorrect = false;
            
            if (selectedOption) {
                userAnswer = parseInt(selectedOption.value);
                answers[index] = userAnswer;
                if (userAnswer === question.correctAnswer) {
                    correct++;
                    isCorrect = true;
                } else {
                    incorrect++;
                }
            } else {
                unanswered++;
            }
            
            detailedResults.push({
                question: question,
                userAnswer: userAnswer,
                isCorrect: isCorrect
            });
        });
        
        const totalQuestions = state.currentTest.questions.length;
        
        // Calcular tiempo usado
        let timeUsedText = '';
        if (state.currentTest.duration > 0) {
            const timeUsed = state.currentTest.duration - state.currentTest.timeLeft;
            timeUsedText = `Tiempo empleado: ${formatTime(timeUsed)} de ${formatTime(state.currentTest.duration)}`;
        }
        
        // Crear objeto de resultado
        const testResult = {
            name: state.currentTest.name,
            correct: correct,
            incorrect: incorrect,
            unanswered: unanswered,
            total: totalQuestions,
            testType: state.currentTest.testTypeText,
            timeUsedText: timeUsedText,
            detailedResults: detailedResults,
            date: new Date().toLocaleString('es-ES'),
            id: Date.now(),
            isFailedQuestionsTest: state.currentTest.isFailedQuestionsTest || false
        };
        
        // AÃ±adir al historial
        state.testResults.push(testResult);
        localStorage.setItem('testResults', JSON.stringify(state.testResults));
        
        // Mostrar el resultado especÃ­fico
        state.currentViewingResult = testResult;
        
        // Mensaje especial para tests de repaso
        if (state.currentTest.isFailedQuestionsTest) {
            const resolvedCount = detailedResults.filter(r => r.isCorrect).length;
            if (resolvedCount > 0) {
                showMessage(`Â¡Excelente! Has superado ${resolvedCount} pregunta${resolvedCount === 1 ? '' : 's'} que anteriormente habÃ­as fallado ðŸŽ‰`, 'success');
            }
        }
        
        // Limpiar test actual y cambiar a pestaÃ±a de resultados
        state.currentTest = null;
        state.currentTab = 'results';
        render();
        
        // Hacer scroll al inicio de la pÃ¡gina despuÃ©s de renderizar
        setTimeout(() => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 100);
    };

    console.log('âœ… Parche de preguntas falladas aplicado correctamente');
</script>
   
<script>
    // ========== CORRECCIÃ“N FINAL: SISTEMA ROBUSTO DE PREGUNTAS FALLADAS ==========
    
    // REEMPLAZAR completamente la funciÃ³n updateFailedQuestionsData
    function updateFailedQuestionsData() {
        const failedQuestions = [];
        
        console.log('ðŸ” Analizando historial de tests...');
        
        // Paso 1: Recopilar todas las preguntas falladas con timestamps
        state.testResults.forEach((result, resultIndex) => {
            if (result.detailedResults) {
                result.detailedResults.forEach(detail => {
                    if (!detail.isCorrect && detail.userAnswer !== null) {
                        const questionId = detail.question.id;
                        
                        let existingFailed = failedQuestions.find(fq => fq.questionId === questionId);
                        
                        if (!existingFailed) {
                            existingFailed = {
                                questionId: questionId,
                                question: detail.question,
                                failedCount: 0,
                                failedTests: [],
                                isResolved: false,
                                resolvedTest: null
                            };
                            failedQuestions.push(existingFailed);
                        }
                        
                        existingFailed.failedCount++;
                        existingFailed.failedTests.push({
                            testName: result.name,
                            date: result.date,
                            timestamp: result.id,
                            resultIndex: resultIndex
                        });
                    }
                });
            }
        });

        console.log(`ðŸ“‹ Encontradas ${failedQuestions.length} preguntas Ãºnicas falladas`);

        // Paso 2: Verificar resoluciones usando timestamps (mÃ¡s confiable que fechas)
        failedQuestions.forEach(failedQ => {
            // Obtener el timestamp de la primera falla
            const firstFailTimestamp = Math.min(...failedQ.failedTests.map(ft => ft.timestamp));
            
            // Buscar tests posteriores a la primera falla
            const laterTests = state.testResults
                .filter(result => result.id > firstFailTimestamp)
                .sort((a, b) => a.id - b.id); // Ordenar por timestamp

            console.log(`ðŸ” Pregunta ${failedQ.questionId}: Primera falla en timestamp ${firstFailTimestamp}, revisando ${laterTests.length} tests posteriores`);

            for (let result of laterTests) {
                if (result.detailedResults) {
                    const correctAnswer = result.detailedResults.find(detail => 
                        detail.question.id === failedQ.questionId && detail.isCorrect
                    );
                    
                    if (correctAnswer) {
                        failedQ.isResolved = true;
                        failedQ.resolvedTest = {
                            testName: result.name,
                            date: result.date,
                            timestamp: result.id
                        };
                        console.log(`âœ… Pregunta ${failedQ.questionId} RESUELTA en test "${result.name}" (timestamp: ${result.id})`);
                        break;
                    }
                }
            }
            
            if (!failedQ.isResolved) {
                console.log(`âŒ Pregunta ${failedQ.questionId} AÃšN PENDIENTE`);
            }
        });

        return failedQuestions;
    }

    // REEMPLAZAR la funciÃ³n getUnresolvedFailedQuestions
    function getUnresolvedFailedQuestions() {
        const failedQuestions = updateFailedQuestionsData();
        const unresolved = failedQuestions.filter(fq => !fq.isResolved);
        
        console.log(`ðŸ“Š RESUMEN FINAL:`);
        console.log(`   ðŸ”´ Total preguntas falladas: ${failedQuestions.length}`);
        console.log(`   âœ… Resueltas: ${failedQuestions.length - unresolved.length}`);
        console.log(`   â³ Pendientes: ${unresolved.length}`);
        
        if (unresolved.length > 0) {
            console.log(`ðŸ“ Preguntas pendientes:`);
            unresolved.forEach(fq => {
                console.log(`   - ID ${fq.questionId}: "${fq.question.question.substring(0, 50)}..."`);
            });
        }
        
        return unresolved;
    }

    // REEMPLAZAR finishTest con versiÃ³n mejorada
    const originalFinishTestRobust = finishTest;
    finishTest = function() {
        if (!state.currentTest) return;
        
        const isFailedQuestionsTest = state.currentTest.isFailedQuestionsTest;
        
        console.log(`ðŸ Finalizando test: "${state.currentTest.name}" (Tipo: ${isFailedQuestionsTest ? 'REPASO' : 'NORMAL'})`);
        
        // Llamar a la funciÃ³n original
        originalFinishTestRobust();
        
        // Si era un test de repaso, hacer anÃ¡lisis completo
        if (isFailedQuestionsTest) {
            console.log('ðŸ”„ ANÃLISIS POST-REPASO:');
            
            // Esperar un poco y luego actualizar
            setTimeout(() => {
                console.log('ðŸ“Š Actualizando estado de preguntas falladas...');
                const unresolvedAfter = getUnresolvedFailedQuestions();
                
                // Si estamos en la pestaÃ±a de test, re-renderizar
                if (state.currentTab === 'test') {
                    console.log('ðŸ”„ Re-renderizando interfaz...');
                    render();
                }
                
                // Mostrar resultado al usuario
                if (unresolvedAfter.length === 0) {
                    showMessage('ðŸŽ‰ Â¡Felicidades! Has superado todas tus preguntas falladas', 'success');
                } else {
                    showMessage(`âœ¨ Progreso: Ahora tienes ${unresolvedAfter.length} pregunta${unresolvedAfter.length === 1 ? '' : 's'} pendiente${unresolvedAfter.length === 1 ? '' : 's'}`, 'success');
                }
                
            }, 500); // Dar tiempo para que se guarde el test
        }
    };

    // FunciÃ³n de diagnÃ³stico (opcional - para debugging)
    window.diagnosticarPreguntas = function() {
        console.log('ðŸ”¬ DIAGNÃ“STICO COMPLETO:');
        console.log('Tests en el historial:', state.testResults.length);
        state.testResults.forEach((test, i) => {
            console.log(`Test ${i}: "${test.name}" - ID: ${test.id} - Fecha: ${test.date}`);
        });
        
        const failed = updateFailedQuestionsData();
        console.log('AnÃ¡lisis de preguntas falladas completado');
    };

    console.log('ðŸ”§ CorrecciÃ³n FINAL aplicada - Sistema robusto activado');
    console.log('ðŸ’¡ Puedes usar diagnosticarPreguntas() en la consola para debugging');
</script>
    <!-- 
PARCHE: SISTEMA DE CARPETAS COLAPSABLES EN BANCO DE PREGUNTAS
AÃ±adir este cÃ³digo al final del archivo index.html, justo antes de </body>
Este parche permite ocultar/mostrar las carpetas de temas individualmente
-->

<script>
    // ========== PARCHE: SISTEMA DE CARPETAS COLAPSABLES ==========
    
    // Estado para controlar quÃ© carpetas estÃ¡n colapsadas
    let collapsedFolders = JSON.parse(localStorage.getItem('collapsedFolders') || '{}');
    
    // FunciÃ³n para alternar el estado de una carpeta
    function toggleFolder(topicId) {
        collapsedFolders[topicId] = !collapsedFolders[topicId];
        localStorage.setItem('collapsedFolders', JSON.stringify(collapsedFolders));
        render();
    }
    
    // FunciÃ³n para colapsar todas las carpetas
    function collapseAllFolders() {
        const allTopicIds = state.topics.map(t => t.id.toString());
        allTopicIds.forEach(id => {
            collapsedFolders[id] = true;
        });
        localStorage.setItem('collapsedFolders', JSON.stringify(collapsedFolders));
        render();
    }
    
    // FunciÃ³n para expandir todas las carpetas
    function expandAllFolders() {
        collapsedFolders = {};
        localStorage.setItem('collapsedFolders', JSON.stringify(collapsedFolders));
        render();
    }
    
    // REEMPLAZAR la funciÃ³n renderQuestionsByTopic con versiÃ³n colapsable
    const originalRenderQuestionsByTopic = renderQuestionsByTopic;
    renderQuestionsByTopic = function() {
        const questionsWithoutTopic = state.questions.filter(q => !q.topicId);
        
        let html = '';
        
        // Botones de control global
        const hasTopicsWithQuestions = state.topics.some(topic => {
            return state.questions.filter(q => q.topicId && q.topicId.toString() === topic.id.toString()).length > 0;
        });
        
        if (hasTopicsWithQuestions) {
            html += `
                <div style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 2px solid #e2e8f0;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span style="font-weight: 500; color: #374151; margin-right: 10px;">Control de carpetas:</span>
                        <button onclick="expandAllFolders()" class="btn btn-info" style="padding: 6px 12px; font-size: 12px;">
                            ðŸ“‚ Expandir Todas
                        </button>
                        <button onclick="collapseAllFolders()" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;">
                            ðŸ“ Contraer Todas
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Mostrar preguntas por cada tema que TENGA preguntas
        state.topics.forEach(topic => {
            const topicQuestions = state.questions.filter(q => q.topicId && q.topicId.toString() === topic.id.toString());
            if (topicQuestions.length > 0) {
                const isCollapsed = collapsedFolders[topic.id.toString()];
                const chevronIcon = isCollapsed ? 'â–¶ï¸' : 'ðŸ”½';
                
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 onclick="toggleFolder('${topic.id}')" style="background: #4f46e5; color: white; padding: 10px 15px; border-radius: 8px 8px 0 0; margin: 0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; transition: all 0.2s;" 
                            onmouseover="this.style.background='#4338ca'" 
                            onmouseout="this.style.background='#4f46e5'">
                            <span style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 14px;">${chevronIcon}</span>
                                <span>ðŸ“ ${topic.name}</span>
                            </span>
                            <span style="font-size: 14px; opacity: 0.9;">${topicQuestions.length} pregunta${topicQuestions.length === 1 ? '' : 's'}</span>
                        </h3>
                        <div style="border: 1px solid #4f46e5; border-top: none; border-radius: 0 0 8px 8px; background: white; ${isCollapsed ? 'display: none;' : ''}">
                            ${topicQuestions.map(q => {
                                const actualIndex = state.questions.findIndex(question => question.id === q.id);
                                return renderSingleQuestion(q, actualIndex);
                            }).join('')}
                        </div>
                    </div>
                `;
            }
        });
        
        // Mostrar preguntas sin tema asignado SI existen
        if (questionsWithoutTopic.length > 0) {
            const noTopicCollapsed = collapsedFolders['no-topic'];
            const chevronIcon = noTopicCollapsed ? 'â–¶ï¸' : 'ðŸ”½';
            
            html += `
                <div style="margin-bottom: 30px;">
                    <h3 onclick="toggleFolder('no-topic')" style="background: #6b7280; color: white; padding: 10px 15px; border-radius: 8px 8px 0 0; margin: 0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; transition: all 0.2s;" 
                        onmouseover="this.style.background='#4b5563'" 
                        onmouseout="this.style.background='#6b7280'">
                        <span style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 14px;">${chevronIcon}</span>
                            <span>ðŸ“‚ Sin tema asignado</span>
                        </span>
                        <span style="font-size: 14px; opacity: 0.9;">${questionsWithoutTopic.length} pregunta${questionsWithoutTopic.length === 1 ? '' : 's'}</span>
                    </h3>
                    <div style="border: 1px solid #6b7280; border-top: none; border-radius: 0 0 8px 8px; background: white; ${noTopicCollapsed ? 'display: none;' : ''}">
                        ${questionsWithoutTopic.map(q => {
                            const actualIndex = state.questions.findIndex(question => question.id === q.id);
                            return renderSingleQuestion(q, actualIndex);
                        }).join('')}
                    </div>
                </div>
            `;
        }
        
        // Si no hay preguntas en absoluto
        if (html === '' || (!hasTopicsWithQuestions && questionsWithoutTopic.length === 0)) {
            return '<div style="padding: 40px; text-align: center; color: #9ca3af;">No hay preguntas disponibles en el banco</div>';
        }
        
        return html;
    };

    console.log('âœ… Parche de carpetas colapsables aplicado correctamente');
</script>
<!-- 
PARCHE: PANTALLA INTERMEDIA DESPUÃ‰S DEL LOGIN
AÃ±adir este cÃ³digo al final del archivo index.html, justo antes de </body>
Este parche aÃ±ade una pantalla de selecciÃ³n entre login y las funciones principales
-->

<script>
    // ========== PARCHE: PANTALLA INTERMEDIA ==========
    
    // Nuevo estado para controlar la pantalla intermedia
    let showIntermediateScreen = false;
    
    // Interceptar la funciÃ³n de login original
    const originalLogin = login;
    login = function() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        if (users[username] && users[username].password === password) {
            state.currentUser = users[username];
            showIntermediateScreen = true; // Mostrar pantalla intermedia
            render();
            showMessage(`Bienvenido ${users[username].name}`, 'success');
        } else {
            showMessage('Usuario o contraseÃ±a incorrectos', 'error');
        }
    };
    
    // FunciÃ³n para ir a realizar tests
    function goToTests() {
        showIntermediateScreen = false;
        state.currentTab = 'upload';
        render();
    }
    
    // FunciÃ³n para ir a ver resÃºmenes
    function goToSummaries() {
        showIntermediateScreen = false;
        state.currentTab = 'results';
        render();
    }
    
    // FunciÃ³n para renderizar la pantalla intermedia
    function renderIntermediateScreen() {
        return `
            <div style="min-height: 80vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: -30px; border-radius: 20px;">
                <div style="background: white; border-radius: 24px; padding: 60px; box-shadow: 0 25px 50px rgba(0,0,0,0.15); max-width: 600px; width: 100%; text-align: center; position: relative; overflow: hidden;">
                    
                    <!-- DecoraciÃ³n de fondo -->
                    <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: linear-gradient(135deg, #667eea20, #764ba220); border-radius: 50%; z-index: 0;"></div>
                    <div style="position: absolute; bottom: -30px; left: -30px; width: 100px; height: 100px; background: linear-gradient(135deg, #764ba220, #667eea20); border-radius: 50%; z-index: 0;"></div>
                    
                    <!-- Contenido principal -->
                    <div style="position: relative; z-index: 1;">
                        <!-- Icono principal -->
                        <div style="background: linear-gradient(135deg, #667eea, #764ba2); width: 80px; height: 80px; border-radius: 20px; margin: 0 auto 30px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);">
                            <span style="font-size: 2.5rem; filter: drop-shadow(0 2px 4px rgba(255,255,255,0.3));">ðŸŽ¯</span>
                        </div>
                        
                        <!-- TÃ­tulo principal -->
                        <h1 style="font-size: 2.8rem; font-weight: 700; margin: 0 0 15px 0; background: linear-gradient(135deg, #2d3748, #4a5568); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                            Â¡Bienvenid@!
                        </h1>
                        
                        <!-- SubtÃ­tulo -->
                        <p style="font-size: 1.3rem; color: #6b7280; margin: 0 0 50px 0; font-weight: 400; line-height: 1.5;">
                            Selecciona quÃ© te gustarÃ­a hacer hoy
                        </p>
                        
                        <!-- Botones principales -->
                        <div style="display: grid; gap: 25px; margin-bottom: 40px;">
                            
                            <!-- BotÃ³n Realizar Tests -->
                            <button onclick="goToTests()" style="
                                background: linear-gradient(135deg, #4f46e5, #7c3aed); 
                                border: none; 
                                border-radius: 16px; 
                                padding: 25px 40px; 
                                color: white; 
                                font-size: 1.3rem; 
                                font-weight: 600; 
                                cursor: pointer; 
                                transition: all 0.3s ease; 
                                box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);
                                position: relative;
                                overflow: hidden;
                                border: 2px solid transparent;
                                "
                                onmouseover="
                                    this.style.transform='translateY(-5px)'; 
                                    this.style.boxShadow='0 20px 40px rgba(79, 70, 229, 0.4)';
                                    this.style.background='linear-gradient(135deg, #6366f1, #8b5cf6)';
                                " 
                                onmouseout="
                                    this.style.transform='translateY(0)'; 
                                    this.style.boxShadow='0 10px 25px rgba(79, 70, 229, 0.3)';
                                    this.style.background='linear-gradient(135deg, #4f46e5, #7c3aed)';
                                ">
                                
                                <!-- Icono y texto -->
                                <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                                    <span style="font-size: 1.8rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));">ðŸ“š</span>
                                    <div style="text-align: left;">
                                        <div style="font-size: 1.3rem; font-weight: 700; margin-bottom: 3px;">Realizar Tests</div>
                                        <div style="font-size: 0.9rem; opacity: 0.9; font-weight: 400;">Crear y gestionar exÃ¡menes</div>
                                    </div>
                                </div>
                                
                                <!-- Efecto de brillo al hover -->
                                <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s ease;"></div>
                            </button>
                            
                            <!-- BotÃ³n Ver ResÃºmenes -->
                            <button onclick="goToSummaries()" style="
                                background: linear-gradient(135deg, #059669, #0ea5e9); 
                                border: none; 
                                border-radius: 16px; 
                                padding: 25px 40px; 
                                color: white; 
                                font-size: 1.3rem; 
                                font-weight: 600; 
                                cursor: pointer; 
                                transition: all 0.3s ease; 
                                box-shadow: 0 10px 25px rgba(5, 150, 105, 0.3);
                                position: relative;
                                overflow: hidden;
                                border: 2px solid transparent;
                                "
                                onmouseover="
                                    this.style.transform='translateY(-5px)'; 
                                    this.style.boxShadow='0 20px 40px rgba(5, 150, 105, 0.4)';
                                    this.style.background='linear-gradient(135deg, #10b981, #06b6d4)';
                                " 
                                onmouseout="
                                    this.style.transform='translateY(0)'; 
                                    this.style.boxShadow='0 10px 25px rgba(5, 150, 105, 0.3)';
                                    this.style.background='linear-gradient(135deg, #059669, #0ea5e9)';
                                ">
                                
                                <!-- Icono y texto -->
                                <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                                    <span style="font-size: 1.8rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));">ðŸ“Š</span>
                                    <div style="text-align: left;">
                                        <div style="font-size: 1.3rem; font-weight: 700; margin-bottom: 3px;">Ver ResÃºmenes</div>
                                        <div style="font-size: 0.9rem; opacity: 0.9; font-weight: 400;">Analizar resultados y estadÃ­sticas</div>
                                    </div>
                                </div>
                                
                                <!-- Efecto de brillo al hover -->
                                <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s ease;"></div>
                            </button>
                        </div>
                        
                        <!-- Footer info -->
                        <div style="border-top: 1px solid #e5e7eb; padding-top: 25px; color: #9ca3af; font-size: 0.9rem;">
                            <p style="margin: 0;">Sistema de ExÃ¡menes â€¢ Usuario: ${state.currentUser.name}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Interceptar la funciÃ³n render original para mostrar la pantalla intermedia
    const originalRender = render;
    render = function() {
        if (showIntermediateScreen && state.currentUser) {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <div class="title">Sistema de ExÃ¡menes</div>
                        <div>
                            <span style="color: ${state.apiKey ? '#10b981' : '#ef4444'};">
                                ${state.apiKey ? 'âœ… API Configurada' : 'âŒ Sin API'}
                            </span>
                            <button onclick="configureAPI()" class="btn btn-secondary">API</button>
                            <span style="color: #f59e0b;">ðŸ‘¤ ${state.currentUser.name}</span>
                            <button onclick="logout()" class="btn btn-danger">Salir</button>
                        </div>
                    </div>
                    ${renderIntermediateScreen()}
                </div>
            `;
        } else {
            // Usar la funciÃ³n render original
            originalRender();
        }
    };
    
    // Interceptar logout para resetear la pantalla intermedia
    const originalLogout = logout;
    logout = function() {
        showIntermediateScreen = false;
        originalLogout();
    };
    
    console.log('âœ… Parche de pantalla intermedia aplicado correctamente');
</script>    
    <!-- 
PARCHE: PANTALLA DE RESÃšMENES CON IA
AÃ±adir este cÃ³digo al final del archivo index.html, justo antes de </body>
Este parche aÃ±ade una nueva funcionalidad para generar resÃºmenes de imÃ¡genes
-->

<script>
    // ========== PARCHE: SISTEMA DE RESÃšMENES CON IA ==========
    
    // Nuevo estado para la funcionalidad de resÃºmenes
    let summaryState = {
        selectedImages: [],
        generatedSummary: '',
        isProcessing: false
    };
    
    // Interceptar la funciÃ³n goToSummaries para redirigir a la nueva pestaÃ±a
    const originalGoToSummaries = goToSummaries;
    goToSummaries = function() {
        showIntermediateScreen = false;
        state.currentTab = 'summary'; // Nueva pestaÃ±a
        render();
    };
    
    // Extender la funciÃ³n renderTabContent para incluir la nueva pestaÃ±a
    const originalRenderTabContent = renderTabContent;
    renderTabContent = function() {
        switch(state.currentTab) {
            case 'upload':
                return renderUploadTab();
            case 'questions':
                return renderQuestionsTab();
            case 'test':
                return renderTestTab();
            case 'results':
                return renderResultsTab();
            case 'summary':
                return renderSummaryTab();
            default:
                return '<div>Error: PestaÃ±a no encontrada</div>';
        }
    };
    
    // FunciÃ³n para renderizar la pestaÃ±a de resÃºmenes
    function renderSummaryTab() {
        return `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h2 style="color: #1f2937; margin: 0;">ðŸ“„ Generador de ResÃºmenes con IA</h2>
                    <p style="color: #6b7280; margin: 5px 0 0 0; font-size: 14px;">Sube una imagen y obtÃ©n un resumen inteligente del contenido</p>
                </div>
                <button onclick="backToIntermediateScreen()" class="btn btn-secondary">
                    â† Volver al MenÃº Principal
                </button>
            </div>
            
            <div class="three-column">
                <div class="column">
                    <h3 style="margin-bottom: 15px;">ðŸ“¤ Subir Imagen para Resumir</h3>
                    <div class="upload-area" onclick="document.getElementById('summaryImageInput').click()">
                        <div>ðŸ“· Seleccionar imagen</div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Una imagen por vez</div>
                        <div style="margin-top: 10px; color: #4f46e5; font-weight: 500;">
                            ${summaryState.selectedImages.length}/1 archivo
                        </div>
                    </div>
                    <input type="file" id="summaryImageInput" style="display: none;" accept="image/*">
                    
                    ${summaryState.selectedImages.length > 0 ? `
                        <div style="margin-bottom: 15px; padding: 15px; background: #f3f4f6; border-radius: 8px; text-align: center;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 12px; word-break: break-all; flex: 1;">${summaryState.selectedImages[0].name}</div>
                                <button onclick="removeSummaryImage()" style="background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; cursor: pointer; margin-left: 10px;">Ã—</button>
                            </div>
                        </div>
                    ` : ''}
                    
                    <button onclick="generateSummary()" class="btn btn-primary" style="width: 100%;" ${summaryState.selectedImages.length === 0 || !state.apiKey || summaryState.isProcessing ? 'disabled' : ''}>
                        ${summaryState.isProcessing ? 'ðŸ”„ Generando Resumen...' : 'ðŸ¤– Generar Resumen'}
                    </button>
                    
                    ${summaryState.isProcessing ? `
                        <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; text-align: center;">
                            <span style="color: #92400e;">ðŸ”„ Procesando imagen y generando resumen...</span>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px;">
                        <h4 style="color: #0c4a6e; margin-bottom: 10px;">ðŸ’¡ Consejos para mejores resÃºmenes</h4>
                        <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #0369a1;">
                            <li>Usa imÃ¡genes con texto claro y legible</li>
                            <li>Evita imÃ¡genes muy pequeÃ±as o borrosas</li>
                            <li>Funciona mejor con documentos, artÃ­culos, o capturas de pantalla</li>
                            <li>El resumen se adaptarÃ¡ al tipo de contenido detectado</li>
                        </ul>
                    </div>
                </div>

                <div class="column">
                    <h3 style="margin-bottom: 15px;">ðŸ“ Resumen Generado</h3>
                    <textarea id="generatedSummary" class="textarea" placeholder="El resumen aparecerÃ¡ aquÃ­ una vez que proceses una imagen..." readonly>${summaryState.generatedSummary}</textarea>
                    
                    ${summaryState.generatedSummary ? `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                            <button onclick="copySummaryToClipboard()" class="btn btn-info" style="width: 100%; padding: 8px; font-size: 13px;">
                                ðŸ“‹ Copiar al Portapapeles
                            </button>
                            <button onclick="clearSummary()" class="btn btn-secondary" style="width: 100%; padding: 8px; font-size: 13px;">
                                ðŸ—‘ï¸ Limpiar Resumen
                            </button>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 15px; background: #f0fdf4; border: 2px solid #22c55e; border-radius: 8px;">
                            <h4 style="color: #166534; margin-bottom: 10px;">âœ… Â¡Resumen generado exitosamente!</h4>
                            <p style="margin: 0; font-size: 13px; color: #16a34a;">
                                Puedes copiar el texto, procesarlo nuevamente, o subir una nueva imagen.
                            </p>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    // FunciÃ³n para volver a la pantalla intermedia
    function backToIntermediateScreen() {
        showIntermediateScreen = true;
        state.currentTab = 'upload'; // Reset tab
        render();
    }
    
    // FunciÃ³n para manejar la selecciÃ³n de imagen
    function handleSummaryImageSelection() {
        document.addEventListener('change', function(e) {
            if (e.target && e.target.id === 'summaryImageInput') {
                const files = Array.from(e.target.files);
                const imageFile = files.filter(file => file.type.startsWith('image/'))[0];
                
                if (imageFile) {
                    summaryState.selectedImages = [imageFile];
                    summaryState.generatedSummary = ''; // Limpiar resumen anterior
                    render();
                    showMessage('Imagen seleccionada correctamente', 'success');
                }
            }
        });
    }
    
    // FunciÃ³n para eliminar la imagen seleccionada
    function removeSummaryImage() {
        summaryState.selectedImages = [];
        summaryState.generatedSummary = '';
        render();
        showMessage('Imagen eliminada', 'success');
    }
    
    // FunciÃ³n principal para generar resumen
    async function generateSummary() {
        if (!state.apiKey) {
            showMessage('Configura tu API key primero', 'error');
            return;
        }

        if (summaryState.selectedImages.length === 0) {
            showMessage('Selecciona una imagen primero', 'error');
            return;
        }

        summaryState.isProcessing = true;
        render();
        showMessage('Generando resumen...', 'success');
        
        try {
            const file = summaryState.selectedImages[0];
            const base64 = await fileToBase64(file);
            
            const messageContent = [
                {
                    type: "image",
                    source: {
                        type: "base64",
                        media_type: file.type,
                        data: base64
                    }
                },
                {
                    type: "text",
                    text: `ActÃºa como un asistente experto en anÃ¡lisis y sÃ­ntesis de informaciÃ³n. Analiza esta imagen y genera un resumen completo e inteligente del contenido.

INSTRUCCIONES PARA EL RESUMEN:

ðŸŽ¯ OBJETIVO: Crear un resumen estructurado, claro y Ãºtil que capture la esencia del contenido

ðŸ“‹ FORMATO DEL RESUMEN:
â€¢ Comienza con una breve descripciÃ³n del tipo de documento/contenido
â€¢ Organiza la informaciÃ³n en secciones lÃ³gicas con encabezados
â€¢ Usa viÃ±etas y numeraciÃ³n cuando sea apropiado
â€¢ Incluye los puntos mÃ¡s importantes y relevantes
â€¢ Termina con conclusiones o puntos clave si es relevante

ðŸ” QUÃ‰ INCLUIR:
- Ideas principales y conceptos clave
- Datos importantes, cifras, fechas relevantes
- Argumentos o puntos de vista presentados
- Conclusiones o recomendaciones si las hay
- Cualquier informaciÃ³n prÃ¡ctica o accionable

âœ¨ ESTILO:
- Lenguaje claro y profesional
- Oraciones concisas pero informativas  
- Estructura fÃ¡cil de leer y escanear
- Adapta el tono al tipo de contenido (acadÃ©mico, empresarial, tÃ©cnico, etc.)

ðŸš« EVITA:
- Repetir informaciÃ³n innecesaria
- Incluir detalles muy tÃ©cnicos a menos que sean cruciales
- Hacer el resumen demasiado largo (mÃ¡ximo 500 palabras)
- Copiar texto textualmente sin reorganizar

Genera un resumen que sea verdaderamente Ãºtil para alguien que quiere entender rÃ¡pidamente el contenido esencial del documento.`
                }
            ];

            const response = await fetch("/api/anthropic", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-api-key": state.apiKey,
                },
                body: JSON.stringify({
                    model: "claude-sonnet-4-20250514",
                    max_tokens: 2000,
                    messages: [{
                        role: "user",
                        content: messageContent
                    }]
                })
            });

            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            summaryState.generatedSummary = data.content[0].text;
            summaryState.isProcessing = false;
            
            render();
            
            
        } catch (error) {
            summaryState.isProcessing = false;
            render();
            showMessage(`Error al generar resumen: ${error.message}`, 'error');
        }
    }
    
    // FunciÃ³n para copiar el resumen al portapapeles
    async function copySummaryToClipboard() {
        try {
            await navigator.clipboard.writeText(summaryState.generatedSummary);
            showMessage('Resumen copiado al portapapeles', 'success');
        } catch (error) {
            // Fallback para navegadores que no soportan clipboard API
            const textArea = document.createElement('textarea');
            textArea.value = summaryState.generatedSummary;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showMessage('Resumen copiado al portapapeles', 'success');
            } catch (err) {
                showMessage('Error al copiar. Selecciona y copia manualmente', 'error');
            }
            document.body.removeChild(textArea);
        }
    }
    
    // FunciÃ³n para limpiar el resumen
    function clearSummary() {
        if (confirm('Â¿Limpiar el resumen generado?')) {
            summaryState.generatedSummary = '';
            render();
            showMessage('Resumen limpiado', 'success');
        }
    }
    
    // Extender la funciÃ³n setTab para incluir la nueva pestaÃ±a
    const originalSetTab = setTab;
    setTab = function(tab) {
        state.currentTab = tab;
        state.currentViewingResult = null;
        
        // Si vamos a summary, asegurar que no se muestre la pantalla intermedia
        if (tab === 'summary') {
            showIntermediateScreen = false;
        }
        
        render();
    };
    
    // Extender el sistema de navegaciÃ³n para incluir la nueva pestaÃ±a
    const originalRender = render;
    render = function() {
        if (showIntermediateScreen && state.currentUser) {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <div class="title">Sistema de ExÃ¡menes</div>
                        <div>
                            <span style="color: ${state.apiKey ? '#10b981' : '#ef4444'};">
                                ${state.apiKey ? 'âœ… API Configurada' : 'âŒ Sin API'}
                            </span>
                            <button onclick="configureAPI()" class="btn btn-secondary">API</button>
                            <span style="color: #f59e0b;">ðŸ‘¤ ${state.currentUser.name}</span>
                            <button onclick="logout()" class="btn btn-danger">Salir</button>
                        </div>
                    </div>
                    ${renderIntermediateScreen()}
                </div>
            `;
        } else if (state.currentUser) {
            const app = document.getElementById('app');
            
            // Determinar el tÃ­tulo segÃºn la pestaÃ±a actual
            let pageTitle = 'Sistema de ExÃ¡menes';
            if (state.currentTab === 'questions') pageTitle = 'Banco de Preguntas';
            else if (state.currentTab === 'results') pageTitle = 'Resultados del Test';
            else if (state.currentTab === 'summary') pageTitle = 'Generador de ResÃºmenes';
            
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <div class="title">${pageTitle}</div>
                        <div>
                            <span style="color: ${state.apiKey ? '#10b981' : '#ef4444'};">
                                ${state.apiKey ? 'âœ… API Configurada' : 'âŒ Sin API'}
                            </span>
                            <button onclick="configureAPI()" class="btn btn-secondary">API</button>
                            <span style="color: #f59e0b;">ðŸ‘¤ ${state.currentUser.name}</span>
                            <button onclick="logout()" class="btn btn-danger">Salir</button>
                        </div>
                    </div>

                    ${state.currentTab !== 'summary' ? `
                        <div class="nav-tabs">
                            <button class="nav-tab ${state.currentTab === 'upload' ? 'active' : ''}" onclick="setTab('upload')">
                                ðŸ“¤ Subir Test
                            </button>
                            <button class="nav-tab ${state.currentTab === 'questions' ? 'active' : ''}" onclick="setTab('questions')">
                                ðŸ“‹ Banco de Preguntas (${getFilteredQuestions().length})
                            </button>
                            <button class="nav-tab ${state.currentTab === 'test' ? 'active' : ''}" onclick="setTab('test')">
                                ðŸŽ¯ Test Aleatorio
                            </button>
                            <button class="nav-tab ${state.currentTab === 'results' ? 'active' : ''}" onclick="setTab('results')">
                                ðŸ“Š Resultados (${state.testResults.length})
                            </button>
                        </div>
                    ` : ''}

                    <div id="messages"></div>

                    ${renderTabContent()}
                </div>
            `;
        } else {
            // Usuario no logueado - mostrar login
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <div class="login-form">
                        <h2 style="text-align: center; margin-bottom: 30px;">Iniciar SesiÃ³n</h2>
                        <div class="form-group">
                            <label class="form-label">Usuario</label>
                            <input type="text" id="username" class="form-input" placeholder="demo">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ContraseÃ±a</label>
                            <input type="password" id="password" class="form-input" placeholder="demo123">
                        </div>
                        <button onclick="login()" class="btn btn-primary" style="width: 100%;">
                            Iniciar SesiÃ³n
                        </button>
                        <div style="text-align: center; margin-top: 15px; color: #6b7280; font-size: 14px;">
                            Usuario: demo | ContraseÃ±a: demo123
                        </div>
                    </div>
                </div>
            `;
        }
    };
    
    // Inicializar el event listener para imÃ¡genes de resumen
    handleSummaryImageSelection();
    
    console.log('âœ… Parche de pantalla de resÃºmenes aplicado correctamente');
</script>
    <!-- 
PARCHE CORRECCIÃ“N: REDIRECCIÃ“N CORRECTA A PANTALLA DE RESÃšMENES
AÃ±adir este cÃ³digo al final del archivo index.html, justo antes de </body>
Este parche corrige el problema de redirecciÃ³n a la pantalla de resÃºmenes
-->

<script>
    // ========== CORRECCIÃ“N: REDIRECCIÃ“N A RESÃšMENES ==========
    
    // Forzar la redefiniciÃ³n correcta de goToSummaries
    goToSummaries = function() {
        showIntermediateScreen = false;
        state.currentTab = 'summary';
        render();
    };
    
    console.log('âœ… Parche de correcciÃ³n de resÃºmenes aplicado correctamente');
</script>
    <!-- 
PARCHE CORRECCIÃ“N FINAL: FUNCIÃ“N RENDERTABCONTENT COMPLETA
AÃ±adir este cÃ³digo al final del archivo index.html, justo antes de </body>
Este parche REEMPLAZA completamente la funciÃ³n renderTabContent para incluir 'summary'
-->

<script>
    // ========== CORRECCIÃ“N FINAL: REEMPLAZAR RENDERTABCONTENT ==========
    
    // REEMPLAZAR completamente la funciÃ³n renderTabContent
    renderTabContent = function() {
        switch(state.currentTab) {
            case 'upload':
                return renderUploadTab();
            case 'questions':
                return renderQuestionsTab();
            case 'test':
                return renderTestTab();
            case 'results':
                return renderResultsTab();
            case 'summary':
                return renderSummaryTab();
            default:
                return '<div>Error: PestaÃ±a no encontrada - ' + state.currentTab + '</div>';
        }
    };
    
    // ASEGURAR que goToSummaries funcione correctamente
    goToSummaries = function() {
        showIntermediateScreen = false;
        state.currentTab = 'summary';
        console.log('Cambiando a pestaÃ±a summary');
        render();
    };
    
    console.log('âœ… CorrecciÃ³n FINAL aplicada - PestaÃ±a summary habilitada');
</script>
    <!-- 
PARCHE URGENTE: DEFINIR FUNCIÃ“N RENDERSUMMARYTAB
AÃ±adir este cÃ³digo AL FINAL del archivo index.html, justo antes de </body>
Este parche define la funciÃ³n renderSummaryTab que falta
-->

<script>
    // ========== PARCHE URGENTE: FUNCIÃ“N RENDERSUMMARYTAB ==========
    
    // Definir la funciÃ³n renderSummaryTab globalmente
    function renderSummaryTab() {
        return `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h2 style="color: #1f2937; margin: 0;">ðŸ“„ Generador de ResÃºmenes con IA</h2>
                    <p style="color: #6b7280; margin: 5px 0 0 0; font-size: 14px;">Sube una imagen y obtÃ©n un resumen inteligente del contenido</p>
                </div>
                <button onclick="backToIntermediateScreen()" class="btn btn-secondary">
                    â† Volver al MenÃº Principal
                </button>
            </div>
            
            <div class="three-column">
                <div class="column">
                    <h3 style="margin-bottom: 15px;">ðŸ“¤ Subir Imagen para Resumir</h3>
                    <div class="upload-area" onclick="document.getElementById('summaryImageInput').click()">
                        <div>ðŸ“· Seleccionar imagen</div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Una imagen por vez</div>
                        <div style="margin-top: 10px; color: #4f46e5; font-weight: 500;">
                            ${summaryState.selectedImages.length}/1 archivo
                        </div>
                    </div>
                    <input type="file" id="summaryImageInput" style="display: none;" accept="image/*">
                    
                    ${summaryState.selectedImages.length > 0 ? `
                        <div style="margin-bottom: 15px; padding: 15px; background: #f3f4f6; border-radius: 8px; text-align: center;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 12px; word-break: break-all; flex: 1;">${summaryState.selectedImages[0].name}</div>
                                <button onclick="removeSummaryImage()" style="background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; cursor: pointer; margin-left: 10px;">Ã—</button>
                            </div>
                        </div>
                    ` : ''}
                    
                    <button onclick="generateSummary()" class="btn btn-primary" style="width: 100%;" ${summaryState.selectedImages.length === 0 || !state.apiKey || summaryState.isProcessing ? 'disabled' : ''}>
                        ${summaryState.isProcessing ? 'ðŸ”„ Generando Resumen...' : 'ðŸ¤– Generar Resumen'}
                    </button>
                    
                    ${summaryState.isProcessing ? `
                        <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; text-align: center;">
                            <span style="color: #92400e;">ðŸ”„ Procesando imagen y generando resumen...</span>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px;">
                        <h4 style="color: #0c4a6e; margin-bottom: 10px;">ðŸ’¡ Consejos para mejores resÃºmenes</h4>
                        <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #0369a1;">
                            <li>Usa imÃ¡genes con texto claro y legible</li>
                            <li>Evita imÃ¡genes muy pequeÃ±as o borrosas</li>
                            <li>Funciona mejor con documentos, artÃ­culos, o capturas de pantalla</li>
                            <li>El resumen se adaptarÃ¡ al tipo de contenido detectado</li>
                        </ul>
                    </div>
                </div>

                <div class="column">
                    <h3 style="margin-bottom: 15px;">ðŸ“ Resumen Generado</h3>
                    <textarea id="generatedSummary" class="textarea" placeholder="El resumen aparecerÃ¡ aquÃ­ una vez que proceses una imagen..." readonly>${summaryState.generatedSummary}</textarea>
                    
                    ${summaryState.generatedSummary ? `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                            <button onclick="copySummaryToClipboard()" class="btn btn-info" style="width: 100%; padding: 8px; font-size: 13px;">
                                ðŸ“‹ Copiar al Portapapeles
                            </button>
                            <button onclick="clearSummary()" class="btn btn-secondary" style="width: 100%; padding: 8px; font-size: 13px;">
                                ðŸ—‘ï¸ Limpiar Resumen
                            </button>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 15px; background: #f0fdf4; border: 2px solid #22c55e; border-radius: 8px;">
                            <h4 style="color: #166534; margin-bottom: 10px;">âœ… Â¡Resumen generado exitosamente!</h4>
                            <p style="margin: 0; font-size: 13px; color: #16a34a;">
                                Puedes copiar el texto, procesarlo nuevamente, o subir una nueva imagen.
                            </p>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    // Asegurar que las funciones auxiliares estÃ©n definidas
    function backToIntermediateScreen() {
        showIntermediateScreen = true;
        state.currentTab = 'upload';
        render();
    }
    
    function removeSummaryImage() {
        summaryState.selectedImages = [];
        summaryState.generatedSummary = '';
        render();
        showMessage('Imagen eliminada', 'success');
    }
    
    async function generateSummary() {
        if (!state.apiKey) {
            showMessage('Configura tu API key primero', 'error');
            return;
        }

        if (summaryState.selectedImages.length === 0) {
            showMessage('Selecciona una imagen primero', 'error');
            return;
        }

        summaryState.isProcessing = true;
        render();
        showMessage('Generando resumen...', 'success');
        
        try {
            const file = summaryState.selectedImages[0];
            const base64 = await fileToBase64(file);
            
            const messageContent = [
                {
                    type: "image",
                    source: {
                        type: "base64",
                        media_type: file.type,
                        data: base64
                    }
                },
                {
                    type: "text",
                    text: `ActÃºa como un asistente experto en anÃ¡lisis y sÃ­ntesis de informaciÃ³n. Analiza esta imagen y genera un resumen completo e inteligente del contenido.

INSTRUCCIONES PARA EL RESUMEN:

ðŸŽ¯ OBJETIVO: Crear un resumen estructurado, claro y Ãºtil que capture la esencia del contenido

ðŸ“‹ FORMATO DEL RESUMEN:
â€¢ Comienza con una breve descripciÃ³n del tipo de documento/contenido
â€¢ Organiza la informaciÃ³n en secciones lÃ³gicas con encabezados
â€¢ Usa viÃ±etas y numeraciÃ³n cuando sea apropiado
â€¢ Incluye los puntos mÃ¡s importantes y relevantes
â€¢ Termina con conclusiones o puntos clave si es relevante

ðŸ” QUÃ‰ INCLUIR:
- Ideas principales y conceptos clave
- Datos importantes, cifras, fechas relevantes
- Argumentos o puntos de vista presentados
- Conclusiones o recomendaciones si las hay
- Cualquier informaciÃ³n prÃ¡ctica o accionable

âœ¨ ESTILO:
- Lenguaje claro y profesional
- Oraciones concisas pero informativas  
- Estructura fÃ¡cil de leer y escanear
- Adapta el tono al tipo de contenido (acadÃ©mico, empresarial, tÃ©cnico, etc.)

ðŸš« EVITA:
- Repetir informaciÃ³n innecesaria
- Incluir detalles muy tÃ©cnicos a menos que sean cruciales
- Hacer el resumen demasiado largo (mÃ¡ximo 500 palabras)
- Copiar texto textualmente sin reorganizar

Genera un resumen que sea verdaderamente Ãºtil para alguien que quiere entender rÃ¡pidamente el contenido esencial del documento.`
                }
            ];

            const response = await fetch("/api/anthropic", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-api-key": state.apiKey,
                },
                body: JSON.stringify({
                    model: "claude-sonnet-4-20250514",
                    max_tokens: 2000,
                    messages: [{
                        role: "user",
                        content: messageContent
                    }]
                })
            });

            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            summaryState.generatedSummary = data.content[0].text;
            summaryState.isProcessing = false;
            
            render();
            showMessage('Â¡Resumen generado exitosamente!', 'success');
            
        } catch (error) {
            summaryState.isProcessing = false;
            render();
            showMessage(`Error al generar resumen: ${error.message}`, 'error');
        }
    }
    
    async function copySummaryToClipboard() {
        try {
            await navigator.clipboard.writeText(summaryState.generatedSummary);
            showMessage('Resumen copiado al portapapeles', 'success');
        } catch (error) {
            const textArea = document.createElement('textarea');
            textArea.value = summaryState.generatedSummary;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showMessage('Resumen copiado al portapapeles', 'success');
            } catch (err) {
                showMessage('Error al copiar. Selecciona y copia manualmente', 'error');
            }
            document.body.removeChild(textArea);
        }
    }
    
    function clearSummary() {
        if (confirm('Â¿Limpiar el resumen generado?')) {
            summaryState.generatedSummary = '';
            render();
            showMessage('Resumen limpiado', 'success');
        }
    }
    
    // Asegurar que summaryState estÃ© definido
    if (typeof summaryState === 'undefined') {
        window.summaryState = {
            selectedImages: [],
            generatedSummary: '',
            isProcessing: false
        };
    }
    
    // Event listener para selecciÃ³n de imÃ¡genes
    document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'summaryImageInput') {
            const files = Array.from(e.target.files);
            const imageFile = files.filter(file => file.type.startsWith('image/'))[0];
            
            if (imageFile) {
                summaryState.selectedImages = [imageFile];
                summaryState.generatedSummary = '';
                render();
                showMessage('Imagen seleccionada correctamente', 'success');
            }
        }
    });
    
    console.log('ðŸ”§ PARCHE URGENTE aplicado - FunciÃ³n renderSummaryTab definida correctamente');
</script>
    <!-- 
PARCHE COMPLETO: SISTEMA DE RESÃšMENES INDEPENDIENTE CON TEMAS
AÃ±adir este cÃ³digo AL FINAL del archivo index.html, justo antes de </body>
Este parche reemplaza el sistema de resÃºmenes con uno completo e independiente
-->

<script>
    // ========== PARCHE COMPLETO: SISTEMA DE RESÃšMENES CON TEMAS ==========
    
    // Estado especÃ­fico para el sistema de resÃºmenes
    let summarySystemState = {
        selectedImages: [],
        generatedSummary: '',
        isProcessing: false,
        summaryTopics: JSON.parse(localStorage.getItem('summaryTopics') || '[]'),
        savedSummaries: JSON.parse(localStorage.getItem('savedSummaries') || '[]'),
        selectedTopicForSummary: null,
        currentView: 'create', // 'create' | 'library'
        viewingSummary: null
    };
    
    // REEMPLAZAR completamente la funciÃ³n renderSummaryTab
    function renderSummaryTab() {
        if (summarySystemState.currentView === 'library') {
            return renderSummaryLibrary();
        } else if (summarySystemState.viewingSummary) {
            return renderViewSummary();
        } else {
            return renderCreateSummary();
        }
    }
    
    // FunciÃ³n para renderizar la creaciÃ³n de resÃºmenes
    function renderCreateSummary() {
        return `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h2 style="color: #1f2937; margin: 0;">ðŸ“„ Crear Nuevo Resumen</h2>
                    <p style="color: #6b7280; margin: 5px 0 0 0; font-size: 14px;">Sube una imagen y obtÃ©n un resumen inteligente del contenido</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="showSummaryLibrary()" class="btn btn-info">
                        ðŸ“š Ver Biblioteca
                    </button>
                    <button onclick="backToIntermediateScreen()" class="btn btn-secondary">
                        â† Volver al MenÃº Principal
                    </button>
                </div>
            </div>
            
            <div class="three-column">
                <div class="column">
                    <h3 style="margin-bottom: 15px;">ðŸ“¤ Subir Imagen para Resumir</h3>
                    <div class="upload-area" onclick="document.getElementById('summaryImageInput').click()">
                        <div>ðŸ“· Seleccionar imagen</div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Una imagen por vez</div>
                        <div style="margin-top: 10px; color: #4f46e5; font-weight: 500;">
                            ${summarySystemState.selectedImages.length}/1 archivo
                        </div>
                    </div>
                    <input type="file" id="summaryImageInput" style="display: none;" accept="image/*">
                    
                    ${summarySystemState.selectedImages.length > 0 ? `
                        <div style="margin-bottom: 15px; padding: 15px; background: #f3f4f6; border-radius: 8px; text-align: center;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 12px; word-break: break-all; flex: 1;">${summarySystemState.selectedImages[0].name}</div>
                                <button onclick="removeSummaryImage()" style="background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; cursor: pointer; margin-left: 10px;">Ã—</button>
                            </div>
                        </div>
                    ` : ''}
                    
                    <button onclick="generateSummary()" class="btn btn-primary" style="width: 100%; margin-bottom: 15px;" ${summarySystemState.selectedImages.length === 0 || !state.apiKey || summarySystemState.isProcessing ? 'disabled' : ''}>
                        ${summarySystemState.isProcessing ? 'ðŸ”„ Generando Resumen...' : 'ðŸ¤– Generar Resumen'}
                    </button>
                    
                    ${summarySystemState.isProcessing ? `
                        <div style="margin-bottom: 15px; padding: 15px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; text-align: center;">
                            <span style="color: #92400e;">ðŸ”„ Procesando imagen y generando resumen...</span>
                        </div>
                    ` : ''}
                    
                    <!-- GestiÃ³n de Temas para ResÃºmenes -->
                    <div style="padding: 15px; background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px;">
                        <h4 style="color: #0c4a6e; margin-bottom: 15px;">ðŸ·ï¸ Organizar por Temas</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <button onclick="createSummaryTopic()" class="btn btn-info" style="width: 100%; padding: 8px; font-size: 13px;">
                                ðŸ†• Crear Tema
                            </button>
                            
                            <select id="summary-topic-selector" onchange="updateSelectedSummaryTopic()" style="width: 100%; padding: 8px; border: none; background: #0ea5e9; color: white; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer;" ${summarySystemState.summaryTopics.length === 0 ? 'disabled' : ''}>
                                <option value="">ðŸ“‚ Seleccionar Tema</option>
                                ${summarySystemState.summaryTopics.map(topic => `
                                    <option value="${topic.id}" ${summarySystemState.selectedTopicForSummary === topic.id ? 'selected' : ''}>
                                        ${topic.name} (${getSummaryTopicCount(topic.id)})
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        ${summarySystemState.summaryTopics.length === 0 ? `
                            <div style="font-size: 12px; color: #0c4a6e; font-style: italic; text-align: center;">
                                Crea temas para organizar tus resÃºmenes
                            </div>
                        ` : ''}
                    </div>
                </div>

                <div class="column">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">ðŸ“ Resumen Generado</h3>
                        ${summarySystemState.generatedSummary ? `
                            <button onclick="saveSummaryToLibrary()" class="btn btn-success" style="padding: 6px 12px; font-size: 12px;">
                                ðŸ’¾ Guardar
                            </button>
                        ` : ''}
                    </div>
                    
                    <textarea id="generatedSummary" class="textarea" placeholder="El resumen aparecerÃ¡ aquÃ­ una vez que proceses una imagen..." readonly>${summarySystemState.generatedSummary}</textarea>
                    
                    ${summarySystemState.generatedSummary ? `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                            <button onclick="copySummaryToClipboard()" class="btn btn-info" style="width: 100%; padding: 8px; font-size: 13px;">
                                ðŸ“‹ Copiar al Portapapeles
                            </button>
                            <button onclick="clearCurrentSummary()" class="btn btn-secondary" style="width: 100%; padding: 8px; font-size: 13px;">
                                ðŸ—‘ï¸ Limpiar Resumen
                            </button>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 15px; background: #f0fdf4; border: 2px solid #22c55e; border-radius: 8px;">
                            <h4 style="color: #166534; margin-bottom: 10px;">âœ… Â¡Resumen generado exitosamente!</h4>
                            <p style="margin: 0; font-size: 13px; color: #16a34a;">
                                Puedes guardar este resumen, copiarlo al portapapeles, o crear uno nuevo.
                            </p>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    // FunciÃ³n para renderizar la biblioteca de resÃºmenes
    function renderSummaryLibrary() {
        return `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h2 style="color: #1f2937; margin: 0;">ðŸ“š Biblioteca de ResÃºmenes</h2>
                    <p style="color: #6b7280; margin: 5px 0 0 0; font-size: 14px;">Explora tus resÃºmenes organizados por temas</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="showCreateSummary()" class="btn btn-primary">
                        âž• Crear Nuevo
                    </button>
                    <button onclick="backToIntermediateScreen()" class="btn btn-secondary">
                        â† Volver al MenÃº Principal
                    </button>
                </div>
            </div>
            
            ${summarySystemState.savedSummaries.length === 0 ? `
                <div style="text-align: center; padding: 80px; color: #9ca3af;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">ðŸ“„</div>
                    <h3 style="color: #6b7280; margin-bottom: 15px;">No hay resÃºmenes guardados</h3>
                    <p style="color: #9ca3af; margin-bottom: 30px;">Crea tu primer resumen para comenzar tu biblioteca</p>
                    <button onclick="showCreateSummary()" class="btn btn-primary" style="font-size: 1.1rem; padding: 15px 30px;">
                        ðŸ“„ Crear Primer Resumen
                    </button>
                </div>
            ` : renderSummariesByTopic()}
        `;
    }
    
    // FunciÃ³n para renderizar resÃºmenes agrupados por tema
    function renderSummariesByTopic() {
        const summariesWithoutTopic = summarySystemState.savedSummaries.filter(s => !s.topicId);
        let html = '';
        
        // Control de temas
        if (summarySystemState.summaryTopics.length > 0) {
            html += `
                <div style="margin-bottom: 30px; padding: 20px; background: #f8fafc; border-radius: 12px; border: 2px solid #e2e8f0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="color: #374151; margin: 0 0 5px 0;">Control de Biblioteca</h3>
                            <p style="color: #6b7280; margin: 0; font-size: 14px;">Tienes ${summarySystemState.savedSummaries.length} resÃºmen${summarySystemState.savedSummaries.length === 1 ? '' : 'es'} en ${summarySystemState.summaryTopics.length} tema${summarySystemState.summaryTopics.length === 1 ? '' : 's'}</p>
                        </div>
                        <button onclick="clearAllSummaries()" class="btn btn-danger" style="padding: 8px 16px;">
                            ðŸ—‘ï¸ Limpiar Todo
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Mostrar resÃºmenes por cada tema que TENGA resÃºmenes
        summarySystemState.summaryTopics.forEach(topic => {
            const topicSummaries = summarySystemState.savedSummaries.filter(s => s.topicId && s.topicId.toString() === topic.id.toString());
            if (topicSummaries.length > 0) {
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="background: linear-gradient(135deg, #059669, #0ea5e9); color: white; padding: 15px 20px; border-radius: 12px 12px 0 0; margin: 0; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <span style="display: flex; align-items: center; gap: 10px;">
                                <span>ðŸ“‚</span>
                                <span>${topic.name}</span>
                            </span>
                            <span style="font-size: 14px; opacity: 0.9; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px;">
                                ${topicSummaries.length} resÃºmen${topicSummaries.length === 1 ? '' : 'es'}
                            </span>
                        </h3>
                        <div style="background: white; border: 2px solid #e2e8f0; border-top: none; border-radius: 0 0 12px 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <div style="display: grid; gap: 0;">
                                ${topicSummaries.map((summary, index) => renderSingleSummary(summary, index)).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
        });
        
        // Mostrar resÃºmenes sin tema asignado SI existen
        if (summariesWithoutTopic.length > 0) {
            html += `
                <div style="margin-bottom: 30px;">
                    <h3 style="background: #6b7280; color: white; padding: 15px 20px; border-radius: 12px 12px 0 0; margin: 0; display: flex; justify-content: space-between; align-items: center;">
                        <span style="display: flex; align-items: center; gap: 10px;">
                            <span>ðŸ“„</span>
                            <span>Sin tema asignado</span>
                        </span>
                        <span style="font-size: 14px; opacity: 0.9; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px;">
                            ${summariesWithoutTopic.length} resÃºmen${summariesWithoutTopic.length === 1 ? '' : 'es'}
                        </span>
                    </h3>
                    <div style="background: white; border: 2px solid #e2e8f0; border-top: none; border-radius: 0 0 12px 12px;">
                        <div style="display: grid; gap: 0;">
                            ${summariesWithoutTopic.map((summary, index) => renderSingleSummary(summary, index)).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        if (html === '') {
            return '<div style="padding: 40px; text-align: center; color: #9ca3af;">No hay resÃºmenes disponibles en la biblioteca</div>';
        }
        
        return html;
    }
    
    // FunciÃ³n para renderizar un resumen individual
    function renderSingleSummary(summary, index) {
        const actualIndex = summarySystemState.savedSummaries.findIndex(s => s.id === summary.id);
        const topicName = summary.topicId ? getSummaryTopicName(summary.topicId) : null;
        
        return `
            <div style="padding: 20px; border-bottom: 1px solid #f3f4f6; transition: all 0.2s; cursor: pointer;" 
                 onmouseover="this.style.backgroundColor='#f9fafb';" 
                 onmouseout="this.style.backgroundColor='white';"
                 onclick="viewSummary(${actualIndex})">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1; margin-right: 15px;">
                        <h4 style="margin: 0 0 8px 0; color: #1f2937; font-size: 16px; font-weight: 600;">
                            ${summary.title}
                        </h4>
                        <p style="margin: 0 0 8px 0; color: #6b7280; font-size: 14px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                            ${summary.content.substring(0, 120)}...
                        </p>
                        <div style="display: flex; align-items: center; gap: 15px; font-size: 12px; color: #9ca3af;">
                            <span>ðŸ“… ${summary.createdAt}</span>
                            ${topicName && !summary.topicId ? `` : ''}
                            <span>${summary.content.length} caracteres</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: flex-start;">
                        <button onclick="event.stopPropagation(); editSummary(${actualIndex})" class="btn btn-warning" style="padding: 6px 12px; font-size: 11px;" title="Editar resumen">
                            âœï¸
                        </button>
                        <button onclick="event.stopPropagation(); deleteSummary(${actualIndex})" class="btn btn-danger" style="padding: 6px 12px; font-size: 11px;" title="Eliminar resumen">
                            ðŸ—‘ï¸
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    // FunciÃ³n para renderizar la visualizaciÃ³n de un resumen especÃ­fico
    function renderViewSummary() {
        const summary = summarySystemState.viewingSummary;
        const topicName = summary.topicId ? getSummaryTopicName(summary.topicId) : 'Sin tema';
        
        return `
            <div style="max-width: 1000px; margin: 0 auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <div>
                        <button onclick="closeSummaryView()" class="btn btn-secondary" style="margin-bottom: 15px;">
                            â† Volver a la Biblioteca
                        </button>
                        <h1 style="color: #1f2937; margin: 0; font-size: 2rem;">${summary.title}</h1>
                        <div style="margin-top: 10px; display: flex; align-items: center; gap: 20px; color: #6b7280; font-size: 14px;">
                            <span>ðŸ“‚ ${topicName}</span>
                            <span>ðŸ“… ${summary.createdAt}</span>
                            <span>ðŸ“ ${summary.content.length} caracteres</span>
                        </div>
                    </div>
                </div>
                
                <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
                    <div style="prose max-w-none;">
                        <div style="white-space: pre-wrap; line-height: 1.7; color: #374151; font-size: 16px;">
                            ${summary.content}
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px; display: flex; justify-content: center; gap: 15px;">
                    <button onclick="copySummaryContentToClipboard('${summary.id}')" class="btn btn-info" style="padding: 12px 24px;">
                        ðŸ“‹ Copiar Contenido
                    </button>
                    <button onclick="editSummaryFromView()" class="btn btn-warning" style="padding: 12px 24px;">
                        âœï¸ Editar Resumen
                    </button>
                    <button onclick="deleteSummaryFromView('${summary.id}')" class="btn btn-danger" style="padding: 12px 24px;">
                        ðŸ—‘ï¸ Eliminar Resumen
                    </button>
                </div>
            </div>
        `;
    }
    
    // ========== FUNCIONES DE GESTIÃ“N ==========
    
    function showCreateSummary() {
        summarySystemState.currentView = 'create';
        summarySystemState.viewingSummary = null;
        render();
    }
    
    function showSummaryLibrary() {
        summarySystemState.currentView = 'library';
        summarySystemState.viewingSummary = null;
        render();
    }
    
    function createSummaryTopic() {
        const name = prompt('Nombre del nuevo tema de resÃºmenes:');
        if (name && name.trim()) {
            const newTopic = {
                id: Date.now() + Math.random(),
                name: name.trim(),
                createdAt: new Date().toLocaleString('es-ES')
            };
            
            summarySystemState.summaryTopics.push(newTopic);
            localStorage.setItem('summaryTopics', JSON.stringify(summarySystemState.summaryTopics));
            render();
            showMessage(`Tema "${name}" creado exitosamente`, 'success');
        }
    }
    
    function updateSelectedSummaryTopic() {
        const selector = document.getElementById('summary-topic-selector');
        if (selector && selector.value) {
            const selectedValue = selector.value;
            const selectedTopic = summarySystemState.summaryTopics.find(t => t.id == selectedValue);
            if (selectedTopic) {
                summarySystemState.selectedTopicForSummary = selectedTopic.id;
                showMessage(`Tema "${selectedTopic.name}" seleccionado`, 'success');
            } else {
                summarySystemState.selectedTopicForSummary = selectedValue;
            }
        } else {
            summarySystemState.selectedTopicForSummary = null;
        }
    }
    
    function getSummaryTopicName(topicId) {
        if (!topicId) return 'Sin tema';
        const topic = summarySystemState.summaryTopics.find(t => t.id.toString() === topicId.toString());
        return topic ? topic.name : 'Tema no encontrado';
    }
    
    function getSummaryTopicCount(topicId) {
        return summarySystemState.savedSummaries.filter(s => s.topicId && s.topicId.toString() === topicId.toString()).length;
    }
    
    function saveSummaryToLibrary() {
        if (!summarySystemState.generatedSummary) {
            showMessage('No hay resumen para guardar', 'error');
            return;
        }
        
        const title = prompt('TÃ­tulo para el resumen:') || 'Resumen sin tÃ­tulo';
        if (!title.trim()) return;
        
        const newSummary = {
            id: Date.now() + Math.random(),
            title: title.trim(),
            content: summarySystemState.generatedSummary,
            topicId: summarySystemState.selectedTopicForSummary,
            createdAt: new Date().toLocaleString('es-ES')
        };
        
        summarySystemState.savedSummaries.push(newSummary);
        localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
        
        const topicName = summarySystemState.selectedTopicForSummary ? getSummaryTopicName(summarySystemState.selectedTopicForSummary) : 'sin tema';
        showMessage(`Resumen "${title}" guardado en ${topicName}`, 'success');
        
        // Limpiar formulario despuÃ©s de guardar
        summarySystemState.selectedImages = [];
        summarySystemState.generatedSummary = '';
        summarySystemState.selectedTopicForSummary = null;
        render();
    }
    
    function viewSummary(index) {
        summarySystemState.viewingSummary = summarySystemState.savedSummaries[index];
        render();
    }
    
    function closeSummaryView() {
        summarySystemState.viewingSummary = null;
        summarySystemState.currentView = 'library';
        render();
    }
    
    function editSummary(index) {
        // ImplementaciÃ³n de ediciÃ³n de resumen
        const summary = summarySystemState.savedSummaries[index];
        const newTitle = prompt('Nuevo tÃ­tulo:', summary.title);
        if (newTitle && newTitle.trim()) {
            summarySystemState.savedSummaries[index].title = newTitle.trim();
            localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
            render();
            showMessage('Resumen actualizado', 'success');
        }
    }
    
    function deleteSummary(index) {
        const summary = summarySystemState.savedSummaries[index];
        if (confirm(`Â¿Eliminar el resumen "${summary.title}"?`)) {
            summarySystemState.savedSummaries.splice(index, 1);
            localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
            render();
            showMessage('Resumen eliminado', 'success');
        }
    }
    
    function clearAllSummaries() {
        if (confirm('Â¿Eliminar todos los resÃºmenes y temas? Esta acciÃ³n no se puede deshacer.')) {
            summarySystemState.savedSummaries = [];
            summarySystemState.summaryTopics = [];
            localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
            localStorage.setItem('summaryTopics', JSON.stringify(summarySystemState.summaryTopics));
            render();
            showMessage('Biblioteca de resÃºmenes limpiada', 'success');
        }
    }
    
    function copySummaryContentToClipboard(summaryId) {
        const summary = summarySystemState.savedSummaries.find(s => s.id == summaryId);
        if (summary) {
            navigator.clipboard.writeText(summary.content).then(() => {
                showMessage('Contenido copiado al portapapeles', 'success');
            }).catch(() => {
                showMessage('Error al copiar', 'error');
            });
        }
    }
    
    // Funciones auxiliares redefinidas
    function removeSummaryImage() {
        summarySystemState.selectedImages = [];
        summarySystemState.generatedSummary = '';
        render();
        showMessage('Imagen eliminada', 'success');
    }
    
    function clearCurrentSummary() {
        if (confirm('Â¿Limpiar el resumen actual?')) {
            summarySystemState.generatedSummary = '';
            render();
            showMessage('Resumen limpiado', 'success');
        }
    }
    
    async function generateSummary() {
        if (!state.apiKey) {
            showMessage('Configura tu API key primero', 'error');
            return;
        }

        if (summarySystemState.selectedImages.length === 0) {
            showMessage('Selecciona una imagen primero', 'error');
            return;
        }

        summarySystemState.isProcessing = true;
        render();
        showMessage('Generando resumen...', 'success');
        
        try {
            const file = summarySystemState.selectedImages[0];
            const base64 = await fileToBase64(file);
            
            const messageContent = [
                {
                    type: "image",
                    source: {
                        type: "base64",
                        media_type: file.type,
                        data: base64
                    }
                },
                {
                    type: "text",
                    text: `ActÃºa como un asistente experto en anÃ¡lisis y sÃ­ntesis de informaciÃ³n. Analiza esta imagen y genera un resumen completo e inteligente del contenido.

INSTRUCCIONES PARA EL RESUMEN:

ðŸŽ¯ OBJETIVO: Crear un resumen estructurado, claro y Ãºtil que capture la esencia del contenido

ðŸ“‹ FORMATO DEL RESUMEN:
â€¢ Comienza con una breve descripciÃ³n del tipo de documento/contenido
â€¢ Organiza la informaciÃ³n en secciones lÃ³gicas con encabezados
â€¢ Usa viÃ±etas y numeraciÃ³n cuando sea apropiado
â€¢ Incluye los puntos mÃ¡s importantes y relevantes
â€¢ Termina con conclusiones o puntos clave si es relevante

ðŸ” QUÃ‰ INCLUIR:
- Ideas principales y conceptos clave
- Datos importantes, cifras, fechas relevantes
- Argumentos o puntos de vista presentados
- Conclusiones o recomendaciones si las hay
- Cualquier informaciÃ³n prÃ¡ctica o accionable

âœ¨ ESTILO:
- Lenguaje claro y profesional
- Oraciones concisas pero informativas  
- Estructura fÃ¡cil de leer y escanear
- Adapta el tono al tipo de contenido (acadÃ©mico, empresarial, tÃ©cnico, etc.)

ðŸš« EVITA:
- Repetir informaciÃ³n innecesaria
- Incluir detalles muy tÃ©cnicos a menos que sean cruciales
- Hacer el resumen demasiado largo (mÃ¡ximo 500 palabras)
- Copiar texto textualmente sin reorganizar

Genera un resumen que sea verdaderamente Ãºtil para alguien que quiere entender rÃ¡pidamente el contenido esencial del documento.`
                }
            ];

            const response = await fetch("/api/anthropic", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-api-key": state.apiKey,
                },
                body: JSON.stringify({
                    model: "claude-sonnet-4-20250514",
                    max_tokens: 2000,
                    messages: [{
                        role: "user",
                        content: messageContent
                    }]
                })
            });

            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            summarySystemState.generatedSummary = data.content[0].text;
            summarySystemState.isProcessing = false;
            
            render();
            showMessage('Â¡Resumen generado exitosamente!', 'success');
            
        } catch (error) {
            summarySystemState.isProcessing = false;
            render();
            showMessage(`Error al generar resumen: ${error.message}`, 'error');
        }
    }
    
    async function copySummaryToClipboard() {
        try {
            await navigator.clipboard.writeText(summarySystemState.generatedSummary);
            showMessage('Resumen copiado al portapapeles', 'success');
        } catch (error) {
            const textArea = document.createElement('textarea');
            textArea.value = summarySystemState.generatedSummary;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showMessage('Resumen copiado al portapapeles', 'success');
            } catch (err) {
                showMessage('Error al copiar', 'error');
            }
            document.body.removeChild(textArea);
        }
    }
    
    // Event listener para selecciÃ³n de imÃ¡genes (actualizado)
    document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'summaryImageInput') {
            const files = Array.from(e.target.files);
            const imageFile = files.filter(file => file.type.startsWith('image/'))[0];
            
            if (imageFile) {
                summarySystemState.selectedImages = [imageFile];
                summarySystemState.generatedSummary = '';
                render();
                showMessage('Imagen seleccionada correctamente', 'success');
            }
        }
    });
    
    console.log('âœ… Sistema de ResÃºmenes Completo con Temas aplicado correctamente');
</script>
    <!-- 
PARCHE CORRECCIÃ“N: OCULTAR PESTAÃ‘AS Y MEJORAR VISUALIZACIÃ“N DE RESÃšMENES
AÃ±adir este cÃ³digo AL FINAL del archivo index.html, justo antes de </body>
Este parche corrige la visualizaciÃ³n de las pestaÃ±as y mejora la vista de resÃºmenes
-->

<script>
    // ========== PARCHE CORRECCIÃ“N: INTERFAZ DE RESÃšMENES ==========
    
    // REEMPLAZAR completamente la funciÃ³n render para corregir las pestaÃ±as
    const originalRenderComplete = render;
    render = function() {
        if (showIntermediateScreen && state.currentUser) {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <div class="title">Sistema de ExÃ¡menes</div>
                        <div>
                            <span style="color: ${state.apiKey ? '#10b981' : '#ef4444'};">
                                ${state.apiKey ? 'âœ… API Configurada' : 'âŒ Sin API'}
                            </span>
                            <button onclick="configureAPI()" class="btn btn-secondary">API</button>
                            <span style="color: #f59e0b;">ðŸ‘¤ ${state.currentUser.name}</span>
                            <button onclick="logout()" class="btn btn-danger">Salir</button>
                        </div>
                    </div>
                    ${renderIntermediateScreen()}
                </div>
            `;
        } else if (state.currentUser) {
            const app = document.getElementById('app');
            
            // Determinar el tÃ­tulo segÃºn la pestaÃ±a actual
            let pageTitle = 'Sistema de ExÃ¡menes';
            if (state.currentTab === 'questions') pageTitle = 'Banco de Preguntas';
            else if (state.currentTab === 'results') pageTitle = 'Resultados del Test';
            else if (state.currentTab === 'summary') pageTitle = 'Generador de ResÃºmenes';
            
            // CRÃTICO: Solo mostrar pestaÃ±as si NO estamos en summary
            const showNavTabs = state.currentTab !== 'summary';
            
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <div class="title">${pageTitle}</div>
                        <div>
                            <span style="color: ${state.apiKey ? '#10b981' : '#ef4444'};">
                                ${state.apiKey ? 'âœ… API Configurada' : 'âŒ Sin API'}
                            </span>
                            <button onclick="configureAPI()" class="btn btn-secondary">API</button>
                            <span style="color: #f59e0b;">ðŸ‘¤ ${state.currentUser.name}</span>
                            <button onclick="logout()" class="btn btn-danger">Salir</button>
                        </div>
                    </div>

                    ${showNavTabs ? `
                        <div class="nav-tabs">
                            <button class="nav-tab ${state.currentTab === 'upload' ? 'active' : ''}" onclick="setTab('upload')">
                                ðŸ“¤ Subir Test
                            </button>
                            <button class="nav-tab ${state.currentTab === 'questions' ? 'active' : ''}" onclick="setTab('questions')">
                                ðŸ“‹ Banco de Preguntas (${getFilteredQuestions().length})
                            </button>
                            <button class="nav-tab ${state.currentTab === 'test' ? 'active' : ''}" onclick="setTab('test')">
                                ðŸŽ¯ Test Aleatorio
                            </button>
                            <button class="nav-tab ${state.currentTab === 'results' ? 'active' : ''}" onclick="setTab('results')">
                                ðŸ“Š Resultados (${state.testResults.length})
                            </button>
                        </div>
                    ` : ''}

                    <div id="messages"></div>

                    ${renderTabContent()}
                </div>
            `;
        } else {
            // Usuario no logueado - mostrar login
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <div class="login-form">
                        <h2 style="text-align: center; margin-bottom: 30px;">Iniciar SesiÃ³n</h2>
                        <div class="form-group">
                            <label class="form-label">Usuario</label>
                            <input type="text" id="username" class="form-input" placeholder="demo">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ContraseÃ±a</label>
                            <input type="password" id="password" class="form-input" placeholder="demo123">
                        </div>
                        <button onclick="login()" class="btn btn-primary" style="width: 100%;">
                            Iniciar SesiÃ³n
                        </button>
                        <div style="text-align: center; margin-top: 15px; color: #6b7280; font-size: 14px;">
                            Usuario: demo | ContraseÃ±a: demo123
                        </div>
                    </div>
                </div>
            `;
        }
    };
    
    // MEJORAR la funciÃ³n renderViewSummary para una mejor visualizaciÃ³n
    const originalRenderViewSummary = renderViewSummary;
    renderViewSummary = function() {
        const summary = summarySystemState.viewingSummary;
        const topicName = summary.topicId ? getSummaryTopicName(summary.topicId) : 'Sin tema';
        
        return `
            <div style="max-width: 1200px; margin: 0 auto;">
                <!-- Header con navegaciÃ³n -->
                <div style="margin-bottom: 30px;">
                    <button onclick="closeSummaryView()" class="btn btn-secondary" style="margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                        <span>â†</span> Volver a la Biblioteca
                    </button>
                    
                    <!-- TÃ­tulo y metadata -->
                    <div style="background: linear-gradient(135deg, #f8fafc, #e2e8f0); border-radius: 16px; padding: 30px; border: 2px solid #e2e8f0;">
                        <h1 style="color: #1f2937; margin: 0 0 15px 0; font-size: 2.5rem; font-weight: 700; line-height: 1.2;">
                            ${summary.title}
                        </h1>
                        <div style="display: flex; flex-wrap: wrap; gap: 20px; color: #6b7280; font-size: 15px;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="color: #059669;">ðŸ“‚</span>
                                <strong>${topicName}</strong>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="color: #0ea5e9;">ðŸ“…</span>
                                ${summary.createdAt}
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="color: #f59e0b;">ðŸ“</span>
                                ${summary.content.length} caracteres
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Contenido del resumen con formato mejorado -->
                <div style="background: white; border: 2px solid #e2e8f0; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                    <!-- Header del contenido -->
                    <div style="background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; padding: 20px 30px;">
                        <h2 style="margin: 0; font-size: 1.3rem; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                            <span>ðŸ“„</span> Contenido del Resumen
                        </h2>
                    </div>
                    
                    <!-- Contenido formateado -->
                    <div style="padding: 40px;">
                        <div style="font-size: 16px; line-height: 1.8; color: #374151; max-width: none;">
                            ${formatSummaryContent(summary.content)}
                        </div>
                    </div>
                </div>
                
                <!-- Acciones -->
                <div style="margin-top: 30px; padding: 25px; background: #f9fafb; border-radius: 16px; border: 2px solid #f3f4f6;">
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;">
                        <button onclick="copySummaryContentToClipboard('${summary.id}')" class="btn btn-info" style="padding: 12px 24px; font-size: 15px; display: flex; align-items: center; gap: 8px; flex: 1; max-width: 200px; justify-content: center;">
                            <span>ðŸ“‹</span> Copiar Contenido
                        </button>
                        <button onclick="editSummaryFromView()" class="btn btn-warning" style="padding: 12px 24px; font-size: 15px; display: flex; align-items: center; gap: 8px; flex: 1; max-width: 200px; justify-content: center;">
                            <span>âœï¸</span> Editar Resumen
                        </button>
                        <button onclick="deleteSummaryFromView('${summary.id}')" class="btn btn-danger" style="padding: 12px 24px; font-size: 15px; display: flex; align-items: center; gap: 8px; flex: 1; max-width: 200px; justify-content: center;">
                            <span>ðŸ—‘ï¸</span> Eliminar Resumen
                        </button>
                    </div>
                </div>
            </div>
        `;
    };
    
    // Nueva funciÃ³n para formatear el contenido del resumen
    function formatSummaryContent(content) {
        // Dividir el contenido en pÃ¡rrafos
        const paragraphs = content.split('\n').filter(line => line.trim());
        
        return paragraphs.map(paragraph => {
            const trimmed = paragraph.trim();
            
            // Detectar tÃ­tulos (lÃ­neas que terminan con ":" o que son muy cortas y estÃ¡n en mayÃºsculas)
            if (trimmed.endsWith(':') && trimmed.length < 80) {
                return `<h3 style="color: #1f2937; font-size: 1.2rem; font-weight: 700; margin: 25px 0 15px 0; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0;">${trimmed}</h3>`;
            }
            
            // Detectar listas con viÃ±etas (lÃ­neas que empiezan con â€¢, -, *, o nÃºmeros)
            if (trimmed.match(/^[â€¢\-\*]\s+/) || trimmed.match(/^\d+\.\s+/)) {
                return `<div style="margin: 8px 0; padding-left: 20px; border-left: 3px solid #e2e8f0; color: #4b5563;">${trimmed}</div>`;
            }
            
            // Detectar secciones importantes (lÃ­neas con palabras clave)
            if (trimmed.match(/^(CONCLUSIÃ“N|RESUMEN|IMPORTANTE|NOTA|OBJETIVO|INTRODUCCIÃ“N|DESARROLLO)/i)) {
                return `<div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 15px; margin: 15px 0; color: #0c4a6e; font-weight: 500;">${trimmed}</div>`;
            }
            
            // PÃ¡rrafos normales
            return `<p style="margin: 15px 0; text-align: justify;">${trimmed}</p>`;
        }).join('');
    }
    
    // FunciÃ³n para editar desde la vista (nueva funcionalidad)
    function editSummaryFromView() {
        const summary = summarySystemState.viewingSummary;
        const newTitle = prompt('Nuevo tÃ­tulo:', summary.title);
        
        if (newTitle && newTitle.trim()) {
            const index = summarySystemState.savedSummaries.findIndex(s => s.id === summary.id);
            if (index !== -1) {
                summarySystemState.savedSummaries[index].title = newTitle.trim();
                summarySystemState.viewingSummary.title = newTitle.trim(); // Actualizar vista actual
                localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
                render();
                showMessage('TÃ­tulo del resumen actualizado', 'success');
            }
        }
    }
    
    // FunciÃ³n para eliminar desde la vista (nueva funcionalidad)
    function deleteSummaryFromView(summaryId) {
        const summary = summarySystemState.savedSummaries.find(s => s.id == summaryId);
        if (summary && confirm(`Â¿Eliminar el resumen "${summary.title}"? Esta acciÃ³n no se puede deshacer.`)) {
            const index = summarySystemState.savedSummaries.findIndex(s => s.id == summaryId);
            if (index !== -1) {
                summarySystemState.savedSummaries.splice(index, 1);
                localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
                showMessage('Resumen eliminado', 'success');
                
                // Volver a la biblioteca despuÃ©s de eliminar
                summarySystemState.viewingSummary = null;
                summarySystemState.currentView = 'library';
                render();
            }
        }
    }
    
    console.log('âœ… Parche de correcciÃ³n aplicado - PestaÃ±as ocultas y visualizaciÃ³n mejorada');
</script>
    <!-- 
PARCHE: CORRECCIÃ“N DEL CLIC EN RESÃšMENES
AÃ±adir este cÃ³digo AL FINAL del archivo index.html, justo antes de </body>
Este parche corrige la funcionalidad de visualizaciÃ³n de resÃºmenes
-->

<script>
    // ========== PARCHE: CORRECCIÃ“N VISUALIZACIÃ“N DE RESÃšMENES ==========
    
    // REEMPLAZAR la funciÃ³n renderSingleSummary para asegurar el clic correcto
    function renderSingleSummary(summary, index) {
        const actualIndex = summarySystemState.savedSummaries.findIndex(s => s.id === summary.id);
        const topicName = summary.topicId ? getSummaryTopicName(summary.topicId) : null;
        
        return `
            <div style="padding: 20px; border-bottom: 1px solid #f3f4f6; transition: all 0.2s; cursor: pointer; position: relative;" 
                 onmouseover="this.style.backgroundColor='#f9fafb';" 
                 onmouseout="this.style.backgroundColor='white';">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1; margin-right: 15px;" onclick="openSummaryView(${actualIndex})">
                        <h4 style="margin: 0 0 8px 0; color: #1f2937; font-size: 16px; font-weight: 600;">
                            ${summary.title}
                        </h4>
                        <p style="margin: 0 0 8px 0; color: #6b7280; font-size: 14px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                            ${summary.content.substring(0, 120)}...
                        </p>
                        <div style="display: flex; align-items: center; gap: 15px; font-size: 12px; color: #9ca3af;">
                            <span>ðŸ“… ${summary.createdAt}</span>
                            <span>${summary.content.length} caracteres</span>
                            <span style="background: #e0f2fe; color: #01579b; padding: 2px 8px; border-radius: 12px; font-weight: 500;">ðŸ‘† Click para ver</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: flex-start;">
                        <button onclick="event.stopPropagation(); editSummaryTitle(${actualIndex})" class="btn btn-warning" style="padding: 6px 12px; font-size: 11px;" title="Editar resumen">
                            âœï¸
                        </button>
                        <button onclick="event.stopPropagation(); deleteSummaryConfirm(${actualIndex})" class="btn btn-danger" style="padding: 6px 12px; font-size: 11px;" title="Eliminar resumen">
                            ðŸ—‘ï¸
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Nueva funciÃ³n especÃ­fica para abrir la vista del resumen
    function openSummaryView(index) {
        console.log('Abriendo vista de resumen, Ã­ndice:', index);
        
        if (summarySystemState.savedSummaries[index]) {
            summarySystemState.viewingSummary = summarySystemState.savedSummaries[index];
            summarySystemState.currentView = 'view';
            console.log('Vista de resumen configurada:', summarySystemState.viewingSummary.title);
            render();
            
            // Scroll suave al inicio
            setTimeout(() => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 100);
        } else {
            console.error('Resumen no encontrado en Ã­ndice:', index);
            showMessage('Error: No se pudo abrir el resumen', 'error');
        }
    }
    
    // FunciÃ³n especÃ­fica para editar tÃ­tulo
    function editSummaryTitle(index) {
        const summary = summarySystemState.savedSummaries[index];
        if (!summary) return;
        
        const newTitle = prompt('Nuevo tÃ­tulo:', summary.title);
        if (newTitle && newTitle.trim()) {
            summarySystemState.savedSummaries[index].title = newTitle.trim();
            localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
            render();
            showMessage('TÃ­tulo actualizado', 'success');
        }
    }
    
    // FunciÃ³n especÃ­fica para confirmar eliminaciÃ³n
    function deleteSummaryConfirm(index) {
        const summary = summarySystemState.savedSummaries[index];
        if (!summary) return;
        
        if (confirm(`Â¿Eliminar el resumen "${summary.title}"?`)) {
            summarySystemState.savedSummaries.splice(index, 1);
            localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
            render();
            showMessage('Resumen eliminado', 'success');
        }
    }
    
    // MEJORAR la funciÃ³n renderSummaryTab para manejar diferentes vistas
    const originalRenderSummaryTabFixed = renderSummaryTab;
    renderSummaryTab = function() {
        console.log('Renderizando resumen tab, vista actual:', summarySystemState.currentView, 'Viendo:', !!summarySystemState.viewingSummary);
        
        // Si estamos viendo un resumen especÃ­fico
        if (summarySystemState.viewingSummary || summarySystemState.currentView === 'view') {
            return renderViewSummaryEnhanced();
        }
        
        // Si estamos en la biblioteca
        if (summarySystemState.currentView === 'library') {
            return renderSummaryLibraryEnhanced();
        }
        
        // Por defecto: crear resumen
        return renderCreateSummary();
    };
    
    // FunciÃ³n mejorada para renderizar la vista del resumen
    function renderViewSummaryEnhanced() {
        const summary = summarySystemState.viewingSummary;
        if (!summary) {
            console.error('No hay resumen para mostrar');
            summarySystemState.currentView = 'library';
            return renderSummaryLibraryEnhanced();
        }
        
        const topicName = summary.topicId ? getSummaryTopicName(summary.topicId) : 'Sin tema';
        
        return `
            <div style="max-width: 1200px; margin: 0 auto; animation: slideIn 0.3s ease-out;">
                <!-- Header con navegaciÃ³n elegante -->
                <div style="margin-bottom: 30px;">
                    <button onclick="closeSummaryViewEnhanced()" class="btn btn-secondary" style="margin-bottom: 25px; display: flex; align-items: center; gap: 10px; padding: 12px 20px; font-size: 15px; font-weight: 500; border-radius: 12px; transition: all 0.3s ease;" onmouseover="this.style.transform='translateX(-5px)'" onmouseout="this.style.transform='translateX(0)'">
                        <span style="font-size: 18px;">â†</span> Volver a la Biblioteca
                    </button>
                    
                    <!-- Tarjeta de tÃ­tulo elegante -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; padding: 40px; color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; overflow: hidden;">
                        <!-- DecoraciÃ³n de fondo -->
                        <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                        <div style="position: absolute; bottom: -30px; left: -30px; width: 100px; height: 100px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>
                        
                        <!-- Contenido del header -->
                        <div style="position: relative; z-index: 1;">
                            <h1 style="margin: 0 0 20px 0; font-size: 2.8rem; font-weight: 800; line-height: 1.2; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                                ${summary.title}
                            </h1>
                            <div style="display: flex; flex-wrap: wrap; gap: 25px; font-size: 16px; opacity: 0.95;">
                                <div style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.15); padding: 8px 16px; border-radius: 25px;">
                                    <span style="font-size: 18px;">ðŸ“‚</span>
                                    <strong>${topicName}</strong>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.15); padding: 8px 16px; border-radius: 25px;">
                                    <span style="font-size: 18px;">ðŸ“…</span>
                                    ${summary.createdAt}
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.15); padding: 8px 16px; border-radius: 25px;">
                                    <span style="font-size: 18px;">ðŸ“</span>
                                    ${summary.content.length} caracteres
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tarjeta del contenido principal -->
                <div style="background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 8px 25px rgba(0,0,0,0.12); margin-bottom: 30px;">
                    <!-- Header del contenido -->
                    <div style="background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; padding: 25px 35px;">
                        <h2 style="margin: 0; font-size: 1.4rem; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">ðŸ“„</span> 
                            <span>Contenido del Resumen</span>
                        </h2>
                    </div>
                    
                    <!-- Contenido formateado con mejor estilo -->
                    <div style="padding: 45px;">
                        <div style="font-size: 17px; line-height: 1.8; color: #2d3748; max-width: none; font-family: 'Georgia', serif;">
                            ${formatSummaryContentAdvanced(summary.content)}
                        </div>
                    </div>
                </div>
                
                <!-- Panel de acciones mejorado -->
                <div style="background: linear-gradient(135deg, #f7fafc, #edf2f7); border-radius: 20px; padding: 30px; border: 2px solid #e2e8f0;">
                    <h3 style="text-align: center; margin: 0 0 25px 0; color: #4a5568; font-size: 1.2rem; font-weight: 600;">Acciones Disponibles</h3>
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;">
                        <button onclick="copySummaryContentToClipboard('${summary.id}')" class="btn btn-info" style="padding: 15px 25px; font-size: 15px; display: flex; align-items: center; gap: 10px; flex: 1; max-width: 220px; justify-content: center; border-radius: 12px; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(14, 165, 233, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'">
                            <span style="font-size: 18px;">ðŸ“‹</span> Copiar Contenido
                        </button>
                        <button onclick="editSummaryFromViewEnhanced()" class="btn btn-warning" style="padding: 15px 25px; font-size: 15px; display: flex; align-items: center; gap: 10px; flex: 1; max-width: 220px; justify-content: center; border-radius: 12px; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(245, 158, 11, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'">
                            <span style="font-size: 18px;">âœï¸</span> Editar TÃ­tulo
                        </button>
                        <button onclick="deleteSummaryFromViewEnhanced('${summary.id}')" class="btn btn-danger" style="padding: 15px 25px; font-size: 15px; display: flex; align-items: center; gap: 10px; flex: 1; max-width: 220px; justify-content: center; border-radius: 12px; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(239, 68, 68, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'">
                            <span style="font-size: 18px;">ðŸ—‘ï¸</span> Eliminar Resumen
                        </button>
                    </div>
                </div>
            </div>
            
            <style>
                @keyframes slideIn {
                    from {
                        opacity: 0;
                        transform: translateY(20px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
            </style>
        `;
    }
    
    // FunciÃ³n para formatear contenido con mÃ¡s opciones
    function formatSummaryContentAdvanced(content) {
        const paragraphs = content.split('\n').filter(line => line.trim());
        
        return paragraphs.map(paragraph => {
            const trimmed = paragraph.trim();
            
            // TÃ­tulos principales
            if (trimmed.endsWith(':') && trimmed.length < 80) {
                return `<h3 style="color: #2d3748; font-size: 1.3rem; font-weight: 800; margin: 30px 0 18px 0; padding: 12px 0; border-bottom: 3px solid #4f46e5; background: linear-gradient(90deg, #4f46e5, transparent); background-size: 100px 3px; background-repeat: no-repeat; background-position: bottom;">${trimmed}</h3>`;
            }
            
            // Listas
            if (trimmed.match(/^[â€¢\-\*]\s+/) || trimmed.match(/^\d+\.\s+/)) {
                return `<div style="margin: 12px 0; padding: 15px 20px; background: #f7fafc; border-left: 4px solid #4f46e5; border-radius: 0 8px 8px 0; color: #2d3748; font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">${trimmed}</div>`;
            }
            
            // Secciones destacadas
            if (trimmed.match(/^(CONCLUSIÃ“N|RESUMEN|IMPORTANTE|NOTA|OBJETIVO|INTRODUCCIÃ“N|DESARROLLO)/i)) {
                return `<div style="background: linear-gradient(135deg, #e0f2fe, #f0f9ff); border: 2px solid #0ea5e9; border-radius: 12px; padding: 20px; margin: 20px 0; color: #0c4a6e; font-weight: 600; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15);">${trimmed}</div>`;
            }
            
            // PÃ¡rrafos normales con mejor estilo
            return `<p style="margin: 18px 0; text-align: justify; font-size: 17px; line-height: 1.8; color: #4a5568; text-indent: 20px;">${trimmed}</p>`;
        }).join('');
    }
    
    // Funciones auxiliares mejoradas
    function closeSummaryViewEnhanced() {
        summarySystemState.viewingSummary = null;
        summarySystemState.currentView = 'library';
        render();
    }
    
    function editSummaryFromViewEnhanced() {
        const summary = summarySystemState.viewingSummary;
        const newTitle = prompt('Nuevo tÃ­tulo:', summary.title);
        
        if (newTitle && newTitle.trim()) {
            const index = summarySystemState.savedSummaries.findIndex(s => s.id === summary.id);
            if (index !== -1) {
                summarySystemState.savedSummaries[index].title = newTitle.trim();
                summarySystemState.viewingSummary.title = newTitle.trim();
                localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
                render();
                showMessage('TÃ­tulo del resumen actualizado', 'success');
            }
        }
    }
    
    function deleteSummaryFromViewEnhanced(summaryId) {
        const summary = summarySystemState.savedSummaries.find(s => s.id == summaryId);
        if (summary && confirm(`Â¿Eliminar el resumen "${summary.title}"? Esta acciÃ³n no se puede deshacer.`)) {
            const index = summarySystemState.savedSummaries.findIndex(s => s.id == summaryId);
            if (index !== -1) {
                summarySystemState.savedSummaries.splice(index, 1);
                localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
                showMessage('Resumen eliminado', 'success');
                
                summarySystemState.viewingSummary = null;
                summarySystemState.currentView = 'library';
                render();
            }
        }
    }
    
    // FunciÃ³n mejorada para la biblioteca
    function renderSummaryLibraryEnhanced() {
        return renderSummaryLibrary(); // Usar la funciÃ³n existente
    }
    
    console.log('âœ… Parche de correcciÃ³n de visualizaciÃ³n aplicado correctamente');
</script>
    <!-- 
PARCHE: LIMPIEZA Y FORMATO ELEGANTE DE RESÃšMENES
AÃ±adir este cÃ³digo AL FINAL del archivo index.html, justo antes de </body>
Este parche limpia el contenido y lo presenta de forma elegante
-->

<script>
    // ========== PARCHE: LIMPIEZA DE FORMATO DE RESÃšMENES ==========
    
    // REEMPLAZAR la funciÃ³n de formateo para limpiar el contenido
    function formatSummaryContentAdvanced(content) {
        // Limpiar el contenido de sÃ­mbolos de formato
        const cleanedContent = cleanSummaryText(content);
        
        // Dividir en lÃ­neas y procesar
        const lines = cleanedContent.split('\n').filter(line => line.trim());
        
        return lines.map(line => {
            const trimmed = line.trim();
            if (!trimmed) return '';
            
            // Detectar tÃ­tulos principales (lÃ­neas cortas que parecen encabezados)
            if (isTitleLine(trimmed)) {
                return `
                    <div style="margin: 35px 0 20px 0; padding: 0 0 12px 0; border-bottom: 2px solid #e2e8f0;">
                        <h3 style="color: #1a202c; font-size: 1.3rem; font-weight: 700; margin: 0; letter-spacing: -0.025em;">
                            ${trimmed}
                        </h3>
                    </div>
                `;
            }
            
            // Detectar subtÃ­tulos
            if (isSubtitleLine(trimmed)) {
                return `
                    <div style="margin: 25px 0 15px 0;">
                        <h4 style="color: #2d3748; font-size: 1.1rem; font-weight: 600; margin: 0; padding: 8px 16px; background: #f7fafc; border-left: 4px solid #4f46e5; border-radius: 0 8px 8px 0;">
                            ${trimmed}
                        </h4>
                    </div>
                `;
            }
            
            // Detectar elementos de lista (lÃ­neas que empiezan con guiÃ³n o nÃºmero)
            if (isListItem(trimmed)) {
                return `
                    <div style="margin: 10px 0; padding: 12px 20px; background: #f8fafc; border-left: 3px solid #cbd5e0; border-radius: 0 6px 6px 0; color: #4a5568;">
                        ${cleanListItem(trimmed)}
                    </div>
                `;
            }
            
            // PÃ¡rrafos normales
            return `
                <p style="margin: 16px 0; line-height: 1.7; color: #4a5568; text-align: justify; font-size: 16px;">
                    ${trimmed}
                </p>
            `;
        }).join('');
    }
    
    // FunciÃ³n para limpiar el texto de sÃ­mbolos de formato
    function cleanSummaryText(text) {
        return text
            // Limpiar asteriscos de markdown
            .replace(/\*\*(.*?)\*\*/g, '$1')
            .replace(/\*(.*?)\*/g, '$1')
            
            // Limpiar sÃ­mbolos de encabezado
            .replace(/^#{1,6}\s*/gm, '')
            
            // Limpiar emojis y sÃ­mbolos al inicio de lÃ­neas
            .replace(/^[\u{1F300}-\u{1F9FF}][\s]*/gum, '')
            .replace(/^[ðŸ§ ðŸ’¡ðŸ“‹ðŸ”âœ¨ðŸš«ðŸ‘¤ðŸ“ŠðŸ’¼ðŸ¢]+[\s]*/gm, '')
            
            // Limpiar sÃ­mbolos de viÃ±etas especiales
            .replace(/^[\-\*\+]\s*\*\*(.*?)\*\*[\s]*(.*)$/gm, '- $1 $2')
            
            // Limpiar lÃ­neas de separaciÃ³n
            .replace(/^[\-\=]{3,}$/gm, '')
            
            // Limpiar texto entre asteriscos dobles al inicio
            .replace(/^\*\*(.*?)\*\*\s*/gm, '$1: ')
            
            // Normalizar espacios mÃºltiples
            .replace(/\s{3,}/g, ' ')
            .replace(/\n{3,}/g, '\n\n')
            
            .trim();
    }
    
    // Detectar si una lÃ­nea es un tÃ­tulo principal
    function isTitleLine(line) {
        return (
            line.length < 60 && 
            line.length > 8 &&
            (line.endsWith(':') || 
             line.match(/^[A-ZÃÃ‰ÃÃ“Ãš][A-ZÃÃ‰ÃÃ“Ãš\s]+$/) ||
             line.includes('RESUMEN') ||
             line.includes('CONCEPTO') ||
             line.includes('APLICACIÃ“N') ||
             line.includes('ÃMBITOS'))
        ) && !line.startsWith('-');
    }
    
    // Detectar si una lÃ­nea es un subtÃ­tulo
    function isSubtitleLine(line) {
        return (
            line.length < 80 && 
            line.length > 15 &&
            (line.includes('Personal') ||
             line.includes('Laboral') ||
             line.includes('Profesional') ||
             line.includes('FunciÃ³n') ||
             line.includes('Entorno')) &&
            !line.startsWith('-')
        ) || (line.endsWith('**') && line.startsWith('**'));
    }
    
    // Detectar elementos de lista
    function isListItem(line) {
        return line.match(/^[\-\*\+â€¢]\s+/) || line.match(/^\d+\.\s+/);
    }
    
    // Limpiar elementos de lista
    function cleanListItem(line) {
        return line.replace(/^[\-\*\+â€¢]\s+/, '').replace(/^\d+\.\s+/, '');
    }
    
    // MEJORAR la visualizaciÃ³n completa del resumen
    function renderViewSummaryEnhanced() {
        const summary = summarySystemState.viewingSummary;
        if (!summary) {
            console.error('No hay resumen para mostrar');
            summarySystemState.currentView = 'library';
            return renderSummaryLibraryEnhanced();
        }
        
        const topicName = summary.topicId ? getSummaryTopicName(summary.topicId) : 'Sin tema';
        
        return `
            <div style="max-width: 1100px; margin: 0 auto; animation: slideIn 0.3s ease-out;">
                
                <!-- NavegaciÃ³n elegante -->
                <div style="margin-bottom: 25px;">
                    <button onclick="closeSummaryViewEnhanced()" class="btn btn-secondary" style="display: flex; align-items: center; gap: 10px; padding: 12px 20px; font-size: 14px; border-radius: 10px; transition: all 0.2s ease; background: #6b7280; border: none;" onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'">
                        <span style="font-size: 16px;">â†</span> Volver a la Biblioteca
                    </button>
                </div>
                
                <!-- Tarjeta principal del resumen -->
                <div style="background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #e2e8f0;">
                    
                    <!-- Header del resumen -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px 35px; color: white; position: relative;">
                        <div style="position: absolute; top: 0; right: 0; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; transform: translate(30px, -30px);"></div>
                        <div style="position: relative; z-index: 2;">
                            <h1 style="margin: 0 0 15px 0; font-size: 2.2rem; font-weight: 700; line-height: 1.2; color: white;">
                                ${summary.title}
                            </h1>
                            <div style="display: flex; flex-wrap: wrap; gap: 20px; font-size: 14px; opacity: 0.95;">
                                <div style="background: rgba(255,255,255,0.2); padding: 6px 14px; border-radius: 20px;">
                                    <strong>${topicName}</strong>
                                </div>
                                <div style="background: rgba(255,255,255,0.2); padding: 6px 14px; border-radius: 20px;">
                                    ${summary.createdAt}
                                </div>
                                <div style="background: rgba(255,255,255,0.2); padding: 6px 14px; border-radius: 20px;">
                                    ${Math.round(summary.content.length / 5)} palabras aprox.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contenido del resumen -->
                    <div style="padding: 40px; background: #fafafa;">
                        <div style="background: white; padding: 35px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #f1f1f1;">
                            <div style="max-width: none; font-family: 'Segoe UI', system-ui, sans-serif;">
                                ${formatSummaryContentAdvanced(summary.content)}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Panel de acciones -->
                    <div style="background: #f8fafc; padding: 25px 35px; border-top: 1px solid #e2e8f0;">
                        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 12px;">
                            <button onclick="copySummaryContentToClipboard('${summary.id}')" class="btn btn-info" style="padding: 10px 20px; font-size: 14px; display: flex; align-items: center; gap: 8px; border-radius: 8px; font-weight: 500; min-width: 160px; justify-content: center;">
                                ðŸ“‹ Copiar Texto
                            </button>
                            <button onclick="editSummaryFromViewEnhanced()" class="btn btn-warning" style="padding: 10px 20px; font-size: 14px; display: flex; align-items: center; gap: 8px; border-radius: 8px; font-weight: 500; min-width: 160px; justify-content: center;">
                                âœï¸ Editar TÃ­tulo
                            </button>
                            <button onclick="deleteSummaryFromViewEnhanced('${summary.id}')" class="btn btn-danger" style="padding: 10px 20px; font-size: 14px; display: flex; align-items: center; gap: 8px; border-radius: 8px; font-weight: 500; min-width: 160px; justify-content: center;">
                                ðŸ—‘ï¸ Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <style>
                @keyframes slideIn {
                    from {
                        opacity: 0;
                        transform: translateY(15px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
            </style>
        `;
    }
    
    console.log('âœ… Parche de limpieza y formato elegante aplicado correctamente');
</script>
    <!-- 
PARCHE: MÃšLTIPLES IMÃGENES PARA RESÃšMENES
AÃ±adir este cÃ³digo AL FINAL del archivo index.html, justo antes de </body>
Este parche permite seleccionar hasta 10 imÃ¡genes para generar resÃºmenes
-->

<script>
    // ========== PARCHE: MÃšLTIPLES IMÃGENES PARA RESÃšMENES ==========
    
    // REEMPLAZAR la funciÃ³n renderCreateSummary para soportar mÃºltiples imÃ¡genes
    function renderCreateSummary() {
        return `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h2 style="color: #1f2937; margin: 0;">ðŸ“„ Crear Nuevo Resumen</h2>
                    <p style="color: #6b7280; margin: 5px 0 0 0; font-size: 14px;">Sube hasta 10 imÃ¡genes y obtÃ©n un resumen inteligente del contenido</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="showSummaryLibrary()" class="btn btn-info">
                        ðŸ“š Ver Biblioteca
                    </button>
                    <button onclick="backToIntermediateScreen()" class="btn btn-secondary">
                        â† Volver al MenÃº Principal
                    </button>
                </div>
            </div>
            
            <div class="three-column">
                <div class="column">
                    <h3 style="margin-bottom: 15px;">ðŸ“¤ Subir ImÃ¡genes para Resumir</h3>
                    
                    <!-- Ãrea de subida mejorada -->
                    <div class="upload-area" onclick="document.getElementById('summaryImageInput').click()" style="border: 2px dashed #cbd5e0; border-radius: 12px; padding: 30px 20px; text-align: center; margin-bottom: 20px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.borderColor='#4f46e5'; this.style.backgroundColor='#f8fafc'" onmouseout="this.style.borderColor='#cbd5e0'; this.style.backgroundColor='white'">
                        <div style="font-size: 48px; margin-bottom: 10px; color: #9ca3af;">ðŸ“</div>
                        <div style="font-size: 16px; font-weight: 500; color: #374151; margin-bottom: 5px;">Seleccionar mÃºltiples imÃ¡genes</div>
                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 10px;">Hasta 10 imÃ¡genes â€¢ PNG, JPG, JPEG</div>
                        <div style="margin-top: 15px; color: #4f46e5; font-weight: 600; font-size: 18px;">
                            ${summarySystemState.selectedImages.length}/10 archivos seleccionados
                        </div>
                    </div>
                    
                    <input type="file" id="summaryImageInput" style="display: none;" accept="image/*" multiple>
                    
                    <!-- CuadrÃ­cula de imÃ¡genes seleccionadas -->
                    ${summarySystemState.selectedImages.length > 0 ? `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #374151; font-size: 14px; font-weight: 600; margin-bottom: 12px;">ImÃ¡genes seleccionadas:</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; max-height: 300px; overflow-y: auto; padding: 10px; background: #f9fafb; border-radius: 8px;">
                                ${summarySystemState.selectedImages.map((file, i) => `
                                    <div style="position: relative; background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 8px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                        <button onclick="removeSummaryImageByIndex(${i})" style="position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2);" onmouseover="this.style.backgroundColor='#dc2626'" onmouseout="this.style.backgroundColor='#ef4444'">Ã—</button>
                                        <div style="font-size: 24px; margin-bottom: 6px;">ðŸ–¼ï¸</div>
                                        <div style="font-size: 10px; word-break: break-all; color: #6b7280; line-height: 1.2;">${file.name.length > 15 ? file.name.substring(0, 12) + '...' : file.name}</div>
                                        <div style="font-size: 9px; color: #9ca3af; margin-top: 2px;">${Math.round(file.size/1024)}KB</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- BotÃ³n de generar resumen -->
                    <button onclick="generateMultipleSummary()" class="btn btn-primary" style="width: 100%; margin-bottom: 15px; padding: 12px; font-size: 15px; font-weight: 600;" ${summarySystemState.selectedImages.length === 0 || !state.apiKey || summarySystemState.isProcessing ? 'disabled' : ''}>
                        ${summarySystemState.isProcessing ? 'ðŸ”„ Generando Resumen...' : `ðŸ¤– Generar Resumen (${summarySystemState.selectedImages.length} imagen${summarySystemState.selectedImages.length === 1 ? '' : 'es'})`}
                    </button>
                    
                    ${summarySystemState.isProcessing ? `
                        <div style="margin-bottom: 15px; padding: 15px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; text-align: center;">
                            <div style="color: #92400e; font-weight: 600; margin-bottom: 8px;">ðŸ”„ Procesando ${summarySystemState.selectedImages.length} imagen${summarySystemState.selectedImages.length === 1 ? '' : 'es'}</div>
                            <div style="color: #78350f; font-size: 13px;">Esto puede tomar unos momentos...</div>
                            <div style="width: 100%; background: #fed7aa; border-radius: 10px; height: 8px; margin-top: 10px; overflow: hidden;">
                                <div style="width: 100%; height: 100%; background: #f59e0b; border-radius: 10px; animation: pulse 1.5s infinite;"></div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- GestiÃ³n de Temas para ResÃºmenes -->
                    <div style="padding: 15px; background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px;">
                        <h4 style="color: #0c4a6e; margin-bottom: 15px;">ðŸ·ï¸ Organizar por Temas</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <button onclick="createSummaryTopic()" class="btn btn-info" style="width: 100%; padding: 8px; font-size: 13px;">
                                ðŸ†• Crear Tema
                            </button>
                            
                            <select id="summary-topic-selector" onchange="updateSelectedSummaryTopic()" style="width: 100%; padding: 8px; border: none; background: #0ea5e9; color: white; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer;" ${summarySystemState.summaryTopics.length === 0 ? 'disabled' : ''}>
                                <option value="">ðŸ“‚ Seleccionar Tema</option>
                                ${summarySystemState.summaryTopics.map(topic => `
                                    <option value="${topic.id}" ${summarySystemState.selectedTopicForSummary === topic.id ? 'selected' : ''}>
                                        ${topic.name} (${getSummaryTopicCount(topic.id)})
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        ${summarySystemState.summaryTopics.length === 0 ? `
                            <div style="font-size: 12px; color: #0c4a6e; font-style: italic; text-align: center;">
                                Crea temas para organizar tus resÃºmenes
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Consejos mejorados -->
                    <div style="margin-top: 20px; padding: 15px; background: #f0fdf4; border: 2px solid #22c55e; border-radius: 8px;">
                        <h4 style="color: #166534; margin-bottom: 10px;">ðŸ’¡ Consejos para resÃºmenes de mÃºltiples imÃ¡genes</h4>
                        <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #16a34a; line-height: 1.4;">
                            <li>Sube imÃ¡genes relacionadas para un resumen coherente</li>
                            <li>Ordena las imÃ¡genes en secuencia lÃ³gica</li>
                            <li>Cada imagen adicional enriquece el resumen final</li>
                            <li>El sistema analizarÃ¡ todas las imÃ¡genes como un conjunto</li>
                        </ul>
                    </div>
                </div>

                <div class="column">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">ðŸ“ Resumen Generado</h3>
                        ${summarySystemState.generatedSummary ? `
                            <button onclick="saveSummaryToLibrary()" class="btn btn-success" style="padding: 6px 12px; font-size: 12px;">
                                ðŸ’¾ Guardar
                            </button>
                        ` : ''}
                    </div>
                    
                    <textarea id="generatedSummary" class="textarea" style="min-height: 400px;" placeholder="El resumen de todas las imÃ¡genes aparecerÃ¡ aquÃ­ una vez que las proceses..." readonly>${summarySystemState.generatedSummary}</textarea>
                    
                    ${summarySystemState.generatedSummary ? `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                            <button onclick="copySummaryToClipboard()" class="btn btn-info" style="width: 100%; padding: 8px; font-size: 13px;">
                                ðŸ“‹ Copiar al Portapapeles
                            </button>
                            <button onclick="clearCurrentSummary()" class="btn btn-secondary" style="width: 100%; padding: 8px; font-size: 13px;">
                                ðŸ—‘ï¸ Limpiar Resumen
                            </button>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 15px; background: #f0fdf4; border: 2px solid #22c55e; border-radius: 8px;">
                            <h4 style="color: #166534; margin-bottom: 10px;">âœ… Â¡Resumen de ${summarySystemState.selectedImages.length} imagen${summarySystemState.selectedImages.length === 1 ? '' : 'es'} generado!</h4>
                            <p style="margin: 0; font-size: 13px; color: #16a34a;">
                                El resumen integra el contenido de todas las imÃ¡genes procesadas.
                            </p>
                        </div>
                    ` : ''}
                </div>
            </div>
            
            <style>
                @keyframes pulse {
                    0%, 100% { opacity: 1; }
                    50% { opacity: 0.5; }
                }
            </style>
        `;
    }
    
    // Nueva funciÃ³n para eliminar imagen por Ã­ndice
    function removeSummaryImageByIndex(index) {
        summarySystemState.selectedImages.splice(index, 1);
        summarySystemState.generatedSummary = ''; // Limpiar resumen al cambiar imÃ¡genes
        render();
        showMessage(`Imagen eliminada (${summarySystemState.selectedImages.length}/10 restantes)`, 'success');
    }
    
    // ACTUALIZAR el event listener para mÃºltiples imÃ¡genes
    document.removeEventListener('change', handleSummaryImageChange); // Remover listener anterior si existe
    
    function handleSummaryImageChange(e) {
        if (e.target && e.target.id === 'summaryImageInput') {
            const files = Array.from(e.target.files);
            const imageFiles = files.filter(file => file.type.startsWith('image/'));
            
            if (imageFiles.length > 0) {
                // Calcular cuÃ¡ntas imÃ¡genes podemos aÃ±adir
                const currentCount = summarySystemState.selectedImages.length;
                const maxNew = Math.min(imageFiles.length, 10 - currentCount);
                
                if (maxNew > 0) {
                    const newImages = imageFiles.slice(0, maxNew);
                    summarySystemState.selectedImages.push(...newImages);
                    summarySystemState.generatedSummary = ''; // Limpiar resumen al cambiar imÃ¡genes
                    render();
                    
                    if (maxNew === imageFiles.length) {
                        showMessage(`${maxNew} imagen${maxNew === 1 ? '' : 'es'} aÃ±adida${maxNew === 1 ? '' : 's'} (${summarySystemState.selectedImages.length}/10)`, 'success');
                    } else {
                        showMessage(`Solo se pudieron aÃ±adir ${maxNew} de ${imageFiles.length} imÃ¡genes (lÃ­mite: 10)`, 'error');
                    }
                } else {
                    showMessage('Ya tienes el mÃ¡ximo de 10 imÃ¡genes seleccionadas', 'error');
                }
            }
            
            // Limpiar el input para permitir seleccionar los mismos archivos de nuevo
            e.target.value = '';
        }
    }
    
    document.addEventListener('change', handleSummaryImageChange);
    
    // Nueva funciÃ³n para generar resumen de mÃºltiples imÃ¡genes
    async function generateMultipleSummary() {
        if (!state.apiKey) {
            showMessage('Configura tu API key primero', 'error');
            return;
        }

        if (summarySystemState.selectedImages.length === 0) {
            showMessage('Selecciona al menos una imagen', 'error');
            return;
        }

        summarySystemState.isProcessing = true;
        render();
        showMessage(`Generando resumen de ${summarySystemState.selectedImages.length} imagen${summarySystemState.selectedImages.length === 1 ? '' : 'es'}...`, 'success');
        
        try {
            // Procesar imÃ¡genes en lotes de 5 para evitar lÃ­mites de la API
            let allTranscriptions = [];
            const batchSize = 5;
            
            for (let i = 0; i < summarySystemState.selectedImages.length; i += batchSize) {
                const batch = summarySystemState.selectedImages.slice(i, i + batchSize);
                
                const imageContents = await Promise.all(
                    batch.map(async (file) => {
                        const base64 = await fileToBase64(file);
                        return {
                            type: "image",
                            source: {
                                type: "base64",
                                media_type: file.type,
                                data: base64
                            }
                        };
                    })
                );

                const messageContent = [
                    ...imageContents,
                    {
                        type: "text",
                        text: `Analiza ${batch.length > 1 ? 'estas imÃ¡genes' : 'esta imagen'} y genera un resumen completo e inteligente del contenido conjunto.

INSTRUCCIONES PARA RESUMEN DE MÃšLTIPLES IMÃGENES:

ðŸŽ¯ OBJETIVO: Crear un resumen unificado que integre toda la informaciÃ³n de las imÃ¡genes

ðŸ“‹ PROCESO:
â€¢ Analiza cada imagen individualmente
â€¢ Identifica temas y conceptos comunes entre las imÃ¡genes
â€¢ Integra la informaciÃ³n en un resumen coherente y estructurado
â€¢ Organiza por temas principales y subtemas relevantes

ðŸ” QUE INCLUIR:
- InformaciÃ³n principal de cada imagen
- Conexiones y relaciones entre las imÃ¡genes
- Conceptos clave que aparecen en mÃºltiples imÃ¡genes
- Datos, cifras y hechos importantes
- Conclusiones derivadas del conjunto completo

âœ¨ FORMATO:
- Comienza con una descripciÃ³n general del contenido conjunto
- Organiza en secciones lÃ³gicas con encabezados claros
- Usa viÃ±etas para informaciÃ³n especÃ­fica
- Termina con conclusiones o puntos clave del conjunto

ðŸš« EVITA:
- Repetir informaciÃ³n idÃ©ntica de diferentes imÃ¡genes
- Hacer el resumen excesivamente largo
- Perder informaciÃ³n importante por resumir demasiado

Genera un resumen que capture la esencia completa del material presentado en todas las imÃ¡genes.`
                    }
                ];

                const response = await fetch("/api/anthropic", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-api-key": state.apiKey,
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 3000,
                        messages: [{
                            role: "user",
                            content: messageContent
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                allTranscriptions.push(data.content[0].text);
            }

            // Si hay mÃºltiples lotes, combinar los resÃºmenes
            if (allTranscriptions.length > 1) {
                const combinedResponse = await fetch("/api/anthropic", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-api-key": state.apiKey,
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 3000,
                        messages: [{
                            role: "user",
                            content: `Combina estos resÃºmenes parciales en un resumen final coherente y bien estructurado:

${allTranscriptions.map((summary, index) => `PARTE ${index + 1}:\n${summary}`).join('\n\n---\n\n')}

Instrucciones:
- Crea un resumen unificado eliminando redundancias
- MantÃ©n toda la informaciÃ³n importante
- Organiza de forma lÃ³gica y clara
- Usa la estructura mÃ¡s apropiada para el contenido`
                        }]
                    })
                });

                if (!combinedResponse.ok) {
                    throw new Error(`Error ${combinedResponse.status}: ${combinedResponse.statusText}`);
                }

                const combinedData = await combinedResponse.json();
                summarySystemState.generatedSummary = combinedData.content[0].text;
            } else {
                summarySystemState.generatedSummary = allTranscriptions[0];
            }

            summarySystemState.isProcessing = false;
            render();
            showMessage(`Â¡Resumen de ${summarySystemState.selectedImages.length} imagen${summarySystemState.selectedImages.length === 1 ? '' : 'es'} generado exitosamente!`, 'success');
            
        } catch (error) {
            summarySystemState.isProcessing = false;
            render();
            showMessage(`Error al generar resumen: ${error.message}`, 'error');
        }
    }
    
    // REEMPLAZAR la funciÃ³n removeSummaryImage para compatibilidad
    function removeSummaryImage() {
        summarySystemState.selectedImages = [];
        summarySystemState.generatedSummary = '';
        render();
        showMessage('Todas las imÃ¡genes eliminadas', 'success');
    }
    
    console.log('âœ… Parche de mÃºltiples imÃ¡genes para resÃºmenes aplicado correctamente');
</script>
    <!-- 
PARCHE: SISTEMA DE CUENTAS DE USUARIO REAL
AÃ±adir este cÃ³digo AL FINAL del archivo index.html, justo antes de </body>
Este parche implementa un sistema completo de cuentas con persistencia de datos por usuario
-->

<script>
    // ========== PARCHE: SISTEMA DE CUENTAS DE USUARIO REAL ==========
    
    // GestiÃ³n de usuarios mejorada
    const UserManager = {
        // Obtener todos los usuarios del localStorage
        getAllUsers() {
            return JSON.parse(localStorage.getItem('systemUsers') || '{}');
        },
        
        // Guardar todos los usuarios
        saveAllUsers(users) {
            localStorage.setItem('systemUsers', JSON.stringify(users));
        },
        
        // Crear nueva cuenta
        createAccount(username, password, fullName) {
            const users = this.getAllUsers();
            
            if (users[username]) {
                return { success: false, message: 'El usuario ya existe' };
            }
            
            if (username.length < 3) {
                return { success: false, message: 'El usuario debe tener al menos 3 caracteres' };
            }
            
            if (password.length < 6) {
                return { success: false, message: 'La contraseÃ±a debe tener al menos 6 caracteres' };
            }
            
            users[username] = {
                password: password,
                name: fullName || username,
                createdAt: new Date().toISOString(),
                lastLogin: null
            };
            
            this.saveAllUsers(users);
            return { success: true, message: 'Cuenta creada exitosamente' };
        },
        
        // Verificar credenciales
        verifyLogin(username, password) {
            const users = this.getAllUsers();
            const user = users[username];
            
            if (!user) {
                return { success: false, message: 'Usuario no encontrado' };
            }
            
            if (user.password !== password) {
                return { success: false, message: 'ContraseÃ±a incorrecta' };
            }
            
            // Actualizar Ãºltimo login
            user.lastLogin = new Date().toISOString();
            this.saveAllUsers(users);
            
            return { success: true, user: user, message: 'Login exitoso' };
        },
        
        // Cambiar contraseÃ±a
        changePassword(username, oldPassword, newPassword) {
            const users = this.getAllUsers();
            const user = users[username];
            
            if (!user || user.password !== oldPassword) {
                return { success: false, message: 'ContraseÃ±a actual incorrecta' };
            }
            
            if (newPassword.length < 6) {
                return { success: false, message: 'La nueva contraseÃ±a debe tener al menos 6 caracteres' };
            }
            
            user.password = newPassword;
            this.saveAllUsers(users);
            
            return { success: true, message: 'ContraseÃ±a actualizada' };
        }
    };
    
    // GestiÃ³n de datos por usuario
    const UserDataManager = {
        // Obtener clave de datos especÃ­fica del usuario
        getUserDataKey(username, dataType) {
            return `user_${username}_${dataType}`;
        },
        
        // Cargar datos especÃ­ficos del usuario
        loadUserData(username) {
            return {
                questions: JSON.parse(localStorage.getItem(this.getUserDataKey(username, 'questions')) || '[]'),
                topics: JSON.parse(localStorage.getItem(this.getUserDataKey(username, 'topics')) || '[]'),
                testResults: JSON.parse(localStorage.getItem(this.getUserDataKey(username, 'testResults')) || '[]'),
                summaryTopics: JSON.parse(localStorage.getItem(this.getUserDataKey(username, 'summaryTopics')) || '[]'),
                savedSummaries: JSON.parse(localStorage.getItem(this.getUserDataKey(username, 'savedSummaries')) || '[]'),
                apiKey: localStorage.getItem(this.getUserDataKey(username, 'apiKey')) || ''
            };
        },
        
        // Guardar datos especÃ­ficos del usuario
        saveUserData(username, dataType, data) {
            localStorage.setItem(this.getUserDataKey(username, dataType), JSON.stringify(data));
        },
        
        // Limpiar datos del usuario actual de las variables globales
        clearCurrentUserData() {
            state.questions = [];
            state.topics = [];
            state.testResults = [];
            state.selectedTopicForNewQuestions = null;
            state.selectedTopicFilter = 'all';
            state.apiKey = '';
            
            summarySystemState.summaryTopics = [];
            summarySystemState.savedSummaries = [];
            summarySystemState.selectedTopicForSummary = null;
        },
        
        // Cargar datos del usuario en las variables globales
        loadCurrentUserData(username) {
            const userData = this.loadUserData(username);
            
            state.questions = userData.questions;
            state.topics = userData.topics;
            state.testResults = userData.testResults;
            state.apiKey = userData.apiKey;
            
            summarySystemState.summaryTopics = userData.summaryTopics;
            summarySystemState.savedSummaries = userData.savedSummaries;
            
            // Actualizar localStorage para compatibilidad con funciones existentes
            localStorage.setItem('questions', JSON.stringify(userData.questions));
            localStorage.setItem('topics', JSON.stringify(userData.topics));
            localStorage.setItem('testResults', JSON.stringify(userData.testResults));
            localStorage.setItem('summaryTopics', JSON.stringify(userData.summaryTopics));
            localStorage.setItem('savedSummaries', JSON.stringify(userData.savedSummaries));
            localStorage.setItem('anthropic_api_key', userData.apiKey);
        },
        
        // Guardar datos actuales del usuario
        saveCurrentUserData(username) {
            this.saveUserData(username, 'questions', state.questions);
            this.saveUserData(username, 'topics', state.topics);
            this.saveUserData(username, 'testResults', state.testResults);
            this.saveUserData(username, 'summaryTopics', summarySystemState.summaryTopics);
            this.saveUserData(username, 'savedSummaries', summarySystemState.savedSummaries);
            this.saveUserData(username, 'apiKey', state.apiKey);
        }
    };
    
    // Estado del sistema de login mejorado
    let loginState = {
        currentView: 'login', // 'login', 'register', 'forgotPassword'
        isRegistering: false
    };
    
    // REEMPLAZAR la funciÃ³n de login principal
    const originalLoginSystem = login;
    login = function() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        
        if (!username || !password) {
            showMessage('Completa todos los campos', 'error');
            return;
        }
        
        const loginResult = UserManager.verifyLogin(username, password);
        
        if (loginResult.success) {
            // Limpiar datos previos
            UserDataManager.clearCurrentUserData();
            
            // Establecer usuario actual
            state.currentUser = { 
                username: username, 
                name: loginResult.user.name 
            };
            
            // Cargar datos del usuario
            UserDataManager.loadCurrentUserData(username);
            
            showIntermediateScreen = true;
            render();
            showMessage(`Bienvenido ${loginResult.user.name}`, 'success');
        } else {
            showMessage(loginResult.message, 'error');
        }
    };
    
    // FunciÃ³n para registrar nueva cuenta
    function registerAccount() {
        const username = document.getElementById('reg-username').value.trim();
        const password = document.getElementById('reg-password').value;
        const confirmPassword = document.getElementById('reg-confirm-password').value;
        const fullName = document.getElementById('reg-fullname').value.trim();
        
        if (!username || !password || !confirmPassword || !fullName) {
            showMessage('Completa todos los campos', 'error');
            return;
        }
        
        if (password !== confirmPassword) {
            showMessage('Las contraseÃ±as no coinciden', 'error');
            return;
        }
        
        const registerResult = UserManager.createAccount(username, password, fullName);
        
        if (registerResult.success) {
            showMessage('Cuenta creada exitosamente. Ahora puedes iniciar sesiÃ³n.', 'success');
            loginState.currentView = 'login';
            render();
        } else {
            showMessage(registerResult.message, 'error');
        }
    }
    
    // FunciÃ³n para mostrar formulario de registro
    function showRegisterForm() {
        loginState.currentView = 'register';
        render();
    }
    
    // FunciÃ³n para mostrar formulario de login
    function showLoginForm() {
        loginState.currentView = 'login';
        render();
    }
    
    // REEMPLAZAR la funciÃ³n de logout
    const originalLogoutSystem = logout;
    logout = function() {
        if (state.currentUser) {
            // Guardar datos antes de hacer logout
            UserDataManager.saveCurrentUserData(state.currentUser.username);
        }
        
        // Limpiar estado
        UserDataManager.clearCurrentUserData();
        state.currentUser = null;
        showIntermediateScreen = false;
        state.currentTab = 'upload';
        loginState.currentView = 'login';
        
        render();
        
    };
    
    // FunciÃ³n para cambiar contraseÃ±a
    function showChangePassword() {
        if (!state.currentUser) return;
        
        const oldPassword = prompt('ContraseÃ±a actual:');
        if (!oldPassword) return;
        
        const newPassword = prompt('Nueva contraseÃ±a (mÃ­nimo 6 caracteres):');
        if (!newPassword) return;
        
        const confirmNewPassword = prompt('Confirmar nueva contraseÃ±a:');
        if (newPassword !== confirmNewPassword) {
            showMessage('Las contraseÃ±as no coinciden', 'error');
            return;
        }
        
        const result = UserManager.changePassword(state.currentUser.username, oldPassword, newPassword);
        showMessage(result.message, result.success ? 'success' : 'error');
    }
    
    // INTERCEPTAR todas las funciones de guardado para usar el sistema por usuario
    
    // Interceptar guardado de preguntas
    const originalQuestionSave = () => {
        const originalSetItem = localStorage.setItem;
        return function(key, value) {
            if (key === 'questions' && state.currentUser) {
                UserDataManager.saveUserData(state.currentUser.username, 'questions', JSON.parse(value));
            } else if (key === 'topics' && state.currentUser) {
                UserDataManager.saveUserData(state.currentUser.username, 'topics', JSON.parse(value));
            } else if (key === 'testResults' && state.currentUser) {
                UserDataManager.saveUserData(state.currentUser.username, 'testResults', JSON.parse(value));
            } else if (key === 'summaryTopics' && state.currentUser) {
                UserDataManager.saveUserData(state.currentUser.username, 'summaryTopics', JSON.parse(value));
            } else if (key === 'savedSummaries' && state.currentUser) {
                UserDataManager.saveUserData(state.currentUser.username, 'savedSummaries', JSON.parse(value));
            } else if (key === 'anthropic_api_key' && state.currentUser) {
                UserDataManager.saveUserData(state.currentUser.username, 'apiKey', value);
            }
            return originalSetItem.call(this, key, value);
        };
    };
    
    // Aplicar la interceptaciÃ³n
    localStorage.setItem = originalQuestionSave();
    
    // ACTUALIZAR la funciÃ³n render para mostrar las nuevas pantallas de login
    const originalRenderWithAccounts = render;
    render = function() {
        if (!state.currentUser) {
            const app = document.getElementById('app');
            
            if (loginState.currentView === 'register') {
                // Formulario de registro
                app.innerHTML = `
                    <div class="container">
                        <div class="login-form" style="max-width: 500px;">
                            <div style="text-align: center; margin-bottom: 30px;">
                                <div style="background: linear-gradient(135deg, #4f46e5, #7c3aed); width: 80px; height: 80px; border-radius: 20px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);">
                                    <span style="font-size: 2.5rem; filter: drop-shadow(0 2px 4px rgba(255,255,255,0.3));">ðŸ‘¤</span>
                                </div>
                                <h2 style="color: #1f2937; margin: 0;">Crear Nueva Cuenta</h2>
                                <p style="color: #6b7280; margin: 10px 0 0 0; font-size: 14px;">Ãšnete al sistema de exÃ¡menes</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Nombre completo</label>
                                <input type="text" id="reg-fullname" class="form-input" placeholder="Tu nombre completo">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Usuario</label>
                                <input type="text" id="reg-username" class="form-input" placeholder="MÃ­nimo 3 caracteres">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ContraseÃ±a</label>
                                <input type="password" id="reg-password" class="form-input" placeholder="MÃ­nimo 6 caracteres">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Confirmar contraseÃ±a</label>
                                <input type="password" id="reg-confirm-password" class="form-input" placeholder="Repite la contraseÃ±a">
                            </div>
                            <button onclick="registerAccount()" class="btn btn-primary" style="width: 100%; margin-bottom: 15px;">
                                Crear Cuenta
                            </button>
                            
                            <div style="text-align: center;">
                                <button onclick="showLoginForm()" class="btn btn-secondary" style="background: transparent; color: #6b7280; border: none; text-decoration: underline;">
                                    Â¿Ya tienes cuenta? Iniciar sesiÃ³n
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Formulario de login mejorado
                app.innerHTML = `
                    <div class="container">
                        <div class="login-form" style="max-width: 450px;">
                            <div style="text-align: center; margin-bottom: 30px;">
                                <div style="background: linear-gradient(135deg, #059669, #0ea5e9); width: 80px; height: 80px; border-radius: 20px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(5, 150, 105, 0.3);">
                                    <span style="font-size: 2.5rem; filter: drop-shadow(0 2px 4px rgba(255,255,255,0.3));">ðŸ”</span>
                                </div>
                                <h2 style="color: #1f2937; margin: 0;">Iniciar SesiÃ³n</h2>
                                <p style="color: #6b7280; margin: 10px 0 0 0; font-size: 14px;">Accede a tu cuenta personal</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Usuario</label>
                                <input type="text" id="username" class="form-input" placeholder="Tu nombre de usuario">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ContraseÃ±a</label>
                                <input type="password" id="password" class="form-input" placeholder="Tu contraseÃ±a">
                            </div>
                            <button onclick="login()" class="btn btn-primary" style="width: 100%; margin-bottom: 20px;">
                                Iniciar SesiÃ³n
                            </button>
                            
                            <div style="text-align: center; border-top: 1px solid #e5e7eb; padding-top: 20px;">
                                <p style="color: #6b7280; margin: 0 0 15px 0; font-size: 14px;">Â¿No tienes una cuenta?</p>
                                <button onclick="showRegisterForm()" class="btn btn-info" style="width: 100%;">
                                    Crear Nueva Cuenta
                                </button>
                            </div>
                            
                            <div style="margin-top: 25px; padding: 15px; background: #f3f4f6; border-radius: 8px;">
                                <h4 style="color: #374151; margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">â„¹ï¸ InformaciÃ³n del Sistema</h4>
                                <ul style="margin: 0; padding-left: 20px; color: #6b7280; font-size: 12px; line-height: 1.4;">
                                    <li>Cada usuario tiene sus propios datos</li>
                                    <li>Tus preguntas y tests son privados</li>
                                    <li>Los datos se guardan automÃ¡ticamente</li>
                                    <li>Puedes cambiar tu contraseÃ±a desde el perfil</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }
        } else {
            // Usuario logueado - usar funciÃ³n original
            originalRenderWithAccounts();
        }
    };
    
    // MEJORAR el header para mostrar opciones de cuenta
    const originalRenderHeaderButtons = () => {
        const originalFunction = originalRenderWithAccounts;
        return function() {
            if (!state.currentUser) {
                originalFunction.call(this);
                return;
            }
            
            const app = document.getElementById('app');
            
            if (showIntermediateScreen && state.currentUser) {
                app.innerHTML = `
                    <div class="container">
                        <div class="header">
                            <div class="title">Sistema de ExÃ¡menes</div>
                            <div>
                                <span style="color: ${state.apiKey ? '#10b981' : '#ef4444'};">
                                    ${state.apiKey ? 'âœ… API Configurada' : 'âŒ Sin API'}
                                </span>
                                <button onclick="configureAPI()" class="btn btn-secondary">API</button>
                                <button onclick="showChangePassword()" class="btn btn-warning" title="Cambiar contraseÃ±a">ðŸ”‘</button>
                                <span style="color: #f59e0b;">ðŸ‘¤ ${state.currentUser.name}</span>
                                <button onclick="logout()" class="btn btn-danger">Salir</button>
                            </div>
                        </div>
                        ${renderIntermediateScreen()}
                    </div>
                `;
            } else if (state.currentUser) {
                // Determinar el tÃ­tulo segÃºn la pestaÃ±a actual
                let pageTitle = 'Sistema de ExÃ¡menes';
                if (state.currentTab === 'questions') pageTitle = 'Banco de Preguntas';
                else if (state.currentTab === 'results') pageTitle = 'Resultados del Test';
                else if (state.currentTab === 'summary') pageTitle = 'Generador de ResÃºmenes';
                
                // Solo mostrar pestaÃ±as si NO estamos en summary
                const showNavTabs = state.currentTab !== 'summary';
                
                app.innerHTML = `
                    <div class="container">
                        <div class="header">
                            <div class="title">${pageTitle}</div>
                            <div>
                                <span style="color: ${state.apiKey ? '#10b981' : '#ef4444'};">
                                    ${state.apiKey ? 'âœ… API Configurada' : 'âŒ Sin API'}
                                </span>
                                <button onclick="configureAPI()" class="btn btn-secondary">API</button>
                                <button onclick="showChangePassword()" class="btn btn-warning" title="Cambiar contraseÃ±a">ðŸ”‘</button>
                                <span style="color: #f59e0b;">ðŸ‘¤ ${state.currentUser.name}</span>
                                <button onclick="logout()" class="btn btn-danger">Salir</button>
                            </div>
                        </div>

                        ${showNavTabs ? `
                            <div class="nav-tabs">
                                <button class="nav-tab ${state.currentTab === 'upload' ? 'active' : ''}" onclick="setTab('upload')">
                                    ðŸ“¤ Subir Test
                                </button>
                                <button class="nav-tab ${state.currentTab === 'questions' ? 'active' : ''}" onclick="setTab('questions')">
                                    ðŸ“‹ Banco de Preguntas (${getFilteredQuestions().length})
                                </button>
                                <button class="nav-tab ${state.currentTab === 'test' ? 'active' : ''}" onclick="setTab('test')">
                                    ðŸŽ¯ Test Aleatorio
                                </button>
                                <button class="nav-tab ${state.currentTab === 'results' ? 'active' : ''}" onclick="setTab('results')">
                                    ðŸ“Š Resultados (${state.testResults.length})
                                </button>
                            </div>
                        ` : ''}

                        <div id="messages"></div>

                        ${renderTabContent()}
                    </div>
                `;
            } else {
                originalFunction.call(this);
            }
        };
    };
    
    render = originalRenderHeaderButtons();
    
    // Asegurar que los datos se guarden periÃ³dicamente
    setInterval(() => {
        if (state.currentUser) {
            UserDataManager.saveCurrentUserData(state.currentUser.username);
        }
    }, 30000); // Guardar cada 30 segundos
    
    // Guardar datos antes de cerrar la ventana
    window.addEventListener('beforeunload', () => {
        if (state.currentUser) {
            UserDataManager.saveCurrentUserData(state.currentUser.username);
        }
    });
    
    console.log('âœ… Sistema de cuentas de usuario real implementado correctamente');
    console.log('ðŸ“Š Usuarios registrados:', Object.keys(UserManager.getAllUsers()).length);
</script>
    <!-- 
PARCHE FORZADO: REEMPLAZAR SISTEMA DE LOGIN COMPLETAMENTE
AÃ±adir este cÃ³digo AL FINAL del archivo index.html, justo antes de </body>
Este parche FUERZA el nuevo sistema de cuentas y elimina la cuenta demo
-->

<script>
    // ========== PARCHE FORZADO: SISTEMA DE CUENTAS REAL ==========
    console.log('ðŸ”§ APLICANDO PARCHE FORZADO DE CUENTAS...');
    
    // ELIMINAR la variable users antigua completamente
    window.users = undefined;
    
    // GestiÃ³n de usuarios REAL
    const RealUserManager = {
        getUsersKey() {
            return 'realSystemUsers';
        },
        
        getAllUsers() {
            return JSON.parse(localStorage.getItem(this.getUsersKey()) || '{}');
        },
        
        saveAllUsers(users) {
            localStorage.setItem(this.getUsersKey(), JSON.stringify(users));
        },
        
        createAccount(username, password, fullName) {
            const users = this.getAllUsers();
            
            if (users[username]) {
                return { success: false, message: 'El usuario ya existe' };
            }
            
            if (username.length < 3) {
                return { success: false, message: 'El usuario debe tener al menos 3 caracteres' };
            }
            
            if (password.length < 4) {
                return { success: false, message: 'La contraseÃ±a debe tener al menos 4 caracteres' };
            }
            
            users[username] = {
                password: password,
                name: fullName || username,
                createdAt: new Date().toLocaleString('es-ES'),
                lastLogin: null
            };
            
            this.saveAllUsers(users);
            console.log('âœ… Nueva cuenta creada:', username);
            return { success: true, message: 'Cuenta creada exitosamente' };
        },
        
        verifyLogin(username, password) {
            const users = this.getAllUsers();
            const user = users[username];
            
            if (!user) {
                return { success: false, message: 'Usuario no encontrado' };
            }
            
            if (user.password !== password) {
                return { success: false, message: 'ContraseÃ±a incorrecta' };
            }
            
            user.lastLogin = new Date().toLocaleString('es-ES');
            this.saveAllUsers(users);
            
            return { success: true, user: user, message: 'Login exitoso' };
        }
    };
    
    // GestiÃ³n de datos por usuario
    const RealDataManager = {
        getUserDataKey(username, dataType) {
            return `realUser_${username}_${dataType}`;
        },
        
        loadUserData(username) {
            return {
                questions: JSON.parse(localStorage.getItem(this.getUserDataKey(username, 'questions')) || '[]'),
                topics: JSON.parse(localStorage.getItem(this.getUserDataKey(username, 'topics')) || '[]'),
                testResults: JSON.parse(localStorage.getItem(this.getUserDataKey(username, 'testResults')) || '[]'),
                summaryTopics: JSON.parse(localStorage.getItem(this.getUserDataKey(username, 'summaryTopics')) || '[]'),
                savedSummaries: JSON.parse(localStorage.getItem(this.getUserDataKey(username, 'savedSummaries')) || '[]'),
                apiKey: localStorage.getItem(this.getUserDataKey(username, 'apiKey')) || ''
            };
        },
        
        saveUserData(username, dataType, data) {
            localStorage.setItem(this.getUserDataKey(username, dataType), typeof data === 'string' ? data : JSON.stringify(data));
        },
        
        clearGlobalData() {
            state.questions = [];
            state.topics = [];
            state.testResults = [];
            state.selectedTopicForNewQuestions = null;
            state.selectedTopicFilter = 'all';
            state.apiKey = '';
            
            if (typeof summarySystemState !== 'undefined') {
                summarySystemState.summaryTopics = [];
                summarySystemState.savedSummaries = [];
                summarySystemState.selectedTopicForSummary = null;
            }
        },
        
        loadIntoGlobalData(username) {
            const userData = this.loadUserData(username);
            
            state.questions = userData.questions;
            state.topics = userData.topics;
            state.testResults = userData.testResults;
            state.apiKey = userData.apiKey;
            
            if (typeof summarySystemState !== 'undefined') {
                summarySystemState.summaryTopics = userData.summaryTopics;
                summarySystemState.savedSummaries = userData.savedSummaries;
            }
            
            // Sincronizar con localStorage para compatibilidad
            localStorage.setItem('questions', JSON.stringify(userData.questions));
            localStorage.setItem('topics', JSON.stringify(userData.topics));
            localStorage.setItem('testResults', JSON.stringify(userData.testResults));
            localStorage.setItem('summaryTopics', JSON.stringify(userData.summaryTopics));
            localStorage.setItem('savedSummaries', JSON.stringify(userData.savedSummaries));
            localStorage.setItem('anthropic_api_key', userData.apiKey);
        },
        
        saveFromGlobalData(username) {
            this.saveUserData(username, 'questions', state.questions);
            this.saveUserData(username, 'topics', state.topics);
            this.saveUserData(username, 'testResults', state.testResults);
            this.saveUserData(username, 'apiKey', state.apiKey);
            
            if (typeof summarySystemState !== 'undefined') {
                this.saveUserData(username, 'summaryTopics', summarySystemState.summaryTopics);
                this.saveUserData(username, 'savedSummaries', summarySystemState.savedSummaries);
            }
        }
    };
    
    // Estado del login
    let newLoginState = {
        currentView: 'login', // 'login', 'register'
        showRegister: false
    };
    
    // INTERCEPTAR y REEMPLAZAR todas las funciones de localStorage
    const originalSetItem = localStorage.setItem;
    localStorage.setItem = function(key, value) {
        if (state.currentUser && state.currentUser.username) {
            if (key === 'questions') {
                RealDataManager.saveUserData(state.currentUser.username, 'questions', value);
            } else if (key === 'topics') {
                RealDataManager.saveUserData(state.currentUser.username, 'topics', value);
            } else if (key === 'testResults') {
                RealDataManager.saveUserData(state.currentUser.username, 'testResults', value);
            } else if (key === 'summaryTopics') {
                RealDataManager.saveUserData(state.currentUser.username, 'summaryTopics', value);
            } else if (key === 'savedSummaries') {
                RealDataManager.saveUserData(state.currentUser.username, 'savedSummaries', value);
            } else if (key === 'anthropic_api_key') {
                RealDataManager.saveUserData(state.currentUser.username, 'apiKey', value);
            }
        }
        return originalSetItem.call(this, key, value);
    };
    
    // REEMPLAZAR funciÃ³n de login COMPLETAMENTE
    window.login = function() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        
        if (!username || !password) {
            showMessage('Completa todos los campos', 'error');
            return;
        }
        
        const loginResult = RealUserManager.verifyLogin(username, password);
        
        if (loginResult.success) {
            console.log('âœ… Login exitoso para:', username);
            
            // Limpiar datos previos
            RealDataManager.clearGlobalData();
            
            // Establecer usuario actual
            state.currentUser = { 
                username: username, 
                name: loginResult.user.name 
            };
            
            // Cargar datos del usuario
            RealDataManager.loadIntoGlobalData(username);
            
            showIntermediateScreen = true;
            render();
            showMessage(`Bienvenido ${loginResult.user.name}`, 'success');
        } else {
            showMessage(loginResult.message, 'error');
        }
    };
    
    // Nueva funciÃ³n de registro
    window.registerNewAccount = function() {
        const username = document.getElementById('reg-username').value.trim();
        const password = document.getElementById('reg-password').value;
        const confirmPassword = document.getElementById('reg-confirm-password').value;
        const fullName = document.getElementById('reg-fullname').value.trim();
        
        if (!username || !password || !confirmPassword || !fullName) {
            showMessage('Completa todos los campos', 'error');
            return;
        }
        
        if (password !== confirmPassword) {
            showMessage('Las contraseÃ±as no coinciden', 'error');
            return;
        }
        
        const registerResult = RealUserManager.createAccount(username, password, fullName);
        
        if (registerResult.success) {
            showMessage('Â¡Cuenta creada! Ahora puedes iniciar sesiÃ³n', 'success');
            newLoginState.currentView = 'login';
            newLoginState.showRegister = false;
            render();
        } else {
            showMessage(registerResult.message, 'error');
        }
    };
    
    // Funciones de navegaciÃ³n
    window.showRegisterForm = function() {
        newLoginState.currentView = 'register';
        newLoginState.showRegister = true;
        render();
    };
    
    window.showLoginForm = function() {
        newLoginState.currentView = 'login';
        newLoginState.showRegister = false;
        render();
    };
    
    // REEMPLAZAR funciÃ³n de logout COMPLETAMENTE
    window.logout = function() {
        if (state.currentUser) {
            console.log('ðŸ’¾ Guardando datos antes de logout...');
            RealDataManager.saveFromGlobalData(state.currentUser.username);
        }
        
        // Limpiar estado
        RealDataManager.clearGlobalData();
        state.currentUser = null;
        showIntermediateScreen = false;
        state.currentTab = 'upload';
        newLoginState.currentView = 'login';
        
        render();
        showMessage('SesiÃ³n cerrada correctamente', 'success');
    };
    
    // REEMPLAZAR funciÃ³n render COMPLETAMENTE
    const originalRenderFunction = render;
    window.render = function() {
        const app = document.getElementById('app');
        
        // Si no hay usuario logueado, mostrar login/registro
        if (!state.currentUser) {
            if (newLoginState.currentView === 'register' || newLoginState.showRegister) {
                // Pantalla de registro
                app.innerHTML = `
                    <div class="container">
                        <div class="login-form" style="max-width: 500px;">
                            <div style="text-align: center; margin-bottom: 30px;">
                                <div style="background: linear-gradient(135deg, #10b981, #059669); width: 80px; height: 80px; border-radius: 20px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);">
                                    <span style="font-size: 2.5rem; color: white;">ðŸ‘¤</span>
                                </div>
                                <h2 style="color: #1f2937; margin: 0; font-weight: 700;">Crear Nueva Cuenta</h2>
                                <p style="color: #6b7280; margin: 10px 0 0 0; font-size: 14px;">RegÃ­strate para acceder al sistema</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Nombre completo</label>
                                <input type="text" id="reg-fullname" class="form-input" placeholder="Tu nombre completo" style="font-size: 15px; padding: 12px;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Usuario</label>
                                <input type="text" id="reg-username" class="form-input" placeholder="MÃ­nimo 3 caracteres" style="font-size: 15px; padding: 12px;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ContraseÃ±a</label>
                                <input type="password" id="reg-password" class="form-input" placeholder="MÃ­nimo 4 caracteres" style="font-size: 15px; padding: 12px;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Confirmar contraseÃ±a</label>
                                <input type="password" id="reg-confirm-password" class="form-input" placeholder="Repite la contraseÃ±a" style="font-size: 15px; padding: 12px;">
                            </div>
                            
                            <button onclick="registerNewAccount()" class="btn btn-success" style="width: 100%; margin-bottom: 15px; padding: 15px; font-size: 16px; font-weight: 600;">
                                âœ… Crear Mi Cuenta
                            </button>
                            
                            <div style="text-align: center; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                                <button onclick="showLoginForm()" class="btn btn-secondary" style="background: transparent; color: #6b7280; border: 1px solid #d1d5db; padding: 10px 20px;">
                                    â† Ya tengo cuenta
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Pantalla de login SIN cuenta demo
                app.innerHTML = `
                    <div class="container">
                        <div class="login-form" style="max-width: 450px;">
                            <div style="text-align: center; margin-bottom: 30px;">
                                <div style="background: linear-gradient(135deg, #4f46e5, #7c3aed); width: 80px; height: 80px; border-radius: 20px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);">
                                    <span style="font-size: 2.5rem; color: white;">ðŸ”</span>
                                </div>
                                <h2 style="color: #1f2937; margin: 0; font-weight: 700;">Iniciar SesiÃ³n</h2>
                                <p style="color: #6b7280; margin: 10px 0 0 0; font-size: 14px;">Accede a tu cuenta personal</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Usuario</label>
                                <input type="text" id="username" class="form-input" placeholder="Tu nombre de usuario" style="font-size: 15px; padding: 12px;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ContraseÃ±a</label>
                                <input type="password" id="password" class="form-input" placeholder="Tu contraseÃ±a" style="font-size: 15px; padding: 12px;">
                            </div>
                            
                            <button onclick="login()" class="btn btn-primary" style="width: 100%; margin-bottom: 20px; padding: 15px; font-size: 16px; font-weight: 600;">
                                ðŸš€ Iniciar SesiÃ³n
                            </button>
                            
                            <div style="text-align: center; border-top: 1px solid #e5e7eb; padding-top: 20px;">
                                <p style="color: #6b7280; margin: 0 0 15px 0; font-size: 14px;">Â¿No tienes una cuenta?</p>
                                <button onclick="showRegisterForm()" class="btn btn-success" style="width: 100%; padding: 12px; font-size: 15px; font-weight: 600;">
                                    ðŸ‘¤ Crear Nueva Cuenta
                                </button>
                            </div>
                            
                            <div style="margin-top: 25px; padding: 15px; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0;">
                                <div style="text-align: center; margin-bottom: 10px;">
                                    <strong style="color: #374151; font-size: 14px;">ðŸ”’ Sistema Seguro</strong>
                                </div>
                                <ul style="margin: 0; padding-left: 20px; color: #6b7280; font-size: 12px; line-height: 1.5;">
                                    <li>Datos privados por usuario</li>
                                    <li>Cuentas reales y seguras</li>
                                    <li>Sin acceso a datos de otros</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }
        } else {
            // Usuario logueado - usar funciÃ³n original
            originalRenderFunction.call(this);
        }
    };
    
    // Guardar datos automÃ¡ticamente cada 30 segundos
    setInterval(() => {
        if (state.currentUser) {
            RealDataManager.saveFromGlobalData(state.currentUser.username);
        }
    }, 30000);
    
    // Guardar antes de cerrar ventana
    window.addEventListener('beforeunload', () => {
        if (state.currentUser) {
            RealDataManager.saveFromGlobalData(state.currentUser.username);
        }
    });
    
    console.log('âœ… PARCHE FORZADO APLICADO - Sistema de cuentas reales activo');
    console.log('ðŸ“Š Usuarios registrados:', Object.keys(RealUserManager.getAllUsers()).length);
    
    // Forzar re-renderizado
    setTimeout(() => {
        render();
    }, 100);
</script>
    <!-- 
PARCHE: SISTEMA DE RECUPERACIÃ“N DE CONTRASEÃ‘A
AÃ±adir este cÃ³digo DESPUÃ‰S de los parches anteriores, antes de </body>
Este parche aÃ±ade recuperaciÃ³n de contraseÃ±a mediante pregunta de seguridad
-->

<script>
    // ========== PARCHE: SISTEMA DE RECUPERACIÃ“N DE CONTRASEÃ‘A ==========
    
    // Ampliar el UserManager para incluir preguntas de seguridad
    const PasswordRecoveryManager = {
        // AÃ±adir pregunta de seguridad al crear cuenta
        createAccountWithSecurity(username, password, fullName, securityQuestion, securityAnswer) {
            const users = RealUserManager.getAllUsers();
            
            if (users[username]) {
                return { success: false, message: 'El usuario ya existe' };
            }
            
            if (username.length < 3) {
                return { success: false, message: 'El usuario debe tener al menos 3 caracteres' };
            }
            
            if (password.length < 4) {
                return { success: false, message: 'La contraseÃ±a debe tener al menos 4 caracteres' };
            }
            
            if (!securityAnswer || securityAnswer.trim().length < 2) {
                return { success: false, message: 'La respuesta de seguridad es muy corta' };
            }
            
            users[username] = {
                password: password,
                name: fullName || username,
                securityQuestion: securityQuestion,
                securityAnswer: securityAnswer.toLowerCase().trim(), // Normalizar para comparaciÃ³n
                createdAt: new Date().toLocaleString('es-ES'),
                lastLogin: null
            };
            
            RealUserManager.saveAllUsers(users);
            return { success: true, message: 'Cuenta creada exitosamente' };
        },
        
        // Verificar si el usuario existe para recuperaciÃ³n
        userExists(username) {
            const users = RealUserManager.getAllUsers();
            return !!users[username];
        },
        
        // Obtener pregunta de seguridad
        getSecurityQuestion(username) {
            const users = RealUserManager.getAllUsers();
            const user = users[username];
            
            if (!user) {
                return { success: false, message: 'Usuario no encontrado' };
            }
            
            return { 
                success: true, 
                question: user.securityQuestion,
                message: 'Pregunta de seguridad encontrada'
            };
        },
        
        // Verificar respuesta y recuperar contraseÃ±a
        recoverPassword(username, securityAnswer) {
            const users = RealUserManager.getAllUsers();
            const user = users[username];
            
            if (!user) {
                return { success: false, message: 'Usuario no encontrado' };
            }
            
            if (user.securityAnswer !== securityAnswer.toLowerCase().trim()) {
                return { success: false, message: 'Respuesta de seguridad incorrecta' };
            }
            
            return { 
                success: true, 
                password: user.password,
                message: 'ContraseÃ±a recuperada exitosamente'
            };
        },
        
        // Cambiar contraseÃ±a despuÃ©s de recuperaciÃ³n
        resetPassword(username, newPassword, securityAnswer) {
            const users = RealUserManager.getAllUsers();
            const user = users[username];
            
            if (!user) {
                return { success: false, message: 'Usuario no encontrado' };
            }
            
            if (user.securityAnswer !== securityAnswer.toLowerCase().trim()) {
                return { success: false, message: 'Respuesta de seguridad incorrecta' };
            }
            
            if (newPassword.length < 4) {
                return { success: false, message: 'La nueva contraseÃ±a debe tener al menos 4 caracteres' };
            }
            
            user.password = newPassword;
            RealUserManager.saveAllUsers(users);
            
            return { success: true, message: 'ContraseÃ±a cambiada exitosamente' };
        }
    };
    
    // Preguntas de seguridad predefinidas
    const securityQuestions = [
        "Â¿CuÃ¡l es el nombre de tu primera mascota?",
        "Â¿En quÃ© ciudad naciste?",
        "Â¿CuÃ¡l es tu color favorito?",
        "Â¿CÃ³mo se llama tu mejor amigo de la infancia?",
        "Â¿CuÃ¡l es tu comida favorita?",
        "Â¿En quÃ© aÃ±o terminaste la escuela?",
        "Â¿CuÃ¡l es el nombre de tu madre?",
        "Â¿CuÃ¡l es tu pelÃ­cula favorita?"
    ];
    
    // Actualizar el estado de login para incluir recuperaciÃ³n
    newLoginState.currentView = 'login'; // 'login', 'register', 'forgot', 'recovery'
    
    // REEMPLAZAR la funciÃ³n de registro para incluir pregunta de seguridad
    window.registerNewAccount = function() {
        const username = document.getElementById('reg-username').value.trim();
        const password = document.getElementById('reg-password').value;
        const confirmPassword = document.getElementById('reg-confirm-password').value;
        const fullName = document.getElementById('reg-fullname').value.trim();
        const securityQuestion = document.getElementById('security-question').value;
        const securityAnswer = document.getElementById('security-answer').value.trim();
        
        if (!username || !password || !confirmPassword || !fullName || !securityQuestion || !securityAnswer) {
            showMessage('Completa todos los campos', 'error');
            return;
        }
        
        if (password !== confirmPassword) {
            showMessage('Las contraseÃ±as no coinciden', 'error');
            return;
        }
        
        const registerResult = PasswordRecoveryManager.createAccountWithSecurity(
            username, password, fullName, securityQuestion, securityAnswer
        );
        
        if (registerResult.success) {
            showMessage('Â¡Cuenta creada! Ahora puedes iniciar sesiÃ³n', 'success');
            newLoginState.currentView = 'login';
            render();
        } else {
            showMessage(registerResult.message, 'error');
        }
    };
    
    // Funciones para recuperaciÃ³n de contraseÃ±a
    window.showForgotPassword = function() {
        newLoginState.currentView = 'forgot';
        render();
    };
    
    window.startPasswordRecovery = function() {
        const username = document.getElementById('forgot-username').value.trim();
        
        if (!username) {
            showMessage('Ingresa tu nombre de usuario', 'error');
            return;
        }
        
        if (!PasswordRecoveryManager.userExists(username)) {
            showMessage('Usuario no encontrado', 'error');
            return;
        }
        
        const result = PasswordRecoveryManager.getSecurityQuestion(username);
        
        if (result.success) {
            // Guardar username temporalmente y mostrar pregunta de seguridad
            window.tempRecoveryUsername = username;
            window.tempRecoveryQuestion = result.question;
            newLoginState.currentView = 'recovery';
            render();
        } else {
            showMessage(result.message, 'error');
        }
    };
    
    window.recoverPassword = function() {
        const securityAnswer = document.getElementById('security-answer-recovery').value.trim();
        
        if (!securityAnswer) {
            showMessage('Responde la pregunta de seguridad', 'error');
            return;
        }
        
        const result = PasswordRecoveryManager.recoverPassword(window.tempRecoveryUsername, securityAnswer);
        
        if (result.success) {
            showMessage(`Tu contraseÃ±a es: ${result.password}`, 'success');
            
            // Limpiar variables temporales
            window.tempRecoveryUsername = null;
            window.tempRecoveryQuestion = null;
            
            // Volver al login despuÃ©s de 3 segundos
            setTimeout(() => {
                newLoginState.currentView = 'login';
                render();
            }, 3000);
        } else {
            showMessage(result.message, 'error');
        }
    };
    
    // ACTUALIZAR la funciÃ³n render para incluir las nuevas pantallas
    const previousRenderFunction = window.render;
    window.render = function() {
        const app = document.getElementById('app');
        
        if (!state.currentUser) {
            if (newLoginState.currentView === 'register') {
                // Pantalla de registro CON pregunta de seguridad
                app.innerHTML = `
                    <div class="container">
                        <div class="login-form" style="max-width: 500px;">
                            <div style="text-align: center; margin-bottom: 25px;">
                                <div style="background: linear-gradient(135deg, #10b981, #059669); width: 80px; height: 80px; border-radius: 20px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);">
                                    <span style="font-size: 2.5rem; color: white;">ðŸ‘¤</span>
                                </div>
                                <h2 style="color: #1f2937; margin: 0; font-weight: 700;">Crear Nueva Cuenta</h2>
                                <p style="color: #6b7280; margin: 10px 0 0 0; font-size: 14px;">RegÃ­strate para acceder al sistema</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Nombre completo</label>
                                <input type="text" id="reg-fullname" class="form-input" placeholder="Tu nombre completo">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Usuario</label>
                                <input type="text" id="reg-username" class="form-input" placeholder="MÃ­nimo 3 caracteres">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ContraseÃ±a</label>
                                <input type="password" id="reg-password" class="form-input" placeholder="MÃ­nimo 4 caracteres">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Confirmar contraseÃ±a</label>
                                <input type="password" id="reg-confirm-password" class="form-input" placeholder="Repite la contraseÃ±a">
                            </div>
                            
                            <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                                <h4 style="color: #92400e; margin: 0 0 10px 0; font-size: 14px;">ðŸ” Pregunta de Seguridad</h4>
                                <p style="color: #78350f; margin: 0 0 15px 0; font-size: 12px;">Para recuperar tu contraseÃ±a si la olvidas</p>
                                
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <select id="security-question" class="form-input" style="margin-bottom: 10px;">
                                        <option value="">Selecciona una pregunta...</option>
                                        ${securityQuestions.map(q => `<option value="${q}">${q}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div class="form-group" style="margin-bottom: 0;">
                                    <input type="text" id="security-answer" class="form-input" placeholder="Tu respuesta">
                                </div>
                            </div>
                            
                            <button onclick="registerNewAccount()" class="btn btn-success" style="width: 100%; margin-bottom: 15px; padding: 15px; font-size: 16px; font-weight: 600;">
                                âœ… Crear Mi Cuenta
                            </button>
                            
                            <div style="text-align: center; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                                <button onclick="showLoginForm()" class="btn btn-secondary" style="background: transparent; color: #6b7280; border: 1px solid #d1d5db; padding: 10px 20px;">
                                    â† Ya tengo cuenta
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (newLoginState.currentView === 'forgot') {
                // Pantalla de "olvidÃ© mi contraseÃ±a"
                app.innerHTML = `
                    <div class="container">
                        <div class="login-form" style="max-width: 450px;">
                            <div style="text-align: center; margin-bottom: 30px;">
                                <div style="background: linear-gradient(135deg, #f59e0b, #d97706); width: 80px; height: 80px; border-radius: 20px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);">
                                    <span style="font-size: 2.5rem; color: white;">ðŸ”‘</span>
                                </div>
                                <h2 style="color: #1f2937; margin: 0; font-weight: 700;">Recuperar ContraseÃ±a</h2>
                                <p style="color: #6b7280; margin: 10px 0 0 0; font-size: 14px;">Ingresa tu usuario para continuar</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Usuario</label>
                                <input type="text" id="forgot-username" class="form-input" placeholder="Tu nombre de usuario" style="font-size: 15px; padding: 12px;">
                            </div>
                            
                            <button onclick="startPasswordRecovery()" class="btn btn-warning" style="width: 100%; margin-bottom: 20px; padding: 15px; font-size: 16px; font-weight: 600;">
                                ðŸ” Buscar Usuario
                            </button>
                            
                            <div style="text-align: center; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                                <button onclick="showLoginForm()" class="btn btn-secondary" style="background: transparent; color: #6b7280; border: 1px solid #d1d5db; padding: 10px 20px;">
                                    â† Volver al Login
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (newLoginState.currentView === 'recovery') {
                // Pantalla de pregunta de seguridad
                app.innerHTML = `
                    <div class="container">
                        <div class="login-form" style="max-width: 500px;">
                            <div style="text-align: center; margin-bottom: 30px;">
                                <div style="background: linear-gradient(135deg, #0ea5e9, #0284c7); width: 80px; height: 80px; border-radius: 20px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(14, 165, 233, 0.3);">
                                    <span style="font-size: 2.5rem; color: white;">â“</span>
                                </div>
                                <h2 style="color: #1f2937; margin: 0; font-weight: 700;">Pregunta de Seguridad</h2>
                                <p style="color: #6b7280; margin: 10px 0 0 0; font-size: 14px;">Usuario: <strong>${window.tempRecoveryUsername}</strong></p>
                            </div>
                            
                            <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                                <h3 style="color: #0c4a6e; margin: 0 0 15px 0; font-size: 16px; font-weight: 600;">${window.tempRecoveryQuestion}</h3>
                                <input type="text" id="security-answer-recovery" class="form-input" placeholder="Tu respuesta" style="font-size: 15px; padding: 12px; width: 100%;">
                            </div>
                            
                            <button onclick="recoverPassword()" class="btn btn-info" style="width: 100%; margin-bottom: 20px; padding: 15px; font-size: 16px; font-weight: 600;">
                                ðŸ”“ Recuperar ContraseÃ±a
                            </button>
                            
                            <div style="text-align: center; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                                <button onclick="showLoginForm()" class="btn btn-secondary" style="background: transparent; color: #6b7280; border: 1px solid #d1d5db; padding: 10px 20px;">
                                    â† Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Pantalla de login CON enlace "OlvidÃ© mi contraseÃ±a"
                app.innerHTML = `
                    <div class="container">
                        <div class="login-form" style="max-width: 450px;">
                            <div style="text-align: center; margin-bottom: 30px;">
                                <div style="background: linear-gradient(135deg, #4f46e5, #7c3aed); width: 80px; height: 80px; border-radius: 20px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);">
                                    <span style="font-size: 2.5rem; color: white;">ðŸ”</span>
                                </div>
                                <h2 style="color: #1f2937; margin: 0; font-weight: 700;">Iniciar SesiÃ³n</h2>
                                <p style="color: #6b7280; margin: 10px 0 0 0; font-size: 14px;">Accede a tu cuenta personal</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Usuario</label>
                                <input type="text" id="username" class="form-input" placeholder="Tu nombre de usuario" style="font-size: 15px; padding: 12px;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ContraseÃ±a</label>
                                <input type="password" id="password" class="form-input" placeholder="Tu contraseÃ±a" style="font-size: 15px; padding: 12px;">
                            </div>
                            
                            <button onclick="login()" class="btn btn-primary" style="width: 100%; margin-bottom: 15px; padding: 15px; font-size: 16px; font-weight: 600;">
                                ðŸš€ Iniciar SesiÃ³n
                            </button>
                            
                            <div style="text-align: center; margin-bottom: 20px;">
                                <button onclick="showForgotPassword()" style="background: transparent; border: none; color: #f59e0b; text-decoration: underline; cursor: pointer; font-size: 14px;">
                                    ðŸ”‘ Â¿Olvidaste tu contraseÃ±a?
                                </button>
                            </div>
                            
                            <div style="text-align: center; border-top: 1px solid #e5e7eb; padding-top: 20px;">
                                <p style="color: #6b7280; margin: 0 0 15px 0; font-size: 14px;">Â¿No tienes una cuenta?</p>
                                <button onclick="showRegisterForm()" class="btn btn-success" style="width: 100%; padding: 12px; font-size: 15px; font-weight: 600;">
                                    ðŸ‘¤ Crear Nueva Cuenta
                                </button>
                            </div>
                            
                            <div style="margin-top: 25px; padding: 15px; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0;">
                                <div style="text-align: center; margin-bottom: 10px;">
                                    <strong style="color: #374151; font-size: 14px;">ðŸ”’ Sistema Seguro</strong>
                                </div>
                                <ul style="margin: 0; padding-left: 20px; color: #6b7280; font-size: 12px; line-height: 1.5;">
                                    <li>Datos privados por usuario</li>
                                    <li>RecuperaciÃ³n por pregunta de seguridad</li>
                                    <li>Sin acceso a datos de otros</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }
        } else {
            // Usuario logueado - usar funciÃ³n anterior
            previousRenderFunction.call(this);
        }
    };
    
    console.log('âœ… Sistema de recuperaciÃ³n de contraseÃ±a implementado');
    console.log('ðŸ”‘ Funcionalidades: Pregunta de seguridad, recuperaciÃ³n automÃ¡tica');
    
    // Forzar re-renderizado
    setTimeout(() => {
        render();
    }, 100);
</script>
    <!-- 
PARCHE DE CORRECCIÃ“N: FUNCIÃ“N DE REGISTRO QUE NO FUNCIONA
AÃ±adir este cÃ³digo DESPUÃ‰S de todos los parches anteriores, antes de </body>
Este parche corrige especÃ­ficamente el problema del botÃ³n "Crear Mi Cuenta"
-->

<script>
    // ========== CORRECCIÃ“N: FUNCIÃ“N DE REGISTRO ==========
    console.log('ðŸ”§ CORRIGIENDO funciÃ³n de registro...');
    
    // DIAGNÃ“STICO: Ver quÃ© funciones existen
    console.log('Funciones disponibles:');
    console.log('- registerNewAccount:', typeof window.registerNewAccount);
    console.log('- RealUserManager:', typeof RealUserManager);
    console.log('- PasswordRecoveryManager:', typeof PasswordRecoveryManager);
    
    // REEMPLAZAR completamente la funciÃ³n de registro
    window.registerNewAccount = function() {
        console.log('ðŸ”„ Ejecutando registerNewAccount...');
        
        try {
            // Obtener valores de los campos
            const username = document.getElementById('reg-username')?.value?.trim() || '';
            const password = document.getElementById('reg-password')?.value || '';
            const confirmPassword = document.getElementById('reg-confirm-password')?.value || '';
            const fullName = document.getElementById('reg-fullname')?.value?.trim() || '';
            const securityQuestion = document.getElementById('security-question')?.value || '';
            const securityAnswer = document.getElementById('security-answer')?.value?.trim() || '';
            
            console.log('ðŸ“ Datos del formulario:');
            console.log('- Usuario:', username);
            console.log('- Nombre:', fullName);
            console.log('- Pregunta:', securityQuestion);
            console.log('- Respuesta:', securityAnswer ? 'SÃ' : 'NO');
            
            // Validaciones bÃ¡sicas
            if (!username) {
                showMessage('El campo usuario es obligatorio', 'error');
                return;
            }
            
            if (!password) {
                showMessage('El campo contraseÃ±a es obligatorio', 'error');
                return;
            }
            
            if (!confirmPassword) {
                showMessage('Debes confirmar la contraseÃ±a', 'error');
                return;
            }
            
            if (!fullName) {
                showMessage('El nombre completo es obligatorio', 'error');
                return;
            }
            
            if (!securityQuestion) {
                showMessage('Selecciona una pregunta de seguridad', 'error');
                return;
            }
            
            if (!securityAnswer) {
                showMessage('Responde la pregunta de seguridad', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showMessage('Las contraseÃ±as no coinciden', 'error');
                return;
            }
            
            if (username.length < 3) {
                showMessage('El usuario debe tener al menos 3 caracteres', 'error');
                return;
            }
            
            if (password.length < 4) {
                showMessage('La contraseÃ±a debe tener al menos 4 caracteres', 'error');
                return;
            }
            
            console.log('âœ… Validaciones pasadas, creando cuenta...');
            
            // Crear la cuenta manualmente
            const users = JSON.parse(localStorage.getItem('realSystemUsers') || '{}');
            
            // Verificar si el usuario ya existe
            if (users[username]) {
                showMessage('El usuario ya existe, elige otro nombre', 'error');
                return;
            }
            
            // Crear nueva cuenta
            users[username] = {
                password: password,
                name: fullName,
                securityQuestion: securityQuestion,
                securityAnswer: securityAnswer.toLowerCase().trim(),
                createdAt: new Date().toLocaleString('es-ES'),
                lastLogin: null
            };
            
            // Guardar en localStorage
            localStorage.setItem('realSystemUsers', JSON.stringify(users));
            
            console.log('ðŸ’¾ Cuenta guardada exitosamente');
            console.log('ðŸ‘¥ Total usuarios:', Object.keys(users).length);
            
            // Mostrar mensaje de Ã©xito
            showMessage('Â¡Cuenta creada exitosamente! Ahora puedes iniciar sesiÃ³n', 'success');
            
            // Cambiar a pantalla de login despuÃ©s de 1 segundo
            setTimeout(() => {
                newLoginState.currentView = 'login';
                render();
            }, 1000);
            
        } catch (error) {
            console.error('âŒ Error en registro:', error);
            showMessage('Error al crear la cuenta: ' + error.message, 'error');
        }
    };
    
// FunciÃ³n showMessage desactivada - no mostrar notificaciones
window.showMessage = function(message, type) {
    // Solo mostrar errores en consola, ignorar mensajes de Ã©xito
    if (type === 'error') {
        console.error(message);
    }
    // No crear elementos DOM ni mostrar notificaciones visuales
};
    
    // VERIFICAR que newLoginState existe
    if (typeof window.newLoginState === 'undefined') {
        window.newLoginState = {
            currentView: 'login',
            showRegister: false
        };
    }
    
    // AÃ‘ADIR event listener para debugging del botÃ³n
    document.addEventListener('click', function(e) {
        if (e.target && e.target.onclick && e.target.textContent.includes('Crear Mi Cuenta')) {
            console.log('ðŸ–±ï¸ Click detectado en botÃ³n "Crear Mi Cuenta"');
            console.log('ðŸ” FunciÃ³n asignada:', e.target.onclick.toString());
        }
    });
    
    // FORZAR re-renderizado para aplicar la nueva funciÃ³n
    setTimeout(() => {
        console.log('ðŸ”„ Forzando re-render...');
        if (typeof window.render === 'function') {
            render();
        }
    }, 500);
    
    console.log('âœ… CorrecciÃ³n de funciÃ³n de registro aplicada');
    
    // DIAGNÃ“STICO FINAL
    setTimeout(() => {
        console.log('ðŸ“Š DIAGNÃ“STICO FINAL:');
        console.log('- registerNewAccount:', typeof window.registerNewAccount);
        console.log('- showMessage:', typeof window.showMessage);
        console.log('- render:', typeof window.render);
        console.log('- Usuarios existentes:', Object.keys(JSON.parse(localStorage.getItem('realSystemUsers') || '{}')).length);
    }, 1000);
</script>
    <!-- 
PARCHE: CORRECCIÃ“N USUARIOS ÃšNICOS Y RESET DE CONTRASEÃ‘A
AÃ±adir este cÃ³digo DESPUÃ‰S de todos los parches anteriores, antes de </body>
Este parche corrige: 1) ValidaciÃ³n de usuarios Ãºnicos, 2) Reset de contraseÃ±a funcional
-->

<script>
    // ========== CORRECCIÃ“N: USUARIOS ÃšNICOS Y RESET DE CONTRASEÃ‘A ==========
    console.log('ðŸ”§ APLICANDO correcciones finales...');
    
    // MEJORAR la funciÃ³n de registro para verificar usuarios Ãºnicos
    window.registerNewAccount = function() {
        console.log('ðŸ”„ Ejecutando registro con validaciÃ³n de usuarios Ãºnicos...');
        
        try {
            // Obtener valores de los campos
            const username = document.getElementById('reg-username')?.value?.trim() || '';
            const password = document.getElementById('reg-password')?.value || '';
            const confirmPassword = document.getElementById('reg-confirm-password')?.value || '';
            const fullName = document.getElementById('reg-fullname')?.value?.trim() || '';
            const securityQuestion = document.getElementById('security-question')?.value || '';
            const securityAnswer = document.getElementById('security-answer')?.value?.trim() || '';
            
            console.log('ðŸ“ Verificando usuario:', username);
            
            // Validaciones bÃ¡sicas
            if (!username) {
                showMessage('El campo usuario es obligatorio', 'error');
                return;
            }
            
            if (!password || !confirmPassword || !fullName || !securityQuestion || !securityAnswer) {
                showMessage('Completa todos los campos', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showMessage('Las contraseÃ±as no coinciden', 'error');
                return;
            }
            
            if (username.length < 3) {
                showMessage('El usuario debe tener al menos 3 caracteres', 'error');
                return;
            }
            
            if (password.length < 4) {
                showMessage('La contraseÃ±a debe tener al menos 4 caracteres', 'error');
                return;
            }
            
            // VERIFICAR SI EL USUARIO YA EXISTS (CRÃTICO)
            const existingUsers = JSON.parse(localStorage.getItem('realSystemUsers') || '{}');
            
            // Verificar tanto el usuario exacto como variaciones (case-insensitive)
            const usernameLower = username.toLowerCase();
            const existingUsernames = Object.keys(existingUsers).map(u => u.toLowerCase());
            
            if (existingUsernames.includes(usernameLower)) {
                showMessage(`âŒ El usuario "${username}" ya existe. Elige otro nombre.`, 'error');
                
                // Limpiar campo de usuario para que elija otro
                const usernameField = document.getElementById('reg-username');
                if (usernameField) {
                    usernameField.value = '';
                    usernameField.focus();
                    usernameField.style.borderColor = '#ef4444';
                    usernameField.style.backgroundColor = '#fee2e2';
                    
                    // Restaurar estilo despuÃ©s de 3 segundos
                    setTimeout(() => {
                        usernameField.style.borderColor = '#d1d5db';
                        usernameField.style.backgroundColor = 'white';
                    }, 3000);
                }
                
                console.log('âŒ Usuario ya existe:', username);
                console.log('ðŸ‘¥ Usuarios existentes:', Object.keys(existingUsers));
                return;
            }
            
            console.log('âœ… Usuario disponible, creando cuenta...');
            
            // Crear nueva cuenta
            existingUsers[username] = {
                password: password,
                name: fullName,
                securityQuestion: securityQuestion,
                securityAnswer: securityAnswer.toLowerCase().trim(),
                createdAt: new Date().toLocaleString('es-ES'),
                lastLogin: null
            };
            
            // Guardar en localStorage
            localStorage.setItem('realSystemUsers', JSON.stringify(existingUsers));
            
            console.log('ðŸ’¾ Cuenta creada exitosamente');
            console.log('ðŸ‘¥ Total usuarios:', Object.keys(existingUsers).length);
            
            // Mostrar mensaje de Ã©xito
            showMessage('Â¡Cuenta creada exitosamente! Ahora puedes iniciar sesiÃ³n', 'success');
            
            // Cambiar a pantalla de login
            setTimeout(() => {
                newLoginState.currentView = 'login';
                render();
            }, 1500);
            
        } catch (error) {
            console.error('âŒ Error en registro:', error);
            showMessage('Error al crear la cuenta: ' + error.message, 'error');
        }
    };
    
    // CORREGIR la funciÃ³n de recuperaciÃ³n de contraseÃ±a
    window.recoverPassword = function() {
        console.log('ðŸ”„ Ejecutando recuperaciÃ³n de contraseÃ±a...');
        
        try {
            const securityAnswer = document.getElementById('security-answer-recovery')?.value?.trim() || '';
            
            if (!securityAnswer) {
                showMessage('Responde la pregunta de seguridad', 'error');
                return;
            }
            
            if (!window.tempRecoveryUsername) {
                showMessage('Error: Usuario no encontrado', 'error');
                newLoginState.currentView = 'login';
                render();
                return;
            }
            
            console.log('ðŸ” Verificando respuesta para usuario:', window.tempRecoveryUsername);
            
            // Obtener usuarios del localStorage
            const users = JSON.parse(localStorage.getItem('realSystemUsers') || '{}');
            const user = users[window.tempRecoveryUsername];
            
            if (!user) {
                showMessage('Error: Usuario no encontrado', 'error');
                newLoginState.currentView = 'login';
                render();
                return;
            }
            
            // Verificar respuesta (normalizada)
            const userAnswer = securityAnswer.toLowerCase().trim();
            const correctAnswer = user.securityAnswer;
            
            console.log('ðŸ”‘ Verificando respuesta...');
            console.log('- Respuesta del usuario:', userAnswer);
            console.log('- Respuesta correcta:', correctAnswer);
            
            if (userAnswer !== correctAnswer) {
                showMessage('âŒ Respuesta incorrecta. IntÃ©ntalo de nuevo.', 'error');
                
                // Limpiar campo y darle foco
                const answerField = document.getElementById('security-answer-recovery');
                if (answerField) {
                    answerField.value = '';
                    answerField.focus();
                }
                return;
            }
            
            console.log('âœ… Respuesta correcta, iniciando reset de contraseÃ±a...');
            
            // Cambiar a pantalla de creaciÃ³n de nueva contraseÃ±a
            newLoginState.currentView = 'reset-password';
            render();
            
        } catch (error) {
            console.error('âŒ Error en recuperaciÃ³n:', error);
            showMessage('Error en la recuperaciÃ³n: ' + error.message, 'error');
        }
    };
    
    // NUEVA funciÃ³n para crear nueva contraseÃ±a
    window.resetPasswordFinal = function() {
        console.log('ðŸ”„ Creando nueva contraseÃ±a...');
        
        try {
            const newPassword = document.getElementById('new-password')?.value || '';
            const confirmNewPassword = document.getElementById('confirm-new-password')?.value || '';
            
            if (!newPassword || !confirmNewPassword) {
                showMessage('Completa ambos campos de contraseÃ±a', 'error');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                showMessage('Las contraseÃ±as no coinciden', 'error');
                return;
            }
            
            if (newPassword.length < 4) {
                showMessage('La contraseÃ±a debe tener al menos 4 caracteres', 'error');
                return;
            }
            
            if (!window.tempRecoveryUsername) {
                showMessage('Error: SesiÃ³n expirada', 'error');
                newLoginState.currentView = 'login';
                render();
                return;
            }
            
            // Actualizar contraseÃ±a en localStorage
            const users = JSON.parse(localStorage.getItem('realSystemUsers') || '{}');
            
            if (!users[window.tempRecoveryUsername]) {
                showMessage('Error: Usuario no encontrado', 'error');
                newLoginState.currentView = 'login';
                render();
                return;
            }
            
            users[window.tempRecoveryUsername].password = newPassword;
            localStorage.setItem('realSystemUsers', JSON.stringify(users));
            
            console.log('âœ… ContraseÃ±a actualizada exitosamente');
            
            // Limpiar variables temporales
            window.tempRecoveryUsername = null;
            window.tempRecoveryQuestion = null;
            
            // Mostrar mensaje de Ã©xito y volver al login
            showMessage('Â¡ContraseÃ±a actualizada exitosamente! Ahora puedes iniciar sesiÃ³n', 'success');
            
            setTimeout(() => {
                newLoginState.currentView = 'login';
                render();
            }, 2000);
            
        } catch (error) {
            console.error('âŒ Error al cambiar contraseÃ±a:', error);
            showMessage('Error al cambiar la contraseÃ±a: ' + error.message, 'error');
        }
    };
    
    // ACTUALIZAR la funciÃ³n render para incluir la pantalla de reset
    const previousRenderForReset = window.render;
    window.render = function() {
        const app = document.getElementById('app');
        
        if (!state.currentUser) {
            if (newLoginState.currentView === 'reset-password') {
                // Nueva pantalla para crear contraseÃ±a
                app.innerHTML = `
                    <div class="container">
                        <div class="login-form" style="max-width: 500px;">
                            <div style="text-align: center; margin-bottom: 30px;">
                                <div style="background: linear-gradient(135deg, #22c55e, #16a34a); width: 80px; height: 80px; border-radius: 20px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(34, 197, 94, 0.3);">
                                    <span style="font-size: 2.5rem; color: white;">ðŸ”</span>
                                </div>
                                <h2 style="color: #1f2937; margin: 0; font-weight: 700;">Crear Nueva ContraseÃ±a</h2>
                                <p style="color: #6b7280; margin: 10px 0 0 0; font-size: 14px;">Usuario: <strong>${window.tempRecoveryUsername}</strong></p>
                            </div>
                            
                            <div style="background: #f0fdf4; border: 2px solid #22c55e; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                                <h3 style="color: #166534; margin: 0 0 15px 0; font-size: 16px; font-weight: 600;">âœ… Identidad verificada</h3>
                                <p style="color: #15803d; margin: 0; font-size: 14px;">Ahora puedes crear una nueva contraseÃ±a segura</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Nueva contraseÃ±a</label>
                                <input type="password" id="new-password" class="form-input" placeholder="MÃ­nimo 4 caracteres" style="font-size: 15px; padding: 12px;">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Confirmar nueva contraseÃ±a</label>
                                <input type="password" id="confirm-new-password" class="form-input" placeholder="Repite la contraseÃ±a" style="font-size: 15px; padding: 12px;">
                            </div>
                            
                            <button onclick="resetPasswordFinal()" class="btn btn-success" style="width: 100%; margin-bottom: 20px; padding: 15px; font-size: 16px; font-weight: 600;">
                                ðŸ”’ Cambiar ContraseÃ±a
                            </button>
                            
                            <div style="text-align: center; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                                <button onclick="showLoginForm()" class="btn btn-secondary" style="background: transparent; color: #6b7280; border: 1px solid #d1d5db; padding: 10px 20px;">
                                    â† Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Usar funciÃ³n anterior para otras pantallas
                previousRenderForReset.call(this);
            }
        } else {
            // Usuario logueado
            previousRenderForReset.call(this);
        }
    };
    
    // FUNCIÃ“N para verificar disponibilidad de usuario en tiempo real
    window.checkUsernameAvailability = function(username) {
        if (username.length < 3) return;
        
        const users = JSON.parse(localStorage.getItem('realSystemUsers') || '{}');
        const usernameLower = username.toLowerCase();
        const existingUsernames = Object.keys(users).map(u => u.toLowerCase());
        
        const usernameField = document.getElementById('reg-username');
        if (usernameField) {
            if (existingUsernames.includes(usernameLower)) {
                usernameField.style.borderColor = '#ef4444';
                usernameField.style.backgroundColor = '#fee2e2';
                
                // Mostrar mensaje temporal
                let existingMsg = document.getElementById('username-status');
                if (existingMsg) existingMsg.remove();
                
                const statusMsg = document.createElement('div');
                statusMsg.id = 'username-status';
                statusMsg.style.cssText = 'color: #ef4444; font-size: 12px; margin-top: 5px;';
                statusMsg.textContent = 'âŒ Usuario no disponible';
                usernameField.parentNode.appendChild(statusMsg);
            } else {
                usernameField.style.borderColor = '#22c55e';
                usernameField.style.backgroundColor = '#f0fdf4';
                
                // Mostrar mensaje temporal
                let existingMsg = document.getElementById('username-status');
                if (existingMsg) existingMsg.remove();
                
                const statusMsg = document.createElement('div');
                statusMsg.id = 'username-status';
                statusMsg.style.cssText = 'color: #22c55e; font-size: 12px; margin-top: 5px;';
                statusMsg.textContent = 'âœ… Usuario disponible';
                usernameField.parentNode.appendChild(statusMsg);
            }
        }
    };
    
    // AÃ‘ADIR event listener para verificar usuario en tiempo real
    document.addEventListener('input', function(e) {
        if (e.target && e.target.id === 'reg-username') {
            setTimeout(() => {
                checkUsernameAvailability(e.target.value.trim());
            }, 500);
        }
    });
    
    console.log('âœ… Correcciones aplicadas: Usuarios Ãºnicos + Reset de contraseÃ±a funcional');
    
    // Forzar re-renderizado
    setTimeout(() => {
        if (typeof window.render === 'function') {
            render();
        }
    }, 100);
</script>
    <!-- 
PARCHE: SISTEMA DE NAVEGACIÃ“N CRUZADA ENTRE SECCIONES
AÃ±adir este cÃ³digo DESPUÃ‰S de todos los parches anteriores, antes de </body>
Este parche aÃ±ade navegaciÃ³n entre Tests y ResÃºmenes, y botÃ³n de vuelta al menÃº principal
-->

<script>
    // ========== PARCHE: NAVEGACIÃ“N CRUZADA ENTRE SECCIONES ==========
    console.log('ðŸ§­ Implementando navegaciÃ³n cruzada...');
    
    // FUNCIÃ“N para volver al menÃº principal (pantalla de bienvenida)
    window.backToMainMenu = function() {
        console.log('ðŸ  Volviendo al menÃº principal...');
        
        // Resetear estados
        showIntermediateScreen = true;
        state.currentTab = 'upload';
        
        // Si estamos en resÃºmenes, resetear estado
        if (typeof summarySystemState !== 'undefined') {
            summarySystemState.currentView = 'create';
            summarySystemState.viewingSummary = null;
        }
        
        render();
        showMessage('Volviendo al menÃº principal', 'success');
    };
    
    // FUNCIÃ“N para ir directamente a Tests
    window.goToTestsFromSummary = function() {
        console.log('ðŸŽ¯ Cambiando de ResÃºmenes a Tests...');
        
        showIntermediateScreen = false;
        state.currentTab = 'upload';
        
        // Si estamos en resÃºmenes, resetear estado
        if (typeof summarySystemState !== 'undefined') {
            summarySystemState.currentView = 'create';
            summarySystemState.viewingSummary = null;
        }
        
        render();
        
    };
    
    // FUNCIÃ“N para ir directamente a ResÃºmenes
    window.goToSummariesFromTest = function() {
        console.log('ðŸ“Š Cambiando de Tests a ResÃºmenes...');
        
        showIntermediateScreen = false;
        state.currentTab = 'summary';
        
        // Asegurar que estamos en la vista de creaciÃ³n
        if (typeof summarySystemState !== 'undefined') {
            summarySystemState.currentView = 'create';
            summarySystemState.viewingSummary = null;
        }
        
        render();
        
    };
    
    // INTERCEPTAR la funciÃ³n render para aÃ±adir botones de navegaciÃ³n
    const previousRenderWithNavigation = window.render;
    window.render = function() {
        // Llamar a la funciÃ³n de render original
        previousRenderWithNavigation.call(this);
        
        // Solo aÃ±adir navegaciÃ³n si el usuario estÃ¡ logueado y no en pantalla intermedia
        if (state.currentUser && !showIntermediateScreen) {
            addNavigationButtons();
        }
    };
    
    // FUNCIÃ“N para aÃ±adir botones de navegaciÃ³n
    function addNavigationButtons() {
        // Esperar un poco para que el DOM se haya renderizado
        setTimeout(() => {
            const header = document.querySelector('.header');
            
            if (header && !document.getElementById('cross-navigation')) {
                // Crear contenedor de navegaciÃ³n cruzada
                const navigationDiv = document.createElement('div');
                navigationDiv.id = 'cross-navigation';
                navigationDiv.style.cssText = `
                    display: flex;
                    gap: 10px;
                    align-items: center;
                    margin-left: 20px;
                `;
                
                // Determinar quÃ© botones mostrar segÃºn la secciÃ³n actual
                let navigationHTML = '';
                
                if (state.currentTab === 'summary') {
                    // Estamos en resÃºmenes, mostrar opciones para ir a tests y menÃº
                    navigationHTML = `
                        <button onclick="goToTestsFromSummary()" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px; display: flex; align-items: center; gap: 6px;" title="Ir a la secciÃ³n de Tests">
                            <span>ðŸŽ¯</span> Tests
                        </button>
                        <button onclick="backToMainMenu()" class="btn btn-info" style="padding: 6px 12px; font-size: 12px; display: flex; align-items: center; gap: 6px;" title="Volver al menÃº principal">
                            <span>ðŸ </span> MenÃº
                        </button>
                    `;
                } else {
                    // Estamos en tests (upload, questions, test, results), mostrar opciones para resÃºmenes y menÃº
                    navigationHTML = `
                        <button onclick="goToSummariesFromTest()" class="btn btn-success" style="padding: 6px 12px; font-size: 12px; display: flex; align-items: center; gap: 6px;" title="Ir a la secciÃ³n de ResÃºmenes">
                            <span>ðŸ“Š</span> ResÃºmenes
                        </button>
                        <button onclick="backToMainMenu()" class="btn btn-info" style="padding: 6px 12px; font-size: 12px; display: flex; align-items: center; gap: 6px;" title="Volver al menÃº principal">
                            <span>ðŸ </span> MenÃº
                        </button>
                    `;
                }
                
                navigationDiv.innerHTML = navigationHTML;
                
                // Insertar en el header, antes de los botones de usuario
                const userButtons = header.querySelector('div:last-child');
                if (userButtons) {
                    header.insertBefore(navigationDiv, userButtons);
                } else {
                    header.appendChild(navigationDiv);
                }
            }
        }, 100);
    }
    
    // MEJORAR la funciÃ³n backToIntermediateScreen existente
    const originalBackToIntermediateScreen = window.backToIntermediateScreen;
    window.backToIntermediateScreen = function() {
        console.log('ðŸ”™ Volviendo a pantalla intermedia...');
        backToMainMenu();
    };
    
    // AÃ‘ADIR botÃ³n especial en la pantalla de visualizaciÃ³n de resÃºmenes
    const originalRenderViewSummaryEnhanced = renderViewSummaryEnhanced;
    if (typeof renderViewSummaryEnhanced === 'function') {
        renderViewSummaryEnhanced = function() {
            const originalHTML = originalRenderViewSummaryEnhanced();
            
            // Buscar el botÃ³n "Volver a la Biblioteca" y aÃ±adir mÃ¡s opciones
            const enhancedHTML = originalHTML.replace(
                'Volver a la Biblioteca',
                'Volver a la Biblioteca</button>\n                    <button onclick="goToTestsFromSummary()" class="btn btn-primary" style="display: flex; align-items: center; gap: 10px; padding: 12px 20px; font-size: 14px; border-radius: 10px; transition: all 0.2s ease; background: #4f46e5; border: none; margin-left: 10px;" onmouseover="this.style.background=\'#4338ca\'" onmouseout="this.style.background=\'#4f46e5\'">\n                        <span style="font-size: 16px;">ðŸŽ¯</span> Ir a Tests\n                    </button>\n                    <button onclick="backToMainMenu()" class="btn btn-info" style="display: flex; align-items: center; gap: 10px; padding: 12px 20px; font-size: 14px; border-radius: 10px; transition: all 0.2s ease; background: #0ea5e9; border: none; margin-left: 10px;" onmouseover="this.style.background=\'#0284c7\'" onmouseout="this.style.background=\'#0ea5e9\'">\n                        <span style="font-size: 16px;">ðŸ </span> MenÃº'
            );
            
            return enhancedHTML;
        };
    }
    
    // INTERCEPTAR las funciones setTab para preservar navegaciÃ³n
    const originalSetTab = window.setTab;
    window.setTab = function(tab) {
        // Remover navegaciÃ³n anterior para re-crearla
        const existingNav = document.getElementById('cross-navigation');
        if (existingNav) {
            existingNav.remove();
        }
        
        // Llamar funciÃ³n original
        originalSetTab.call(this, tab);
    };
    
    // MEJORAR las funciones goToTests y goToSummaries originales
    const originalGoToTests = window.goToTests;
    window.goToTests = function() {
        console.log('ðŸŽ¯ Yendo a Tests desde menÃº principal...');
        showIntermediateScreen = false;
        state.currentTab = 'upload';
        render();
    };
    
    const originalGoToSummariesMain = window.goToSummaries;
    window.goToSummaries = function() {
        console.log('ðŸ“Š Yendo a ResÃºmenes desde menÃº principal...');
        showIntermediateScreen = false;
        state.currentTab = 'summary';
        render();
    };
    
    // AÃ‘ADIR estilos CSS para los botones de navegaciÃ³n
    const navigationStyles = document.createElement('style');
    navigationStyles.textContent = `
        #cross-navigation {
            border-left: 1px solid #e5e7eb;
            padding-left: 15px;
            margin-left: 15px !important;
        }
        
        #cross-navigation .btn {
            transition: all 0.2s ease;
            font-weight: 500;
            border: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        #cross-navigation .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        
        @media (max-width: 768px) {
            #cross-navigation {
                display: none !important;
            }
        }
    `;
    
    // AÃ±adir estilos al head si no existen
    if (!document.getElementById('navigation-styles')) {
        navigationStyles.id = 'navigation-styles';
        document.head.appendChild(navigationStyles);
    }
    
    console.log('âœ… Sistema de navegaciÃ³n cruzada implementado');
    console.log('ðŸ§­ Funcionalidades aÃ±adidas:');
    console.log('   - BotÃ³n "Tests" en secciÃ³n de ResÃºmenes');
    console.log('   - BotÃ³n "ResÃºmenes" en secciÃ³n de Tests');  
    console.log('   - BotÃ³n "MenÃº" en ambas secciones');
    console.log('   - NavegaciÃ³n desde visualizaciÃ³n de resÃºmenes');
    
    // Forzar re-renderizado para aplicar navegaciÃ³n
    setTimeout(() => {
        if (state.currentUser && typeof window.render === 'function') {
            render();
        }
    }, 200);
</script>
<!-- 
PARCHE ULTRA SIMPLE: RECORDAR USUARIO
AÃ±adir este cÃ³digo AL FINAL del archivo index.html, justo antes de </body>
Sin preguntas, sin confirmaciones. Solo recordar datos del login.
-->

<script>
    // ========== PARCHE ULTRA SIMPLE: RECORDAR USUARIO ==========
    console.log('ðŸ” Implementando recordar usuario ultra simple...');
    
    // INTERCEPTAR funciÃ³n de login
    const originalUltraLogin = window.login;
    window.login = function() {
        const username = document.getElementById('username')?.value?.trim() || '';
        const password = document.getElementById('password')?.value || '';
        const rememberMe = document.getElementById('remember-me')?.checked || false;
        
        if (!username || !password) {
            showMessage('Completa todos los campos', 'error');
            return;
        }
        
        const loginResult = RealUserManager.verifyLogin(username, password);
        
        if (loginResult.success) {
            console.log('âœ… Login exitoso para:', username);
            
            // Si marcÃ³ "recordar", guardar credenciales
            if (rememberMe) {
                localStorage.setItem('rememberedUsername', username);
                localStorage.setItem('rememberedPassword', password);
                localStorage.setItem('rememberExpiry', Date.now() + (30 * 24 * 60 * 60 * 1000)); // 30 dÃ­as
                console.log('ðŸ’¾ Credenciales guardadas');
            } else {
                // Si no marcÃ³ recordar, limpiar datos guardados
                localStorage.removeItem('rememberedUsername');
                localStorage.removeItem('rememberedPassword');
                localStorage.removeItem('rememberExpiry');
            }
            
            // Limpiar datos previos
            RealDataManager.clearGlobalData();
            
            // Establecer usuario actual
            state.currentUser = { 
                username: username, 
                name: loginResult.user.name 
            };
            
            // Cargar datos del usuario
            RealDataManager.loadIntoGlobalData(username);
            
            showIntermediateScreen = true;
            render();
            
        } else {
            showMessage(loginResult.message, 'error');
        }
    };
    
    // FUNCIÃ“N para llenar datos recordados
    function fillRememberedCredentials() {
        const rememberedUser = localStorage.getItem('rememberedUsername');
        const rememberedPass = localStorage.getItem('rememberedPassword');
        const expiry = localStorage.getItem('rememberExpiry');
        
        // Verificar si no ha expirado
        if (expiry && Date.now() > parseInt(expiry)) {
            localStorage.removeItem('rememberedUsername');
            localStorage.removeItem('rememberedPassword');
            localStorage.removeItem('rememberExpiry');
            return;
        }
        
        if (rememberedUser && rememberedPass) {
            setTimeout(() => {
                const usernameField = document.getElementById('username');
                const passwordField = document.getElementById('password');
                const rememberCheckbox = document.getElementById('remember-me');
                
                if (usernameField) usernameField.value = rememberedUser;
                if (passwordField) passwordField.value = rememberedPass;
                if (rememberCheckbox) rememberCheckbox.checked = true;
                
                console.log('ðŸ“ Credenciales pre-llenadas');
            }, 100);
        }
    }
    
    // LOGOUT ultra simple - directo al login sin preguntas
    const originalUltraLogout = window.logout;
    window.logout = function() {
        if (state.currentUser) {
            RealDataManager.saveFromGlobalData(state.currentUser.username);
        }
        
        // Limpiar estado
        RealDataManager.clearGlobalData();
        state.currentUser = null;
        showIntermediateScreen = false;
        state.currentTab = 'upload';
        newLoginState.currentView = 'login';
        
        render();
        showMessage('SesiÃ³n cerrada correctamente', 'success');
    };
    
    // ACTUALIZAR render para aÃ±adir checkbox
    const previousUltraRender = window.render;
    window.render = function() {
        const app = document.getElementById('app');
        
        if (!state.currentUser) {
            if (newLoginState.currentView === 'login') {
                // Pantalla de login con checkbox
                app.innerHTML = `
                    <div class="container">
                        <div class="login-form" style="max-width: 450px;">
                            <div style="text-align: center; margin-bottom: 30px;">
                                <div style="background: linear-gradient(135deg, #4f46e5, #7c3aed); width: 80px; height: 80px; border-radius: 20px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);">
                                    <span style="font-size: 2.5rem; color: white;">ðŸ”</span>
                                </div>
                                <h2 style="color: #1f2937; margin: 0; font-weight: 700;">Iniciar SesiÃ³n</h2>
                                <p style="color: #6b7280; margin: 10px 0 0 0; font-size: 14px;">Accede a tu cuenta personal</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Usuario</label>
                                <input type="text" id="username" class="form-input" placeholder="Tu nombre de usuario" style="font-size: 15px; padding: 12px;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ContraseÃ±a</label>
                                <input type="password" id="password" class="form-input" placeholder="Tu contraseÃ±a" style="font-size: 15px; padding: 12px;">
                            </div>
                            
                            <!-- Checkbox simple -->
                            <div style="margin-bottom: 20px;">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 14px; color: #374151;">
                                    <input type="checkbox" id="remember-me" style="transform: scale(1.2); accent-color: #4f46e5;">
                                    <span>Recordar usuario</span>
                                </label>
                            </div>
                            
                            <button onclick="login()" class="btn btn-primary" style="width: 100%; margin-bottom: 15px; padding: 15px; font-size: 16px; font-weight: 600;">
                                ðŸš€ Iniciar SesiÃ³n
                            </button>
                            
                            <div style="text-align: center; margin-bottom: 20px;">
                                <button onclick="showForgotPassword()" style="background: transparent; border: none; color: #f59e0b; text-decoration: underline; cursor: pointer; font-size: 14px;">
                                    ðŸ”‘ Â¿Olvidaste tu contraseÃ±a?
                                </button>
                            </div>
                            
                            <div style="text-align: center; border-top: 1px solid #e5e7eb; padding-top: 20px;">
                                <p style="color: #6b7280; margin: 0 0 15px 0; font-size: 14px;">Â¿No tienes una cuenta?</p>
                                <button onclick="showRegisterForm()" class="btn btn-success" style="width: 100%; padding: 12px; font-size: 15px; font-weight: 600;">
                                    ðŸ‘¤ Crear Nueva Cuenta
                                </button>
                            </div>
                            
                            <div style="margin-top: 25px; padding: 15px; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0;">
                                <div style="text-align: center; margin-bottom: 10px;">
                                    <strong style="color: #374151; font-size: 14px;">ðŸ”’ Sistema Seguro</strong>
                                </div>
                                <ul style="margin: 0; padding-left: 20px; color: #6b7280; font-size: 12px; line-height: 1.5;">
                                    <li>Datos privados por usuario</li>
                                    <li>RecuperaciÃ³n por pregunta de seguridad</li>
                                    <li>OpciÃ³n de recordar credenciales</li>
                                    <li>Sin acceso a datos de otros</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
                
                // Llenar datos recordados despuÃ©s de renderizar
                fillRememberedCredentials();
            } else {
                // Otras pantallas - usar funciÃ³n original
                previousUltraRender.call(this);
            }
        } else {
            // Usuario logueado - usar funciÃ³n original
            previousUltraRender.call(this);
        }
    };
    
    console.log('âœ… Sistema ultra simple de recordar usuario implementado');
    console.log('ðŸŽ¯ Funcionalidad: Recordar y pre-llenar credenciales, logout directo');
    
    // Forzar re-renderizado si no hay usuario logueado
    setTimeout(() => {
        if (!state.currentUser && typeof window.render === 'function') {
            render();
        }
    }, 100);
</script>
   <!-- 
PARCHE CORREGIDO: SISTEMA DE TARJETAS DE MEMORIA
AÃ±adir este cÃ³digo AL FINAL del archivo index.html, justo antes de </body>
VersiÃ³n corregida con botÃ³n en header y diseÃ±o mejorado
-->

<script>
    // ========== PARCHE CORREGIDO: SISTEMA DE TARJETAS DE MEMORIA ==========
    console.log('ðŸƒ Implementando sistema de tarjetas de memoria corregido...');
    
    // Estado para las tarjetas de memoria
    let memoryCardsState = {
        currentCard: null,
        cardIndex: 0,
        verifiedQuestions: [],
        showAnswer: false
    };
    
    // FUNCIÃ“N para ir a tarjetas de memoria desde el menÃº principal
    window.goToMemoryCards = function() {
        console.log('ðŸƒ Cambiando a Tarjetas de Memoria...');
        
        showIntermediateScreen = false;
        state.currentTab = 'memory-cards';
        
        // Cargar preguntas verificadas
        loadVerifiedQuestions();
        
        render();
        
    };
    
    // FUNCIÃ“N para volver al menÃº desde tarjetas
    window.backToMainMenuFromCards = function() {
        console.log('ðŸ  Volviendo al menÃº principal desde tarjetas...');
        showIntermediateScreen = true;
        state.currentTab = 'upload';
        render();
        
    };
    
    // FUNCIÃ“N para cargar preguntas verificadas
    function loadVerifiedQuestions() {
        memoryCardsState.verifiedQuestions = state.questions.filter(q => q.isVerified);
        
        if (memoryCardsState.verifiedQuestions.length > 0) {
            // Mezclar preguntas aleatoriamente
            memoryCardsState.verifiedQuestions = [...memoryCardsState.verifiedQuestions].sort(() => Math.random() - 0.5);
            memoryCardsState.cardIndex = 0;
            memoryCardsState.currentCard = memoryCardsState.verifiedQuestions[0];
            memoryCardsState.showAnswer = false;
        } else {
            memoryCardsState.currentCard = null;
        }
    }
    
    // FUNCIÃ“N para mostrar/ocultar respuesta
    function toggleAnswer() {
        memoryCardsState.showAnswer = !memoryCardsState.showAnswer;
        render();
    }
    
    // FUNCIÃ“N para siguiente tarjeta
    function nextCard() {
        if (memoryCardsState.verifiedQuestions.length === 0) return;
        
        memoryCardsState.cardIndex = (memoryCardsState.cardIndex + 1) % memoryCardsState.verifiedQuestions.length;
        memoryCardsState.currentCard = memoryCardsState.verifiedQuestions[memoryCardsState.cardIndex];
        memoryCardsState.showAnswer = false;
        render();
    }
    
    // FUNCIÃ“N para tarjeta anterior
    function previousCard() {
        if (memoryCardsState.verifiedQuestions.length === 0) return;
        
        memoryCardsState.cardIndex = memoryCardsState.cardIndex === 0 
            ? memoryCardsState.verifiedQuestions.length - 1 
            : memoryCardsState.cardIndex - 1;
        memoryCardsState.currentCard = memoryCardsState.verifiedQuestions[memoryCardsState.cardIndex];
        memoryCardsState.showAnswer = false;
        render();
    }
    
    // FUNCIÃ“N para mezclar tarjetas
    function shuffleCards() {
        if (memoryCardsState.verifiedQuestions.length === 0) return;
        
        memoryCardsState.verifiedQuestions = [...memoryCardsState.verifiedQuestions].sort(() => Math.random() - 0.5);
        memoryCardsState.cardIndex = 0;
        memoryCardsState.currentCard = memoryCardsState.verifiedQuestions[0];
        memoryCardsState.showAnswer = false;
        render();
        showMessage('Tarjetas mezcladas aleatoriamente', 'success');
    }
    
    // FUNCIÃ“N para renderizar la secciÃ³n de tarjetas de memoria
    function renderMemoryCardsTab() {
        if (memoryCardsState.verifiedQuestions.length === 0) {
            return `
                <div style="max-width: 800px; margin: 0 auto; text-align: center; padding: 80px 20px;">
                    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); width: 120px; height: 120px; border-radius: 20px; margin: 0 auto 30px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(245, 158, 11, 0.3);">
                        <span style="font-size: 4rem; color: white;">ðŸƒ</span>
                    </div>
                    <h2 style="color: #1f2937; margin: 0 0 20px 0; font-size: 2.5rem;">No hay tarjetas disponibles</h2>
                    <p style="color: #6b7280; margin: 0 0 30px 0; font-size: 1.2rem; line-height: 1.6;">
                        Para usar las tarjetas de memoria necesitas tener preguntas <strong>verificadas</strong> (â­) en tu banco de preguntas.
                    </p>
                    <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; padding: 25px; margin-bottom: 30px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto;">
                        <h3 style="color: #92400e; margin: 0 0 15px 0; font-size: 1.1rem;">ðŸ“ Â¿CÃ³mo verificar preguntas?</h3>
                        <ol style="color: #78350f; margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li>Ve a "Banco de Preguntas"</li>
                            <li>Busca el botÃ³n â˜† junto a cada pregunta</li>
                            <li>Haz clic para convertirlo en â­ (verificada)</li>
                            <li>Vuelve aquÃ­ para practicar con tarjetas</li>
                        </ol>
                    </div>
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="goToTestsFromSummary()" class="btn btn-primary" style="padding: 15px 25px; font-size: 16px;">
                            ðŸ“‹ Ir al Banco de Preguntas
                        </button>
                    </div>
                </div>
            `;
        }
        
        const currentCard = memoryCardsState.currentCard;
        const cardNumber = memoryCardsState.cardIndex + 1;
        const totalCards = memoryCardsState.verifiedQuestions.length;
        const topicName = currentCard.topicId ? getTopicName(currentCard.topicId) : 'General';
        
        return `
            <div style="max-width: 900px; margin: 0 auto; padding: 20px;">
                
                <!-- Header simple -->
                <div style="text-align: center; margin-bottom: 30px;">
                    <h1 style="color: #1f2937; margin: 0; font-size: 2.2rem; display: flex; align-items: center; justify-content: center; gap: 15px;">
                        <span>ðŸƒ</span> Tarjetas de Memoria
                    </h1>
                    <p style="color: #6b7280; margin: 5px 0 0 0; font-size: 14px;">
                        Tarjeta ${cardNumber} de ${totalCards} preguntas verificadas
                    </p>
                </div>
                
                <!-- Controles superiores -->
                <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 40px;">
                    <button onclick="shuffleCards()" class="btn btn-warning" style="padding: 10px 20px; display: flex; align-items: center; gap: 8px;">
                        <span>ðŸ”€</span> Mezclar
                    </button>
                    <div style="background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; padding: 10px 20px; border-radius: 20px; font-weight: 600; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);">
                        ${cardNumber} / ${totalCards}
                    </div>
                    <button onclick="loadVerifiedQuestions()" class="btn btn-info" style="padding: 10px 20px; display: flex; align-items: center; gap: 8px;">
                        <span>ðŸ”„</span> Recargar
                    </button>
                </div>
                
                <!-- Tarjeta principal mejorada -->
                <div style="perspective: 1000px; margin-bottom: 40px;">
                    <div class="memory-card" style="
                        background: linear-gradient(145deg, #ffffff, #f8fafc); 
                        border-radius: 20px; 
                        box-shadow: 
                            0 20px 40px rgba(0,0,0,0.12),
                            0 1px 0 rgba(255,255,255,0.8),
                            inset 0 1px 3px rgba(255,255,255,0.9);
                        margin: 0 auto; 
                        max-width: 650px; 
                        min-height: 400px; 
                        position: relative; 
                        border: 2px solid #e2e8f0;
                        transform: rotateX(1deg) rotateY(-1deg);
                        transition: all 0.4s ease;
                        animation: cardFloat 4s ease-in-out infinite;
                    ">
                    
                        <!-- Badge de verificada -->
                        <div style="position: absolute; top: -8px; right: 15px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 14px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); z-index: 10;">
                            â­ Verificada
                        </div>
                        
                        <!-- Contenido de la tarjeta -->
                        <div style="padding: 35px;">
                            
                            <!-- Tema y Pregunta -->
                            <div style="margin-bottom: 30px;">
                                <!-- Badge del tema -->
                                <div style="display: inline-block; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 6px 14px; border-radius: 15px; font-size: 13px; font-weight: 600; margin-bottom: 20px; box-shadow: 0 2px 6px rgba(139, 92, 246, 0.3);">
                                    ðŸ“ ${topicName}
                                </div>
                                
                                <!-- Pregunta -->
                                <h3 style="color: #6b7280; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">
                                    ðŸ“ PREGUNTA
                                </h3>
                                <div style="font-size: 1.3rem; line-height: 1.6; color: #1f2937; font-weight: 500; background: linear-gradient(135deg, #f8fafc, #f1f5f9); padding: 25px; border-radius: 12px; border-left: 4px solid #4f46e5; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);">
                                    ${currentCard.question}
                                </div>
                            </div>
                            
                            <!-- Ãrea de respuesta -->
                            <div style="margin-bottom: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3 style="color: #6b7280; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin: 0;">
                                        âœ… RESPUESTA CORRECTA
                                    </h3>
                                    <button onclick="toggleAnswer()" class="btn ${memoryCardsState.showAnswer ? 'btn-secondary' : 'btn-success'}" style="padding: 8px 16px; font-size: 14px; font-weight: 600; border-radius: 20px;">
                                        ${memoryCardsState.showAnswer ? 'ðŸ™ˆ Ocultar' : 'ðŸ‘ï¸ Ver Respuesta'}
                                    </button>
                                </div>
                                
                                <div style="min-height: 80px; background: ${memoryCardsState.showAnswer ? 'linear-gradient(135deg, #f0fdf4, #dcfce7)' : 'linear-gradient(135deg, #f9fafb, #f3f4f6)'}; border: 2px ${memoryCardsState.showAnswer ? 'solid #22c55e' : 'dashed #d1d5db'}; border-radius: 12px; padding: 25px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
                                    
                                    ${memoryCardsState.showAnswer ? `
                                        <div style="text-align: center;">
                                            <div style="font-size: 1.3rem; font-weight: 700; color: #166534; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                                                <span style="font-size: 1.5rem;">âœ…</span>
                                                <span>${String.fromCharCode(97 + currentCard.correctAnswer).toUpperCase()}) ${currentCard.options[currentCard.correctAnswer]}</span>
                                            </div>
                                            <div style="font-size: 14px; color: #16a34a; font-weight: 500;">
                                                Esta es la respuesta correcta
                                            </div>
                                        </div>
                                    ` : `
                                        <div style="color: #9ca3af; font-style: italic; text-align: center;">
                                            <div style="font-size: 2.5rem; margin-bottom: 10px;">ðŸ¤”</div>
                                            <div style="font-size: 16px;">Haz clic en "Ver Respuesta" para revelar la soluciÃ³n</div>
                                        </div>
                                    `}
                                </div>
                            </div>
                            
                            <!-- Consejo -->
                            <div style="text-align: center; margin-top: 25px; padding: 12px; background: rgba(79, 70, 229, 0.05); border-radius: 10px; border: 1px solid rgba(79, 70, 229, 0.1);">
                                <div style="color: #6b7280; font-size: 13px; font-weight: 500;">
                                    ðŸ’¡ Intenta responder mentalmente antes de ver la respuesta
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Controles de navegaciÃ³n -->
                <div style="display: flex; justify-content: center; align-items: center; gap: 25px;">
                    <button onclick="previousCard()" class="btn btn-secondary" style="padding: 12px 25px; font-size: 16px; border-radius: 25px; display: flex; align-items: center; gap: 10px; min-width: 140px; justify-content: center;" ${totalCards <= 1 ? 'disabled' : ''}>
                        <span style="font-size: 18px;">â†</span>
                        <span>Anterior</span>
                    </button>
                    
                    <button onclick="nextCard()" class="btn btn-primary" style="padding: 12px 25px; font-size: 16px; border-radius: 25px; display: flex; align-items: center; gap: 10px; min-width: 140px; justify-content: center;" ${totalCards <= 1 ? 'disabled' : ''}>
                        <span>Siguiente</span>
                        <span style="font-size: 18px;">â†’</span>
                    </button>
                </div>
            </div>
            
            <!-- Estilos CSS -->
            <style>
                @keyframes cardFloat {
                    0%, 100% { transform: rotateX(1deg) rotateY(-1deg) translateY(0px); }
                    50% { transform: rotateX(1deg) rotateY(-1deg) translateY(-2px); }
                }
                
                .memory-card:hover {
                    transform: rotateX(0deg) rotateY(0deg) translateY(-3px) !important;
                    box-shadow: 0 25px 50px rgba(0,0,0,0.15) !important;
                }
            </style>
        `;
    }
    
    // INTERCEPTAR la funciÃ³n renderIntermediateScreen para aÃ±adir la tercera opciÃ³n
    const originalRenderIntermediateScreen = renderIntermediateScreen;
    window.renderIntermediateScreen = function() {
    return `
        <div style="min-height: 80vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: -30px; border-radius: 20px;">
            <div style="background: white; border-radius: 24px; padding: 60px; box-shadow: 0 25px 50px rgba(0,0,0,0.15); max-width: 600px; width: 100%; text-align: center; position: relative; overflow: hidden;">
                
                <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: linear-gradient(135deg, #667eea20, #764ba220); border-radius: 50%; z-index: 0;"></div>
                <div style="position: absolute; bottom: -30px; left: -30px; width: 100px; height: 100px; background: linear-gradient(135deg, #764ba220, #667eea20); border-radius: 50%; z-index: 0;"></div>
                
                <div style="position: relative; z-index: 1;">
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); width: 80px; height: 80px; border-radius: 20px; margin: 0 auto 30px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);">
                        <span style="font-size: 2.5rem; filter: drop-shadow(0 2px 4px rgba(255,255,255,0.3));">ðŸŽ¯</span>
                    </div>
                    
                    <h1 style="font-size: 2.8rem; font-weight: 700; margin: 0 0 15px 0; background: linear-gradient(135deg, #2d3748, #4a5568); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                        Â¡Bienvenid@!
                    </h1>
                    
                    <p style="font-size: 1.3rem; color: #6b7280; margin: 0 0 50px 0; font-weight: 400; line-height: 1.5;">
                        Selecciona quÃ© te gustarÃ­a hacer hoy
                    </p>
                    
                    <div style="display: grid; gap: 15px; margin-bottom: 40px;">
                        
                        <button onclick="goToTests()" style="background: linear-gradient(135deg, #4f46e5, #7c3aed); border: none; border-radius: 16px; padding: 20px 30px; color: white; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3);" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                                <span style="font-size: 1.5rem;">ðŸ“š</span>
                                <div style="text-align: left;">
                                    <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 2px;">Realizar Tests</div>
                                    <div style="font-size: 0.85rem; opacity: 0.9; font-weight: 400;">Crear y gestionar exÃ¡menes</div>
                                </div>
                            </div>
                        </button>
                        
                        <button onclick="goToSummaries()" style="background: linear-gradient(135deg, #059669, #0ea5e9); border: none; border-radius: 16px; padding: 20px 30px; color: white; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 20px rgba(5, 150, 105, 0.3);" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                                <span style="font-size: 1.5rem;">ðŸ“Š</span>
                                <div style="text-align: left;">
                                    <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 2px;">Ver ResÃºmenes</div>
                                    <div style="font-size: 0.85rem; opacity: 0.9; font-weight: 400;">Analizar resultados y estadÃ­sticas</div>
                                </div>
                            </div>
                        </button>
                        
                        <button onclick="goToMemoryCards()" style="background: linear-gradient(135deg, #f59e0b, #d97706); border: none; border-radius: 16px; padding: 20px 30px; color: white; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3);" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                                <span style="font-size: 1.5rem;">ðŸƒ</span>
                                <div style="text-align: left;">
                                    <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 2px;">Tarjetas de Memoria</div>
                                    <div style="font-size: 0.85rem; opacity: 0.9; font-weight: 400;">Repasar con tarjetas interactivas</div>
                                </div>
                            </div>
                        </button>
                        
                        <button onclick="goToMultiplayer()" style="background: linear-gradient(135deg, #ef4444, #dc2626); border: none; border-radius: 16px; padding: 20px 30px; color: white; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                                <span style="font-size: 1.5rem;">âš”ï¸</span>
                                <div style="text-align: left;">
                                    <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 2px;">Duelo de Preguntas</div>
                                    <div style="font-size: 0.85rem; opacity: 0.9; font-weight: 400;">Compete con otros usuarios</div>
                                </div>
                            </div>
                        </button>
                    </div>
                    
                    <div style="border-top: 1px solid #e5e7eb; padding-top: 25px; color: #9ca3af; font-size: 0.9rem;">
                        <p style="margin: 0;">Sistema de ExÃ¡menes â€¢ Usuario: ${state.currentUser.name}</p>
                    </div>
                </div>
            </div>
        </div>
    `;
};
    
    // EXTENDER renderTabContent para incluir memory-cards
    const originalRenderTabContentMemory = renderTabContent;
    renderTabContent = function() {
        switch(state.currentTab) {
            case 'upload':
                return renderUploadTab();
            case 'questions':
                return renderQuestionsTab();
            case 'test':
                return renderTestTab();
            case 'results':
                return renderResultsTab();
            case 'summary':
                return renderSummaryTab();
            case 'memory-cards':
                return renderMemoryCardsTab();
            default:
                return '<div>Error: PestaÃ±a no encontrada - ' + state.currentTab + '</div>';
        }
    };
    
    // EXTENDER render para mostrar botÃ³n en header cuando estamos en tarjetas
    const originalRenderMemoryCards = render;
    render = function() {
        if (showIntermediateScreen && state.currentUser) {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <div class="title">Sistema de ExÃ¡menes</div>
                        <div>
                            <span style="color: ${state.apiKey ? '#10b981' : '#ef4444'};">
                                ${state.apiKey ? 'âœ… API Configurada' : 'âŒ Sin API'}
                            </span>
                            <button onclick="configureAPI()" class="btn btn-secondary">API</button>
                            <span style="color: #f59e0b;">ðŸ‘¤ ${state.currentUser.name}</span>
                            <button onclick="logout()" class="btn btn-danger">Salir</button>
                        </div>
                    </div>
                    ${renderIntermediateScreen()}
                </div>
            `;
        } else if (state.currentUser) {
            const app = document.getElementById('app');
            
            let pageTitle = 'Sistema de ExÃ¡menes';
            if (state.currentTab === 'questions') pageTitle = 'Banco de Preguntas';
            else if (state.currentTab === 'results') pageTitle = 'Resultados del Test';
            else if (state.currentTab === 'summary') pageTitle = 'Generador de ResÃºmenes';
            else if (state.currentTab === 'memory-cards') pageTitle = 'Tarjetas de Memoria';
            
            const showNavTabs = state.currentTab !== 'summary' && state.currentTab !== 'memory-cards';
            
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <div class="title">${pageTitle}</div>
                        <div>
                            <span style="color: ${state.apiKey ? '#10b981' : '#ef4444'};">
                                ${state.apiKey ? 'âœ… API Configurada' : 'âŒ Sin API'}
                            </span>
                            <button onclick="configureAPI()" class="btn btn-secondary">API</button>
                            ${state.currentTab === 'memory-cards' ? `
                                <button onclick="backToMainMenuFromCards()" class="btn btn-info">ðŸ  MenÃº</button>
                            ` : ''}
                            <span style="color: #f59e0b;">ðŸ‘¤ ${state.currentUser.name}</span>
                            <button onclick="logout()" class="btn btn-danger">Salir</button>
                        </div>
                    </div>

                    ${showNavTabs ? `
                        <div class="nav-tabs">
                            <button class="nav-tab ${state.currentTab === 'upload' ? 'active' : ''}" onclick="setTab('upload')">
                                ðŸ“¤ Subir Test
                            </button>
                            <button class="nav-tab ${state.currentTab === 'questions' ? 'active' : ''}" onclick="setTab('questions')">
                                ðŸ“‹ Banco de Preguntas (${getFilteredQuestions().length})
                            </button>
                            <button class="nav-tab ${state.currentTab === 'test' ? 'active' : ''}" onclick="setTab('test')">
                                ðŸŽ¯ Test Aleatorio
                            </button>
                            <button class="nav-tab ${state.currentTab === 'results' ? 'active' : ''}" onclick="setTab('results')">
                                ðŸ“Š Resultados (${state.testResults.length})
                            </button>
                        </div>
                    ` : ''}

                    <div id="messages"></div>

                    ${renderTabContent()}
                </div>
            `;
        } else {
            originalRenderMemoryCards.call(this);
        }
    };
    
    // ATAJOS DE TECLADO
    function setupMemoryCardsKeyboard() {
        document.addEventListener('keydown', function(e) {
            if (state.currentTab !== 'memory-cards') return;
            
            switch(e.key) {
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    e.preventDefault();
                    previousCard();
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    e.preventDefault();
                    nextCard();
                    break;
                case ' ':
                case 'Enter':
                    e.preventDefault();
                    toggleAnswer();
                    break;
                case 's':
                case 'S':
                    e.preventDefault();
                    shuffleCards();
                    break;
                case 'Escape':
                    e.preventDefault();
                    backToMainMenuFromCards();
                    break;
            }
        });
    }
    
    setupMemoryCardsKeyboard();
    
    console.log('âœ… Sistema de Tarjetas de Memoria CORREGIDO implementado');
    console.log('ðŸƒ Funcionalidades:');
    console.log('   - BotÃ³n "ðŸ  MenÃº" en header (mÃ¡s corto)');
    console.log('   - Tarjeta con animaciÃ³n flotante sutil');
    console.log('   - Tema dentro de la tarjeta');
    console.log('   - Solo respuesta correcta');
    console.log('   - DiseÃ±o limpio y funcional');
    
    setTimeout(() => {
        if (state.currentUser && typeof window.render === 'function') {
            render();
        }
    }, 100);
</script>
   <!-- 
PARCHE: BOTÃ“N MENÃš UNIVERSAL EN TODAS LAS PANTALLAS
AÃ±adir este cÃ³digo AL FINAL del archivo index.html, justo antes de </body>
Este parche aÃ±ade un botÃ³n "MenÃº" consistente en el header de todas las pantallas
-->

<script>
    // ========== PARCHE: BOTÃ“N MENÃš UNIVERSAL ==========
    console.log('ðŸŽ¯ Implementando botÃ³n MenÃº universal...');
    
    // INTERCEPTAR la funciÃ³n render para aÃ±adir el botÃ³n MenÃº a todas las pantallas
    const originalRenderForMenu = window.render;
    window.render = function() {
        // Llamar a la funciÃ³n de render original
        originalRenderForMenu.call(this);
        
        // Solo aÃ±adir el botÃ³n si el usuario estÃ¡ logueado
        if (state.currentUser) {
            addUniversalMenuButton();
        }
    };
    
    // FUNCIÃ“N para aÃ±adir el botÃ³n MenÃº universal
    function addUniversalMenuButton() {
        // Esperar un poco para que el DOM se haya renderizado
        setTimeout(() => {
            const header = document.querySelector('.header');
            
            if (header && !document.getElementById('universal-menu-button')) {
                // Crear el botÃ³n MenÃº
                const menuButton = document.createElement('button');
                menuButton.id = 'universal-menu-button';
                menuButton.onclick = goToMainMenu;
                menuButton.className = 'btn btn-info';
                menuButton.style.cssText = `
                    padding: 8px 16px; 
                    font-size: 14px; 
                    font-weight: 600;
                    display: flex; 
                    align-items: center; 
                    gap: 8px;
                    margin-right: 15px;
                    border-radius: 8px;
                    transition: all 0.2s ease;
                `;
                menuButton.innerHTML = '<span>ðŸ </span> MenÃº';
                
                // AÃ±adir efecto hover
                menuButton.addEventListener('mouseover', function() {
                    this.style.transform = 'translateY(-1px)';
                    this.style.boxShadow = '0 4px 12px rgba(14, 165, 233, 0.3)';
                });
                
                menuButton.addEventListener('mouseout', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                });
                
                // Insertar el botÃ³n en el header
                // Buscar el contenedor de botones de usuario (lado derecho del header)
                const userButtons = header.querySelector('div:last-child');
                if (userButtons) {
                    // Insertar el botÃ³n MenÃº al principio del contenedor de botones de usuario
                    userButtons.insertBefore(menuButton, userButtons.firstChild);
                } else {
                    // Si no hay contenedor de botones, aÃ±adir al final del header
                    header.appendChild(menuButton);
                }
                
                console.log('ðŸŽ¯ BotÃ³n MenÃº aÃ±adido al header');
            }
        }, 50);
    }
    
    // FUNCIÃ“N para ir al menÃº principal
    function goToMainMenu() {
        console.log('ðŸ  Navegando al menÃº principal...');
        
        // Resetear todos los estados a su valor inicial
        showIntermediateScreen = true;
        state.currentTab = 'upload';
        
        // Resetear estado de resÃºmenes si existe
        if (typeof summarySystemState !== 'undefined') {
            summarySystemState.currentView = 'create';
            summarySystemState.viewingSummary = null;
            summarySystemState.selectedImages = [];
            summarySystemState.generatedSummary = '';
            summarySystemState.isProcessing = false;
        }
        
        // Resetear estado de tarjetas de memoria si existe
        if (typeof memoryCardsState !== 'undefined') {
            memoryCardsState.currentCard = null;
            memoryCardsState.cardIndex = 0;
            memoryCardsState.showAnswer = false;
        }
        
        // Resetear estado de tests
        if (state.currentTest) {
            if (state.currentTest.timer) {
                clearInterval(state.currentTest.timer);
            }
            state.currentTest = null;
        }
        
        // Resetear filtros de preguntas
        state.selectedTopicFilter = 'all';
        state.selectedTopicForNewQuestions = null;
        state.currentViewingResult = null;
        
        // Limpiar estados de upload
        state.selectedImages = [];
        state.transcribedText = '';
        state.cleanedText = '';
        
        // Re-renderizar
        render();
        
        // Mostrar mensaje de confirmaciÃ³n
        showMessage('Volviendo al menÃº principal', 'success');
    }
    
    // ASEGURAR que el botÃ³n aparezca en pantallas especiales
    
    // Para la pantalla de visualizaciÃ³n de resultados especÃ­ficos
    const originalRenderSpecificResult = renderSpecificResult;
    if (typeof renderSpecificResult === 'function') {
        window.renderSpecificResult = function(result) {
            const originalHTML = originalRenderSpecificResult(result);
            // La funciÃ³n render ya se encargarÃ¡ de aÃ±adir el botÃ³n
            return originalHTML;
        };
    }
    
    // Para la pantalla de test en curso
    const originalRenderCurrentTest = renderCurrentTest;
    if (typeof renderCurrentTest === 'function') {
        window.renderCurrentTest = function() {
            const originalHTML = originalRenderCurrentTest();
            // La funciÃ³n render ya se encargarÃ¡ de aÃ±adir el botÃ³n
            return originalHTML;
        };
    }
    
    // MANEJAR casos especiales donde el botÃ³n podrÃ­a no aparecer
    
    // Interceptar setTab para asegurar que el botÃ³n se re-aÃ±ada
    const originalSetTabForMenu = window.setTab;
    if (typeof window.setTab === 'function') {
        window.setTab = function(tab) {
            // Remover botÃ³n anterior para evitar duplicados
            const existingButton = document.getElementById('universal-menu-button');
            if (existingButton) {
                existingButton.remove();
            }
            
            // Llamar funciÃ³n original
            originalSetTabForMenu.call(this, tab);
        };
    }
    
    // ESTILOS CSS adicionales para el botÃ³n
    const menuButtonStyles = document.createElement('style');
    menuButtonStyles.textContent = `
        #universal-menu-button {
            background: linear-gradient(135deg, #0ea5e9, #0284c7) !important;
            border: none !important;
            color: white !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        #universal-menu-button:hover {
            background: linear-gradient(135deg, #0284c7, #0369a1) !important;
        }
        
        #universal-menu-button:active {
            transform: translateY(0) !important;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1) !important;
        }
        
        /* Responsive: ocultar texto en pantallas pequeÃ±as */
        @media (max-width: 768px) {
            #universal-menu-button span:last-child {
                display: none;
            }
            #universal-menu-button {
                padding: 8px 12px !important;
            }
        }
    `;
    
    // AÃ±adir estilos al head si no existen
    if (!document.getElementById('universal-menu-styles')) {
        menuButtonStyles.id = 'universal-menu-styles';
        document.head.appendChild(menuButtonStyles);
    }
    
    // FUNCIÃ“N de diagnÃ³stico (opcional)
    window.checkMenuButton = function() {
        console.log('ðŸ” DIAGNÃ“STICO DEL BOTÃ“N MENÃš:');
        console.log('- BotÃ³n existe:', !!document.getElementById('universal-menu-button'));
        console.log('- Header existe:', !!document.querySelector('.header'));
        console.log('- Usuario logueado:', !!state.currentUser);
        console.log('- PestaÃ±a actual:', state.currentTab);
        console.log('- Pantalla intermedia:', showIntermediateScreen);
    };
    
    console.log('âœ… Parche de botÃ³n MenÃº universal aplicado correctamente');
    console.log('ðŸŽ¯ El botÃ³n "ðŸ  MenÃº" aparecerÃ¡ en todas las pantallas del sistema');
    console.log('ðŸ”§ Usa checkMenuButton() en consola para diagnÃ³stico si hay problemas');
    
    // Forzar re-renderizado para aplicar el botÃ³n inmediatamente
    setTimeout(() => {
        if (state.currentUser && typeof window.render === 'function') {
            render();
        }
    }, 100);
</script>
  <!-- 
PARCHE: HEADER UNIFICADO "PRIII" EN TODAS LAS PANTALLAS
AÃ±adir este cÃ³digo AL FINAL del archivo index.html, justo antes de </body>
Este parche crea un header consistente con "Priii", botÃ³n MenÃº central, y botones API/Perfil
-->

<script>
    // ========== PARCHE: HEADER UNIFICADO "PRIII" ==========
    console.log('ðŸŽ¨ Implementando header unificado "Priii"...');
    
    // Estado para el modal de perfil
    let userProfileState = {
        showModal: false,
        editingField: null
    };
    
    // FUNCIÃ“N para mostrar/ocultar modal de perfil
    window.toggleUserProfile = function() {
        userProfileState.showModal = !userProfileState.showModal;
        userProfileState.editingField = null;
        renderUserProfileModal();
    };
    
    // FUNCIÃ“N para editar campo del perfil
    window.editProfileField = function(field) {
        if (!state.currentUser) return;
        
        const users = JSON.parse(localStorage.getItem('realSystemUsers') || '{}');
        const currentUser = users[state.currentUser.username];
        
        if (!currentUser) return;
        
        let newValue = '';
        let message = '';
        
        switch(field) {
            case 'name':
                newValue = prompt('Nuevo nombre completo:', currentUser.name);
                message = 'Nombre actualizado correctamente';
                break;
            case 'password':
                const oldPassword = prompt('ContraseÃ±a actual:');
                if (!oldPassword || oldPassword !== currentUser.password) {
                    showMessage('ContraseÃ±a actual incorrecta', 'error');
                    return;
                }
                newValue = prompt('Nueva contraseÃ±a (mÃ­nimo 4 caracteres):');
                if (!newValue || newValue.length < 4) {
                    showMessage('La nueva contraseÃ±a debe tener al menos 4 caracteres', 'error');
                    return;
                }
                const confirmPassword = prompt('Confirmar nueva contraseÃ±a:');
                if (newValue !== confirmPassword) {
                    showMessage('Las contraseÃ±as no coinciden', 'error');
                    return;
                }
                message = 'ContraseÃ±a actualizada correctamente';
                break;
            case 'security':
                const currentAnswer = prompt('Respuesta actual a la pregunta de seguridad:');
                if (!currentAnswer || currentAnswer.toLowerCase().trim() !== currentUser.securityAnswer) {
                    showMessage('Respuesta de seguridad incorrecta', 'error');
                    return;
                }
                const newQuestion = prompt('Nueva pregunta de seguridad:', currentUser.securityQuestion);
                if (!newQuestion) return;
                const newAnswer = prompt('Nueva respuesta:');
                if (!newAnswer) return;
                
                currentUser.securityQuestion = newQuestion;
                currentUser.securityAnswer = newAnswer.toLowerCase().trim();
                localStorage.setItem('realSystemUsers', JSON.stringify(users));
                showMessage('Pregunta de seguridad actualizada', 'success');
                renderUserProfileModal();
                return;
        }
        
        if (newValue && newValue.trim()) {
            currentUser[field] = field === 'name' ? newValue.trim() : newValue;
            
            // Actualizar en localStorage
            localStorage.setItem('realSystemUsers', JSON.stringify(users));
            
            // Actualizar estado actual si es el nombre
            if (field === 'name') {
                state.currentUser.name = newValue.trim();
            }
            
            showMessage(message, 'success');
            renderUserProfileModal();
            render(); // Re-renderizar para actualizar el nombre en el header
        }
    };
    
    // FUNCIÃ“N para renderizar el modal de perfil
    function renderUserProfileModal() {
        // Remover modal existente
        const existingModal = document.getElementById('user-profile-modal');
        if (existingModal) {
            existingModal.remove();
        }
        
        if (!userProfileState.showModal || !state.currentUser) return;
        
        const users = JSON.parse(localStorage.getItem('realSystemUsers') || '{}');
        const currentUser = users[state.currentUser.username];
        
        if (!currentUser) return;
        
        const modal = document.createElement('div');
        modal.id = 'user-profile-modal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        `;
        
        modal.innerHTML = `
            <div style="
                background: white;
                border-radius: 16px;
                padding: 30px;
                max-width: 500px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 40px rgba(0,0,0,0.2);
                animation: slideInModal 0.3s ease;
            ">
                <!-- Header del modal -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 style="margin: 0; color: #1f2937; display: flex; align-items: center; gap: 10px;">
                        <span>ðŸ‘¤</span> Perfil de Usuario
                    </h2>
                    <button onclick="toggleUserProfile()" style="
                        background: #ef4444;
                        color: white;
                        border: none;
                        border-radius: 50%;
                        width: 32px;
                        height: 32px;
                        font-size: 16px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">Ã—</button>
                </div>
                
                <!-- InformaciÃ³n del usuario -->
                <div style="space-y: 20px;">
                    
                    <!-- Nombre completo -->
                    <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <label style="font-size: 13px; font-weight: 600; color: #6b7280; display: block; margin-bottom: 5px;">NOMBRE COMPLETO</label>
                                <div style="font-size: 16px; color: #1f2937; font-weight: 500;">${currentUser.name}</div>
                            </div>
                            <button onclick="editProfileField('name')" class="btn btn-warning" style="padding: 6px 12px; font-size: 12px;">
                                âœï¸ Editar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Usuario (no editable) -->
                    <div style="background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <label style="font-size: 13px; font-weight: 600; color: #6b7280; display: block; margin-bottom: 5px;">NOMBRE DE USUARIO</label>
                        <div style="font-size: 16px; color: #6b7280; font-weight: 500;">${state.currentUser.username}</div>
                        <div style="font-size: 11px; color: #9ca3af; margin-top: 5px; font-style: italic;">No se puede modificar</div>
                    </div>
                    
                    <!-- ContraseÃ±a -->
                    <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <label style="font-size: 13px; font-weight: 600; color: #92400e; display: block; margin-bottom: 5px;">CONTRASEÃ‘A</label>
                                <div style="font-size: 16px; color: #78350f; font-weight: 500;">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</div>
                            </div>
                            <button onclick="editProfileField('password')" class="btn btn-warning" style="padding: 6px 12px; font-size: 12px;">
                                ðŸ”‘ Cambiar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Pregunta de seguridad -->
                    <div style="background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1; margin-right: 15px;">
                                <label style="font-size: 13px; font-weight: 600; color: #1e40af; display: block; margin-bottom: 5px;">PREGUNTA DE SEGURIDAD</label>
                                <div style="font-size: 14px; color: #1e3a8a; line-height: 1.4;">${currentUser.securityQuestion}</div>
                            </div>
                            <button onclick="editProfileField('security')" class="btn btn-info" style="padding: 6px 12px; font-size: 12px; flex-shrink: 0;">
                                ðŸ” Cambiar
                            </button>
                        </div>
                    </div>
                    
                    <!-- InformaciÃ³n de cuenta -->
                    <div style="background: #f0fdf4; border: 1px solid #22c55e; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <label style="font-size: 13px; font-weight: 600; color: #166534; display: block; margin-bottom: 10px;">INFORMACIÃ“N DE LA CUENTA</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 13px; color: #166534;">
                            <div>
                                <div style="font-weight: 500; margin-bottom: 2px;">Cuenta creada:</div>
                                <div style="opacity: 0.8;">${currentUser.createdAt}</div>
                            </div>
                            <div>
                                <div style="font-weight: 500; margin-bottom: 2px;">Ãšltimo acceso:</div>
                                <div style="opacity: 0.8;">${currentUser.lastLogin || 'Nunca'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- EstadÃ­sticas del usuario -->
                    <div style="background: linear-gradient(135deg, #667eea15, #764ba215); border: 1px solid #4f46e5; border-radius: 8px; padding: 15px;">
                        <label style="font-size: 13px; font-weight: 600; color: #4f46e5; display: block; margin-bottom: 10px;">ðŸ“Š ESTADÃSTICAS PERSONALES</label>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; font-size: 13px;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #4f46e5;">${state.questions.length}</div>
                                <div style="color: #6366f1; font-size: 11px;">Preguntas</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #7c3aed;">${state.topics.length}</div>
                                <div style="color: #8b5cf6; font-size: 11px;">Temas</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #059669;">${state.testResults.length}</div>
                                <div style="color: #10b981; font-size: 11px;">Tests</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #f59e0b;">${(typeof summarySystemState !== 'undefined') ? summarySystemState.savedSummaries.length : 0}</div>
                                <div style="color: #d97706; font-size: 11px;">ResÃºmenes</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <style>
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                
                @keyframes slideInModal {
                    from { 
                        opacity: 0;
                        transform: translateY(-20px) scale(0.95);
                    }
                    to { 
                        opacity: 1;
                        transform: translateY(0) scale(1);
                    }
                }
            </style>
        `;
        
        // AÃ±adir al DOM
        document.body.appendChild(modal);
        
        // Cerrar modal al hacer clic fuera
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                toggleUserProfile();
            }
        });
    }
    
    // FUNCIÃ“N para ir al menÃº principal desde cualquier lugar
    window.goToMainMenuUnified = function() {
        console.log('ðŸ  Navegando al menÃº principal desde header unificado...');
        
        // Cerrar modal de perfil si estÃ¡ abierto
        userProfileState.showModal = false;
        renderUserProfileModal();
        
        // Resetear todos los estados
        showIntermediateScreen = true;
        state.currentTab = 'upload';
        
        // Resetear estado de resÃºmenes
        if (typeof summarySystemState !== 'undefined') {
            summarySystemState.currentView = 'create';
            summarySystemState.viewingSummary = null;
            summarySystemState.selectedImages = [];
            summarySystemState.generatedSummary = '';
            summarySystemState.isProcessing = false;
        }
        
        // Resetear estado de tarjetas de memoria
        if (typeof memoryCardsState !== 'undefined') {
            memoryCardsState.currentCard = null;
            memoryCardsState.cardIndex = 0;
            memoryCardsState.showAnswer = false;
        }
        
        // Resetear estado de tests
        if (state.currentTest) {
            if (state.currentTest.timer) {
                clearInterval(state.currentTest.timer);
            }
            state.currentTest = null;
        }
        
        // Resetear filtros y estados
        state.selectedTopicFilter = 'all';
        state.selectedTopicForNewQuestions = null;
        state.currentViewingResult = null;
        state.selectedImages = [];
        state.transcribedText = '';
        state.cleanedText = '';
        
        render();
        showMessage('Volviendo al menÃº principal', 'success');
    };
    
    // FUNCIÃ“N para renderizar el header unificado
    function renderUnifiedHeader() {
        return `
            <div class="unified-header">
                <!-- Logo/Marca "Priii" -->
                <div class="priii-logo" onclick="goToMainMenuUnified()" title="Ir al menÃº principal">
                    Priii
                </div>
                
                <!-- BotÃ³n MenÃº Central -->
                <div class="center-menu">
                    <button onclick="goToMainMenuUnified()" class="menu-button">
                        <span class="menu-icon">ðŸ </span>
                        <span class="menu-text">MenÃº</span>
                    </button>
                </div>
                
                <!-- Botones de la derecha -->
                <div class="right-buttons">
                    <button onclick="configureAPI()" class="header-btn api-btn" title="Configurar API de Anthropic">
                        <span class="btn-icon">ðŸ”‘</span>
                        <span class="btn-text">API</span>
                        <span class="api-status ${state.apiKey ? 'active' : 'inactive'}"></span>
                    </button>
                    
                    <button onclick="toggleUserProfile()" class="header-btn profile-btn" title="Perfil de usuario">
                        <span class="btn-icon">ðŸ‘¤</span>
                        <span class="btn-text">${state.currentUser.name.split(' ')[0]}</span>
                    </button>
                </div>
            </div>
            
            <style>
                .unified-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 15px 25px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                    position: relative;
                    z-index: 1000;
                }
                
                /* Logo Priii */
                .priii-logo {
                    font-size: 2.5rem;
                    font-weight: 900;
                    background: linear-gradient(45deg, #fff, #f0f9ff);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                    background-clip: text;
                    text-shadow: 0 4px 8px rgba(0,0,0,0.3);
                    cursor: pointer;
                    transition: all 0.3s ease;
                    font-family: 'Comic Sans MS', cursive, sans-serif;
                    letter-spacing: -2px;
                    transform: rotate(-2deg);
                    user-select: none;
                }
                
                .priii-logo:hover {
                    transform: rotate(0deg) scale(1.05);
                    filter: drop-shadow(0 0 10px rgba(255,255,255,0.5));
                }
                
                /* MenÃº Central */
                .center-menu {
                    position: absolute;
                    left: 50%;
                    transform: translateX(-50%);
                }
                
                .menu-button {
                    background: rgba(255,255,255,0.15);
                    border: 2px solid rgba(255,255,255,0.3);
                    border-radius: 25px;
                    color: white;
                    padding: 12px 24px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    transition: all 0.3s ease;
                    backdrop-filter: blur(10px);
                }
                
                .menu-button:hover {
                    background: rgba(255,255,255,0.25);
                    border-color: rgba(255,255,255,0.5);
                    transform: translateY(-2px);
                    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
                }
                
                .menu-icon {
                    font-size: 18px;
                }
                
                /* Botones de la derecha */
                .right-buttons {
                    display: flex;
                    gap: 10px;
                    align-items: center;
                }
                
                .header-btn {
                    background: rgba(255,255,255,0.1);
                    border: 1px solid rgba(255,255,255,0.2);
                    border-radius: 20px;
                    color: white;
                    padding: 10px 16px;
                    font-size: 14px;
                    font-weight: 500;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    transition: all 0.2s ease;
                    position: relative;
                }
                
                .header-btn:hover {
                    background: rgba(255,255,255,0.2);
                    border-color: rgba(255,255,255,0.4);
                    transform: translateY(-1px);
                }
                
                .btn-icon {
                    font-size: 16px;
                }
                
                /* Indicador de estado API */
                .api-status {
                    position: absolute;
                    top: -2px;
                    right: -2px;
                    width: 10px;
                    height: 10px;
                    border-radius: 50%;
                    border: 2px solid white;
                }
                
                .api-status.active {
                    background: #22c55e;
                    box-shadow: 0 0 6px rgba(34, 197, 94, 0.8);
                }
                
                .api-status.inactive {
                    background: #ef4444;
                }
                
                /* Responsive */
                @media (max-width: 768px) {
                    .unified-header {
                        padding: 12px 15px;
                    }
                    
                    .priii-logo {
                        font-size: 2rem;
                    }
                    
                    .menu-button {
                        padding: 10px 16px;
                        font-size: 14px;
                    }
                    
                    .menu-text,
                    .btn-text {
                        display: none;
                    }
                    
                    .header-btn {
                        padding: 10px 12px;
                    }
                }
                
                @media (max-width: 480px) {
                    .center-menu {
                        position: static;
                        transform: none;
                        order: -1;
                        margin-right: auto;
                        margin-left: 10px;
                    }
                    
                    .unified-header {
                        flex-wrap: wrap;
                        gap: 10px;
                    }
                }
            </style>
        `;
    }
    
    // INTERCEPTAR la funciÃ³n render principal para usar el header unificado
    const originalRenderForUnifiedHeader = window.render;
    window.render = function() {
        const app = document.getElementById('app');
        
        if (!state.currentUser) {
            // Pantallas de login - usar funciÃ³n original
            originalRenderForUnifiedHeader.call(this);
        } else {
            // Usuario logueado - usar header unificado
            
            let contentHTML = '';
            
            if (showIntermediateScreen) {
                // Pantalla intermedia (menÃº principal)
                contentHTML = renderIntermediateScreen();
            } else {
                // Otras pantallas - renderizar contenido con navegaciÃ³n interna cuando corresponda
                if (state.currentTab !== 'summary' && state.currentTab !== 'memory-cards') {
                    // Para secciones de tests (upload, questions, test, results) mantener navegaciÃ³n
                    contentHTML = `
                        <div class="nav-tabs">
                            <button class="nav-tab ${state.currentTab === 'upload' ? 'active' : ''}" onclick="setTab('upload')">
                                ðŸ“¤ Subir Test
                            </button>
                            <button class="nav-tab ${state.currentTab === 'questions' ? 'active' : ''}" onclick="setTab('questions')">
                                ðŸ“‹ Banco de Preguntas (${getFilteredQuestions().length})
                            </button>
                            <button class="nav-tab ${state.currentTab === 'test' ? 'active' : ''}" onclick="setTab('test')">
                                ðŸŽ¯ Test Aleatorio
                            </button>
                            <button class="nav-tab ${state.currentTab === 'results' ? 'active' : ''}" onclick="setTab('results')">
                                ðŸ“Š Resultados (${state.testResults.length})
                            </button>
                        </div>
                        ${renderTabContent()}
                    `;
                } else {
                    // Para resÃºmenes y tarjetas de memoria, solo el contenido
                    contentHTML = renderTabContent();
                }
            }
            
            app.innerHTML = `
                <div class="container" style="padding: 0; max-width: none; margin: 0; border-radius: 0; box-shadow: none; background: transparent;">
                    ${renderUnifiedHeader()}
                    
                    <div style="padding: 20px; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); min-height: calc(100vh - 80px);">
                        <div id="messages" style="max-width: 1400px; margin: 0 auto 20px auto;"></div>
                        <div style="max-width: 1400px; margin: 0 auto;">
                            ${contentHTML}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Renderizar modal de perfil si estÃ¡ activo
        renderUserProfileModal();
    };
    
    // LIMPIAR funciones de navegaciÃ³n redundantes ya que ahora todo se maneja desde el header
    // Mantener las funciones existentes por compatibilidad pero simplificarlas
    
    window.backToIntermediateScreen = goToMainMenuUnified;
    window.backToMainMenu = goToMainMenuUnified;
    window.backToMainMenuFromCards = goToMainMenuUnified;
    
    // INTERCEPTAR funciones que podrÃ­an aÃ±adir botones redundantes
    const originalAddNavigationButtons = window.addNavigationButtons || function() {};
    window.addNavigationButtons = function() {
        // No hacer nada - el header unificado maneja toda la navegaciÃ³n
        console.log('ðŸš« NavegaciÃ³n redundante bloqueada - usando header unificado');
    };
    
    // INTERCEPTAR funciÃ³n addUniversalMenuButton
    const originalAddUniversalMenuButton = window.addUniversalMenuButton || function() {};
    window.addUniversalMenuButton = function() {
        // No hacer nada - el header unificado ya incluye el botÃ³n
        console.log('ðŸš« BotÃ³n menÃº redundante bloqueado - usando header unificado');
    };
    
    // ACTUALIZAR estilos globales para el nuevo diseÃ±o
    const unifiedHeaderStyles = document.createElement('style');
    unifiedHeaderStyles.textContent = `
        /* Reset de estilos del container original */
        body {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            margin: 0;
            padding: 0;
        }
        
        /* Ocultar headers redundantes */
        .header:not(.unified-header) {
            display: none !important;
        }
        
        /* Ocultar botones de navegaciÃ³n redundantes pero mantener navegaciÃ³n interna */
        #cross-navigation,
        #universal-menu-button,
        button[onclick*="backToIntermediateScreen"],
        button[onclick*="backToMainMenu"],
        button[onclick*="backToMainMenuFromCards"] {
            display: none !important;
        }
        
        /* Estilos para las pestaÃ±as de navegaciÃ³n interna */
        .nav-tabs {
            display: flex;
            margin-bottom: 30px;
            background: #f8fafc;
            border-radius: 12px;
            padding: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .nav-tab {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #6b7280;
        }
        
        .nav-tab.active {
            background: white;
            color: #4f46e5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-weight: 600;
        }
        
        .nav-tab:hover:not(.active) {
            background: rgba(255,255,255,0.5);
            color: #374151;
        }
        
        /* Ajustar mensaje de notificaciones para el nuevo header */
        #messages .message {
            position: relative;
            z-index: 999;
            max-width: 500px;
            margin: 0 auto;
        }
        
        /* Mejorar contraste en pantalla intermedia */
        .container > div:not(.unified-header) {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            overflow: hidden;
        }
    `;
    
    // Reemplazar estilos anteriores
    const existingStyles = document.getElementById('unified-header-styles');
    if (existingStyles) {
        existingStyles.remove();
    }
    
    unifiedHeaderStyles.id = 'unified-header-styles';
    document.head.appendChild(unifiedHeaderStyles);
    
    console.log('âœ… Header unificado "Priii" implementado correctamente');
    console.log('ðŸŽ¨ CaracterÃ­sticas:');
    console.log('   - Logo "Priii" divertido a la izquierda');
    console.log('   - BotÃ³n MenÃº centrado');
    console.log('   - Botones API y Perfil a la derecha');
    console.log('   - Modal de perfil completo');
    console.log('   - Headers redundantes eliminados');
    console.log('   - Responsive design');
    
    // Forzar re-renderizado inmediato
    setTimeout(() => {
        if (state.currentUser && typeof window.render === 'function') {
            render();
        }
    }, 100);
</script>
<!-- 
PARCHE: TARJETAS DE MEMORIA COMPACTAS - SIN SCROLL
AÃ±adir este cÃ³digo AL FINAL del archivo index.html, justo antes de </body>
Este parche optimiza el espacio vertical para evitar scroll
-->

<script>
    // ========== PARCHE: TARJETAS DE MEMORIA COMPACTAS ==========
    console.log('ðŸ“ Optimizando tarjetas de memoria para viewport completo...');
    
    // REEMPLAZAR la funciÃ³n renderMemoryCardsTab con versiÃ³n compacta
    function renderMemoryCardsTab() {
        if (memoryCardsState.verifiedQuestions.length === 0) {
            return `
                <div style="max-width: 800px; margin: 0 auto; text-align: center; padding: 40px 20px; height: calc(100vh - 200px); display: flex; flex-direction: column; justify-content: center;">
                    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); width: 80px; height: 80px; border-radius: 16px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);">
                        <span style="font-size: 2.5rem; color: white;">ðŸƒ</span>
                    </div>
                    <h2 style="color: #1f2937; margin: 0 0 15px 0; font-size: 2rem;">No hay tarjetas disponibles</h2>
                    <p style="color: #6b7280; margin: 0 0 25px 0; font-size: 1rem; line-height: 1.5; max-width: 500px; margin-left: auto; margin-right: auto;">
                        Para usar las tarjetas de memoria necesitas tener preguntas <strong>verificadas</strong> (â­) en tu banco de preguntas.
                    </p>
                    <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; padding: 20px; margin-bottom: 25px; text-align: left; max-width: 450px; margin-left: auto; margin-right: auto;">
                        <h3 style="color: #92400e; margin: 0 0 12px 0; font-size: 1rem;">ðŸ“ Â¿CÃ³mo verificar preguntas?</h3>
                        <ol style="color: #78350f; margin: 0; padding-left: 18px; line-height: 1.6; font-size: 14px;">
                            <li>Ve a "Banco de Preguntas"</li>
                            <li>Busca el botÃ³n â˜† junto a cada pregunta</li>
                            <li>Haz clic para convertirlo en â­ (verificada)</li>
                            <li>Vuelve aquÃ­ para practicar con tarjetas</li>
                        </ol>
                    </div>
                    <button onclick="goToTestsFromSummary()" class="btn btn-primary" style="padding: 12px 20px; font-size: 15px;">
                        ðŸ“‹ Ir al Banco de Preguntas
                    </button>
                </div>
            `;
        }
        
        const currentCard = memoryCardsState.currentCard;
        const cardNumber = memoryCardsState.cardIndex + 1;
        const totalCards = memoryCardsState.verifiedQuestions.length;
        const topicName = currentCard.topicId ? getTopicName(currentCard.topicId) : 'General';
        
        return `
            <div style="max-width: 900px; margin: 0 auto; padding: 15px; min-height: calc(100vh - 150px); display: flex; flex-direction: column;">
                
                <!-- Header compacto -->
                <div style="text-align: center; margin-bottom: 15px;">
                    <h1 style="color: #1f2937; margin: 0; font-size: 1.8rem; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span>ðŸƒ</span> Tarjetas de Memoria
                    </h1>
                    <p style="color: #6b7280; margin: 3px 0 0 0; font-size: 13px;">
                        Tarjeta ${cardNumber} de ${totalCards} preguntas verificadas
                    </p>
                </div>
                
                <!-- Controles superiores compactos -->
                <div style="display: flex; justify-content: center; align-items: center; gap: 12px; margin-bottom: 20px;">
                    <button onclick="shuffleCards()" class="btn btn-warning" style="padding: 8px 16px; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                        <span>ðŸ”€</span> Mezclar
                    </button>
                    <div style="background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 14px; box-shadow: 0 3px 10px rgba(79, 70, 229, 0.3);">
                        ${cardNumber} / ${totalCards}
                    </div>
                    <button onclick="loadVerifiedQuestions()" class="btn btn-info" style="padding: 8px 16px; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                        <span>ðŸ”„</span> Recargar
                    </button>
                </div>
                
                <!-- Tarjeta principal optimizada -->
                <div style="flex: 1; display: flex; align-items: center; margin-bottom: 20px;">
                    <div class="memory-card-compact" style="
                        background: linear-gradient(145deg, #ffffff, #f8fafc); 
                        border-radius: 16px; 
                        box-shadow: 0 8px 25px rgba(0,0,0,0.12), 0 1px 0 rgba(255,255,255,0.8);
                        margin: 0 auto; 
                        max-width: 700px; 
                        width: 100%;
                        position: relative; 
                        border: 2px solid #e2e8f0;
                        transition: all 0.3s ease;
                    ">
                    
                        <!-- Badge compacto -->
                        <div style="position: absolute; top: -6px; right: 12px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 6px 12px; border-radius: 15px; font-weight: 600; font-size: 12px; box-shadow: 0 3px 10px rgba(59, 130, 246, 0.4); z-index: 10;">
                            â­ Verificada
                        </div>
                        
                        <!-- Contenido de la tarjeta compacto -->
                        <div style="padding: 25px;">
                            
                            <!-- Tema y Pregunta -->
                            <div style="margin-bottom: 20px;">
                                <!-- Badge del tema -->
                                <div style="display: inline-block; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; margin-bottom: 15px; box-shadow: 0 2px 6px rgba(139, 92, 246, 0.3);">
                                    ðŸ“ ${topicName}
                                </div>
                                
                                <!-- Pregunta -->
                                <h3 style="color: #6b7280; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;">
                                    ðŸ“ PREGUNTA
                                </h3>
                                <div style="font-size: 1.1rem; line-height: 1.5; color: #1f2937; font-weight: 500; background: linear-gradient(135deg, #f8fafc, #f1f5f9); padding: 18px; border-radius: 10px; border-left: 3px solid #4f46e5; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);">
                                    ${currentCard.question}
                                </div>
                            </div>
                            
                            <!-- Ãrea de respuesta compacta -->
                            <div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <h3 style="color: #6b7280; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin: 0;">
                                        âœ… RESPUESTA CORRECTA
                                    </h3>
                                    <button onclick="toggleAnswer()" class="btn ${memoryCardsState.showAnswer ? 'btn-secondary' : 'btn-success'}" style="padding: 6px 14px; font-size: 13px; font-weight: 600; border-radius: 15px;">
                                        ${memoryCardsState.showAnswer ? 'ðŸ™ˆ Ocultar' : 'ðŸ‘ï¸ Ver'}
                                    </button>
                                </div>
                                
                                <div style="min-height: 60px; background: ${memoryCardsState.showAnswer ? 'linear-gradient(135deg, #f0fdf4, #dcfce7)' : 'linear-gradient(135deg, #f9fafb, #f3f4f6)'}; border: 2px ${memoryCardsState.showAnswer ? 'solid #22c55e' : 'dashed #d1d5db'}; border-radius: 10px; padding: 15px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
                                    
                                    ${memoryCardsState.showAnswer ? `
                                        <div style="text-align: center;">
                                            <div style="font-size: 1.1rem; font-weight: 700; color: #166534; margin-bottom: 5px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                                <span style="font-size: 1.3rem;">âœ…</span>
                                                <span>${String.fromCharCode(97 + currentCard.correctAnswer).toUpperCase()}) ${currentCard.options[currentCard.correctAnswer]}</span>
                                            </div>
                                            <div style="font-size: 12px; color: #16a34a; font-weight: 500;">
                                                Esta es la respuesta correcta
                                            </div>
                                        </div>
                                    ` : `
                                        <div style="color: #9ca3af; font-style: italic; text-align: center;">
                                            <div style="font-size: 2rem; margin-bottom: 5px;">ðŸ¤”</div>
                                            <div style="font-size: 14px;">Haz clic en "Ver" para revelar la respuesta</div>
                                        </div>
                                    `}
                                </div>
                            </div>
                            
                            <!-- Consejo compacto -->
                            <div style="text-align: center; margin-top: 15px; padding: 8px; background: rgba(79, 70, 229, 0.05); border-radius: 8px; border: 1px solid rgba(79, 70, 229, 0.1);">
                                <div style="color: #6b7280; font-size: 12px; font-weight: 500;">
                                    ðŸ’¡ Intenta responder mentalmente antes de ver la respuesta
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Controles de navegaciÃ³n fijos en la parte inferior -->
                <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: auto; padding-top: 15px;">
                    <button onclick="previousCard()" class="btn btn-secondary" style="padding: 10px 20px; font-size: 15px; border-radius: 20px; display: flex; align-items: center; gap: 8px; min-width: 120px; justify-content: center;" ${totalCards <= 1 ? 'disabled' : ''}>
                        <span style="font-size: 16px;">â†</span>
                        <span>Anterior</span>
                    </button>
                    
                    <button onclick="nextCard()" class="btn btn-primary" style="padding: 10px 20px; font-size: 15px; border-radius: 20px; display: flex; align-items: center; gap: 8px; min-width: 120px; justify-content: center;" ${totalCards <= 1 ? 'disabled' : ''}>
                        <span>Siguiente</span>
                        <span style="font-size: 16px;">â†’</span>
                    </button>
                </div>
                
                <!-- Indicador de atajos de teclado -->
                <div style="text-align: center; margin-top: 10px; padding: 5px; font-size: 11px; color: #9ca3af;">
                    â† â†’ para navegar â€¢ Espacio para ver respuesta â€¢ S para mezclar â€¢ Esc para salir
                </div>
            </div>
            
            <!-- Estilos CSS optimizados -->
            <style>
                .memory-card-compact:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 12px 30px rgba(0,0,0,0.15) !important;
                }
                
                /* Optimizaciones responsive */
                @media (max-height: 700px) {
                    .memory-card-compact {
                        max-height: calc(100vh - 300px);
                        overflow-y: auto;
                    }
                }
                
                @media (max-width: 768px) {
                    .memory-card-compact {
                        margin: 0;
                        border-radius: 12px;
                    }
                    
                    .memory-card-compact > div {
                        padding: 20px !important;
                    }
                }
                
                /* AnimaciÃ³n suave para cambio de tarjetas */
                .memory-card-compact {
                    animation: cardSlideIn 0.3s ease-out;
                }
                
                @keyframes cardSlideIn {
                    from { 
                        opacity: 0;
                        transform: translateX(20px);
                    }
                    to { 
                        opacity: 1;
                        transform: translateX(0);
                    }
                }
            </style>
        `;
    }
    
    console.log('âœ… Tarjetas de memoria optimizadas para viewport completo');
    console.log('ðŸ“ Mejoras aplicadas:');
    console.log('   - Espaciado reducido y optimizado');
    console.log('   - Layout flexbox para uso completo del alto');
    console.log('   - Controles fijos en parte inferior');
    console.log('   - Responsive para diferentes alturas de pantalla');
    console.log('   - Sin scroll necesario');
    
    // Forzar re-renderizado si estamos en tarjetas de memoria
    setTimeout(() => {
        if (state.currentUser && state.currentTab === 'memory-cards' && typeof window.render === 'function') {
            render();
        }
    }, 100);
</script>
  <!-- 
PARCHE: BOTÃ“N CERRAR SESIÃ“N EN HEADER UNIFICADO
AÃ±adir este cÃ³digo AL FINAL del archivo index.html, justo antes de </body>
Este parche aÃ±ade el botÃ³n de logout al header en todas las pÃ¡ginas
-->

<script>
    // ========== PARCHE: BOTÃ“N CERRAR SESIÃ“N EN HEADER ==========
    console.log('ðŸšª AÃ±adiendo botÃ³n de cerrar sesiÃ³n al header...');
    
    // FUNCIÃ“N para cerrar sesiÃ³n con confirmaciÃ³n simple
    window.logoutFromHeader = function() {
        const confirmLogout = confirm('Â¿Seguro que quieres cerrar sesiÃ³n?');
        
        if (confirmLogout) {
            console.log('ðŸšª Cerrando sesiÃ³n desde header...');
            
            // Cerrar modal de perfil si estÃ¡ abierto
            if (userProfileState && userProfileState.showModal) {
                userProfileState.showModal = false;
                const modal = document.getElementById('user-profile-modal');
                if (modal) {
                    modal.remove();
                }
            }
            
            // Guardar datos antes del logout
            if (state.currentUser) {
                RealDataManager.saveFromGlobalData(state.currentUser.username);
            }
            
            // Limpiar estado
            RealDataManager.clearGlobalData();
            state.currentUser = null;
            showIntermediateScreen = false;
            state.currentTab = 'upload';
            newLoginState.currentView = 'login';
            
            render();
            showMessage('SesiÃ³n cerrada correctamente', 'success');
        }
    };
    
    // FUNCIÃ“N para renderizar el header unificado CON botÃ³n de logout
    function renderUnifiedHeaderWithLogout() {
        return `
            <div class="unified-header">
                <!-- Logo/Marca "Priii" -->
                <div class="priii-logo" onclick="goToMainMenuUnified()" title="Ir al menÃº principal">
                    Priii
                </div>
                
                <!-- BotÃ³n MenÃº Central -->
                <div class="center-menu">
                    <button onclick="goToMainMenuUnified()" class="menu-button">
                        <span class="menu-icon">ðŸ </span>
                        <span class="menu-text">MenÃº</span>
                    </button>
                </div>
                
                <!-- Botones de la derecha CON logout -->
                <div class="right-buttons">
                    <button onclick="configureAPI()" class="header-btn api-btn" title="Configurar API de Anthropic">
                        <span class="btn-icon">ðŸ”‘</span>
                        <span class="btn-text">API</span>
                        <span class="api-status ${state.apiKey ? 'active' : 'inactive'}"></span>
                    </button>
                    
                    <button onclick="toggleUserProfile()" class="header-btn profile-btn" title="Perfil de usuario">
                        <span class="btn-icon">ðŸ‘¤</span>
                        <span class="btn-text">${state.currentUser.name.split(' ')[0]}</span>
                    </button>
                    
                    <button onclick="logoutFromHeader()" class="header-btn logout-btn" title="Cerrar sesiÃ³n">
                        <span class="btn-icon">ðŸšª</span>
                        <span class="btn-text">Salir</span>
                    </button>
                </div>
            </div>
            
            <style>
                .unified-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 15px 25px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                    position: relative;
                    z-index: 1000;
                }
                
                /* Logo Priii */
                .priii-logo {
                    font-size: 2.5rem;
                    font-weight: 900;
                    background: linear-gradient(45deg, #fff, #f0f9ff);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                    background-clip: text;
                    text-shadow: 0 4px 8px rgba(0,0,0,0.3);
                    cursor: pointer;
                    transition: all 0.3s ease;
                    font-family: 'Comic Sans MS', cursive, sans-serif;
                    letter-spacing: -2px;
                    transform: rotate(-2deg);
                    user-select: none;
                }
                
                .priii-logo:hover {
                    transform: rotate(0deg) scale(1.05);
                    filter: drop-shadow(0 0 10px rgba(255,255,255,0.5));
                }
                
                /* MenÃº Central */
                .center-menu {
                    position: absolute;
                    left: 50%;
                    transform: translateX(-50%);
                }
                
                .menu-button {
                    background: rgba(255,255,255,0.15);
                    border: 2px solid rgba(255,255,255,0.3);
                    border-radius: 25px;
                    color: white;
                    padding: 12px 24px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    transition: all 0.3s ease;
                    backdrop-filter: blur(10px);
                }
                
                .menu-button:hover {
                    background: rgba(255,255,255,0.25);
                    border-color: rgba(255,255,255,0.5);
                    transform: translateY(-2px);
                    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
                }
                
                .menu-icon {
                    font-size: 18px;
                }
                
                /* Botones de la derecha */
                .right-buttons {
                    display: flex;
                    gap: 8px;
                    align-items: center;
                }
                
                .header-btn {
                    background: rgba(255,255,255,0.1);
                    border: 1px solid rgba(255,255,255,0.2);
                    border-radius: 18px;
                    color: white;
                    padding: 9px 14px;
                    font-size: 13px;
                    font-weight: 500;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    transition: all 0.2s ease;
                    position: relative;
                }
                
            /* Estilos especÃ­ficos para el botÃ³n de logout */
.logout-btn {
    background: rgba(255, 255, 255, 0.1) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    color: #fff;
    transition: all 0.2s ease;
}

.logout-btn:hover {
    background: #4b5563 !important;   /* Gris sÃ³lido */
    border: 1px solid #374151 !important;
    box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    transform: translateY(-2px);
}

                
                /* Indicador de estado API */
                .api-status {
                    position: absolute;
                    top: -2px;
                    right: -2px;
                    width: 8px;
                    height: 8px;
                    border-radius: 50%;
                    border: 2px solid white;
                }
                
                .api-status.active {
                    background: #22c55e;
                    box-shadow: 0 0 6px rgba(34, 197, 94, 0.8);
                }
                
                .api-status.inactive {
                    background: #ef4444;
                }
                
                /* Responsive */
                @media (max-width: 768px) {
                    .unified-header {
                        padding: 12px 15px;
                    }
                    
                    .priii-logo {
                        font-size: 2rem;
                    }
                    
                    .menu-button {
                        padding: 10px 16px;
                        font-size: 14px;
                    }
                    
                    .menu-text,
                    .btn-text {
                        display: none;
                    }
                    
                    .header-btn {
                        padding: 9px 11px;
                    }
                    
                    .right-buttons {
                        gap: 6px;
                    }
                }
                
                @media (max-width: 480px) {
                    .center-menu {
                        position: static;
                        transform: none;
                        order: -1;
                        margin-right: auto;
                        margin-left: 10px;
                    }
                    
                    .unified-header {
                        flex-wrap: wrap;
                        gap: 8px;
                    }
                    
                    .priii-logo {
                        font-size: 1.8rem;
                    }
                    
                    .menu-button {
                        padding: 8px 12px;
                        font-size: 13px;
                    }
                }
            </style>
        `;
    }
    
    // REEMPLAZAR la funciÃ³n renderUnifiedHeader existente
    window.renderUnifiedHeader = renderUnifiedHeaderWithLogout;
    
    // INTERCEPTAR la funciÃ³n render para usar el header con logout
    const originalRenderWithLogout = window.render;
    window.render = function() {
        const app = document.getElementById('app');
        
        if (!state.currentUser) {
            // Pantallas de login - usar funciÃ³n original
            originalRenderWithLogout.call(this);
        } else {
            // Usuario logueado - usar header con logout
            
            let contentHTML = '';
            
            if (showIntermediateScreen) {
                // Pantalla intermedia (menÃº principal)
                contentHTML = renderIntermediateScreen();
            } else {
                // Otras pantallas - renderizar contenido con navegaciÃ³n interna cuando corresponda
                if (state.currentTab !== 'summary' && state.currentTab !== 'memory-cards') {
                    // Para secciones de tests (upload, questions, test, results) mantener navegaciÃ³n
                    contentHTML = `
                        <div class="nav-tabs">
                            <button class="nav-tab ${state.currentTab === 'upload' ? 'active' : ''}" onclick="setTab('upload')">
                                ðŸ“¤ Subir Test
                            </button>
                            <button class="nav-tab ${state.currentTab === 'questions' ? 'active' : ''}" onclick="setTab('questions')">
                                ðŸ“‹ Banco de Preguntas (${getFilteredQuestions().length})
                            </button>
                            <button class="nav-tab ${state.currentTab === 'test' ? 'active' : ''}" onclick="setTab('test')">
                                ðŸŽ¯ Test Aleatorio
                            </button>
                            <button class="nav-tab ${state.currentTab === 'results' ? 'active' : ''}" onclick="setTab('results')">
                                ðŸ“Š Resultados (${state.testResults.length})
                            </button>
                        </div>
                        ${renderTabContent()}
                    `;
                } else {
                    // Para resÃºmenes y tarjetas de memoria, solo el contenido
                    contentHTML = renderTabContent();
                }
            }
            
            app.innerHTML = `
                <div class="container" style="padding: 0; max-width: none; margin: 0; border-radius: 0; box-shadow: none; background: transparent;">
                    ${renderUnifiedHeaderWithLogout()}
                    
                    <div style="padding: 20px; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); min-height: calc(100vh - 80px);">
                        <div id="messages" style="max-width: 1400px; margin: 0 auto 20px auto;"></div>
                        <div style="max-width: 1400px; margin: 0 auto;">
                            ${contentHTML}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Renderizar modal de perfil si estÃ¡ activo
        if (typeof renderUserProfileModal === 'function') {
            renderUserProfileModal();
        }
    };
    
    console.log('âœ… BotÃ³n de cerrar sesiÃ³n aÃ±adido al header');
    console.log('ðŸšª CaracterÃ­sticas del botÃ³n logout:');
    console.log('   - Ubicado junto al botÃ³n de perfil');
    console.log('   - ConfirmaciÃ³n antes de cerrar sesiÃ³n');
    console.log('   - OpciÃ³n de eliminar credenciales recordadas');
    console.log('   - Estilo distintivo (rojo sutil)');
    console.log('   - Responsive para mÃ³viles');
    console.log('   - Disponible en todas las pÃ¡ginas');
    
    // Forzar re-renderizado inmediato
    setTimeout(() => {
        if (state.currentUser && typeof window.render === 'function') {
            render();
        }
    }, 100);
</script>
    <script>
// ========== PASO 1: CONFIGURACIÃ“N FIREBASE MULTIJUGADOR ==========
console.log('ðŸŽ® Configurando sistema multijugador...');

const firebaseConfig = {
  apiKey: "AIzaSyBzeTnm6iYR0b_gccYmenaR_NsOY9VmUz8",
  authDomain: "priii-572dd.firebaseapp.com",
  databaseURL: "https://priii-572dd-default-rtdb.firebaseio.com",
  projectId: "priii-572dd",
  storageBucket: "priii-572dd.firebasestorage.app",
  messagingSenderId: "858611366137",
  appId: "1:858611366137:web:9d84afde86f5b209e04a28"
};

let firebaseApp = null;
let database = null;
let multiplayerEnabled = false;

function initializeFirebase() {
    try {
        firebaseApp = firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        multiplayerEnabled = true;
        console.log('âœ… Firebase inicializado correctamente');
        return true;
    } catch (error) {
        console.error('âŒ Error inicializando Firebase:', error);
        return false;
    }
}

let multiplayerState = {
    currentRoom: null,
    isHost: false,
    opponent: null,
    roomCode: null,
    gameState: 'waiting',
    myTurn: false,
    myFailures: 0,
    opponentFailures: 0
};

document.addEventListener('DOMContentLoaded', function() {
    initializeFirebase();
});

console.log('âœ… Paso 1 completado - Firebase configurado');
</script>
    <script>
// ========== PASO 2: INTERFAZ MULTIJUGADOR ==========
console.log('ðŸŽ® Creando interfaz multijugador...');

// FunciÃ³n para ir a multijugador desde el menÃº principal
window.goToMultiplayer = function() {
    console.log('ðŸŽ¯ Cambiando a Multijugador...');
    showIntermediateScreen = false;
    state.currentTab = 'multiplayer';
    render();
};

// Extender renderTabContent para incluir multijugador
const originalRenderTabContentMultiplayer = renderTabContent;
renderTabContent = function() {
    switch(state.currentTab) {
        case 'upload':
            return renderUploadTab();
        case 'questions':
            return renderQuestionsTab();
        case 'test':
            return renderTestTab();
        case 'results':
            return renderResultsTab();
        case 'summary':
            return renderSummaryTab();
        case 'memory-cards':
            return renderMemoryCardsTab();
        case 'multiplayer':
            return renderMultiplayerTab();
        default:
            return '<div>Error: PestaÃ±a no encontrada - ' + state.currentTab + '</div>';
    }
};

// FunciÃ³n para renderizar la pestaÃ±a multijugador
function renderMultiplayerTab() {
    return `
        <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
            <div style="text-align: center; margin-bottom: 30px;">
                <h1 style="color: #1f2937; margin: 0; font-size: 2.2rem; display: flex; align-items: center; justify-content: center; gap: 15px;">
                    <span>âš”ï¸</span> Duelo de Preguntas
                </h1>
                <p style="color: #6b7280; margin: 5px 0 0 0; font-size: 14px;">
                    Compite con otro usuario - El primero en fallar 3 preguntas pierde
                </p>
            </div>
            
            <div style="display: grid; gap: 20px; max-width: 600px; margin: 0 auto;">
                <button onclick="createMultiplayerRoom()" class="btn btn-primary" style="padding: 20px; font-size: 18px; border-radius: 12px;">
                    ðŸ  Crear Sala
                </button>
                
                <button onclick="joinMultiplayerRoom()" class="btn btn-success" style="padding: 20px; font-size: 18px; border-radius: 12px;">
                    ðŸšª Unirse a Sala
                </button>
                
                <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                    <p style="color: #1e40af; margin: 0; font-size: 14px;">
                        <strong>Estado:</strong> ${multiplayerEnabled ? 'Conectado a Firebase' : 'Desconectado'}
                    </p>
                </div>
            </div>
        </div>
    `;
}

// Funciones bÃ¡sicas (por ahora solo mostrarÃ¡n mensajes)
function createMultiplayerRoom() {
    showMessage('Creando sala... (PrÃ³ximamente)', 'success');
    console.log('ðŸ  Creando sala multijugador');
}

function joinMultiplayerRoom() {
    showMessage('Unirse a sala... (PrÃ³ximamente)', 'success');
    console.log('ðŸšª UniÃ©ndose a sala multijugador');
}

console.log('âœ… Paso 2 completado - Interfaz multijugador creada');
</script>
<script>
// ========== PASO 1: GESTIÃ“N DE SALAS MULTIJUGADOR ==========
console.log('ðŸ  Implementando gestiÃ³n de salas...');

// FunciÃ³n para generar cÃ³digo de sala Ãºnico
function generateRoomCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = '';
    for (let i = 0; i < 6; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

// FunciÃ³n para crear sala de multijugador
function createMultiplayerRoom() {
    if (!multiplayerEnabled) {
        showMessage('Error: Sistema multijugador no disponible', 'error');
        return;
    }

    if (!state.currentUser) {
        showMessage('Debes estar logueado para crear una sala', 'error');
        return;
    }

    // Verificar que el usuario tenga al menos 5 preguntas verificadas
    const verifiedQuestions = state.questions.filter(q => q.isVerified);
    if (verifiedQuestions.length < 5) {
        showMessage('Necesitas al menos 5 preguntas verificadas para crear una sala', 'error');
        return;
    }

    const roomCode = generateRoomCode();
    
    // Estructura de la sala en Firebase
    const roomData = {
        code: roomCode,
        host: {
            username: state.currentUser.username,
            name: state.currentUser.name,
            questions: verifiedQuestions.length,
            ready: false
        },
        guest: null,
        status: 'waiting', // waiting, ready, playing, finished
        gameData: {
            currentQuestion: 0,
            currentTurn: 'host', // host or guest
            hostFailures: 0,
            guestFailures: 0,
            questions: [],
            hostAnswers: {},
            guestAnswers: {},
            winner: null
        },
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        lastActivity: firebase.database.ServerValue.TIMESTAMP
    };

    // Crear sala en Firebase
    database.ref('rooms/' + roomCode).set(roomData)
        .then(() => {
            console.log('âœ… Sala creada:', roomCode);
            
            // Actualizar estado local
            multiplayerState.currentRoom = roomCode;
            multiplayerState.isHost = true;
            multiplayerState.roomCode = roomCode;
            multiplayerState.gameState = 'waiting';
            
            // Escuchar cambios en la sala
            listenToRoom(roomCode);
            
            // Mostrar interfaz de sala
            renderMultiplayerRoom();
            
            showMessage(`Sala creada con cÃ³digo: ${roomCode}`, 'success');
        })
        .catch((error) => {
            console.error('âŒ Error creando sala:', error);
            showMessage('Error al crear la sala. IntÃ©ntalo de nuevo.', 'error');
        });
}

// FunciÃ³n para unirse a sala
function joinMultiplayerRoom() {
    if (!multiplayerEnabled) {
        showMessage('Error: Sistema multijugador no disponible', 'error');
        return;
    }

    if (!state.currentUser) {
        showMessage('Debes estar logueado para unirte a una sala', 'error');
        return;
    }

    // Verificar que el usuario tenga al menos 5 preguntas verificadas
    const verifiedQuestions = state.questions.filter(q => q.isVerified);
    if (verifiedQuestions.length < 5) {
        showMessage('Necesitas al menos 5 preguntas verificadas para unirte a una sala', 'error');
        return;
    }

    const roomCode = prompt('Ingresa el cÃ³digo de la sala (6 caracteres):');
    if (!roomCode || roomCode.length !== 6) {
        showMessage('CÃ³digo de sala invÃ¡lido', 'error');
        return;
    }

    const upperRoomCode = roomCode.toUpperCase();
    
    // Verificar que la sala existe y estÃ¡ disponible
    database.ref('rooms/' + upperRoomCode).once('value')
        .then((snapshot) => {
            if (!snapshot.exists()) {
                showMessage('La sala no existe', 'error');
                return;
            }

            const roomData = snapshot.val();
            
            if (roomData.status !== 'waiting') {
                showMessage('La sala no estÃ¡ disponible', 'error');
                return;
            }

            if (roomData.guest !== null) {
                showMessage('La sala estÃ¡ llena', 'error');
                return;
            }

            if (roomData.host.username === state.currentUser.username) {
                showMessage('No puedes unirte a tu propia sala', 'error');
                return;
            }

            // Unirse a la sala
            const guestData = {
                username: state.currentUser.username,
                name: state.currentUser.name,
                questions: verifiedQuestions.length,
                ready: false
            };

            return database.ref('rooms/' + upperRoomCode + '/guest').set(guestData);
        })
        .then(() => {
            console.log('âœ… Unido a sala:', upperRoomCode);
            
            // Actualizar estado local
            multiplayerState.currentRoom = upperRoomCode;
            multiplayerState.isHost = false;
            multiplayerState.roomCode = upperRoomCode;
            multiplayerState.gameState = 'waiting';
            
            // Escuchar cambios en la sala
            listenToRoom(upperRoomCode);
            
            // Mostrar interfaz de sala
            renderMultiplayerRoom();
            
            showMessage(`Te has unido a la sala: ${upperRoomCode}`, 'success');
        })
        .catch((error) => {
            console.error('âŒ Error uniÃ©ndose a sala:', error);
            showMessage('Error al unirse a la sala', 'error');
        });
}

// FunciÃ³n para escuchar cambios en la sala
function listenToRoom(roomCode) {
    const roomRef = database.ref('rooms/' + roomCode);
    
    roomRef.on('value', (snapshot) => {
        if (!snapshot.exists()) {
            console.log('âŒ La sala fue eliminada');
            showMessage('La sala ha sido cerrada', 'error');
            leaveRoom();
            return;
        }

        const roomData = snapshot.val();
        console.log('ðŸ“¡ ActualizaciÃ³n de sala:', roomData);
        
        // Actualizar estado local
        updateLocalStateFromRoom(roomData);
        
        // Re-renderizar interfaz
        renderMultiplayerRoom();
    });
}

// FunciÃ³n para actualizar estado local desde datos de Firebase
function updateLocalStateFromRoom(roomData) {
    multiplayerState.gameState = roomData.status;
    
    if (multiplayerState.isHost) {
        multiplayerState.opponent = roomData.guest;
    } else {
        multiplayerState.opponent = roomData.host;
    }
    
    // Actualizar datos del juego si existen
    if (roomData.gameData) {
        multiplayerState.myFailures = multiplayerState.isHost ? 
            roomData.gameData.hostFailures : roomData.gameData.guestFailures;
        multiplayerState.opponentFailures = multiplayerState.isHost ? 
            roomData.gameData.guestFailures : roomData.gameData.hostFailures;
        multiplayerState.myTurn = (roomData.gameData.currentTurn === 'host') === multiplayerState.isHost;
    }
}

// FunciÃ³n para salir de la sala
function leaveRoom() {
    if (multiplayerState.currentRoom && database) {
        // Si eres el host, eliminar la sala
        if (multiplayerState.isHost) {
            database.ref('rooms/' + multiplayerState.currentRoom).remove();
        } else {
            // Si eres invitado, solo remover tu presencia
            database.ref('rooms/' + multiplayerState.currentRoom + '/guest').remove();
        }
        
        // Dejar de escuchar cambios
        database.ref('rooms/' + multiplayerState.currentRoom).off();
    }
    
    // Resetear estado
    multiplayerState = {
        currentRoom: null,
        isHost: false,
        opponent: null,
        roomCode: null,
        gameState: 'waiting',
        myTurn: false,
        myFailures: 0,
        opponentFailures: 0
    };
    
    // Volver a la pantalla principal de multijugador
    render();
}

// FunciÃ³n para renderizar la interfaz de sala
function renderMultiplayerRoom() {
    // Esta funciÃ³n actualizarÃ¡ el contenido para mostrar la sala
    // Por ahora, forzamos un re-render
    render();
}

console.log('âœ… Paso 1 completado - GestiÃ³n de salas implementada');
</script>
    <script>
// Actualizar funciÃ³n renderMultiplayerTab para mostrar salas
function renderMultiplayerTab() {
    // Si estamos en una sala, mostrar interfaz de sala
    if (multiplayerState.currentRoom) {
        return renderRoomInterface();
    }
    
    // Interfaz principal de multijugador
    const verifiedQuestions = state.questions.filter(q => q.isVerified);
    const hasEnoughQuestions = verifiedQuestions.length >= 5;
    
    return `
        <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
            <div style="text-align: center; margin-bottom: 30px;">
                <h1 style="color: #1f2937; margin: 0; font-size: 2.2rem; display: flex; align-items: center; justify-content: center; gap: 15px;">
                    <span>âš”ï¸</span> Duelo de Preguntas
                </h1>
                <p style="color: #6b7280; margin: 5px 0 0 0; font-size: 14px;">
                    Compite con otro usuario - El primero en fallar 3 preguntas pierde
                </p>
            </div>
            
            ${!hasEnoughQuestions ? `
                <div style="background: #fee2e2; border: 2px solid #ef4444; border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
                    <h3 style="color: #dc2626; margin: 0 0 10px 0;">âŒ Preguntas Insuficientes</h3>
                    <p style="color: #991b1b; margin: 0; font-size: 14px;">
                        Necesitas al menos <strong>5 preguntas verificadas (â­)</strong> para jugar multijugador.
                        <br>Actualmente tienes: <strong>${verifiedQuestions.length}</strong>
                    </p>
                </div>
            ` : ''}
            
            <div style="display: grid; gap: 20px; max-width: 600px; margin: 0 auto;">
                <button onclick="createMultiplayerRoom()" class="btn btn-primary" style="padding: 20px; font-size: 18px; border-radius: 12px;" ${!hasEnoughQuestions ? 'disabled' : ''}>
                    ðŸ  Crear Sala
                </button>
                
                <button onclick="joinMultiplayerRoom()" class="btn btn-success" style="padding: 20px; font-size: 18px; border-radius: 12px;" ${!hasEnoughQuestions ? 'disabled' : ''}>
                    ðŸšª Unirse a Sala
                </button>
                
                <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                    <p style="color: #1e40af; margin: 0 0 10px 0; font-size: 14px;">
                        <strong>Estado:</strong> ${multiplayerEnabled ? 'âœ… Conectado' : 'âŒ Desconectado'}
                    </p>
                    <p style="color: #6b7280; margin: 0; font-size: 12px;">
                        Preguntas verificadas: ${verifiedQuestions.length}
                    </p>
                </div>
            </div>
        </div>
    `;
}

// Nueva funciÃ³n para renderizar la interfaz de sala
function renderRoomInterface() {
    const roomCode = multiplayerState.roomCode;
    const isHost = multiplayerState.isHost;
    const opponent = multiplayerState.opponent;
    const gameState = multiplayerState.gameState;
    
    return `
        <div style="max-width: 700px; margin: 0 auto; padding: 20px;">
            
            <!-- Header de la sala -->
            <div style="text-align: center; margin-bottom: 30px; background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; padding: 25px; border-radius: 16px;">
                <h2 style="margin: 0 0 10px 0; font-size: 1.8rem;">Sala de Duelo</h2>
                <div style="font-size: 2rem; font-weight: bold; letter-spacing: 3px; margin: 10px 0;">
                    ${roomCode}
                </div>
                <p style="margin: 0; opacity: 0.9; font-size: 14px;">
                    Comparte este cÃ³digo con tu oponente
                </p>
            </div>
            
            <!-- InformaciÃ³n de jugadores -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                
                <!-- Jugador 1 (Host) -->
                <div style="background: ${isHost ? '#f0fdf4' : '#f8fafc'}; border: 2px solid ${isHost ? '#22c55e' : '#e2e8f0'}; border-radius: 12px; padding: 20px; text-align: center;">
                    <div style="font-size: 1.5rem; margin-bottom: 10px;">${isHost ? 'ðŸ‘‘' : 'ðŸ‘¤'}</div>
                    <h3 style="margin: 0 0 5px 0; color: #1f2937;">${state.currentUser.name}</h3>
                    <p style="margin: 0; font-size: 12px; color: #6b7280;">
                        ${isHost ? 'AnfitriÃ³n' : 'Invitado'} (TÃº)
                    </p>
                </div>
                
                <!-- Jugador 2 (Guest/Waiting) -->
                <div style="background: ${!isHost && opponent ? '#f0fdf4' : '#f9fafb'}; border: 2px solid ${!isHost && opponent ? '#22c55e' : '#d1d5db'}; border-radius: 12px; padding: 20px; text-align: center;">
                    <div style="font-size: 1.5rem; margin-bottom: 10px;">
                        ${opponent ? (!isHost ? 'ðŸ‘‘' : 'ðŸ‘¤') : 'â³'}
                    </div>
                    <h3 style="margin: 0 0 5px 0; color: #1f2937;">
                        ${opponent ? opponent.name : 'Esperando...'}
                    </h3>
                    <p style="margin: 0; font-size: 12px; color: #6b7280;">
                        ${opponent ? (!isHost ? 'AnfitriÃ³n' : 'Invitado') : 'Waiting for player'}
                    </p>
                </div>
            </div>
            
            <!-- Estado del juego -->
            <div style="text-align: center; margin-bottom: 30px;">
                ${gameState === 'waiting' ? `
                    <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; padding: 20px;">
                        <h3 style="color: #92400e; margin: 0 0 10px 0;">
                            ${opponent ? 'â³ Esperando que ambos estÃ©n listos' : 'ðŸ‘¥ Esperando oponente'}
                        </h3>
                        <p style="color: #78350f; margin: 0; font-size: 14px;">
                            ${opponent ? 'Presiona "Listo" cuando quieras empezar' : 'Comparte el cÃ³digo de sala con tu oponente'}
                        </p>
                    </div>
                ` : ''}
            </div>
            
            <!-- Botones de acciÃ³n -->
            <div style="display: flex; gap: 15px; justify-content: center;">
                ${opponent && gameState === 'waiting' ? `
                    <button onclick="markAsReady()" class="btn btn-success" style="padding: 15px 25px; font-size: 16px;">
                        âœ… Estoy Listo
                    </button>
                ` : ''}
                
                <button onclick="leaveRoom()" class="btn btn-danger" style="padding: 15px 25px; font-size: 16px;">
                    ðŸšª Salir de la Sala
                </button>
            </div>
        </div>
    `;
}

// FunciÃ³n placeholder para marcar como listo (implementaremos en el siguiente paso)
function markAsReady() {
    showMessage('FunciÃ³n "Listo" serÃ¡ implementada en el siguiente paso', 'success');
}
</script>
<script>
// ========== SISTEMA MULTIJUGADOR MEJORADO - PANTALLA DIVIDIDA ==========

// Actualizar la función renderRoomInterface para incluir el juego
function renderRoomInterface() {
    const roomCode = multiplayerState.roomCode;
    const isHost = multiplayerState.isHost;
    const opponent = multiplayerState.opponent;
    const gameState = multiplayerState.gameState;
    
    // Si el juego está en progreso, mostrar pantalla dividida
    if (gameState === 'playing') {
        return renderGameScreen();
    }
    
    // Interfaz de espera (código existente mejorado)
    return `
        <div style="max-width: 700px; margin: 0 auto; padding: 20px;">
            
            <!-- Header de la sala -->
            <div style="text-align: center; margin-bottom: 30px; background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; padding: 25px; border-radius: 16px;">
                <h2 style="margin: 0 0 10px 0; font-size: 1.8rem;">Sala de Duelo</h2>
                <div style="font-size: 2rem; font-weight: bold; letter-spacing: 3px; margin: 10px 0;">
                    ${roomCode}
                </div>
                <p style="margin: 0; opacity: 0.9; font-size: 14px;">
                    ${opponent ? 'Ambos jugadores conectados' : 'Esperando oponente...'}
                </p>
            </div>
            
            <!-- Información de jugadores -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                
                <!-- Jugador 1 (Host) -->
                <div style="background: ${isHost ? '#f0fdf4' : '#f8fafc'}; border: 2px solid ${isHost ? '#22c55e' : '#e2e8f0'}; border-radius: 12px; padding: 20px; text-align: center;">
                    <div style="font-size: 1.5rem; margin-bottom: 10px;">${isHost ? '👑' : '👤'}</div>
                    <h3 style="margin: 0 0 5px 0; color: #1f2937;">${state.currentUser.name}</h3>
                    <p style="margin: 0; font-size: 12px; color: #6b7280;">
                        ${isHost ? 'Anfitrión' : 'Invitado'} (Tú)
                    </p>
                    <div style="margin-top: 10px; font-size: 12px; color: #10b981;">
                        ✅ ${state.questions.filter(q => q.isVerified).length} preguntas listas
                    </div>
                </div>
                
                <!-- Jugador 2 (Guest/Waiting) -->
                <div style="background: ${!isHost && opponent ? '#f0fdf4' : '#f9fafb'}; border: 2px solid ${!isHost && opponent ? '#22c55e' : '#d1d5db'}; border-radius: 12px; padding: 20px; text-align: center;">
                    <div style="font-size: 1.5rem; margin-bottom: 10px;">
                        ${opponent ? (!isHost ? '👑' : '🎮') : '⏳'}
                    </div>
                    <h3 style="margin: 0 0 5px 0; color: #1f2937;">
                        ${opponent ? opponent.name : 'Esperando...'}
                    </h3>
                    <p style="margin: 0; font-size: 12px; color: #6b7280;">
                        ${opponent ? (!isHost ? 'Anfitrión' : 'Invitado') : 'Jugador pendiente'}
                    </p>
                    ${opponent ? `
                        <div style="margin-top: 10px; font-size: 12px; color: #10b981;">
                            ✅ ${opponent.questions} preguntas listas
                        </div>
                    ` : ''}
                </div>
            </div>
            
            <!-- Botones de acción -->
            <div style="display: flex; gap: 15px; justify-content: center; margin-bottom: 20px;">
                ${opponent && !multiplayerState.myReady ? `
                    <button onclick="markReady()" class="btn btn-success" style="padding: 15px 30px; font-size: 16px;">
                        ✅ Estoy Listo
                    </button>
                ` : opponent && multiplayerState.myReady ? `
                    <div style="background: #dcfce7; color: #166534; padding: 15px 30px; border-radius: 8px; font-weight: 500;">
                        ✅ Esperando al oponente...
                    </div>
                ` : ''}
                
                <button onclick="leaveRoom()" class="btn btn-danger" style="padding: 15px 30px;">
                    🚪 Salir de Sala
                </button>
            </div>
            
            <div style="text-align: center; padding: 15px; background: #f0f9ff; border-radius: 8px; font-size: 14px; color: #1e40af;">
                ${!opponent ? '⏳ Esperando que alguien se una con el código...' : 
                  !multiplayerState.myReady && !multiplayerState.opponentReady ? '🎯 Haz clic en "Estoy Listo" cuando quieras empezar' :
                  multiplayerState.myReady && !multiplayerState.opponentReady ? '⏳ Esperando que tu oponente esté listo...' :
                  !multiplayerState.myReady && multiplayerState.opponentReady ? '⚡ Tu oponente está listo! Haz clic en "Estoy Listo"' :
                  '🚀 ¡Ambos listos! Iniciando juego...'}
            </div>
        </div>
    `;
}

// Nueva función para renderizar la pantalla de juego dividida
function renderGameScreen() {
    const isHost = multiplayerState.isHost;
    const opponent = multiplayerState.opponent;
    const currentQuestion = multiplayerState.currentQuestion;
    const isMyTurn = multiplayerState.myTurn;
    
    // Obtener preguntas del oponente
    const opponentQuestions = isHost ? 
        multiplayerState.guestQuestions || [] : 
        multiplayerState.hostQuestions || [];
    
    return `
        <div class="container">
            <!-- Header del juego -->
            <div class="header">
                <div class="title">⚔️ Duelo en Progreso</div>
                <button onclick="leaveRoom()" class="btn btn-danger">🚪 Salir</button>
            </div>
            
            <!-- Estadísticas -->
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 12px;">
                <div style="text-align: center;">
                    <div style="font-weight: bold; color: ${isHost ? '#10b981' : '#6b7280'};">
                        ${state.currentUser.name} ${isHost ? '👑' : '🎮'}
                    </div>
                    <div style="color: #ef4444;">❌ Fallos: ${multiplayerState.myFailures}/3</div>
                    <div style="color: #3b82f6;">❓ Preguntas: ${multiplayerState.myQuestionsAsked || 0}/10</div>
                </div>
                
                <div style="text-align: center; align-self: center;">
                    <div style="font-size: 18px; font-weight: bold; color: #4f46e5;">
                        Turno: ${isMyTurn ? 'TÚ' : opponent.name.toUpperCase()}
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <div style="font-weight: bold; color: ${!isHost ? '#10b981' : '#6b7280'};">
                        ${opponent.name} ${!isHost ? '👑' : '🎮'}
                    </div>
                    <div style="color: #ef4444;">❌ Fallos: ${multiplayerState.opponentFailures}/3</div>
                    <div style="color: #3b82f6;">❓ Preguntas: ${multiplayerState.opponentQuestionsAsked || 0}/10</div>
                </div>
            </div>
            
            <!-- Pantalla dividida -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 500px;">
                
                <!-- Panel izquierdo: Preguntas del oponente -->
                <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; overflow-y: auto;">
                    <h3 style="color: #374151; margin-bottom: 15px; text-align: center;">
                        📋 Todas las preguntas de ${opponent.name}
                    </h3>
                    
                    <div style="background: ${isMyTurn ? '#fef3c7' : '#f3f4f6'}; border: 1px solid ${isMyTurn ? '#f59e0b' : '#d1d5db'}; border-radius: 8px; padding: 10px; margin-bottom: 15px; text-align: center; font-size: 14px; color: ${isMyTurn ? '#92400e' : '#6b7280'};">
                        ${isMyTurn ? '🎯 Es tu turno - Selecciona una pregunta para tu oponente' : '⏳ Espera tu turno'}
                    </div>
                    
                    ${opponentQuestions.length > 0 ? 
                        opponentQuestions.map((q, index) => `
                            <div class="question-card" style="border: 1px solid #d1d5db; border-radius: 8px; padding: 12px; margin-bottom: 10px; background: ${isMyTurn ? '#f8fafc' : '#f9fafb'}; ${isMyTurn ? 'cursor: pointer;' : 'cursor: not-allowed;'} transition: all 0.2s;" 
                                 ${isMyTurn ? `onclick="selectQuestionForOpponent(${index})" onmouseover="this.style.borderColor='#3b82f6'" onmouseout="this.style.borderColor='#d1d5db'"` : ''}>
                                <div style="font-weight: 500; margin-bottom: 8px; color: #374151;">
                                    ${q.question}
                                </div>
                                <div style="font-size: 12px; color: #6b7280;">
                                    Tema: ${q.topicId ? state.topics.find(t => t.id.toString() === q.topicId.toString())?.name || 'Sin tema' : 'Sin tema'}
                                </div>
                            </div>
                        `).join('') : 
                        '<div style="text-align: center; padding: 40px; color: #6b7280;">⏳ Cargando preguntas del oponente...</div>'
                    }
                </div>
                
                <!-- Panel derecho: Pregunta actual -->
                <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px;">
                    <h3 style="color: #374151; margin-bottom: 20px; text-align: center;">
                        ${currentQuestion ? '❓ Pregunta Actual' : '⏳ Esperando pregunta...'}
                    </h3>
                    
                    ${renderCurrentQuestion()}
                </div>
            </div>
        </div>
    `;
}

// Función para renderizar la pregunta actual
function renderCurrentQuestion() {
    const currentQuestion = multiplayerState.currentQuestion;
    const isMyTurnToAnswer = !multiplayerState.myTurn; // Si no es mi turno para preguntar, es mi turno para responder
    
    if (!currentQuestion) {
        return `
            <div style="text-align: center; padding: 60px 20px; color: #6b7280;">
                <div style="font-size: 48px; margin-bottom: 15px;">🤔</div>
                <div style="font-size: 18px; margin-bottom: 10px;">Esperando que se seleccione una pregunta...</div>
                <div style="font-size: 14px;">El jugador activo debe elegir una pregunta del panel izquierdo</div>
            </div>
        `;
    }
    
    return `
        <div style="margin-bottom: 20px;">
            <div style="background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                <div style="font-weight: 600; font-size: 16px; color: #1e40af; margin-bottom: 10px;">
                    ${currentQuestion.question}
                </div>
                <div style="font-size: 12px; color: #6b7280;">
                    Tema: ${currentQuestion.topicId ? state.topics.find(t => t.id.toString() === currentQuestion.topicId.toString())?.name || 'Sin tema' : 'Sin tema'}
                </div>
            </div>
            
            ${isMyTurnToAnswer ? `
                <div style="margin-bottom: 15px; padding: 10px; background: #dcfce7; border: 1px solid #16a34a; border-radius: 8px; text-align: center; color: #15803d; font-weight: 500;">
                    🎯 Tu turno - Selecciona tu respuesta
                </div>
                
                <div style="display: grid; gap: 10px;">
                    ${currentQuestion.options.map((option, index) => `
                        <button onclick="submitAnswer(${index})" class="btn" style="background: #f8fafc; border: 2px solid #e2e8f0; color: #374151; padding: 12px; text-align: left; border-radius: 8px; transition: all 0.2s;" 
                                onmouseover="this.style.borderColor='#3b82f6'; this.style.backgroundColor='#dbeafe'" 
                                onmouseout="this.style.borderColor='#e2e8f0'; this.style.backgroundColor='#f8fafc'">
                            ${String.fromCharCode(65 + index)}. ${option}
                        </button>
                    `).join('')}
                </div>
            ` : `
                <div style="padding: 20px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; text-align: center; color: #92400e;">
                    ⏳ Esperando respuesta del oponente...
                </div>
                
                <div style="display: grid; gap: 10px; margin-top: 15px; opacity: 0.6;">
                    ${currentQuestion.options.map((option, index) => `
                        <div style="background: #f9fafb; border: 1px solid #e5e7eb; color: #6b7280; padding: 12px; text-align: left; border-radius: 8px;">
                            ${String.fromCharCode(65 + index)}. ${option}
                        </div>
                    `).join('')}
                </div>
            `}
        </div>
    `;
}

// Función para marcar como listo
function markReady() {
    if (!multiplayerState.currentRoom || !database) return;
    
    const playerPath = multiplayerState.isHost ? 'host' : 'guest';
    const verifiedQuestions = state.questions.filter(q => q.isVerified);
    
    // Marcar como listo y añadir preguntas
    const updates = {};
    updates[`/rooms/${multiplayerState.currentRoom}/${playerPath}/ready`] = true;
    updates[`/rooms/${multiplayerState.currentRoom}/${playerPath}/userQuestions`] = verifiedQuestions;
    
    database.ref().update(updates)
        .then(() => {
            multiplayerState.myReady = true;
            showMessage('Marcado como listo', 'success');
            
            // Verificar si ambos están listos
            checkIfBothReady();
        })
        .catch(error => {
            console.error('Error marcando como listo:', error);
            showMessage('Error al marcar como listo', 'error');
        });
}

// Verificar si ambos jugadores están listos
function checkIfBothReady() {
    if (!database || !multiplayerState.currentRoom) return;
    
    database.ref(`rooms/${multiplayerState.currentRoom}`).once('value')
        .then(snapshot => {
            const roomData = snapshot.val();
            
            if (roomData.host.ready && roomData.guest && roomData.guest.ready) {
                // Ambos listos - iniciar juego
                if (multiplayerState.isHost) {
                    startGame(roomData);
                }
            }
        });
}

// Iniciar el juego (solo el host)
function startGame(roomData) {
    const gameData = {
        status: 'playing',
        currentTurn: 'host', // El host empieza
        currentQuestion: null,
        hostFailures: 0,
        guestFailures: 0,
        hostQuestionsAsked: 0,
        guestQuestionsAsked: 0,
        hostQuestions: roomData.host.userQuestions,
        guestQuestions: roomData.guest.userQuestions
    };
    
    database.ref(`rooms/${multiplayerState.currentRoom}`).update(gameData)
        .then(() => {
            showMessage('¡Juego iniciado! Es tu turno para elegir pregunta', 'success');
        });
}

// Seleccionar pregunta para el oponente
function selectQuestionForOpponent(questionIndex) {
    if (!multiplayerState.myTurn || !database) return;
    
    database.ref(`rooms/${multiplayerState.currentRoom}`).once('value')
        .then(snapshot => {
            const roomData = snapshot.val();
            const opponentQuestions = multiplayerState.isHost ? 
                roomData.guestQuestions : roomData.hostQuestions;
            
            const selectedQuestion = opponentQuestions[questionIndex];
            
            database.ref(`rooms/${multiplayerState.currentRoom}/currentQuestion`).set(selectedQuestion)
                .then(() => {
                    showMessage('Pregunta seleccionada para tu oponente', 'success');
                });
        });
}

// Enviar respuesta
function submitAnswer(selectedIndex) {
    if (!database || multiplayerState.myTurn) return; // Solo responder si no es mi turno para preguntar
    
    database.ref(`rooms/${multiplayerState.currentRoom}`).once('value')
        .then(snapshot => {
            const roomData = snapshot.val();
            const question = roomData.currentQuestion;
            const isCorrect = selectedIndex === question.correctAnswer;
            
            const myPath = multiplayerState.isHost ? 'host' : 'guest';
            const opponentPath = multiplayerState.isHost ? 'guest' : 'host';
            
            const updates = {};
            
            if (!isCorrect) {
                // Incrementar mis fallos si respondo mal
                updates[`/rooms/${multiplayerState.currentRoom}/${myPath}Failures`] = (roomData[myPath + 'Failures'] || 0) + 1;
                showMessage('❌ Respuesta incorrecta', 'error');
            } else {
                showMessage('✅ ¡Respuesta correcta!', 'success');
            }
            
            // Incrementar preguntas hechas por el oponente
            updates[`/rooms/${multiplayerState.currentRoom}/${opponentPath}QuestionsAsked`] = (roomData[opponentPath + 'QuestionsAsked'] || 0) + 1;
            
            // Limpiar pregunta actual y cambiar turno
            updates[`/rooms/${multiplayerState.currentRoom}/currentQuestion`] = null;
            updates[`/rooms/${multiplayerState.currentRoom}/currentTurn`] = myPath;
            
            database.ref().update(updates)
                .then(() => {
                    // Verificar condiciones de fin de juego después de un delay
                    setTimeout(() => checkGameEnd(), 1500);
                });
        });
}

// Verificar fin de juego
function checkGameEnd() {
    if (!database) return;
    
    database.ref(`rooms/${multiplayerState.currentRoom}`).once('value')
        .then(snapshot => {
            const roomData = snapshot.val();
            
            // Verificar 3 fallos
            if (roomData.hostFailures >= 3) {
                endGame(roomData.guest.name, 'El anfitrión alcanzó 3 fallos');
                return;
            }
            if (roomData.guestFailures >= 3) {
                endGame(roomData.host.name, 'El invitado alcanzó 3 fallos');
                return;
            }
            
            // Verificar 10 preguntas cada uno
            if ((roomData.hostQuestionsAsked || 0) >= 10 && (roomData.guestQuestionsAsked || 0) >= 10) {
                const hostFailures = roomData.hostFailures || 0;
                const guestFailures = roomData.guestFailures || 0;
                
                if (hostFailures < guestFailures) {
                    endGame(roomData.host.name, 'Menor número de fallos');
                } else if (guestFailures < hostFailures) {
                    endGame(roomData.guest.name, 'Menor número de fallos');
                } else {
                    endGame('Empate', 'Ambos tienen los mismos fallos');
                }
            }
        });
}

// Terminar juego
function endGame(winner, reason) {
    const updates = {
        [`/rooms/${multiplayerState.currentRoom}/status`]: 'finished',
        [`/rooms/${multiplayerState.currentRoom}/winner`]: { name: winner, reason: reason }
    };
    
    database.ref().update(updates)
        .then(() => {
            showMessage(`🏆 Juego terminado! Ganador: ${winner} (${reason})`, 
                winner === 'Empate' ? 'warning' : 'success');
            
            setTimeout(() => {
                leaveRoom();
            }, 5000);
        });
}

// Actualizar el listener para manejar datos del juego
function updateLocalStateFromRoom(roomData) {
    multiplayerState.gameState = roomData.status;
    multiplayerState.myReady = multiplayerState.isHost ? roomData.host.ready : roomData.guest.ready;
    multiplayerState.opponentReady = multiplayerState.isHost ? 
        (roomData.guest ? roomData.guest.ready : false) : roomData.host.ready;
    
    if (multiplayerState.isHost) {
        multiplayerState.opponent = roomData.guest;
    } else {
        multiplayerState.opponent = roomData.host;
    }
    
    // Datos del juego
    if (roomData.status === 'playing') {
        multiplayerState.myTurn = (roomData.currentTurn === 'host') === multiplayerState.isHost;
        multiplayerState.currentQuestion = roomData.currentQuestion;
        multiplayerState.myFailures = multiplayerState.isHost ? 
            (roomData.hostFailures || 0) : (roomData.guestFailures || 0);
        multiplayerState.opponentFailures = multiplayerState.isHost ? 
            (roomData.guestFailures || 0) : (roomData.hostFailures || 0);
        multiplayerState.myQuestionsAsked = multiplayerState.isHost ? 
            (roomData.hostQuestionsAsked || 0) : (roomData.guestQuestionsAsked || 0);
        multiplayerState.opponentQuestionsAsked = multiplayerState.isHost ? 
            (roomData.guestQuestionsAsked || 0) : (roomData.hostQuestionsAsked || 0);
        multiplayerState.hostQuestions = roomData.hostQuestions;
        multiplayerState.guestQuestions = roomData.guestQuestions;
    }
}

console.log('✅ Sistema multijugador con pantalla dividida implementado');
</script>    
</body>
</html>

