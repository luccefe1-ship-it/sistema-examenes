<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Exámenes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .title {
            font-size: 2rem;
            font-weight: bold;
            color: #2d3748;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            margin: 5px;
        }

        .btn-primary { background: #4f46e5; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-info { background: #0ea5e9; color: white; }

        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

        .nav-tabs {
            display: flex;
            margin-bottom: 30px;
            background: #f8fafc;
            border-radius: 12px;
            padding: 5px;
        }

        .nav-tab {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: white;
            color: #4f46e5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            font-weight: 500;
            margin-bottom: 5px;
            color: #374151;
            display: block;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .success { 
            background: #d1fae5; 
            color: #065f46; 
            border-color: #10b981; 
        }

        .error { 
            background: #fee2e2; 
            color: #991b1b; 
            border-color: #ef4444; 
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .column {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e2e8f0;
        }

        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
        }

        .custom-checkbox {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .custom-checkbox:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .custom-checkbox.selected {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .custom-checkbox input[type="checkbox"] {
            transform: scale(1.3);
            accent-color: #3b82f6;
        }

        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Estado global de la aplicación
        const appState = {
            currentUser: null,
            currentMode: null,
            currentTab: 'upload',
            apiKey: localStorage.getItem('anthropic_api_key') || '',
            questions: JSON.parse(localStorage.getItem('questions') || '[]'),
            topics: JSON.parse(localStorage.getItem('topics') || '[]'),
            selectedImages: [],
            transcribedText: '',
            cleanedText: '',
            selectedTopicForNewQuestions: null,
            selectedTopicFilter: 'all',
            currentTest: null,
            testResults: JSON.parse(localStorage.getItem('testResults') || '[]'),
            currentViewingResult: null
        };

        const users = {
            'demo': { password: 'demo123', name: 'Usuario Demo' }
        };

        // Funciones de renderizado principales
        function render() {
            const app = document.getElementById('app');
            
            if (!appState.currentUser) {
                renderLogin(app);
            } else if (!appState.currentMode) {
                renderModeSelection(app);
            } else {
                renderMainApp(app);
            }
        }

        function renderLogin(app) {
            app.innerHTML = `
                <div class="container">
                    <div class="login-form">
                        <h2 style="text-align: center; margin-bottom: 30px;">Iniciar Sesión</h2>
                        <div class="form-group">
                            <label class="form-label">Usuario</label>
                            <input type="text" id="username" class="form-input" placeholder="demo">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contraseña</label>
                            <input type="password" id="password" class="form-input" placeholder="demo123">
                        </div>
                        <button onclick="handleLogin()" class="btn btn-primary" style="width: 100%;">
                            Iniciar Sesión
                        </button>
                        <div style="text-align: center; margin-top: 15px; color: #6b7280; font-size: 14px;">
                            Usuario: demo | Contraseña: demo123
                        </div>
                    </div>
                </div>
            `;
        }

        function renderModeSelection(app) {
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <div class="title">Selecciona el Modo de Trabajo</div>
                        <div>
                            <span style="color: #f59e0b;">👤 ${appState.currentUser.name}</span>
                            <button onclick="handleLogout()" class="btn btn-danger">Salir</button>
                        </div>
                    </div>

                    <div style="max-width: 800px; margin: 0 auto; padding: 60px 20px;">
                        <div style="text-align: center; margin-bottom: 50px;">
                            <h2 style="color: #1f2937; font-size: 2.5rem; margin-bottom: 15px;">¿Qué quieres hacer hoy?</h2>
                            <p style="color: #6b7280; font-size: 1.2rem; line-height: 1.6;">
                                Elige entre realizar tests para evaluar tus conocimientos o consultar resúmenes para estudiar
                            </p>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-top: 40px;">
                            <div onclick="selectMode('test')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; padding: 40px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3); color: white; text-align: center; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-10px)'; this.style.boxShadow='0 20px 40px rgba(102, 126, 234, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 10px 30px rgba(102, 126, 234, 0.3)';">
                                <div style="position: absolute; top: -20px; right: -20px; font-size: 8rem; opacity: 0.1;">🎯</div>
                                <div style="position: relative; z-index: 2;">
                                    <div style="font-size: 4rem; margin-bottom: 20px;">🎯</div>
                                    <h3 style="font-size: 1.8rem; margin-bottom: 15px; font-weight: bold;">Realizar Test</h3>
                                    <p style="opacity: 0.9; line-height: 1.5; margin-bottom: 25px;">
                                        Sube imágenes de exámenes, crea bancos de preguntas y realiza tests personalizados
                                    </p>
                                    <div style="background: rgba(255, 255, 255, 0.2); padding: 12px 25px; border-radius: 25px; display: inline-block; font-weight: 500;">
                                        Comenzar →
                                    </div>
                                </div>
                            </div>

                            <div onclick="selectMode('summaries')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 20px; padding: 40px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 10px 30px rgba(240, 147, 251, 0.3); color: white; text-align: center; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-10px)'; this.style.boxShadow='0 20px 40px rgba(240, 147, 251, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 10px 30px rgba(240, 147, 251, 0.3)';">
                                <div style="position: absolute; top: -20px; right: -20px; font-size: 8rem; opacity: 0.1;">📚</div>
                                <div style="position: relative; z-index: 2;">
                                    <div style="font-size: 4rem; margin-bottom: 20px;">📚</div>
                                    <h3 style="font-size: 1.8rem; margin-bottom: 15px; font-weight: bold;">Ver Resúmenes</h3>
                                    <p style="opacity: 0.9; line-height: 1.5; margin-bottom: 25px;">
                                        Consulta resúmenes organizados por tema y accede a material de repaso
                                    </p>
                                    <div style="background: rgba(255, 255, 255, 0.2); padding: 12px 25px; border-radius: 25px; display: inline-block; font-weight: 500;">
                                        Explorar →
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 50px; padding: 25px; background: #f8fafc; border-radius: 12px; border: 2px solid #e2e8f0;">
                            <div style="color: #4f46e5; font-size: 1.5rem; margin-bottom: 10px;">💡</div>
                            <p style="color: #6b7280; margin: 0;">
                                <strong>Consejo:</strong> Puedes cambiar de modo usando el botón "← Modo" en la barra superior
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMainApp(app) {
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <div class="title">${getPageTitle()}</div>
                        <div>
                            <span style="color: ${appState.apiKey ? '#10b981' : '#ef4444'};">
                                ${appState.apiKey ? '✅ API Configurada' : '❌ Sin API'}
                            </span>
                            <button onclick="configureAPI()" class="btn btn-secondary">API</button>
                            <button onclick="goBackToModeSelection()" class="btn btn-info">← Modo</button>
                            <span style="color: #f59e0b;">👤 ${appState.currentUser.name}</span>
                            <button onclick="handleLogout()" class="btn btn-danger">Salir</button>
                        </div>
                    </div>

                    <div class="nav-tabs">
                        <button class="nav-tab ${appState.currentTab === 'upload' ? 'active' : ''}" onclick="setTab('upload')">
                            📤 Subir Test
                        </button>
                        <button class="nav-tab ${appState.currentTab === 'questions' ? 'active' : ''}" onclick="setTab('questions')">
                            📋 Banco (${getFilteredQuestions().length})
                        </button>
                        <button class="nav-tab ${appState.currentTab === 'test' ? 'active' : ''}" onclick="setTab('test')">
                            🎯 Test
                        </button>
                        <button class="nav-tab ${appState.currentTab === 'results' ? 'active' : ''}" onclick="setTab('results')">
                            📊 Resultados (${appState.testResults.length})
                        </button>
                    </div>

                    <div id="messages"></div>
                    ${renderTabContent()}
                </div>
            `;
        }

        function renderTabContent() {
            switch(appState.currentTab) {
                case 'upload': return renderUploadTab();
                case 'questions': return renderQuestionsTab();
                case 'test': return renderTestTab();
                case 'results': return renderResultsTab();
                default: return '<div>Pestaña no encontrada</div>';
            }
        }

        function renderUploadTab() {
            return `
                <div class="two-column">
                    <div class="column">
                        <h3 style="margin-bottom: 15px;">📤 Subir Imágenes</h3>
                        <div class="upload-area" onclick="document.getElementById('imageInput').click()">
                            <div>📁 Seleccionar imágenes</div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Hasta 10 imágenes</div>
                            <div style="margin-top: 10px; color: #4f46e5; font-weight: 500;">
                                ${appState.selectedImages.length}/10 archivos
                            </div>
                        </div>
                        <input type="file" id="imageInput" style="display: none;" accept="image/*" multiple>
                        
                        ${renderSelectedImages()}
                        
                        <button onclick="transcribeImages()" class="btn btn-primary" style="width: 100%;" ${appState.selectedImages.length === 0 || !appState.apiKey ? 'disabled' : ''}>
                            🤖 1. Transcribir
                        </button>
                    </div>

                    <div class="column">
                        <h3 style="margin-bottom: 15px;">📝 Texto Procesado</h3>
                        <textarea class="textarea" placeholder="El texto procesado aparecerá aquí..." readonly>${appState.cleanedText}</textarea>
                        
                        <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px;">
                            <h4 style="color: #92400e; margin-bottom: 10px;">🏷️ Gestión de Temas</h4>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <button onclick="createTopic()" class="btn btn-info" style="width: 100%; padding: 8px; font-size: 13px;">
                                    🆕 Crear Tema
                                </button>
                                
                                <select id="topic-selector" onchange="updateSelectedTopic()" style="width: 100%; padding: 8px; border: none; background: #f59e0b; color: white; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer;" ${appState.topics.length === 0 ? 'disabled' : ''}>
                                    <option value="">🏷️ Seleccionar Tema</option>
                                    ${appState.topics.map(topic => `
                                        <option value="${topic.id}" ${appState.selectedTopicForNewQuestions === topic.id ? 'selected' : ''}>
                                            ${topic.name} (${getTopicQuestionCount(topic.id)})
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <button onclick="addToQuestions()" class="btn btn-success" style="width: 100%; margin-top: 10px;" ${!appState.cleanedText ? 'disabled' : ''}>
                            ${getAddButtonText()}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderSelectedImages() {
            if (appState.selectedImages.length === 0) return '';
            
            return `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                    ${appState.selectedImages.map((file, i) => `
                        <div style="position: relative; text-align: center; padding: 10px; background: #f3f4f6; border-radius: 8px;">
                            <button onclick="removeImage(${i})" style="position: absolute; top: 5px; right: 5px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer;">×</button>
                            <div style="font-size: 10px; word-break: break-all;">${file.name}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderQuestionsTab() {
            const filteredQuestions = getFilteredQuestions();
            
            return `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>BANCO DE PREGUNTAS (${filteredQuestions.length})</h2>
                    <button onclick="clearQuestions()" class="btn btn-danger">Limpiar Todo</button>
                </div>

                ${appState.topics.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <label style="margin-right: 10px; font-weight: 500;">Filtrar por tema:</label>
                        <select onchange="filterByTopic(this.value)" style="padding: 8px; border-radius: 6px; border: 1px solid #d1d5db;">
                            <option value="all" ${appState.selectedTopicFilter === 'all' ? 'selected' : ''}>Todos los temas (${appState.questions.length})</option>
                            ${appState.topics.map(topic => `
                                <option value="${topic.id}" ${appState.selectedTopicFilter == topic.id ? 'selected' : ''}>
                                    ${topic.name} (${getTopicQuestionCount(topic.id)})
                                </option>
                            `).join('')}
                        </select>
                    </div>
                ` : ''}

                <div style="border: 1px solid #e5e7eb; border-radius: 8px; background: white;">
                    ${filteredQuestions.length === 0 ? 
                        '<div style="padding: 40px; text-align: center; color: #9ca3af;">No hay preguntas disponibles</div>' :
                        filteredQuestions.map(q => renderSingleQuestion(q)).join('')
                    }
                </div>
            `;
        }

        function renderSingleQuestion(question) {
            const actualIndex = appState.questions.findIndex(q => q.id === question.id);
            const topicName = question.topicId ? getTopicName(question.topicId) : null;
            
            return `
                <div style="padding: 15px; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between;">
                    <div style="flex: 1;">
                        <div style="font-weight: 500; margin-bottom: 8px;">
                            ${question.question}
                            ${topicName ? `<span style="background: #e0e7ff; color: #4f46e5; padding: 2px 6px; border-radius: 8px; font-size: 11px; margin-left: 8px;">${topicName}</span>` : ''}
                        </div>
                        <ul style="list-style: none; margin: 0; padding: 0;">
                            ${question.options.map((opt, optIndex) => `
                                <li style="padding: 2px 0; color: ${question.correctAnswer === optIndex ? '#059669' : '#6b7280'}; ${question.correctAnswer === optIndex ? 'font-weight: 500;' : ''}">
                                    ${String.fromCharCode(97 + optIndex)}) ${opt}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    <div style="display: flex; gap: 5px; align-items: flex-start;">
                        <button onclick="editQuestion(${actualIndex})" class="btn btn-warning" style="padding: 5px 10px; font-size: 12px;">Editar</button>
                        <button onclick="deleteQuestion(${actualIndex})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">Eliminar</button>
                    </div>
                </div>
            `;
        }

        function renderTestTab() {
            if (appState.questions.length === 0) {
                return '<div style="text-align: center; padding: 40px;">Añade preguntas al banco para generar tests</div>';
            }

            if (!appState.currentTest) {
                return `
                    <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="color: #0c4a6e; margin-bottom: 15px;">🎯 Configuración del Test</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Número de preguntas:</label>
                                <select id="test-questions-count" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <option value="5">5 preguntas</option>
                                    <option value="10" selected>10 preguntas</option>
                                    <option value="15">15 preguntas</option>
                                    <option value="20">20 preguntas</option>
                                    <option value="all">Todas las preguntas disponibles</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Duración:</label>
                                <select id="test-duration" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <option value="300">5 minutos</option>
                                    <option value="600" selected>10 minutos</option>
                                    <option value="900">15 minutos</option>
                                    <option value="1200">20 minutos</option>
                                    <option value="1800">30 minutos</option>
                                    <option value="0">Sin límite de tiempo</option>
                                </select>
                            </div>
                        </div>

                        ${appState.topics.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 15px; font-weight: 500;">Selección de temas:</label>
                                <div style="display: grid; gap: 8px;">
                                    <div class="custom-checkbox" onclick="toggleGeneralTest()">
                                        <input type="checkbox" id="test-general" onchange="handleGeneralTestChange(this)" checked>
                                        <span style="font-weight: 500;">Test General (${appState.questions.length} preguntas)</span>
                                    </div>
                                    ${appState.topics.map(topic => `
                                        <div class="custom-checkbox" onclick="toggleTopicTest('${topic.id}')">
                                            <input type="checkbox" class="topic-checkbox" data-topic-id="${topic.id}" onchange="handleTopicChange()">
                                            <span>${topic.name} (${getTopicQuestionCount(topic.id)} preguntas)</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Nombre del test:</label>
                            <input type="text" id="test-name" placeholder="Ej: Test de Matemáticas - Sesión 1" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                        </div>
                    </div>

                    <div style="text-align: center; padding: 40px;">
                        <button onclick="startTest()" class="btn btn-primary" style="font-size: 1.2rem; padding: 15px 30px;">
                            🎯 Comenzar Test
                        </button>
                    </div>
                `;
            }

            return renderCurrentTest();
        }

        function renderCurrentTest() {
            return `
                <div style="max-width: 1000px; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 20px; background: #f8fafc; border-radius: 12px;">
                        <div>
                            <h2 style="margin: 0; color: #1f2937;">${appState.currentTest.name}</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280; font-size: 14px;">${appState.currentTest.questions.length} preguntas</p>
                        </div>
                    </div>
                    
                    <form id="test-form">
                        ${appState.currentTest.questions.map((question, questionIndex) => `
                            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 25px; margin-bottom: 25px;">
                                <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; color: #1f2937;">
                                    <span style="color: #4f46e5;">#${questionIndex + 1}</span> ${question.question}
                                </div>
                                
                                <div style="display: grid; gap: 12px;">
                                    ${question.options.map((option, optionIndex) => `
                                        <label style="display: flex; align-items: center; gap: 12px; padding: 15px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer;">
                                            <input type="radio" name="question-${questionIndex}" value="${optionIndex}">
                                            <span><strong>${String.fromCharCode(97 + optionIndex)})</strong> ${option}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </form>
                    
                    <div style="text-align: center; padding: 30px;">
                        <button onclick="finishTest()" class="btn btn-primary" style="font-size: 1.2rem; padding: 15px 40px;">
                            🏁 Finalizar Test
                        </button>
                    </div>
                </div>
            `;
        }

        function renderResultsTab() {
            if (appState.testResults.length === 0) {
                return `
                    <div style="text-align: center; padding: 60px; color: #9ca3af;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">📊</div>
                        <h3 style="color: #6b7280; margin-bottom: 10px;">No hay resultados disponibles</h3>
                        <p style="color: #9ca3af;">Realiza tu primer test para ver los resultados aquí</p>
                    </div>
                `;
            }

            return `
                <div style="max-width: 1000px; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="color: #1f2937; margin: 0;">📊 Historial de Tests (${appState.testResults.length})</h2>
                        <button onclick="clearTestHistory()" class="btn btn-danger">🗑️ Limpiar Historial</button>
                    </div>

                    <div style="display: grid; gap: 20px;">
                        ${appState.testResults.map((result, index) => {
                            const percentage = Math.round((result.correct / result.total) * 100);
                            let scoreColor = percentage >= 70 ? '#059669' : percentage >= 50 ? '#f59e0b' : '#ef4444';
                            
                            return `
                                <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h3 style="margin: 0; color: #1f2937;">${result.name}</h3>
                                        <div style="background: ${scoreColor}; color: white; padding: 6px 12px; border-radius: 20px; font-weight: bold;">
                                            ${percentage}%
                                        </div>
                                    </div>

                                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                                        <div style="text-align: center;">
                                            <div style="font-size: 1.5rem; font-weight: bold; color: #059669;">${result.correct}</div>
                                            <div style="font-size: 12px; color: #6b7280;">Correctas</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 1.5rem; font-weight: bold; color: #ef4444;">${result.incorrect}</div>
                                            <div style="font-size: 12px; color: #6b7280;">Incorrectas</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 1.5rem; font-weight: bold; color: #f59e0b;">${result.unanswered}</div>
                                            <div style="font-size: 12px; color: #6b7280;">Sin responder</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 1.5rem; font-weight: bold; color: #6b7280;">${result.total}</div>
                                            <div style="font-size: 12px; color: #6b7280;">Total</div>
                                        </div>
                                    </div>

                                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: #6b7280; margin-top: 15px;">
                                        <span>${result.date}</span>
                                        <button onclick="deleteIndividualTest(${index})" class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;">Eliminar</button>
                                    </div>
                                </div>
                            `;
                        }).reverse().join('')}
                    </div>
                </div>
            `;
        }

        // Funciones de manejo de eventos
        function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (users[username] && users[username].password === password) {
                appState.currentUser = users[username];
                appState.currentMode = null;
                render();
                showMessage('Bienvenido ' + users[username].name, 'success');
            } else {
                showMessage('Usuario o contraseña incorrectos', 'error');
            }
        }

        function handleLogout() {
            appState.currentUser = null;
            appState.currentMode = null;
            appState.currentTab = 'upload';
            render();
        }

        function selectMode(mode) {
            appState.currentMode = mode;
            if (mode === 'test') {
                appState.currentTab = 'upload';
            } else if (mode === 'summaries') {
                showMessage('Funcionalidad de resúmenes en desarrollo...', 'success');
                return;
            }
            render();
        }

        function goBackToModeSelection() {
            appState.currentMode = null;
            appState.currentTab = 'upload';
            render();
        }

        function setTab(tab) {
            appState.currentTab = tab;
            render();
        }

        function configureAPI() {
            const key = prompt('Ingresa tu API key de Anthropic:');
            if (key && key.trim()) {
                appState.apiKey = key.trim();
                localStorage.setItem('anthropic_api_key', key.trim());
                render();
                showMessage('API key configurada correctamente', 'success');
            }
        }

        function createTopic() {
            const name = prompt('Nombre del nuevo tema:');
            if (name && name.trim()) {
                const newTopic = {
                    id: Date.now() + Math.random(),
                    name: name.trim(),
                    createdAt: new Date().toISOString()
                };
                
                appState.topics.push(newTopic);
                localStorage.setItem('topics', JSON.stringify(appState.topics));
                render();
                showMessage('Tema "' + name + '" creado exitosamente', 'success');
            }
        }

        function updateSelectedTopic() {
            const selector = document.getElementById('topic-selector');
            if (selector && selector.value) {
                const selectedTopic = appState.topics.find(t => t.id == selector.value);
                if (selectedTopic) {
                    appState.selectedTopicForNewQuestions = selectedTopic.id;
                    showMessage('Tema "' + selectedTopic.name + '" seleccionado', 'success');
                }
            } else {
                appState.selectedTopicForNewQuestions = null;
            }
            render();
        }

        function removeImage(index) {
            appState.selectedImages.splice(index, 1);
            render();
        }

        async function transcribeImages() {
            if (!appState.apiKey) {
                showMessage('Configura tu API key primero', 'error');
                return;
            }

            if (appState.selectedImages.length === 0) {
                showMessage('Selecciona al menos una imagen', 'error');
                return;
            }

            showMessage('Transcribiendo imágenes...', 'success');
            
            try {
                let allTranscriptions = [];
                
                for (let i = 0; i < appState.selectedImages.length; i++) {
                    const file = appState.selectedImages[i];
                    const base64 = await fileToBase64(file);
                    
                    const response = await fetch("/api/anthropic", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "x-api-key": appState.apiKey,
                        },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 4000,
                            messages: [{
                                role: "user",
                                content: [
                                    {
                                        type: "image",
                                        source: {
                                            type: "base64",
                                            media_type: file.type,
                                            data: base64
                                        }
                                    },
                                    {
                                        type: "text",
                                        text: `Extrae todas las preguntas y respuestas de esta imagen. Para cada pregunta, identifica la respuesta correcta si está marcada visualmente. Formato:

PREGUNTA: [texto de la pregunta]
OPCION_A: [primera opción]
OPCION_B: **[segunda opción si es correcta]**
OPCION_C: [tercera opción]
OPCION_D: **[cuarta opción si es correcta]**

Usa **texto** para marcar las respuestas correctas.`
                                    }
                                ]
                            }]
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Error ' + response.status + ': ' + response.statusText);
                    }

                    const data = await response.json();
                    allTranscriptions.push(data.content[0].text);
                }

                appState.cleanedText = allTranscriptions.join('\n\n--- SIGUIENTE IMAGEN ---\n\n');
                render();
                showMessage('Transcripción completada', 'success');
                
            } catch (error) {
                showMessage('Error en la transcripción: ' + error.message, 'error');
            }
        }

        function addToQuestions() {
            if (!appState.cleanedText) {
                showMessage('Primero transcribe las imágenes', 'error');
                return;
            }

            try {
                const newQuestions = parseCleanedText(appState.cleanedText);
                if (newQuestions.length === 0) {
                    showMessage('No se pudieron extraer preguntas del texto', 'error');
                    return;
                }

                if (appState.selectedTopicForNewQuestions) {
                    newQuestions.forEach(question => {
                        question.topicId = appState.selectedTopicForNewQuestions;
                    });
                }

                appState.questions.push(...newQuestions);
                localStorage.setItem('questions', JSON.stringify(appState.questions));
                
                appState.selectedImages = [];
                appState.transcribedText = '';
                appState.cleanedText = '';
                appState.selectedTopicForNewQuestions = null;
                
                render();
                showMessage('Se añadieron ' + newQuestions.length + ' preguntas al banco', 'success');
                
            } catch (error) {
                showMessage('Error al procesar preguntas: ' + error.message, 'error');
            }
        }

        function parseCleanedText(text) {
            const questions = [];
            const sections = text.split(/PREGUNTA:/i).filter(section => section.trim());
            
            sections.forEach(section => {
                const lines = section.trim().split('\n').filter(line => line.trim());
                if (lines.length === 0) return;
                
                const questionText = lines[0].trim();
                const options = [];
                let correctAnswer = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line.match(/^OPCION_[A-D]:/i)) {
                        let optionText = line.replace(/^OPCION_[A-D]:/i, '').trim();
                        
                        if (optionText.startsWith('**') && optionText.endsWith('**')) {
                            optionText = optionText.slice(2, -2);
                            correctAnswer = options.length;
                        }
                        
                        if (optionText) {
                            options.push(optionText);
                        }
                    }
                }
                
                if (questionText && options.length >= 2) {
                    questions.push({
                        id: Date.now() + Math.random(),
                        question: questionText,
                        options: options,
                        correctAnswer: correctAnswer,
                        topicId: null
                    });
                }
            });
            
            return questions;
        }

        function clearQuestions() {
            if (confirm('¿Eliminar todas las preguntas?')) {
                appState.questions = [];
                localStorage.setItem('questions', JSON.stringify(appState.questions));
                render();
            }
        }

        function deleteQuestion(index) {
            if (confirm('¿Eliminar esta pregunta?')) {
                appState.questions.splice(index, 1);
                localStorage.setItem('questions', JSON.stringify(appState.questions));
                render();
            }
        }

        function editQuestion(index) {
            const question = appState.questions[index];
            const newQuestion = prompt('Nueva pregunta:', question.question);
            if (newQuestion && newQuestion.trim()) {
                appState.questions[index].question = newQuestion.trim();
                localStorage.setItem('questions', JSON.stringify(appState.questions));
                render();
                showMessage('Pregunta actualizada', 'success');
            }
        }

        function filterByTopic(topicId) {
            appState.selectedTopicFilter = topicId;
            render();
        }

        function toggleGeneralTest() {
            const generalCheckbox = document.getElementById('test-general');
            const topicCheckboxes = document.querySelectorAll('.topic-checkbox');
            
            if (generalCheckbox.checked) {
                topicCheckboxes.forEach(cb => {
                    cb.checked = false;
                    cb.closest('.custom-checkbox').classList.remove('selected');
                });
                generalCheckbox.closest('.custom-checkbox').classList.add('selected');
            } else {
                generalCheckbox.closest('.custom-checkbox').classList.remove('selected');
            }
        }

        function toggleTopicTest(topicId) {
            const topicCheckbox = document.querySelector('.topic-checkbox[data-topic-id="' + topicId + '"]');
            const generalCheckbox = document.getElementById('test-general');
            
            if (topicCheckbox.checked) {
                topicCheckbox.checked = false;
                topicCheckbox.closest('.custom-checkbox').classList.remove('selected');
            } else {
                topicCheckbox.checked = true;
                topicCheckbox.closest('.custom-checkbox').classList.add('selected');
                if (generalCheckbox.checked) {
                    generalCheckbox.checked = false;
                    generalCheckbox.closest('.custom-checkbox').classList.remove('selected');
                }
            }
        }

        function handleGeneralTestChange(checkbox) {
            const topicCheckboxes = document.querySelectorAll('.topic-checkbox');
            
            if (checkbox.checked) {
                topicCheckboxes.forEach(cb => {
                    cb.checked = false;
                    cb.closest('.custom-checkbox').classList.remove('selected');
                });
                checkbox.closest('.custom-checkbox').classList.add('selected');
            } else {
                checkbox.closest('.custom-checkbox').classList.remove('selected');
            }
        }

        function handleTopicChange() {
            const topicCheckboxes = document.querySelectorAll('.topic-checkbox');
            const generalCheckbox = document.getElementById('test-general');
            const anyTopicSelected = Array.from(topicCheckboxes).some(cb => cb.checked);
            
            topicCheckboxes.forEach(cb => {
                if (cb.checked) {
                    cb.closest('.custom-checkbox').classList.add('selected');
                } else {
                    cb.closest('.custom-checkbox').classList.remove('selected');
                }
            });
            
            if (anyTopicSelected && generalCheckbox.checked) {
                generalCheckbox.checked = false;
                generalCheckbox.closest('.custom-checkbox').classList.remove('selected');
            }
        }

        function startTest() {
            const generalCheckbox = document.getElementById('test-general');
            const topicCheckboxes = document.querySelectorAll('.topic-checkbox');
            
            let availableQuestions = [];
            let testName = document.getElementById('test-name').value.trim();
            
            if (generalCheckbox && generalCheckbox.checked) {
                availableQuestions = appState.questions;
                if (!testName) testName = 'Test General';
            } else {
                const selectedTopicIds = Array.from(topicCheckboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.getAttribute('data-topic-id'));
                
                if (selectedTopicIds.length === 0) {
                    showMessage('Selecciona al menos un tema o marca "Test General"', 'error');
                    return;
                }
                
                availableQuestions = appState.questions.filter(q => 
                    q.topicId && selectedTopicIds.includes(q.topicId.toString())
                );
                
                if (!testName) testName = 'Test Personalizado';
            }

            if (availableQuestions.length === 0) {
                showMessage('No hay preguntas disponibles', 'error');
                return;
            }

            const questionsCountSelect = document.getElementById('test-questions-count');
            const questionsCount = questionsCountSelect.value === 'all' ? availableQuestions.length : parseInt(questionsCountSelect.value);
            const finalQuestionsCount = Math.min(questionsCount, availableQuestions.length);
            const shuffled = [...availableQuestions].sort(() => Math.random() - 0.5);
            
            appState.currentTest = {
                name: testName,
                questions: shuffled.slice(0, finalQuestionsCount),
                startTime: Date.now()
            };
            
            render();
        }

        function finishTest() {
            if (!appState.currentTest) return;
            
            const form = document.getElementById('test-form');
            let correct = 0;
            let incorrect = 0;
            let unanswered = 0;
            
            appState.currentTest.questions.forEach((question, index) => {
                const selectedOption = form.querySelector('input[name="question-' + index + '"]:checked');
                
                if (selectedOption) {
                    const userAnswer = parseInt(selectedOption.value);
                    if (userAnswer === question.correctAnswer) {
                        correct++;
                    } else {
                        incorrect++;
                    }
                } else {
                    unanswered++;
                }
            });
            
            const totalQuestions = appState.currentTest.questions.length;
            
            const testResult = {
                name: appState.currentTest.name,
                correct: correct,
                incorrect: incorrect,
                unanswered: unanswered,
                total: totalQuestions,
                date: new Date().toLocaleString('es-ES'),
                id: Date.now()
            };
            
            appState.testResults.push(testResult);
            localStorage.setItem('testResults', JSON.stringify(appState.testResults));
            
            appState.currentTest = null;
            appState.currentTab = 'results';
            render();
        }

        function clearTestHistory() {
            if (confirm('¿Eliminar todo el historial de tests?')) {
                appState.testResults = [];
                localStorage.setItem('testResults', JSON.stringify(appState.testResults));
                render();
            }
        }

        function deleteIndividualTest(index) {
            if (confirm('¿Eliminar este test?')) {
                appState.testResults.splice(index, 1);
                localStorage.setItem('testResults', JSON.stringify(appState.testResults));
                render();
            }
        }

        // Funciones auxiliares
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        function getPageTitle() {
            switch(appState.currentTab) {
                case 'questions': return 'Banco de Preguntas';
                case 'results': return 'Resultados del Test';
                default: return 'Sistema de Exámenes';
            }
        }

        function getFilteredQuestions() {
            if (appState.selectedTopicFilter === 'all') {
                return appState.questions;
            }
            return appState.questions.filter(q => q.topicId && q.topicId.toString() === appState.selectedTopicFilter.toString());
        }

        function getTopicName(topicId) {
            if (!topicId) return 'Sin tema';
            const topic = appState.topics.find(t => t.id.toString() === topicId.toString());
            return topic ? topic.name : 'Tema no encontrado';
        }

        function getTopicQuestionCount(topicId) {
            return appState.questions.filter(q => q.topicId && q.topicId.toString() === topicId.toString()).length;
        }

        function getAddButtonText() {
            if (!appState.selectedTopicForNewQuestions) {
                return '✅ 2. Añadir al Banco';
            } else {
                const topicName = getTopicName(appState.selectedTopicForNewQuestions);
                return '✅ 2. Asignar a "' + topicName + '"';
            }
        }

        function showMessage(message, type) {
            const messagesDiv = document.getElementById('messages');
            if (messagesDiv) {
                messagesDiv.innerHTML = '<div class="message ' + type + '">' + message + '</div>';
                setTimeout(() => {
                    messagesDiv.innerHTML = '';
                }, 5000);
            }
        }

        // Inicialización
        function initializeApp() {
            document.addEventListener('change', function(e) {
                if (e.target && e.target.id === 'imageInput') {
                    const files = Array.from(e.target.files);
                    const imageFiles = files.filter(file => file.type.startsWith('image/')).slice(0, 10);
                    
                    if (imageFiles.length > 0) {
                        appState.selectedImages = imageFiles;
                        render();
                        showMessage(imageFiles.length + ' imagen(es) seleccionada(s)', 'success');
                    }
                }
            });
            
            render();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>
