








<!DOCTYPE html>
<html lang="es">
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
</head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Ex√°menes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .title {
            font-size: 2rem;
            font-weight: bold;
            color: #2d3748;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            margin: 5px;
        }

        .btn-primary { background: #4f46e5; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-info { background: #0ea5e9; color: white; }

        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

        .nav-tabs {
            display: flex;
            margin-bottom: 30px;
            background: #f8fafc;
            border-radius: 12px;
            padding: 5px;
        }

        .nav-tab {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: white;
            color: #4f46e5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            font-weight: 500;
            margin-bottom: 5px;
            color: #374151;
            display: block;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .success { 
            background: #d1fae5; 
            color: #065f46; 
            border-color: #10b981; 
        }

        .error { 
            background: #fee2e2; 
            color: #991b1b; 
            border-color: #ef4444; 
        }

        .three-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .column {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e2e8f0;
        }

        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
        }

        /* Nuevos estilos para checkboxes personalizados */
        .custom-checkbox {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .custom-checkbox:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .custom-checkbox.selected {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .custom-checkbox input[type="checkbox"] {
            transform: scale(1.3);
            accent-color: #3b82f6;
        }

        @media (max-width: 768px) {
            .three-column {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Variables globales
        let state = {
            currentUser: null,
            currentTab: 'upload',
            apiKey: localStorage.getItem('anthropic_api_key') || '',
            questions: JSON.parse(localStorage.getItem('questions') || '[]'),
            topics: JSON.parse(localStorage.getItem('topics') || '[]'),
            selectedImages: [],
            transcribedText: '',
            cleanedText: '',
            selectedTopicForNewQuestions: null,
            selectedTopicFilter: 'all',
            currentTest: null,
            testResults: JSON.parse(localStorage.getItem('testResults') || '[]'),
            currentViewingResult: null
        };

        const users = {
            'demo': { password: 'demo123', name: 'Usuario Demo' }
        };

        // Funci√≥n principal de renderizado
        function render() {
            const app = document.getElementById('app');
            
            if (!state.currentUser) {
                app.innerHTML = `
                    <div class="container">
                        <div class="login-form">
                            <h2 style="text-align: center; margin-bottom: 30px;">Iniciar Sesi√≥n</h2>
                            <div class="form-group">
                                <label class="form-label">Usuario</label>
                                <input type="text" id="username" class="form-input" placeholder="demo">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contrase√±a</label>
                                <input type="password" id="password" class="form-input" placeholder="demo123">
                            </div>
                            <button onclick="login()" class="btn btn-primary" style="width: 100%;">
                                Iniciar Sesi√≥n
                            </button>
                            <div style="text-align: center; margin-top: 15px; color: #6b7280; font-size: 14px;">
                                Usuario: demo | Contrase√±a: demo123
                            </div>
                        </div>
                    </div>
                `;
            } else {
                app.innerHTML = `
                    <div class="container">
                        <div class="header">
                            <div class="title">${state.currentTab === 'questions' ? 'Banco de Preguntas' : (state.currentTab === 'results' ? 'Resultados del Test' : 'Sistema de Ex√°menes')}</div>
                            <div>
                                <span style="color: ${state.apiKey ? '#10b981' : '#ef4444'};">
                                    ${state.apiKey ? '‚úÖ API Configurada' : '‚ùå Sin API'}
                                </span>
                                <button onclick="configureAPI()" class="btn btn-secondary">API</button>
                                <span style="color: #f59e0b;">üë§ ${state.currentUser.name}</span>
                                <button onclick="logout()" class="btn btn-danger">Salir</button>
                            </div>
                        </div>

                        <div class="nav-tabs">
                            <button class="nav-tab ${state.currentTab === 'upload' ? 'active' : ''}" onclick="setTab('upload')">
                                üì§ Subir Test
                            </button>
                            <button class="nav-tab ${state.currentTab === 'questions' ? 'active' : ''}" onclick="setTab('questions')">
                                üìã Banco de Preguntas (${getFilteredQuestions().length})
                            </button>
                            <button class="nav-tab ${state.currentTab === 'test' ? 'active' : ''}" onclick="setTab('test')">
                                üéØ Test Aleatorio
                            </button>
                            <button class="nav-tab ${state.currentTab === 'results' ? 'active' : ''}" onclick="setTab('results')">
                                üìä Resultados (${state.testResults.length})
                            </button>
                        </div>

                        <div id="messages"></div>

                        ${renderTabContent()}
                    </div>
                `;
            }
        }

        function renderTabContent() {
            switch(state.currentTab) {
                case 'upload':
                    return renderUploadTab();
                case 'questions':
                    return renderQuestionsTab();
                case 'test':
                    return renderTestTab();
                case 'results':
                    return renderResultsTab();
                default:
                    return '<div>Error: Pesta√±a no encontrada</div>';
            }
        }

        function renderUploadTab() {
            return `
                <div class="three-column">
                    <div class="column">
                        <h3 style="margin-bottom: 15px;">üì§ Subir Im√°genes</h3>
                        <div class="upload-area" onclick="document.getElementById('imageInput').click()">
                            <div>üìÅ Seleccionar im√°genes</div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Hasta 10 im√°genes</div>
                            <div style="margin-top: 10px; color: #4f46e5; font-weight: 500;">
                                ${state.selectedImages.length}/10 archivos
                            </div>
                        </div>
                        <input type="file" id="imageInput" style="display: none;" accept="image/*" multiple>
                        
                        ${state.selectedImages.length > 0 ? `
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                                ${state.selectedImages.map((file, i) => `
                                    <div style="position: relative; text-align: center; padding: 10px; background: #f3f4f6; border-radius: 8px;">
                                        <button onclick="removeImage(${i})" style="position: absolute; top: 5px; right: 5px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer;">√ó</button>
                                        <div style="font-size: 10px; word-break: break-all;">${file.name}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <button onclick="transcribeImages()" class="btn btn-primary" style="width: 100%;" ${state.selectedImages.length === 0 || !state.apiKey ? 'disabled' : ''}>
                            ü§ñ 1. Transcribir y Procesar
                        </button>
                        
                        ${state.transcribedText && !state.cleanedText ? `
                            <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; text-align: center;">
                                <span style="color: #92400e;">üîÑ Procesando texto autom√°ticamente...</span>
                            </div>
                        ` : ''}
                    </div>

                    <div class="column">
                        <h3 style="margin-bottom: 15px;">üìù Texto Transcrito</h3>
                        <textarea id="cleanedText" class="textarea" placeholder="El texto procesado aparecer√° aqu√≠..." readonly>${state.cleanedText}</textarea>
                        
                        <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px;">
                            <h4 style="color: #92400e; margin-bottom: 10px;">üè∑Ô∏è Gesti√≥n de Temas</h4>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <button onclick="createTopic()" class="btn btn-info" style="width: 100%; padding: 8px; font-size: 13px;">
                                    üÜï Crear Tema
                                </button>
                                
                                <div style="position: relative;">
                                    <select id="topic-selector" onchange="updateSelectedTopic()" style="width: 100%; padding: 8px; border: none; background: #f59e0b; color: white; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer;" ${state.topics.length === 0 ? 'disabled' : ''}>
                                        <option value="">üè∑Ô∏è Seleccionar Tema</option>
                                        ${state.topics.map(topic => `
                                            <option value="${topic.id}" ${state.selectedTopicForNewQuestions === topic.id ? 'selected' : ''}>
                                                ${topic.name} (${getTopicQuestionCount(topic.id)})
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            ${state.topics.length === 0 ? `
                                <div style="font-size: 12px; color: #78350f; font-style: italic; text-align: center;">
                                    Crea un tema para organizar tus preguntas
                                </div>
                            ` : ''}
                        </div>
                        
                        <button onclick="addToQuestions()" class="btn btn-success" style="width: 100%; margin-top: 10px;" ${!state.cleanedText ? 'disabled' : ''}>
                            ${getAddButtonText()}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderQuestionsTab() {
            const filteredQuestions = getFilteredQuestions();
            
            function getQuestionsTitle() {
                if (state.selectedTopicFilter === 'all') {
                    return 'TODAS LAS PREGUNTAS DEL BANCO';
                } else {
                    const topic = state.topics.find(t => t.id == state.selectedTopicFilter);
                    if (topic) {
                        return `PREGUNTAS ${topic.name.toUpperCase()}`;
                    } else {
                        return 'PREGUNTAS DEL TEMA SELECCIONADO';
                    }
                }
            }
            
            return `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>${getQuestionsTitle()} (${filteredQuestions.length})</h2>
        <div style="display: flex; gap: 10px;">
            <button onclick="detectDuplicates()" class="btn btn-warning">üîç Detectar Repetidas</button>
            <button onclick="clearQuestions()" class="btn btn-danger">Limpiar Todo</button>
        </div>
    </div>

                ${state.topics.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <label style="margin-right: 10px; font-weight: 500;">Filtrar por tema:</label>
                        <select onchange="filterByTopic(this.value)" style="padding: 8px; border-radius: 6px; border: 1px solid #d1d5db;">
                            <option value="all" ${state.selectedTopicFilter === 'all' ? 'selected' : ''}>Todos los temas (${state.questions.length})</option>
                            ${state.topics.map(topic => `
                                <option value="${topic.id}" ${state.selectedTopicFilter == topic.id ? 'selected' : ''}>
                                    ${topic.name} (${getTopicQuestionCount(topic.id)})
                                </option>
                            `).join('')}
                        </select>
                    </div>
                ` : ''}

                ${state.topics.length > 0 && state.selectedTopicFilter === 'all' ? 
                    renderQuestionsByTopic() : 
                    renderQuestionsFiltered(filteredQuestions)
                }
            `;
        }

        function renderQuestionsByTopic() {
            const questionsWithoutTopic = state.questions.filter(q => !q.topicId);
            
            let html = '';
            
            // Mostrar preguntas por cada tema que TENGA preguntas
            state.topics.forEach(topic => {
                const topicQuestions = state.questions.filter(q => q.topicId && q.topicId.toString() === topic.id.toString());
                if (topicQuestions.length > 0) {
                    html += `
                        <div style="margin-bottom: 30px;">
                            <h3 style="background: #4f46e5; color: white; padding: 10px 15px; border-radius: 8px 8px 0 0; margin: 0; display: flex; justify-content: space-between; align-items: center;">
                                <span>üìÅ ${topic.name}</span>
                                <span style="font-size: 14px; opacity: 0.9;">${topicQuestions.length} preguntas</span>
                            </h3>
                            <div style="border: 1px solid #4f46e5; border-top: none; border-radius: 0 0 8px 8px; background: white;">
                                ${topicQuestions.map(q => {
                                    const actualIndex = state.questions.findIndex(question => question.id === q.id);
                                    return renderSingleQuestion(q, actualIndex);
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
            });
            
            // Mostrar preguntas sin tema asignado SI existen
            if (questionsWithoutTopic.length > 0) {
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="background: #6b7280; color: white; padding: 10px 15px; border-radius: 8px 8px 0 0; margin: 0; display: flex; justify-content: space-between; align-items: center;">
                            <span>üìÇ Sin tema asignado</span>
                            <span style="font-size: 14px; opacity: 0.9;">${questionsWithoutTopic.length} preguntas</span>
                        </h3>
                        <div style="border: 1px solid #6b7280; border-top: none; border-radius: 0 0 8px 8px; background: white;">
                            ${questionsWithoutTopic.map(q => {
                                const actualIndex = state.questions.findIndex(question => question.id === q.id);
                                return renderSingleQuestion(q, actualIndex);
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Si no hay preguntas en absoluto
            if (html === '') {
                return '<div style="padding: 40px; text-align: center; color: #9ca3af;">No hay preguntas disponibles en el banco</div>';
            }
            
            return html;
        }

        function renderQuestionsFiltered(filteredQuestions) {
            return `
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; background: white;">
                    ${filteredQuestions.length === 0 ? 
                        '<div style="padding: 40px; text-align: center; color: #9ca3af;">No hay preguntas disponibles</div>' :
                        filteredQuestions.map(q => {
                            const actualIndex = state.questions.findIndex(question => question.id === q.id);
                            return renderSingleQuestion(q, actualIndex);
                        }).join('')
                    }
                </div>
            `;
        }

        function renderSingleQuestion(q, actualIndex) {
            const topicName = q.topicId ? getTopicName(q.topicId) : null;
            
            return `
                <div style="padding: 15px; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between;">
                    <div style="flex: 1; display: flex; gap: 8px;">
                        ${q.isVerified ? '<span style="color: #3b82f6; font-size: 16px; filter: drop-shadow(0 0 2px rgba(59, 130, 246, 0.5)); flex-shrink: 0; margin-top: 2px;" title="Pregunta verificada">‚≠ê</span>' : '<span style="width: 16px; flex-shrink: 0;"></span>'}
                        <div style="flex: 1;">
                            <div style="font-weight: 500; margin-bottom: 8px;">
                                ${q.question}
                                ${topicName && state.selectedTopicFilter === 'all' && state.selectedTopicFilter !== q.topicId ? `<span style="background: #e0e7ff; color: #4f46e5; padding: 2px 6px; border-radius: 8px; font-size: 11px; margin-left: 8px;">${topicName}</span>` : ''}
                            </div>
                            <ul style="list-style: none; margin: 0; padding: 0;">
                                ${q.options.map((opt, optIndex) => `
                                    <li style="padding: 2px 0; color: ${q.correctAnswer === optIndex ? '#059669' : '#6b7280'}; ${q.correctAnswer === optIndex ? 'font-weight: 500;' : ''}">
                                        ${String.fromCharCode(97 + optIndex)}) ${opt}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                    <div style="display: flex; gap: 5px; align-items: flex-start;">
                        <button onclick="toggleVerified(${actualIndex})" class="btn ${q.isVerified ? 'btn-primary' : 'btn-secondary'}" style="padding: 4px 8px; font-size: 14px; ${q.isVerified ? 'background: linear-gradient(135deg, #3b82f6, #1d4ed8);' : ''}" title="${q.isVerified ? 'Pregunta verificada - Click para desmarcar' : 'Marcar como verificada'}">
                            ${q.isVerified ? '‚≠ê' : '‚òÜ'}
                        </button>
                        <button onclick="editQuestion(${actualIndex})" class="btn btn-warning" style="padding: 5px 10px; font-size: 12px;">Editar</button>
                        <button onclick="deleteQuestion(${actualIndex})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">Eliminar</button>
                    </div>
                </div>
            `;
        }

        function renderTestTab() {
            if (state.questions.length === 0) {
                return '<div style="text-align: center; padding: 40px;">A√±ade preguntas al banco para generar tests</div>';
            }

            if (!state.currentTest) {
                return `
                    <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="color: #0c4a6e; margin-bottom: 15px;">üéØ Configuraci√≥n del Test</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">N√∫mero de preguntas:</label>
                                <select id="test-questions-count" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <option value="5">5 preguntas</option>
                                    <option value="10" selected>10 preguntas</option>
                                    <option value="15">15 preguntas</option>
                                    <option value="20">20 preguntas</option>
                                    <option value="all">Todas las preguntas disponibles</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Duraci√≥n:</label>
                                <select id="test-duration" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <option value="300">5 minutos</option>
                                    <option value="600" selected>10 minutos</option>
                                    <option value="900">15 minutos</option>
                                    <option value="1200">20 minutos</option>
                                    <option value="1800">30 minutos</option>
                                    <option value="0">Sin l√≠mite de tiempo</option>
                                </select>
                            </div>
                        </div>

                        ${state.topics.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 15px; font-weight: 500;">Selecci√≥n de temas:</label>
                                <div style="display: grid; gap: 8px;">
                                    <div class="custom-checkbox" onclick="toggleGeneralTest()">
                                        <input type="checkbox" id="test-general" onchange="handleGeneralTestChange(this)" checked>
                                        <span style="font-weight: 500;">Test General (${state.questions.length} preguntas)</span>
                                    </div>
                                    ${state.topics.map(topic => `
                                        <div class="custom-checkbox" onclick="toggleTopicTest('${topic.id}')">
                                            <input type="checkbox" class="topic-checkbox" data-topic-id="${topic.id}" onchange="handleTopicChange()">
                                            <span>${topic.name} (${getTopicQuestionCount(topic.id)} preguntas)</span>
                                        </div>
                                    `).join('')}
                                </div>
                                <div style="margin-top: 15px; padding: 10px; background: #f3f4f6; border-radius: 6px; font-size: 14px; color: #6b7280;">
                                    üí° <strong>Consejo:</strong> Puedes seleccionar m√∫ltiples temas para crear un test combinado, o elegir "Test General" para incluir todas las preguntas.
                                </div>
                            </div>
                        ` : ''}

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Nombre del test:</label>
                            <input type="text" id="test-name" placeholder="Ej: Test de Matem√°ticas - Sesi√≥n 1" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                            <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                                Si no especificas un nombre, se generar√° autom√°ticamente
                            </div>
                        </div>
                    </div>

                    <div style="text-align: center; padding: 40px;">
                        <button onclick="startTest()" class="btn btn-primary" style="font-size: 1.2rem; padding: 15px 30px;">
                            üéØ Comenzar Test
                        </button>
                    </div>
                `;
            }

            return renderCurrentTest();
        }

        function renderCurrentTest() {
            const duration = state.currentTest.duration;
            const hasTimer = duration > 0;
            
            return `
                <div style="max-width: 1000px; margin: 0 auto; position: relative;">
                    ${hasTimer ? `
                        <div id="timer" style="position: fixed; top: 20px; right: 20px; background: white; padding: 15px 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: bold; color: #ef4444; font-size: 1.2rem; z-index: 1000; border: 2px solid #fecaca;">
                            ‚è±Ô∏è ${formatTime(state.currentTest.timeLeft)}
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 20px; background: #f8fafc; border-radius: 12px;">
                        <div>
                            <h2 style="margin: 0; color: #1f2937;">${state.currentTest.name}</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280; font-size: 14px;">${state.currentTest.questions.length} preguntas</p>
                            <p style="margin: 5px 0 0 0; color: #6b7280; font-size: 14px;">${state.currentTest.testTypeText}</p>
                        </div>
                        ${hasTimer ? `<div style="color: #6b7280; font-size: 14px;">El tiempo se muestra arriba a la derecha</div>` : ''}
                    </div>
                    
                    <form id="test-form">
                        ${state.currentTest.questions.map((question, questionIndex) => `
                            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; color: #1f2937; flex-wrap: nowrap;">
                                    <span style="color: #4f46e5; flex-shrink: 0;">#${questionIndex + 1}</span>
                                    <span style="flex: 1; min-width: 0;">${question.question}</span>
                                    ${question.isVerified ? '<span style="color: #3b82f6; font-size: 16px; filter: drop-shadow(0 0 2px rgba(59, 130, 246, 0.5)); flex-shrink: 0;" title="Pregunta verificada">‚≠ê</span>' : ''}
                                    ${question.topicId && state.currentTest.testType !== question.topicId.toString() ? `<span style="background: #f3f4f6; color: #6b7280; padding: 2px 6px; border-radius: 6px; font-size: 11px; font-weight: 400; flex-shrink: 0; white-space: nowrap;" title="Tema de la pregunta">${getTopicName(question.topicId)}</span>` : ''}
                                </div>
                                
                                <div style="display: grid; gap: 12px;">
                                    ${question.options.map((option, optionIndex) => `
                                        <label style="display: flex; align-items: center; gap: 12px; padding: 15px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 15px;" 
                                               onmouseover="this.style.backgroundColor='#f3f4f6'; this.style.borderColor='#d1d5db';" 
                                               onmouseout="this.style.backgroundColor='#f9fafb'; this.style.borderColor='#e5e7eb';">
                                            <input type="radio" name="question-${questionIndex}" value="${optionIndex}" style="transform: scale(1.2);">
                                            <span><strong>${String.fromCharCode(97 + optionIndex)})</strong> ${option}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </form>
                    
                    <div style="text-align: center; padding: 30px;">
                        <button onclick="finishTest()" class="btn btn-primary" style="font-size: 1.2rem; padding: 15px 40px;">
                            üèÅ Finalizar Test
                        </button>
                    </div>
                </div>
            `;
        }

        function renderResultsTab() {
            if (state.currentViewingResult) {
                // Mostrar resultado espec√≠fico
                return renderSpecificResult(state.currentViewingResult);
            }

            // Mostrar lista de resultados
            if (state.testResults.length === 0) {
                return `
                    <div style="text-align: center; padding: 60px; color: #9ca3af;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">üìä</div>
                        <h3 style="color: #6b7280; margin-bottom: 10px;">No hay resultados disponibles</h3>
                        <p style="color: #9ca3af;">Realiza tu primer test para ver los resultados aqu√≠</p>
                    </div>
                `;
            }

            return `
                <div style="max-width: 1000px; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="color: #1f2937; margin: 0;">üìä Historial de Tests (${state.testResults.length})</h2>
                        <button onclick="clearTestHistory()" class="btn btn-danger">
                            üóëÔ∏è Limpiar Historial
                        </button>
                    </div>

                    <div style="display: grid; gap: 20px;">
                        ${state.testResults.map((result, index) => {
                            const percentage = Math.round((result.correct / result.total) * 100);
                            let scoreColor = '#ef4444';
                            let scoreIcon = 'üìâ';
                            
                            if (percentage >= 90) {
                                scoreColor = '#059669';
                                scoreIcon = 'üåü';
                            } else if (percentage >= 70) {
                                scoreColor = '#0ea5e9';
                                scoreIcon = 'üëç';
                            } else if (percentage >= 50) {
                                scoreColor = '#f59e0b';
                                scoreIcon = '‚ö°';
                            }

                            return `
                                <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative;" 
                                     onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" 
                                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                                    
                                    <!-- Bot√≥n eliminar individual -->
                                    <button onclick="event.stopPropagation(); deleteIndividualTest(${index})" 
                                            style="position: absolute; top: 10px; right: 10px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.7; transition: opacity 0.2s;" 
                                            onmouseover="this.style.opacity='1'" 
                                            onmouseout="this.style.opacity='0.7'" 
                                            title="Eliminar este test">√ó</button>
                                    
                                    <div onclick="viewTestResult(${index})" style="width: 100%;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                            <h3 style="margin: 0; color: #1f2937; display: flex; align-items: center; gap: 10px; padding-right: 30px;">
                                                <span style="font-size: 1.2em;">${scoreIcon}</span>
                                                ${result.name}
                                            </h3>
                                            <div style="background: ${scoreColor}; color: white; padding: 6px 12px; border-radius: 20px; font-weight: bold; font-size: 1.1rem;">
                                                ${percentage}%
                                            </div>
                                        </div>

                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                            <div style="text-align: center;">
                                                <div style="font-size: 1.5rem; font-weight: bold; color: #059669;">${result.correct}</div>
                                                <div style="font-size: 12px; color: #6b7280;">Correctas</div>
                                            </div>
                                            <div style="text-align: center;">
                                                <div style="font-size: 1.5rem; font-weight: bold; color: #ef4444;">${result.incorrect}</div>
                                                <div style="font-size: 12px; color: #6b7280;">Incorrectas</div>
                                            </div>
                                            <div style="text-align: center;">
                                                <div style="font-size: 1.5rem; font-weight: bold; color: #f59e0b;">${result.unanswered}</div>
                                                <div style="font-size: 12px; color: #6b7280;">Sin responder</div>
                                            </div>
                                            <div style="text-align: center;">
                                                <div style="font-size: 1.5rem; font-weight: bold; color: #6b7280;">${result.total}</div>
                                                <div style="font-size: 12px; color: #6b7280;">Total</div>
                                            </div>
                                        </div>

                                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: #6b7280;">
                                            <span>${result.testType}</span>
                                            <span>${result.date}</span>
                                        </div>
                                        
                                        ${result.timeUsedText ? `
                                            <div style="font-size: 12px; color: #9ca3af; margin-top: 5px; text-align: right;">
                                                ${result.timeUsedText}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).reverse().join('')}
                    </div>
                </div>
            `;
        }

        function renderSpecificResult(result) {
            const percentage = Math.round((result.correct / result.total) * 100);
            
            // Determinar color y mensaje seg√∫n porcentaje
            let scoreColor = '#ef4444'; // Rojo por defecto
            let scoreMessage = '¬°Sigue practicando! üí™';
            let scoreIcon = 'üìâ';
            
            if (percentage >= 90) {
                scoreColor = '#059669';
                scoreMessage = '¬°Excelente trabajo! üèÜ';
                scoreIcon = 'üåü';
            } else if (percentage >= 70) {
                scoreColor = '#0ea5e9';
                scoreMessage = '¬°Buen desempe√±o! üëè';
                scoreIcon = 'üëç';
            } else if (percentage >= 50) {
                scoreColor = '#f59e0b';
                scoreMessage = '¬°Puedes mejorar! üìö';
                scoreIcon = '‚ö°';
            }

            return `
                <div style="max-width: 1000px; margin: 0 auto;">
                    <!-- Bot√≥n Volver -->
                    <div style="margin-bottom: 20px;">
                        <button onclick="state.currentViewingResult = null; render();" class="btn btn-secondary">
                            ‚Üê Volver al Historial
                        </button>
                    </div>

                    <!-- Header de Resultados -->
                    <div style="text-align: center; background: linear-gradient(135deg, ${scoreColor}15, ${scoreColor}05); border: 2px solid ${scoreColor}30; border-radius: 20px; padding: 40px; margin-bottom: 30px;">
                        <div style="font-size: 4rem; margin-bottom: 15px;">${scoreIcon}</div>
                        <h1 style="color: ${scoreColor}; font-size: 2.5rem; margin: 0 0 10px 0;">${percentage}%</h1>
                        <p style="color: ${scoreColor}; font-size: 1.3rem; font-weight: 600; margin: 0 0 15px 0;">${scoreMessage}</p>
                        <h2 style="color: #6b7280; font-size: 1.2rem; margin: 0;">${result.name}</h2>
                        <p style="color: #6b7280; font-size: 1rem; margin: 5px 0 0 0;">${result.testType}</p>
                        ${result.timeUsedText ? `<p style="color: #6b7280; font-size: 0.9rem; margin: 5px 0 0 0;">${result.timeUsedText}</p>` : ''}
                        <p style="color: #9ca3af; font-size: 0.85rem; margin: 10px 0 0 0;">${result.date}</p>
                    </div>

                    <!-- M√©tricas Generales -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="font-size: 2rem; color: #0ea5e9; margin-bottom: 10px;">‚úÖ</div>
                            <div style="font-size: 1.8rem; font-weight: bold; color: #0c4a6e; margin-bottom: 5px;">${result.correct}</div>
                            <div style="color: #0369a1; font-weight: 500;">Correctas</div>
                        </div>

                        <div style="background: #fef2f2; border: 2px solid #ef4444; border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="font-size: 2rem; color: #ef4444; margin-bottom: 10px;">‚ùå</div>
                            <div style="font-size: 1.8rem; font-weight: bold; color: #991b1b; margin-bottom: 5px;">${result.incorrect}</div>
                            <div style="color: #dc2626; font-weight: 500;">Incorrectas</div>
                        </div>

                        <div style="background: #fffbeb; border: 2px solid #f59e0b; border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="font-size: 2rem; color: #f59e0b; margin-bottom: 10px;">‚è≠Ô∏è</div>
                            <div style="font-size: 1.8rem; font-weight: bold; color: #92400e; margin-bottom: 5px;">${result.unanswered}</div>
                            <div style="color: #d97706; font-weight: 500;">Sin responder</div>
                        </div>

                        <div style="background: #f0fdf4; border: 2px solid #22c55e; border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="font-size: 2rem; color: #22c55e; margin-bottom: 10px;">üìä</div>
                            <div style="font-size: 1.8rem; font-weight: bold; color: #166534; margin-bottom: 5px;">${result.total}</div>
                            <div style="color: #16a34a; font-weight: 500;">Total</div>
                        </div>
                    </div>

                    <!-- Barra de Progreso Visual -->
                    <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px; margin-bottom: 30px;">
                        <h3 style="margin: 0 0 20px 0; color: #374151;">üìà Distribuci√≥n de Respuestas</h3>
                        <div style="background: #f3f4f6; border-radius: 10px; overflow: hidden; height: 30px; display: flex; margin-bottom: 15px;">
                            <div style="background: #22c55e; width: ${(result.correct/result.total)*100}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
                                ${result.correct > 0 ? `${result.correct}‚úì` : ''}
                            </div>
                            <div style="background: #ef4444; width: ${(result.incorrect/result.total)*100}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
                                ${result.incorrect > 0 ? `${result.incorrect}‚úó` : ''}
                            </div>
                            <div style="background: #f59e0b; width: ${(result.unanswered/result.total)*100}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
                                ${result.unanswered > 0 ? `${result.unanswered}?` : ''}
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 14px; color: #6b7280;">
                            <span>0%</span>
                            <span>50%</span>
                            <span>100%</span>
                        </div>
                    </div>

                    <!-- Revisi√≥n Detallada -->
                    <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px; margin-bottom: 30px;">
                        <h3 style="margin: 0 0 20px 0; color: #374151;">üîç Revisi√≥n Detallada</h3>
                        ${result.detailedResults.map((resultItem, index) => `
                            <div style="border: 2px solid ${resultItem.isCorrect ? '#22c55e' : (resultItem.userAnswer !== null ? '#ef4444' : '#f59e0b')}; border-radius: 8px; margin-bottom: 15px; overflow: hidden;">
                                <div style="background: ${resultItem.isCorrect ? '#22c55e' : (resultItem.userAnswer !== null ? '#ef4444' : '#f59e0b')}; color: white; padding: 12px 15px; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 1.1em;">
                                        ${resultItem.isCorrect ? '‚úÖ' : (resultItem.userAnswer !== null ? '‚ùå' : '‚è≠Ô∏è')}
                                    </span>
                                    <span>Pregunta ${index + 1}</span>
                                    ${resultItem.question.isVerified ? '<span style="filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.8));" title="Pregunta verificada">‚≠ê</span>' : ''}
                                </div>
                                <div style="padding: 15px;">
                                    <p style="font-weight: 500; margin: 0 0 15px 0; color: #374151;">${resultItem.question.question}</p>
                                    <div style="display: grid; gap: 8px;">
                                        ${resultItem.question.options.map((option, optIndex) => {
                                            let bgColor = '#f9fafb';
                                            let textColor = '#374151';
                                            let border = '#e5e7eb';
                                            let prefix = '';
                                            
                                            if (optIndex === resultItem.question.correctAnswer) {
                                                bgColor = '#dcfce7';
                                                textColor = '#166534';
                                                border = '#22c55e';
                                                prefix = '‚úì ';
                                            }
                                            
                                            if (resultItem.userAnswer === optIndex && optIndex !== resultItem.question.correctAnswer) {
                                                bgColor = '#fee2e2';
                                                textColor = '#991b1b';
                                                border = '#ef4444';
                                                prefix = '‚úó ';
                                            }
                                            
                                            return `
                                                <div style="background: ${bgColor}; border: 1px solid ${border}; border-radius: 6px; padding: 10px; color: ${textColor};">
                                                    <strong>${String.fromCharCode(97 + optIndex)})</strong> ${prefix}${option}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                    ${resultItem.userAnswer === null ? `
                                        <div style="background: #fffbeb; border: 1px solid #f59e0b; border-radius: 6px; padding: 10px; margin-top: 10px; color: #92400e; text-align: center; font-style: italic;">
                                            No respondida
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Acciones -->
                    <div style="text-align: center; padding: 20px;">
                        <button onclick="startNewTest()" class="btn btn-primary" style="font-size: 1.1rem; padding: 15px 30px; margin: 0 10px;">
                            üéØ Nuevo Test
                        </button>
                        <button onclick="state.currentViewingResult = null; render();" class="btn btn-secondary" style="font-size: 1.1rem; padding: 15px 30px; margin: 0 10px;">
                            üìä Ver Historial
                        </button>
                    </div>
                </div>
            `;
        }

        // Event handlers
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (users[username] && users[username].password === password) {
                state.currentUser = users[username];
                render();
                showMessage(`Bienvenido ${users[username].name}`, 'success');
            } else {
                showMessage('Usuario o contrase√±a incorrectos', 'error');
            }
        }

        function logout() {
            state.currentUser = null;
            state.currentTab = 'upload';
            render();
        }

        function configureAPI() {
            const key = prompt('Ingresa tu API key de Anthropic:');
            if (key && key.trim()) {
                state.apiKey = key.trim();
                localStorage.setItem('anthropic_api_key', key.trim());
                render();
                showMessage('API key configurada correctamente', 'success');
            }
        }

        function setTab(tab) {
            state.currentTab = tab;
            state.currentViewingResult = null;
            render();
        }

        function createTopic() {
            const name = prompt('Nombre del nuevo tema:');
            if (name && name.trim()) {
                const newTopic = {
                    id: Date.now() + Math.random(),
                    name: name.trim(),
                    createdAt: new Date().toISOString()
                };
                
                state.topics.push(newTopic);
                localStorage.setItem('topics', JSON.stringify(state.topics));
                render();
                showMessage(`Tema "${name}" creado exitosamente`, 'success');
            }
        }

        function updateSelectedTopic() {
            const selector = document.getElementById('topic-selector');
            if (selector && selector.value) {
                // Convertir el valor del selector al tipo correcto
                const selectedValue = selector.value;
                // Buscar el tema para obtener el ID en su formato original
                const selectedTopic = state.topics.find(t => t.id == selectedValue);
                if (selectedTopic) {
                    state.selectedTopicForNewQuestions = selectedTopic.id;
                    showMessage(`Tema "${selectedTopic.name}" seleccionado`, 'success');
                } else {
                    state.selectedTopicForNewQuestions = selectedValue;
                }
            } else {
                state.selectedTopicForNewQuestions = null;
            }
            render();
        }

        function getAddButtonText() {
            if (!state.selectedTopicForNewQuestions) {
                return '‚úÖ 2. A√±adir al Banco';
            } else {
                const topicName = getTopicName(state.selectedTopicForNewQuestions);
                return `‚úÖ 2. Asignar a "${topicName}"`;
            }
        }

        function removeImage(index) {
            state.selectedImages.splice(index, 1);
            render();
            
        }

        async function transcribeImages() {
            if (!state.apiKey) {
                showMessage('Configura tu API key primero', 'error');
                return;
            }

            if (state.selectedImages.length === 0) {
                showMessage('Selecciona al menos una imagen', 'error');
                return;
            }

            showMessage('Transcribiendo im√°genes...', 'success');
            
            try {
                let allTranscriptions = [];
                
                const batchSize = 5;
                for (let i = 0; i < state.selectedImages.length; i += batchSize) {
                    const batch = state.selectedImages.slice(i, i + batchSize);
                    
                    const imageContents = await Promise.all(
                        batch.map(async (file) => {
                            const base64 = await fileToBase64(file);
                            return {
                                type: "image",
                                source: {
                                    type: "base64",
                                    media_type: file.type,
                                    data: base64
                                }
                            };
                        })
                    );

                    const messageContent = [
                        ...imageContents,
                        {
                            type: "text",
                            text: `Act√∫a como un transcriptor de texto para una persona ciega. Analiza ${batch.length > 1 ? 'estas im√°genes' : 'esta imagen'} y extrae todo el texto visible de manera secuencial.

INSTRUCCIONES CR√çTICAS:
- Solo dicta las palabras que ves, como si estuvieras hablando en voz alta
- Encuentra las preguntas numeradas y sus opciones de respuesta
- CONSERVA y DESCRIBE todos los s√≠mbolos visuales de respuesta correcta que veas
- MANT√âN s√≠mbolos como: ‚úì, ‚úî, checkmarks, asteriscos, vi√±etas, flechas
- DESCRIBE elementos visuales importantes: "opci√≥n marcada en verde", "con tick", "con check", "respuesta correcta", "marcada"
- PRESERVA cualquier indicaci√≥n visual de que una opci√≥n es la correcta
- Si hay m√∫ltiples im√°genes, procesa cada una en orden
- Separa claramente el contenido de cada imagen

IMPORTANTE: NO elimines s√≠mbolos de respuesta correcta - los necesitamos para el siguiente paso.

Responde con el texto extra√≠do conservando TODOS los s√≠mbolos y marcas visuales.`
                        }
                    ];

                    const response = await fetch("/api/anthropic", {
    method: "POST",
    headers: {
        "Content-Type": "application/json",
        "x-api-key": state.apiKey,
    },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 4000,
                            messages: [{
                                role: "user",
                                content: messageContent
                            }]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Error ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    allTranscriptions.push(data.content[0].text);
                }

                state.transcribedText = allTranscriptions.join('\n\n--- SIGUIENTE IMAGEN ---\n\n');
                
                render();
                showMessage(`Transcripci√≥n completada. Procesando texto...`, 'success');
                
                // Autom√°ticamente limpiar el texto despu√©s de transcribir
                await cleanText();
                
            } catch (error) {
                showMessage(`Error en la transcripci√≥n: ${error.message}`, 'error');
            }
        }

        async function cleanText() {
            if (!state.transcribedText) {
                showMessage('Primero transcribe las im√°genes', 'error');
                return;
            }

            if (!state.apiKey) {
                showMessage('Configura tu API key primero', 'error');
                return;
            }

            render(); // Mostrar el indicador de procesamiento
            
            try {
                const response = await fetch("/api/anthropic", {
    method: "POST",
    headers: {
        "Content-Type": "application/json",
        "x-api-key": state.apiKey,
    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 4000,
                        messages: [{
                            role: "user",
                            content: `Limpia este texto extra√≠do de m√∫ltiples im√°genes y convi√©rtelo en formato de preguntas para banco de preguntas:

TEXTO A LIMPIAR:
${state.transcribedText}

INSTRUCCIONES CR√çTICAS PARA DETECTAR RESPUESTAS CORRECTAS:
- Busca s√≠mbolos visuales: ‚úì, ‚úî, *, ‚Ä¢, ‚Üí, >, checkmarks, ticks
- Busca descripciones: "marcada", "marcada en verde", "respuesta correcta", "con tick", "con check"
- Busca colores mencionados: "verde", "resaltada", "seleccionada"
- MARCA EN NEGRITA las opciones que tengan cualquiera de estos indicadores usando **texto**
- Elimina los s√≠mbolos y descripciones visuales DESPU√âS de identificar las correctas
- Extrae solo las preguntas y opciones de respuesta
- Numera las preguntas secuencialmente

FORMATO DE SALIDA ESTRICTO:
PREGUNTA: [texto de la pregunta]
OPCION_A: [opci√≥n a normal]
OPCION_B: **[opci√≥n b si tiene s√≠mbolo/marca de correcta]**
OPCION_C: [opci√≥n c normal]
OPCION_D: **[opci√≥n d si tiene s√≠mbolo/marca de correcta]**

IMPORTANTE: Cualquier opci√≥n con s√≠mbolo, marca visual, color verde, o descripci√≥n de "correcta" debe ir en **negritas**.`
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                state.cleanedText = data.content[0].text;
                
                render();
                showMessage('¬°Texto procesado y listo para a√±adir al banco!', 'success');
                
            } catch (error) {
                showMessage(`Error en la limpieza: ${error.message}`, 'error');
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        function addToQuestions() {
            if (!state.cleanedText) {
                showMessage('Primero procesa el texto', 'error');
                return;
            }

            try {
                const newQuestions = parseCleanedText(state.cleanedText);
                if (newQuestions.length === 0) {
                    showMessage('No se pudieron extraer preguntas del texto limpio', 'error');
                    return;
                }

                if (state.selectedTopicForNewQuestions) {
                    newQuestions.forEach(question => {
                        question.topicId = state.selectedTopicForNewQuestions;
                    });
                    const topicName = getTopicName(state.selectedTopicForNewQuestions);
                    showMessage(`¬°Se a√±adieron ${newQuestions.length} preguntas al tema "${topicName}"!`, 'success');
                } else {
                    showMessage(`¬°Se a√±adieron ${newQuestions.length} preguntas al banco!`, 'success');
                }

                state.questions.push(...newQuestions);
                localStorage.setItem('questions', JSON.stringify(state.questions));
                
                state.selectedImages = [];
                state.transcribedText = '';
                state.cleanedText = '';
                state.selectedTopicForNewQuestions = null;
                
                render();
                
            } catch (error) {
                showMessage(`Error al procesar preguntas: ${error.message}`, 'error');
            }
        }

        function parseCleanedText(text) {
            const questions = [];
            const sections = text.split(/PREGUNTA:/i).filter(section => section.trim());
            
            sections.forEach(section => {
                const lines = section.trim().split('\n').filter(line => line.trim());
                if (lines.length === 0) return;
                
                const questionText = lines[0].trim();
                const options = [];
                let correctAnswer = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line.match(/^OPCION_[A-D]:/i)) {
                        let optionText = line.replace(/^OPCION_[A-D]:/i, '').trim();
                        
                        if (optionText.startsWith('**') && optionText.endsWith('**')) {
                            optionText = optionText.slice(2, -2);
                            correctAnswer = options.length;
                        }
                        
                        if (optionText) {
                            options.push(optionText);
                        }
                    }
                }
                
                if (questionText && options.length >= 2) {
                    questions.push({
                        id: Date.now() + Math.random(),
                        question: questionText,
                        options: options,
                        correctAnswer: correctAnswer,
                        topicId: null
                    });
                }
            });
            
            return questions;
        }

        function toggleVerified(index) {
            if (state.questions[index]) {
                state.questions[index].isVerified = !state.questions[index].isVerified;
                localStorage.setItem('questions', JSON.stringify(state.questions));
                render();
                showMessage(`Pregunta ${state.questions[index].isVerified ? 'verificada' : 'sin verificar'}`, 'success');
            }
        }

        function clearQuestions() {
            if (confirm('¬øEliminar todas las preguntas?')) {
                state.questions = [];
                localStorage.setItem('questions', JSON.stringify(state.questions));
                render();
            }
        }

        function deleteQuestion(index) {
            if (confirm('¬øEliminar esta pregunta?')) {
                state.questions.splice(index, 1);
                localStorage.setItem('questions', JSON.stringify(state.questions));
                render();
                showMessage('Pregunta eliminada', 'success');
            }
        }

        function editQuestion(index) {
            const question = state.questions[index];
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); display: flex; justify-content: center;
                align-items: center; z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 20px;">Editar Pregunta</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Pregunta:</label>
                        <textarea id="edit-question" style="width: 100%; height: 60px; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">${question.question}</textarea>
                    </div>
                    
                    ${state.topics.length > 0 ? `
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Tema:</label>
                            <select id="edit-topic" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="">Sin tema</option>
                                ${state.topics.map(topic => `
                                    <option value="${topic.id}" ${question.topicId === topic.id ? 'selected' : ''}>
                                        ${topic.name}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 500;">Opciones:</label>
                        ${question.options.map((option, i) => `
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <input type="radio" name="correct" value="${i}" ${question.correctAnswer === i ? 'checked' : ''}>
                                <span style="font-weight: 500; min-width: 20px;">${String.fromCharCode(97 + i)})</span>
                                <input type="text" id="edit-option-${i}" value="${option}" style="flex: 1; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" style="padding: 10px 20px; border: none; background: #6b7280; color: white; border-radius: 6px; cursor: pointer;">
                            Cancelar
                        </button>
                        <button onclick="saveEdit(${index})" style="padding: 10px 20px; border: none; background: #4f46e5; color: white; border-radius: 6px; cursor: pointer;">
                            Guardar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            window.saveEdit = function(qIndex) {
                try {
                    const newQuestion = document.getElementById('edit-question').value.trim();
                    const newOptions = [];
                    
                    for (let i = 0; i < question.options.length; i++) {
                        const optInput = document.getElementById(`edit-option-${i}`);
                        if (optInput && optInput.value.trim()) {
                            newOptions.push(optInput.value.trim());
                        }
                    }
                    
                    const correctRadio = modal.querySelector('input[name="correct"]:checked');
                    const newCorrect = correctRadio ? parseInt(correctRadio.value) : 0;
                    
                    let newTopicId = null;
                    const topicSelect = modal.querySelector('#edit-topic');
                    if (topicSelect && topicSelect.value) {
                        newTopicId = topicSelect.value;
                    }
                    
                    if (!newQuestion || newOptions.length < 2) {
                        alert('Completa todos los campos requeridos');
                        return;
                    }
                    
                    state.questions[qIndex] = {
                        ...state.questions[qIndex],
                        question: newQuestion,
                        options: newOptions,
                        correctAnswer: newCorrect,
                        topicId: newTopicId
                    };
                    
                    localStorage.setItem('questions', JSON.stringify(state.questions));
                    modal.remove();
                    render();
                    showMessage('Pregunta actualizada', 'success');
                    
                } catch (error) {
                    showMessage('Error al guardar: ' + error.message, 'error');
                }
            };
        }

        function filterByTopic(topicId) {
            state.selectedTopicFilter = topicId;
            render(); // Importante: re-renderizar para actualizar el t√≠tulo
        }

        function getFilteredQuestions() {
            if (state.selectedTopicFilter === 'all') {
                return state.questions;
            }
            return state.questions.filter(q => q.topicId && q.topicId.toString() === state.selectedTopicFilter.toString());
        }

        function getTopicName(topicId) {
            if (!topicId) return 'Sin tema';
            const topic = state.topics.find(t => t.id.toString() === topicId.toString());
            return topic ? topic.name : 'Tema no encontrado';
        }

        function getTopicQuestionCount(topicId) {
            return state.questions.filter(q => q.topicId && q.topicId.toString() === topicId.toString()).length;
        }

        // Nuevas funciones para manejar la selecci√≥n m√∫ltiple de temas
        function toggleGeneralTest() {
            const generalCheckbox = document.getElementById('test-general');
            const topicCheckboxes = document.querySelectorAll('.topic-checkbox');
            
            if (generalCheckbox.checked) {
                // Si se marca "Test General", desmarcar todos los temas
                topicCheckboxes.forEach(cb => {
                    cb.checked = false;
                    cb.closest('.custom-checkbox').classList.remove('selected');
                });
                generalCheckbox.closest('.custom-checkbox').classList.add('selected');
            } else {
                generalCheckbox.closest('.custom-checkbox').classList.remove('selected');
            }
        }

        function toggleTopicTest(topicId) {
            const topicCheckbox = document.querySelector(`.topic-checkbox[data-topic-id="${topicId}"]`);
            const generalCheckbox = document.getElementById('test-general');
            
            if (topicCheckbox.checked) {
                topicCheckbox.checked = false;
                topicCheckbox.closest('.custom-checkbox').classList.remove('selected');
            } else {
                topicCheckbox.checked = true;
                topicCheckbox.closest('.custom-checkbox').classList.add('selected');
                // Si se marca alg√∫n tema, desmarcar "Test General"
                if (generalCheckbox.checked) {
                    generalCheckbox.checked = false;
                    generalCheckbox.closest('.custom-checkbox').classList.remove('selected');
                }
            }
        }

        function handleGeneralTestChange(checkbox) {
            const topicCheckboxes = document.querySelectorAll('.topic-checkbox');
            
            if (checkbox.checked) {
                // Si se marca "Test General", desmarcar todos los temas
                topicCheckboxes.forEach(cb => {
                    cb.checked = false;
                    cb.closest('.custom-checkbox').classList.remove('selected');
                });
                checkbox.closest('.custom-checkbox').classList.add('selected');
            } else {
                checkbox.closest('.custom-checkbox').classList.remove('selected');
            }
        }

        function handleTopicChange() {
            const topicCheckboxes = document.querySelectorAll('.topic-checkbox');
            const generalCheckbox = document.getElementById('test-general');
            const anyTopicSelected = Array.from(topicCheckboxes).some(cb => cb.checked);
            
            // Actualizar estilos visuales para cada checkbox de tema
            topicCheckboxes.forEach(cb => {
                if (cb.checked) {
                    cb.closest('.custom-checkbox').classList.add('selected');
                } else {
                    cb.closest('.custom-checkbox').classList.remove('selected');
                }
            });
            
            // Si hay alg√∫n tema seleccionado, desmarcar "Test General"
            if (anyTopicSelected && generalCheckbox.checked) {
                generalCheckbox.checked = false;
                generalCheckbox.closest('.custom-checkbox').classList.remove('selected');
            }
        }

function startTest() {
    const generalCheckbox = document.getElementById('test-general');
    const topicCheckboxes = document.querySelectorAll('.topic-checkbox');
    
    let availableQuestions = [];
    let testTypeText = '';
    let selectedTopics = [];
    
    if (generalCheckbox && generalCheckbox.checked) {
        // Test general - solo preguntas verificadas
        availableQuestions = state.questions.filter(q => q.isVerified === true);
        testTypeText = 'Test General';
    } else {
        // Test de temas espec√≠ficos
        const selectedTopicIds = Array.from(topicCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.getAttribute('data-topic-id'));
        
        if (selectedTopicIds.length === 0) {
            showMessage('Selecciona al menos un tema o marca "Test General"', 'error');
            return;
        }
        
        selectedTopics = selectedTopicIds.map(id => getTopicName(id));
        
        // Filtrar preguntas por los temas seleccionados y que sean verificadas
        availableQuestions = state.questions.filter(q => 
            q.topicId && selectedTopicIds.includes(q.topicId.toString()) && q.isVerified === true
        );
        
        if (selectedTopics.length === 1) {
            testTypeText = `Test de ${selectedTopics[0]}`;
        } else {
            testTypeText = `Test Combinado: ${selectedTopics.join(', ')}`;
        }
    }

    if (availableQuestions.length === 0) {
        showMessage('No hay preguntas disponibles para la selecci√≥n actual', 'error');
        return;
    }

    // Obtener configuraciones
    const questionsCountSelect = document.getElementById('test-questions-count');
    const durationSelect = document.getElementById('test-duration');
    const testNameInput = document.getElementById('test-name');
    
    const questionsCount = questionsCountSelect.value === 'all' ? availableQuestions.length : parseInt(questionsCountSelect.value);
    const duration = parseInt(durationSelect.value);

    // Generar nombre del test
    let testName = testNameInput.value.trim();
    if (!testName) {
        const now = new Date();
        const dateStr = now.toLocaleDateString('es-ES');
        const timeStr = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        
        if (selectedTopics.length === 1) {
            testName = `Test ${selectedTopics[0]} - ${dateStr} ${timeStr}`;
        } else if (selectedTopics.length > 1) {
            testName = `Test Combinado - ${dateStr} ${timeStr}`;
        } else {
            testName = `Test General - ${dateStr} ${timeStr}`;
        }
    }

    const finalQuestionsCount = Math.min(questionsCount, availableQuestions.length);
    const shuffled = [...availableQuestions].sort(() => Math.random() - 0.5);
    
    state.currentTest = {
        name: testName,
        questions: shuffled.slice(0, finalQuestionsCount),
        answers: {},
        duration: duration,
        timeLeft: duration,
        timer: null,
        testType: generalCheckbox && generalCheckbox.checked ? 'all' : 'multiple',
        testTypeText: testTypeText,
        selectedTopics: selectedTopics,
        startTime: Date.now()
    };
    
    // Solo iniciar timer si hay duraci√≥n
    if (duration > 0) {
        state.currentTest.timer = setInterval(() => {
            state.currentTest.timeLeft--;
            if (state.currentTest.timeLeft <= 0) {
                finishTest();
            } else {
                const timerElement = document.getElementById('timer');
                if (timerElement) {
                    timerElement.textContent = `‚è±Ô∏è ${formatTime(state.currentTest.timeLeft)}`;
                }
            }
        }, 1000);
    }
    
    render();
}

function finishTest() {
    if (!state.currentTest) return;
    
    // Detener timer si existe
    if (state.currentTest.timer) {
        clearInterval(state.currentTest.timer);
    }
    
    // Recoger respuestas del formulario
    const form = document.getElementById('test-form');
    let correct = 0;
    let incorrect = 0;
    let unanswered = 0;
    const answers = {};
    const detailedResults = [];
    
    state.currentTest.questions.forEach((question, index) => {
        const selectedOption = form.querySelector(`input[name="question-${index}"]:checked`);
        let userAnswer = null;
        let isCorrect = false;
        
        if (selectedOption) {
            userAnswer = parseInt(selectedOption.value);
            answers[index] = userAnswer;
            if (userAnswer === question.correctAnswer) {
                correct++;
                isCorrect = true;
            } else {
                incorrect++;
            }
        } else {
            unanswered++;
        }
        
        detailedResults.push({
            question: question,
            userAnswer: userAnswer,
            isCorrect: isCorrect
        });
    });
    
    const totalQuestions = state.currentTest.questions.length;
    
    // Calcular tiempo usado
    let timeUsedText = '';
    if (state.currentTest.duration > 0) {
        const timeUsed = state.currentTest.duration - state.currentTest.timeLeft;
        timeUsedText = `Tiempo empleado: ${formatTime(timeUsed)} de ${formatTime(state.currentTest.duration)}`;
    }
    
    // Crear objeto de resultado
    const testResult = {
        name: state.currentTest.name,
        correct: correct,
        incorrect: incorrect,
        unanswered: unanswered,
        total: totalQuestions,
        testType: state.currentTest.testTypeText,
        timeUsedText: timeUsedText,
        detailedResults: detailedResults,
        date: new Date().toLocaleString('es-ES'),
        id: Date.now()
    };
    
    // A√±adir al historial
    state.testResults.push(testResult);
    localStorage.setItem('testResults', JSON.stringify(state.testResults));
    
    // Mostrar el resultado espec√≠fico
    state.currentViewingResult = testResult;
    
    // Limpiar test actual y cambiar a pesta√±a de resultados
    state.currentTest = null;
    state.currentTab = 'results';
    render();
    
    // Hacer scroll al inicio de la p√°gina despu√©s de renderizar
    setTimeout(() => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 100);
}

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function startNewTest() {
            state.currentTab = 'test';
            state.currentViewingResult = null;
            render();
        }

        function viewTestResult(index) {
            state.currentViewingResult = state.testResults[index];
            render();
        }

        function clearTestHistory() {
            if (confirm('¬øEliminar todo el historial de tests? Esta acci√≥n no se puede deshacer.')) {
                state.testResults = [];
                state.currentViewingResult = null;
                localStorage.setItem('testResults', JSON.stringify(state.testResults));
                render();
                showMessage('Historial de tests eliminado', 'success');
            }
        }

        function deleteIndividualTest(index) {
            const testName = state.testResults[index].name;
            if (confirm(`¬øEliminar el test "${testName}"? Esta acci√≥n no se puede deshacer.`)) {
                state.testResults.splice(index, 1);
                localStorage.setItem('testResults', JSON.stringify(state.testResults));
                
                // Si est√°bamos viendo el test que se elimin√≥, volver al historial
                if (state.currentViewingResult && state.currentViewingResult.id === state.testResults[index]?.id) {
                    state.currentViewingResult = null;
                }
                
                render();
                showMessage('Test eliminado correctamente', 'success');
            }
        }

        function showMessage(message, type) {
            const messagesDiv = document.getElementById('messages');
            if (messagesDiv) {
                messagesDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
                setTimeout(() => {
                    messagesDiv.innerHTML = '';
                }, 5000);
            }
        }

        function initializeApp() {
            console.log('Sistema iniciando...');
            
            document.addEventListener('change', function(e) {
                if (e.target && e.target.id === 'imageInput') {
                    const files = Array.from(e.target.files);
                    const imageFiles = files.filter(file => file.type.startsWith('image/')).slice(0, 10);
                    
                    if (imageFiles.length > 0) {
                        state.selectedImages = imageFiles;
                        render();
                        showMessage(`${imageFiles.length} imagen(es) seleccionada(s)`, 'success');
                    }
                }
            });
            
            render();
            console.log('Sistema cargado correctamente');
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
    <!-- 
PARCHE PARA PREGUNTAS FALLADAS
A√±adir este c√≥digo al final del archivo index.html, justo antes de </body>
Sin tocar nada del c√≥digo existente
-->

<script>
    // ========== PARCHE: SISTEMA DE PREGUNTAS FALLADAS ==========
    
    // Funci√≥n para actualizar preguntas falladas (sin tocar c√≥digo original)
    function updateFailedQuestionsData() {
        const failedQuestions = [];
        
        state.testResults.forEach(result => {
            if (result.detailedResults) {
                result.detailedResults.forEach(detail => {
                    if (!detail.isCorrect && detail.userAnswer !== null) {
                        const questionId = detail.question.id;
                        
                        let existingFailed = failedQuestions.find(fq => fq.questionId === questionId);
                        
                        if (!existingFailed) {
                            existingFailed = {
                                questionId: questionId,
                                question: detail.question,
                                failedCount: 0,
                                lastFailedDate: null,
                                isResolved: false
                            };
                            failedQuestions.push(existingFailed);
                        }
                        
                        existingFailed.failedCount++;
                        existingFailed.lastFailedDate = result.date;
                    }
                });
            }
        });

        // Verificar preguntas resueltas
        failedQuestions.forEach(failedQ => {
            const laterResults = state.testResults
                .filter(result => new Date(result.date) > new Date(failedQ.lastFailedDate))
                .reverse();

            for (let result of laterResults) {
                if (result.detailedResults) {
                    const correctAnswer = result.detailedResults.find(detail => 
                        detail.question.id === failedQ.questionId && detail.isCorrect
                    );
                    
                    if (correctAnswer) {
                        failedQ.isResolved = true;
                        break;
                    }
                }
            }
        });

        return failedQuestions;
    }

    // Funci√≥n para obtener preguntas falladas no resueltas
    function getUnresolvedFailedQuestions() {
        const failedQuestions = updateFailedQuestionsData();
        return failedQuestions.filter(fq => !fq.isResolved);
    }

    // Funci√≥n para iniciar test de preguntas falladas
    function startFailedQuestionsTest() {
        const unresolvedFailed = getUnresolvedFailedQuestions();
        
        if (unresolvedFailed.length === 0) {
            showMessage('No tienes preguntas falladas para repasar üéâ', 'success');
            return;
        }

        const questions = unresolvedFailed.map(fq => fq.question);
        const duration = Math.max(300, questions.length * 60);
        
        const now = new Date();
        const dateStr = now.toLocaleDateString('es-ES');
        const timeStr = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        const testName = `Test de Repaso - ${dateStr} ${timeStr}`;

        state.currentTest = {
            name: testName,
            questions: questions,
            answers: {},
            duration: duration,
            timeLeft: duration,
            timer: null,
            testType: 'failed',
            testTypeText: `Repaso de Preguntas Falladas (${questions.length} preguntas)`,
            startTime: Date.now(),
            isFailedQuestionsTest: true
        };
        
        // Iniciar timer
        state.currentTest.timer = setInterval(() => {
            state.currentTest.timeLeft--;
            if (state.currentTest.timeLeft <= 0) {
                finishTest();
            } else {
                const timerElement = document.getElementById('timer');
                if (timerElement) {
                    timerElement.textContent = `‚è±Ô∏è ${formatTime(state.currentTest.timeLeft)}`;
                }
            }
        }, 1000);
        
        render();
        showMessage(`Test de repaso iniciado con ${questions.length} preguntas`, 'success');
    }

    // Extender la funci√≥n renderTestTab original
    const originalRenderTestTab = renderTestTab;
    renderTestTab = function() {
        if (state.questions.length === 0) {
            return '<div style="text-align: center; padding: 40px;">A√±ade preguntas al banco para generar tests</div>';
        }

        if (!state.currentTest) {
            const unresolvedFailed = getUnresolvedFailedQuestions();
            
            return `
                <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #0c4a6e; margin-bottom: 15px;">üéØ Configuraci√≥n del Test</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">N√∫mero de preguntas:</label>
                            <select id="test-questions-count" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="5">5 preguntas</option>
                                <option value="10" selected>10 preguntas</option>
                                <option value="15">15 preguntas</option>
                                <option value="20">20 preguntas</option>
                                <option value="all">Todas las preguntas disponibles</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Duraci√≥n:</label>
                            <select id="test-duration" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="300">5 minutos</option>
                                <option value="600" selected>10 minutos</option>
                                <option value="900">15 minutos</option>
                                <option value="1200">20 minutos</option>
                                <option value="1800">30 minutos</option>
                                <option value="0">Sin l√≠mite de tiempo</option>
                            </select>
                        </div>
                    </div>

                    ${state.topics.length > 0 ? `
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 15px; font-weight: 500;">Selecci√≥n de temas:</label>
                            <div style="display: grid; gap: 8px;">
                                <div class="custom-checkbox" onclick="toggleGeneralTest()">
                                    <input type="checkbox" id="test-general" onchange="handleGeneralTestChange(this)" checked>
                                    <span style="font-weight: 500;">Test General (${state.questions.length} preguntas)</span>
                                </div>
                                ${state.topics.map(topic => `
                                    <div class="custom-checkbox" onclick="toggleTopicTest('${topic.id}')">
                                        <input type="checkbox" class="topic-checkbox" data-topic-id="${topic.id}" onchange="handleTopicChange()">
                                        <span>${topic.name} (${getTopicQuestionCount(topic.id)} preguntas)</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div style="margin-top: 15px; padding: 10px; background: #f3f4f6; border-radius: 6px; font-size: 14px; color: #6b7280;">
                                üí° <strong>Consejo:</strong> Puedes seleccionar m√∫ltiples temas para crear un test combinado, o elegir "Test General" para incluir todas las preguntas.
                            </div>
                        </div>
                    ` : ''}

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Nombre del test:</label>
                        <input type="text" id="test-name" placeholder="Ej: Test de Matem√°ticas - Sesi√≥n 1" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                        <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                            Si no especificas un nombre, se generar√° autom√°ticamente
                        </div>
                    </div>
                </div>

                ${unresolvedFailed.length > 0 ? `
                    <div style="background: #fef2f2; border: 2px solid #ef4444; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="color: #dc2626; margin-bottom: 15px;">üîÑ Test de Repaso Disponible</h3>
                        <p style="color: #991b1b; margin-bottom: 15px;">
                            Tienes <strong>${unresolvedFailed.length} pregunta${unresolvedFailed.length === 1 ? '' : 's'}</strong> fallada${unresolvedFailed.length === 1 ? '' : 's'} esperando repaso.
                        </p>
                        <div style="text-align: center;">
                            <button onclick="startFailedQuestionsTest()" class="btn btn-danger" style="font-size: 1.1rem; padding: 12px 25px;">
                                üîÑ Test de Repaso (${unresolvedFailed.length} preguntas)
                            </button>
                        </div>
                        <div style="margin-top: 10px; font-size: 12px; color: #6b7280; text-align: center;">
                            Repasa solo las preguntas que has fallado anteriormente
                        </div>
                    </div>
                ` : ''}

                <div style="text-align: center; padding: 40px;">
                    <button onclick="startTest()" class="btn btn-primary" style="font-size: 1.2rem; padding: 15px 30px;">
                        üéØ Comenzar Test
                    </button>
                </div>
            `;
        }

        return renderCurrentTest();
    };

    // Extender la funci√≥n finishTest para manejar tests de repaso
    const originalFinishTest = finishTest;
    finishTest = function() {
        if (!state.currentTest) return;
        
        // Detener timer si existe
        if (state.currentTest.timer) {
            clearInterval(state.currentTest.timer);
        }
        
        // Recoger respuestas del formulario
        const form = document.getElementById('test-form');
        let correct = 0;
        let incorrect = 0;
        let unanswered = 0;
        const answers = {};
        const detailedResults = [];
        
        state.currentTest.questions.forEach((question, index) => {
            const selectedOption = form.querySelector(`input[name="question-${index}"]:checked`);
            let userAnswer = null;
            let isCorrect = false;
            
            if (selectedOption) {
                userAnswer = parseInt(selectedOption.value);
                answers[index] = userAnswer;
                if (userAnswer === question.correctAnswer) {
                    correct++;
                    isCorrect = true;
                } else {
                    incorrect++;
                }
            } else {
                unanswered++;
            }
            
            detailedResults.push({
                question: question,
                userAnswer: userAnswer,
                isCorrect: isCorrect
            });
        });
        
        const totalQuestions = state.currentTest.questions.length;
        
        // Calcular tiempo usado
        let timeUsedText = '';
        if (state.currentTest.duration > 0) {
            const timeUsed = state.currentTest.duration - state.currentTest.timeLeft;
            timeUsedText = `Tiempo empleado: ${formatTime(timeUsed)} de ${formatTime(state.currentTest.duration)}`;
        }
        
        // Crear objeto de resultado
        const testResult = {
            name: state.currentTest.name,
            correct: correct,
            incorrect: incorrect,
            unanswered: unanswered,
            total: totalQuestions,
            testType: state.currentTest.testTypeText,
            timeUsedText: timeUsedText,
            detailedResults: detailedResults,
            date: new Date().toLocaleString('es-ES'),
            id: Date.now(),
            isFailedQuestionsTest: state.currentTest.isFailedQuestionsTest || false
        };
        
        // A√±adir al historial
        state.testResults.push(testResult);
        localStorage.setItem('testResults', JSON.stringify(state.testResults));
        
        // Mostrar el resultado espec√≠fico
        state.currentViewingResult = testResult;
        
        // Mensaje especial para tests de repaso
        if (state.currentTest.isFailedQuestionsTest) {
            const resolvedCount = detailedResults.filter(r => r.isCorrect).length;
            if (resolvedCount > 0) {
                showMessage(`¬°Excelente! Has superado ${resolvedCount} pregunta${resolvedCount === 1 ? '' : 's'} que anteriormente hab√≠as fallado üéâ`, 'success');
            }
        }
        
        // Limpiar test actual y cambiar a pesta√±a de resultados
        state.currentTest = null;
        state.currentTab = 'results';
        render();
        
        // Hacer scroll al inicio de la p√°gina despu√©s de renderizar
        setTimeout(() => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 100);
    };

    console.log('‚úÖ Parche de preguntas falladas aplicado correctamente');
</script>
   
<script>
    // ========== CORRECCI√ìN FINAL: SISTEMA ROBUSTO DE PREGUNTAS FALLADAS ==========
    
    // REEMPLAZAR completamente la funci√≥n updateFailedQuestionsData
    function updateFailedQuestionsData() {
        const failedQuestions = [];
        
        console.log('üîç Analizando historial de tests...');
        
        // Paso 1: Recopilar todas las preguntas falladas con timestamps
        state.testResults.forEach((result, resultIndex) => {
            if (result.detailedResults) {
                result.detailedResults.forEach(detail => {
                    if (!detail.isCorrect && detail.userAnswer !== null) {
                        const questionId = detail.question.id;
                        
                        let existingFailed = failedQuestions.find(fq => fq.questionId === questionId);
                        
                        if (!existingFailed) {
                            existingFailed = {
                                questionId: questionId,
                                question: detail.question,
                                failedCount: 0,
                                failedTests: [],
                                isResolved: false,
                                resolvedTest: null
                            };
                            failedQuestions.push(existingFailed);
                        }
                        
                        existingFailed.failedCount++;
                        existingFailed.failedTests.push({
                            testName: result.name,
                            date: result.date,
                            timestamp: result.id,
                            resultIndex: resultIndex
                        });
                    }
                });
            }
        });

        console.log(`üìã Encontradas ${failedQuestions.length} preguntas √∫nicas falladas`);

        // Paso 2: Verificar resoluciones usando timestamps (m√°s confiable que fechas)
        failedQuestions.forEach(failedQ => {
            // Obtener el timestamp de la primera falla
            const firstFailTimestamp = Math.min(...failedQ.failedTests.map(ft => ft.timestamp));
            
            // Buscar tests posteriores a la primera falla
            const laterTests = state.testResults
                .filter(result => result.id > firstFailTimestamp)
                .sort((a, b) => a.id - b.id); // Ordenar por timestamp

            console.log(`üîç Pregunta ${failedQ.questionId}: Primera falla en timestamp ${firstFailTimestamp}, revisando ${laterTests.length} tests posteriores`);

            for (let result of laterTests) {
                if (result.detailedResults) {
                    const correctAnswer = result.detailedResults.find(detail => 
                        detail.question.id === failedQ.questionId && detail.isCorrect
                    );
                    
                    if (correctAnswer) {
                        failedQ.isResolved = true;
                        failedQ.resolvedTest = {
                            testName: result.name,
                            date: result.date,
                            timestamp: result.id
                        };
                        console.log(`‚úÖ Pregunta ${failedQ.questionId} RESUELTA en test "${result.name}" (timestamp: ${result.id})`);
                        break;
                    }
                }
            }
            
            if (!failedQ.isResolved) {
                console.log(`‚ùå Pregunta ${failedQ.questionId} A√öN PENDIENTE`);
            }
        });

        return failedQuestions;
    }

    // REEMPLAZAR la funci√≥n getUnresolvedFailedQuestions
    function getUnresolvedFailedQuestions() {
        const failedQuestions = updateFailedQuestionsData();
        const unresolved = failedQuestions.filter(fq => !fq.isResolved);
        
        console.log(`üìä RESUMEN FINAL:`);
        console.log(`   üî¥ Total preguntas falladas: ${failedQuestions.length}`);
        console.log(`   ‚úÖ Resueltas: ${failedQuestions.length - unresolved.length}`);
        console.log(`   ‚è≥ Pendientes: ${unresolved.length}`);
        
        if (unresolved.length > 0) {
            console.log(`üìù Preguntas pendientes:`);
            unresolved.forEach(fq => {
                console.log(`   - ID ${fq.questionId}: "${fq.question.question.substring(0, 50)}..."`);
            });
        }
        
        return unresolved;
    }

    // REEMPLAZAR finishTest con versi√≥n mejorada
    const originalFinishTestRobust = finishTest;
    finishTest = function() {
        if (!state.currentTest) return;
        
        const isFailedQuestionsTest = state.currentTest.isFailedQuestionsTest;
        
        console.log(`üèÅ Finalizando test: "${state.currentTest.name}" (Tipo: ${isFailedQuestionsTest ? 'REPASO' : 'NORMAL'})`);
        
        // Llamar a la funci√≥n original
        originalFinishTestRobust();
        
        // Si era un test de repaso, hacer an√°lisis completo
        if (isFailedQuestionsTest) {
            console.log('üîÑ AN√ÅLISIS POST-REPASO:');
            
            // Esperar un poco y luego actualizar
            setTimeout(() => {
                console.log('üìä Actualizando estado de preguntas falladas...');
                const unresolvedAfter = getUnresolvedFailedQuestions();
                
                // Si estamos en la pesta√±a de test, re-renderizar
                if (state.currentTab === 'test') {
                    console.log('üîÑ Re-renderizando interfaz...');
                    render();
                }
                
                // Mostrar resultado al usuario
                if (unresolvedAfter.length === 0) {
                    showMessage('üéâ ¬°Felicidades! Has superado todas tus preguntas falladas', 'success');
                } else {
                    showMessage(`‚ú® Progreso: Ahora tienes ${unresolvedAfter.length} pregunta${unresolvedAfter.length === 1 ? '' : 's'} pendiente${unresolvedAfter.length === 1 ? '' : 's'}`, 'success');
                }
                
            }, 500); // Dar tiempo para que se guarde el test
        }
    };

    // Funci√≥n de diagn√≥stico (opcional - para debugging)
    window.diagnosticarPreguntas = function() {
        console.log('üî¨ DIAGN√ìSTICO COMPLETO:');
        console.log('Tests en el historial:', state.testResults.length);
        state.testResults.forEach((test, i) => {
            console.log(`Test ${i}: "${test.name}" - ID: ${test.id} - Fecha: ${test.date}`);
        });
        
        const failed = updateFailedQuestionsData();
        console.log('An√°lisis de preguntas falladas completado');
    };

    console.log('üîß Correcci√≥n FINAL aplicada - Sistema robusto activado');
    console.log('üí° Puedes usar diagnosticarPreguntas() en la consola para debugging');
</script>
    <!-- 
PARCHE: SISTEMA DE CARPETAS COLAPSABLES EN BANCO DE PREGUNTAS
A√±adir este c√≥digo al final del archivo index.html, justo antes de </body>
Este parche permite ocultar/mostrar las carpetas de temas individualmente
-->

<script>
    // ========== PARCHE: SISTEMA DE CARPETAS COLAPSABLES ==========
    
    // Estado para controlar qu√© carpetas est√°n colapsadas
    let collapsedFolders = JSON.parse(localStorage.getItem('collapsedFolders') || '{}');
    
    // Funci√≥n para alternar el estado de una carpeta
    function toggleFolder(topicId) {
        collapsedFolders[topicId] = !collapsedFolders[topicId];
        localStorage.setItem('collapsedFolders', JSON.stringify(collapsedFolders));
        render();
    }
    
    // Funci√≥n para colapsar todas las carpetas
    function collapseAllFolders() {
        const allTopicIds = state.topics.map(t => t.id.toString());
        allTopicIds.forEach(id => {
            collapsedFolders[id] = true;
        });
        localStorage.setItem('collapsedFolders', JSON.stringify(collapsedFolders));
        render();
    }
    
    // Funci√≥n para expandir todas las carpetas
    function expandAllFolders() {
        collapsedFolders = {};
        localStorage.setItem('collapsedFolders', JSON.stringify(collapsedFolders));
        render();
    }
    
    // REEMPLAZAR la funci√≥n renderQuestionsByTopic con versi√≥n colapsable
    const originalRenderQuestionsByTopic = renderQuestionsByTopic;
    renderQuestionsByTopic = function() {
        const questionsWithoutTopic = state.questions.filter(q => !q.topicId);
        
        let html = '';
        
        // Botones de control global
        const hasTopicsWithQuestions = state.topics.some(topic => {
            return state.questions.filter(q => q.topicId && q.topicId.toString() === topic.id.toString()).length > 0;
        });
        
        if (hasTopicsWithQuestions) {
            html += `
                <div style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 2px solid #e2e8f0;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span style="font-weight: 500; color: #374151; margin-right: 10px;">Control de carpetas:</span>
                        <button onclick="expandAllFolders()" class="btn btn-info" style="padding: 6px 12px; font-size: 12px;">
                            üìÇ Expandir Todas
                        </button>
                        <button onclick="collapseAllFolders()" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;">
                            üìÅ Contraer Todas
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Mostrar preguntas por cada tema que TENGA preguntas
        state.topics.forEach(topic => {
            const topicQuestions = state.questions.filter(q => q.topicId && q.topicId.toString() === topic.id.toString());
            if (topicQuestions.length > 0) {
                const isCollapsed = collapsedFolders[topic.id.toString()];
                const chevronIcon = isCollapsed ? '‚ñ∂Ô∏è' : 'üîΩ';
                
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 onclick="toggleFolder('${topic.id}')" style="background: #4f46e5; color: white; padding: 10px 15px; border-radius: 8px 8px 0 0; margin: 0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; transition: all 0.2s;" 
                            onmouseover="this.style.background='#4338ca'" 
                            onmouseout="this.style.background='#4f46e5'">
                            <span style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 14px;">${chevronIcon}</span>
                                <span>üìÅ ${topic.name}</span>
                            </span>
                            <span style="font-size: 14px; opacity: 0.9;">${topicQuestions.length} pregunta${topicQuestions.length === 1 ? '' : 's'}</span>
                        </h3>
                        <div style="border: 1px solid #4f46e5; border-top: none; border-radius: 0 0 8px 8px; background: white; ${isCollapsed ? 'display: none;' : ''}">
                            ${topicQuestions.map(q => {
                                const actualIndex = state.questions.findIndex(question => question.id === q.id);
                                return renderSingleQuestion(q, actualIndex);
                            }).join('')}
                        </div>
                    </div>
                `;
            }
        });
        
        // Mostrar preguntas sin tema asignado SI existen
        if (questionsWithoutTopic.length > 0) {
            const noTopicCollapsed = collapsedFolders['no-topic'];
            const chevronIcon = noTopicCollapsed ? '‚ñ∂Ô∏è' : 'üîΩ';
            
            html += `
                <div style="margin-bottom: 30px;">
                    <h3 onclick="toggleFolder('no-topic')" style="background: #6b7280; color: white; padding: 10px 15px; border-radius: 8px 8px 0 0; margin: 0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; transition: all 0.2s;" 
                        onmouseover="this.style.background='#4b5563'" 
                        onmouseout="this.style.background='#6b7280'">
                        <span style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 14px;">${chevronIcon}</span>
                            <span>üìÇ Sin tema asignado</span>
                        </span>
                        <span style="font-size: 14px; opacity: 0.9;">${questionsWithoutTopic.length} pregunta${questionsWithoutTopic.length === 1 ? '' : 's'}</span>
                    </h3>
                    <div style="border: 1px solid #6b7280; border-top: none; border-radius: 0 0 8px 8px; background: white; ${noTopicCollapsed ? 'display: none;' : ''}">
                        ${questionsWithoutTopic.map(q => {
                            const actualIndex = state.questions.findIndex(question => question.id === q.id);
                            return renderSingleQuestion(q, actualIndex);
                        }).join('')}
                    </div>
                </div>
            `;
        }
        
        // Si no hay preguntas en absoluto
        if (html === '' || (!hasTopicsWithQuestions && questionsWithoutTopic.length === 0)) {
            return '<div style="padding: 40px; text-align: center; color: #9ca3af;">No hay preguntas disponibles en el banco</div>';
        }
        
        return html;
    };

    console.log('‚úÖ Parche de carpetas colapsables aplicado correctamente');
</script>
<!-- 
PARCHE: PANTALLA INTERMEDIA DESPU√âS DEL LOGIN
A√±adir este c√≥digo al final del archivo index.html, justo antes de </body>
Este parche a√±ade una pantalla de selecci√≥n entre login y las funciones principales
-->

<script>
    // ========== PARCHE: PANTALLA INTERMEDIA ==========
    
    // Nuevo estado para controlar la pantalla intermedia
    let showIntermediateScreen = false;
    
    // Interceptar la funci√≥n de login original
    const originalLogin = login;
    login = function() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        if (users[username] && users[username].password === password) {
            state.currentUser = users[username];
            showIntermediateScreen = true; // Mostrar pantalla intermedia
            render();
            showMessage(`Bienvenido ${users[username].name}`, 'success');
        } else {
            showMessage('Usuario o contrase√±a incorrectos', 'error');
        }
    };
    
    // Funci√≥n para ir a realizar tests
    function goToTests() {
        showIntermediateScreen = false;
        state.currentTab = 'upload';
        render();
    }
    
    // Funci√≥n para ir a ver res√∫menes
    function goToSummaries() {
        showIntermediateScreen = false;
        state.currentTab = 'results';
        render();
    }
    
    // Funci√≥n para renderizar la pantalla intermedia
    function renderIntermediateScreen() {
        return `
            <div style="min-height: 80vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: -30px; border-radius: 20px;">
                <div style="background: white; border-radius: 24px; padding: 60px; box-shadow: 0 25px 50px rgba(0,0,0,0.15); max-width: 600px; width: 100%; text-align: center; position: relative; overflow: hidden;">
                    
                    <!-- Decoraci√≥n de fondo -->
                    <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: linear-gradient(135deg, #667eea20, #764ba220); border-radius: 50%; z-index: 0;"></div>
                    <div style="position: absolute; bottom: -30px; left: -30px; width: 100px; height: 100px; background: linear-gradient(135deg, #764ba220, #667eea20); border-radius: 50%; z-index: 0;"></div>
                    
                    <!-- Contenido principal -->
                    <div style="position: relative; z-index: 1;">
                        <!-- Icono principal -->
                        <div style="background: linear-gradient(135deg, #667eea, #764ba2); width: 80px; height: 80px; border-radius: 20px; margin: 0 auto 30px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);">
                            <span style="font-size: 2.5rem; filter: drop-shadow(0 2px 4px rgba(255,255,255,0.3));">üéØ</span>
                        </div>
                        
                        <!-- T√≠tulo principal -->
                        <h1 style="font-size: 2.8rem; font-weight: 700; margin: 0 0 15px 0; background: linear-gradient(135deg, #2d3748, #4a5568); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                            ¬°Bienvenid@!
                        </h1>
                        
                        <!-- Subt√≠tulo -->
                        <p style="font-size: 1.3rem; color: #6b7280; margin: 0 0 50px 0; font-weight: 400; line-height: 1.5;">
                            Selecciona qu√© te gustar√≠a hacer hoy
                        </p>
                        
                        <!-- Botones principales -->
                        <div style="display: grid; gap: 25px; margin-bottom: 40px;">
                            
                            <!-- Bot√≥n Realizar Tests -->
                            <button onclick="goToTests()" style="
                                background: linear-gradient(135deg, #4f46e5, #7c3aed); 
                                border: none; 
                                border-radius: 16px; 
                                padding: 25px 40px; 
                                color: white; 
                                font-size: 1.3rem; 
                                font-weight: 600; 
                                cursor: pointer; 
                                transition: all 0.3s ease; 
                                box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);
                                position: relative;
                                overflow: hidden;
                                border: 2px solid transparent;
                                "
                                onmouseover="
                                    this.style.transform='translateY(-5px)'; 
                                    this.style.boxShadow='0 20px 40px rgba(79, 70, 229, 0.4)';
                                    this.style.background='linear-gradient(135deg, #6366f1, #8b5cf6)';
                                " 
                                onmouseout="
                                    this.style.transform='translateY(0)'; 
                                    this.style.boxShadow='0 10px 25px rgba(79, 70, 229, 0.3)';
                                    this.style.background='linear-gradient(135deg, #4f46e5, #7c3aed)';
                                ">
                                
                                <!-- Icono y texto -->
                                <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                                    <span style="font-size: 1.8rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));">üìö</span>
                                    <div style="text-align: left;">
                                        <div style="font-size: 1.3rem; font-weight: 700; margin-bottom: 3px;">Realizar Tests</div>
                                        <div style="font-size: 0.9rem; opacity: 0.9; font-weight: 400;">Crear y gestionar ex√°menes</div>
                                    </div>
                                </div>
                                
                                <!-- Efecto de brillo al hover -->
                                <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s ease;"></div>
                            </button>
                            
                            <!-- Bot√≥n Ver Res√∫menes -->
                            <button onclick="goToSummaries()" style="
                                background: linear-gradient(135deg, #059669, #0ea5e9); 
                                border: none; 
                                border-radius: 16px; 
                                padding: 25px 40px; 
                                color: white; 
                                font-size: 1.3rem; 
                                font-weight: 600; 
                                cursor: pointer; 
                                transition: all 0.3s ease; 
                                box-shadow: 0 10px 25px rgba(5, 150, 105, 0.3);
                                position: relative;
                                overflow: hidden;
                                border: 2px solid transparent;
                                "
                                onmouseover="
                                    this.style.transform='translateY(-5px)'; 
                                    this.style.boxShadow='0 20px 40px rgba(5, 150, 105, 0.4)';
                                    this.style.background='linear-gradient(135deg, #10b981, #06b6d4)';
                                " 
                                onmouseout="
                                    this.style.transform='translateY(0)'; 
                                    this.style.boxShadow='0 10px 25px rgba(5, 150, 105, 0.3)';
                                    this.style.background='linear-gradient(135deg, #059669, #0ea5e9)';
                                ">
                                
                                <!-- Icono y texto -->
                                <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                                    <span style="font-size: 1.8rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));">üìä</span>
                                    <div style="text-align: left;">
                                        <div style="font-size: 1.3rem; font-weight: 700; margin-bottom: 3px;">Ver Res√∫menes</div>
                                        <div style="font-size: 0.9rem; opacity: 0.9; font-weight: 400;">Analizar resultados y estad√≠sticas</div>
                                    </div>
                                </div>
                                
                                <!-- Efecto de brillo al hover -->
                                <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s ease;"></div>
                            </button>
                        </div>
                        
                        <!-- Footer info -->
                        <div style="border-top: 1px solid #e5e7eb; padding-top: 25px; color: #9ca3af; font-size: 0.9rem;">
                            <p style="margin: 0;">Sistema de Ex√°menes ‚Ä¢ Usuario: ${state.currentUser.name}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Interceptar la funci√≥n render original para mostrar la pantalla intermedia
    const originalRender = render;
    render = function() {
        if (showIntermediateScreen && state.currentUser) {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <div class="title">Sistema de Ex√°menes</div>
                        <div>
                            <span style="color: ${state.apiKey ? '#10b981' : '#ef4444'};">
                                ${state.apiKey ? '‚úÖ API Configurada' : '‚ùå Sin API'}
                            </span>
                            <button onclick="configureAPI()" class="btn btn-secondary">API</button>
                            <span style="color: #f59e0b;">üë§ ${state.currentUser.name}</span>
                            <button onclick="logout()" class="btn btn-danger">Salir</button>
                        </div>
                    </div>
                    ${renderIntermediateScreen()}
                </div>
            `;
        } else {
            // Usar la funci√≥n render original
            originalRender();
        }
    };
    
    // Interceptar logout para resetear la pantalla intermedia
    const originalLogout = logout;
    logout = function() {
        showIntermediateScreen = false;
        originalLogout();
    };
    
    console.log('‚úÖ Parche de pantalla intermedia aplicado correctamente');
</script>    
    <!-- 
PARCHE: PANTALLA DE RES√öMENES CON IA
A√±adir este c√≥digo al final del archivo index.html, justo antes de </body>
Este parche a√±ade una nueva funcionalidad para generar res√∫menes de im√°genes
-->

<script>
    // ========== PARCHE: SISTEMA DE RES√öMENES CON IA ==========
    
    // Nuevo estado para la funcionalidad de res√∫menes
    let summaryState = {
        selectedImages: [],
        generatedSummary: '',
        isProcessing: false
    };
    
    // Interceptar la funci√≥n goToSummaries para redirigir a la nueva pesta√±a
    const originalGoToSummaries = goToSummaries;
    goToSummaries = function() {
        showIntermediateScreen = false;
        state.currentTab = 'summary'; // Nueva pesta√±a
        render();
    };
    
    // Extender la funci√≥n renderTabContent para incluir la nueva pesta√±a
    const originalRenderTabContent = renderTabContent;
    renderTabContent = function() {
        switch(state.currentTab) {
            case 'upload':
                return renderUploadTab();
            case 'questions':
                return renderQuestionsTab();
            case 'test':
                return renderTestTab();
            case 'results':
                return renderResultsTab();
            case 'summary':
                return renderSummaryTab();
            default:
                return '<div>Error: Pesta√±a no encontrada</div>';
        }
    };
    
    // Funci√≥n para renderizar la pesta√±a de res√∫menes
    function renderSummaryTab() {
        return `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h2 style="color: #1f2937; margin: 0;">üìÑ Generador de Res√∫menes con IA</h2>
                    <p style="color: #6b7280; margin: 5px 0 0 0; font-size: 14px;">Sube una imagen y obt√©n un resumen inteligente del contenido</p>
                </div>
                <button onclick="backToIntermediateScreen()" class="btn btn-secondary">
                    ‚Üê Volver al Men√∫ Principal
                </button>
            </div>
            
            <div class="three-column">
                <div class="column">
                    <h3 style="margin-bottom: 15px;">üì§ Subir Imagen para Resumir</h3>
                    <div class="upload-area" onclick="document.getElementById('summaryImageInput').click()">
                        <div>üì∑ Seleccionar imagen</div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Una imagen por vez</div>
                        <div style="margin-top: 10px; color: #4f46e5; font-weight: 500;">
                            ${summaryState.selectedImages.length}/1 archivo
                        </div>
                    </div>
                    <input type="file" id="summaryImageInput" style="display: none;" accept="image/*">
                    
                    ${summaryState.selectedImages.length > 0 ? `
                        <div style="margin-bottom: 15px; padding: 15px; background: #f3f4f6; border-radius: 8px; text-align: center;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 12px; word-break: break-all; flex: 1;">${summaryState.selectedImages[0].name}</div>
                                <button onclick="removeSummaryImage()" style="background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; cursor: pointer; margin-left: 10px;">√ó</button>
                            </div>
                        </div>
                    ` : ''}
                    
                    <button onclick="generateSummary()" class="btn btn-primary" style="width: 100%;" ${summaryState.selectedImages.length === 0 || !state.apiKey || summaryState.isProcessing ? 'disabled' : ''}>
                        ${summaryState.isProcessing ? 'üîÑ Generando Resumen...' : 'ü§ñ Generar Resumen'}
                    </button>
                    
                    ${summaryState.isProcessing ? `
                        <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; text-align: center;">
                            <span style="color: #92400e;">üîÑ Procesando imagen y generando resumen...</span>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px;">
                        <h4 style="color: #0c4a6e; margin-bottom: 10px;">üí° Consejos para mejores res√∫menes</h4>
                        <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #0369a1;">
                            <li>Usa im√°genes con texto claro y legible</li>
                            <li>Evita im√°genes muy peque√±as o borrosas</li>
                            <li>Funciona mejor con documentos, art√≠culos, o capturas de pantalla</li>
                            <li>El resumen se adaptar√° al tipo de contenido detectado</li>
                        </ul>
                    </div>
                </div>

                <div class="column">
                    <h3 style="margin-bottom: 15px;">üìù Resumen Generado</h3>
                    <textarea id="generatedSummary" class="textarea" placeholder="El resumen aparecer√° aqu√≠ una vez que proceses una imagen..." readonly>${summaryState.generatedSummary}</textarea>
                    
                    ${summaryState.generatedSummary ? `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                            <button onclick="copySummaryToClipboard()" class="btn btn-info" style="width: 100%; padding: 8px; font-size: 13px;">
                                üìã Copiar al Portapapeles
                            </button>
                            <button onclick="clearSummary()" class="btn btn-secondary" style="width: 100%; padding: 8px; font-size: 13px;">
                                üóëÔ∏è Limpiar Resumen
                            </button>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 15px; background: #f0fdf4; border: 2px solid #22c55e; border-radius: 8px;">
                            <h4 style="color: #166534; margin-bottom: 10px;">‚úÖ ¬°Resumen generado exitosamente!</h4>
                            <p style="margin: 0; font-size: 13px; color: #16a34a;">
                                Puedes copiar el texto, procesarlo nuevamente, o subir una nueva imagen.
                            </p>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    // Funci√≥n para volver a la pantalla intermedia
    function backToIntermediateScreen() {
        showIntermediateScreen = true;
        state.currentTab = 'upload'; // Reset tab
        render();
    }
    
    // Funci√≥n para manejar la selecci√≥n de imagen
    function handleSummaryImageSelection() {
        document.addEventListener('change', function(e) {
            if (e.target && e.target.id === 'summaryImageInput') {
                const files = Array.from(e.target.files);
                const imageFile = files.filter(file => file.type.startsWith('image/'))[0];
                
                if (imageFile) {
                    summaryState.selectedImages = [imageFile];
                    summaryState.generatedSummary = ''; // Limpiar resumen anterior
                    render();
                    showMessage('Imagen seleccionada correctamente', 'success');
                }
            }
        });
    }
    
    // Funci√≥n para eliminar la imagen seleccionada
    function removeSummaryImage() {
        summaryState.selectedImages = [];
        summaryState.generatedSummary = '';
        render();
        showMessage('Imagen eliminada', 'success');
    }
    
    // Funci√≥n principal para generar resumen
    async function generateSummary() {
        if (!state.apiKey) {
            showMessage('Configura tu API key primero', 'error');
            return;
        }

        if (summaryState.selectedImages.length === 0) {
            showMessage('Selecciona una imagen primero', 'error');
            return;
        }

        summaryState.isProcessing = true;
        render();
        showMessage('Generando resumen...', 'success');
        
        try {
            const file = summaryState.selectedImages[0];
            const base64 = await fileToBase64(file);
            
            const messageContent = [
                {
                    type: "image",
                    source: {
                        type: "base64",
                        media_type: file.type,
                        data: base64
                    }
                },
                {
                    type: "text",
                    text: `Act√∫a como un asistente experto en an√°lisis y s√≠ntesis de informaci√≥n. Analiza esta imagen y genera un resumen completo e inteligente del contenido.

INSTRUCCIONES PARA EL RESUMEN:

üéØ OBJETIVO: Crear un resumen estructurado, claro y √∫til que capture la esencia del contenido

üìã FORMATO DEL RESUMEN:
‚Ä¢ Comienza con una breve descripci√≥n del tipo de documento/contenido
‚Ä¢ Organiza la informaci√≥n en secciones l√≥gicas con encabezados
‚Ä¢ Usa vi√±etas y numeraci√≥n cuando sea apropiado
‚Ä¢ Incluye los puntos m√°s importantes y relevantes
‚Ä¢ Termina con conclusiones o puntos clave si es relevante

üîç QU√â INCLUIR:
- Ideas principales y conceptos clave
- Datos importantes, cifras, fechas relevantes
- Argumentos o puntos de vista presentados
- Conclusiones o recomendaciones si las hay
- Cualquier informaci√≥n pr√°ctica o accionable

‚ú® ESTILO:
- Lenguaje claro y profesional
- Oraciones concisas pero informativas  
- Estructura f√°cil de leer y escanear
- Adapta el tono al tipo de contenido (acad√©mico, empresarial, t√©cnico, etc.)

üö´ EVITA:
- Repetir informaci√≥n innecesaria
- Incluir detalles muy t√©cnicos a menos que sean cruciales
- Hacer el resumen demasiado largo (m√°ximo 500 palabras)
- Copiar texto textualmente sin reorganizar

Genera un resumen que sea verdaderamente √∫til para alguien que quiere entender r√°pidamente el contenido esencial del documento.`
                }
            ];

            const response = await fetch("/api/anthropic", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-api-key": state.apiKey,
                },
                body: JSON.stringify({
                    model: "claude-sonnet-4-20250514",
                    max_tokens: 2000,
                    messages: [{
                        role: "user",
                        content: messageContent
                    }]
                })
            });

            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            summaryState.generatedSummary = data.content[0].text;
            summaryState.isProcessing = false;
            
            render();
            
            
        } catch (error) {
            summaryState.isProcessing = false;
            render();
            showMessage(`Error al generar resumen: ${error.message}`, 'error');
        }
    }
    
    // Funci√≥n para copiar el resumen al portapapeles
    async function copySummaryToClipboard() {
        try {
            await navigator.clipboard.writeText(summaryState.generatedSummary);
            showMessage('Resumen copiado al portapapeles', 'success');
        } catch (error) {
            // Fallback para navegadores que no soportan clipboard API
            const textArea = document.createElement('textarea');
            textArea.value = summaryState.generatedSummary;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showMessage('Resumen copiado al portapapeles', 'success');
            } catch (err) {
                showMessage('Error al copiar. Selecciona y copia manualmente', 'error');
            }
            document.body.removeChild(textArea);
        }
    }
    
    // Funci√≥n para limpiar el resumen
    function clearSummary() {
        if (confirm('¬øLimpiar el resumen generado?')) {
            summaryState.generatedSummary = '';
            render();
            showMessage('Resumen limpiado', 'success');
        }
    }
    
    // Extender la funci√≥n setTab para incluir la nueva pesta√±a
    const originalSetTab = setTab;
    setTab = function(tab) {
        state.currentTab = tab;
        state.currentViewingResult = null;
        
        // Si vamos a summary, asegurar que no se muestre la pantalla intermedia
        if (tab === 'summary') {
            showIntermediateScreen = false;
        }
        
        render();
    };
    
    // Extender el sistema de navegaci√≥n para incluir la nueva pesta√±a
    const originalRender = render;
    render = function() {
        if (showIntermediateScreen && state.currentUser) {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <div class="title">Sistema de Ex√°menes</div>
                        <div>
                            <span style="color: ${state.apiKey ? '#10b981' : '#ef4444'};">
                                ${state.apiKey ? '‚úÖ API Configurada' : '‚ùå Sin API'}
                            </span>
                            <button onclick="configureAPI()" class="btn btn-secondary">API</button>
                            <span style="color: #f59e0b;">üë§ ${state.currentUser.name}</span>
                            <button onclick="logout()" class="btn btn-danger">Salir</button>
                        </div>
                    </div>
                    ${renderIntermediateScreen()}
                </div>
            `;
        } else if (state.currentUser) {
            const app = document.getElementById('app');
            
            // Determinar el t√≠tulo seg√∫n la pesta√±a actual
            let pageTitle = 'Sistema de Ex√°menes';
            if (state.currentTab === 'questions') pageTitle = 'Banco de Preguntas';
            else if (state.currentTab === 'results') pageTitle = 'Resultados del Test';
            else if (state.currentTab === 'summary') pageTitle = 'Generador de Res√∫menes';
            
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <div class="title">${pageTitle}</div>
                        <div>
                            <span style="color: ${state.apiKey ? '#10b981' : '#ef4444'};">
                                ${state.apiKey ? '‚úÖ API Configurada' : '‚ùå Sin API'}
                            </span>
                            <button onclick="configureAPI()" class="btn btn-secondary">API</button>
                            <span style="color: #f59e0b;">üë§ ${state.currentUser.name}</span>
                            <button onclick="logout()" class="btn btn-danger">Salir</button>
                        </div>
                    </div>

                    ${state.currentTab !== 'summary' ? `
                        <div class="nav-tabs">
                            <button class="nav-tab ${state.currentTab === 'upload' ? 'active' : ''}" onclick="setTab('upload')">
                                üì§ Subir Test
                            </button>
                            <button class="nav-tab ${state.currentTab === 'questions' ? 'active' : ''}" onclick="setTab('questions')">
                                üìã Banco de Preguntas (${getFilteredQuestions().length})
                            </button>
                            <button class="nav-tab ${state.currentTab === 'test' ? 'active' : ''}" onclick="setTab('test')">
                                üéØ Test Aleatorio
                            </button>
                            <button class="nav-tab ${state.currentTab === 'results' ? 'active' : ''}" onclick="setTab('results')">
                                üìä Resultados (${state.testResults.length})
                            </button>
                        </div>
                    ` : ''}

                    <div id="messages"></div>

                    ${renderTabContent()}
                </div>
            `;
        } else {
            // Usuario no logueado - mostrar login
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <div class="login-form">
                        <h2 style="text-align: center; margin-bottom: 30px;">Iniciar Sesi√≥n</h2>
                        <div class="form-group">
                            <label class="form-label">Usuario</label>
                            <input type="text" id="username" class="form-input" placeholder="demo">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contrase√±a</label>
                            <input type="password" id="password" class="form-input" placeholder="demo123">
                        </div>
                        <button onclick="login()" class="btn btn-primary" style="width: 100%;">
                            Iniciar Sesi√≥n
                        </button>
                        <div style="text-align: center; margin-top: 15px; color: #6b7280; font-size: 14px;">
                            Usuario: demo | Contrase√±a: demo123
                        </div>
                    </div>
                </div>
            `;
        }
    };
    
    // Inicializar el event listener para im√°genes de resumen
    handleSummaryImageSelection();
    
    console.log('‚úÖ Parche de pantalla de res√∫menes aplicado correctamente');
</script>
    <!-- 
PARCHE CORRECCI√ìN: REDIRECCI√ìN CORRECTA A PANTALLA DE RES√öMENES
A√±adir este c√≥digo al final del archivo index.html, justo antes de </body>
Este parche corrige el problema de redirecci√≥n a la pantalla de res√∫menes
-->

<script>
    // ========== CORRECCI√ìN: REDIRECCI√ìN A RES√öMENES ==========
    
    // Forzar la redefinici√≥n correcta de goToSummaries
    goToSummaries = function() {
        showIntermediateScreen = false;
        state.currentTab = 'summary';
        render();
    };
    
    console.log('‚úÖ Parche de correcci√≥n de res√∫menes aplicado correctamente');
</script>
    <!-- 
PARCHE CORRECCI√ìN FINAL: FUNCI√ìN RENDERTABCONTENT COMPLETA
A√±adir este c√≥digo al final del archivo index.html, justo antes de </body>
Este parche REEMPLAZA completamente la funci√≥n renderTabContent para incluir 'summary'
-->

<script>
    // ========== CORRECCI√ìN FINAL: REEMPLAZAR RENDERTABCONTENT ==========
    
    // REEMPLAZAR completamente la funci√≥n renderTabContent
    renderTabContent = function() {
        switch(state.currentTab) {
            case 'upload':
                return renderUploadTab();
            case 'questions':
                return renderQuestionsTab();
            case 'test':
                return renderTestTab();
            case 'results':
                return renderResultsTab();
            case 'summary':
                return renderSummaryTab();
            default:
                return '<div>Error: Pesta√±a no encontrada - ' + state.currentTab + '</div>';
        }
    };
    
    // ASEGURAR que goToSummaries funcione correctamente
    goToSummaries = function() {
        showIntermediateScreen = false;
        state.currentTab = 'summary';
        console.log('Cambiando a pesta√±a summary');
        render();
    };
    
    console.log('‚úÖ Correcci√≥n FINAL aplicada - Pesta√±a summary habilitada');
</script>
    <!-- 
PARCHE URGENTE: DEFINIR FUNCI√ìN RENDERSUMMARYTAB
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
Este parche define la funci√≥n renderSummaryTab que falta
-->

<script>
    // ========== PARCHE URGENTE: FUNCI√ìN RENDERSUMMARYTAB ==========
    
    // Definir la funci√≥n renderSummaryTab globalmente
    function renderSummaryTab() {
        return `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h2 style="color: #1f2937; margin: 0;">üìÑ Generador de Res√∫menes con IA</h2>
                    <p style="color: #6b7280; margin: 5px 0 0 0; font-size: 14px;">Sube una imagen y obt√©n un resumen inteligente del contenido</p>
                </div>
                <button onclick="backToIntermediateScreen()" class="btn btn-secondary">
                    ‚Üê Volver al Men√∫ Principal
                </button>
            </div>
            
            <div class="three-column">
                <div class="column">
                    <h3 style="margin-bottom: 15px;">üì§ Subir Imagen para Resumir</h3>
                    <div class="upload-area" onclick="document.getElementById('summaryImageInput').click()">
                        <div>üì∑ Seleccionar imagen</div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Una imagen por vez</div>
                        <div style="margin-top: 10px; color: #4f46e5; font-weight: 500;">
                            ${summaryState.selectedImages.length}/1 archivo
                        </div>
                    </div>
                    <input type="file" id="summaryImageInput" style="display: none;" accept="image/*">
                    
                    ${summaryState.selectedImages.length > 0 ? `
                        <div style="margin-bottom: 15px; padding: 15px; background: #f3f4f6; border-radius: 8px; text-align: center;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 12px; word-break: break-all; flex: 1;">${summaryState.selectedImages[0].name}</div>
                                <button onclick="removeSummaryImage()" style="background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; cursor: pointer; margin-left: 10px;">√ó</button>
                            </div>
                        </div>
                    ` : ''}
                    
                    <button onclick="generateSummary()" class="btn btn-primary" style="width: 100%;" ${summaryState.selectedImages.length === 0 || !state.apiKey || summaryState.isProcessing ? 'disabled' : ''}>
                        ${summaryState.isProcessing ? 'üîÑ Generando Resumen...' : 'ü§ñ Generar Resumen'}
                    </button>
                    
                    ${summaryState.isProcessing ? `
                        <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; text-align: center;">
                            <span style="color: #92400e;">üîÑ Procesando imagen y generando resumen...</span>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px;">
                        <h4 style="color: #0c4a6e; margin-bottom: 10px;">üí° Consejos para mejores res√∫menes</h4>
                        <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #0369a1;">
                            <li>Usa im√°genes con texto claro y legible</li>
                            <li>Evita im√°genes muy peque√±as o borrosas</li>
                            <li>Funciona mejor con documentos, art√≠culos, o capturas de pantalla</li>
                            <li>El resumen se adaptar√° al tipo de contenido detectado</li>
                        </ul>
                    </div>
                </div>

                <div class="column">
                    <h3 style="margin-bottom: 15px;">üìù Resumen Generado</h3>
                    <textarea id="generatedSummary" class="textarea" placeholder="El resumen aparecer√° aqu√≠ una vez que proceses una imagen..." readonly>${summaryState.generatedSummary}</textarea>
                    
                    ${summaryState.generatedSummary ? `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                            <button onclick="copySummaryToClipboard()" class="btn btn-info" style="width: 100%; padding: 8px; font-size: 13px;">
                                üìã Copiar al Portapapeles
                            </button>
                            <button onclick="clearSummary()" class="btn btn-secondary" style="width: 100%; padding: 8px; font-size: 13px;">
                                üóëÔ∏è Limpiar Resumen
                            </button>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 15px; background: #f0fdf4; border: 2px solid #22c55e; border-radius: 8px;">
                            <h4 style="color: #166534; margin-bottom: 10px;">‚úÖ ¬°Resumen generado exitosamente!</h4>
                            <p style="margin: 0; font-size: 13px; color: #16a34a;">
                                Puedes copiar el texto, procesarlo nuevamente, o subir una nueva imagen.
                            </p>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    // Asegurar que las funciones auxiliares est√©n definidas
    function backToIntermediateScreen() {
        showIntermediateScreen = true;
        state.currentTab = 'upload';
        render();
    }
    
    function removeSummaryImage() {
        summaryState.selectedImages = [];
        summaryState.generatedSummary = '';
        render();
        showMessage('Imagen eliminada', 'success');
    }
    
    async function generateSummary() {
        if (!state.apiKey) {
            showMessage('Configura tu API key primero', 'error');
            return;
        }

        if (summaryState.selectedImages.length === 0) {
            showMessage('Selecciona una imagen primero', 'error');
            return;
        }

        summaryState.isProcessing = true;
        render();
        showMessage('Generando resumen...', 'success');
        
        try {
            const file = summaryState.selectedImages[0];
            const base64 = await fileToBase64(file);
            
            const messageContent = [
                {
                    type: "image",
                    source: {
                        type: "base64",
                        media_type: file.type,
                        data: base64
                    }
                },
                {
                    type: "text",
                    text: `Act√∫a como un asistente experto en an√°lisis y s√≠ntesis de informaci√≥n. Analiza esta imagen y genera un resumen completo e inteligente del contenido.

INSTRUCCIONES PARA EL RESUMEN:

üéØ OBJETIVO: Crear un resumen estructurado, claro y √∫til que capture la esencia del contenido

üìã FORMATO DEL RESUMEN:
‚Ä¢ Comienza con una breve descripci√≥n del tipo de documento/contenido
‚Ä¢ Organiza la informaci√≥n en secciones l√≥gicas con encabezados
‚Ä¢ Usa vi√±etas y numeraci√≥n cuando sea apropiado
‚Ä¢ Incluye los puntos m√°s importantes y relevantes
‚Ä¢ Termina con conclusiones o puntos clave si es relevante

üîç QU√â INCLUIR:
- Ideas principales y conceptos clave
- Datos importantes, cifras, fechas relevantes
- Argumentos o puntos de vista presentados
- Conclusiones o recomendaciones si las hay
- Cualquier informaci√≥n pr√°ctica o accionable

‚ú® ESTILO:
- Lenguaje claro y profesional
- Oraciones concisas pero informativas  
- Estructura f√°cil de leer y escanear
- Adapta el tono al tipo de contenido (acad√©mico, empresarial, t√©cnico, etc.)

üö´ EVITA:
- Repetir informaci√≥n innecesaria
- Incluir detalles muy t√©cnicos a menos que sean cruciales
- Hacer el resumen demasiado largo (m√°ximo 500 palabras)
- Copiar texto textualmente sin reorganizar

Genera un resumen que sea verdaderamente √∫til para alguien que quiere entender r√°pidamente el contenido esencial del documento.`
                }
            ];

            const response = await fetch("/api/anthropic", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-api-key": state.apiKey,
                },
                body: JSON.stringify({
                    model: "claude-sonnet-4-20250514",
                    max_tokens: 2000,
                    messages: [{
                        role: "user",
                        content: messageContent
                    }]
                })
            });

            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            summaryState.generatedSummary = data.content[0].text;
            summaryState.isProcessing = false;
            
            render();
            showMessage('¬°Resumen generado exitosamente!', 'success');
            
        } catch (error) {
            summaryState.isProcessing = false;
            render();
            showMessage(`Error al generar resumen: ${error.message}`, 'error');
        }
    }
    
    async function copySummaryToClipboard() {
        try {
            await navigator.clipboard.writeText(summaryState.generatedSummary);
            showMessage('Resumen copiado al portapapeles', 'success');
        } catch (error) {
            const textArea = document.createElement('textarea');
            textArea.value = summaryState.generatedSummary;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showMessage('Resumen copiado al portapapeles', 'success');
            } catch (err) {
                showMessage('Error al copiar. Selecciona y copia manualmente', 'error');
            }
            document.body.removeChild(textArea);
        }
    }
    
    function clearSummary() {
        if (confirm('¬øLimpiar el resumen generado?')) {
            summaryState.generatedSummary = '';
            render();
            showMessage('Resumen limpiado', 'success');
        }
    }
    
    // Asegurar que summaryState est√© definido
    if (typeof summaryState === 'undefined') {
        window.summaryState = {
            selectedImages: [],
            generatedSummary: '',
            isProcessing: false
        };
    }
    
    // Event listener para selecci√≥n de im√°genes
    document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'summaryImageInput') {
            const files = Array.from(e.target.files);
            const imageFile = files.filter(file => file.type.startsWith('image/'))[0];
            
            if (imageFile) {
                summaryState.selectedImages = [imageFile];
                summaryState.generatedSummary = '';
                render();
                showMessage('Imagen seleccionada correctamente', 'success');
            }
        }
    });
    
    console.log('üîß PARCHE URGENTE aplicado - Funci√≥n renderSummaryTab definida correctamente');
</script>
    <!-- 
PARCHE COMPLETO: SISTEMA DE RES√öMENES INDEPENDIENTE CON TEMAS
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
Este parche reemplaza el sistema de res√∫menes con uno completo e independiente
-->

<script>
    // ========== PARCHE COMPLETO: SISTEMA DE RES√öMENES CON TEMAS ==========
    
    // Estado espec√≠fico para el sistema de res√∫menes
    let summarySystemState = {
        selectedImages: [],
        generatedSummary: '',
        isProcessing: false,
        summaryTopics: JSON.parse(localStorage.getItem('summaryTopics') || '[]'),
        savedSummaries: JSON.parse(localStorage.getItem('savedSummaries') || '[]'),
        selectedTopicForSummary: null,
        currentView: 'create', // 'create' | 'library'
        viewingSummary: null
    };
    
    // REEMPLAZAR completamente la funci√≥n renderSummaryTab
    function renderSummaryTab() {
        if (summarySystemState.currentView === 'library') {
            return renderSummaryLibrary();
        } else if (summarySystemState.viewingSummary) {
            return renderViewSummary();
        } else {
            return renderCreateSummary();
        }
    }
    
    // Funci√≥n para renderizar la creaci√≥n de res√∫menes
    function renderCreateSummary() {
        return `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h2 style="color: #1f2937; margin: 0;">üìÑ Crear Nuevo Resumen</h2>
                    <p style="color: #6b7280; margin: 5px 0 0 0; font-size: 14px;">Sube una imagen y obt√©n un resumen inteligente del contenido</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="showSummaryLibrary()" class="btn btn-info">
                        üìö Ver Biblioteca
                    </button>
                    <button onclick="backToIntermediateScreen()" class="btn btn-secondary">
                        ‚Üê Volver al Men√∫ Principal
                    </button>
                </div>
            </div>
            
            <div class="three-column">
                <div class="column">
                    <h3 style="margin-bottom: 15px;">üì§ Subir Imagen para Resumir</h3>
                    <div class="upload-area" onclick="document.getElementById('summaryImageInput').click()">
                        <div>üì∑ Seleccionar imagen</div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Una imagen por vez</div>
                        <div style="margin-top: 10px; color: #4f46e5; font-weight: 500;">
                            ${summarySystemState.selectedImages.length}/1 archivo
                        </div>
                    </div>
                    <input type="file" id="summaryImageInput" style="display: none;" accept="image/*">
                    
                    ${summarySystemState.selectedImages.length > 0 ? `
                        <div style="margin-bottom: 15px; padding: 15px; background: #f3f4f6; border-radius: 8px; text-align: center;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 12px; word-break: break-all; flex: 1;">${summarySystemState.selectedImages[0].name}</div>
                                <button onclick="removeSummaryImage()" style="background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; cursor: pointer; margin-left: 10px;">√ó</button>
                            </div>
                        </div>
                    ` : ''}
                    
                    <button onclick="generateSummary()" class="btn btn-primary" style="width: 100%; margin-bottom: 15px;" ${summarySystemState.selectedImages.length === 0 || !state.apiKey || summarySystemState.isProcessing ? 'disabled' : ''}>
                        ${summarySystemState.isProcessing ? 'üîÑ Generando Resumen...' : 'ü§ñ Generar Resumen'}
                    </button>
                    
                    ${summarySystemState.isProcessing ? `
                        <div style="margin-bottom: 15px; padding: 15px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; text-align: center;">
                            <span style="color: #92400e;">üîÑ Procesando imagen y generando resumen...</span>
                        </div>
                    ` : ''}
                    
                    <!-- Gesti√≥n de Temas para Res√∫menes -->
                    <div style="padding: 15px; background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px;">
                        <h4 style="color: #0c4a6e; margin-bottom: 15px;">üè∑Ô∏è Organizar por Temas</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <button onclick="createSummaryTopic()" class="btn btn-info" style="width: 100%; padding: 8px; font-size: 13px;">
                                üÜï Crear Tema
                            </button>
                            
                            <select id="summary-topic-selector" onchange="updateSelectedSummaryTopic()" style="width: 100%; padding: 8px; border: none; background: #0ea5e9; color: white; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer;" ${summarySystemState.summaryTopics.length === 0 ? 'disabled' : ''}>
                                <option value="">üìÇ Seleccionar Tema</option>
                                ${summarySystemState.summaryTopics.map(topic => `
                                    <option value="${topic.id}" ${summarySystemState.selectedTopicForSummary === topic.id ? 'selected' : ''}>
                                        ${topic.name} (${getSummaryTopicCount(topic.id)})
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        ${summarySystemState.summaryTopics.length === 0 ? `
                            <div style="font-size: 12px; color: #0c4a6e; font-style: italic; text-align: center;">
                                Crea temas para organizar tus res√∫menes
                            </div>
                        ` : ''}
                    </div>
                </div>

                <div class="column">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">üìù Resumen Generado</h3>
                        ${summarySystemState.generatedSummary ? `
                            <button onclick="saveSummaryToLibrary()" class="btn btn-success" style="padding: 6px 12px; font-size: 12px;">
                                üíæ Guardar
                            </button>
                        ` : ''}
                    </div>
                    
                    <textarea id="generatedSummary" class="textarea" placeholder="El resumen aparecer√° aqu√≠ una vez que proceses una imagen..." readonly>${summarySystemState.generatedSummary}</textarea>
                    
                    ${summarySystemState.generatedSummary ? `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                            <button onclick="copySummaryToClipboard()" class="btn btn-info" style="width: 100%; padding: 8px; font-size: 13px;">
                                üìã Copiar al Portapapeles
                            </button>
                            <button onclick="clearCurrentSummary()" class="btn btn-secondary" style="width: 100%; padding: 8px; font-size: 13px;">
                                üóëÔ∏è Limpiar Resumen
                            </button>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 15px; background: #f0fdf4; border: 2px solid #22c55e; border-radius: 8px;">
                            <h4 style="color: #166534; margin-bottom: 10px;">‚úÖ ¬°Resumen generado exitosamente!</h4>
                            <p style="margin: 0; font-size: 13px; color: #16a34a;">
                                Puedes guardar este resumen, copiarlo al portapapeles, o crear uno nuevo.
                            </p>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    // Funci√≥n para renderizar la biblioteca de res√∫menes
    function renderSummaryLibrary() {
        return `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h2 style="color: #1f2937; margin: 0;">üìö Biblioteca de Res√∫menes</h2>
                    <p style="color: #6b7280; margin: 5px 0 0 0; font-size: 14px;">Explora tus res√∫menes organizados por temas</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="showCreateSummary()" class="btn btn-primary">
                        ‚ûï Crear Nuevo
                    </button>
                    <button onclick="backToIntermediateScreen()" class="btn btn-secondary">
                        ‚Üê Volver al Men√∫ Principal
                    </button>
                </div>
            </div>
            
            ${summarySystemState.savedSummaries.length === 0 ? `
                <div style="text-align: center; padding: 80px; color: #9ca3af;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üìÑ</div>
                    <h3 style="color: #6b7280; margin-bottom: 15px;">No hay res√∫menes guardados</h3>
                    <p style="color: #9ca3af; margin-bottom: 30px;">Crea tu primer resumen para comenzar tu biblioteca</p>
                    <button onclick="showCreateSummary()" class="btn btn-primary" style="font-size: 1.1rem; padding: 15px 30px;">
                        üìÑ Crear Primer Resumen
                    </button>
                </div>
            ` : renderSummariesByTopic()}
        `;
    }
    
    // Funci√≥n para renderizar res√∫menes agrupados por tema
    function renderSummariesByTopic() {
        const summariesWithoutTopic = summarySystemState.savedSummaries.filter(s => !s.topicId);
        let html = '';
        
        // Control de temas
        if (summarySystemState.summaryTopics.length > 0) {
            html += `
                <div style="margin-bottom: 30px; padding: 20px; background: #f8fafc; border-radius: 12px; border: 2px solid #e2e8f0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="color: #374151; margin: 0 0 5px 0;">Control de Biblioteca</h3>
                            <p style="color: #6b7280; margin: 0; font-size: 14px;">Tienes ${summarySystemState.savedSummaries.length} res√∫men${summarySystemState.savedSummaries.length === 1 ? '' : 'es'} en ${summarySystemState.summaryTopics.length} tema${summarySystemState.summaryTopics.length === 1 ? '' : 's'}</p>
                        </div>
                        <button onclick="clearAllSummaries()" class="btn btn-danger" style="padding: 8px 16px;">
                            üóëÔ∏è Limpiar Todo
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Mostrar res√∫menes por cada tema que TENGA res√∫menes
        summarySystemState.summaryTopics.forEach(topic => {
            const topicSummaries = summarySystemState.savedSummaries.filter(s => s.topicId && s.topicId.toString() === topic.id.toString());
            if (topicSummaries.length > 0) {
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="background: linear-gradient(135deg, #059669, #0ea5e9); color: white; padding: 15px 20px; border-radius: 12px 12px 0 0; margin: 0; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <span style="display: flex; align-items: center; gap: 10px;">
                                <span>üìÇ</span>
                                <span>${topic.name}</span>
                            </span>
                            <span style="font-size: 14px; opacity: 0.9; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px;">
                                ${topicSummaries.length} res√∫men${topicSummaries.length === 1 ? '' : 'es'}
                            </span>
                        </h3>
                        <div style="background: white; border: 2px solid #e2e8f0; border-top: none; border-radius: 0 0 12px 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <div style="display: grid; gap: 0;">
                                ${topicSummaries.map((summary, index) => renderSingleSummary(summary, index)).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
        });
        
        // Mostrar res√∫menes sin tema asignado SI existen
        if (summariesWithoutTopic.length > 0) {
            html += `
                <div style="margin-bottom: 30px;">
                    <h3 style="background: #6b7280; color: white; padding: 15px 20px; border-radius: 12px 12px 0 0; margin: 0; display: flex; justify-content: space-between; align-items: center;">
                        <span style="display: flex; align-items: center; gap: 10px;">
                            <span>üìÑ</span>
                            <span>Sin tema asignado</span>
                        </span>
                        <span style="font-size: 14px; opacity: 0.9; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px;">
                            ${summariesWithoutTopic.length} res√∫men${summariesWithoutTopic.length === 1 ? '' : 'es'}
                        </span>
                    </h3>
                    <div style="background: white; border: 2px solid #e2e8f0; border-top: none; border-radius: 0 0 12px 12px;">
                        <div style="display: grid; gap: 0;">
                            ${summariesWithoutTopic.map((summary, index) => renderSingleSummary(summary, index)).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        if (html === '') {
            return '<div style="padding: 40px; text-align: center; color: #9ca3af;">No hay res√∫menes disponibles en la biblioteca</div>';
        }
        
        return html;
    }
    
    // Funci√≥n para renderizar un resumen individual
    function renderSingleSummary(summary, index) {
        const actualIndex = summarySystemState.savedSummaries.findIndex(s => s.id === summary.id);
        const topicName = summary.topicId ? getSummaryTopicName(summary.topicId) : null;
        
        return `
            <div style="padding: 20px; border-bottom: 1px solid #f3f4f6; transition: all 0.2s; cursor: pointer;" 
                 onmouseover="this.style.backgroundColor='#f9fafb';" 
                 onmouseout="this.style.backgroundColor='white';"
                 onclick="viewSummary(${actualIndex})">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1; margin-right: 15px;">
                        <h4 style="margin: 0 0 8px 0; color: #1f2937; font-size: 16px; font-weight: 600;">
                            ${summary.title}
                        </h4>
                        <p style="margin: 0 0 8px 0; color: #6b7280; font-size: 14px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                            ${summary.content.substring(0, 120)}...
                        </p>
                        <div style="display: flex; align-items: center; gap: 15px; font-size: 12px; color: #9ca3af;">
                            <span>üìÖ ${summary.createdAt}</span>
                            ${topicName && !summary.topicId ? `` : ''}
                            <span>${summary.content.length} caracteres</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: flex-start;">
                        <button onclick="event.stopPropagation(); editSummary(${actualIndex})" class="btn btn-warning" style="padding: 6px 12px; font-size: 11px;" title="Editar resumen">
                            ‚úèÔ∏è
                        </button>
                        <button onclick="event.stopPropagation(); deleteSummary(${actualIndex})" class="btn btn-danger" style="padding: 6px 12px; font-size: 11px;" title="Eliminar resumen">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
   // PARCHE: Reemplazar la funci√≥n renderViewSummary existente
function renderViewSummary() {
    const summary = summarySystemState.viewingSummary;
    const topicName = summary.topicId ? getSummaryTopicName(summary.topicId) : 'Sin tema';
    
    return `
        <div style="max-width: 1000px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <button onclick="closeSummaryView()" class="btn btn-secondary" style="margin-bottom: 15px;">
                        ‚Üê Volver a la Biblioteca
                    </button>
                    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 10px;">
                        <h1 style="color: #1f2937; margin: 0; font-size: 2rem;">${summary.title}</h1>
                        <button onclick="editSummaryFromView()" class="btn btn-warning" style="padding: 8px 16px;">
                            ‚úèÔ∏è Editar T√≠tulo
                        </button>
                    </div>
                    <div style="margin-top: 10px; display: flex; align-items: center; gap: 20px; color: #6b7280; font-size: 14px;">
                        <span>üìÇ ${topicName}</span>
                        <span>üìÖ ${summary.createdAt}</span>
                        <span>üìù ${summary.content.length} caracteres</span>
                    </div>
                </div>
            </div>
            
            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
                <div style="prose max-w-none;">
                    <div style="white-space: pre-wrap; line-height: 1.7; color: #374151; font-size: 16px;">
                        ${summary.content}
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 30px; display: flex; justify-content: center; gap: 15px;">
                <button onclick="copySummaryContentToClipboard('${summary.id}')" class="btn btn-info" style="padding: 12px 24px;">
                    üìã Copiar Contenido
                </button>
                <button onclick="deleteSummaryFromView('${summary.id}')" class="btn btn-danger" style="padding: 12px 24px;">
                    üóëÔ∏è Eliminar Resumen
                </button>
            </div>
        </div>
    `;
}
    
    // ========== FUNCIONES DE GESTI√ìN ==========
    
    function showCreateSummary() {
        summarySystemState.currentView = 'create';
        summarySystemState.viewingSummary = null;
        render();
    }
    
    function showSummaryLibrary() {
        summarySystemState.currentView = 'library';
        summarySystemState.viewingSummary = null;
        render();
    }
    
    function createSummaryTopic() {
        const name = prompt('Nombre del nuevo tema de res√∫menes:');
        if (name && name.trim()) {
            const newTopic = {
                id: Date.now() + Math.random(),
                name: name.trim(),
                createdAt: new Date().toLocaleString('es-ES')
            };
            
            summarySystemState.summaryTopics.push(newTopic);
            localStorage.setItem('summaryTopics', JSON.stringify(summarySystemState.summaryTopics));
            render();
            showMessage(`Tema "${name}" creado exitosamente`, 'success');
        }
    }
    
    function updateSelectedSummaryTopic() {
        const selector = document.getElementById('summary-topic-selector');
        if (selector && selector.value) {
            const selectedValue = selector.value;
            const selectedTopic = summarySystemState.summaryTopics.find(t => t.id == selectedValue);
            if (selectedTopic) {
                summarySystemState.selectedTopicForSummary = selectedTopic.id;
                showMessage(`Tema "${selectedTopic.name}" seleccionado`, 'success');
            } else {
                summarySystemState.selectedTopicForSummary = selectedValue;
            }
        } else {
            summarySystemState.selectedTopicForSummary = null;
        }
    }
    
    function getSummaryTopicName(topicId) {
        if (!topicId) return 'Sin tema';
        const topic = summarySystemState.summaryTopics.find(t => t.id.toString() === topicId.toString());
        return topic ? topic.name : 'Tema no encontrado';
    }
    
    function getSummaryTopicCount(topicId) {
        return summarySystemState.savedSummaries.filter(s => s.topicId && s.topicId.toString() === topicId.toString()).length;
    }
    
    function saveSummaryToLibrary() {
        if (!summarySystemState.generatedSummary) {
            showMessage('No hay resumen para guardar', 'error');
            return;
        }
        
        const title = prompt('T√≠tulo para el resumen:') || 'Resumen sin t√≠tulo';
        if (!title.trim()) return;
        
        const newSummary = {
            id: Date.now() + Math.random(),
            title: title.trim(),
            content: summarySystemState.generatedSummary,
            topicId: summarySystemState.selectedTopicForSummary,
            createdAt: new Date().toLocaleString('es-ES')
        };
        
        summarySystemState.savedSummaries.push(newSummary);
        localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
        
        const topicName = summarySystemState.selectedTopicForSummary ? getSummaryTopicName(summarySystemState.selectedTopicForSummary) : 'sin tema';
        showMessage(`Resumen "${title}" guardado en ${topicName}`, 'success');
        
        // Limpiar formulario despu√©s de guardar
        summarySystemState.selectedImages = [];
        summarySystemState.generatedSummary = '';
        summarySystemState.selectedTopicForSummary = null;
        render();
    }
    
    function viewSummary(index) {
        summarySystemState.viewingSummary = summarySystemState.savedSummaries[index];
        render();
    }
    
    function closeSummaryView() {
        summarySystemState.viewingSummary = null;
        summarySystemState.currentView = 'library';
        render();
    }
    
    function editSummary(index) {
        // Implementaci√≥n de edici√≥n de resumen
        const summary = summarySystemState.savedSummaries[index];
        const newTitle = prompt('Nuevo t√≠tulo:', summary.title);
        if (newTitle && newTitle.trim()) {
            summarySystemState.savedSummaries[index].title = newTitle.trim();
            localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
            render();
            showMessage('Resumen actualizado', 'success');
        }
    }
    
    function deleteSummary(index) {
        const summary = summarySystemState.savedSummaries[index];
        if (confirm(`¬øEliminar el resumen "${summary.title}"?`)) {
            summarySystemState.savedSummaries.splice(index, 1);
            localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
            render();
            showMessage('Resumen eliminado', 'success');
        }
    }
    
    function clearAllSummaries() {
        if (confirm('¬øEliminar todos los res√∫menes y temas? Esta acci√≥n no se puede deshacer.')) {
            summarySystemState.savedSummaries = [];
            summarySystemState.summaryTopics = [];
            localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
            localStorage.setItem('summaryTopics', JSON.stringify(summarySystemState.summaryTopics));
            render();
            showMessage('Biblioteca de res√∫menes limpiada', 'success');
        }
    }
    
    function copySummaryContentToClipboard(summaryId) {
        const summary = summarySystemState.savedSummaries.find(s => s.id == summaryId);
        if (summary) {
            navigator.clipboard.writeText(summary.content).then(() => {
                showMessage('Contenido copiado al portapapeles', 'success');
            }).catch(() => {
                showMessage('Error al copiar', 'error');
            });
        }
    }
    
    // Funciones auxiliares redefinidas
    function removeSummaryImage() {
        summarySystemState.selectedImages = [];
        summarySystemState.generatedSummary = '';
        render();
        showMessage('Imagen eliminada', 'success');
    }
    
    function clearCurrentSummary() {
        if (confirm('¬øLimpiar el resumen actual?')) {
            summarySystemState.generatedSummary = '';
            render();
            showMessage('Resumen limpiado', 'success');
        }
    }
    
    async function generateSummary() {
        if (!state.apiKey) {
            showMessage('Configura tu API key primero', 'error');
            return;
        }

        if (summarySystemState.selectedImages.length === 0) {
            showMessage('Selecciona una imagen primero', 'error');
            return;
        }

        summarySystemState.isProcessing = true;
        render();
        showMessage('Generando resumen...', 'success');
        
        try {
            const file = summarySystemState.selectedImages[0];
            const base64 = await fileToBase64(file);
            
            const messageContent = [
                {
                    type: "image",
                    source: {
                        type: "base64",
                        media_type: file.type,
                        data: base64
                    }
                },
                {
                    type: "text",
                    text: `Act√∫a como un asistente experto en an√°lisis y s√≠ntesis de informaci√≥n. Analiza esta imagen y genera un resumen completo e inteligente del contenido.

INSTRUCCIONES PARA EL RESUMEN:

üéØ OBJETIVO: Crear un resumen estructurado, claro y √∫til que capture la esencia del contenido

üìã FORMATO DEL RESUMEN:
‚Ä¢ Comienza con una breve descripci√≥n del tipo de documento/contenido
‚Ä¢ Organiza la informaci√≥n en secciones l√≥gicas con encabezados
‚Ä¢ Usa vi√±etas y numeraci√≥n cuando sea apropiado
‚Ä¢ Incluye los puntos m√°s importantes y relevantes
‚Ä¢ Termina con conclusiones o puntos clave si es relevante

üîç QU√â INCLUIR:
- Ideas principales y conceptos clave
- Datos importantes, cifras, fechas relevantes
- Argumentos o puntos de vista presentados
- Conclusiones o recomendaciones si las hay
- Cualquier informaci√≥n pr√°ctica o accionable

‚ú® ESTILO:
- Lenguaje claro y profesional
- Oraciones concisas pero informativas  
- Estructura f√°cil de leer y escanear
- Adapta el tono al tipo de contenido (acad√©mico, empresarial, t√©cnico, etc.)

üö´ EVITA:
- Repetir informaci√≥n innecesaria
- Incluir detalles muy t√©cnicos a menos que sean cruciales
- Hacer el resumen demasiado largo (m√°ximo 500 palabras)
- Copiar texto textualmente sin reorganizar

Genera un resumen que sea verdaderamente √∫til para alguien que quiere entender r√°pidamente el contenido esencial del documento.`
                }
            ];

            const response = await fetch("/api/anthropic", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-api-key": state.apiKey,
                },
                body: JSON.stringify({
                    model: "claude-sonnet-4-20250514",
                    max_tokens: 2000,
                    messages: [{
                        role: "user",
                        content: messageContent
                    }]
                })
            });

            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            summarySystemState.generatedSummary = data.content[0].text;
            summarySystemState.isProcessing = false;
            
            render();
            showMessage('¬°Resumen generado exitosamente!', 'success');
            
        } catch (error) {
            summarySystemState.isProcessing = false;
            render();
            showMessage(`Error al generar resumen: ${error.message}`, 'error');
        }
    }
    
    async function copySummaryToClipboard() {
        try {
            await navigator.clipboard.writeText(summarySystemState.generatedSummary);
            showMessage('Resumen copiado al portapapeles', 'success');
        } catch (error) {
            const textArea = document.createElement('textarea');
            textArea.value = summarySystemState.generatedSummary;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showMessage('Resumen copiado al portapapeles', 'success');
            } catch (err) {
                showMessage('Error al copiar', 'error');
            }
            document.body.removeChild(textArea);
        }
    }
    
    // Event listener para selecci√≥n de im√°genes (actualizado)
    document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'summaryImageInput') {
            const files = Array.from(e.target.files);
            const imageFile = files.filter(file => file.type.startsWith('image/'))[0];
            
            if (imageFile) {
                summarySystemState.selectedImages = [imageFile];
                summarySystemState.generatedSummary = '';
                render();
                showMessage('Imagen seleccionada correctamente', 'success');
            }
        }
    });
    
    console.log('‚úÖ Sistema de Res√∫menes Completo con Temas aplicado correctamente');
</script>
    <!-- 
PARCHE CORRECCI√ìN: OCULTAR PESTA√ëAS Y MEJORAR VISUALIZACI√ìN DE RES√öMENES
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
Este parche corrige la visualizaci√≥n de las pesta√±as y mejora la vista de res√∫menes
-->

<script>
    // ========== PARCHE CORRECCI√ìN: INTERFAZ DE RES√öMENES ==========
    
    // REEMPLAZAR completamente la funci√≥n render para corregir las pesta√±as
    const originalRenderComplete = render;
    render = function() {
        if (showIntermediateScreen && state.currentUser) {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <div class="title">Sistema de Ex√°menes</div>
                        <div>
                            <span style="color: ${state.apiKey ? '#10b981' : '#ef4444'};">
                                ${state.apiKey ? '‚úÖ API Configurada' : '‚ùå Sin API'}
                            </span>
                            <button onclick="configureAPI()" class="btn btn-secondary">API</button>
                            <span style="color: #f59e0b;">üë§ ${state.currentUser.name}</span>
                            <button onclick="logout()" class="btn btn-danger">Salir</button>
                        </div>
                    </div>
                    ${renderIntermediateScreen()}
                </div>
            `;
        } else if (state.currentUser) {
            const app = document.getElementById('app');
            
            // Determinar el t√≠tulo seg√∫n la pesta√±a actual
            let pageTitle = 'Sistema de Ex√°menes';
            if (state.currentTab === 'questions') pageTitle = 'Banco de Preguntas';
            else if (state.currentTab === 'results') pageTitle = 'Resultados del Test';
            else if (state.currentTab === 'summary') pageTitle = 'Generador de Res√∫menes';
            
            // CR√çTICO: Solo mostrar pesta√±as si NO estamos en summary
            const showNavTabs = state.currentTab !== 'summary';
            
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <div class="title">${pageTitle}</div>
                        <div>
                            <span style="color: ${state.apiKey ? '#10b981' : '#ef4444'};">
                                ${state.apiKey ? '‚úÖ API Configurada' : '‚ùå Sin API'}
                            </span>
                            <button onclick="configureAPI()" class="btn btn-secondary">API</button>
                            <span style="color: #f59e0b;">üë§ ${state.currentUser.name}</span>
                            <button onclick="logout()" class="btn btn-danger">Salir</button>
                        </div>
                    </div>

                    ${showNavTabs ? `
                        <div class="nav-tabs">
                            <button class="nav-tab ${state.currentTab === 'upload' ? 'active' : ''}" onclick="setTab('upload')">
                                üì§ Subir Test
                            </button>
                            <button class="nav-tab ${state.currentTab === 'questions' ? 'active' : ''}" onclick="setTab('questions')">
                                üìã Banco de Preguntas (${getFilteredQuestions().length})
                            </button>
                            <button class="nav-tab ${state.currentTab === 'test' ? 'active' : ''}" onclick="setTab('test')">
                                üéØ Test Aleatorio
                            </button>
                            <button class="nav-tab ${state.currentTab === 'results' ? 'active' : ''}" onclick="setTab('results')">
                                üìä Resultados (${state.testResults.length})
                            </button>
                        </div>
                    ` : ''}

                    <div id="messages"></div>

                    ${renderTabContent()}
                </div>
            `;
        } else {
            // Usuario no logueado - mostrar login
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <div class="login-form">
                        <h2 style="text-align: center; margin-bottom: 30px;">Iniciar Sesi√≥n</h2>
                        <div class="form-group">
                            <label class="form-label">Usuario</label>
                            <input type="text" id="username" class="form-input" placeholder="demo">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contrase√±a</label>
                            <input type="password" id="password" class="form-input" placeholder="demo123">
                        </div>
                        <button onclick="login()" class="btn btn-primary" style="width: 100%;">
                            Iniciar Sesi√≥n
                        </button>
                        <div style="text-align: center; margin-top: 15px; color: #6b7280; font-size: 14px;">
                            Usuario: demo | Contrase√±a: demo123
                        </div>
                    </div>
                </div>
            `;
        }
    };
    
    // MEJORAR la funci√≥n renderViewSummary para una mejor visualizaci√≥n
    const originalRenderViewSummary = renderViewSummary;
    renderViewSummary = function() {
        const summary = summarySystemState.viewingSummary;
        const topicName = summary.topicId ? getSummaryTopicName(summary.topicId) : 'Sin tema';
        
        return `
            <div style="max-width: 1200px; margin: 0 auto;">
                <!-- Header con navegaci√≥n -->
                <div style="margin-bottom: 30px;">
                    <button onclick="closeSummaryView()" class="btn btn-secondary" style="margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                        <span>‚Üê</span> Volver a la Biblioteca
                    </button>
                    
                    <!-- T√≠tulo y metadata -->
                    <div style="background: linear-gradient(135deg, #f8fafc, #e2e8f0); border-radius: 16px; padding: 30px; border: 2px solid #e2e8f0;">
                        <h1 style="color: #1f2937; margin: 0 0 15px 0; font-size: 2.5rem; font-weight: 700; line-height: 1.2;">
                            ${summary.title}
                        </h1>
                        <div style="display: flex; flex-wrap: wrap; gap: 20px; color: #6b7280; font-size: 15px;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="color: #059669;">üìÇ</span>
                                <strong>${topicName}</strong>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="color: #0ea5e9;">üìÖ</span>
                                ${summary.createdAt}
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="color: #f59e0b;">üìù</span>
                                ${summary.content.length} caracteres
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Contenido del resumen con formato mejorado -->
                <div style="background: white; border: 2px solid #e2e8f0; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                    <!-- Header del contenido -->
                    <div style="background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; padding: 20px 30px;">
                        <h2 style="margin: 0; font-size: 1.3rem; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                            <span>üìÑ</span> Contenido del Resumen
                        </h2>
                    </div>
                    
                    <!-- Contenido formateado -->
                    <div style="padding: 40px;">
                        <div style="font-size: 16px; line-height: 1.8; color: #374151; max-width: none;">
                            ${formatSummaryContent(summary.content)}
                        </div>
                    </div>
                </div>
                
                <!-- Acciones -->
                <div style="margin-top: 30px; padding: 25px; background: #f9fafb; border-radius: 16px; border: 2px solid #f3f4f6;">
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;">
                        <button onclick="copySummaryContentToClipboard('${summary.id}')" class="btn btn-info" style="padding: 12px 24px; font-size: 15px; display: flex; align-items: center; gap: 8px; flex: 1; max-width: 200px; justify-content: center;">
                            <span>üìã</span> Copiar Contenido
                        </button>
                        <button onclick="editSummaryFromView()" class="btn btn-warning" style="padding: 12px 24px; font-size: 15px; display: flex; align-items: center; gap: 8px; flex: 1; max-width: 200px; justify-content: center;">
                            <span>‚úèÔ∏è</span> Editar Resumen
                        </button>
                        <button onclick="deleteSummaryFromView('${summary.id}')" class="btn btn-danger" style="padding: 12px 24px; font-size: 15px; display: flex; align-items: center; gap: 8px; flex: 1; max-width: 200px; justify-content: center;">
                            <span>üóëÔ∏è</span> Eliminar Resumen
                        </button>
                    </div>
                </div>
            </div>
        `;
    };
    
    // Nueva funci√≥n para formatear el contenido del resumen
    function formatSummaryContent(content) {
        // Dividir el contenido en p√°rrafos
        const paragraphs = content.split('\n').filter(line => line.trim());
        
        return paragraphs.map(paragraph => {
            const trimmed = paragraph.trim();
            
            // Detectar t√≠tulos (l√≠neas que terminan con ":" o que son muy cortas y est√°n en may√∫sculas)
            if (trimmed.endsWith(':') && trimmed.length < 80) {
                return `<h3 style="color: #1f2937; font-size: 1.2rem; font-weight: 700; margin: 25px 0 15px 0; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0;">${trimmed}</h3>`;
            }
            
            // Detectar listas con vi√±etas (l√≠neas que empiezan con ‚Ä¢, -, *, o n√∫meros)
            if (trimmed.match(/^[‚Ä¢\-\*]\s+/) || trimmed.match(/^\d+\.\s+/)) {
                return `<div style="margin: 8px 0; padding-left: 20px; border-left: 3px solid #e2e8f0; color: #4b5563;">${trimmed}</div>`;
            }
            
            // Detectar secciones importantes (l√≠neas con palabras clave)
            if (trimmed.match(/^(CONCLUSI√ìN|RESUMEN|IMPORTANTE|NOTA|OBJETIVO|INTRODUCCI√ìN|DESARROLLO)/i)) {
                return `<div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 15px; margin: 15px 0; color: #0c4a6e; font-weight: 500;">${trimmed}</div>`;
            }
            
            // P√°rrafos normales
            return `<p style="margin: 15px 0; text-align: justify;">${trimmed}</p>`;
        }).join('');
    }
    
    // Funci√≥n para editar desde la vista (nueva funcionalidad)
    function editSummaryFromView() {
        const summary = summarySystemState.viewingSummary;
        const newTitle = prompt('Nuevo t√≠tulo:', summary.title);
        
        if (newTitle && newTitle.trim()) {
            const index = summarySystemState.savedSummaries.findIndex(s => s.id === summary.id);
            if (index !== -1) {
                summarySystemState.savedSummaries[index].title = newTitle.trim();
                summarySystemState.viewingSummary.title = newTitle.trim(); // Actualizar vista actual
                localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
                render();
                showMessage('T√≠tulo del resumen actualizado', 'success');
            }
        }
    }
    
    // Funci√≥n para eliminar desde la vista (nueva funcionalidad)
    function deleteSummaryFromView(summaryId) {
        const summary = summarySystemState.savedSummaries.find(s => s.id == summaryId);
        if (summary && confirm(`¬øEliminar el resumen "${summary.title}"? Esta acci√≥n no se puede deshacer.`)) {
            const index = summarySystemState.savedSummaries.findIndex(s => s.id == summaryId);
            if (index !== -1) {
                summarySystemState.savedSummaries.splice(index, 1);
                localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
                showMessage('Resumen eliminado', 'success');
                
                // Volver a la biblioteca despu√©s de eliminar
                summarySystemState.viewingSummary = null;
                summarySystemState.currentView = 'library';
                render();
            }
        }
    }
    
    console.log('‚úÖ Parche de correcci√≥n aplicado - Pesta√±as ocultas y visualizaci√≥n mejorada');
</script>
    <!-- 
PARCHE: CORRECCI√ìN DEL CLIC EN RES√öMENES
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
Este parche corrige la funcionalidad de visualizaci√≥n de res√∫menes
-->

<script>
    // ========== PARCHE: CORRECCI√ìN VISUALIZACI√ìN DE RES√öMENES ==========
    
    // REEMPLAZAR la funci√≥n renderSingleSummary para asegurar el clic correcto
    function renderSingleSummary(summary, index) {
        const actualIndex = summarySystemState.savedSummaries.findIndex(s => s.id === summary.id);
        const topicName = summary.topicId ? getSummaryTopicName(summary.topicId) : null;
        
        return `
            <div style="padding: 20px; border-bottom: 1px solid #f3f4f6; transition: all 0.2s; cursor: pointer; position: relative;" 
                 onmouseover="this.style.backgroundColor='#f9fafb';" 
                 onmouseout="this.style.backgroundColor='white';">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1; margin-right: 15px;" onclick="openSummaryView(${actualIndex})">
                        <h4 style="margin: 0 0 8px 0; color: #1f2937; font-size: 16px; font-weight: 600;">
                            ${summary.title}
                        </h4>
                        <p style="margin: 0 0 8px 0; color: #6b7280; font-size: 14px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                            ${summary.content.substring(0, 120)}...
                        </p>
                        <div style="display: flex; align-items: center; gap: 15px; font-size: 12px; color: #9ca3af;">
                            <span>üìÖ ${summary.createdAt}</span>
                            <span>${summary.content.length} caracteres</span>
                            <span style="background: #e0f2fe; color: #01579b; padding: 2px 8px; border-radius: 12px; font-weight: 500;">üëÜ Click para ver</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: flex-start;">
                        <button onclick="event.stopPropagation(); editSummaryTitle(${actualIndex})" class="btn btn-warning" style="padding: 6px 12px; font-size: 11px;" title="Editar resumen">
                            ‚úèÔ∏è
                        </button>
                        <button onclick="event.stopPropagation(); deleteSummaryConfirm(${actualIndex})" class="btn btn-danger" style="padding: 6px 12px; font-size: 11px;" title="Eliminar resumen">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Nueva funci√≥n espec√≠fica para abrir la vista del resumen
    function openSummaryView(index) {
        console.log('Abriendo vista de resumen, √≠ndice:', index);
        
        if (summarySystemState.savedSummaries[index]) {
            summarySystemState.viewingSummary = summarySystemState.savedSummaries[index];
            summarySystemState.currentView = 'view';
            console.log('Vista de resumen configurada:', summarySystemState.viewingSummary.title);
            render();
            
            // Scroll suave al inicio
            setTimeout(() => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 100);
        } else {
            console.error('Resumen no encontrado en √≠ndice:', index);
            showMessage('Error: No se pudo abrir el resumen', 'error');
        }
    }
    
    // Funci√≥n espec√≠fica para editar t√≠tulo
    function editSummaryTitle(index) {
        const summary = summarySystemState.savedSummaries[index];
        if (!summary) return;
        
        const newTitle = prompt('Nuevo t√≠tulo:', summary.title);
        if (newTitle && newTitle.trim()) {
            summarySystemState.savedSummaries[index].title = newTitle.trim();
            localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
            render();
            showMessage('T√≠tulo actualizado', 'success');
        }
    }
    
    // Funci√≥n espec√≠fica para confirmar eliminaci√≥n
    function deleteSummaryConfirm(index) {
        const summary = summarySystemState.savedSummaries[index];
        if (!summary) return;
        
        if (confirm(`¬øEliminar el resumen "${summary.title}"?`)) {
            summarySystemState.savedSummaries.splice(index, 1);
            localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
            render();
            showMessage('Resumen eliminado', 'success');
        }
    }
    
    // MEJORAR la funci√≥n renderSummaryTab para manejar diferentes vistas
    const originalRenderSummaryTabFixed = renderSummaryTab;
    renderSummaryTab = function() {
        console.log('Renderizando resumen tab, vista actual:', summarySystemState.currentView, 'Viendo:', !!summarySystemState.viewingSummary);
        
        // Si estamos viendo un resumen espec√≠fico
        if (summarySystemState.viewingSummary || summarySystemState.currentView === 'view') {
            return renderViewSummaryEnhanced();
        }
        
        // Si estamos en la biblioteca
        if (summarySystemState.currentView === 'library') {
            return renderSummaryLibraryEnhanced();
        }
        
        // Por defecto: crear resumen
        return renderCreateSummary();
    };
    
    // Funci√≥n mejorada para renderizar la vista del resumen
    function renderViewSummaryEnhanced() {
        const summary = summarySystemState.viewingSummary;
        if (!summary) {
            console.error('No hay resumen para mostrar');
            summarySystemState.currentView = 'library';
            return renderSummaryLibraryEnhanced();
        }
        
        const topicName = summary.topicId ? getSummaryTopicName(summary.topicId) : 'Sin tema';
        
        return `
            <div style="max-width: 1200px; margin: 0 auto; animation: slideIn 0.3s ease-out;">
                <!-- Header con navegaci√≥n elegante -->
                <div style="margin-bottom: 30px;">
                    <button onclick="closeSummaryViewEnhanced()" class="btn btn-secondary" style="margin-bottom: 25px; display: flex; align-items: center; gap: 10px; padding: 12px 20px; font-size: 15px; font-weight: 500; border-radius: 12px; transition: all 0.3s ease;" onmouseover="this.style.transform='translateX(-5px)'" onmouseout="this.style.transform='translateX(0)'">
                        <span style="font-size: 18px;">‚Üê</span> Volver a la Biblioteca
                    </button>
                    
                    <!-- Tarjeta de t√≠tulo elegante -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; padding: 40px; color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; overflow: hidden;">
                        <!-- Decoraci√≥n de fondo -->
                        <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                        <div style="position: absolute; bottom: -30px; left: -30px; width: 100px; height: 100px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>
                        
                        <!-- Contenido del header -->
                        <div style="position: relative; z-index: 1;">
                            <h1 style="margin: 0 0 20px 0; font-size: 2.8rem; font-weight: 800; line-height: 1.2; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                                ${summary.title}
                            </h1>
                            <div style="display: flex; flex-wrap: wrap; gap: 25px; font-size: 16px; opacity: 0.95;">
                                <div style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.15); padding: 8px 16px; border-radius: 25px;">
                                    <span style="font-size: 18px;">üìÇ</span>
                                    <strong>${topicName}</strong>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.15); padding: 8px 16px; border-radius: 25px;">
                                    <span style="font-size: 18px;">üìÖ</span>
                                    ${summary.createdAt}
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.15); padding: 8px 16px; border-radius: 25px;">
                                    <span style="font-size: 18px;">üìù</span>
                                    ${summary.content.length} caracteres
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tarjeta del contenido principal -->
                <div style="background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 8px 25px rgba(0,0,0,0.12); margin-bottom: 30px;">
                    <!-- Header del contenido -->
                    <div style="background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; padding: 25px 35px;">
                        <h2 style="margin: 0; font-size: 1.4rem; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">üìÑ</span> 
                            <span>Contenido del Resumen</span>
                        </h2>
                    </div>
                    
                    <!-- Contenido formateado con mejor estilo -->
                    <div style="padding: 45px;">
                        <div style="font-size: 17px; line-height: 1.8; color: #2d3748; max-width: none; font-family: 'Georgia', serif;">
                            ${formatSummaryContentAdvanced(summary.content)}
                        </div>
                    </div>
                </div>
                
                <!-- Panel de acciones mejorado -->
                <div style="background: linear-gradient(135deg, #f7fafc, #edf2f7); border-radius: 20px; padding: 30px; border: 2px solid #e2e8f0;">
                    <h3 style="text-align: center; margin: 0 0 25px 0; color: #4a5568; font-size: 1.2rem; font-weight: 600;">Acciones Disponibles</h3>
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;">
                        <button onclick="copySummaryContentToClipboard('${summary.id}')" class="btn btn-info" style="padding: 15px 25px; font-size: 15px; display: flex; align-items: center; gap: 10px; flex: 1; max-width: 220px; justify-content: center; border-radius: 12px; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(14, 165, 233, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'">
                            <span style="font-size: 18px;">üìã</span> Copiar Contenido
                        </button>
                        <button onclick="editSummaryFromViewEnhanced()" class="btn btn-warning" style="padding: 15px 25px; font-size: 15px; display: flex; align-items: center; gap: 10px; flex: 1; max-width: 220px; justify-content: center; border-radius: 12px; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(245, 158, 11, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'">
                            <span style="font-size: 18px;">‚úèÔ∏è</span> Editar T√≠tulo
                        </button>
                        <button onclick="deleteSummaryFromViewEnhanced('${summary.id}')" class="btn btn-danger" style="padding: 15px 25px; font-size: 15px; display: flex; align-items: center; gap: 10px; flex: 1; max-width: 220px; justify-content: center; border-radius: 12px; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(239, 68, 68, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'">
                            <span style="font-size: 18px;">üóëÔ∏è</span> Eliminar Resumen
                        </button>
                    </div>
                </div>
            </div>
            
            <style>
                @keyframes slideIn {
                    from {
                        opacity: 0;
                        transform: translateY(20px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
            </style>
        `;
    }
    
    // Funci√≥n para formatear contenido con m√°s opciones
    function formatSummaryContentAdvanced(content) {
        const paragraphs = content.split('\n').filter(line => line.trim());
        
        return paragraphs.map(paragraph => {
            const trimmed = paragraph.trim();
            
            // T√≠tulos principales
            if (trimmed.endsWith(':') && trimmed.length < 80) {
                return `<h3 style="color: #2d3748; font-size: 1.3rem; font-weight: 800; margin: 30px 0 18px 0; padding: 12px 0; border-bottom: 3px solid #4f46e5; background: linear-gradient(90deg, #4f46e5, transparent); background-size: 100px 3px; background-repeat: no-repeat; background-position: bottom;">${trimmed}</h3>`;
            }
            
            // Listas
            if (trimmed.match(/^[‚Ä¢\-\*]\s+/) || trimmed.match(/^\d+\.\s+/)) {
                return `<div style="margin: 12px 0; padding: 15px 20px; background: #f7fafc; border-left: 4px solid #4f46e5; border-radius: 0 8px 8px 0; color: #2d3748; font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">${trimmed}</div>`;
            }
            
            // Secciones destacadas
            if (trimmed.match(/^(CONCLUSI√ìN|RESUMEN|IMPORTANTE|NOTA|OBJETIVO|INTRODUCCI√ìN|DESARROLLO)/i)) {
                return `<div style="background: linear-gradient(135deg, #e0f2fe, #f0f9ff); border: 2px solid #0ea5e9; border-radius: 12px; padding: 20px; margin: 20px 0; color: #0c4a6e; font-weight: 600; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15);">${trimmed}</div>`;
            }
            
            // P√°rrafos normales con mejor estilo
            return `<p style="margin: 18px 0; text-align: justify; font-size: 17px; line-height: 1.8; color: #4a5568; text-indent: 20px;">${trimmed}</p>`;
        }).join('');
    }
    
    // Funciones auxiliares mejoradas
    function closeSummaryViewEnhanced() {
        summarySystemState.viewingSummary = null;
        summarySystemState.currentView = 'library';
        render();
    }
    
    function editSummaryFromViewEnhanced() {
        const summary = summarySystemState.viewingSummary;
        const newTitle = prompt('Nuevo t√≠tulo:', summary.title);
        
        if (newTitle && newTitle.trim()) {
            const index = summarySystemState.savedSummaries.findIndex(s => s.id === summary.id);
            if (index !== -1) {
                summarySystemState.savedSummaries[index].title = newTitle.trim();
                summarySystemState.viewingSummary.title = newTitle.trim();
                localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
                render();
                showMessage('T√≠tulo del resumen actualizado', 'success');
            }
        }
    }
    
    function deleteSummaryFromViewEnhanced(summaryId) {
        const summary = summarySystemState.savedSummaries.find(s => s.id == summaryId);
        if (summary && confirm(`¬øEliminar el resumen "${summary.title}"? Esta acci√≥n no se puede deshacer.`)) {
            const index = summarySystemState.savedSummaries.findIndex(s => s.id == summaryId);
            if (index !== -1) {
                summarySystemState.savedSummaries.splice(index, 1);
                localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
                showMessage('Resumen eliminado', 'success');
                
                summarySystemState.viewingSummary = null;
                summarySystemState.currentView = 'library';
                render();
            }
        }
    }
    
    // Funci√≥n mejorada para la biblioteca
    function renderSummaryLibraryEnhanced() {
        return renderSummaryLibrary(); // Usar la funci√≥n existente
    }
    
    console.log('‚úÖ Parche de correcci√≥n de visualizaci√≥n aplicado correctamente');
</script>
    <!-- 
PARCHE: LIMPIEZA Y FORMATO ELEGANTE DE RES√öMENES
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
Este parche limpia el contenido y lo presenta de forma elegante
-->

<script>
    // ========== PARCHE: LIMPIEZA DE FORMATO DE RES√öMENES ==========
    
    // REEMPLAZAR la funci√≥n de formateo para limpiar el contenido
    function formatSummaryContentAdvanced(content) {
        // Limpiar el contenido de s√≠mbolos de formato
        const cleanedContent = cleanSummaryText(content);
        
        // Dividir en l√≠neas y procesar
        const lines = cleanedContent.split('\n').filter(line => line.trim());
        
        return lines.map(line => {
            const trimmed = line.trim();
            if (!trimmed) return '';
            
            // Detectar t√≠tulos principales (l√≠neas cortas que parecen encabezados)
            if (isTitleLine(trimmed)) {
                return `
                    <div style="margin: 35px 0 20px 0; padding: 0 0 12px 0; border-bottom: 2px solid #e2e8f0;">
                        <h3 style="color: #1a202c; font-size: 1.3rem; font-weight: 700; margin: 0; letter-spacing: -0.025em;">
                            ${trimmed}
                        </h3>
                    </div>
                `;
            }
            
            // Detectar subt√≠tulos
            if (isSubtitleLine(trimmed)) {
                return `
                    <div style="margin: 25px 0 15px 0;">
                        <h4 style="color: #2d3748; font-size: 1.1rem; font-weight: 600; margin: 0; padding: 8px 16px; background: #f7fafc; border-left: 4px solid #4f46e5; border-radius: 0 8px 8px 0;">
                            ${trimmed}
                        </h4>
                    </div>
                `;
            }
            
            // Detectar elementos de lista (l√≠neas que empiezan con gui√≥n o n√∫mero)
            if (isListItem(trimmed)) {
                return `
                    <div style="margin: 10px 0; padding: 12px 20px; background: #f8fafc; border-left: 3px solid #cbd5e0; border-radius: 0 6px 6px 0; color: #4a5568;">
                        ${cleanListItem(trimmed)}
                    </div>
                `;
            }
            
            // P√°rrafos normales
            return `
                <p style="margin: 16px 0; line-height: 1.7; color: #4a5568; text-align: justify; font-size: 16px;">
                    ${trimmed}
                </p>
            `;
        }).join('');
    }
    
    // Funci√≥n para limpiar el texto de s√≠mbolos de formato
    function cleanSummaryText(text) {
        return text
            // Limpiar asteriscos de markdown
            .replace(/\*\*(.*?)\*\*/g, '$1')
            .replace(/\*(.*?)\*/g, '$1')
            
            // Limpiar s√≠mbolos de encabezado
            .replace(/^#{1,6}\s*/gm, '')
            
            // Limpiar emojis y s√≠mbolos al inicio de l√≠neas
            .replace(/^[\u{1F300}-\u{1F9FF}][\s]*/gum, '')
            .replace(/^[üß†üí°üìãüîç‚ú®üö´üë§üìäüíºüè¢]+[\s]*/gm, '')
            
            // Limpiar s√≠mbolos de vi√±etas especiales
            .replace(/^[\-\*\+]\s*\*\*(.*?)\*\*[\s]*(.*)$/gm, '- $1 $2')
            
            // Limpiar l√≠neas de separaci√≥n
            .replace(/^[\-\=]{3,}$/gm, '')
            
            // Limpiar texto entre asteriscos dobles al inicio
            .replace(/^\*\*(.*?)\*\*\s*/gm, '$1: ')
            
            // Normalizar espacios m√∫ltiples
            .replace(/\s{3,}/g, ' ')
            .replace(/\n{3,}/g, '\n\n')
            
            .trim();
    }
    
    // Detectar si una l√≠nea es un t√≠tulo principal
    function isTitleLine(line) {
        return (
            line.length < 60 && 
            line.length > 8 &&
            (line.endsWith(':') || 
             line.match(/^[A-Z√Å√â√ç√ì√ö][A-Z√Å√â√ç√ì√ö\s]+$/) ||
             line.includes('RESUMEN') ||
             line.includes('CONCEPTO') ||
             line.includes('APLICACI√ìN') ||
             line.includes('√ÅMBITOS'))
        ) && !line.startsWith('-');
    }
    
    // Detectar si una l√≠nea es un subt√≠tulo
    function isSubtitleLine(line) {
        return (
            line.length < 80 && 
            line.length > 15 &&
            (line.includes('Personal') ||
             line.includes('Laboral') ||
             line.includes('Profesional') ||
             line.includes('Funci√≥n') ||
             line.includes('Entorno')) &&
            !line.startsWith('-')
        ) || (line.endsWith('**') && line.startsWith('**'));
    }
    
    // Detectar elementos de lista
    function isListItem(line) {
        return line.match(/^[\-\*\+‚Ä¢]\s+/) || line.match(/^\d+\.\s+/);
    }
    
    // Limpiar elementos de lista
    function cleanListItem(line) {
        return line.replace(/^[\-\*\+‚Ä¢]\s+/, '').replace(/^\d+\.\s+/, '');
    }
    
    // MEJORAR la visualizaci√≥n completa del resumen
    function renderViewSummaryEnhanced() {
        const summary = summarySystemState.viewingSummary;
        if (!summary) {
            console.error('No hay resumen para mostrar');
            summarySystemState.currentView = 'library';
            return renderSummaryLibraryEnhanced();
        }
        
        const topicName = summary.topicId ? getSummaryTopicName(summary.topicId) : 'Sin tema';
        
        return `
            <div style="max-width: 1100px; margin: 0 auto; animation: slideIn 0.3s ease-out;">
                
                <!-- Navegaci√≥n elegante -->
                <div style="margin-bottom: 25px;">
                    <button onclick="closeSummaryViewEnhanced()" class="btn btn-secondary" style="display: flex; align-items: center; gap: 10px; padding: 12px 20px; font-size: 14px; border-radius: 10px; transition: all 0.2s ease; background: #6b7280; border: none;" onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'">
                        <span style="font-size: 16px;">‚Üê</span> Volver a la Biblioteca
                    </button>
                </div>
                
                <!-- Tarjeta principal del resumen -->
                <div style="background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #e2e8f0;">
                    
                    <!-- Header del resumen -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px 35px; color: white; position: relative;">
                        <div style="position: absolute; top: 0; right: 0; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; transform: translate(30px, -30px);"></div>
                        <div style="position: relative; z-index: 2;">
                            <h1 style="margin: 0 0 15px 0; font-size: 2.2rem; font-weight: 700; line-height: 1.2; color: white;">
                                ${summary.title}
                            </h1>
                            <div style="display: flex; flex-wrap: wrap; gap: 20px; font-size: 14px; opacity: 0.95;">
                                <div style="background: rgba(255,255,255,0.2); padding: 6px 14px; border-radius: 20px;">
                                    <strong>${topicName}</strong>
                                </div>
                                <div style="background: rgba(255,255,255,0.2); padding: 6px 14px; border-radius: 20px;">
                                    ${summary.createdAt}
                                </div>
                                <div style="background: rgba(255,255,255,0.2); padding: 6px 14px; border-radius: 20px;">
                                    ${Math.round(summary.content.length / 5)} palabras aprox.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contenido del resumen -->
                    <div style="padding: 40px; background: #fafafa;">
                        <div style="background: white; padding: 35px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #f1f1f1;">
                            <div style="max-width: none; font-family: 'Segoe UI', system-ui, sans-serif;">
                                ${formatSummaryContentAdvanced(summary.content)}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Panel de acciones -->
                    <div style="background: #f8fafc; padding: 25px 35px; border-top: 1px solid #e2e8f0;">
                        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 12px;">
                            <button onclick="copySummaryContentToClipboard('${summary.id}')" class="btn btn-info" style="padding: 10px 20px; font-size: 14px; display: flex; align-items: center; gap: 8px; border-radius: 8px; font-weight: 500; min-width: 160px; justify-content: center;">
                                üìã Copiar Texto
                            </button>
                            <button onclick="editSummaryFromViewEnhanced()" class="btn btn-warning" style="padding: 10px 20px; font-size: 14px; display: flex; align-items: center; gap: 8px; border-radius: 8px; font-weight: 500; min-width: 160px; justify-content: center;">
                                ‚úèÔ∏è Editar T√≠tulo
                            </button>
                            <button onclick="deleteSummaryFromViewEnhanced('${summary.id}')" class="btn btn-danger" style="padding: 10px 20px; font-size: 14px; display: flex; align-items: center; gap: 8px; border-radius: 8px; font-weight: 500; min-width: 160px; justify-content: center;">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <style>
                @keyframes slideIn {
                    from {
                        opacity: 0;
                        transform: translateY(15px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
            </style>
        `;
    }
    
    console.log('‚úÖ Parche de limpieza y formato elegante aplicado correctamente');
</script>
    <!-- 
PARCHE: M√öLTIPLES IM√ÅGENES PARA RES√öMENES
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
Este parche permite seleccionar hasta 10 im√°genes para generar res√∫menes
-->

<script>
    // ========== PARCHE: M√öLTIPLES IM√ÅGENES PARA RES√öMENES ==========
    
    // REEMPLAZAR la funci√≥n renderCreateSummary para soportar m√∫ltiples im√°genes
    function renderCreateSummary() {
        return `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h2 style="color: #1f2937; margin: 0;">üìÑ Crear Nuevo Resumen</h2>
                    <p style="color: #6b7280; margin: 5px 0 0 0; font-size: 14px;">Sube hasta 10 im√°genes y obt√©n un resumen inteligente del contenido</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="showSummaryLibrary()" class="btn btn-info">
                        üìö Ver Biblioteca
                    </button>
                    <button onclick="backToIntermediateScreen()" class="btn btn-secondary">
                        ‚Üê Volver al Men√∫ Principal
                    </button>
                </div>
            </div>
            
            <div class="three-column">
                <div class="column">
                    <h3 style="margin-bottom: 15px;">üì§ Subir Im√°genes para Resumir</h3>
                    
                    <!-- √Årea de subida mejorada -->
                    <div class="upload-area" onclick="document.getElementById('summaryImageInput').click()" style="border: 2px dashed #cbd5e0; border-radius: 12px; padding: 30px 20px; text-align: center; margin-bottom: 20px; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.borderColor='#4f46e5'; this.style.backgroundColor='#f8fafc'" onmouseout="this.style.borderColor='#cbd5e0'; this.style.backgroundColor='white'">
                        <div style="font-size: 48px; margin-bottom: 10px; color: #9ca3af;">üìÅ</div>
                        <div style="font-size: 16px; font-weight: 500; color: #374151; margin-bottom: 5px;">Seleccionar m√∫ltiples im√°genes</div>
                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 10px;">Hasta 10 im√°genes ‚Ä¢ PNG, JPG, JPEG</div>
                        <div style="margin-top: 15px; color: #4f46e5; font-weight: 600; font-size: 18px;">
                            ${summarySystemState.selectedImages.length}/10 archivos seleccionados
                        </div>
                    </div>
                    
                    <input type="file" id="summaryImageInput" style="display: none;" accept="image/*" multiple>
                    
                    <!-- Cuadr√≠cula de im√°genes seleccionadas -->
                    ${summarySystemState.selectedImages.length > 0 ? `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #374151; font-size: 14px; font-weight: 600; margin-bottom: 12px;">Im√°genes seleccionadas:</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; max-height: 300px; overflow-y: auto; padding: 10px; background: #f9fafb; border-radius: 8px;">
                                ${summarySystemState.selectedImages.map((file, i) => `
                                    <div style="position: relative; background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 8px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                        <button onclick="removeSummaryImageByIndex(${i})" style="position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2);" onmouseover="this.style.backgroundColor='#dc2626'" onmouseout="this.style.backgroundColor='#ef4444'">√ó</button>
                                        <div style="font-size: 24px; margin-bottom: 6px;">üñºÔ∏è</div>
                                        <div style="font-size: 10px; word-break: break-all; color: #6b7280; line-height: 1.2;">${file.name.length > 15 ? file.name.substring(0, 12) + '...' : file.name}</div>
                                        <div style="font-size: 9px; color: #9ca3af; margin-top: 2px;">${Math.round(file.size/1024)}KB</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Bot√≥n de generar resumen -->
                    <button onclick="generateMultipleSummary()" class="btn btn-primary" style="width: 100%; margin-bottom: 15px; padding: 12px; font-size: 15px; font-weight: 600;" ${summarySystemState.selectedImages.length === 0 || !state.apiKey || summarySystemState.isProcessing ? 'disabled' : ''}>
                        ${summarySystemState.isProcessing ? 'üîÑ Generando Resumen...' : `ü§ñ Generar Resumen (${summarySystemState.selectedImages.length} imagen${summarySystemState.selectedImages.length === 1 ? '' : 'es'})`}
                    </button>
                    
                    ${summarySystemState.isProcessing ? `
                        <div style="margin-bottom: 15px; padding: 15px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; text-align: center;">
                            <div style="color: #92400e; font-weight: 600; margin-bottom: 8px;">üîÑ Procesando ${summarySystemState.selectedImages.length} imagen${summarySystemState.selectedImages.length === 1 ? '' : 'es'}</div>
                            <div style="color: #78350f; font-size: 13px;">Esto puede tomar unos momentos...</div>
                            <div style="width: 100%; background: #fed7aa; border-radius: 10px; height: 8px; margin-top: 10px; overflow: hidden;">
                                <div style="width: 100%; height: 100%; background: #f59e0b; border-radius: 10px; animation: pulse 1.5s infinite;"></div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Gesti√≥n de Temas para Res√∫menes -->
                    <div style="padding: 15px; background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px;">
                        <h4 style="color: #0c4a6e; margin-bottom: 15px;">üè∑Ô∏è Organizar por Temas</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <button onclick="createSummaryTopic()" class="btn btn-info" style="width: 100%; padding: 8px; font-size: 13px;">
                                üÜï Crear Tema
                            </button>
                            
                            <select id="summary-topic-selector" onchange="updateSelectedSummaryTopic()" style="width: 100%; padding: 8px; border: none; background: #0ea5e9; color: white; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer;" ${summarySystemState.summaryTopics.length === 0 ? 'disabled' : ''}>
                                <option value="">üìÇ Seleccionar Tema</option>
                                ${summarySystemState.summaryTopics.map(topic => `
                                    <option value="${topic.id}" ${summarySystemState.selectedTopicForSummary === topic.id ? 'selected' : ''}>
                                        ${topic.name} (${getSummaryTopicCount(topic.id)})
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        ${summarySystemState.summaryTopics.length === 0 ? `
                            <div style="font-size: 12px; color: #0c4a6e; font-style: italic; text-align: center;">
                                Crea temas para organizar tus res√∫menes
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Consejos mejorados -->
                    <div style="margin-top: 20px; padding: 15px; background: #f0fdf4; border: 2px solid #22c55e; border-radius: 8px;">
                        <h4 style="color: #166534; margin-bottom: 10px;">üí° Consejos para res√∫menes de m√∫ltiples im√°genes</h4>
                        <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #16a34a; line-height: 1.4;">
                            <li>Sube im√°genes relacionadas para un resumen coherente</li>
                            <li>Ordena las im√°genes en secuencia l√≥gica</li>
                            <li>Cada imagen adicional enriquece el resumen final</li>
                            <li>El sistema analizar√° todas las im√°genes como un conjunto</li>
                        </ul>
                    </div>
                </div>

                <div class="column">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">üìù Resumen Generado</h3>
                        ${summarySystemState.generatedSummary ? `
                            <button onclick="saveSummaryToLibrary()" class="btn btn-success" style="padding: 6px 12px; font-size: 12px;">
                                üíæ Guardar
                            </button>
                        ` : ''}
                    </div>
                    
                    <textarea id="generatedSummary" class="textarea" style="min-height: 400px;" placeholder="El resumen de todas las im√°genes aparecer√° aqu√≠ una vez que las proceses..." readonly>${summarySystemState.generatedSummary}</textarea>
                    
                    ${summarySystemState.generatedSummary ? `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                            <button onclick="copySummaryToClipboard()" class="btn btn-info" style="width: 100%; padding: 8px; font-size: 13px;">
                                üìã Copiar al Portapapeles
                            </button>
                            <button onclick="clearCurrentSummary()" class="btn btn-secondary" style="width: 100%; padding: 8px; font-size: 13px;">
                                üóëÔ∏è Limpiar Resumen
                            </button>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 15px; background: #f0fdf4; border: 2px solid #22c55e; border-radius: 8px;">
                            <h4 style="color: #166534; margin-bottom: 10px;">‚úÖ ¬°Resumen de ${summarySystemState.selectedImages.length} imagen${summarySystemState.selectedImages.length === 1 ? '' : 'es'} generado!</h4>
                            <p style="margin: 0; font-size: 13px; color: #16a34a;">
                                El resumen integra el contenido de todas las im√°genes procesadas.
                            </p>
                        </div>
                    ` : ''}
                </div>
            </div>
            
            <style>
                @keyframes pulse {
                    0%, 100% { opacity: 1; }
                    50% { opacity: 0.5; }
                }
            </style>
        `;
    }
    
    // Nueva funci√≥n para eliminar imagen por √≠ndice
    function removeSummaryImageByIndex(index) {
        summarySystemState.selectedImages.splice(index, 1);
        summarySystemState.generatedSummary = ''; // Limpiar resumen al cambiar im√°genes
        render();
        showMessage(`Imagen eliminada (${summarySystemState.selectedImages.length}/10 restantes)`, 'success');
    }
    
    // ACTUALIZAR el event listener para m√∫ltiples im√°genes
    document.removeEventListener('change', handleSummaryImageChange); // Remover listener anterior si existe
    
    function handleSummaryImageChange(e) {
        if (e.target && e.target.id === 'summaryImageInput') {
            const files = Array.from(e.target.files);
            const imageFiles = files.filter(file => file.type.startsWith('image/'));
            
            if (imageFiles.length > 0) {
                // Calcular cu√°ntas im√°genes podemos a√±adir
                const currentCount = summarySystemState.selectedImages.length;
                const maxNew = Math.min(imageFiles.length, 10 - currentCount);
                
                if (maxNew > 0) {
                    const newImages = imageFiles.slice(0, maxNew);
                    summarySystemState.selectedImages.push(...newImages);
                    summarySystemState.generatedSummary = ''; // Limpiar resumen al cambiar im√°genes
                    render();
                    
                    if (maxNew === imageFiles.length) {
                        showMessage(`${maxNew} imagen${maxNew === 1 ? '' : 'es'} a√±adida${maxNew === 1 ? '' : 's'} (${summarySystemState.selectedImages.length}/10)`, 'success');
                    } else {
                        showMessage(`Solo se pudieron a√±adir ${maxNew} de ${imageFiles.length} im√°genes (l√≠mite: 10)`, 'error');
                    }
                } else {
                    showMessage('Ya tienes el m√°ximo de 10 im√°genes seleccionadas', 'error');
                }
            }
            
            // Limpiar el input para permitir seleccionar los mismos archivos de nuevo
            e.target.value = '';
        }
    }
    
    document.addEventListener('change', handleSummaryImageChange);
    
    // Nueva funci√≥n para generar resumen de m√∫ltiples im√°genes
    async function generateMultipleSummary() {
        if (!state.apiKey) {
            showMessage('Configura tu API key primero', 'error');
            return;
        }

        if (summarySystemState.selectedImages.length === 0) {
            showMessage('Selecciona al menos una imagen', 'error');
            return;
        }

        summarySystemState.isProcessing = true;
        render();
        showMessage(`Generando resumen de ${summarySystemState.selectedImages.length} imagen${summarySystemState.selectedImages.length === 1 ? '' : 'es'}...`, 'success');
        
        try {
            // Procesar im√°genes en lotes de 5 para evitar l√≠mites de la API
            let allTranscriptions = [];
            const batchSize = 5;
            
            for (let i = 0; i < summarySystemState.selectedImages.length; i += batchSize) {
                const batch = summarySystemState.selectedImages.slice(i, i + batchSize);
                
                const imageContents = await Promise.all(
                    batch.map(async (file) => {
                        const base64 = await fileToBase64(file);
                        return {
                            type: "image",
                            source: {
                                type: "base64",
                                media_type: file.type,
                                data: base64
                            }
                        };
                    })
                );

                const messageContent = [
                    ...imageContents,
                    {
                        type: "text",
                        text: `Analiza ${batch.length > 1 ? 'estas im√°genes' : 'esta imagen'} y genera un resumen completo e inteligente del contenido conjunto.

INSTRUCCIONES PARA RESUMEN DE M√öLTIPLES IM√ÅGENES:

üéØ OBJETIVO: Crear un resumen unificado que integre toda la informaci√≥n de las im√°genes

üìã PROCESO:
‚Ä¢ Analiza cada imagen individualmente
‚Ä¢ Identifica temas y conceptos comunes entre las im√°genes
‚Ä¢ Integra la informaci√≥n en un resumen coherente y estructurado
‚Ä¢ Organiza por temas principales y subtemas relevantes

üîç QUE INCLUIR:
- Informaci√≥n principal de cada imagen
- Conexiones y relaciones entre las im√°genes
- Conceptos clave que aparecen en m√∫ltiples im√°genes
- Datos, cifras y hechos importantes
- Conclusiones derivadas del conjunto completo

‚ú® FORMATO:
- Comienza con una descripci√≥n general del contenido conjunto
- Organiza en secciones l√≥gicas con encabezados claros
- Usa vi√±etas para informaci√≥n espec√≠fica
- Termina con conclusiones o puntos clave del conjunto

üö´ EVITA:
- Repetir informaci√≥n id√©ntica de diferentes im√°genes
- Hacer el resumen excesivamente largo
- Perder informaci√≥n importante por resumir demasiado

Genera un resumen que capture la esencia completa del material presentado en todas las im√°genes.`
                    }
                ];

                const response = await fetch("/api/anthropic", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-api-key": state.apiKey,
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 3000,
                        messages: [{
                            role: "user",
                            content: messageContent
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                allTranscriptions.push(data.content[0].text);
            }

            // Si hay m√∫ltiples lotes, combinar los res√∫menes
            if (allTranscriptions.length > 1) {
                const combinedResponse = await fetch("/api/anthropic", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-api-key": state.apiKey,
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 3000,
                        messages: [{
                            role: "user",
                            content: `Combina estos res√∫menes parciales en un resumen final coherente y bien estructurado:

${allTranscriptions.map((summary, index) => `PARTE ${index + 1}:\n${summary}`).join('\n\n---\n\n')}

Instrucciones:
- Crea un resumen unificado eliminando redundancias
- Mant√©n toda la informaci√≥n importante
- Organiza de forma l√≥gica y clara
- Usa la estructura m√°s apropiada para el contenido`
                        }]
                    })
                });

                if (!combinedResponse.ok) {
                    throw new Error(`Error ${combinedResponse.status}: ${combinedResponse.statusText}`);
                }

                const combinedData = await combinedResponse.json();
                summarySystemState.generatedSummary = combinedData.content[0].text;
            } else {
                summarySystemState.generatedSummary = allTranscriptions[0];
            }

            summarySystemState.isProcessing = false;
            render();
            showMessage(`¬°Resumen de ${summarySystemState.selectedImages.length} imagen${summarySystemState.selectedImages.length === 1 ? '' : 'es'} generado exitosamente!`, 'success');
            
        } catch (error) {
            summarySystemState.isProcessing = false;
            render();
            showMessage(`Error al generar resumen: ${error.message}`, 'error');
        }
    }
    
    // REEMPLAZAR la funci√≥n removeSummaryImage para compatibilidad
    function removeSummaryImage() {
        summarySystemState.selectedImages = [];
        summarySystemState.generatedSummary = '';
        render();
        showMessage('Todas las im√°genes eliminadas', 'success');
    }
    
    console.log('‚úÖ Parche de m√∫ltiples im√°genes para res√∫menes aplicado correctamente');
</script>
    <!-- 
PARCHE: SISTEMA DE CUENTAS DE USUARIO REAL
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
Este parche implementa un sistema completo de cuentas con persistencia de datos por usuario
-->

<script>
    // ========== PARCHE: SISTEMA DE CUENTAS DE USUARIO REAL ==========
    
    // Gesti√≥n de usuarios mejorada
    const UserManager = {
        // Obtener todos los usuarios del localStorage
        getAllUsers() {
            return JSON.parse(localStorage.getItem('systemUsers') || '{}');
        },
        
        // Guardar todos los usuarios
        saveAllUsers(users) {
            localStorage.setItem('systemUsers', JSON.stringify(users));
        },
        
        // Crear nueva cuenta
        createAccount(username, password, fullName) {
            const users = this.getAllUsers();
            
            if (users[username]) {
                return { success: false, message: 'El usuario ya existe' };
            }
            
            if (username.length < 3) {
                return { success: false, message: 'El usuario debe tener al menos 3 caracteres' };
            }
            
            if (password.length < 6) {
                return { success: false, message: 'La contrase√±a debe tener al menos 6 caracteres' };
            }
            
            users[username] = {
                password: password,
                name: fullName || username,
                createdAt: new Date().toISOString(),
                lastLogin: null
            };
            
            this.saveAllUsers(users);
            return { success: true, message: 'Cuenta creada exitosamente' };
        },
        
        // Verificar credenciales
        verifyLogin(username, password) {
            const users = this.getAllUsers();
            const user = users[username];
            
            if (!user) {
                return { success: false, message: 'Usuario no encontrado' };
            }
            
            if (user.password !== password) {
                return { success: false, message: 'Contrase√±a incorrecta' };
            }
            
            // Actualizar √∫ltimo login
            user.lastLogin = new Date().toISOString();
            this.saveAllUsers(users);
            
            return { success: true, user: user, message: 'Login exitoso' };
        },
        
        // Cambiar contrase√±a
        changePassword(username, oldPassword, newPassword) {
            const users = this.getAllUsers();
            const user = users[username];
            
            if (!user || user.password !== oldPassword) {
                return { success: false, message: 'Contrase√±a actual incorrecta' };
            }
            
            if (newPassword.length < 6) {
                return { success: false, message: 'La nueva contrase√±a debe tener al menos 6 caracteres' };
            }
            
            user.password = newPassword;
            this.saveAllUsers(users);
            
            return { success: true, message: 'Contrase√±a actualizada' };
        }
    };
    
    // Gesti√≥n de datos por usuario
    const UserDataManager = {
        // Obtener clave de datos espec√≠fica del usuario
        getUserDataKey(username, dataType) {
            return `user_${username}_${dataType}`;
        },
        
        // Cargar datos espec√≠ficos del usuario
        loadUserData(username) {
            return {
                questions: JSON.parse(localStorage.getItem(this.getUserDataKey(username, 'questions')) || '[]'),
                topics: JSON.parse(localStorage.getItem(this.getUserDataKey(username, 'topics')) || '[]'),
                testResults: JSON.parse(localStorage.getItem(this.getUserDataKey(username, 'testResults')) || '[]'),
                summaryTopics: JSON.parse(localStorage.getItem(this.getUserDataKey(username, 'summaryTopics')) || '[]'),
                savedSummaries: JSON.parse(localStorage.getItem(this.getUserDataKey(username, 'savedSummaries')) || '[]'),
                apiKey: localStorage.getItem(this.getUserDataKey(username, 'apiKey')) || ''
            };
        },
        
        // Guardar datos espec√≠ficos del usuario
        saveUserData(username, dataType, data) {
            localStorage.setItem(this.getUserDataKey(username, dataType), JSON.stringify(data));
        },
        
        // Limpiar datos del usuario actual de las variables globales
        clearCurrentUserData() {
            state.questions = [];
            state.topics = [];
            state.testResults = [];
            state.selectedTopicForNewQuestions = null;
            state.selectedTopicFilter = 'all';
            state.apiKey = '';
            
            summarySystemState.summaryTopics = [];
            summarySystemState.savedSummaries = [];
            summarySystemState.selectedTopicForSummary = null;
        },
        
        // Cargar datos del usuario en las variables globales
        loadCurrentUserData(username) {
            const userData = this.loadUserData(username);
            
            state.questions = userData.questions;
            state.topics = userData.topics;
            state.testResults = userData.testResults;
            state.apiKey = userData.apiKey;
            
            summarySystemState.summaryTopics = userData.summaryTopics;
            summarySystemState.savedSummaries = userData.savedSummaries;
            
            // Actualizar localStorage para compatibilidad con funciones existentes
            localStorage.setItem('questions', JSON.stringify(userData.questions));
            localStorage.setItem('topics', JSON.stringify(userData.topics));
            localStorage.setItem('testResults', JSON.stringify(userData.testResults));
            localStorage.setItem('summaryTopics', JSON.stringify(userData.summaryTopics));
            localStorage.setItem('savedSummaries', JSON.stringify(userData.savedSummaries));
            localStorage.setItem('anthropic_api_key', userData.apiKey);
        },
        
        // Guardar datos actuales del usuario
        saveCurrentUserData(username) {
            this.saveUserData(username, 'questions', state.questions);
            this.saveUserData(username, 'topics', state.topics);
            this.saveUserData(username, 'testResults', state.testResults);
            this.saveUserData(username, 'summaryTopics', summarySystemState.summaryTopics);
            this.saveUserData(username, 'savedSummaries', summarySystemState.savedSummaries);
            this.saveUserData(username, 'apiKey', state.apiKey);
        }
    };
    
    // Estado del sistema de login mejorado
    let loginState = {
        currentView: 'login', // 'login', 'register', 'forgotPassword'
        isRegistering: false
    };
    
    // REEMPLAZAR la funci√≥n de login principal
    const originalLoginSystem = login;
    login = function() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        
        if (!username || !password) {
            showMessage('Completa todos los campos', 'error');
            return;
        }
        
        const loginResult = UserManager.verifyLogin(username, password);
        
        if (loginResult.success) {
            // Limpiar datos previos
            UserDataManager.clearCurrentUserData();
            
            // Establecer usuario actual
            state.currentUser = { 
                username: username, 
                name: loginResult.user.name 
            };
            
            // Cargar datos del usuario
            UserDataManager.loadCurrentUserData(username);
            
            showIntermediateScreen = true;
            render();
            showMessage(`Bienvenido ${loginResult.user.name}`, 'success');
        } else {
            showMessage(loginResult.message, 'error');
        }
    };
    
    // Funci√≥n para registrar nueva cuenta
    function registerAccount() {
        const username = document.getElementById('reg-username').value.trim();
        const password = document.getElementById('reg-password').value;
        const confirmPassword = document.getElementById('reg-confirm-password').value;
        const fullName = document.getElementById('reg-fullname').value.trim();
        
        if (!username || !password || !confirmPassword || !fullName) {
            showMessage('Completa todos los campos', 'error');
            return;
        }
        
        if (password !== confirmPassword) {
            showMessage('Las contrase√±as no coinciden', 'error');
            return;
        }
        
        const registerResult = UserManager.createAccount(username, password, fullName);
        
        if (registerResult.success) {
            showMessage('Cuenta creada exitosamente. Ahora puedes iniciar sesi√≥n.', 'success');
            loginState.currentView = 'login';
            render();
        } else {
            showMessage(registerResult.message, 'error');
        }
    }
    
    // Funci√≥n para mostrar formulario de registro
    function showRegisterForm() {
        loginState.currentView = 'register';
        render();
    }
    
    // Funci√≥n para mostrar formulario de login
    function showLoginForm() {
        loginState.currentView = 'login';
        render();
    }
    
    // REEMPLAZAR la funci√≥n de logout
    const originalLogoutSystem = logout;
    logout = function() {
        if (state.currentUser) {
            // Guardar datos antes de hacer logout
            UserDataManager.saveCurrentUserData(state.currentUser.username);
        }
        
        // Limpiar estado
        UserDataManager.clearCurrentUserData();
        state.currentUser = null;
        showIntermediateScreen = false;
        state.currentTab = 'upload';
        loginState.currentView = 'login';
        
        render();
        
    };
    
    // Funci√≥n para cambiar contrase√±a
    function showChangePassword() {
        if (!state.currentUser) return;
        
        const oldPassword = prompt('Contrase√±a actual:');
        if (!oldPassword) return;
        
        const newPassword = prompt('Nueva contrase√±a (m√≠nimo 6 caracteres):');
        if (!newPassword) return;
        
        const confirmNewPassword = prompt('Confirmar nueva contrase√±a:');
        if (newPassword !== confirmNewPassword) {
            showMessage('Las contrase√±as no coinciden', 'error');
            return;
        }
        
        const result = UserManager.changePassword(state.currentUser.username, oldPassword, newPassword);
        showMessage(result.message, result.success ? 'success' : 'error');
    }
    
    // INTERCEPTAR todas las funciones de guardado para usar el sistema por usuario
    
    // Interceptar guardado de preguntas
    const originalQuestionSave = () => {
        const originalSetItem = localStorage.setItem;
        return function(key, value) {
            if (key === 'questions' && state.currentUser) {
                UserDataManager.saveUserData(state.currentUser.username, 'questions', JSON.parse(value));
            } else if (key === 'topics' && state.currentUser) {
                UserDataManager.saveUserData(state.currentUser.username, 'topics', JSON.parse(value));
            } else if (key === 'testResults' && state.currentUser) {
                UserDataManager.saveUserData(state.currentUser.username, 'testResults', JSON.parse(value));
            } else if (key === 'summaryTopics' && state.currentUser) {
                UserDataManager.saveUserData(state.currentUser.username, 'summaryTopics', JSON.parse(value));
            } else if (key === 'savedSummaries' && state.currentUser) {
                UserDataManager.saveUserData(state.currentUser.username, 'savedSummaries', JSON.parse(value));
            } else if (key === 'anthropic_api_key' && state.currentUser) {
                UserDataManager.saveUserData(state.currentUser.username, 'apiKey', value);
            }
            return originalSetItem.call(this, key, value);
        };
    };
    
    // Aplicar la interceptaci√≥n
    localStorage.setItem = originalQuestionSave();
    
    // ACTUALIZAR la funci√≥n render para mostrar las nuevas pantallas de login
    const originalRenderWithAccounts = render;
    render = function() {
        if (!state.currentUser) {
            const app = document.getElementById('app');
            
            if (loginState.currentView === 'register') {
                // Formulario de registro
                app.innerHTML = `
                    <div class="container">
                        <div class="login-form" style="max-width: 500px;">
                            <div style="text-align: center; margin-bottom: 30px;">
                                <div style="background: linear-gradient(135deg, #4f46e5, #7c3aed); width: 80px; height: 80px; border-radius: 20px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);">
                                    <span style="font-size: 2.5rem; filter: drop-shadow(0 2px 4px rgba(255,255,255,0.3));">üë§</span>
                                </div>
                                <h2 style="color: #1f2937; margin: 0;">Crear Nueva Cuenta</h2>
                                <p style="color: #6b7280; margin: 10px 0 0 0; font-size: 14px;">√önete al sistema de ex√°menes</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Nombre completo</label>
                                <input type="text" id="reg-fullname" class="form-input" placeholder="Tu nombre completo">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Usuario</label>
                                <input type="text" id="reg-username" class="form-input" placeholder="M√≠nimo 3 caracteres">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contrase√±a</label>
                                <input type="password" id="reg-password" class="form-input" placeholder="M√≠nimo 6 caracteres">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Confirmar contrase√±a</label>
                                <input type="password" id="reg-confirm-password" class="form-input" placeholder="Repite la contrase√±a">
                            </div>
                            <button onclick="registerAccount()" class="btn btn-primary" style="width: 100%; margin-bottom: 15px;">
                                Crear Cuenta
                            </button>
                            
                            <div style="text-align: center;">
                                <button onclick="showLoginForm()" class="btn btn-secondary" style="background: transparent; color: #6b7280; border: none; text-decoration: underline;">
                                    ¬øYa tienes cuenta? Iniciar sesi√≥n
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Formulario de login mejorado
                app.innerHTML = `
                    <div class="container">
                        <div class="login-form" style="max-width: 450px;">
                            <div style="text-align: center; margin-bottom: 30px;">
                                <div style="background: linear-gradient(135deg, #059669, #0ea5e9); width: 80px; height: 80px; border-radius: 20px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(5, 150, 105, 0.3);">
                                    <span style="font-size: 2.5rem; filter: drop-shadow(0 2px 4px rgba(255,255,255,0.3));">üîê</span>
                                </div>
                                <h2 style="color: #1f2937; margin: 0;">Iniciar Sesi√≥n</h2>
                                <p style="color: #6b7280; margin: 10px 0 0 0; font-size: 14px;">Accede a tu cuenta personal</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Usuario</label>
                                <input type="text" id="username" class="form-input" placeholder="Tu nombre de usuario">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contrase√±a</label>
                                <input type="password" id="password" class="form-input" placeholder="Tu contrase√±a">
                            </div>
                            <button onclick="login()" class="btn btn-primary" style="width: 100%; margin-bottom: 20px;">
                                Iniciar Sesi√≥n
                            </button>
                            
                            <div style="text-align: center; border-top: 1px solid #e5e7eb; padding-top: 20px;">
                                <p style="color: #6b7280; margin: 0 0 15px 0; font-size: 14px;">¬øNo tienes una cuenta?</p>
                                <button onclick="showRegisterForm()" class="btn btn-info" style="width: 100%;">
                                    Crear Nueva Cuenta
                                </button>
                            </div>
                            
                            <div style="margin-top: 25px; padding: 15px; background: #f3f4f6; border-radius: 8px;">
                                <h4 style="color: #374151; margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">‚ÑπÔ∏è Informaci√≥n del Sistema</h4>
                                <ul style="margin: 0; padding-left: 20px; color: #6b7280; font-size: 12px; line-height: 1.4;">
                                    <li>Cada usuario tiene sus propios datos</li>
                                    <li>Tus preguntas y tests son privados</li>
                                    <li>Los datos se guardan autom√°ticamente</li>
                                    <li>Puedes cambiar tu contrase√±a desde el perfil</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }
        } else {
            // Usuario logueado - usar funci√≥n original
            originalRenderWithAccounts();
        }
    };
    
    // MEJORAR el header para mostrar opciones de cuenta
    const originalRenderHeaderButtons = () => {
        const originalFunction = originalRenderWithAccounts;
        return function() {
            if (!state.currentUser) {
                originalFunction.call(this);
                return;
            }
            
            const app = document.getElementById('app');
            
            if (showIntermediateScreen && state.currentUser) {
                app.innerHTML = `
                    <div class="container">
                        <div class="header">
                            <div class="title">Sistema de Ex√°menes</div>
                            <div>
                                <span style="color: ${state.apiKey ? '#10b981' : '#ef4444'};">
                                    ${state.apiKey ? '‚úÖ API Configurada' : '‚ùå Sin API'}
                                </span>
                                <button onclick="configureAPI()" class="btn btn-secondary">API</button>
                                <button onclick="showChangePassword()" class="btn btn-warning" title="Cambiar contrase√±a">üîë</button>
                                <span style="color: #f59e0b;">üë§ ${state.currentUser.name}</span>
                                <button onclick="logout()" class="btn btn-danger">Salir</button>
                            </div>
                        </div>
                        ${renderIntermediateScreen()}
                    </div>
                `;
            } else if (state.currentUser) {
                // Determinar el t√≠tulo seg√∫n la pesta√±a actual
                let pageTitle = 'Sistema de Ex√°menes';
                if (state.currentTab === 'questions') pageTitle = 'Banco de Preguntas';
                else if (state.currentTab === 'results') pageTitle = 'Resultados del Test';
                else if (state.currentTab === 'summary') pageTitle = 'Generador de Res√∫menes';
                
                // Solo mostrar pesta√±as si NO estamos en summary
                const showNavTabs = state.currentTab !== 'summary';
                
                app.innerHTML = `
                    <div class="container">
                        <div class="header">
                            <div class="title">${pageTitle}</div>
                            <div>
                                <span style="color: ${state.apiKey ? '#10b981' : '#ef4444'};">
                                    ${state.apiKey ? '‚úÖ API Configurada' : '‚ùå Sin API'}
                                </span>
                                <button onclick="configureAPI()" class="btn btn-secondary">API</button>
                                <button onclick="showChangePassword()" class="btn btn-warning" title="Cambiar contrase√±a">üîë</button>
                                <span style="color: #f59e0b;">üë§ ${state.currentUser.name}</span>
                                <button onclick="logout()" class="btn btn-danger">Salir</button>
                            </div>
                        </div>

                        ${showNavTabs ? `
                            <div class="nav-tabs">
                                <button class="nav-tab ${state.currentTab === 'upload' ? 'active' : ''}" onclick="setTab('upload')">
                                    üì§ Subir Test
                                </button>
                                <button class="nav-tab ${state.currentTab === 'questions' ? 'active' : ''}" onclick="setTab('questions')">
                                    üìã Banco de Preguntas (${getFilteredQuestions().length})
                                </button>
                                <button class="nav-tab ${state.currentTab === 'test' ? 'active' : ''}" onclick="setTab('test')">
                                    üéØ Test Aleatorio
                                </button>
                                <button class="nav-tab ${state.currentTab === 'results' ? 'active' : ''}" onclick="setTab('results')">
                                    üìä Resultados (${state.testResults.length})
                                </button>
                            </div>
                        ` : ''}

                        <div id="messages"></div>

                        ${renderTabContent()}
                    </div>
                `;
            } else {
                originalFunction.call(this);
            }
        };
    };
    
    render = originalRenderHeaderButtons();
    
    // Asegurar que los datos se guarden peri√≥dicamente
    setInterval(() => {
        if (state.currentUser) {
            UserDataManager.saveCurrentUserData(state.currentUser.username);
        }
    }, 30000); // Guardar cada 30 segundos
    
    // Guardar datos antes de cerrar la ventana
    window.addEventListener('beforeunload', () => {
        if (state.currentUser) {
            UserDataManager.saveCurrentUserData(state.currentUser.username);
        }
    });
    
    console.log('‚úÖ Sistema de cuentas de usuario real implementado correctamente');
    console.log('üìä Usuarios registrados:', Object.keys(UserManager.getAllUsers()).length);
</script>
    <!-- 
PARCHE FORZADO: REEMPLAZAR SISTEMA DE LOGIN COMPLETAMENTE
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
Este parche FUERZA el nuevo sistema de cuentas y elimina la cuenta demo
-->

<script>
    // ========== PARCHE FORZADO: SISTEMA DE CUENTAS REAL ==========
    console.log('üîß APLICANDO PARCHE FORZADO DE CUENTAS...');
    
    // ELIMINAR la variable users antigua completamente
    window.users = undefined;
    
    // Gesti√≥n de usuarios REAL
    const RealUserManager = {
        getUsersKey() {
            return 'realSystemUsers';
        },
        
        getAllUsers() {
            return JSON.parse(localStorage.getItem(this.getUsersKey()) || '{}');
        },
        
        saveAllUsers(users) {
            localStorage.setItem(this.getUsersKey(), JSON.stringify(users));
        },
        
        createAccount(username, password, fullName) {
            const users = this.getAllUsers();
            
            if (users[username]) {
                return { success: false, message: 'El usuario ya existe' };
            }
            
            if (username.length < 3) {
                return { success: false, message: 'El usuario debe tener al menos 3 caracteres' };
            }
            
            if (password.length < 4) {
                return { success: false, message: 'La contrase√±a debe tener al menos 4 caracteres' };
            }
            
            users[username] = {
                password: password,
                name: fullName || username,
                createdAt: new Date().toLocaleString('es-ES'),
                lastLogin: null
            };
            
            this.saveAllUsers(users);
            console.log('‚úÖ Nueva cuenta creada:', username);
            return { success: true, message: 'Cuenta creada exitosamente' };
        },
        
        verifyLogin(username, password) {
            const users = this.getAllUsers();
            const user = users[username];
            
            if (!user) {
                return { success: false, message: 'Usuario no encontrado' };
            }
            
            if (user.password !== password) {
                return { success: false, message: 'Contrase√±a incorrecta' };
            }
            
            user.lastLogin = new Date().toLocaleString('es-ES');
            this.saveAllUsers(users);
            
            return { success: true, user: user, message: 'Login exitoso' };
        }
    };
    
    // Gesti√≥n de datos por usuario
    const RealDataManager = {
        getUserDataKey(username, dataType) {
            return `realUser_${username}_${dataType}`;
        },
        
        loadUserData(username) {
            return {
                questions: JSON.parse(localStorage.getItem(this.getUserDataKey(username, 'questions')) || '[]'),
                topics: JSON.parse(localStorage.getItem(this.getUserDataKey(username, 'topics')) || '[]'),
                testResults: JSON.parse(localStorage.getItem(this.getUserDataKey(username, 'testResults')) || '[]'),
                summaryTopics: JSON.parse(localStorage.getItem(this.getUserDataKey(username, 'summaryTopics')) || '[]'),
                savedSummaries: JSON.parse(localStorage.getItem(this.getUserDataKey(username, 'savedSummaries')) || '[]'),
                apiKey: localStorage.getItem(this.getUserDataKey(username, 'apiKey')) || ''
            };
        },
        
        saveUserData(username, dataType, data) {
            localStorage.setItem(this.getUserDataKey(username, dataType), typeof data === 'string' ? data : JSON.stringify(data));
        },
        
        clearGlobalData() {
            state.questions = [];
            state.topics = [];
            state.testResults = [];
            state.selectedTopicForNewQuestions = null;
            state.selectedTopicFilter = 'all';
            state.apiKey = '';
            
            if (typeof summarySystemState !== 'undefined') {
                summarySystemState.summaryTopics = [];
                summarySystemState.savedSummaries = [];
                summarySystemState.selectedTopicForSummary = null;
            }
        },
        
        loadIntoGlobalData(username) {
            const userData = this.loadUserData(username);
            
            state.questions = userData.questions;
            state.topics = userData.topics;
            state.testResults = userData.testResults;
            state.apiKey = userData.apiKey;
            
            if (typeof summarySystemState !== 'undefined') {
                summarySystemState.summaryTopics = userData.summaryTopics;
                summarySystemState.savedSummaries = userData.savedSummaries;
            }
            
            // Sincronizar con localStorage para compatibilidad
            localStorage.setItem('questions', JSON.stringify(userData.questions));
            localStorage.setItem('topics', JSON.stringify(userData.topics));
            localStorage.setItem('testResults', JSON.stringify(userData.testResults));
            localStorage.setItem('summaryTopics', JSON.stringify(userData.summaryTopics));
            localStorage.setItem('savedSummaries', JSON.stringify(userData.savedSummaries));
            localStorage.setItem('anthropic_api_key', userData.apiKey);
        },
        
        saveFromGlobalData(username) {
            this.saveUserData(username, 'questions', state.questions);
            this.saveUserData(username, 'topics', state.topics);
            this.saveUserData(username, 'testResults', state.testResults);
            this.saveUserData(username, 'apiKey', state.apiKey);
            
            if (typeof summarySystemState !== 'undefined') {
                this.saveUserData(username, 'summaryTopics', summarySystemState.summaryTopics);
                this.saveUserData(username, 'savedSummaries', summarySystemState.savedSummaries);
            }
        }
    };
    
    // Estado del login
    let newLoginState = {
        currentView: 'login', // 'login', 'register'
        showRegister: false
    };
    
    // INTERCEPTAR y REEMPLAZAR todas las funciones de localStorage
    const originalSetItem = localStorage.setItem;
    localStorage.setItem = function(key, value) {
        if (state.currentUser && state.currentUser.username) {
            if (key === 'questions') {
                RealDataManager.saveUserData(state.currentUser.username, 'questions', value);
            } else if (key === 'topics') {
                RealDataManager.saveUserData(state.currentUser.username, 'topics', value);
            } else if (key === 'testResults') {
                RealDataManager.saveUserData(state.currentUser.username, 'testResults', value);
            } else if (key === 'summaryTopics') {
                RealDataManager.saveUserData(state.currentUser.username, 'summaryTopics', value);
            } else if (key === 'savedSummaries') {
                RealDataManager.saveUserData(state.currentUser.username, 'savedSummaries', value);
            } else if (key === 'anthropic_api_key') {
                RealDataManager.saveUserData(state.currentUser.username, 'apiKey', value);
            }
        }
        return originalSetItem.call(this, key, value);
    };
    
    // REEMPLAZAR funci√≥n de login COMPLETAMENTE
    window.login = function() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        
        if (!username || !password) {
            showMessage('Completa todos los campos', 'error');
            return;
        }
        
        const loginResult = RealUserManager.verifyLogin(username, password);
        
        if (loginResult.success) {
            console.log('‚úÖ Login exitoso para:', username);
            
            // Limpiar datos previos
            RealDataManager.clearGlobalData();
            
            // Establecer usuario actual
            state.currentUser = { 
                username: username, 
                name: loginResult.user.name 
            };
            
            // Cargar datos del usuario
            RealDataManager.loadIntoGlobalData(username);
            
            showIntermediateScreen = true;
            render();
            showMessage(`Bienvenido ${loginResult.user.name}`, 'success');
        } else {
            showMessage(loginResult.message, 'error');
        }
    };
    
    // Nueva funci√≥n de registro
    window.registerNewAccount = function() {
        const username = document.getElementById('reg-username').value.trim();
        const password = document.getElementById('reg-password').value;
        const confirmPassword = document.getElementById('reg-confirm-password').value;
        const fullName = document.getElementById('reg-fullname').value.trim();
        
        if (!username || !password || !confirmPassword || !fullName) {
            showMessage('Completa todos los campos', 'error');
            return;
        }
        
        if (password !== confirmPassword) {
            showMessage('Las contrase√±as no coinciden', 'error');
            return;
        }
        
        const registerResult = RealUserManager.createAccount(username, password, fullName);
        
        if (registerResult.success) {
            showMessage('¬°Cuenta creada! Ahora puedes iniciar sesi√≥n', 'success');
            newLoginState.currentView = 'login';
            newLoginState.showRegister = false;
            render();
        } else {
            showMessage(registerResult.message, 'error');
        }
    };
    
    // Funciones de navegaci√≥n
    window.showRegisterForm = function() {
        newLoginState.currentView = 'register';
        newLoginState.showRegister = true;
        render();
    };
    
    window.showLoginForm = function() {
        newLoginState.currentView = 'login';
        newLoginState.showRegister = false;
        render();
    };
    
    // REEMPLAZAR funci√≥n de logout COMPLETAMENTE
    window.logout = function() {
        if (state.currentUser) {
            console.log('üíæ Guardando datos antes de logout...');
            RealDataManager.saveFromGlobalData(state.currentUser.username);
        }
        
        // Limpiar estado
        RealDataManager.clearGlobalData();
        state.currentUser = null;
        showIntermediateScreen = false;
        state.currentTab = 'upload';
        newLoginState.currentView = 'login';
        
        render();
        showMessage('Sesi√≥n cerrada correctamente', 'success');
    };
    
    // REEMPLAZAR funci√≥n render COMPLETAMENTE
    const originalRenderFunction = render;
    window.render = function() {
        const app = document.getElementById('app');
        
        // Si no hay usuario logueado, mostrar login/registro
        if (!state.currentUser) {
            if (newLoginState.currentView === 'register' || newLoginState.showRegister) {
                // Pantalla de registro
                app.innerHTML = `
                    <div class="container">
                        <div class="login-form" style="max-width: 500px;">
                            <div style="text-align: center; margin-bottom: 30px;">
                                <div style="background: linear-gradient(135deg, #10b981, #059669); width: 80px; height: 80px; border-radius: 20px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);">
                                    <span style="font-size: 2.5rem; color: white;">üë§</span>
                                </div>
                                <h2 style="color: #1f2937; margin: 0; font-weight: 700;">Crear Nueva Cuenta</h2>
                                <p style="color: #6b7280; margin: 10px 0 0 0; font-size: 14px;">Reg√≠strate para acceder al sistema</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Nombre completo</label>
                                <input type="text" id="reg-fullname" class="form-input" placeholder="Tu nombre completo" style="font-size: 15px; padding: 12px;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Usuario</label>
                                <input type="text" id="reg-username" class="form-input" placeholder="M√≠nimo 3 caracteres" style="font-size: 15px; padding: 12px;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contrase√±a</label>
                                <input type="password" id="reg-password" class="form-input" placeholder="M√≠nimo 4 caracteres" style="font-size: 15px; padding: 12px;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Confirmar contrase√±a</label>
                                <input type="password" id="reg-confirm-password" class="form-input" placeholder="Repite la contrase√±a" style="font-size: 15px; padding: 12px;">
                            </div>
                            
                            <button onclick="registerNewAccount()" class="btn btn-success" style="width: 100%; margin-bottom: 15px; padding: 15px; font-size: 16px; font-weight: 600;">
                                ‚úÖ Crear Mi Cuenta
                            </button>
                            
                            <div style="text-align: center; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                                <button onclick="showLoginForm()" class="btn btn-secondary" style="background: transparent; color: #6b7280; border: 1px solid #d1d5db; padding: 10px 20px;">
                                    ‚Üê Ya tengo cuenta
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Pantalla de login SIN cuenta demo
                app.innerHTML = `
                    <div class="container">
                        <div class="login-form" style="max-width: 450px;">
                            <div style="text-align: center; margin-bottom: 30px;">
                                <div style="background: linear-gradient(135deg, #4f46e5, #7c3aed); width: 80px; height: 80px; border-radius: 20px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);">
                                    <span style="font-size: 2.5rem; color: white;">üîê</span>
                                </div>
                                <h2 style="color: #1f2937; margin: 0; font-weight: 700;">Iniciar Sesi√≥n</h2>
                                <p style="color: #6b7280; margin: 10px 0 0 0; font-size: 14px;">Accede a tu cuenta personal</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Usuario</label>
                                <input type="text" id="username" class="form-input" placeholder="Tu nombre de usuario" style="font-size: 15px; padding: 12px;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contrase√±a</label>
                                <input type="password" id="password" class="form-input" placeholder="Tu contrase√±a" style="font-size: 15px; padding: 12px;">
                            </div>
                            
                            <button onclick="login()" class="btn btn-primary" style="width: 100%; margin-bottom: 20px; padding: 15px; font-size: 16px; font-weight: 600;">
                                üöÄ Iniciar Sesi√≥n
                            </button>
                            
                            <div style="text-align: center; border-top: 1px solid #e5e7eb; padding-top: 20px;">
                                <p style="color: #6b7280; margin: 0 0 15px 0; font-size: 14px;">¬øNo tienes una cuenta?</p>
                                <button onclick="showRegisterForm()" class="btn btn-success" style="width: 100%; padding: 12px; font-size: 15px; font-weight: 600;">
                                    üë§ Crear Nueva Cuenta
                                </button>
                            </div>
                            
                            <div style="margin-top: 25px; padding: 15px; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0;">
                                <div style="text-align: center; margin-bottom: 10px;">
                                    <strong style="color: #374151; font-size: 14px;">üîí Sistema Seguro</strong>
                                </div>
                                <ul style="margin: 0; padding-left: 20px; color: #6b7280; font-size: 12px; line-height: 1.5;">
                                    <li>Datos privados por usuario</li>
                                    <li>Cuentas reales y seguras</li>
                                    <li>Sin acceso a datos de otros</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }
        } else {
            // Usuario logueado - usar funci√≥n original
            originalRenderFunction.call(this);
        }
    };
    
    // Guardar datos autom√°ticamente cada 30 segundos
    setInterval(() => {
        if (state.currentUser) {
            RealDataManager.saveFromGlobalData(state.currentUser.username);
        }
    }, 30000);
    
    // Guardar antes de cerrar ventana
    window.addEventListener('beforeunload', () => {
        if (state.currentUser) {
            RealDataManager.saveFromGlobalData(state.currentUser.username);
        }
    });
    
    console.log('‚úÖ PARCHE FORZADO APLICADO - Sistema de cuentas reales activo');
    console.log('üìä Usuarios registrados:', Object.keys(RealUserManager.getAllUsers()).length);
    
    // Forzar re-renderizado
    setTimeout(() => {
        render();
    }, 100);
</script>
    <!-- 
PARCHE: SISTEMA DE RECUPERACI√ìN DE CONTRASE√ëA
A√±adir este c√≥digo DESPU√âS de los parches anteriores, antes de </body>
Este parche a√±ade recuperaci√≥n de contrase√±a mediante pregunta de seguridad
-->

<script>
    // ========== PARCHE: SISTEMA DE RECUPERACI√ìN DE CONTRASE√ëA ==========
    
    // Ampliar el UserManager para incluir preguntas de seguridad
    const PasswordRecoveryManager = {
        // A√±adir pregunta de seguridad al crear cuenta
        createAccountWithSecurity(username, password, fullName, securityQuestion, securityAnswer) {
            const users = RealUserManager.getAllUsers();
            
            if (users[username]) {
                return { success: false, message: 'El usuario ya existe' };
            }
            
            if (username.length < 3) {
                return { success: false, message: 'El usuario debe tener al menos 3 caracteres' };
            }
            
            if (password.length < 4) {
                return { success: false, message: 'La contrase√±a debe tener al menos 4 caracteres' };
            }
            
            if (!securityAnswer || securityAnswer.trim().length < 2) {
                return { success: false, message: 'La respuesta de seguridad es muy corta' };
            }
            
            users[username] = {
                password: password,
                name: fullName || username,
                securityQuestion: securityQuestion,
                securityAnswer: securityAnswer.toLowerCase().trim(), // Normalizar para comparaci√≥n
                createdAt: new Date().toLocaleString('es-ES'),
                lastLogin: null
            };
            
            RealUserManager.saveAllUsers(users);
            return { success: true, message: 'Cuenta creada exitosamente' };
        },
        
        // Verificar si el usuario existe para recuperaci√≥n
        userExists(username) {
            const users = RealUserManager.getAllUsers();
            return !!users[username];
        },
        
        // Obtener pregunta de seguridad
        getSecurityQuestion(username) {
            const users = RealUserManager.getAllUsers();
            const user = users[username];
            
            if (!user) {
                return { success: false, message: 'Usuario no encontrado' };
            }
            
            return { 
                success: true, 
                question: user.securityQuestion,
                message: 'Pregunta de seguridad encontrada'
            };
        },
        
        // Verificar respuesta y recuperar contrase√±a
        recoverPassword(username, securityAnswer) {
            const users = RealUserManager.getAllUsers();
            const user = users[username];
            
            if (!user) {
                return { success: false, message: 'Usuario no encontrado' };
            }
            
            if (user.securityAnswer !== securityAnswer.toLowerCase().trim()) {
                return { success: false, message: 'Respuesta de seguridad incorrecta' };
            }
            
            return { 
                success: true, 
                password: user.password,
                message: 'Contrase√±a recuperada exitosamente'
            };
        },
        
        // Cambiar contrase√±a despu√©s de recuperaci√≥n
        resetPassword(username, newPassword, securityAnswer) {
            const users = RealUserManager.getAllUsers();
            const user = users[username];
            
            if (!user) {
                return { success: false, message: 'Usuario no encontrado' };
            }
            
            if (user.securityAnswer !== securityAnswer.toLowerCase().trim()) {
                return { success: false, message: 'Respuesta de seguridad incorrecta' };
            }
            
            if (newPassword.length < 4) {
                return { success: false, message: 'La nueva contrase√±a debe tener al menos 4 caracteres' };
            }
            
            user.password = newPassword;
            RealUserManager.saveAllUsers(users);
            
            return { success: true, message: 'Contrase√±a cambiada exitosamente' };
        }
    };
    
    // Preguntas de seguridad predefinidas
    const securityQuestions = [
        "¬øCu√°l es el nombre de tu primera mascota?",
        "¬øEn qu√© ciudad naciste?",
        "¬øCu√°l es tu color favorito?",
        "¬øC√≥mo se llama tu mejor amigo de la infancia?",
        "¬øCu√°l es tu comida favorita?",
        "¬øEn qu√© a√±o terminaste la escuela?",
        "¬øCu√°l es el nombre de tu madre?",
        "¬øCu√°l es tu pel√≠cula favorita?"
    ];
    
    // Actualizar el estado de login para incluir recuperaci√≥n
    newLoginState.currentView = 'login'; // 'login', 'register', 'forgot', 'recovery'
    
    // REEMPLAZAR la funci√≥n de registro para incluir pregunta de seguridad
    window.registerNewAccount = function() {
        const username = document.getElementById('reg-username').value.trim();
        const password = document.getElementById('reg-password').value;
        const confirmPassword = document.getElementById('reg-confirm-password').value;
        const fullName = document.getElementById('reg-fullname').value.trim();
        const securityQuestion = document.getElementById('security-question').value;
        const securityAnswer = document.getElementById('security-answer').value.trim();
        
        if (!username || !password || !confirmPassword || !fullName || !securityQuestion || !securityAnswer) {
            showMessage('Completa todos los campos', 'error');
            return;
        }
        
        if (password !== confirmPassword) {
            showMessage('Las contrase√±as no coinciden', 'error');
            return;
        }
        
        const registerResult = PasswordRecoveryManager.createAccountWithSecurity(
            username, password, fullName, securityQuestion, securityAnswer
        );
        
        if (registerResult.success) {
            showMessage('¬°Cuenta creada! Ahora puedes iniciar sesi√≥n', 'success');
            newLoginState.currentView = 'login';
            render();
        } else {
            showMessage(registerResult.message, 'error');
        }
    };
    
    // Funciones para recuperaci√≥n de contrase√±a
    window.showForgotPassword = function() {
        newLoginState.currentView = 'forgot';
        render();
    };
    
    window.startPasswordRecovery = function() {
        const username = document.getElementById('forgot-username').value.trim();
        
        if (!username) {
            showMessage('Ingresa tu nombre de usuario', 'error');
            return;
        }
        
        if (!PasswordRecoveryManager.userExists(username)) {
            showMessage('Usuario no encontrado', 'error');
            return;
        }
        
        const result = PasswordRecoveryManager.getSecurityQuestion(username);
        
        if (result.success) {
            // Guardar username temporalmente y mostrar pregunta de seguridad
            window.tempRecoveryUsername = username;
            window.tempRecoveryQuestion = result.question;
            newLoginState.currentView = 'recovery';
            render();
        } else {
            showMessage(result.message, 'error');
        }
    };
    
    window.recoverPassword = function() {
        const securityAnswer = document.getElementById('security-answer-recovery').value.trim();
        
        if (!securityAnswer) {
            showMessage('Responde la pregunta de seguridad', 'error');
            return;
        }
        
        const result = PasswordRecoveryManager.recoverPassword(window.tempRecoveryUsername, securityAnswer);
        
        if (result.success) {
            showMessage(`Tu contrase√±a es: ${result.password}`, 'success');
            
            // Limpiar variables temporales
            window.tempRecoveryUsername = null;
            window.tempRecoveryQuestion = null;
            
            // Volver al login despu√©s de 3 segundos
            setTimeout(() => {
                newLoginState.currentView = 'login';
                render();
            }, 3000);
        } else {
            showMessage(result.message, 'error');
        }
    };
    
    // ACTUALIZAR la funci√≥n render para incluir las nuevas pantallas
    const previousRenderFunction = window.render;
    window.render = function() {
        const app = document.getElementById('app');
        
        if (!state.currentUser) {
            if (newLoginState.currentView === 'register') {
                // Pantalla de registro CON pregunta de seguridad
                app.innerHTML = `
                    <div class="container">
                        <div class="login-form" style="max-width: 500px;">
                            <div style="text-align: center; margin-bottom: 25px;">
                                <div style="background: linear-gradient(135deg, #10b981, #059669); width: 80px; height: 80px; border-radius: 20px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);">
                                    <span style="font-size: 2.5rem; color: white;">üë§</span>
                                </div>
                                <h2 style="color: #1f2937; margin: 0; font-weight: 700;">Crear Nueva Cuenta</h2>
                                <p style="color: #6b7280; margin: 10px 0 0 0; font-size: 14px;">Reg√≠strate para acceder al sistema</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Nombre completo</label>
                                <input type="text" id="reg-fullname" class="form-input" placeholder="Tu nombre completo">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Usuario</label>
                                <input type="text" id="reg-username" class="form-input" placeholder="M√≠nimo 3 caracteres">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contrase√±a</label>
                                <input type="password" id="reg-password" class="form-input" placeholder="M√≠nimo 4 caracteres">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Confirmar contrase√±a</label>
                                <input type="password" id="reg-confirm-password" class="form-input" placeholder="Repite la contrase√±a">
                            </div>
                            
                            <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                                <h4 style="color: #92400e; margin: 0 0 10px 0; font-size: 14px;">üîê Pregunta de Seguridad</h4>
                                <p style="color: #78350f; margin: 0 0 15px 0; font-size: 12px;">Para recuperar tu contrase√±a si la olvidas</p>
                                
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <select id="security-question" class="form-input" style="margin-bottom: 10px;">
                                        <option value="">Selecciona una pregunta...</option>
                                        ${securityQuestions.map(q => `<option value="${q}">${q}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div class="form-group" style="margin-bottom: 0;">
                                    <input type="text" id="security-answer" class="form-input" placeholder="Tu respuesta">
                                </div>
                            </div>
                            
                            <button onclick="registerNewAccount()" class="btn btn-success" style="width: 100%; margin-bottom: 15px; padding: 15px; font-size: 16px; font-weight: 600;">
                                ‚úÖ Crear Mi Cuenta
                            </button>
                            
                            <div style="text-align: center; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                                <button onclick="showLoginForm()" class="btn btn-secondary" style="background: transparent; color: #6b7280; border: 1px solid #d1d5db; padding: 10px 20px;">
                                    ‚Üê Ya tengo cuenta
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (newLoginState.currentView === 'forgot') {
                // Pantalla de "olvid√© mi contrase√±a"
                app.innerHTML = `
                    <div class="container">
                        <div class="login-form" style="max-width: 450px;">
                            <div style="text-align: center; margin-bottom: 30px;">
                                <div style="background: linear-gradient(135deg, #f59e0b, #d97706); width: 80px; height: 80px; border-radius: 20px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);">
                                    <span style="font-size: 2.5rem; color: white;">üîë</span>
                                </div>
                                <h2 style="color: #1f2937; margin: 0; font-weight: 700;">Recuperar Contrase√±a</h2>
                                <p style="color: #6b7280; margin: 10px 0 0 0; font-size: 14px;">Ingresa tu usuario para continuar</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Usuario</label>
                                <input type="text" id="forgot-username" class="form-input" placeholder="Tu nombre de usuario" style="font-size: 15px; padding: 12px;">
                            </div>
                            
                            <button onclick="startPasswordRecovery()" class="btn btn-warning" style="width: 100%; margin-bottom: 20px; padding: 15px; font-size: 16px; font-weight: 600;">
                                üîç Buscar Usuario
                            </button>
                            
                            <div style="text-align: center; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                                <button onclick="showLoginForm()" class="btn btn-secondary" style="background: transparent; color: #6b7280; border: 1px solid #d1d5db; padding: 10px 20px;">
                                    ‚Üê Volver al Login
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (newLoginState.currentView === 'recovery') {
                // Pantalla de pregunta de seguridad
                app.innerHTML = `
                    <div class="container">
                        <div class="login-form" style="max-width: 500px;">
                            <div style="text-align: center; margin-bottom: 30px;">
                                <div style="background: linear-gradient(135deg, #0ea5e9, #0284c7); width: 80px; height: 80px; border-radius: 20px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(14, 165, 233, 0.3);">
                                    <span style="font-size: 2.5rem; color: white;">‚ùì</span>
                                </div>
                                <h2 style="color: #1f2937; margin: 0; font-weight: 700;">Pregunta de Seguridad</h2>
                                <p style="color: #6b7280; margin: 10px 0 0 0; font-size: 14px;">Usuario: <strong>${window.tempRecoveryUsername}</strong></p>
                            </div>
                            
                            <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                                <h3 style="color: #0c4a6e; margin: 0 0 15px 0; font-size: 16px; font-weight: 600;">${window.tempRecoveryQuestion}</h3>
                                <input type="text" id="security-answer-recovery" class="form-input" placeholder="Tu respuesta" style="font-size: 15px; padding: 12px; width: 100%;">
                            </div>
                            
                            <button onclick="recoverPassword()" class="btn btn-info" style="width: 100%; margin-bottom: 20px; padding: 15px; font-size: 16px; font-weight: 600;">
                                üîì Recuperar Contrase√±a
                            </button>
                            
                            <div style="text-align: center; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                                <button onclick="showLoginForm()" class="btn btn-secondary" style="background: transparent; color: #6b7280; border: 1px solid #d1d5db; padding: 10px 20px;">
                                    ‚Üê Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Pantalla de login CON enlace "Olvid√© mi contrase√±a"
                app.innerHTML = `
                    <div class="container">
                        <div class="login-form" style="max-width: 450px;">
                            <div style="text-align: center; margin-bottom: 30px;">
                                <div style="background: linear-gradient(135deg, #4f46e5, #7c3aed); width: 80px; height: 80px; border-radius: 20px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);">
                                    <span style="font-size: 2.5rem; color: white;">üîê</span>
                                </div>
                                <h2 style="color: #1f2937; margin: 0; font-weight: 700;">Iniciar Sesi√≥n</h2>
                                <p style="color: #6b7280; margin: 10px 0 0 0; font-size: 14px;">Accede a tu cuenta personal</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Usuario</label>
                                <input type="text" id="username" class="form-input" placeholder="Tu nombre de usuario" style="font-size: 15px; padding: 12px;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contrase√±a</label>
                                <input type="password" id="password" class="form-input" placeholder="Tu contrase√±a" style="font-size: 15px; padding: 12px;">
                            </div>
                            
                            <button onclick="login()" class="btn btn-primary" style="width: 100%; margin-bottom: 15px; padding: 15px; font-size: 16px; font-weight: 600;">
                                üöÄ Iniciar Sesi√≥n
                            </button>
                            
                            <div style="text-align: center; margin-bottom: 20px;">
                                <button onclick="showForgotPassword()" style="background: transparent; border: none; color: #f59e0b; text-decoration: underline; cursor: pointer; font-size: 14px;">
                                    üîë ¬øOlvidaste tu contrase√±a?
                                </button>
                            </div>
                            
                            <div style="text-align: center; border-top: 1px solid #e5e7eb; padding-top: 20px;">
                                <p style="color: #6b7280; margin: 0 0 15px 0; font-size: 14px;">¬øNo tienes una cuenta?</p>
                                <button onclick="showRegisterForm()" class="btn btn-success" style="width: 100%; padding: 12px; font-size: 15px; font-weight: 600;">
                                    üë§ Crear Nueva Cuenta
                                </button>
                            </div>
                            
                            <div style="margin-top: 25px; padding: 15px; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0;">
                                <div style="text-align: center; margin-bottom: 10px;">
                                    <strong style="color: #374151; font-size: 14px;">üîí Sistema Seguro</strong>
                                </div>
                                <ul style="margin: 0; padding-left: 20px; color: #6b7280; font-size: 12px; line-height: 1.5;">
                                    <li>Datos privados por usuario</li>
                                    <li>Recuperaci√≥n por pregunta de seguridad</li>
                                    <li>Sin acceso a datos de otros</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }
        } else {
            // Usuario logueado - usar funci√≥n anterior
            previousRenderFunction.call(this);
        }
    };
    
    console.log('‚úÖ Sistema de recuperaci√≥n de contrase√±a implementado');
    console.log('üîë Funcionalidades: Pregunta de seguridad, recuperaci√≥n autom√°tica');
    
    // Forzar re-renderizado
    setTimeout(() => {
        render();
    }, 100);
</script>
    <!-- 
PARCHE DE CORRECCI√ìN: FUNCI√ìN DE REGISTRO QUE NO FUNCIONA
A√±adir este c√≥digo DESPU√âS de todos los parches anteriores, antes de </body>
Este parche corrige espec√≠ficamente el problema del bot√≥n "Crear Mi Cuenta"
-->

<script>
    // ========== CORRECCI√ìN: FUNCI√ìN DE REGISTRO ==========
    console.log('üîß CORRIGIENDO funci√≥n de registro...');
    
    // DIAGN√ìSTICO: Ver qu√© funciones existen
    console.log('Funciones disponibles:');
    console.log('- registerNewAccount:', typeof window.registerNewAccount);
    console.log('- RealUserManager:', typeof RealUserManager);
    console.log('- PasswordRecoveryManager:', typeof PasswordRecoveryManager);
    
    // REEMPLAZAR completamente la funci√≥n de registro
    window.registerNewAccount = function() {
        console.log('üîÑ Ejecutando registerNewAccount...');
        
        try {
            // Obtener valores de los campos
            const username = document.getElementById('reg-username')?.value?.trim() || '';
            const password = document.getElementById('reg-password')?.value || '';
            const confirmPassword = document.getElementById('reg-confirm-password')?.value || '';
            const fullName = document.getElementById('reg-fullname')?.value?.trim() || '';
            const securityQuestion = document.getElementById('security-question')?.value || '';
            const securityAnswer = document.getElementById('security-answer')?.value?.trim() || '';
            
            console.log('üìù Datos del formulario:');
            console.log('- Usuario:', username);
            console.log('- Nombre:', fullName);
            console.log('- Pregunta:', securityQuestion);
            console.log('- Respuesta:', securityAnswer ? 'S√ç' : 'NO');
            
            // Validaciones b√°sicas
            if (!username) {
                showMessage('El campo usuario es obligatorio', 'error');
                return;
            }
            
            if (!password) {
                showMessage('El campo contrase√±a es obligatorio', 'error');
                return;
            }
            
            if (!confirmPassword) {
                showMessage('Debes confirmar la contrase√±a', 'error');
                return;
            }
            
            if (!fullName) {
                showMessage('El nombre completo es obligatorio', 'error');
                return;
            }
            
            if (!securityQuestion) {
                showMessage('Selecciona una pregunta de seguridad', 'error');
                return;
            }
            
            if (!securityAnswer) {
                showMessage('Responde la pregunta de seguridad', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showMessage('Las contrase√±as no coinciden', 'error');
                return;
            }
            
            if (username.length < 3) {
                showMessage('El usuario debe tener al menos 3 caracteres', 'error');
                return;
            }
            
            if (password.length < 4) {
                showMessage('La contrase√±a debe tener al menos 4 caracteres', 'error');
                return;
            }
            
            console.log('‚úÖ Validaciones pasadas, creando cuenta...');
            
            // Crear la cuenta manualmente
            const users = JSON.parse(localStorage.getItem('realSystemUsers') || '{}');
            
            // Verificar si el usuario ya existe
            if (users[username]) {
                showMessage('El usuario ya existe, elige otro nombre', 'error');
                return;
            }
            
            // Crear nueva cuenta
            users[username] = {
                password: password,
                name: fullName,
                securityQuestion: securityQuestion,
                securityAnswer: securityAnswer.toLowerCase().trim(),
                createdAt: new Date().toLocaleString('es-ES'),
                lastLogin: null
            };
            
            // Guardar en localStorage
            localStorage.setItem('realSystemUsers', JSON.stringify(users));
            
            console.log('üíæ Cuenta guardada exitosamente');
            console.log('üë• Total usuarios:', Object.keys(users).length);
            
            // Mostrar mensaje de √©xito
            showMessage('¬°Cuenta creada exitosamente! Ahora puedes iniciar sesi√≥n', 'success');
            
            // Cambiar a pantalla de login despu√©s de 1 segundo
            setTimeout(() => {
                newLoginState.currentView = 'login';
                render();
            }, 1000);
            
        } catch (error) {
            console.error('‚ùå Error en registro:', error);
            showMessage('Error al crear la cuenta: ' + error.message, 'error');
        }
    };
    
// Funci√≥n showMessage desactivada - no mostrar notificaciones
window.showMessage = function(message, type) {
    // Solo mostrar errores en consola, ignorar mensajes de √©xito
    if (type === 'error') {
        console.error(message);
    }
    // No crear elementos DOM ni mostrar notificaciones visuales
};
    
    // VERIFICAR que newLoginState existe
    if (typeof window.newLoginState === 'undefined') {
        window.newLoginState = {
            currentView: 'login',
            showRegister: false
        };
    }
    
    // A√ëADIR event listener para debugging del bot√≥n
    document.addEventListener('click', function(e) {
        if (e.target && e.target.onclick && e.target.textContent.includes('Crear Mi Cuenta')) {
            console.log('üñ±Ô∏è Click detectado en bot√≥n "Crear Mi Cuenta"');
            console.log('üîç Funci√≥n asignada:', e.target.onclick.toString());
        }
    });
    
    // FORZAR re-renderizado para aplicar la nueva funci√≥n
    setTimeout(() => {
        console.log('üîÑ Forzando re-render...');
        if (typeof window.render === 'function') {
            render();
        }
    }, 500);
    
    console.log('‚úÖ Correcci√≥n de funci√≥n de registro aplicada');
    
    // DIAGN√ìSTICO FINAL
    setTimeout(() => {
        console.log('üìä DIAGN√ìSTICO FINAL:');
        console.log('- registerNewAccount:', typeof window.registerNewAccount);
        console.log('- showMessage:', typeof window.showMessage);
        console.log('- render:', typeof window.render);
        console.log('- Usuarios existentes:', Object.keys(JSON.parse(localStorage.getItem('realSystemUsers') || '{}')).length);
    }, 1000);
</script>
    <!-- 
PARCHE: CORRECCI√ìN USUARIOS √öNICOS Y RESET DE CONTRASE√ëA
A√±adir este c√≥digo DESPU√âS de todos los parches anteriores, antes de </body>
Este parche corrige: 1) Validaci√≥n de usuarios √∫nicos, 2) Reset de contrase√±a funcional
-->

<script>
    // ========== CORRECCI√ìN: USUARIOS √öNICOS Y RESET DE CONTRASE√ëA ==========
    console.log('üîß APLICANDO correcciones finales...');
    
    // MEJORAR la funci√≥n de registro para verificar usuarios √∫nicos
    window.registerNewAccount = function() {
        console.log('üîÑ Ejecutando registro con validaci√≥n de usuarios √∫nicos...');
        
        try {
            // Obtener valores de los campos
            const username = document.getElementById('reg-username')?.value?.trim() || '';
            const password = document.getElementById('reg-password')?.value || '';
            const confirmPassword = document.getElementById('reg-confirm-password')?.value || '';
            const fullName = document.getElementById('reg-fullname')?.value?.trim() || '';
            const securityQuestion = document.getElementById('security-question')?.value || '';
            const securityAnswer = document.getElementById('security-answer')?.value?.trim() || '';
            
            console.log('üìù Verificando usuario:', username);
            
            // Validaciones b√°sicas
            if (!username) {
                showMessage('El campo usuario es obligatorio', 'error');
                return;
            }
            
            if (!password || !confirmPassword || !fullName || !securityQuestion || !securityAnswer) {
                showMessage('Completa todos los campos', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showMessage('Las contrase√±as no coinciden', 'error');
                return;
            }
            
            if (username.length < 3) {
                showMessage('El usuario debe tener al menos 3 caracteres', 'error');
                return;
            }
            
            if (password.length < 4) {
                showMessage('La contrase√±a debe tener al menos 4 caracteres', 'error');
                return;
            }
            
            // VERIFICAR SI EL USUARIO YA EXISTS (CR√çTICO)
            const existingUsers = JSON.parse(localStorage.getItem('realSystemUsers') || '{}');
            
            // Verificar tanto el usuario exacto como variaciones (case-insensitive)
            const usernameLower = username.toLowerCase();
            const existingUsernames = Object.keys(existingUsers).map(u => u.toLowerCase());
            
            if (existingUsernames.includes(usernameLower)) {
                showMessage(`‚ùå El usuario "${username}" ya existe. Elige otro nombre.`, 'error');
                
                // Limpiar campo de usuario para que elija otro
                const usernameField = document.getElementById('reg-username');
                if (usernameField) {
                    usernameField.value = '';
                    usernameField.focus();
                    usernameField.style.borderColor = '#ef4444';
                    usernameField.style.backgroundColor = '#fee2e2';
                    
                    // Restaurar estilo despu√©s de 3 segundos
                    setTimeout(() => {
                        usernameField.style.borderColor = '#d1d5db';
                        usernameField.style.backgroundColor = 'white';
                    }, 3000);
                }
                
                console.log('‚ùå Usuario ya existe:', username);
                console.log('üë• Usuarios existentes:', Object.keys(existingUsers));
                return;
            }
            
            console.log('‚úÖ Usuario disponible, creando cuenta...');
            
            // Crear nueva cuenta
            existingUsers[username] = {
                password: password,
                name: fullName,
                securityQuestion: securityQuestion,
                securityAnswer: securityAnswer.toLowerCase().trim(),
                createdAt: new Date().toLocaleString('es-ES'),
                lastLogin: null
            };
            
            // Guardar en localStorage
            localStorage.setItem('realSystemUsers', JSON.stringify(existingUsers));
            
            console.log('üíæ Cuenta creada exitosamente');
            console.log('üë• Total usuarios:', Object.keys(existingUsers).length);
            
            // Mostrar mensaje de √©xito
            showMessage('¬°Cuenta creada exitosamente! Ahora puedes iniciar sesi√≥n', 'success');
            
            // Cambiar a pantalla de login
            setTimeout(() => {
                newLoginState.currentView = 'login';
                render();
            }, 1500);
            
        } catch (error) {
            console.error('‚ùå Error en registro:', error);
            showMessage('Error al crear la cuenta: ' + error.message, 'error');
        }
    };
    
    // CORREGIR la funci√≥n de recuperaci√≥n de contrase√±a
    window.recoverPassword = function() {
        console.log('üîÑ Ejecutando recuperaci√≥n de contrase√±a...');
        
        try {
            const securityAnswer = document.getElementById('security-answer-recovery')?.value?.trim() || '';
            
            if (!securityAnswer) {
                showMessage('Responde la pregunta de seguridad', 'error');
                return;
            }
            
            if (!window.tempRecoveryUsername) {
                showMessage('Error: Usuario no encontrado', 'error');
                newLoginState.currentView = 'login';
                render();
                return;
            }
            
            console.log('üîç Verificando respuesta para usuario:', window.tempRecoveryUsername);
            
            // Obtener usuarios del localStorage
            const users = JSON.parse(localStorage.getItem('realSystemUsers') || '{}');
            const user = users[window.tempRecoveryUsername];
            
            if (!user) {
                showMessage('Error: Usuario no encontrado', 'error');
                newLoginState.currentView = 'login';
                render();
                return;
            }
            
            // Verificar respuesta (normalizada)
            const userAnswer = securityAnswer.toLowerCase().trim();
            const correctAnswer = user.securityAnswer;
            
            console.log('üîë Verificando respuesta...');
            console.log('- Respuesta del usuario:', userAnswer);
            console.log('- Respuesta correcta:', correctAnswer);
            
            if (userAnswer !== correctAnswer) {
                showMessage('‚ùå Respuesta incorrecta. Int√©ntalo de nuevo.', 'error');
                
                // Limpiar campo y darle foco
                const answerField = document.getElementById('security-answer-recovery');
                if (answerField) {
                    answerField.value = '';
                    answerField.focus();
                }
                return;
            }
            
            console.log('‚úÖ Respuesta correcta, iniciando reset de contrase√±a...');
            
            // Cambiar a pantalla de creaci√≥n de nueva contrase√±a
            newLoginState.currentView = 'reset-password';
            render();
            
        } catch (error) {
            console.error('‚ùå Error en recuperaci√≥n:', error);
            showMessage('Error en la recuperaci√≥n: ' + error.message, 'error');
        }
    };
    
    // NUEVA funci√≥n para crear nueva contrase√±a
    window.resetPasswordFinal = function() {
        console.log('üîÑ Creando nueva contrase√±a...');
        
        try {
            const newPassword = document.getElementById('new-password')?.value || '';
            const confirmNewPassword = document.getElementById('confirm-new-password')?.value || '';
            
            if (!newPassword || !confirmNewPassword) {
                showMessage('Completa ambos campos de contrase√±a', 'error');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                showMessage('Las contrase√±as no coinciden', 'error');
                return;
            }
            
            if (newPassword.length < 4) {
                showMessage('La contrase√±a debe tener al menos 4 caracteres', 'error');
                return;
            }
            
            if (!window.tempRecoveryUsername) {
                showMessage('Error: Sesi√≥n expirada', 'error');
                newLoginState.currentView = 'login';
                render();
                return;
            }
            
            // Actualizar contrase√±a en localStorage
            const users = JSON.parse(localStorage.getItem('realSystemUsers') || '{}');
            
            if (!users[window.tempRecoveryUsername]) {
                showMessage('Error: Usuario no encontrado', 'error');
                newLoginState.currentView = 'login';
                render();
                return;
            }
            
            users[window.tempRecoveryUsername].password = newPassword;
            localStorage.setItem('realSystemUsers', JSON.stringify(users));
            
            console.log('‚úÖ Contrase√±a actualizada exitosamente');
            
            // Limpiar variables temporales
            window.tempRecoveryUsername = null;
            window.tempRecoveryQuestion = null;
            
            // Mostrar mensaje de √©xito y volver al login
            showMessage('¬°Contrase√±a actualizada exitosamente! Ahora puedes iniciar sesi√≥n', 'success');
            
            setTimeout(() => {
                newLoginState.currentView = 'login';
                render();
            }, 2000);
            
        } catch (error) {
            console.error('‚ùå Error al cambiar contrase√±a:', error);
            showMessage('Error al cambiar la contrase√±a: ' + error.message, 'error');
        }
    };
    
    // ACTUALIZAR la funci√≥n render para incluir la pantalla de reset
    const previousRenderForReset = window.render;
    window.render = function() {
        const app = document.getElementById('app');
        
        if (!state.currentUser) {
            if (newLoginState.currentView === 'reset-password') {
                // Nueva pantalla para crear contrase√±a
                app.innerHTML = `
                    <div class="container">
                        <div class="login-form" style="max-width: 500px;">
                            <div style="text-align: center; margin-bottom: 30px;">
                                <div style="background: linear-gradient(135deg, #22c55e, #16a34a); width: 80px; height: 80px; border-radius: 20px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(34, 197, 94, 0.3);">
                                    <span style="font-size: 2.5rem; color: white;">üîê</span>
                                </div>
                                <h2 style="color: #1f2937; margin: 0; font-weight: 700;">Crear Nueva Contrase√±a</h2>
                                <p style="color: #6b7280; margin: 10px 0 0 0; font-size: 14px;">Usuario: <strong>${window.tempRecoveryUsername}</strong></p>
                            </div>
                            
                            <div style="background: #f0fdf4; border: 2px solid #22c55e; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                                <h3 style="color: #166534; margin: 0 0 15px 0; font-size: 16px; font-weight: 600;">‚úÖ Identidad verificada</h3>
                                <p style="color: #15803d; margin: 0; font-size: 14px;">Ahora puedes crear una nueva contrase√±a segura</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Nueva contrase√±a</label>
                                <input type="password" id="new-password" class="form-input" placeholder="M√≠nimo 4 caracteres" style="font-size: 15px; padding: 12px;">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Confirmar nueva contrase√±a</label>
                                <input type="password" id="confirm-new-password" class="form-input" placeholder="Repite la contrase√±a" style="font-size: 15px; padding: 12px;">
                            </div>
                            
                            <button onclick="resetPasswordFinal()" class="btn btn-success" style="width: 100%; margin-bottom: 20px; padding: 15px; font-size: 16px; font-weight: 600;">
                                üîí Cambiar Contrase√±a
                            </button>
                            
                            <div style="text-align: center; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                                <button onclick="showLoginForm()" class="btn btn-secondary" style="background: transparent; color: #6b7280; border: 1px solid #d1d5db; padding: 10px 20px;">
                                    ‚Üê Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Usar funci√≥n anterior para otras pantallas
                previousRenderForReset.call(this);
            }
        } else {
            // Usuario logueado
            previousRenderForReset.call(this);
        }
    };
    
    // FUNCI√ìN para verificar disponibilidad de usuario en tiempo real
    window.checkUsernameAvailability = function(username) {
        if (username.length < 3) return;
        
        const users = JSON.parse(localStorage.getItem('realSystemUsers') || '{}');
        const usernameLower = username.toLowerCase();
        const existingUsernames = Object.keys(users).map(u => u.toLowerCase());
        
        const usernameField = document.getElementById('reg-username');
        if (usernameField) {
            if (existingUsernames.includes(usernameLower)) {
                usernameField.style.borderColor = '#ef4444';
                usernameField.style.backgroundColor = '#fee2e2';
                
                // Mostrar mensaje temporal
                let existingMsg = document.getElementById('username-status');
                if (existingMsg) existingMsg.remove();
                
                const statusMsg = document.createElement('div');
                statusMsg.id = 'username-status';
                statusMsg.style.cssText = 'color: #ef4444; font-size: 12px; margin-top: 5px;';
                statusMsg.textContent = '‚ùå Usuario no disponible';
                usernameField.parentNode.appendChild(statusMsg);
            } else {
                usernameField.style.borderColor = '#22c55e';
                usernameField.style.backgroundColor = '#f0fdf4';
                
                // Mostrar mensaje temporal
                let existingMsg = document.getElementById('username-status');
                if (existingMsg) existingMsg.remove();
                
                const statusMsg = document.createElement('div');
                statusMsg.id = 'username-status';
                statusMsg.style.cssText = 'color: #22c55e; font-size: 12px; margin-top: 5px;';
                statusMsg.textContent = '‚úÖ Usuario disponible';
                usernameField.parentNode.appendChild(statusMsg);
            }
        }
    };
    
    // A√ëADIR event listener para verificar usuario en tiempo real
    document.addEventListener('input', function(e) {
        if (e.target && e.target.id === 'reg-username') {
            setTimeout(() => {
                checkUsernameAvailability(e.target.value.trim());
            }, 500);
        }
    });
    
    console.log('‚úÖ Correcciones aplicadas: Usuarios √∫nicos + Reset de contrase√±a funcional');
    
    // Forzar re-renderizado
    setTimeout(() => {
        if (typeof window.render === 'function') {
            render();
        }
    }, 100);
</script>
    <!-- 
PARCHE: SISTEMA DE NAVEGACI√ìN CRUZADA ENTRE SECCIONES
A√±adir este c√≥digo DESPU√âS de todos los parches anteriores, antes de </body>
Este parche a√±ade navegaci√≥n entre Tests y Res√∫menes, y bot√≥n de vuelta al men√∫ principal
-->

<script>
    // ========== PARCHE: NAVEGACI√ìN CRUZADA ENTRE SECCIONES ==========
    console.log('üß≠ Implementando navegaci√≥n cruzada...');
    
    // FUNCI√ìN para volver al men√∫ principal (pantalla de bienvenida)
    window.backToMainMenu = function() {
        console.log('üè† Volviendo al men√∫ principal...');
        
        // Resetear estados
        showIntermediateScreen = true;
        state.currentTab = 'upload';
        
        // Si estamos en res√∫menes, resetear estado
        if (typeof summarySystemState !== 'undefined') {
            summarySystemState.currentView = 'create';
            summarySystemState.viewingSummary = null;
        }
        
        render();
        showMessage('Volviendo al men√∫ principal', 'success');
    };
    
    // FUNCI√ìN para ir directamente a Tests
    window.goToTestsFromSummary = function() {
        console.log('üéØ Cambiando de Res√∫menes a Tests...');
        
        showIntermediateScreen = false;
        state.currentTab = 'upload';
        
        // Si estamos en res√∫menes, resetear estado
        if (typeof summarySystemState !== 'undefined') {
            summarySystemState.currentView = 'create';
            summarySystemState.viewingSummary = null;
        }
        
        render();
        
    };
    
    // FUNCI√ìN para ir directamente a Res√∫menes
    window.goToSummariesFromTest = function() {
        console.log('üìä Cambiando de Tests a Res√∫menes...');
        
        showIntermediateScreen = false;
        state.currentTab = 'summary';
        
        // Asegurar que estamos en la vista de creaci√≥n
        if (typeof summarySystemState !== 'undefined') {
            summarySystemState.currentView = 'create';
            summarySystemState.viewingSummary = null;
        }
        
        render();
        
    };
    
    // INTERCEPTAR la funci√≥n render para a√±adir botones de navegaci√≥n
    const previousRenderWithNavigation = window.render;
    window.render = function() {
        // Llamar a la funci√≥n de render original
        previousRenderWithNavigation.call(this);
        
        // Solo a√±adir navegaci√≥n si el usuario est√° logueado y no en pantalla intermedia
        if (state.currentUser && !showIntermediateScreen) {
            addNavigationButtons();
        }
    };
    
    // FUNCI√ìN para a√±adir botones de navegaci√≥n
    function addNavigationButtons() {
        // Esperar un poco para que el DOM se haya renderizado
        setTimeout(() => {
            const header = document.querySelector('.header');
            
            if (header && !document.getElementById('cross-navigation')) {
                // Crear contenedor de navegaci√≥n cruzada
                const navigationDiv = document.createElement('div');
                navigationDiv.id = 'cross-navigation';
                navigationDiv.style.cssText = `
                    display: flex;
                    gap: 10px;
                    align-items: center;
                    margin-left: 20px;
                `;
                
                // Determinar qu√© botones mostrar seg√∫n la secci√≥n actual
                let navigationHTML = '';
                
                if (state.currentTab === 'summary') {
                    // Estamos en res√∫menes, mostrar opciones para ir a tests y men√∫
                    navigationHTML = `
                        <button onclick="goToTestsFromSummary()" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px; display: flex; align-items: center; gap: 6px;" title="Ir a la secci√≥n de Tests">
                            <span>üéØ</span> Tests
                        </button>
                        <button onclick="backToMainMenu()" class="btn btn-info" style="padding: 6px 12px; font-size: 12px; display: flex; align-items: center; gap: 6px;" title="Volver al men√∫ principal">
                            <span>üè†</span> Men√∫
                        </button>
                    `;
                } else {
                    // Estamos en tests (upload, questions, test, results), mostrar opciones para res√∫menes y men√∫
                    navigationHTML = `
                        <button onclick="goToSummariesFromTest()" class="btn btn-success" style="padding: 6px 12px; font-size: 12px; display: flex; align-items: center; gap: 6px;" title="Ir a la secci√≥n de Res√∫menes">
                            <span>üìä</span> Res√∫menes
                        </button>
                        <button onclick="backToMainMenu()" class="btn btn-info" style="padding: 6px 12px; font-size: 12px; display: flex; align-items: center; gap: 6px;" title="Volver al men√∫ principal">
                            <span>üè†</span> Men√∫
                        </button>
                    `;
                }
                
                navigationDiv.innerHTML = navigationHTML;
                
                // Insertar en el header, antes de los botones de usuario
                const userButtons = header.querySelector('div:last-child');
                if (userButtons) {
                    header.insertBefore(navigationDiv, userButtons);
                } else {
                    header.appendChild(navigationDiv);
                }
            }
        }, 100);
    }
    
    // MEJORAR la funci√≥n backToIntermediateScreen existente
    const originalBackToIntermediateScreen = window.backToIntermediateScreen;
    window.backToIntermediateScreen = function() {
        console.log('üîô Volviendo a pantalla intermedia...');
        backToMainMenu();
    };
    
    // A√ëADIR bot√≥n especial en la pantalla de visualizaci√≥n de res√∫menes
    const originalRenderViewSummaryEnhanced = renderViewSummaryEnhanced;
    if (typeof renderViewSummaryEnhanced === 'function') {
        renderViewSummaryEnhanced = function() {
            const originalHTML = originalRenderViewSummaryEnhanced();
            
            // Buscar el bot√≥n "Volver a la Biblioteca" y a√±adir m√°s opciones
            const enhancedHTML = originalHTML.replace(
                'Volver a la Biblioteca',
                'Volver a la Biblioteca</button>\n                    <button onclick="goToTestsFromSummary()" class="btn btn-primary" style="display: flex; align-items: center; gap: 10px; padding: 12px 20px; font-size: 14px; border-radius: 10px; transition: all 0.2s ease; background: #4f46e5; border: none; margin-left: 10px;" onmouseover="this.style.background=\'#4338ca\'" onmouseout="this.style.background=\'#4f46e5\'">\n                        <span style="font-size: 16px;">üéØ</span> Ir a Tests\n                    </button>\n                    <button onclick="backToMainMenu()" class="btn btn-info" style="display: flex; align-items: center; gap: 10px; padding: 12px 20px; font-size: 14px; border-radius: 10px; transition: all 0.2s ease; background: #0ea5e9; border: none; margin-left: 10px;" onmouseover="this.style.background=\'#0284c7\'" onmouseout="this.style.background=\'#0ea5e9\'">\n                        <span style="font-size: 16px;">üè†</span> Men√∫'
            );
            
            return enhancedHTML;
        };
    }
    
    // INTERCEPTAR las funciones setTab para preservar navegaci√≥n
    const originalSetTab = window.setTab;
    window.setTab = function(tab) {
        // Remover navegaci√≥n anterior para re-crearla
        const existingNav = document.getElementById('cross-navigation');
        if (existingNav) {
            existingNav.remove();
        }
        
        // Llamar funci√≥n original
        originalSetTab.call(this, tab);
    };
    
    // MEJORAR las funciones goToTests y goToSummaries originales
    const originalGoToTests = window.goToTests;
    window.goToTests = function() {
        console.log('üéØ Yendo a Tests desde men√∫ principal...');
        showIntermediateScreen = false;
        state.currentTab = 'upload';
        render();
    };
    
    const originalGoToSummariesMain = window.goToSummaries;
    window.goToSummaries = function() {
        console.log('üìä Yendo a Res√∫menes desde men√∫ principal...');
        showIntermediateScreen = false;
        state.currentTab = 'summary';
        render();
    };
    
    // A√ëADIR estilos CSS para los botones de navegaci√≥n
    const navigationStyles = document.createElement('style');
    navigationStyles.textContent = `
        #cross-navigation {
            border-left: 1px solid #e5e7eb;
            padding-left: 15px;
            margin-left: 15px !important;
        }
        
        #cross-navigation .btn {
            transition: all 0.2s ease;
            font-weight: 500;
            border: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        #cross-navigation .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        
        @media (max-width: 768px) {
            #cross-navigation {
                display: none !important;
            }
        }
    `;
    
    // A√±adir estilos al head si no existen
    if (!document.getElementById('navigation-styles')) {
        navigationStyles.id = 'navigation-styles';
        document.head.appendChild(navigationStyles);
    }
    
    console.log('‚úÖ Sistema de navegaci√≥n cruzada implementado');
    console.log('üß≠ Funcionalidades a√±adidas:');
    console.log('   - Bot√≥n "Tests" en secci√≥n de Res√∫menes');
    console.log('   - Bot√≥n "Res√∫menes" en secci√≥n de Tests');  
    console.log('   - Bot√≥n "Men√∫" en ambas secciones');
    console.log('   - Navegaci√≥n desde visualizaci√≥n de res√∫menes');
    
    // Forzar re-renderizado para aplicar navegaci√≥n
    setTimeout(() => {
        if (state.currentUser && typeof window.render === 'function') {
            render();
        }
    }, 200);
</script>
<!-- 
PARCHE ULTRA SIMPLE: RECORDAR USUARIO + EXPORTAR DATOS
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
Sin preguntas, sin confirmaciones. Solo recordar datos del login + exportar.
-->

<script>
    // ========== SISTEMA COMPLETO: LOGIN + BACKUP ==========
    console.log('üîê Implementando sistema de login con recordar credenciales...');
    
    // INTERCEPTAR funci√≥n de login MEJORADA
    const originalUltraLogin = window.login;
    window.login = function() {
        const username = document.getElementById('username')?.value?.trim() || '';
        const password = document.getElementById('password')?.value || '';
        const rememberMe = document.getElementById('remember-me')?.checked || false;
        
        if (!username || !password) {
            showMessage('Completa todos los campos', 'error');
            return;
        }
        
        const loginResult = RealUserManager.verifyLogin(username, password);
        
        if (loginResult.success) {
            console.log('‚úÖ Login exitoso para:', username);
            
            // Si marc√≥ "recordar", guardar credenciales
            if (rememberMe) {
                localStorage.setItem('rememberedUsername', username);
                localStorage.setItem('rememberedPassword', password);
                localStorage.setItem('rememberExpiry', Date.now() + (30 * 24 * 60 * 60 * 1000)); // 30 d√≠as
                console.log('üíæ Credenciales guardadas');
            } else {
                // Si no marc√≥ recordar, limpiar datos guardados
                localStorage.removeItem('rememberedUsername');
                localStorage.removeItem('rememberedPassword');
                localStorage.removeItem('rememberExpiry');
            }
            
            // Limpiar datos previos
            RealDataManager.clearGlobalData();
            
            // Establecer usuario actual
            state.currentUser = { 
                username: username, 
                name: loginResult.user.name 
            };
            
            // Cargar datos del usuario
            RealDataManager.loadIntoGlobalData(username);
            
            showIntermediateScreen = true;
            render();
            
        } else {
            showMessage(loginResult.message, 'error');
        }
    };
    
    // FUNCI√ìN para llenar datos recordados
    function fillRememberedCredentials() {
        const rememberedUser = localStorage.getItem('rememberedUsername');
        const rememberedPass = localStorage.getItem('rememberedPassword');
        const expiry = localStorage.getItem('rememberExpiry');
        
        // Verificar si no ha expirado
        if (expiry && Date.now() > parseInt(expiry)) {
            localStorage.removeItem('rememberedUsername');
            localStorage.removeItem('rememberedPassword');
            localStorage.removeItem('rememberExpiry');
            return;
        }
        
        if (rememberedUser && rememberedPass) {
            setTimeout(() => {
                const usernameField = document.getElementById('username');
                const passwordField = document.getElementById('password');
                const rememberCheckbox = document.getElementById('remember-me');
                
                if (usernameField) usernameField.value = rememberedUser;
                if (passwordField) passwordField.value = rememberedPass;
                if (rememberCheckbox) rememberCheckbox.checked = true;
                
                console.log('üìù Credenciales pre-llenadas');
            }, 100);
        }
    }
    
    // FUNCI√ìN para EXPORTAR datos completos
    function exportUserDataComplete() {
        if (!state.currentUser) {
            showMessage('‚ùå Error: No hay usuario logueado', 'error');
            return;
        }
        
        try {
            const username = state.currentUser.username;
            
            // Obtener datos de la cuenta desde localStorage
            const allUsers = JSON.parse(localStorage.getItem('realSystemUsers') || '{}');
            const accountData = allUsers[username];
            
            if (!accountData) {
                showMessage('‚ùå Error: No se encontraron datos de la cuenta', 'error');
                return;
            }
            
            // Crear backup completo con cuenta + datos
            const completeBackup = {
                version: "2.0",
                exportDate: new Date().toISOString(),
                exportTimestamp: Date.now(),
                username: username,
                accountData: {
                    password: accountData.password,
                    name: accountData.name,
                    securityQuestion: accountData.securityQuestion,
                    securityAnswer: accountData.securityAnswer,
                    createdAt: accountData.createdAt
                },
                userData: {
                    questions: state.questions || [],
                    topics: state.topics || [],
                    testResults: state.testResults || [],
                    summaryTopics: (typeof summarySystemState !== 'undefined') ? summarySystemState.summaryTopics || [] : [],
                    savedSummaries: (typeof summarySystemState !== 'undefined') ? summarySystemState.savedSummaries || [] : [],
                    apiKey: state.apiKey || ''
                },
                stats: {
                    totalQuestions: state.questions ? state.questions.length : 0,
                    totalTopics: state.topics ? state.topics.length : 0,
                    totalTests: state.testResults ? state.testResults.length : 0,
                    totalSummaries: (typeof summarySystemState !== 'undefined') ? (summarySystemState.savedSummaries || []).length : 0
                }
            };
            
            // Mostrar estad√≠sticas antes de descargar
            const statsMessage = `
üìä BACKUP COMPLETO GENERADO:
‚Ä¢ Preguntas: ${completeBackup.stats.totalQuestions}
‚Ä¢ Temas: ${completeBackup.stats.totalTopics}
‚Ä¢ Tests realizados: ${completeBackup.stats.totalTests}
‚Ä¢ Res√∫menes: ${completeBackup.stats.totalSummaries}
‚Ä¢ Datos de cuenta: ‚úÖ Incluidos
            `;
            
            showMessage(statsMessage, 'success');
            
            // Crear archivo para descarga
            const blob = new Blob([JSON.stringify(completeBackup, null, 2)], { 
                type: 'application/json' 
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            const dateStr = new Date().toISOString().split('T')[0];
            const timeStr = new Date().toLocaleTimeString('es-ES').replace(/:/g, '');
            a.href = url;
            a.download = `backup_completo_${username}_${dateStr}_${timeStr}.json`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Mensaje de confirmaci√≥n con instrucciones
            setTimeout(() => {
                showMessage(`
‚úÖ BACKUP DESCARGADO EXITOSAMENTE
üìÅ Archivo: backup_completo_${username}_${dateStr}_${timeStr}.json

üí° INSTRUCCIONES:
‚Ä¢ Guarda este archivo en un lugar seguro
‚Ä¢ Incluye tanto tu cuenta como todos tus datos
‚Ä¢ √ötil para respaldos y migraci√≥n de datos
                `, 'success');
            }, 1000);
            
            console.log('‚úÖ Backup completo exportado para:', username);
            
        } catch (error) {
            console.error('‚ùå Error exportando backup:', error);
            showMessage('‚ùå Error al exportar datos: ' + error.message, 'error');
        }
    }
    
    // LOGOUT ultra simple - directo al login sin preguntas
    const originalUltraLogout = window.logout;
    window.logout = function() {
        if (state.currentUser) {
            RealDataManager.saveFromGlobalData(state.currentUser.username);
        }
        
        // Limpiar estado
        RealDataManager.clearGlobalData();
        state.currentUser = null;
        showIntermediateScreen = false;
        state.currentTab = 'upload';
        newLoginState.currentView = 'login';
        
        render();
        showMessage('Sesi√≥n cerrada correctamente', 'success');
    };
    
    // FUNCI√ìN para agregar bot√≥n de EXPORTAR al men√∫ principal
    function addExportButtonToMainMenu() {
        // Buscar d√≥nde insertar el bot√≥n (despu√©s de los tabs principales)
        const tabsContainer = document.querySelector('.nav-tabs');
        if (!tabsContainer) return;
        
        // Verificar si ya existe el bot√≥n
        if (document.getElementById('export-data-btn')) return;
        
        // Crear bot√≥n de exportar datos
        const exportButton = document.createElement('button');
        exportButton.id = 'export-data-btn';
        exportButton.className = 'nav-tab export-btn';
        exportButton.innerHTML = 'üíæ Exportar Mis Datos';
        exportButton.onclick = exportUserDataComplete;
        
        // Agregar estilos espec√≠ficos
        exportButton.style.cssText = `
            background: linear-gradient(45deg, #10b981, #059669) !important;
            color: white !important;
            border: none !important;
            margin-left: 10px !important;
            font-weight: bold !important;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3) !important;
            transition: all 0.3s ease !important;
            padding: 10px 16px !important;
            border-radius: 8px !important;
            cursor: pointer !important;
            font-size: 14px !important;
        `;
        
        // Efectos hover
        exportButton.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.4)';
        });
        
        exportButton.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 2px 8px rgba(16, 185, 129, 0.3)';
        });
        
        // Insertar despu√©s de los tabs existentes
        tabsContainer.appendChild(exportButton);
    }
    
    // ACTUALIZAR render para incluir recordar credenciales
    const previousUltraRender = window.render;
    window.render = function() {
        const app = document.getElementById('app');
        
        if (!state.currentUser) {
            if (newLoginState.currentView === 'login') {
                // Pantalla de login CON RECORDAR CREDENCIALES
                app.innerHTML = `
                    <div class="container">
                        <div class="login-form" style="max-width: 450px; margin: 50px auto; padding: 40px; background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);">
                            
                            <!-- HEADER -->
                            <div style="text-align: center; margin-bottom: 35px;">
                                <div style="background: linear-gradient(135deg, #4f46e5, #7c3aed); width: 80px; height: 80px; border-radius: 20px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);">
                                    <span style="font-size: 2.5rem; color: white;">üéì</span>
                                </div>
                                <h2 style="color: #1f2937; margin: 0; font-weight: 700;">PRIII Sistema</h2>
                                <p style="color: #6b7280; margin: 10px 0 0 0; font-size: 14px;">Accede con tus credenciales</p>
                            </div>
                            
                            <!-- FORMULARIO DE LOGIN -->
                            <div class="form-group">
                                <label class="form-label">üë§ Usuario</label>
                                <input type="text" id="username" class="form-input" placeholder="Tu nombre de usuario" style="font-size: 15px; padding: 12px;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">üîí Contrase√±a</label>
                                <input type="password" id="password" class="form-input" placeholder="Tu contrase√±a" style="font-size: 15px; padding: 12px;">
                            </div>
                            
                            <!-- Checkbox recordar usuario -->
                            <div style="margin-bottom: 20px;">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 14px; color: #374151;">
                                    <input type="checkbox" id="remember-me" style="transform: scale(1.2); accent-color: #4f46e5;">
                                    <span>Recordar usuario por 30 d√≠as</span>
                                </label>
                            </div>
                            
                            <button onclick="login()" class="btn btn-primary" style="width: 100%; margin-bottom: 15px; padding: 15px; font-size: 16px; font-weight: 600;">
                                üöÄ ACCEDER AL SISTEMA
                            </button>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                                <button onclick="showRegisterForm()" class="btn btn-success" style="padding: 12px; font-size: 14px;">
                                    üë§ Crear Cuenta
                                </button>
                                <button onclick="showForgotPassword()" style="
                                    padding: 12px; background: linear-gradient(45deg, #f59e0b, #d97706); 
                                    color: white; border: none; border-radius: 8px; font-size: 14px; 
                                    cursor: pointer; font-weight: 600;
                                ">
                                    üîë Recuperar
                                </button>
                            </div>
                            
                            <div style="margin-top: 25px; padding: 15px; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0;">
                                <div style="text-align: center; margin-bottom: 10px;">
                                    <strong style="color: #374151; font-size: 14px;">üîí Sistema Seguro</strong>
                                </div>
                                <ul style="margin: 0; padding-left: 20px; color: #6b7280; font-size: 12px; line-height: 1.5;">
                                    <li>Datos privados por usuario</li>
                                    <li>Recuperaci√≥n por pregunta de seguridad</li>
                                    <li>Opci√≥n de recordar credenciales</li>
                                    <li>Exportar datos completos desde el sistema</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Contenedor para mensajes -->
                        <div id="messages" style="position: fixed; top: 20px; right: 20px; z-index: 10000;"></div>
                    </div>
                `;
                
                // Llenar datos recordados despu√©s de renderizar
                fillRememberedCredentials();
            } else {
                // Otras pantallas - usar funci√≥n original
                previousUltraRender.call(this);
            }
        } else {
            // Usuario logueado - usar funci√≥n original
            previousUltraRender.call(this);
            
            // Agregar bot√≥n exportar si estamos en men√∫ principal
            setTimeout(() => {
                addExportButtonToMainMenu();
            }, 100);
        }
    };
    
    console.log('‚úÖ SISTEMA IMPLEMENTADO: Login + Recordar Credenciales');
    console.log('üéØ Funcionalidades:');
    console.log('  ‚Ä¢ Login normal con recordar credenciales por 30 d√≠as');  
    console.log('  ‚Ä¢ Exportaci√≥n completa desde men√∫ principal');
    console.log('  ‚Ä¢ Logout ultra simple sin confirmaciones');
    console.log('  ‚Ä¢ Auto-llenado de campos si est√°n guardados');
    
    // Forzar re-renderizado si no hay usuario logueado
    setTimeout(() => {
        if (!state.currentUser && typeof window.render === 'function') {
            render();
        }
    }, 100);
</script>
<!-- 
PARCHE MODIFICADO: SISTEMA DE TARJETAS DE MEMORIA + EXPORTAR SOLO CONTENIDO
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
Versi√≥n modificada que exporta SOLO datos de contenido (portable entre usuarios)
-->

<script>
    // ========== PARCHE MODIFICADO: SISTEMA DE TARJETAS DE MEMORIA + EXPORTAR CONTENIDO ==========
    console.log('üÉè Implementando sistema de tarjetas de memoria + exportaci√≥n de contenido portable...');
    
    // Estado para las tarjetas de memoria
    let memoryCardsState = {
        currentCard: null,
        cardIndex: 0,
        verifiedQuestions: [],
        showAnswer: false
    };
    
    // FUNCI√ìN para ir a tarjetas de memoria desde el men√∫ principal
    window.goToMemoryCards = function() {
        console.log('üÉè Cambiando a Tarjetas de Memoria...');
        
        showIntermediateScreen = false;
        state.currentTab = 'memory-cards';
        
        // Cargar preguntas verificadas
        loadVerifiedQuestions();
        
        render();
        
    };
    
    // FUNCI√ìN para volver al men√∫ desde tarjetas
    window.backToMainMenuFromCards = function() {
        console.log('üè† Volviendo al men√∫ principal desde tarjetas...');
        showIntermediateScreen = true;
        state.currentTab = 'upload';
        render();
        
    };
    
    // FUNCI√ìN para cargar preguntas verificadas
    function loadVerifiedQuestions() {
        memoryCardsState.verifiedQuestions = state.questions.filter(q => q.isVerified);
        
        if (memoryCardsState.verifiedQuestions.length > 0) {
            // Mezclar preguntas aleatoriamente
            memoryCardsState.verifiedQuestions = [...memoryCardsState.verifiedQuestions].sort(() => Math.random() - 0.5);
            memoryCardsState.cardIndex = 0;
            memoryCardsState.currentCard = memoryCardsState.verifiedQuestions[0];
            memoryCardsState.showAnswer = false;
        } else {
            memoryCardsState.currentCard = null;
        }
    }
    
    // FUNCI√ìN para mostrar/ocultar respuesta
    function toggleAnswer() {
        memoryCardsState.showAnswer = !memoryCardsState.showAnswer;
        render();
    }
    
    // FUNCI√ìN para siguiente tarjeta
    function nextCard() {
        if (memoryCardsState.verifiedQuestions.length === 0) return;
        
        memoryCardsState.cardIndex = (memoryCardsState.cardIndex + 1) % memoryCardsState.verifiedQuestions.length;
        memoryCardsState.currentCard = memoryCardsState.verifiedQuestions[memoryCardsState.cardIndex];
        memoryCardsState.showAnswer = false;
        render();
    }
    
    // FUNCI√ìN para tarjeta anterior
    function previousCard() {
        if (memoryCardsState.verifiedQuestions.length === 0) return;
        
        memoryCardsState.cardIndex = memoryCardsState.cardIndex === 0 
            ? memoryCardsState.verifiedQuestions.length - 1 
            : memoryCardsState.cardIndex - 1;
        memoryCardsState.currentCard = memoryCardsState.verifiedQuestions[memoryCardsState.cardIndex];
        memoryCardsState.showAnswer = false;
        render();
    }
    
    // FUNCI√ìN para mezclar tarjetas
    function shuffleCards() {
        if (memoryCardsState.verifiedQuestions.length === 0) return;
        
        memoryCardsState.verifiedQuestions = [...memoryCardsState.verifiedQuestions].sort(() => Math.random() - 0.5);
        memoryCardsState.cardIndex = 0;
        memoryCardsState.currentCard = memoryCardsState.verifiedQuestions[0];
        memoryCardsState.showAnswer = false;
        render();
        showMessage('Tarjetas mezcladas aleatoriamente', 'success');
    }
    
    // ========== NUEVA FUNCI√ìN: EXPORTAR SOLO CONTENIDO (PORTABLE) ==========
    function exportContentDataOnly() {
        if (!state.currentUser) {
            showMessage('‚ùå Error: No hay usuario logueado', 'error');
            return;
        }
        
        try {
            const username = state.currentUser.username;
            
            // Crear backup SOLO con datos de contenido (sin datos de cuenta)
            const contentBackup = {
                version: "3.0", // Nueva versi√≥n para datos portables
                exportDate: new Date().toISOString(),
                exportTimestamp: Date.now(),
                exportType: "content_only", // Indicar que es solo contenido
                originalUser: username, // Solo para referencia, no para validaci√≥n
                contentData: {
                    questions: state.questions || [],
                    topics: state.topics || [],
                    testResults: state.testResults || [],
                    summaryTopics: (typeof summarySystemState !== 'undefined') ? summarySystemState.summaryTopics || [] : [],
                    savedSummaries: (typeof summarySystemState !== 'undefined') ? summarySystemState.savedSummaries || [] : [],
                    apiKey: state.apiKey || ''
                },
                stats: {
                    totalQuestions: state.questions ? state.questions.length : 0,
                    totalTopics: state.topics ? state.topics.length : 0,
                    totalTests: state.testResults ? state.testResults.length : 0,
                    totalSummaries: (typeof summarySystemState !== 'undefined') ? (summarySystemState.savedSummaries || []).length : 0
                }
            };
            
            // Mostrar estad√≠sticas antes de descargar
            const statsMessage = `
üìä BACKUP DE CONTENIDO GENERADO:
‚Ä¢ Preguntas: ${contentBackup.stats.totalQuestions}
‚Ä¢ Temas: ${contentBackup.stats.totalTopics}  
‚Ä¢ Tests realizados: ${contentBackup.stats.totalTests}
‚Ä¢ Res√∫menes: ${contentBackup.stats.totalSummaries}
‚Ä¢ Datos de cuenta: ‚ùå NO incluidos (portable)
            `;
            
            showMessage(statsMessage, 'success');
            
            // Crear archivo para descarga
            const blob = new Blob([JSON.stringify(contentBackup, null, 2)], { 
                type: 'application/json' 
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            const dateStr = new Date().toISOString().split('T')[0];
            const timeStr = new Date().toLocaleTimeString('es-ES').replace(/:/g, '');
            a.href = url;
            a.download = `contenido_portable_${dateStr}_${timeStr}.json`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Mensaje de confirmaci√≥n con instrucciones
            setTimeout(() => {
                showMessage(`
‚úÖ BACKUP DE CONTENIDO DESCARGADO
üìÅ Archivo: contenido_portable_${dateStr}_${timeStr}.json

üí° INSTRUCCIONES:
‚Ä¢ Este archivo contiene SOLO tus datos (no cuenta)
‚Ä¢ Se puede importar desde cualquier usuario
‚Ä¢ Perfecto para compartir contenido entre cuentas
‚Ä¢ Para usar: Login + usar "üì• Importar Contenido"
                `, 'success');
            }, 1000);
            
            console.log('‚úÖ Backup de contenido portable exportado');
            
        } catch (error) {
            console.error('‚ùå Error exportando contenido:', error);
            showMessage('‚ùå Error al exportar contenido: ' + error.message, 'error');
        }
    }
    
    // ========== NUEVA FUNCI√ìN: IMPORTAR CONTENIDO DESDE CUALQUIER USUARIO ==========
    function importContentFromFile() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                showMessage('‚ùå Por favor selecciona un archivo .json v√°lido', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importedData = JSON.parse(event.target.result);
                    
                    // Validar que sea un archivo v√°lido
                    if (!importedData.contentData && !importedData.userData) {
                        throw new Error('Archivo no v√°lido: falta datos de contenido');
                    }
                    
                    // Determinar tipo de archivo y extraer datos
                    let sourceData;
                    let fileType = "desconocido";
                    
                    if (importedData.exportType === "content_only") {
                        // Archivo nuevo de solo contenido
                        sourceData = importedData.contentData;
                        fileType = "contenido portable";
                    } else if (importedData.userData) {
                        // Archivo viejo completo, usar solo userData
                        sourceData = importedData.userData;
                        fileType = "backup completo (solo datos)";
                    } else {
                        throw new Error('Formato de archivo no reconocido');
                    }
                    
                    // Mostrar informaci√≥n del archivo
                    const stats = importedData.stats || {};
                    const questionsCount = sourceData.questions?.length || 0;
                    const topicsCount = sourceData.topics?.length || 0;
                    const testsCount = sourceData.testResults?.length || 0;
                    const summariesCount = sourceData.savedSummaries?.length || 0;
                    
                    // Confirmar importaci√≥n
                    const confirmMsg = `¬øImportar este contenido a tu cuenta actual?

üìÑ TIPO: ${fileType}
${importedData.originalUser ? `üë§ Usuario original: ${importedData.originalUser}` : ''}

üìä DATOS A IMPORTAR:
‚Ä¢ Preguntas: ${questionsCount}
‚Ä¢ Temas: ${topicsCount}
‚Ä¢ Tests: ${testsCount}
‚Ä¢ Res√∫menes: ${summariesCount}

‚ö†Ô∏è ATENCI√ìN: 
‚Ä¢ Los datos se AGREGAR√ÅN a tu cuenta actual
‚Ä¢ Se evitar√°n duplicados autom√°ticamente
‚Ä¢ Tu contenido actual NO se borrar√°`;
                    
                    if (!confirm(confirmMsg)) return;
                    
                    showMessage('üîÑ Importando contenido...', 'info');
                    
                    // IMPORTAR datos agreg√°ndolos a los existentes
                    const currentQuestions = state.questions || [];
                    const currentTopics = state.topics || [];
                    const currentTests = state.testResults || [];
                    
                    // Agregar preguntas (evitar duplicados por ID)
                    const importedQuestions = sourceData.questions || [];
                    const existingQuestionIds = new Set(currentQuestions.map(q => q.id));
                    const newQuestions = importedQuestions.filter(q => !existingQuestionIds.has(q.id));
                    
                    // Agregar temas (evitar duplicados por nombre)
                    const importedTopics = sourceData.topics || [];
                    const existingTopicNames = new Set(currentTopics.map(t => t.name.toLowerCase()));
                    const newTopics = importedTopics.filter(t => !existingTopicNames.has(t.name.toLowerCase()));
                    
                    // Regenerar IDs √∫nicos para temas nuevos si es necesario
                    newTopics.forEach(topic => {
                        if (!topic.id) {
                            topic.id = 'topic_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        }
                    });
                    
                    // Actualizar arrays globales
                    state.questions = [...currentQuestions, ...newQuestions];
                    state.topics = [...currentTopics, ...newTopics];
                    state.testResults = [...currentTests, ...(sourceData.testResults || [])];
                    
                    // Importar datos de res√∫menes si existen
                    if (typeof summarySystemState !== 'undefined') {
                        const currentSummaryTopics = summarySystemState.summaryTopics || [];
                        const currentSummaries = summarySystemState.savedSummaries || [];
                        
                        summarySystemState.summaryTopics = [...currentSummaryTopics, ...(sourceData.summaryTopics || [])];
                        summarySystemState.savedSummaries = [...currentSummaries, ...(sourceData.savedSummaries || [])];
                    }
                    
                    // Guardar datos actualizados en localStorage del usuario
                    if (typeof RealDataManager !== 'undefined') {
                        RealDataManager.saveFromGlobalData(state.currentUser.username);
                    } else {
                        // Fallback manual si RealDataManager no existe
                        const username = state.currentUser.username;
                        localStorage.setItem(`realUser_${username}_questions`, JSON.stringify(state.questions));
                        localStorage.setItem(`realUser_${username}_topics`, JSON.stringify(state.topics));
                        localStorage.setItem(`realUser_${username}_testResults`, JSON.stringify(state.testResults));
                    }
                    
                    // Actualizar interfaz
                    render();
                    
                    showMessage(`
‚úÖ CONTENIDO IMPORTADO EXITOSAMENTE

üìä RESUMEN DE IMPORTACI√ìN:
‚Ä¢ Preguntas a√±adidas: ${newQuestions.length}
‚Ä¢ Temas a√±adidos: ${newTopics.length}
‚Ä¢ Tests importados: ${(sourceData.testResults || []).length}
‚Ä¢ Res√∫menes importados: ${(sourceData.savedSummaries || []).length}

üéâ ¬°Tu contenido ha sido actualizado!
                    `, 'success');
                    
                    console.log(`‚úÖ Contenido importado: ${newQuestions.length} preguntas, ${newTopics.length} temas`);
                    
                } catch (error) {
                    console.error('Error importando contenido:', error);
                    showMessage('‚ùå Error al importar archivo: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
        };
        
        input.click();
    }
    
    // FUNCI√ìN para renderizar la secci√≥n de tarjetas de memoria
    function renderMemoryCardsTab() {
        if (memoryCardsState.verifiedQuestions.length === 0) {
            return `
                <div style="max-width: 800px; margin: 0 auto; text-align: center; padding: 80px 20px;">
                    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); width: 120px; height: 120px; border-radius: 20px; margin: 0 auto 30px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(245, 158, 11, 0.3);">
                        <span style="font-size: 4rem; color: white;">üÉè</span>
                    </div>
                    <h2 style="color: #1f2937; margin: 0 0 20px 0; font-size: 2.5rem;">No hay tarjetas disponibles</h2>
                    <p style="color: #6b7280; margin: 0 0 30px 0; font-size: 1.2rem; line-height: 1.6;">
                        Para usar las tarjetas de memoria necesitas tener preguntas <strong>verificadas</strong> (‚≠ê) en tu banco de preguntas.
                    </p>
                    <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; padding: 25px; margin-bottom: 30px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto;">
                        <h3 style="color: #92400e; margin: 0 0 15px 0; font-size: 1.1rem;">üìù ¬øC√≥mo verificar preguntas?</h3>
                        <ol style="color: #78350f; margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li>Ve a "Banco de Preguntas"</li>
                            <li>Busca el bot√≥n ‚òÜ junto a cada pregunta</li>
                            <li>Haz clic para convertirlo en ‚≠ê (verificada)</li>
                            <li>Vuelve aqu√≠ para practicar con tarjetas</li>
                        </ol>
                    </div>
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="goToTestsFromSummary()" class="btn btn-primary" style="padding: 15px 25px; font-size: 16px;">
                            üìã Ir al Banco de Preguntas
                        </button>
                    </div>
                </div>
            `;
        }
        
        const currentCard = memoryCardsState.currentCard;
        const cardNumber = memoryCardsState.cardIndex + 1;
        const totalCards = memoryCardsState.verifiedQuestions.length;
        const topicName = currentCard.topicId ? getTopicName(currentCard.topicId) : 'General';
        
        return `
            <div style="max-width: 900px; margin: 0 auto; padding: 20px;">
                
                <!-- Header simple -->
                <div style="text-align: center; margin-bottom: 30px;">
                    <h1 style="color: #1f2937; margin: 0; font-size: 2.2rem; display: flex; align-items: center; justify-content: center; gap: 15px;">
                        <span>üÉè</span> Tarjetas de Memoria
                    </h1>
                    <p style="color: #6b7280; margin: 5px 0 0 0; font-size: 14px;">
                        Tarjeta ${cardNumber} de ${totalCards} preguntas verificadas
                    </p>
                </div>
                
                <!-- Controles superiores -->
                <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 40px;">
                    <button onclick="shuffleCards()" class="btn btn-warning" style="padding: 10px 20px; display: flex; align-items: center; gap: 8px;">
                        <span>üîÄ</span> Mezclar
                    </button>
                    <div style="background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; padding: 10px 20px; border-radius: 20px; font-weight: 600; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);">
                        ${cardNumber} / ${totalCards}
                    </div>
                    <button onclick="loadVerifiedQuestions()" class="btn btn-info" style="padding: 10px 20px; display: flex; align-items: center; gap: 8px;">
                        <span>üîÑ</span> Recargar
                    </button>
                </div>
                
                <!-- Tarjeta principal mejorada -->
                <div style="perspective: 1000px; margin-bottom: 40px;">
                    <div class="memory-card" style="
                        background: linear-gradient(145deg, #ffffff, #f8fafc); 
                        border-radius: 20px; 
                        box-shadow: 
                            0 20px 40px rgba(0,0,0,0.12),
                            0 1px 0 rgba(255,255,255,0.8),
                            inset 0 1px 3px rgba(255,255,255,0.9);
                        margin: 0 auto; 
                        max-width: 650px; 
                        min-height: 400px; 
                        position: relative; 
                        border: 2px solid #e2e8f0;
                        transform: rotateX(1deg) rotateY(-1deg);
                        transition: all 0.4s ease;
                        animation: cardFloat 4s ease-in-out infinite;
                    ">
                    
                        <!-- Badge de verificada -->
                        <div style="position: absolute; top: -8px; right: 15px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 14px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); z-index: 10;">
                            ‚≠ê Verificada
                        </div>
                        
                        <!-- Contenido de la tarjeta -->
                        <div style="padding: 35px;">
                            
                            <!-- Tema y Pregunta -->
                            <div style="margin-bottom: 30px;">
                                <!-- Badge del tema -->
                                <div style="display: inline-block; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 6px 14px; border-radius: 15px; font-size: 13px; font-weight: 600; margin-bottom: 20px; box-shadow: 0 2px 6px rgba(139, 92, 246, 0.3);">
                                    üìÅ ${topicName}
                                </div>
                                
                                <!-- Pregunta -->
                                <h3 style="color: #6b7280; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">
                                    üìù PREGUNTA
                                </h3>
                                <div style="font-size: 1.3rem; line-height: 1.6; color: #1f2937; font-weight: 500; background: linear-gradient(135deg, #f8fafc, #f1f5f9); padding: 25px; border-radius: 12px; border-left: 4px solid #4f46e5; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);">
                                    ${currentCard.question}
                                </div>
                            </div>
                            
                            <!-- √Årea de respuesta -->
                            <div style="margin-bottom: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3 style="color: #6b7280; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin: 0;">
                                        ‚úÖ RESPUESTA CORRECTA
                                    </h3>
                                    <button onclick="toggleAnswer()" class="btn ${memoryCardsState.showAnswer ? 'btn-secondary' : 'btn-success'}" style="padding: 8px 16px; font-size: 14px; font-weight: 600; border-radius: 20px;">
                                        ${memoryCardsState.showAnswer ? 'üôà Ocultar' : 'üëÅÔ∏è Ver Respuesta'}
                                    </button>
                                </div>
                                
                                <div style="min-height: 80px; background: ${memoryCardsState.showAnswer ? 'linear-gradient(135deg, #f0fdf4, #dcfce7)' : 'linear-gradient(135deg, #f9fafb, #f3f4f6)'}; border: 2px ${memoryCardsState.showAnswer ? 'solid #22c55e' : 'dashed #d1d5db'}; border-radius: 12px; padding: 25px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
                                    
                                    ${memoryCardsState.showAnswer ? `
                                        <div style="text-align: center;">
                                            <div style="font-size: 1.3rem; font-weight: 700; color: #166534; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                                                <span style="font-size: 1.5rem;">‚úÖ</span>
                                                <span>${String.fromCharCode(97 + currentCard.correctAnswer).toUpperCase()}) ${currentCard.options[currentCard.correctAnswer]}</span>
                                            </div>
                                            <div style="font-size: 14px; color: #16a34a; font-weight: 500;">
                                                Esta es la respuesta correcta
                                            </div>
                                        </div>
                                    ` : `
                                        <div style="color: #9ca3af; font-style: italic; text-align: center;">
                                            <div style="font-size: 2.5rem; margin-bottom: 10px;">ü§î</div>
                                            <div style="font-size: 16px;">Haz clic en "Ver Respuesta" para revelar la soluci√≥n</div>
                                        </div>
                                    `}
                                </div>
                            </div>
                            
                            <!-- Consejo -->
                            <div style="text-align: center; margin-top: 25px; padding: 12px; background: rgba(79, 70, 229, 0.05); border-radius: 10px; border: 1px solid rgba(79, 70, 229, 0.1);">
                                <div style="color: #6b7280; font-size: 13px; font-weight: 500;">
                                    üí° Intenta responder mentalmente antes de ver la respuesta
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Controles de navegaci√≥n -->
                <div style="display: flex; justify-content: center; align-items: center; gap: 25px;">
                    <button onclick="previousCard()" class="btn btn-secondary" style="padding: 12px 25px; font-size: 16px; border-radius: 25px; display: flex; align-items: center; gap: 10px; min-width: 140px; justify-content: center;" ${totalCards <= 1 ? 'disabled' : ''}>
                        <span style="font-size: 18px;">‚Üê</span>
                        <span>Anterior</span>
                    </button>
                    
                    <button onclick="nextCard()" class="btn btn-primary" style="padding: 12px 25px; font-size: 16px; border-radius: 25px; display: flex; align-items: center; gap: 10px; min-width: 140px; justify-content: center;" ${totalCards <= 1 ? 'disabled' : ''}>
                        <span>Siguiente</span>
                        <span style="font-size: 18px;">‚Üí</span>
                    </button>
                </div>
            </div>
            
            <!-- Estilos CSS -->
            <style>
                @keyframes cardFloat {
                    0%, 100% { transform: rotateX(1deg) rotateY(-1deg) translateY(0px); }
                    50% { transform: rotateX(1deg) rotateY(-1deg) translateY(-2px); }
                }
                
                .memory-card:hover {
                    transform: rotateX(0deg) rotateY(0deg) translateY(-3px) !important;
                    box-shadow: 0 25px 50px rgba(0,0,0,0.15) !important;
                }
            </style>
        `;
    }
    
    // INTERCEPTAR la funci√≥n renderIntermediateScreen para a√±adir las nuevas opciones
    const originalRenderIntermediateScreen = renderIntermediateScreen;
    window.renderIntermediateScreen = function() {
        return `
            <div style="min-height: 80vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: -30px; border-radius: 20px;">
                <div style="background: white; border-radius: 24px; padding: 60px; box-shadow: 0 25px 50px rgba(0,0,0,0.15); max-width: 600px; width: 100%; text-align: center; position: relative; overflow: hidden;">
                    
                    <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: linear-gradient(135deg, #667eea20, #764ba220); border-radius: 50%; z-index: 0;"></div>
                    <div style="position: absolute; bottom: -30px; left: -30px; width: 100px; height: 100px; background: linear-gradient(135deg, #764ba220, #667eea20); border-radius: 50%; z-index: 0;"></div>
                    
                    <div style="position: relative; z-index: 1;">
                        <div style="background: linear-gradient(135deg, #667eea, #764ba2); width: 80px; height: 80px; border-radius: 20px; margin: 0 auto 30px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);">
                            <span style="font-size: 2.5rem; filter: drop-shadow(0 2px 4px rgba(255,255,255,0.3));">üéØ</span>
                        </div>
                        
                        <h1 style="font-size: 2.8rem; font-weight: 700; margin: 0 0 15px 0; background: linear-gradient(135deg, #2d3748, #4a5568); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                            ¬°Bienvenid@!
                        </h1>
                        
                        <p style="font-size: 1.3rem; color: #6b7280; margin: 0 0 50px 0; font-weight: 400; line-height: 1.5;">
                            Selecciona qu√© te gustar√≠a hacer hoy
                        </p>
                        
                        <div style="display: grid; gap: 15px; margin-bottom: 40px;">
                            
                            <button onclick="goToTests()" style="background: linear-gradient(135deg, #4f46e5, #7c3aed); border: none; border-radius: 16px; padding: 20px 30px; color: white; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3);" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                                    <span style="font-size: 1.5rem;">üìö</span>
                                    <div style="text-align: left;">
                                        <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 2px;">Realizar Tests</div>
                                        <div style="font-size: 0.85rem; opacity: 0.9; font-weight: 400;">Crear y gestionar ex√°menes</div>
                                    </div>
                                </div>
                            </button>
                            
                            <button onclick="goToSummaries()" style="background: linear-gradient(135deg, #059669, #0ea5e9); border: none; border-radius: 16px; padding: 20px 30px; color: white; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 20px rgba(5, 150, 105, 0.3);" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                                    <span style="font-size: 1.5rem;">üìä</span>
                                    <div style="text-align: left;">
                                        <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 2px;">Ver Res√∫menes</div>
                                        <div style="font-size: 0.85rem; opacity: 0.9; font-weight: 400;">Analizar resultados y estad√≠sticas</div>
                                    </div>
                                </div>
                            </button>
                            
                            <button onclick="goToMemoryCards()" style="background: linear-gradient(135deg, #f59e0b, #d97706); border: none; border-radius: 16px; padding: 20px 30px; color: white; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3);" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                                    <span style="font-size: 1.5rem;">üÉè</span>
                                    <div style="text-align: left;">
                                        <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 2px;">Tarjetas de Memoria</div>
                                        <div style="font-size: 0.85rem; opacity: 0.9; font-weight: 400;">Repasar con tarjetas interactivas</div>
                                    </div>
                                </div>
                            </button>
                            
                            <button onclick="goToMultiplayer()" style="background: linear-gradient(135deg, #ef4444, #dc2626); border: none; border-radius: 16px; padding: 20px 30px; color: white; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                                    <span style="font-size: 1.5rem;">‚öîÔ∏è</span>
                                    <div style="text-align: left;">
                                        <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 2px;">Duelo de Preguntas</div>
                                        <div style="font-size: 0.85rem; opacity: 0.9; font-weight: 400;">Compete con otros usuarios</div>
                                    </div>
                                </div>
                            </button>
                            
                            <!-- NUEVO: BOT√ìN EXPORTAR CONTENIDO PORTABLE -->
                            <button onclick="exportContentDataOnly()" style="background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 16px; padding: 20px 30px; color: white; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                                    <span style="font-size: 1.5rem;">üì§</span>
                                    <div style="text-align: left;">
                                        <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 2px;">Exportar Contenido</div>
                                        <div style="font-size: 0.85rem; opacity: 0.9; font-weight: 400;">Descargar datos portables</div>
                                    </div>
                                </div>
                            </button>
                            
                            <!-- NUEVO: BOT√ìN IMPORTAR CONTENIDO -->
                            <button onclick="importContentFromFile()" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); border: none; border-radius: 16px; padding: 20px 30px; color: white; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 20px rgba(139, 92, 246, 0.3);" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                                    <span style="font-size: 1.5rem;">üì•</span>
                                    <div style="text-align: left;">
                                        <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 2px;">Importar Contenido</div>
                                        <div style="font-size: 0.85rem; opacity: 0.9; font-weight: 400;">Cargar datos desde archivo</div>
                                    </div>
                                </div>
                            </button>
                        </div>
                        
                        <div style="border-top: 1px solid #e5e7eb; padding-top: 25px; color: #9ca3af; font-size: 0.9rem;">
                            <p style="margin: 0;">Sistema de Ex√°menes ‚Ä¢ Usuario: ${state.currentUser.name}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    };
    
    // EXTENDER renderTabContent para incluir memory-cards
    const originalRenderTabContentMemory = renderTabContent;
    renderTabContent = function() {
        switch(state.currentTab) {
            case 'upload':
                return renderUploadTab();
            case 'questions':
                return renderQuestionsTab();
            case 'test':
                return renderTestTab();
            case 'results':
                return renderResultsTab();
            case 'summary':
                return renderSummaryTab();
            case 'memory-cards':
                return renderMemoryCardsTab();
            default:
                return '<div>Error: Pesta√±a no encontrada - ' + state.currentTab + '</div>';
        }
    };
    
    // EXTENDER render para mostrar bot√≥n en header cuando estamos en tarjetas
    const originalRenderMemoryCards = render;
    render = function() {
        if (showIntermediateScreen && state.currentUser) {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <div class="title">Sistema de Ex√°menes</div>
                        <div>
                            <span style="color: ${state.apiKey ? '#10b981' : '#ef4444'};">
                                ${state.apiKey ? '‚úÖ API Configurada' : '‚ùå Sin API'}
                            </span>
                            <button onclick="configureAPI()" class="btn btn-secondary">API</button>
                            <span style="color: #f59e0b;">üë§ ${state.currentUser.name}</span>
                            <button onclick="logout()" class="btn btn-danger">Salir</button>
                        </div>
                    </div>
                    ${renderIntermediateScreen()}
                </div>
            `;
        } else if (state.currentUser) {
            const app = document.getElementById('app');
            
            let pageTitle = 'Sistema de Ex√°menes';
            if (state.currentTab === 'questions') pageTitle = 'Banco de Preguntas';
            else if (state.currentTab === 'results') pageTitle = 'Resultados del Test';
            else if (state.currentTab === 'summary') pageTitle = 'Generador de Res√∫menes';
            else if (state.currentTab === 'memory-cards') pageTitle = 'Tarjetas de Memoria';
            
            const showNavTabs = state.currentTab !== 'summary' && state.currentTab !== 'memory-cards';
            
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <div class="title">${pageTitle}</div>
                        <div>
                            <span style="color: ${state.apiKey ? '#10b981' : '#ef4444'};">
                                ${state.apiKey ? '‚úÖ API Configurada' : '‚ùå Sin API'}
                            </span>
                            <button onclick="configureAPI()" class="btn btn-secondary">API</button>
                            ${state.currentTab === 'memory-cards' ? `
                                <button onclick="backToMainMenuFromCards()" class="btn btn-info">üè† Men√∫</button>
                            ` : ''}
                            <span style="color: #f59e0b;">üë§ ${state.currentUser.name}</span>
                            <button onclick="logout()" class="btn btn-danger">Salir</button>
                        </div>
                    </div>

                    ${showNavTabs ? `
                        <div class="nav-tabs">
                            <button class="nav-tab ${state.currentTab === 'upload' ? 'active' : ''}" onclick="setTab('upload')">
                                üì§ Subir Test
                            </button>
                            <button class="nav-tab ${state.currentTab === 'questions' ? 'active' : ''}" onclick="setTab('questions')">
                                üìã Banco de Preguntas (${getFilteredQuestions().length})
                            </button>
                            <button class="nav-tab ${state.currentTab === 'test' ? 'active' : ''}" onclick="setTab('test')">
                                üéØ Test Aleatorio
                            </button>
                            <button class="nav-tab ${state.currentTab === 'results' ? 'active' : ''}" onclick="setTab('results')">
                                üìä Resultados (${state.testResults.length})
                            </button>
                        </div>
                    ` : ''}

                    <div id="messages"></div>

                    ${renderTabContent()}
                </div>
            `;
        } else {
            originalRenderMemoryCards.call(this);
        }
    };
    
    // ATAJOS DE TECLADO
    function setupMemoryCardsKeyboard() {
        document.addEventListener('keydown', function(e) {
            if (state.currentTab !== 'memory-cards') return;
            
            switch(e.key) {
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    e.preventDefault();
                    previousCard();
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    e.preventDefault();
                    nextCard();
                    break;
                case ' ':
                case 'Enter':
                    e.preventDefault();
                    toggleAnswer();
                    break;
                case 's':
                case 'S':
                    e.preventDefault();
                    shuffleCards();
                    break;
                case 'Escape':
                    e.preventDefault();
                    backToMainMenuFromCards();
                    break;
            }
        });
    }
    
    setupMemoryCardsKeyboard();
    
    console.log('‚úÖ Sistema Completo Implementado: Tarjetas de Memoria + Exportar/Importar Contenido Portable');
    console.log('üÉè Funcionalidades de Tarjetas:');
    console.log('   - Bot√≥n "üè† Men√∫" en header');
    console.log('   - Tarjeta con animaci√≥n flotante');
    console.log('   - Atajos de teclado (‚Üê‚Üí navegaci√≥n, Espacio ver respuesta)');
    console.log('üì§ Funcionalidades de Exportaci√≥n/Importaci√≥n:');
    console.log('   - "üì§ Exportar Contenido": SOLO datos (preguntas, temas, tests)');
    console.log('   - "üì• Importar Contenido": Compatible con cualquier usuario');
    console.log('   - Evita duplicados autom√°ticamente');
    console.log('   - Perfecto para compartir contenido entre cuentas');
    
    setTimeout(() => {
        if (state.currentUser && typeof window.render === 'function') {
            render();
        }
    }, 100);
</script>
   <!-- 
PARCHE: BOT√ìN MEN√ö UNIVERSAL EN TODAS LAS PANTALLAS
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
Este parche a√±ade un bot√≥n "Men√∫" consistente en el header de todas las pantallas
-->

<script>
    // ========== PARCHE: BOT√ìN MEN√ö UNIVERSAL ==========
    console.log('üéØ Implementando bot√≥n Men√∫ universal...');
    
    // INTERCEPTAR la funci√≥n render para a√±adir el bot√≥n Men√∫ a todas las pantallas
    const originalRenderForMenu = window.render;
    window.render = function() {
        // Llamar a la funci√≥n de render original
        originalRenderForMenu.call(this);
        
        // Solo a√±adir el bot√≥n si el usuario est√° logueado
        if (state.currentUser) {
            addUniversalMenuButton();
        }
    };
    
    // FUNCI√ìN para a√±adir el bot√≥n Men√∫ universal
    function addUniversalMenuButton() {
        // Esperar un poco para que el DOM se haya renderizado
        setTimeout(() => {
            const header = document.querySelector('.header');
            
            if (header && !document.getElementById('universal-menu-button')) {
                // Crear el bot√≥n Men√∫
                const menuButton = document.createElement('button');
                menuButton.id = 'universal-menu-button';
                menuButton.onclick = goToMainMenu;
                menuButton.className = 'btn btn-info';
                menuButton.style.cssText = `
                    padding: 8px 16px; 
                    font-size: 14px; 
                    font-weight: 600;
                    display: flex; 
                    align-items: center; 
                    gap: 8px;
                    margin-right: 15px;
                    border-radius: 8px;
                    transition: all 0.2s ease;
                `;
                menuButton.innerHTML = '<span>üè†</span> Men√∫';
                
                // A√±adir efecto hover
                menuButton.addEventListener('mouseover', function() {
                    this.style.transform = 'translateY(-1px)';
                    this.style.boxShadow = '0 4px 12px rgba(14, 165, 233, 0.3)';
                });
                
                menuButton.addEventListener('mouseout', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                });
                
                // Insertar el bot√≥n en el header
                // Buscar el contenedor de botones de usuario (lado derecho del header)
                const userButtons = header.querySelector('div:last-child');
                if (userButtons) {
                    // Insertar el bot√≥n Men√∫ al principio del contenedor de botones de usuario
                    userButtons.insertBefore(menuButton, userButtons.firstChild);
                } else {
                    // Si no hay contenedor de botones, a√±adir al final del header
                    header.appendChild(menuButton);
                }
                
                console.log('üéØ Bot√≥n Men√∫ a√±adido al header');
            }
        }, 50);
    }
    
    // FUNCI√ìN para ir al men√∫ principal
    function goToMainMenu() {
        console.log('üè† Navegando al men√∫ principal...');
        
        // Resetear todos los estados a su valor inicial
        showIntermediateScreen = true;
        state.currentTab = 'upload';
        
        // Resetear estado de res√∫menes si existe
        if (typeof summarySystemState !== 'undefined') {
            summarySystemState.currentView = 'create';
            summarySystemState.viewingSummary = null;
            summarySystemState.selectedImages = [];
            summarySystemState.generatedSummary = '';
            summarySystemState.isProcessing = false;
        }
        
        // Resetear estado de tarjetas de memoria si existe
        if (typeof memoryCardsState !== 'undefined') {
            memoryCardsState.currentCard = null;
            memoryCardsState.cardIndex = 0;
            memoryCardsState.showAnswer = false;
        }
        
        // Resetear estado de tests
        if (state.currentTest) {
            if (state.currentTest.timer) {
                clearInterval(state.currentTest.timer);
            }
            state.currentTest = null;
        }
        
        // Resetear filtros de preguntas
        state.selectedTopicFilter = 'all';
        state.selectedTopicForNewQuestions = null;
        state.currentViewingResult = null;
        
        // Limpiar estados de upload
        state.selectedImages = [];
        state.transcribedText = '';
        state.cleanedText = '';
        
        // Re-renderizar
        render();
        
        // Mostrar mensaje de confirmaci√≥n
        showMessage('Volviendo al men√∫ principal', 'success');
    }
    
    // ASEGURAR que el bot√≥n aparezca en pantallas especiales
    
    // Para la pantalla de visualizaci√≥n de resultados espec√≠ficos
    const originalRenderSpecificResult = renderSpecificResult;
    if (typeof renderSpecificResult === 'function') {
        window.renderSpecificResult = function(result) {
            const originalHTML = originalRenderSpecificResult(result);
            // La funci√≥n render ya se encargar√° de a√±adir el bot√≥n
            return originalHTML;
        };
    }
    
    // Para la pantalla de test en curso
    const originalRenderCurrentTest = renderCurrentTest;
    if (typeof renderCurrentTest === 'function') {
        window.renderCurrentTest = function() {
            const originalHTML = originalRenderCurrentTest();
            // La funci√≥n render ya se encargar√° de a√±adir el bot√≥n
            return originalHTML;
        };
    }
    
    // MANEJAR casos especiales donde el bot√≥n podr√≠a no aparecer
    
    // Interceptar setTab para asegurar que el bot√≥n se re-a√±ada
    const originalSetTabForMenu = window.setTab;
    if (typeof window.setTab === 'function') {
        window.setTab = function(tab) {
            // Remover bot√≥n anterior para evitar duplicados
            const existingButton = document.getElementById('universal-menu-button');
            if (existingButton) {
                existingButton.remove();
            }
            
            // Llamar funci√≥n original
            originalSetTabForMenu.call(this, tab);
        };
    }
    
    // ESTILOS CSS adicionales para el bot√≥n
    const menuButtonStyles = document.createElement('style');
    menuButtonStyles.textContent = `
        #universal-menu-button {
            background: linear-gradient(135deg, #0ea5e9, #0284c7) !important;
            border: none !important;
            color: white !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        #universal-menu-button:hover {
            background: linear-gradient(135deg, #0284c7, #0369a1) !important;
        }
        
        #universal-menu-button:active {
            transform: translateY(0) !important;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1) !important;
        }
        
        /* Responsive: ocultar texto en pantallas peque√±as */
        @media (max-width: 768px) {
            #universal-menu-button span:last-child {
                display: none;
            }
            #universal-menu-button {
                padding: 8px 12px !important;
            }
        }
    `;
    
    // A√±adir estilos al head si no existen
    if (!document.getElementById('universal-menu-styles')) {
        menuButtonStyles.id = 'universal-menu-styles';
        document.head.appendChild(menuButtonStyles);
    }
    
    // FUNCI√ìN de diagn√≥stico (opcional)
    window.checkMenuButton = function() {
        console.log('üîç DIAGN√ìSTICO DEL BOT√ìN MEN√ö:');
        console.log('- Bot√≥n existe:', !!document.getElementById('universal-menu-button'));
        console.log('- Header existe:', !!document.querySelector('.header'));
        console.log('- Usuario logueado:', !!state.currentUser);
        console.log('- Pesta√±a actual:', state.currentTab);
        console.log('- Pantalla intermedia:', showIntermediateScreen);
    };
    
    console.log('‚úÖ Parche de bot√≥n Men√∫ universal aplicado correctamente');
    console.log('üéØ El bot√≥n "üè† Men√∫" aparecer√° en todas las pantallas del sistema');
    console.log('üîß Usa checkMenuButton() en consola para diagn√≥stico si hay problemas');
    
    // Forzar re-renderizado para aplicar el bot√≥n inmediatamente
    setTimeout(() => {
        if (state.currentUser && typeof window.render === 'function') {
            render();
        }
    }, 100);
</script>
  <!-- 
PARCHE: HEADER UNIFICADO "PRIII" EN TODAS LAS PANTALLAS
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
Este parche crea un header consistente con "Priii", bot√≥n Men√∫ central, y botones API/Perfil
-->

<script>
    // ========== PARCHE: HEADER UNIFICADO "PRIII" ==========
    console.log('üé® Implementando header unificado "Priii"...');
    
    // Estado para el modal de perfil
    let userProfileState = {
        showModal: false,
        editingField: null
    };
    
    // FUNCI√ìN para mostrar/ocultar modal de perfil
    window.toggleUserProfile = function() {
        userProfileState.showModal = !userProfileState.showModal;
        userProfileState.editingField = null;
        renderUserProfileModal();
    };
    
    // FUNCI√ìN para editar campo del perfil
    window.editProfileField = function(field) {
        if (!state.currentUser) return;
        
        const users = JSON.parse(localStorage.getItem('realSystemUsers') || '{}');
        const currentUser = users[state.currentUser.username];
        
        if (!currentUser) return;
        
        let newValue = '';
        let message = '';
        
        switch(field) {
            case 'name':
                newValue = prompt('Nuevo nombre completo:', currentUser.name);
                message = 'Nombre actualizado correctamente';
                break;
            case 'password':
                const oldPassword = prompt('Contrase√±a actual:');
                if (!oldPassword || oldPassword !== currentUser.password) {
                    showMessage('Contrase√±a actual incorrecta', 'error');
                    return;
                }
                newValue = prompt('Nueva contrase√±a (m√≠nimo 4 caracteres):');
                if (!newValue || newValue.length < 4) {
                    showMessage('La nueva contrase√±a debe tener al menos 4 caracteres', 'error');
                    return;
                }
                const confirmPassword = prompt('Confirmar nueva contrase√±a:');
                if (newValue !== confirmPassword) {
                    showMessage('Las contrase√±as no coinciden', 'error');
                    return;
                }
                message = 'Contrase√±a actualizada correctamente';
                break;
            case 'security':
                const currentAnswer = prompt('Respuesta actual a la pregunta de seguridad:');
                if (!currentAnswer || currentAnswer.toLowerCase().trim() !== currentUser.securityAnswer) {
                    showMessage('Respuesta de seguridad incorrecta', 'error');
                    return;
                }
                const newQuestion = prompt('Nueva pregunta de seguridad:', currentUser.securityQuestion);
                if (!newQuestion) return;
                const newAnswer = prompt('Nueva respuesta:');
                if (!newAnswer) return;
                
                currentUser.securityQuestion = newQuestion;
                currentUser.securityAnswer = newAnswer.toLowerCase().trim();
                localStorage.setItem('realSystemUsers', JSON.stringify(users));
                showMessage('Pregunta de seguridad actualizada', 'success');
                renderUserProfileModal();
                return;
        }
        
        if (newValue && newValue.trim()) {
            currentUser[field] = field === 'name' ? newValue.trim() : newValue;
            
            // Actualizar en localStorage
            localStorage.setItem('realSystemUsers', JSON.stringify(users));
            
            // Actualizar estado actual si es el nombre
            if (field === 'name') {
                state.currentUser.name = newValue.trim();
            }
            
            showMessage(message, 'success');
            renderUserProfileModal();
            render(); // Re-renderizar para actualizar el nombre en el header
        }
    };
    
    // FUNCI√ìN para renderizar el modal de perfil
    function renderUserProfileModal() {
        // Remover modal existente
        const existingModal = document.getElementById('user-profile-modal');
        if (existingModal) {
            existingModal.remove();
        }
        
        if (!userProfileState.showModal || !state.currentUser) return;
        
        const users = JSON.parse(localStorage.getItem('realSystemUsers') || '{}');
        const currentUser = users[state.currentUser.username];
        
        if (!currentUser) return;
        
        const modal = document.createElement('div');
        modal.id = 'user-profile-modal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        `;
        
        modal.innerHTML = `
            <div style="
                background: white;
                border-radius: 16px;
                padding: 30px;
                max-width: 500px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 40px rgba(0,0,0,0.2);
                animation: slideInModal 0.3s ease;
            ">
                <!-- Header del modal -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 style="margin: 0; color: #1f2937; display: flex; align-items: center; gap: 10px;">
                        <span>üë§</span> Perfil de Usuario
                    </h2>
                    <button onclick="toggleUserProfile()" style="
                        background: #ef4444;
                        color: white;
                        border: none;
                        border-radius: 50%;
                        width: 32px;
                        height: 32px;
                        font-size: 16px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">√ó</button>
                </div>
                
                <!-- Informaci√≥n del usuario -->
                <div style="space-y: 20px;">
                    
                    <!-- Nombre completo -->
                    <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <label style="font-size: 13px; font-weight: 600; color: #6b7280; display: block; margin-bottom: 5px;">NOMBRE COMPLETO</label>
                                <div style="font-size: 16px; color: #1f2937; font-weight: 500;">${currentUser.name}</div>
                            </div>
                            <button onclick="editProfileField('name')" class="btn btn-warning" style="padding: 6px 12px; font-size: 12px;">
                                ‚úèÔ∏è Editar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Usuario (no editable) -->
                    <div style="background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <label style="font-size: 13px; font-weight: 600; color: #6b7280; display: block; margin-bottom: 5px;">NOMBRE DE USUARIO</label>
                        <div style="font-size: 16px; color: #6b7280; font-weight: 500;">${state.currentUser.username}</div>
                        <div style="font-size: 11px; color: #9ca3af; margin-top: 5px; font-style: italic;">No se puede modificar</div>
                    </div>
                    
                    <!-- Contrase√±a -->
                    <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <label style="font-size: 13px; font-weight: 600; color: #92400e; display: block; margin-bottom: 5px;">CONTRASE√ëA</label>
                                <div style="font-size: 16px; color: #78350f; font-weight: 500;">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
                            </div>
                            <button onclick="editProfileField('password')" class="btn btn-warning" style="padding: 6px 12px; font-size: 12px;">
                                üîë Cambiar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Pregunta de seguridad -->
                    <div style="background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1; margin-right: 15px;">
                                <label style="font-size: 13px; font-weight: 600; color: #1e40af; display: block; margin-bottom: 5px;">PREGUNTA DE SEGURIDAD</label>
                                <div style="font-size: 14px; color: #1e3a8a; line-height: 1.4;">${currentUser.securityQuestion}</div>
                            </div>
                            <button onclick="editProfileField('security')" class="btn btn-info" style="padding: 6px 12px; font-size: 12px; flex-shrink: 0;">
                                üîê Cambiar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Informaci√≥n de cuenta -->
                    <div style="background: #f0fdf4; border: 1px solid #22c55e; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <label style="font-size: 13px; font-weight: 600; color: #166534; display: block; margin-bottom: 10px;">INFORMACI√ìN DE LA CUENTA</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 13px; color: #166534;">
                            <div>
                                <div style="font-weight: 500; margin-bottom: 2px;">Cuenta creada:</div>
                                <div style="opacity: 0.8;">${currentUser.createdAt}</div>
                            </div>
                            <div>
                                <div style="font-weight: 500; margin-bottom: 2px;">√öltimo acceso:</div>
                                <div style="opacity: 0.8;">${currentUser.lastLogin || 'Nunca'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Estad√≠sticas del usuario -->
                    <div style="background: linear-gradient(135deg, #667eea15, #764ba215); border: 1px solid #4f46e5; border-radius: 8px; padding: 15px;">
                        <label style="font-size: 13px; font-weight: 600; color: #4f46e5; display: block; margin-bottom: 10px;">üìä ESTAD√çSTICAS PERSONALES</label>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; font-size: 13px;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #4f46e5;">${state.questions.length}</div>
                                <div style="color: #6366f1; font-size: 11px;">Preguntas</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #7c3aed;">${state.topics.length}</div>
                                <div style="color: #8b5cf6; font-size: 11px;">Temas</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #059669;">${state.testResults.length}</div>
                                <div style="color: #10b981; font-size: 11px;">Tests</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #f59e0b;">${(typeof summarySystemState !== 'undefined') ? summarySystemState.savedSummaries.length : 0}</div>
                                <div style="color: #d97706; font-size: 11px;">Res√∫menes</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <style>
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                
                @keyframes slideInModal {
                    from { 
                        opacity: 0;
                        transform: translateY(-20px) scale(0.95);
                    }
                    to { 
                        opacity: 1;
                        transform: translateY(0) scale(1);
                    }
                }
            </style>
        `;
        
        // A√±adir al DOM
        document.body.appendChild(modal);
        
        // Cerrar modal al hacer clic fuera
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                toggleUserProfile();
            }
        });
    }
    
    // FUNCI√ìN para ir al men√∫ principal desde cualquier lugar
    window.goToMainMenuUnified = function() {
        console.log('üè† Navegando al men√∫ principal desde header unificado...');
        
        // Cerrar modal de perfil si est√° abierto
        userProfileState.showModal = false;
        renderUserProfileModal();
        
        // Resetear todos los estados
        showIntermediateScreen = true;
        state.currentTab = 'upload';
        
        // Resetear estado de res√∫menes
        if (typeof summarySystemState !== 'undefined') {
            summarySystemState.currentView = 'create';
            summarySystemState.viewingSummary = null;
            summarySystemState.selectedImages = [];
            summarySystemState.generatedSummary = '';
            summarySystemState.isProcessing = false;
        }
        
        // Resetear estado de tarjetas de memoria
        if (typeof memoryCardsState !== 'undefined') {
            memoryCardsState.currentCard = null;
            memoryCardsState.cardIndex = 0;
            memoryCardsState.showAnswer = false;
        }
        
        // Resetear estado de tests
        if (state.currentTest) {
            if (state.currentTest.timer) {
                clearInterval(state.currentTest.timer);
            }
            state.currentTest = null;
        }
        
        // Resetear filtros y estados
        state.selectedTopicFilter = 'all';
        state.selectedTopicForNewQuestions = null;
        state.currentViewingResult = null;
        state.selectedImages = [];
        state.transcribedText = '';
        state.cleanedText = '';
        
        render();
        showMessage('Volviendo al men√∫ principal', 'success');
    };
    
    // FUNCI√ìN para renderizar el header unificado
    function renderUnifiedHeader() {
        return `
            <div class="unified-header">
                <!-- Logo/Marca "Priii" -->
                <div class="priii-logo" onclick="goToMainMenuUnified()" title="Ir al men√∫ principal">
                    Priii
                </div>
                
                <!-- Bot√≥n Men√∫ Central -->
                <div class="center-menu">
                    <button onclick="goToMainMenuUnified()" class="menu-button">
                        <span class="menu-icon">üè†</span>
                        <span class="menu-text">Men√∫</span>
                    </button>
                </div>
                
                <!-- Botones de la derecha -->
                <div class="right-buttons">
                    <button onclick="configureAPI()" class="header-btn api-btn" title="Configurar API de Anthropic">
                        <span class="btn-icon">üîë</span>
                        <span class="btn-text">API</span>
                        <span class="api-status ${state.apiKey ? 'active' : 'inactive'}"></span>
                    </button>
                    
                    <button onclick="toggleUserProfile()" class="header-btn profile-btn" title="Perfil de usuario">
                        <span class="btn-icon">üë§</span>
                        <span class="btn-text">${state.currentUser.name.split(' ')[0]}</span>
                    </button>
                </div>
            </div>
            
            <style>
                .unified-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 15px 25px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                    position: relative;
                    z-index: 1000;
                }
                
                /* Logo Priii */
                .priii-logo {
                    font-size: 2.5rem;
                    font-weight: 900;
                    background: linear-gradient(45deg, #fff, #f0f9ff);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                    background-clip: text;
                    text-shadow: 0 4px 8px rgba(0,0,0,0.3);
                    cursor: pointer;
                    transition: all 0.3s ease;
                    font-family: 'Comic Sans MS', cursive, sans-serif;
                    letter-spacing: -2px;
                    transform: rotate(-2deg);
                    user-select: none;
                }
                
                .priii-logo:hover {
                    transform: rotate(0deg) scale(1.05);
                    filter: drop-shadow(0 0 10px rgba(255,255,255,0.5));
                }
                
                /* Men√∫ Central */
                .center-menu {
                    position: absolute;
                    left: 50%;
                    transform: translateX(-50%);
                }
                
                .menu-button {
                    background: rgba(255,255,255,0.15);
                    border: 2px solid rgba(255,255,255,0.3);
                    border-radius: 25px;
                    color: white;
                    padding: 12px 24px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    transition: all 0.3s ease;
                    backdrop-filter: blur(10px);
                }
                
                .menu-button:hover {
                    background: rgba(255,255,255,0.25);
                    border-color: rgba(255,255,255,0.5);
                    transform: translateY(-2px);
                    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
                }
                
                .menu-icon {
                    font-size: 18px;
                }
                
                /* Botones de la derecha */
                .right-buttons {
                    display: flex;
                    gap: 10px;
                    align-items: center;
                }
                
                .header-btn {
                    background: rgba(255,255,255,0.1);
                    border: 1px solid rgba(255,255,255,0.2);
                    border-radius: 20px;
                    color: white;
                    padding: 10px 16px;
                    font-size: 14px;
                    font-weight: 500;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    transition: all 0.2s ease;
                    position: relative;
                }
                
                .header-btn:hover {
                    background: rgba(255,255,255,0.2);
                    border-color: rgba(255,255,255,0.4);
                    transform: translateY(-1px);
                }
                
                .btn-icon {
                    font-size: 16px;
                }
                
                /* Indicador de estado API */
                .api-status {
                    position: absolute;
                    top: -2px;
                    right: -2px;
                    width: 10px;
                    height: 10px;
                    border-radius: 50%;
                    border: 2px solid white;
                }
                
                .api-status.active {
                    background: #22c55e;
                    box-shadow: 0 0 6px rgba(34, 197, 94, 0.8);
                }
                
                .api-status.inactive {
                    background: #ef4444;
                }
                
                /* Responsive */
                @media (max-width: 768px) {
                    .unified-header {
                        padding: 12px 15px;
                    }
                    
                    .priii-logo {
                        font-size: 2rem;
                    }
                    
                    .menu-button {
                        padding: 10px 16px;
                        font-size: 14px;
                    }
                    
                    .menu-text,
                    .btn-text {
                        display: none;
                    }
                    
                    .header-btn {
                        padding: 10px 12px;
                    }
                }
                
                @media (max-width: 480px) {
                    .center-menu {
                        position: static;
                        transform: none;
                        order: -1;
                        margin-right: auto;
                        margin-left: 10px;
                    }
                    
                    .unified-header {
                        flex-wrap: wrap;
                        gap: 10px;
                    }
                }
            </style>
        `;
    }
    
    // INTERCEPTAR la funci√≥n render principal para usar el header unificado
    const originalRenderForUnifiedHeader = window.render;
    window.render = function() {
        const app = document.getElementById('app');
        
        if (!state.currentUser) {
            // Pantallas de login - usar funci√≥n original
            originalRenderForUnifiedHeader.call(this);
        } else {
            // Usuario logueado - usar header unificado
            
            let contentHTML = '';
            
            if (showIntermediateScreen) {
                // Pantalla intermedia (men√∫ principal)
                contentHTML = renderIntermediateScreen();
            } else {
                // Otras pantallas - renderizar contenido con navegaci√≥n interna cuando corresponda
                if (state.currentTab !== 'summary' && state.currentTab !== 'memory-cards') {
                    // Para secciones de tests (upload, questions, test, results) mantener navegaci√≥n
                    contentHTML = `
                        <div class="nav-tabs">
                            <button class="nav-tab ${state.currentTab === 'upload' ? 'active' : ''}" onclick="setTab('upload')">
                                üì§ Subir Test
                            </button>
                            <button class="nav-tab ${state.currentTab === 'questions' ? 'active' : ''}" onclick="setTab('questions')">
                                üìã Banco de Preguntas (${getFilteredQuestions().length})
                            </button>
                            <button class="nav-tab ${state.currentTab === 'test' ? 'active' : ''}" onclick="setTab('test')">
                                üéØ Test Aleatorio
                            </button>
                            <button class="nav-tab ${state.currentTab === 'results' ? 'active' : ''}" onclick="setTab('results')">
                                üìä Resultados (${state.testResults.length})
                            </button>
                        </div>
                        ${renderTabContent()}
                    `;
                } else {
                    // Para res√∫menes y tarjetas de memoria, solo el contenido
                    contentHTML = renderTabContent();
                }
            }
            
            app.innerHTML = `
                <div class="container" style="padding: 0; max-width: none; margin: 0; border-radius: 0; box-shadow: none; background: transparent;">
                    ${renderUnifiedHeader()}
                    
                    <div style="padding: 20px; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); min-height: calc(100vh - 80px);">
                        <div id="messages" style="max-width: 1400px; margin: 0 auto 20px auto;"></div>
                        <div style="max-width: 1400px; margin: 0 auto;">
                            ${contentHTML}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Renderizar modal de perfil si est√° activo
        renderUserProfileModal();
    };
    
    // LIMPIAR funciones de navegaci√≥n redundantes ya que ahora todo se maneja desde el header
    // Mantener las funciones existentes por compatibilidad pero simplificarlas
    
    window.backToIntermediateScreen = goToMainMenuUnified;
    window.backToMainMenu = goToMainMenuUnified;
    window.backToMainMenuFromCards = goToMainMenuUnified;
    
    // INTERCEPTAR funciones que podr√≠an a√±adir botones redundantes
    const originalAddNavigationButtons = window.addNavigationButtons || function() {};
    window.addNavigationButtons = function() {
        // No hacer nada - el header unificado maneja toda la navegaci√≥n
        console.log('üö´ Navegaci√≥n redundante bloqueada - usando header unificado');
    };
    
    // INTERCEPTAR funci√≥n addUniversalMenuButton
    const originalAddUniversalMenuButton = window.addUniversalMenuButton || function() {};
    window.addUniversalMenuButton = function() {
        // No hacer nada - el header unificado ya incluye el bot√≥n
        console.log('üö´ Bot√≥n men√∫ redundante bloqueado - usando header unificado');
    };
    
    // ACTUALIZAR estilos globales para el nuevo dise√±o
    const unifiedHeaderStyles = document.createElement('style');
    unifiedHeaderStyles.textContent = `
        /* Reset de estilos del container original */
        body {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            margin: 0;
            padding: 0;
        }
        
        /* Ocultar headers redundantes */
        .header:not(.unified-header) {
            display: none !important;
        }
        
        /* Ocultar botones de navegaci√≥n redundantes pero mantener navegaci√≥n interna */
        #cross-navigation,
        #universal-menu-button,
        button[onclick*="backToIntermediateScreen"],
        button[onclick*="backToMainMenu"],
        button[onclick*="backToMainMenuFromCards"] {
            display: none !important;
        }
        
        /* Estilos para las pesta√±as de navegaci√≥n interna */
        .nav-tabs {
            display: flex;
            margin-bottom: 30px;
            background: #f8fafc;
            border-radius: 12px;
            padding: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .nav-tab {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #6b7280;
        }
        
        .nav-tab.active {
            background: white;
            color: #4f46e5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-weight: 600;
        }
        
        .nav-tab:hover:not(.active) {
            background: rgba(255,255,255,0.5);
            color: #374151;
        }
        
        /* Ajustar mensaje de notificaciones para el nuevo header */
        #messages .message {
            position: relative;
            z-index: 999;
            max-width: 500px;
            margin: 0 auto;
        }
        
        /* Mejorar contraste en pantalla intermedia */
        .container > div:not(.unified-header) {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            overflow: hidden;
        }
    `;
    
    // Reemplazar estilos anteriores
    const existingStyles = document.getElementById('unified-header-styles');
    if (existingStyles) {
        existingStyles.remove();
    }
    
    unifiedHeaderStyles.id = 'unified-header-styles';
    document.head.appendChild(unifiedHeaderStyles);
    
    console.log('‚úÖ Header unificado "Priii" implementado correctamente');
    console.log('üé® Caracter√≠sticas:');
    console.log('   - Logo "Priii" divertido a la izquierda');
    console.log('   - Bot√≥n Men√∫ centrado');
    console.log('   - Botones API y Perfil a la derecha');
    console.log('   - Modal de perfil completo');
    console.log('   - Headers redundantes eliminados');
    console.log('   - Responsive design');
    
    // Forzar re-renderizado inmediato
    setTimeout(() => {
        if (state.currentUser && typeof window.render === 'function') {
            render();
        }
    }, 100);
</script>
<!-- 
PARCHE: TARJETAS DE MEMORIA COMPACTAS - SIN SCROLL
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
Este parche optimiza el espacio vertical para evitar scroll
-->

<script>
    // ========== PARCHE: TARJETAS DE MEMORIA COMPACTAS ==========
    console.log('üìê Optimizando tarjetas de memoria para viewport completo...');
    
    // REEMPLAZAR la funci√≥n renderMemoryCardsTab con versi√≥n compacta
    function renderMemoryCardsTab() {
        if (memoryCardsState.verifiedQuestions.length === 0) {
            return `
                <div style="max-width: 800px; margin: 0 auto; text-align: center; padding: 40px 20px; height: calc(100vh - 200px); display: flex; flex-direction: column; justify-content: center;">
                    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); width: 80px; height: 80px; border-radius: 16px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);">
                        <span style="font-size: 2.5rem; color: white;">üÉè</span>
                    </div>
                    <h2 style="color: #1f2937; margin: 0 0 15px 0; font-size: 2rem;">No hay tarjetas disponibles</h2>
                    <p style="color: #6b7280; margin: 0 0 25px 0; font-size: 1rem; line-height: 1.5; max-width: 500px; margin-left: auto; margin-right: auto;">
                        Para usar las tarjetas de memoria necesitas tener preguntas <strong>verificadas</strong> (‚≠ê) en tu banco de preguntas.
                    </p>
                    <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; padding: 20px; margin-bottom: 25px; text-align: left; max-width: 450px; margin-left: auto; margin-right: auto;">
                        <h3 style="color: #92400e; margin: 0 0 12px 0; font-size: 1rem;">üìù ¬øC√≥mo verificar preguntas?</h3>
                        <ol style="color: #78350f; margin: 0; padding-left: 18px; line-height: 1.6; font-size: 14px;">
                            <li>Ve a "Banco de Preguntas"</li>
                            <li>Busca el bot√≥n ‚òÜ junto a cada pregunta</li>
                            <li>Haz clic para convertirlo en ‚≠ê (verificada)</li>
                            <li>Vuelve aqu√≠ para practicar con tarjetas</li>
                        </ol>
                    </div>
                    <button onclick="goToTestsFromSummary()" class="btn btn-primary" style="padding: 12px 20px; font-size: 15px;">
                        üìã Ir al Banco de Preguntas
                    </button>
                </div>
            `;
        }
        
        const currentCard = memoryCardsState.currentCard;
        const cardNumber = memoryCardsState.cardIndex + 1;
        const totalCards = memoryCardsState.verifiedQuestions.length;
        const topicName = currentCard.topicId ? getTopicName(currentCard.topicId) : 'General';
        
        return `
            <div style="max-width: 900px; margin: 0 auto; padding: 15px; min-height: calc(100vh - 150px); display: flex; flex-direction: column;">
                
                <!-- Header compacto -->
                <div style="text-align: center; margin-bottom: 15px;">
                    <h1 style="color: #1f2937; margin: 0; font-size: 1.8rem; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span>üÉè</span> Tarjetas de Memoria
                    </h1>
                    <p style="color: #6b7280; margin: 3px 0 0 0; font-size: 13px;">
                        Tarjeta ${cardNumber} de ${totalCards} preguntas verificadas
                    </p>
                </div>
                
                <!-- Controles superiores compactos -->
                <div style="display: flex; justify-content: center; align-items: center; gap: 12px; margin-bottom: 20px;">
                    <button onclick="shuffleCards()" class="btn btn-warning" style="padding: 8px 16px; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                        <span>üîÄ</span> Mezclar
                    </button>
                    <div style="background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 14px; box-shadow: 0 3px 10px rgba(79, 70, 229, 0.3);">
                        ${cardNumber} / ${totalCards}
                    </div>
                    <button onclick="loadVerifiedQuestions()" class="btn btn-info" style="padding: 8px 16px; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                        <span>üîÑ</span> Recargar
                    </button>
                </div>
                
                <!-- Tarjeta principal optimizada -->
                <div style="flex: 1; display: flex; align-items: center; margin-bottom: 20px;">
                    <div class="memory-card-compact" style="
                        background: linear-gradient(145deg, #ffffff, #f8fafc); 
                        border-radius: 16px; 
                        box-shadow: 0 8px 25px rgba(0,0,0,0.12), 0 1px 0 rgba(255,255,255,0.8);
                        margin: 0 auto; 
                        max-width: 700px; 
                        width: 100%;
                        position: relative; 
                        border: 2px solid #e2e8f0;
                        transition: all 0.3s ease;
                    ">
                    
                        <!-- Badge compacto -->
                        <div style="position: absolute; top: -6px; right: 12px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 6px 12px; border-radius: 15px; font-weight: 600; font-size: 12px; box-shadow: 0 3px 10px rgba(59, 130, 246, 0.4); z-index: 10;">
                            ‚≠ê Verificada
                        </div>
                        
                        <!-- Contenido de la tarjeta compacto -->
                        <div style="padding: 25px;">
                            
                            <!-- Tema y Pregunta -->
                            <div style="margin-bottom: 20px;">
                                <!-- Badge del tema -->
                                <div style="display: inline-block; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; margin-bottom: 15px; box-shadow: 0 2px 6px rgba(139, 92, 246, 0.3);">
                                    üìÅ ${topicName}
                                </div>
                                
                                <!-- Pregunta -->
                                <h3 style="color: #6b7280; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;">
                                    üìù PREGUNTA
                                </h3>
                                <div style="font-size: 1.1rem; line-height: 1.5; color: #1f2937; font-weight: 500; background: linear-gradient(135deg, #f8fafc, #f1f5f9); padding: 18px; border-radius: 10px; border-left: 3px solid #4f46e5; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);">
                                    ${currentCard.question}
                                </div>
                            </div>
                            
                            <!-- √Årea de respuesta compacta -->
                            <div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <h3 style="color: #6b7280; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin: 0;">
                                        ‚úÖ RESPUESTA CORRECTA
                                    </h3>
                                    <button onclick="toggleAnswer()" class="btn ${memoryCardsState.showAnswer ? 'btn-secondary' : 'btn-success'}" style="padding: 6px 14px; font-size: 13px; font-weight: 600; border-radius: 15px;">
                                        ${memoryCardsState.showAnswer ? 'üôà Ocultar' : 'üëÅÔ∏è Ver'}
                                    </button>
                                </div>
                                
                                <div style="min-height: 60px; background: ${memoryCardsState.showAnswer ? 'linear-gradient(135deg, #f0fdf4, #dcfce7)' : 'linear-gradient(135deg, #f9fafb, #f3f4f6)'}; border: 2px ${memoryCardsState.showAnswer ? 'solid #22c55e' : 'dashed #d1d5db'}; border-radius: 10px; padding: 15px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
                                    
                                    ${memoryCardsState.showAnswer ? `
                                        <div style="text-align: center;">
                                            <div style="font-size: 1.1rem; font-weight: 700; color: #166534; margin-bottom: 5px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                                <span style="font-size: 1.3rem;">‚úÖ</span>
                                                <span>${String.fromCharCode(97 + currentCard.correctAnswer).toUpperCase()}) ${currentCard.options[currentCard.correctAnswer]}</span>
                                            </div>
                                            <div style="font-size: 12px; color: #16a34a; font-weight: 500;">
                                                Esta es la respuesta correcta
                                            </div>
                                        </div>
                                    ` : `
                                        <div style="color: #9ca3af; font-style: italic; text-align: center;">
                                            <div style="font-size: 2rem; margin-bottom: 5px;">ü§î</div>
                                            <div style="font-size: 14px;">Haz clic en "Ver" para revelar la respuesta</div>
                                        </div>
                                    `}
                                </div>
                            </div>
                            
                            <!-- Consejo compacto -->
                            <div style="text-align: center; margin-top: 15px; padding: 8px; background: rgba(79, 70, 229, 0.05); border-radius: 8px; border: 1px solid rgba(79, 70, 229, 0.1);">
                                <div style="color: #6b7280; font-size: 12px; font-weight: 500;">
                                    üí° Intenta responder mentalmente antes de ver la respuesta
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Controles de navegaci√≥n fijos en la parte inferior -->
                <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: auto; padding-top: 15px;">
                    <button onclick="previousCard()" class="btn btn-secondary" style="padding: 10px 20px; font-size: 15px; border-radius: 20px; display: flex; align-items: center; gap: 8px; min-width: 120px; justify-content: center;" ${totalCards <= 1 ? 'disabled' : ''}>
                        <span style="font-size: 16px;">‚Üê</span>
                        <span>Anterior</span>
                    </button>
                    
                    <button onclick="nextCard()" class="btn btn-primary" style="padding: 10px 20px; font-size: 15px; border-radius: 20px; display: flex; align-items: center; gap: 8px; min-width: 120px; justify-content: center;" ${totalCards <= 1 ? 'disabled' : ''}>
                        <span>Siguiente</span>
                        <span style="font-size: 16px;">‚Üí</span>
                    </button>
                </div>
                
                <!-- Indicador de atajos de teclado -->
                <div style="text-align: center; margin-top: 10px; padding: 5px; font-size: 11px; color: #9ca3af;">
                    ‚Üê ‚Üí para navegar ‚Ä¢ Espacio para ver respuesta ‚Ä¢ S para mezclar ‚Ä¢ Esc para salir
                </div>
            </div>
            
            <!-- Estilos CSS optimizados -->
            <style>
                .memory-card-compact:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 12px 30px rgba(0,0,0,0.15) !important;
                }
                
                /* Optimizaciones responsive */
                @media (max-height: 700px) {
                    .memory-card-compact {
                        max-height: calc(100vh - 300px);
                        overflow-y: auto;
                    }
                }
                
                @media (max-width: 768px) {
                    .memory-card-compact {
                        margin: 0;
                        border-radius: 12px;
                    }
                    
                    .memory-card-compact > div {
                        padding: 20px !important;
                    }
                }
                
                /* Animaci√≥n suave para cambio de tarjetas */
                .memory-card-compact {
                    animation: cardSlideIn 0.3s ease-out;
                }
                
                @keyframes cardSlideIn {
                    from { 
                        opacity: 0;
                        transform: translateX(20px);
                    }
                    to { 
                        opacity: 1;
                        transform: translateX(0);
                    }
                }
            </style>
        `;
    }
    
    console.log('‚úÖ Tarjetas de memoria optimizadas para viewport completo');
    console.log('üìê Mejoras aplicadas:');
    console.log('   - Espaciado reducido y optimizado');
    console.log('   - Layout flexbox para uso completo del alto');
    console.log('   - Controles fijos en parte inferior');
    console.log('   - Responsive para diferentes alturas de pantalla');
    console.log('   - Sin scroll necesario');
    
    // Forzar re-renderizado si estamos en tarjetas de memoria
    setTimeout(() => {
        if (state.currentUser && state.currentTab === 'memory-cards' && typeof window.render === 'function') {
            render();
        }
    }, 100);
</script>
  <!-- 
PARCHE: BOT√ìN CERRAR SESI√ìN EN HEADER UNIFICADO
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
Este parche a√±ade el bot√≥n de logout al header en todas las p√°ginas
-->

<script>
    // ========== PARCHE: BOT√ìN CERRAR SESI√ìN EN HEADER ==========
    console.log('üö™ A√±adiendo bot√≥n de cerrar sesi√≥n al header...');
    
    // FUNCI√ìN para cerrar sesi√≥n con confirmaci√≥n simple
    window.logoutFromHeader = function() {
        const confirmLogout = confirm('¬øSeguro que quieres cerrar sesi√≥n?');
        
        if (confirmLogout) {
            console.log('üö™ Cerrando sesi√≥n desde header...');
            
            // Cerrar modal de perfil si est√° abierto
            if (userProfileState && userProfileState.showModal) {
                userProfileState.showModal = false;
                const modal = document.getElementById('user-profile-modal');
                if (modal) {
                    modal.remove();
                }
            }
            
            // Guardar datos antes del logout
            if (state.currentUser) {
                RealDataManager.saveFromGlobalData(state.currentUser.username);
            }
            
            // Limpiar estado
            RealDataManager.clearGlobalData();
            state.currentUser = null;
            showIntermediateScreen = false;
            state.currentTab = 'upload';
            newLoginState.currentView = 'login';
            
            render();
            showMessage('Sesi√≥n cerrada correctamente', 'success');
        }
    };
    
    // FUNCI√ìN para renderizar el header unificado CON bot√≥n de logout
    function renderUnifiedHeaderWithLogout() {
        return `
            <div class="unified-header">
                <!-- Logo/Marca "Priii" -->
                <div class="priii-logo" onclick="goToMainMenuUnified()" title="Ir al men√∫ principal">
                    Priii
                </div>
                
                <!-- Bot√≥n Men√∫ Central -->
                <div class="center-menu">
                    <button onclick="goToMainMenuUnified()" class="menu-button">
                        <span class="menu-icon">üè†</span>
                        <span class="menu-text">Men√∫</span>
                    </button>
                </div>
                
                <!-- Botones de la derecha CON logout -->
                <div class="right-buttons">
                    <button onclick="configureAPI()" class="header-btn api-btn" title="Configurar API de Anthropic">
                        <span class="btn-icon">üîë</span>
                        <span class="btn-text">API</span>
                        <span class="api-status ${state.apiKey ? 'active' : 'inactive'}"></span>
                    </button>
                    
                    <button onclick="toggleUserProfile()" class="header-btn profile-btn" title="Perfil de usuario">
                        <span class="btn-icon">üë§</span>
                        <span class="btn-text">${state.currentUser.name.split(' ')[0]}</span>
                    </button>
                    
                    <button onclick="logoutFromHeader()" class="header-btn logout-btn" title="Cerrar sesi√≥n">
                        <span class="btn-icon">üö™</span>
                        <span class="btn-text">Salir</span>
                    </button>
                </div>
            </div>
            
            <style>
                .unified-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 15px 25px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                    position: relative;
                    z-index: 1000;
                }
                
                /* Logo Priii */
                .priii-logo {
                    font-size: 2.5rem;
                    font-weight: 900;
                    background: linear-gradient(45deg, #fff, #f0f9ff);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                    background-clip: text;
                    text-shadow: 0 4px 8px rgba(0,0,0,0.3);
                    cursor: pointer;
                    transition: all 0.3s ease;
                    font-family: 'Comic Sans MS', cursive, sans-serif;
                    letter-spacing: -2px;
                    transform: rotate(-2deg);
                    user-select: none;
                }
                
                .priii-logo:hover {
                    transform: rotate(0deg) scale(1.05);
                    filter: drop-shadow(0 0 10px rgba(255,255,255,0.5));
                }
                
                /* Men√∫ Central */
                .center-menu {
                    position: absolute;
                    left: 50%;
                    transform: translateX(-50%);
                }
                
                .menu-button {
                    background: rgba(255,255,255,0.15);
                    border: 2px solid rgba(255,255,255,0.3);
                    border-radius: 25px;
                    color: white;
                    padding: 12px 24px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    transition: all 0.3s ease;
                    backdrop-filter: blur(10px);
                }
                
                .menu-button:hover {
                    background: rgba(255,255,255,0.25);
                    border-color: rgba(255,255,255,0.5);
                    transform: translateY(-2px);
                    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
                }
                
                .menu-icon {
                    font-size: 18px;
                }
                
                /* Botones de la derecha */
                .right-buttons {
                    display: flex;
                    gap: 8px;
                    align-items: center;
                }
                
                .header-btn {
                    background: rgba(255,255,255,0.1);
                    border: 1px solid rgba(255,255,255,0.2);
                    border-radius: 18px;
                    color: white;
                    padding: 9px 14px;
                    font-size: 13px;
                    font-weight: 500;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    transition: all 0.2s ease;
                    position: relative;
                }
                
            /* Estilos espec√≠ficos para el bot√≥n de logout */
.logout-btn {
    background: rgba(255, 255, 255, 0.1) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    color: #fff;
    transition: all 0.2s ease;
}

.logout-btn:hover {
    background: #4b5563 !important;   /* Gris s√≥lido */
    border: 1px solid #374151 !important;
    box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    transform: translateY(-2px);
}

                
                /* Indicador de estado API */
                .api-status {
                    position: absolute;
                    top: -2px;
                    right: -2px;
                    width: 8px;
                    height: 8px;
                    border-radius: 50%;
                    border: 2px solid white;
                }
                
                .api-status.active {
                    background: #22c55e;
                    box-shadow: 0 0 6px rgba(34, 197, 94, 0.8);
                }
                
                .api-status.inactive {
                    background: #ef4444;
                }
                
                /* Responsive */
                @media (max-width: 768px) {
                    .unified-header {
                        padding: 12px 15px;
                    }
                    
                    .priii-logo {
                        font-size: 2rem;
                    }
                    
                    .menu-button {
                        padding: 10px 16px;
                        font-size: 14px;
                    }
                    
                    .menu-text,
                    .btn-text {
                        display: none;
                    }
                    
                    .header-btn {
                        padding: 9px 11px;
                    }
                    
                    .right-buttons {
                        gap: 6px;
                    }
                }
                
                @media (max-width: 480px) {
                    .center-menu {
                        position: static;
                        transform: none;
                        order: -1;
                        margin-right: auto;
                        margin-left: 10px;
                    }
                    
                    .unified-header {
                        flex-wrap: wrap;
                        gap: 8px;
                    }
                    
                    .priii-logo {
                        font-size: 1.8rem;
                    }
                    
                    .menu-button {
                        padding: 8px 12px;
                        font-size: 13px;
                    }
                }
            </style>
        `;
    }
    
    // REEMPLAZAR la funci√≥n renderUnifiedHeader existente
    window.renderUnifiedHeader = renderUnifiedHeaderWithLogout;
    
    // INTERCEPTAR la funci√≥n render para usar el header con logout
    const originalRenderWithLogout = window.render;
    window.render = function() {
        const app = document.getElementById('app');
        
        if (!state.currentUser) {
            // Pantallas de login - usar funci√≥n original
            originalRenderWithLogout.call(this);
        } else {
            // Usuario logueado - usar header con logout
            
            let contentHTML = '';
            
            if (showIntermediateScreen) {
                // Pantalla intermedia (men√∫ principal)
                contentHTML = renderIntermediateScreen();
            } else {
                // Otras pantallas - renderizar contenido con navegaci√≥n interna cuando corresponda
                if (state.currentTab !== 'summary' && state.currentTab !== 'memory-cards') {
                    // Para secciones de tests (upload, questions, test, results) mantener navegaci√≥n
                    contentHTML = `
                        <div class="nav-tabs">
                            <button class="nav-tab ${state.currentTab === 'upload' ? 'active' : ''}" onclick="setTab('upload')">
                                üì§ Subir Test
                            </button>
                            <button class="nav-tab ${state.currentTab === 'questions' ? 'active' : ''}" onclick="setTab('questions')">
                                üìã Banco de Preguntas (${getFilteredQuestions().length})
                            </button>
                            <button class="nav-tab ${state.currentTab === 'test' ? 'active' : ''}" onclick="setTab('test')">
                                üéØ Test Aleatorio
                            </button>
                            <button class="nav-tab ${state.currentTab === 'results' ? 'active' : ''}" onclick="setTab('results')">
                                üìä Resultados (${state.testResults.length})
                            </button>
                        </div>
                        ${renderTabContent()}
                    `;
                } else {
                    // Para res√∫menes y tarjetas de memoria, solo el contenido
                    contentHTML = renderTabContent();
                }
            }
            
            app.innerHTML = `
                <div class="container" style="padding: 0; max-width: none; margin: 0; border-radius: 0; box-shadow: none; background: transparent;">
                    ${renderUnifiedHeaderWithLogout()}
                    
                    <div style="padding: 20px; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); min-height: calc(100vh - 80px);">
                        <div id="messages" style="max-width: 1400px; margin: 0 auto 20px auto;"></div>
                        <div style="max-width: 1400px; margin: 0 auto;">
                            ${contentHTML}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Renderizar modal de perfil si est√° activo
        if (typeof renderUserProfileModal === 'function') {
            renderUserProfileModal();
        }
    };
    
    console.log('‚úÖ Bot√≥n de cerrar sesi√≥n a√±adido al header');
    console.log('üö™ Caracter√≠sticas del bot√≥n logout:');
    console.log('   - Ubicado junto al bot√≥n de perfil');
    console.log('   - Confirmaci√≥n antes de cerrar sesi√≥n');
    console.log('   - Opci√≥n de eliminar credenciales recordadas');
    console.log('   - Estilo distintivo (rojo sutil)');
    console.log('   - Responsive para m√≥viles');
    console.log('   - Disponible en todas las p√°ginas');
    
    // Forzar re-renderizado inmediato
    setTimeout(() => {
        if (state.currentUser && typeof window.render === 'function') {
            render();
        }
    }, 100);
</script>
    <script>
// ========== PASO 1: CONFIGURACI√ìN FIREBASE MULTIJUGADOR ==========
console.log('üéÆ Configurando sistema multijugador...');

const firebaseConfig = {
  apiKey: "AIzaSyBzeTnm6iYR0b_gccYmenaR_NsOY9VmUz8",
  authDomain: "priii-572dd.firebaseapp.com",
  databaseURL: "https://priii-572dd-default-rtdb.firebaseio.com",
  projectId: "priii-572dd",
  storageBucket: "priii-572dd.firebasestorage.app",
  messagingSenderId: "858611366137",
  appId: "1:858611366137:web:9d84afde86f5b209e04a28"
};

let firebaseApp = null;
let database = null;
let multiplayerEnabled = false;

function initializeFirebase() {
    try {
        firebaseApp = firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        multiplayerEnabled = true;
        console.log('‚úÖ Firebase inicializado correctamente');
        return true;
    } catch (error) {
        console.error('‚ùå Error inicializando Firebase:', error);
        return false;
    }
}

let multiplayerState = {
    currentRoom: null,
    isHost: false,
    opponent: null,
    roomCode: null,
    gameState: 'waiting',
    myTurn: false,
    myFailures: 0,
    opponentFailures: 0
};

document.addEventListener('DOMContentLoaded', function() {
    initializeFirebase();
});

console.log('‚úÖ Paso 1 completado - Firebase configurado');
</script>
    <script>
// ========== PASO 2: INTERFAZ MULTIJUGADOR ==========
console.log('üéÆ Creando interfaz multijugador...');

// Funci√≥n para ir a multijugador desde el men√∫ principal
window.goToMultiplayer = function() {
    console.log('üéØ Cambiando a Multijugador...');
    showIntermediateScreen = false;
    state.currentTab = 'multiplayer';
    render();
};

// Extender renderTabContent para incluir multijugador
const originalRenderTabContentMultiplayer = renderTabContent;
renderTabContent = function() {
    switch(state.currentTab) {
        case 'upload':
            return renderUploadTab();
        case 'questions':
            return renderQuestionsTab();
        case 'test':
            return renderTestTab();
        case 'results':
            return renderResultsTab();
        case 'summary':
            return renderSummaryTab();
        case 'memory-cards':
            return renderMemoryCardsTab();
        case 'multiplayer':
            return renderMultiplayerTab();
        default:
            return '<div>Error: Pesta√±a no encontrada - ' + state.currentTab + '</div>';
    }
};

// Funci√≥n para renderizar la pesta√±a multijugador
function renderMultiplayerTab() {
    return `
        <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
            <div style="text-align: center; margin-bottom: 30px;">
                <h1 style="color: #1f2937; margin: 0; font-size: 2.2rem; display: flex; align-items: center; justify-content: center; gap: 15px;">
                    <span>‚öîÔ∏è</span> Duelo de Preguntas
                </h1>
                <p style="color: #6b7280; margin: 5px 0 0 0; font-size: 14px;">
                    Compite con otro usuario - El primero en fallar 3 preguntas pierde
                </p>
            </div>
            
            <div style="display: grid; gap: 20px; max-width: 600px; margin: 0 auto;">
                <button onclick="createMultiplayerRoom()" class="btn btn-primary" style="padding: 20px; font-size: 18px; border-radius: 12px;">
                    üè† Crear Sala
                </button>
                
                <button onclick="joinMultiplayerRoom()" class="btn btn-success" style="padding: 20px; font-size: 18px; border-radius: 12px;">
                    üö™ Unirse a Sala
                </button>
                
                <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                    <p style="color: #1e40af; margin: 0; font-size: 14px;">
                        <strong>Estado:</strong> ${multiplayerEnabled ? 'Conectado a Firebase' : 'Desconectado'}
                    </p>
                </div>
            </div>
        </div>
    `;
}

// Funciones b√°sicas (por ahora solo mostrar√°n mensajes)
function createMultiplayerRoom() {
    showMessage('Creando sala... (Pr√≥ximamente)', 'success');
    console.log('üè† Creando sala multijugador');
}

function joinMultiplayerRoom() {
    showMessage('Unirse a sala... (Pr√≥ximamente)', 'success');
    console.log('üö™ Uni√©ndose a sala multijugador');
}

console.log('‚úÖ Paso 2 completado - Interfaz multijugador creada');
</script>
<script>
// ========== PASO 1: GESTI√ìN DE SALAS MULTIJUGADOR ==========
console.log('üè† Implementando gesti√≥n de salas...');

// Funci√≥n para generar c√≥digo de sala √∫nico
function generateRoomCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = '';
    for (let i = 0; i < 6; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

// Funci√≥n para crear sala de multijugador
function createMultiplayerRoom() {
    if (!multiplayerEnabled) {
        showMessage('Error: Sistema multijugador no disponible', 'error');
        return;
    }

    if (!state.currentUser) {
        showMessage('Debes estar logueado para crear una sala', 'error');
        return;
    }

    // Verificar que el usuario tenga al menos 5 preguntas verificadas
    const verifiedQuestions = state.questions.filter(q => q.isVerified);
    if (verifiedQuestions.length < 5) {
        showMessage('Necesitas al menos 5 preguntas verificadas para crear una sala', 'error');
        return;
    }

    const roomCode = generateRoomCode();
    
    // Estructura de la sala en Firebase
    const roomData = {
        code: roomCode,
        host: {
            username: state.currentUser.username,
            name: state.currentUser.name,
            questions: verifiedQuestions.length,
            ready: false
        },
        guest: null,
        status: 'waiting', // waiting, ready, playing, finished
        gameData: {
            currentQuestion: 0,
            currentTurn: 'host', // host or guest
            hostFailures: 0,
            guestFailures: 0,
            questions: [],
            hostAnswers: {},
            guestAnswers: {},
            winner: null
        },
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        lastActivity: firebase.database.ServerValue.TIMESTAMP
    };

    // Crear sala en Firebase
    database.ref('rooms/' + roomCode).set(roomData)
        .then(() => {
            console.log('‚úÖ Sala creada:', roomCode);
            
            // Actualizar estado local
            multiplayerState.currentRoom = roomCode;
            multiplayerState.isHost = true;
            multiplayerState.roomCode = roomCode;
            multiplayerState.gameState = 'waiting';
            
            // Escuchar cambios en la sala
            listenToRoom(roomCode);
            
            // Mostrar interfaz de sala
            renderMultiplayerRoom();
            
            showMessage(`Sala creada con c√≥digo: ${roomCode}`, 'success');
        })
        .catch((error) => {
            console.error('‚ùå Error creando sala:', error);
            showMessage('Error al crear la sala. Int√©ntalo de nuevo.', 'error');
        });
}

// Funci√≥n para unirse a sala
function joinMultiplayerRoom() {
    if (!multiplayerEnabled) {
        showMessage('Error: Sistema multijugador no disponible', 'error');
        return;
    }

    if (!state.currentUser) {
        showMessage('Debes estar logueado para unirte a una sala', 'error');
        return;
    }

    // Verificar que el usuario tenga al menos 5 preguntas verificadas
    const verifiedQuestions = state.questions.filter(q => q.isVerified);
    if (verifiedQuestions.length < 5) {
        showMessage('Necesitas al menos 5 preguntas verificadas para unirte a una sala', 'error');
        return;
    }

    const roomCode = prompt('Ingresa el c√≥digo de la sala (6 caracteres):');
    if (!roomCode || roomCode.length !== 6) {
        showMessage('C√≥digo de sala inv√°lido', 'error');
        return;
    }

    const upperRoomCode = roomCode.toUpperCase();
    
    // Verificar que la sala existe y est√° disponible
    database.ref('rooms/' + upperRoomCode).once('value')
        .then((snapshot) => {
            if (!snapshot.exists()) {
                showMessage('La sala no existe', 'error');
                return;
            }

            const roomData = snapshot.val();
            
            if (roomData.status !== 'waiting') {
                showMessage('La sala no est√° disponible', 'error');
                return;
            }

            if (roomData.guest !== null) {
                showMessage('La sala est√° llena', 'error');
                return;
            }

            if (roomData.host.username === state.currentUser.username) {
                showMessage('No puedes unirte a tu propia sala', 'error');
                return;
            }

            // Unirse a la sala
            const guestData = {
                username: state.currentUser.username,
                name: state.currentUser.name,
                questions: verifiedQuestions.length,
                ready: false
            };

            return database.ref('rooms/' + upperRoomCode + '/guest').set(guestData);
        })
        .then(() => {
            console.log('‚úÖ Unido a sala:', upperRoomCode);
            
            // Actualizar estado local
            multiplayerState.currentRoom = upperRoomCode;
            multiplayerState.isHost = false;
            multiplayerState.roomCode = upperRoomCode;
            multiplayerState.gameState = 'waiting';
            
            // Escuchar cambios en la sala
            listenToRoom(upperRoomCode);
            
            // Mostrar interfaz de sala
            renderMultiplayerRoom();
            
            showMessage(`Te has unido a la sala: ${upperRoomCode}`, 'success');
        })
        .catch((error) => {
            console.error('‚ùå Error uni√©ndose a sala:', error);
            showMessage('Error al unirse a la sala', 'error');
        });
}

// Funci√≥n para escuchar cambios en la sala
function listenToRoom(roomCode) {
    const roomRef = database.ref('rooms/' + roomCode);
    
    roomRef.on('value', (snapshot) => {
        if (!snapshot.exists()) {
            console.log('‚ùå La sala fue eliminada');
            showMessage('La sala ha sido cerrada', 'error');
            leaveRoom();
            return;
        }

        const roomData = snapshot.val();
        console.log('üì° Actualizaci√≥n de sala:', roomData);
        
        // Actualizar estado local
        updateLocalStateFromRoom(roomData);
        
        // Re-renderizar interfaz
        renderMultiplayerRoom();
    });
}

// Funci√≥n para actualizar estado local desde datos de Firebase
function updateLocalStateFromRoom(roomData) {
    multiplayerState.gameState = roomData.status;
    
    if (multiplayerState.isHost) {
        multiplayerState.opponent = roomData.guest;
    } else {
        multiplayerState.opponent = roomData.host;
    }
    
    // Actualizar datos del juego si existen
    if (roomData.gameData) {
        multiplayerState.myFailures = multiplayerState.isHost ? 
            roomData.gameData.hostFailures : roomData.gameData.guestFailures;
        multiplayerState.opponentFailures = multiplayerState.isHost ? 
            roomData.gameData.guestFailures : roomData.gameData.hostFailures;
        multiplayerState.myTurn = (roomData.gameData.currentTurn === 'host') === multiplayerState.isHost;
    }
}

// Funci√≥n para salir de la sala
function leaveRoom() {
    if (multiplayerState.currentRoom && database) {
        // Si eres el host, eliminar la sala
        if (multiplayerState.isHost) {
            database.ref('rooms/' + multiplayerState.currentRoom).remove();
        } else {
            // Si eres invitado, solo remover tu presencia
            database.ref('rooms/' + multiplayerState.currentRoom + '/guest').remove();
        }
        
        // Dejar de escuchar cambios
        database.ref('rooms/' + multiplayerState.currentRoom).off();
    }
    
    // Resetear estado
    multiplayerState = {
        currentRoom: null,
        isHost: false,
        opponent: null,
        roomCode: null,
        gameState: 'waiting',
        myTurn: false,
        myFailures: 0,
        opponentFailures: 0
    };
    
    // Volver a la pantalla principal de multijugador
    render();
}

// Funci√≥n para renderizar la interfaz de sala
function renderMultiplayerRoom() {
    // Esta funci√≥n actualizar√° el contenido para mostrar la sala
    // Por ahora, forzamos un re-render
    render();
}

console.log('‚úÖ Paso 1 completado - Gesti√≥n de salas implementada');
</script>
    <script>
// Actualizar funci√≥n renderMultiplayerTab para mostrar salas
function renderMultiplayerTab() {
    // Si estamos en una sala, mostrar interfaz de sala
    if (multiplayerState.currentRoom) {
        return renderRoomInterface();
    }
    
    // Interfaz principal de multijugador
    const verifiedQuestions = state.questions.filter(q => q.isVerified);
    const hasEnoughQuestions = verifiedQuestions.length >= 5;
    
    return `
        <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
            <div style="text-align: center; margin-bottom: 30px;">
                <h1 style="color: #1f2937; margin: 0; font-size: 2.2rem; display: flex; align-items: center; justify-content: center; gap: 15px;">
                    <span>‚öîÔ∏è</span> Duelo de Preguntas
                </h1>
                <p style="color: #6b7280; margin: 5px 0 0 0; font-size: 14px;">
                    Compite con otro usuario - El primero en fallar 3 preguntas pierde
                </p>
            </div>
            
            ${!hasEnoughQuestions ? `
                <div style="background: #fee2e2; border: 2px solid #ef4444; border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
                    <h3 style="color: #dc2626; margin: 0 0 10px 0;">‚ùå Preguntas Insuficientes</h3>
                    <p style="color: #991b1b; margin: 0; font-size: 14px;">
                        Necesitas al menos <strong>5 preguntas verificadas (‚≠ê)</strong> para jugar multijugador.
                        <br>Actualmente tienes: <strong>${verifiedQuestions.length}</strong>
                    </p>
                </div>
            ` : ''}
            
            <div style="display: grid; gap: 20px; max-width: 600px; margin: 0 auto;">
                <button onclick="createMultiplayerRoom()" class="btn btn-primary" style="padding: 20px; font-size: 18px; border-radius: 12px;" ${!hasEnoughQuestions ? 'disabled' : ''}>
                    üè† Crear Sala
                </button>
                
                <button onclick="joinMultiplayerRoom()" class="btn btn-success" style="padding: 20px; font-size: 18px; border-radius: 12px;" ${!hasEnoughQuestions ? 'disabled' : ''}>
                    üö™ Unirse a Sala
                </button>
                
                <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                    <p style="color: #1e40af; margin: 0 0 10px 0; font-size: 14px;">
                        <strong>Estado:</strong> ${multiplayerEnabled ? '‚úÖ Conectado' : '‚ùå Desconectado'}
                    </p>
                    <p style="color: #6b7280; margin: 0; font-size: 12px;">
                        Preguntas verificadas: ${verifiedQuestions.length}
                    </p>
                </div>
            </div>
        </div>
    `;
}

// Nueva funci√≥n para renderizar la interfaz de sala
function renderRoomInterface() {
    const roomCode = multiplayerState.roomCode;
    const isHost = multiplayerState.isHost;
    const opponent = multiplayerState.opponent;
    const gameState = multiplayerState.gameState;
    
    return `
        <div style="max-width: 700px; margin: 0 auto; padding: 20px;">
            
            <!-- Header de la sala -->
            <div style="text-align: center; margin-bottom: 30px; background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; padding: 25px; border-radius: 16px;">
                <h2 style="margin: 0 0 10px 0; font-size: 1.8rem;">Sala de Duelo</h2>
                <div style="font-size: 2rem; font-weight: bold; letter-spacing: 3px; margin: 10px 0;">
                    ${roomCode}
                </div>
                <p style="margin: 0; opacity: 0.9; font-size: 14px;">
                    Comparte este c√≥digo con tu oponente
                </p>
            </div>
            
            <!-- Informaci√≥n de jugadores -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                
                <!-- Jugador 1 (Host) -->
                <div style="background: ${isHost ? '#f0fdf4' : '#f8fafc'}; border: 2px solid ${isHost ? '#22c55e' : '#e2e8f0'}; border-radius: 12px; padding: 20px; text-align: center;">
                    <div style="font-size: 1.5rem; margin-bottom: 10px;">${isHost ? 'üëë' : 'üë§'}</div>
                    <h3 style="margin: 0 0 5px 0; color: #1f2937;">${state.currentUser.name}</h3>
                    <p style="margin: 0; font-size: 12px; color: #6b7280;">
                        ${isHost ? 'Anfitri√≥n' : 'Invitado'} (T√∫)
                    </p>
                </div>
                
                <!-- Jugador 2 (Guest/Waiting) -->
                <div style="background: ${!isHost && opponent ? '#f0fdf4' : '#f9fafb'}; border: 2px solid ${!isHost && opponent ? '#22c55e' : '#d1d5db'}; border-radius: 12px; padding: 20px; text-align: center;">
                    <div style="font-size: 1.5rem; margin-bottom: 10px;">
                        ${opponent ? (!isHost ? 'üëë' : 'üë§') : '‚è≥'}
                    </div>
                    <h3 style="margin: 0 0 5px 0; color: #1f2937;">
                        ${opponent ? opponent.name : 'Esperando...'}
                    </h3>
                    <p style="margin: 0; font-size: 12px; color: #6b7280;">
                        ${opponent ? (!isHost ? 'Anfitri√≥n' : 'Invitado') : 'Waiting for player'}
                    </p>
                </div>
            </div>
            
            <!-- Estado del juego -->
            <div style="text-align: center; margin-bottom: 30px;">
                ${gameState === 'waiting' ? `
                    <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; padding: 20px;">
                        <h3 style="color: #92400e; margin: 0 0 10px 0;">
                            ${opponent ? '‚è≥ Esperando que ambos est√©n listos' : 'üë• Esperando oponente'}
                        </h3>
                        <p style="color: #78350f; margin: 0; font-size: 14px;">
                            ${opponent ? 'Presiona "Listo" cuando quieras empezar' : 'Comparte el c√≥digo de sala con tu oponente'}
                        </p>
                    </div>
                ` : ''}
            </div>
            
            <!-- Botones de acci√≥n -->
            <div style="display: flex; gap: 15px; justify-content: center;">
                ${opponent && gameState === 'waiting' ? `
                    <button onclick="markAsReady()" class="btn btn-success" style="padding: 15px 25px; font-size: 16px;">
                        ‚úÖ Estoy Listo
                    </button>
                ` : ''}
                
                <button onclick="leaveRoom()" class="btn btn-danger" style="padding: 15px 25px; font-size: 16px;">
                    üö™ Salir de la Sala
                </button>
            </div>
        </div>
    `;
}

// Funci√≥n placeholder para marcar como listo (implementaremos en el siguiente paso)
function markAsReady() {
    showMessage('Funci√≥n "Listo" ser√° implementada en el siguiente paso', 'success');
}
</script>
    <!-- 
PASO 1 INTEGRADO: SISTEMA DE ESTADOS "LISTO" MULTIJUGADOR
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
Este paso integra con el c√≥digo existente para implementar estados ready
-->

<script>
    // ========== PASO 1 INTEGRADO: SISTEMA DE ESTADOS "LISTO" ==========
    console.log('üéÆ PASO 1 INTEGRADO: Implementando sistema de estados "Listo"...');

    // REEMPLAZAR la funci√≥n createMultiplayerRoom existente
    window.createMultiplayerRoom = function() {
        if (!multiplayerEnabled) {
            showMessage('Error: Sistema multijugador no disponible', 'error');
            return;
        }

        if (!state.currentUser) {
            showMessage('Debes estar logueado para crear una sala', 'error');
            return;
        }

        // Verificar que el usuario tenga al menos 5 preguntas verificadas
        const verifiedQuestions = state.questions.filter(q => q.isVerified);
        if (verifiedQuestions.length < 5) {
            showMessage('Necesitas al menos 5 preguntas verificadas para crear una sala', 'error');
            return;
        }

        const roomCode = generateRoomCode();
        
        // ESTRUCTURA ACTUALIZADA con campos ready espec√≠ficos
        const roomData = {
            code: roomCode,
            host: {
                username: state.currentUser.username,
                name: state.currentUser.name,
                questions: verifiedQuestions.length,
                ready: false
            },
            guest: null,
            hostReady: false,    // Campo espec√≠fico para control de estado
            guestReady: false,   // Campo espec√≠fico para control de estado
            status: 'waiting', // waiting, ready, playing, finished
            gameData: {
                currentQuestion: 0,
                currentTurn: 'host',
                hostFailures: 0,
                guestFailures: 0,
                questions: [],
                hostAnswers: {},
                guestAnswers: {},
                winner: null
            },
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            lastActivity: firebase.database.ServerValue.TIMESTAMP
        };

        // Crear sala en Firebase
        database.ref('rooms/' + roomCode).set(roomData)
            .then(() => {
                console.log('‚úÖ Sala creada con estados ready:', roomCode);
                
                // Actualizar estado local
                multiplayerState.currentRoom = roomCode;
                multiplayerState.isHost = true;
                multiplayerState.roomCode = roomCode;
                multiplayerState.gameState = 'waiting';
                
                // Escuchar cambios en la sala
                listenToRoom(roomCode);
                
                // Re-renderizar
                render();
                
                showMessage(`Sala creada con c√≥digo: ${roomCode}`, 'success');
            })
            .catch((error) => {
                console.error('‚ùå Error creando sala:', error);
                showMessage('Error al crear la sala. Int√©ntalo de nuevo.', 'error');
            });
    };

    // IMPLEMENTAR la funci√≥n markAsReady que estaba como placeholder
    window.markAsReady = function() {
        if (!multiplayerState.currentRoom || !database) {
            showMessage('Error: No hay conexi√≥n con la sala', 'error');
            return;
        }

        console.log('üéØ Marcando como listo...', {
            room: multiplayerState.currentRoom,
            isHost: multiplayerState.isHost,
            user: state.currentUser.username
        });

        const readyField = multiplayerState.isHost ? 'hostReady' : 'guestReady';
        const playerField = multiplayerState.isHost ? 'host/ready' : 'guest/ready';
        
        // Actualizar tanto el campo espec√≠fico como el del jugador
        const updates = {};
        updates[readyField] = true;
        updates[playerField] = true;
        updates['lastActivity'] = firebase.database.ServerValue.TIMESTAMP;

        database.ref('rooms/' + multiplayerState.currentRoom).update(updates)
            .then(() => {
                console.log('‚úÖ Marcado como listo correctamente');
                showMessage('Marcado como listo - esperando al oponente...', 'success');
            })
            .catch((error) => {
                console.error('‚ùå Error marcando como listo:', error);
                showMessage('Error al marcar como listo', 'error');
            });
    };

    // FUNCI√ìN para verificar si ambos jugadores est√°n listos
    function checkBothReady(roomData) {
        const hostReady = roomData.hostReady || false;
        const guestReady = roomData.guestReady || false;
        
        console.log('üîç Verificando estados ready:', {
            hostReady,
            guestReady,
            currentStatus: roomData.status
        });

        // Si ambos est√°n listos y el estado es 'waiting', cambiar a 'ready'
        if (hostReady && guestReady && roomData.status === 'waiting') {
            console.log('üöÄ ¬°Ambos jugadores listos! Iniciando transici√≥n...');
            
            // Actualizar estado en Firebase
            database.ref('rooms/' + multiplayerState.currentRoom).update({
                status: 'ready',
                lastActivity: firebase.database.ServerValue.TIMESTAMP
            });
            
            return true;
        }
        
        return false;
    }

    // FUNCI√ìN para iniciar el juego
    function startGame() {
        if (!multiplayerState.currentRoom || !database) return;
        
        console.log('üéÆ Iniciando juego...');
        
        // Cambiar estado a 'playing'
        database.ref('rooms/' + multiplayerState.currentRoom).update({
            status: 'playing',
            'gameData/currentTurn': 'host', // El anfitri√≥n empieza
            lastActivity: firebase.database.ServerValue.TIMESTAMP
        });
        
        showMessage('¬°El duelo ha comenzado! El anfitri√≥n inicia seleccionando una pregunta.', 'success');
    }

    // REEMPLAZAR funci√≥n updateLocalStateFromRoom para manejar transiciones
    const originalUpdateLocalStateFromRoom = updateLocalStateFromRoom;
    updateLocalStateFromRoom = function(roomData) {
        const previousState = multiplayerState.gameState;
        
        // Llamar funci√≥n original
        originalUpdateLocalStateFromRoom(roomData);
        
        // Guardar datos completos para acceso en render
        multiplayerState.currentRoomData = roomData;
        
        // Verificar transiciones de estado
        if (previousState === 'waiting' && roomData.status === 'waiting') {
            // Verificar si ambos est√°n listos
            checkBothReady(roomData);
        } else if (previousState === 'waiting' && roomData.status === 'ready') {
            console.log('üéØ Estado cambi√≥ a READY - preparando inicio del juego...');
            
            // Mostrar mensaje y auto-iniciar despu√©s de 3 segundos
            showMessage('¬°Ambos jugadores listos! Iniciando duelo en 3 segundos...', 'success');
            
            setTimeout(() => {
                if (multiplayerState.isHost && multiplayerState.gameState === 'ready') {
                    startGame();
                }
            }, 3000);
            
        } else if (previousState !== 'playing' && roomData.status === 'playing') {
            console.log('üöÄ ¬°JUEGO INICIADO!');
            showMessage('¬°El duelo ha comenzado!', 'success');
        }
    };

    // REEMPLAZAR funci√≥n renderRoomInterface para mostrar estados ready
    function renderRoomInterface() {
        const roomCode = multiplayerState.roomCode;
        const isHost = multiplayerState.isHost;
        const opponent = multiplayerState.opponent;
        const gameState = multiplayerState.gameState;
        
        // Obtener estados ready desde los datos de la sala
        const roomData = multiplayerState.currentRoomData || {};
        const myReady = isHost ? (roomData.hostReady || false) : (roomData.guestReady || false);
        const opponentReady = !isHost ? (roomData.hostReady || false) : (roomData.guestReady || false);
        
        return `
            <div style="max-width: 700px; margin: 0 auto; padding: 20px;">
                
                <!-- Header de la sala -->
                <div style="text-align: center; margin-bottom: 30px; background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; padding: 25px; border-radius: 16px;">
                    <h2 style="margin: 0 0 10px 0; font-size: 1.8rem;">‚öîÔ∏è Duelo de Preguntas</h2>
                    <div style="font-size: 2rem; font-weight: bold; letter-spacing: 3px; margin: 10px 0;">
                        ${roomCode}
                    </div>
                    <p style="margin: 0; opacity: 0.9; font-size: 14px;">
                        ${gameState === 'waiting' ? 'Preparando duelo...' : 
                          gameState === 'ready' ? '¬°Iniciando en breve!' : 
                          gameState === 'playing' ? '¬°Duelo en curso!' : 'Comparte este c√≥digo'}
                    </p>
                </div>
                
                <!-- Informaci√≥n de jugadores CON ESTADOS READY -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    
                    <!-- Jugador Anfitri√≥n -->
                    <div style="background: ${isHost ? '#f0fdf4' : '#f8fafc'}; border: 2px solid ${isHost ? '#22c55e' : '#e2e8f0'}; border-radius: 12px; padding: 20px; text-align: center; position: relative;">
                        
                        <!-- Indicador de estado ready -->
                        <div style="position: absolute; top: 10px; right: 10px; width: 16px; height: 16px; border-radius: 50%; background: ${(isHost ? myReady : opponentReady) ? '#22c55e' : '#ef4444'}; border: 2px solid white; box-shadow: 0 0 0 2px ${(isHost ? myReady : opponentReady) ? '#22c55e40' : '#ef444440'};"></div>
                        
                        <div style="font-size: 1.5rem; margin-bottom: 10px;">üëë</div>
                        <h3 style="margin: 0 0 5px 0; color: #1f2937;">${isHost ? state.currentUser.name : (opponent?.name || 'Anfitri√≥n')}</h3>
                        <p style="margin: 0; font-size: 12px; color: #6b7280;">
                            Anfitri√≥n ${isHost ? '(T√∫)' : ''}
                        </p>
                        <div style="margin-top: 8px; font-size: 11px; font-weight: 600; color: ${(isHost ? myReady : opponentReady) ? '#16a34a' : '#dc2626'};">
                            ${(isHost ? myReady : opponentReady) ? '‚úÖ LISTO' : '‚è≥ ESPERANDO'}
                        </div>
                    </div>
                    
                    <!-- Jugador Invitado -->
                    <div style="background: ${!isHost && opponent ? '#f0fdf4' : '#f9fafb'}; border: 2px solid ${!isHost && opponent ? '#22c55e' : '#d1d5db'}; border-radius: 12px; padding: 20px; text-align: center; position: relative;">
                        
                        <!-- Indicador de estado ready -->
                        ${opponent ? `
                            <div style="position: absolute; top: 10px; right: 10px; width: 16px; height: 16px; border-radius: 50%; background: ${(!isHost ? myReady : opponentReady) ? '#22c55e' : '#ef4444'}; border: 2px solid white; box-shadow: 0 0 0 2px ${(!isHost ? myReady : opponentReady) ? '#22c55e40' : '#ef444440'};"></div>
                        ` : ''}
                        
                        <div style="font-size: 1.5rem; margin-bottom: 10px;">
                            ${opponent ? 'üë§' : '‚è≥'}
                        </div>
                        <h3 style="margin: 0 0 5px 0; color: #1f2937;">
                            ${opponent ? (isHost ? opponent.name : state.currentUser.name) : 'Esperando...'}
                        </h3>
                        <p style="margin: 0; font-size: 12px; color: #6b7280;">
                            ${opponent ? `Invitado ${!isHost ? '(T√∫)' : ''}` : 'Esperando jugador'}
                        </p>
                        ${opponent ? `
                            <div style="margin-top: 8px; font-size: 11px; font-weight: 600; color: ${(!isHost ? myReady : opponentReady) ? '#16a34a' : '#dc2626'};">
                                ${(!isHost ? myReady : opponentReady) ? '‚úÖ LISTO' : '‚è≥ ESPERANDO'}
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- Estado del juego ACTUALIZADO -->
                <div style="text-align: center; margin-bottom: 30px;">
                    ${gameState === 'waiting' ? `
                        <div style="background: ${opponent ? '#fef3c7' : '#e0f2fe'}; border: 2px solid ${opponent ? '#f59e0b' : '#0ea5e9'}; border-radius: 12px; padding: 20px;">
                            <h3 style="color: ${opponent ? '#92400e' : '#0c4a6e'}; margin: 0 0 10px 0;">
                                ${opponent ? 
                                    (myReady && opponentReady ? 'üöÄ ¬°Iniciando duelo!' : 
                                     myReady ? '‚è≥ Esperando que tu oponente est√© listo' : 
                                     opponentReady ? '‚ö° Tu oponente est√° listo - ¬øEst√°s preparado?' : 
                                     'üìã Presiona "Estoy Listo" cuando quieras empezar') : 
                                    'üë• Esperando oponente'
                                }
                            </h3>
                            <p style="color: ${opponent ? '#78350f' : '#0369a1'}; margin: 0; font-size: 14px;">
                                ${opponent ? 
                                    (myReady && opponentReady ? 'El duelo comenzar√° en unos segundos...' :
                                     'Ambos jugadores deben estar listos para iniciar') : 
                                    'Comparte el c√≥digo de sala con tu oponente'
                                }
                            </p>
                        </div>
                    ` : gameState === 'ready' ? `
                        <div style="background: #f0fdf4; border: 2px solid #22c55e; border-radius: 12px; padding: 20px;">
                            <h3 style="color: #166534; margin: 0 0 10px 0;">üéØ ¬°Duelo Preparado!</h3>
                            <p style="color: #15803d; margin: 0; font-size: 14px;">Iniciando autom√°ticamente...</p>
                        </div>
                    ` : gameState === 'playing' ? `
                        <div style="background: #fef2f2; border: 2px solid #ef4444; border-radius: 12px; padding: 20px;">
                            <h3 style="color: #dc2626; margin: 0 0 10px 0;">‚öîÔ∏è ¬°DUELO EN CURSO!</h3>
                            <p style="color: #991b1b; margin: 0; font-size: 14px;">La interfaz de juego se cargar√° pr√≥ximamente...</p>
                        </div>
                    ` : ''}
                </div>
                
                <!-- Botones de acci√≥n ACTUALIZADOS -->
                <div style="display: flex; gap: 15px; justify-content: center;">
                    ${opponent && gameState === 'waiting' && !myReady ? `
                        <button onclick="markAsReady()" class="btn btn-success" style="padding: 15px 25px; font-size: 16px;">
                            ‚úÖ Estoy Listo
                        </button>
                    ` : opponent && gameState === 'waiting' && myReady ? `
                        <button disabled class="btn btn-secondary" style="padding: 15px 25px; font-size: 16px; opacity: 0.6;">
                            ‚úÖ Listo - Esperando...
                        </button>
                    ` : ''}
                    
                    <button onclick="leaveRoom()" class="btn btn-danger" style="padding: 15px 25px; font-size: 16px;">
                        üö™ Salir de la Sala
                    </button>
                </div>
            </div>
        `;
    }

    console.log('‚úÖ PASO 1 INTEGRADO completado - Sistema de estados "Listo" funcional');
    console.log('üéÆ Integraci√≥n realizada con c√≥digo existente:');
    console.log('   - Reemplazada createMultiplayerRoom con soporte ready states');
    console.log('   - Implementada markAsReady funcional');
    console.log('   - Actualizada updateLocalStateFromRoom con transiciones');
    console.log('   - Mejorada renderRoomInterface con indicadores visuales');
    console.log('   - Detecci√≥n autom√°tica de ambos listos y auto-inicio');
</script>
   <!-- 
PASO 2 CORREGIDO: SINCRONIZACI√ìN DE BANCOS DE PREGUNTAS
REEMPLAZAR el c√≥digo del PASO 2 anterior con este c√≥digo corregido
-->

<script>
    // ========== PASO 2 CORREGIDO: SINCRONIZACI√ìN DE BANCOS DE PREGUNTAS ==========
    console.log('üéÆ PASO 2 CORREGIDO: Implementando sincronizaci√≥n con IDs v√°lidos...');

    // FUNCI√ìN para limpiar IDs para Firebase (quitar caracteres prohibidos)
    function cleanFirebaseKey(key) {
        if (!key) return 'invalid-key';
        return key.toString().replace(/[.#$\/\[\]]/g, '_');
    }

    // FUNCI√ìN AUXILIAR: Organizar preguntas por temas para Firebase (CORREGIDA)
    function organizeQuestionsForFirebase(questions, topics) {
        const organized = {};
        
        // Crear estructura por temas existentes
        topics.forEach(topic => {
            const topicQuestions = questions.filter(q => q.topicId === topic.id);
            if (topicQuestions.length > 0) {
                const cleanTopicId = cleanFirebaseKey(topic.id);
                organized[cleanTopicId] = {
                    id: topic.id, // ID original para referencia
                    name: topic.name,
                    questions: topicQuestions.map(q => ({
                        id: q.id, // ID original
                        firebaseKey: cleanFirebaseKey(q.id), // ID limpio para Firebase
                        question: q.question,
                        options: q.options,
                        correctAnswer: q.correctAnswer,
                        topicId: q.topicId
                    }))
                };
            }
        });
        
        // Preguntas sin tema asignado
        const questionsWithoutTopic = questions.filter(q => !q.topicId);
        if (questionsWithoutTopic.length > 0) {
            organized['no-topic'] = {
                id: 'no-topic',
                name: 'Sin tema asignado',
                questions: questionsWithoutTopic.map(q => ({
                    id: q.id,
                    firebaseKey: cleanFirebaseKey(q.id),
                    question: q.question,
                    options: q.options,
                    correctAnswer: q.correctAnswer,
                    topicId: null
                }))
            };
        }
        
        return organized;
    }

    // REEMPLAZAR funci√≥n createMultiplayerRoom CORREGIDA
    window.createMultiplayerRoom = function() {
        if (!multiplayerEnabled) {
            showMessage('Error: Sistema multijugador no disponible', 'error');
            return;
        }

        if (!state.currentUser) {
            showMessage('Debes estar logueado para crear una sala', 'error');
            return;
        }

        const verifiedQuestions = state.questions.filter(q => q.isVerified);
        if (verifiedQuestions.length < 5) {
            showMessage('Necesitas al menos 5 preguntas verificadas para crear una sala', 'error');
            return;
        }

        const roomCode = generateRoomCode();
        
        // Organizar preguntas del anfitri√≥n por temas (con IDs limpios)
        const hostQuestionBank = organizeQuestionsForFirebase(verifiedQuestions, state.topics);
        
        console.log('üìö Banco del anfitri√≥n organizado (IDs limpios):', hostQuestionBank);
        
        const roomData = {
            code: roomCode,
            host: {
                username: state.currentUser.username,
                name: state.currentUser.name,
                questions: verifiedQuestions.length,
                ready: false
            },
            guest: null,
            hostReady: false,
            guestReady: false,
            status: 'waiting',
            questionBanks: {
                host: hostQuestionBank,
                guest: null
            },
            gameData: {
                currentQuestion: 0,
                currentTurn: 'host',
                hostFailures: 0,
                guestFailures: 0,
                currentQuestionData: null,
                hostAnswers: {},
                guestAnswers: {},
                winner: null
            },
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            lastActivity: firebase.database.ServerValue.TIMESTAMP
        };

        database.ref('rooms/' + roomCode).set(roomData)
            .then(() => {
                console.log('‚úÖ Sala creada correctamente con IDs v√°lidos:', roomCode);
                
                multiplayerState.currentRoom = roomCode;
                multiplayerState.isHost = true;
                multiplayerState.roomCode = roomCode;
                multiplayerState.gameState = 'waiting';
                
                listenToRoom(roomCode);
                render();
                
                showMessage(`Sala creada con c√≥digo: ${roomCode}`, 'success');
            })
            .catch((error) => {
                console.error('‚ùå Error creando sala:', error);
                showMessage('Error al crear la sala: ' + error.message, 'error');
            });
    };

    // REEMPLAZAR funci√≥n joinMultiplayerRoom CORREGIDA
    window.joinMultiplayerRoom = function() {
        if (!multiplayerEnabled) {
            showMessage('Error: Sistema multijugador no disponible', 'error');
            return;
        }

        if (!state.currentUser) {
            showMessage('Debes estar logueado para unirte a una sala', 'error');
            return;
        }

        const verifiedQuestions = state.questions.filter(q => q.isVerified);
        if (verifiedQuestions.length < 5) {
            showMessage('Necesitas al menos 5 preguntas verificadas para unirte a una sala', 'error');
            return;
        }

        const roomCode = prompt('Ingresa el c√≥digo de la sala (6 caracteres):');
        if (!roomCode || roomCode.length !== 6) {
            showMessage('C√≥digo de sala inv√°lido', 'error');
            return;
        }

        const upperRoomCode = roomCode.toUpperCase();
        
        // Organizar preguntas del invitado por temas (con IDs limpios)
        const guestQuestionBank = organizeQuestionsForFirebase(verifiedQuestions, state.topics);
        
        console.log('üìö Banco del invitado organizado (IDs limpios):', guestQuestionBank);
        
        database.ref('rooms/' + upperRoomCode).once('value')
            .then((snapshot) => {
                if (!snapshot.exists()) {
                    showMessage('La sala no existe', 'error');
                    return;
                }

                const roomData = snapshot.val();
                
                if (roomData.status !== 'waiting') {
                    showMessage('La sala no est√° disponible', 'error');
                    return;
                }

                if (roomData.guest !== null) {
                    showMessage('La sala est√° llena', 'error');
                    return;
                }

                if (roomData.host.username === state.currentUser.username) {
                    showMessage('No puedes unirte a tu propia sala', 'error');
                    return;
                }

                const guestData = {
                    username: state.currentUser.username,
                    name: state.currentUser.name,
                    questions: verifiedQuestions.length,
                    ready: false
                };

                const updates = {
                    guest: guestData,
                    'questionBanks/guest': guestQuestionBank,
                    lastActivity: firebase.database.ServerValue.TIMESTAMP
                };

                return database.ref('rooms/' + upperRoomCode).update(updates);
            })
            .then(() => {
                console.log('‚úÖ Unido a sala correctamente con IDs v√°lidos:', upperRoomCode);
                
                multiplayerState.currentRoom = upperRoomCode;
                multiplayerState.isHost = false;
                multiplayerState.roomCode = upperRoomCode;
                multiplayerState.gameState = 'waiting';
                
                listenToRoom(upperRoomCode);
                render();
                
                showMessage(`Te has unido a la sala: ${upperRoomCode}`, 'success');
            })
            .catch((error) => {
                console.error('‚ùå Error uni√©ndose a sala:', error);
                showMessage('Error al unirse a la sala: ' + error.message, 'error');
            });
    };

    // EXTENDER updateLocalStateFromRoom para manejar bancos de preguntas
    const originalUpdateLocalStateFromRoomStep2 = updateLocalStateFromRoom;
    updateLocalStateFromRoom = function(roomData) {
        originalUpdateLocalStateFromRoomStep2(roomData);
        
        if (roomData.questionBanks) {
            multiplayerState.hostQuestionBank = roomData.questionBanks.host || {};
            multiplayerState.guestQuestionBank = roomData.questionBanks.guest || {};
            
            console.log('üìö Bancos de preguntas sincronizados correctamente:', {
                hostTopics: Object.keys(multiplayerState.hostQuestionBank).length,
                guestTopics: Object.keys(multiplayerState.guestQuestionBank).length
            });
        }
    };

    // FUNCI√ìN para obtener banco de preguntas del oponente
    function getOpponentQuestionBank() {
        if (multiplayerState.isHost) {
            return multiplayerState.guestQuestionBank || {};
        } else {
            return multiplayerState.hostQuestionBank || {};
        }
    }

    // FUNCI√ìN para obtener mi banco de preguntas  
    function getMyQuestionBank() {
        if (multiplayerState.isHost) {
            return multiplayerState.hostQuestionBank || {};
        } else {
            return multiplayerState.guestQuestionBank || {};
        }
    }

    // FUNCI√ìN para seleccionar pregunta del oponente (PREPARADA)
    function selectQuestionFromOpponent(topicKey, questionFirebaseKey) {
        const opponentBank = getOpponentQuestionBank();
        
        if (!opponentBank[topicKey] || !opponentBank[topicKey].questions) {
            console.error('‚ùå Tema no encontrado:', topicKey);
            showMessage('Error: Tema no encontrado', 'error');
            return;
        }
        
        const question = opponentBank[topicKey].questions.find(q => q.firebaseKey === questionFirebaseKey);
        
        if (!question) {
            console.error('‚ùå Pregunta no encontrada:', questionFirebaseKey);
            showMessage('Error: Pregunta no encontrada', 'error');
            return;
        }
        
        console.log('üéØ Enviando pregunta al oponente:', question);
        
        database.ref('rooms/' + multiplayerState.currentRoom).update({
            'gameData/currentQuestionData': question,
            'gameData/currentTurn': multiplayerState.isHost ? 'guest' : 'host',
            lastActivity: firebase.database.ServerValue.TIMESTAMP
        });
        
        showMessage('Pregunta enviada al oponente', 'success');
    }

    // FUNCI√ìN de prueba mejorada
    window.debugQuestionBanks = function() {
        console.log('üîç DEBUG - Bancos de preguntas (IDs corregidos):');
        console.log('Mi banco:', getMyQuestionBank());
        console.log('Banco del oponente:', getOpponentQuestionBank());
        
        // Mostrar estad√≠sticas
        const myBank = getMyQuestionBank();
        const opponentBank = getOpponentQuestionBank();
        
        console.log('üìä Estad√≠sticas:');
        console.log(`- Mis temas: ${Object.keys(myBank).length}`);
        console.log(`- Temas del oponente: ${Object.keys(opponentBank).length}`);
        
        Object.keys(opponentBank).forEach(topicKey => {
            const topic = opponentBank[topicKey];
            console.log(`- ${topic.name}: ${topic.questions.length} preguntas`);
        });
    };

    // ACTUALIZAR renderRoomInterface con mensaje mejorado
    const originalRenderRoomInterface = renderRoomInterface;
    renderRoomInterface = function() {
        const originalHTML = originalRenderRoomInterface();
        
        if (multiplayerState.gameState === 'playing') {
            const opponentBank = getOpponentQuestionBank();
            const opponentTopicsCount = Object.keys(opponentBank).length;
            
            const updatedHTML = originalHTML.replace(
                'La interfaz de juego se cargar√° pr√≥ximamente...',
                `‚úÖ Bancos sincronizados correctamente.<br>
                Tienes acceso a ${opponentTopicsCount} tema${opponentTopicsCount === 1 ? '' : 's'} del oponente.<br>
                <small style="color: #059669;">Usa debugQuestionBanks() en consola para detalles.</small>`
            );
            
            return updatedHTML;
        }
        
        return originalHTML;
    };

    console.log('‚úÖ PASO 2 CORREGIDO completado - IDs v√°lidos para Firebase');
    console.log('üîß Correcci√≥n aplicada: cleanFirebaseKey() para caracteres prohibidos');
    console.log('üìö Sincronizaci√≥n de bancos funcionando correctamente');
</script>
    <!-- 
PASO 3: INTERFAZ DE DUELO (3 FRANJAS)
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
Este paso crea la interfaz de 3 franjas para el duelo de preguntas
-->

<script>
    // ========== PASO 3: INTERFAZ DE DUELO (3 FRANJAS) ==========
    console.log('üéÆ PASO 3: Implementando interfaz de duelo con 3 franjas...');

    // FUNCI√ìN para renderizar la interfaz de duelo cuando el juego est√° en estado 'playing'
    function renderDuelInterface() {
        const isHost = multiplayerState.isHost;
        const opponent = multiplayerState.opponent;
        const myTurn = multiplayerState.myTurn;
        const myFailures = multiplayerState.myFailures || 0;
        const opponentFailures = multiplayerState.opponentFailures || 0;
        
        // Obtener bancos de preguntas
        const opponentBank = getOpponentQuestionBank();
        const myBank = getMyQuestionBank();
        
        // Datos de la pregunta actual si existe
        const currentQuestion = multiplayerState.currentRoomData?.gameData?.currentQuestionData || null;
        
        return `
            <div style="max-width: 1400px; margin: 0 auto; padding: 20px; min-height: calc(100vh - 200px);">
                
                <!-- Header del duelo -->
                <div style="text-align: center; margin-bottom: 25px; background: linear-gradient(135deg, #dc2626, #7f1d1d); color: white; padding: 20px; border-radius: 16px;">
                    <h1 style="margin: 0 0 10px 0; font-size: 2rem; font-weight: 800;">‚öîÔ∏è Duelo de Preguntas</h1>
                    <div style="font-size: 1.8rem; font-weight: bold; letter-spacing: 2px; margin: 5px 0;">
                        ${multiplayerState.roomCode}
                    </div>
                    <p style="margin: 0; opacity: 0.9; font-size: 14px;">
                        ${myTurn ? 'Tu turno: Selecciona una pregunta' : 'Turno del oponente: Espera tu respuesta'}
                    </p>
                </div>
                
                <!-- Interfaz de 3 franjas -->
                <div style="display: grid; grid-template-columns: 300px 1fr 300px; gap: 20px; min-height: 500px;">
                    
                    <!-- FRANJA IZQUIERDA: Panel del jugador que puede seleccionar pregunta -->
                    <div style="background: ${myTurn ? '#f0f9ff' : '#f8fafc'}; border: 2px solid ${myTurn ? '#0ea5e9' : '#e2e8f0'}; border-radius: 12px; overflow-y: auto; max-height: 600px;">
                        <div style="padding: 15px; border-bottom: 2px solid ${myTurn ? '#0ea5e9' : '#e2e8f0'}; background: ${myTurn ? '#0ea5e9' : '#6b7280'}; color: white; text-align: center;">
                            <h3 style="margin: 0; font-size: 16px;">${isHost ? 'üëë ANFITRI√ìN' : 'üë§ INVITADO'}</h3>
                            <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.9;">${state.currentUser.name}</p>
                            <div style="margin-top: 8px;">
                                <span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 10px; font-size: 12px;">
                                    ‚ùå ${myFailures}/3 Fallos
                                </span>
                            </div>
                        </div>
                        
                        <div style="padding: 15px;">
                            ${myTurn ? renderOpponentTopics(opponentBank) : `
                                <div style="text-align: center; padding: 40px 20px; color: #6b7280;">
                                    <div style="font-size: 2rem; margin-bottom: 10px;">‚è≥</div>
                                    <p style="margin: 0; font-size: 14px;">Esperando tu turno</p>
                                </div>
                            `}
                        </div>
                    </div>
                    
                    <!-- FRANJA CENTRAL: Pregunta actual -->
                    <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; display: flex; flex-direction: column;">
                        <div style="padding: 20px; border-bottom: 2px solid #e2e8f0; background: linear-gradient(135deg, #f8fafc, #e2e8f0); text-align: center;">
                            <h3 style="margin: 0; color: #374151; font-size: 18px;">üìã Pregunta Actual</h3>
                        </div>
                        
                        <div style="flex: 1; padding: 25px; display: flex; align-items: center; justify-content: center;">
                            ${currentQuestion ? renderCurrentQuestion(currentQuestion, !myTurn) : `
                                <div style="text-align: center; color: #9ca3af;">
                                    <div style="font-size: 4rem; margin-bottom: 20px;">üéØ</div>
                                    <h3 style="color: #6b7280; margin: 0 0 10px 0;">Esperando pregunta</h3>
                                    <p style="margin: 0; font-size: 14px;">
                                        ${myTurn ? 'Selecciona una pregunta del banco del oponente' : 'Tu oponente est√° seleccionando una pregunta'}
                                    </p>
                                </div>
                            `}
                        </div>
                    </div>
                    
                    <!-- FRANJA DERECHA: Panel del oponente -->
                    <div style="background: ${!myTurn ? '#fef3c7' : '#f8fafc'}; border: 2px solid ${!myTurn ? '#f59e0b' : '#e2e8f0'}; border-radius: 12px; overflow-y: auto; max-height: 600px;">
                        <div style="padding: 15px; border-bottom: 2px solid ${!myTurn ? '#f59e0b' : '#e2e8f0'}; background: ${!myTurn ? '#f59e0b' : '#6b7280'}; color: white; text-align: center;">
                            <h3 style="margin: 0; font-size: 16px;">${!isHost ? 'üëë ANFITRI√ìN' : 'üë§ INVITADO'}</h3>
                            <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.9;">${opponent ? opponent.name : 'Oponente'}</p>
                            <div style="margin-top: 8px;">
                                <span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 10px; font-size: 12px;">
                                    ‚ùå ${opponentFailures}/3 Fallos
                                </span>
                            </div>
                        </div>
                        
                        <div style="padding: 15px;">
                            ${!myTurn ? renderOpponentTopics(myBank) : `
                                <div style="text-align: center; padding: 40px 20px; color: #6b7280;">
                                    <div style="font-size: 2rem; margin-bottom: 10px;">ü§î</div>
                                    <p style="margin: 0; font-size: 14px;">Seleccionando pregunta...</p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
                
                <!-- Bot√≥n salir -->
                <div style="text-align: center; margin-top: 25px;">
                    <button onclick="leaveRoom()" class="btn btn-danger" style="padding: 12px 24px;">
                        üö™ Salir del Duelo
                    </button>
                </div>
            </div>
        `;
    }

    // FUNCI√ìN para renderizar los temas del oponente (para seleccionar preguntas)
    function renderOpponentTopics(questionBank) {
        if (!questionBank || Object.keys(questionBank).length === 0) {
            return `
                <div style="text-align: center; padding: 20px; color: #6b7280;">
                    <p style="margin: 0; font-size: 14px;">Sin temas disponibles</p>
                </div>
            `;
        }
        
        let html = '<div style="font-size: 13px; color: #374151; margin-bottom: 15px; text-align: center; font-weight: 600;">Temas Disponibles:</div>';
        
        Object.keys(questionBank).forEach(topicKey => {
            const topic = questionBank[topicKey];
            if (topic.questions && topic.questions.length > 0) {
                html += `
                    <div style="margin-bottom: 15px; border: 1px solid #d1d5db; border-radius: 8px; overflow: hidden;">
                        <div style="background: #f9fafb; padding: 10px; border-bottom: 1px solid #d1d5db; cursor: pointer;" onclick="toggleTopicQuestions('${topicKey}')">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 500; color: #374151; font-size: 13px;">${topic.name}</span>
                                <span style="background: #e5e7eb; color: #374151; padding: 2px 6px; border-radius: 10px; font-size: 11px;">
                                    ${topic.questions.length}
                                </span>
                            </div>
                        </div>
                        <div id="questions-${topicKey}" style="display: none; max-height: 200px; overflow-y: auto;">
                            ${topic.questions.map((question, index) => `
                                <div style="padding: 8px 12px; border-bottom: 1px solid #f3f4f6; cursor: pointer; font-size: 12px; line-height: 1.4;" 
                                     onclick="selectQuestionFromOpponent('${topicKey}', '${question.firebaseKey}')"
                                     onmouseover="this.style.backgroundColor='#f3f4f6'" 
                                     onmouseout="this.style.backgroundColor='white'">
                                    <strong>P${index + 1}:</strong> ${question.question.substring(0, 80)}${question.question.length > 80 ? '...' : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        });
        
        return html;
    }

    // FUNCI√ìN para renderizar la pregunta actual en la franja central
    function renderCurrentQuestion(question, canAnswer) {
        if (!question) return '';
        
        return `
            <div style="width: 100%; max-width: 500px;">
                <div style="margin-bottom: 25px;">
                    <h4 style="color: #1f2937; font-size: 18px; line-height: 1.5; margin: 0; text-align: center;">
                        ${question.question}
                    </h4>
                </div>
                
                <div style="display: grid; gap: 12px;">
                    ${question.options.map((option, index) => `
                        <div style="
                            padding: 15px; 
                            background: ${canAnswer ? '#f9fafb' : '#f8fafc'}; 
                            border: 2px solid ${canAnswer ? '#d1d5db' : '#e2e8f0'}; 
                            border-radius: 8px; 
                            ${canAnswer ? 'cursor: pointer;' : 'cursor: default;'}
                            transition: all 0.2s;
                            font-size: 14px;
                            line-height: 1.4;
                        " 
                        ${canAnswer ? `
                            onclick="answerCurrentQuestion(${index})"
                            onmouseover="this.style.backgroundColor='#f3f4f6'; this.style.borderColor='#4f46e5';" 
                            onmouseout="this.style.backgroundColor='#f9fafb'; this.style.borderColor='#d1d5db';"
                        ` : ''}>
                            <strong>${String.fromCharCode(97 + index)}) </strong>${option}
                        </div>
                    `).join('')}
                </div>
                
                ${canAnswer ? `
                    <div style="text-align: center; margin-top: 20px; padding: 10px; background: #f0f9ff; border-radius: 6px;">
                        <span style="color: #1e40af; font-size: 13px;">üí° Haz clic en una opci√≥n para responder</span>
                    </div>
                ` : `
                    <div style="text-align: center; margin-top: 20px; padding: 10px; background: #fef3c7; border-radius: 6px;">
                        <span style="color: #92400e; font-size: 13px;">‚è≥ Esperando respuesta del oponente</span>
                    </div>
                `}
            </div>
        `;
    }

    // FUNCI√ìN para alternar la visualizaci√≥n de preguntas de un tema
    function toggleTopicQuestions(topicKey) {
        const questionsDiv = document.getElementById(`questions-${topicKey}`);
        if (questionsDiv) {
            questionsDiv.style.display = questionsDiv.style.display === 'none' ? 'block' : 'none';
        }
    }

   // FUNCI√ìN COMPLETA para responder la pregunta actual
function answerCurrentQuestion(optionIndex) {
    console.log('üéØ Respondiendo pregunta con opci√≥n:', optionIndex);
    
    // Verificar que hay una pregunta actual
    const currentQuestion = multiplayerState.currentRoomData?.gameData?.currentQuestionData;
    if (!currentQuestion) {
        showMessage('No hay pregunta actual para responder', 'warning');
        return;
    }
    
    // Verificar que no estoy esperando una respuesta ya procesada
    if (!multiplayerState.currentRoomData?.gameData?.waitingForAnswer) {
        showMessage('Esta pregunta ya fue respondida', 'warning');
        return;
    }
    
    // Verificar que es mi turno para responder (es el turno del otro)
    if (multiplayerState.myTurn) {
        showMessage('No es tu turno para responder', 'warning');
        return;
    }
    
    // Determinar si la respuesta es correcta
    const isCorrect = optionIndex === currentQuestion.correctAnswer;
    const selectedOption = currentQuestion.options[optionIndex];
    
    console.log('üìä Procesando respuesta:', {
        selectedIndex: optionIndex,
        correctIndex: currentQuestion.correctAnswer,
        isCorrect: isCorrect,
        selectedOption: selectedOption
    });
    
    // Preparar datos de la respuesta
    const responseData = {
        'gameData/currentResponse': {
            selectedIndex: optionIndex,
            isCorrect: isCorrect,
            selectedOption: selectedOption,
            answeredBy: multiplayerState.isHost ? 'host' : 'guest',
            timestamp: Date.now()
        },
        'gameData/waitingForAnswer': false, // Ya no esperamos respuesta
        'gameData/showingResult': true, // Mostrar resultado por unos segundos
        lastActivity: firebase.database.ServerValue.TIMESTAMP
    };
    
    // Si la respuesta es incorrecta, incrementar fallos del que responde
    if (!isCorrect) {
        const failuresPath = multiplayerState.isHost ? 'gameData/hostFailures' : 'gameData/guestFailures';
        const currentFailures = multiplayerState.isHost ? 
            (multiplayerState.myFailures || 0) : 
            (multiplayerState.myFailures || 0);
        
        responseData[failuresPath] = currentFailures + 1;
    }
    
    // Actualizar Firebase con la respuesta
    database.ref('rooms/' + multiplayerState.currentRoom).update(responseData).then(() => {
        const resultMessage = isCorrect ? 
            `‚úÖ ¬°Correcto! ${selectedOption}` : 
            `‚ùå Incorrecto. Era: ${currentQuestion.options[currentQuestion.correctAnswer]}`;
        
        showMessage(resultMessage, isCorrect ? 'success' : 'error');
        
        // Despu√©s de 3 segundos, cambiar el turno y limpiar la pregunta
        setTimeout(() => {
            changeToNextTurn();
        }, 3000);
        
    }).catch(error => {
        console.error('‚ùå Error enviando respuesta:', error);
        showMessage('Error al enviar la respuesta', 'error');
    });
}

// FUNCI√ìN AUXILIAR para cambiar al siguiente turno
function changeToNextTurn() {
    const nextTurnData = {
        'gameData/currentQuestionData': null, // Limpiar pregunta actual
        'gameData/currentResponse': null, // Limpiar respuesta
        'gameData/showingResult': false, // No mostrar resultado
        'gameData/questionAsker': null, // Limpiar quien pregunt√≥
        'gameData/currentTurn': multiplayerState.isHost ? 'host' : 'guest', // Cambiar turno
        lastActivity: firebase.database.ServerValue.TIMESTAMP
    };
    
    database.ref('rooms/' + multiplayerState.currentRoom).update(nextTurnData).then(() => {
        console.log('üîÑ Turno cambiado correctamente');
        showMessage('Tu turno para preguntar', 'info');
    }).catch(error => {
        console.error('‚ùå Error cambiando turno:', error);
    });
}

    // ACTUALIZAR renderRoomInterface para mostrar interfaz de duelo cuando est√© jugando
    const originalRenderRoomInterfaceStep3 = renderRoomInterface;
    renderRoomInterface = function() {
        // Si el juego est√° en curso, mostrar interfaz de duelo
        if (multiplayerState.gameState === 'playing') {
            return renderDuelInterface();
        }
        
        // Si no, mostrar la interfaz de sala normal
        return originalRenderRoomInterfaceStep3();
    };

    // ACTUALIZAR updateLocalStateFromRoom para manejar turnos
    const originalUpdateLocalStateFromRoomStep3 = updateLocalStateFromRoom;
    updateLocalStateFromRoom = function(roomData) {
        // Llamar funci√≥n original
        originalUpdateLocalStateFromRoomStep3(roomData);
        
        // Actualizar informaci√≥n de turnos y fallos
        if (roomData.gameData) {
            const gameData = roomData.gameData;
            
            // Determinar de qui√©n es el turno
            multiplayerState.myTurn = (gameData.currentTurn === 'host') === multiplayerState.isHost;
            
            // Actualizar fallos
            multiplayerState.myFailures = multiplayerState.isHost ? gameData.hostFailures : gameData.guestFailures;
            multiplayerState.opponentFailures = multiplayerState.isHost ? gameData.guestFailures : gameData.hostFailures;
            
            console.log('üéÆ Estado de juego actualizado:', {
                myTurn: multiplayerState.myTurn,
                myFailures: multiplayerState.myFailures,
                opponentFailures: multiplayerState.opponentFailures,
                currentQuestion: gameData.currentQuestionData ? 'Hay pregunta' : 'Sin pregunta'
            });
        }
    };

    console.log('‚úÖ PASO 3 completado - Interfaz de duelo implementada');
    console.log('üéÆ Funcionalidades a√±adidas:');
    console.log('   - Layout de 3 franjas responsivo');
    console.log('   - Panel izquierdo: Selector de temas/preguntas del jugador activo');
    console.log('   - Panel central: Visualizaci√≥n de pregunta actual');
    console.log('   - Panel derecho: Informaci√≥n del oponente'); 
    console.log('   - Control visual de turnos y fallos');
    console.log('   - Temas expandibles con lista de preguntas');
    console.log('   - Opciones clicables solo para el jugador que debe responder');
    console.log('   - Funci√≥n toggleTopicQuestions() para expandir/contraer');
    console.log('   - Funci√≥n answerCurrentQuestion() preparada para siguiente paso');
</script>
<!--
CORRECCI√ìN COMPLETA: MODO DESARROLLADOR - INTERFAZ DE DUELO
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
Esta correcci√≥n arregla la visualizaci√≥n de temas y la l√≥gica de franjas
-->
<script>
// ========== CORRECCI√ìN COMPLETA - INTERFAZ DE DUELO ==========
console.log('üîß Aplicando correcci√≥n completa del modo desarrollador...');

// PASO 1: REEMPLAZAR renderDuelInterface completamente
function renderDuelInterface() {
    const isHost = multiplayerState.isHost;
    const opponent = multiplayerState.opponent;
    const myTurn = multiplayerState.myTurn;
    const myFailures = multiplayerState.myFailures || 0;
    const opponentFailures = multiplayerState.opponentFailures || 0;

    // Obtener bancos de preguntas
    const opponentBank = getOpponentQuestionBank();
    const myBank = getMyQuestionBank();

    // Datos de la pregunta actual si existe
    const currentQuestion = multiplayerState.currentRoomData?.gameData?.currentQuestionData || null;

    console.log('üéÆ Estado del duelo:', {
        isHost,
        myTurn,
        myBankTopics: Object.keys(myBank).length,
        opponentBankTopics: Object.keys(opponentBank).length
    });

    return `
    <div style="max-width: 1400px; margin: 0 auto; padding: 20px; min-height: calc(100vh - 200px);">
        <!-- Header del duelo -->
        <div style="text-align: center; margin-bottom: 25px; background: linear-gradient(135deg, #dc2626, #7f1d1d); color: white; padding: 20px; border-radius: 16px;">
            <h1 style="margin: 0 0 10px 0; font-size: 2rem; font-weight: 800;">‚öîÔ∏è Duelo de Preguntas</h1>
            <div style="font-size: 1.8rem; font-weight: bold; letter-spacing: 2px; margin: 5px 0;">
                ${multiplayerState.roomCode}
            </div>
            <p style="margin: 0; opacity: 0.9; font-size: 14px;">
                ${myTurn ? 'Tu turno: Selecciona una pregunta del oponente' : 'Turno del oponente: Espera su pregunta'}
            </p>
        </div>

        <!-- Interfaz de 3 franjas CORREGIDA -->
        <div style="display: grid; grid-template-columns: 300px 1fr 300px; gap: 20px; min-height: 500px;">
            
            <!-- FRANJA IZQUIERDA: SIEMPRE EL USUARIO ACTUAL + SUS TEMAS -->
            <div style="background: #f0fdf4; border: 2px solid #22c55e; border-radius: 12px; overflow-y: auto; max-height: 600px;">
                <div style="padding: 15px; border-bottom: 2px solid #22c55e; background: #22c55e; color: white; text-align: center;">
                    <h3 style="margin: 0; font-size: 16px;">${isHost ? 'üëë ANFITRI√ìN' : 'üë§ INVITADO'}</h3>
                    <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.9;">${state.currentUser.name} (T√ö)</p>
                    <div style="margin-top: 8px;">
                        <span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 10px; font-size: 12px;">
                            ‚ùå ${myFailures}/3 Fallos
                        </span>
                    </div>
                </div>
                <div style="padding: 15px;">
                    <div style="font-size: 13px; color: #16a34a; margin-bottom: 15px; text-align: center; font-weight: 600;">
                        Mis Temas:
                    </div>
                    ${renderMyTopics(myBank)}
                </div>
            </div>

            <!-- FRANJA CENTRAL: Pregunta actual -->
            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; display: flex; flex-direction: column;">
                <div style="padding: 20px; border-bottom: 2px solid #e2e8f0; background: linear-gradient(135deg, #f8fafc, #e2e8f0); text-align: center;">
                    <h3 style="margin: 0; color: #374151; font-size: 18px;">üìã Pregunta Actual</h3>
                </div>
                <div style="flex: 1; padding: 25px; display: flex; align-items: center; justify-content: center;">
                    ${currentQuestion ? renderCurrentQuestion(currentQuestion, !myTurn) : `
                        <div style="text-align: center; color: #9ca3af;">
                            <div style="font-size: 4rem; margin-bottom: 20px;">üéØ</div>
                            <h3 style="color: #6b7280; margin: 0 0 10px 0;">Esperando pregunta</h3>
                            <p style="margin: 0; font-size: 14px;">
                                ${myTurn ? 'Selecciona una pregunta de los temas del oponente (panel derecho)' : 'Tu oponente est√° seleccionando una pregunta'}
                            </p>
                        </div>
                    `}
                </div>
            </div>

            <!-- FRANJA DERECHA: SIEMPRE EL OPONENTE + SUS TEMAS -->
            <div style="background: ${myTurn ? '#fef3c7' : '#f8fafc'}; border: 2px solid ${myTurn ? '#f59e0b' : '#e2e8f0'}; border-radius: 12px; overflow-y: auto; max-height: 600px;">
                <div style="padding: 15px; border-bottom: 2px solid ${myTurn ? '#f59e0b' : '#e2e8f0'}; background: ${myTurn ? '#f59e0b' : '#6b7280'}; color: white; text-align: center;">
                    <h3 style="margin: 0; font-size: 16px;">${!isHost ? 'üëë ANFITRI√ìN' : 'üë§ INVITADO'}</h3>
                    <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.9;">${opponent ? opponent.name : 'Oponente'}</p>
                    <div style="margin-top: 8px;">
                        <span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 10px; font-size: 12px;">
                            ‚ùå ${opponentFailures}/3 Fallos
                        </span>
                    </div>
                </div>
                <div style="padding: 15px;">
                    <div style="font-size: 13px; color: ${myTurn ? '#92400e' : '#6b7280'}; margin-bottom: 15px; text-align: center; font-weight: 600;">
                        ${myTurn ? 'Selecciona una pregunta:' : 'Temas del oponente:'}
                    </div>
                    ${renderOpponentTopicsForSelection(opponentBank, myTurn)}
                </div>
            </div>
        </div>

        <!-- Bot√≥n salir -->
        <div style="text-align: center; margin-top: 25px;">
            <button onclick="leaveRoom()" class="btn btn-danger" style="padding: 12px 24px;">
                üö™ Salir del Duelo
            </button>
        </div>
    </div>
    `;
}

// PASO 2: NUEVA FUNCI√ìN para renderizar MIS temas (solo visualizaci√≥n)
function renderMyTopics(questionBank) {
    if (!questionBank || Object.keys(questionBank).length === 0) {
        return `
            <div style="text-align: center; padding: 20px; color: #6b7280;">
                <p style="margin: 0; font-size: 14px;">Sin temas disponibles</p>
            </div>
        `;
    }

    let html = '';
    Object.keys(questionBank).forEach(topicKey => {
        const topic = questionBank[topicKey];
        if (topic.questions && topic.questions.length > 0) {
            html += `
                <div style="margin-bottom: 15px; border: 1px solid #d1d5db; border-radius: 8px; overflow: hidden;">
                    <div style="background: #f9fafb; padding: 10px; border-bottom: 1px solid #d1d5db; cursor: pointer;" onclick="toggleTopicQuestions('my-${topicKey}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 500; color: #374151; font-size: 13px;">${topic.name}</span>
                            <span style="background: #16a34a; color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px;">
                                ${topic.questions.length}
                            </span>
                        </div>
                    </div>
                    <div id="my-questions-${topicKey}" style="display: none; max-height: 200px; overflow-y: auto;">
                        ${topic.questions.map((question, index) => `
                            <div style="padding: 8px 12px; border-bottom: 1px solid #f3f4f6; font-size: 12px; line-height: 1.4; color: #6b7280;">
                                <strong>P${index + 1}:</strong> ${question.question.substring(0, 60)}...
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
    });

    return html || `
        <div style="text-align: center; padding: 20px; color: #6b7280;">
            <p style="margin: 0; font-size: 14px;">Sin preguntas en tus temas</p>
        </div>
    `;
}

// PASO 3: FUNCI√ìN MEJORADA para renderizar temas del oponente (con selecci√≥n)
function renderOpponentTopicsForSelection(questionBank, canSelect) {
    if (!questionBank || Object.keys(questionBank).length === 0) {
        return `
            <div style="text-align: center; padding: 20px; color: #6b7280;">
                <p style="margin: 0; font-size: 14px;">Sin temas disponibles</p>
            </div>
        `;
    }

    let html = '';
    Object.keys(questionBank).forEach(topicKey => {
        const topic = questionBank[topicKey];
        if (topic.questions && topic.questions.length > 0) {
            html += `
                <div style="margin-bottom: 15px; border: 1px solid ${canSelect ? '#f59e0b' : '#d1d5db'}; border-radius: 8px; overflow: hidden; ${canSelect ? 'box-shadow: 0 2px 4px rgba(245,158,11,0.2);' : ''}">
                    <div style="background: ${canSelect ? '#fef3c7' : '#f9fafb'}; padding: 10px; border-bottom: 1px solid ${canSelect ? '#f59e0b' : '#d1d5db'}; cursor: pointer;" onclick="toggleTopicQuestions('opponent-${topicKey}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 500; color: ${canSelect ? '#92400e' : '#374151'}; font-size: 13px;">${topic.name}</span>
                            <span style="background: ${canSelect ? '#f59e0b' : '#e5e7eb'}; color: ${canSelect ? 'white' : '#374151'}; padding: 2px 6px; border-radius: 10px; font-size: 11px;">
                                ${topic.questions.length}
                            </span>
                        </div>
                    </div>
                    <div id="opponent-questions-${topicKey}" style="display: none; max-height: 200px; overflow-y: auto;">
                        ${topic.questions.map((question, index) => `
                            <div style="padding: 8px 12px; border-bottom: 1px solid #f3f4f6; ${canSelect ? 'cursor: pointer;' : ''} font-size: 12px; line-height: 1.4; ${canSelect ? 'transition: background-color 0.2s;' : ''}"
                                 ${canSelect ? `onclick="selectQuestionFromOpponent('${topicKey}', '${question.firebaseKey}')" 
                                               onmouseover="this.style.backgroundColor='${canSelect ? '#fef3c7' : 'inherit'}'"
                                               onmouseout="this.style.backgroundColor='transparent'"` : ''}>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong style="color: ${canSelect ? '#92400e' : '#6b7280'};">P${index + 1}:</strong> 
                                        <span style="color: ${canSelect ? '#374151' : '#6b7280'};">${question.question.substring(0, 50)}...</span>
                                    </div>
                                    ${canSelect ? `<span style="color: #f59e0b; font-size: 10px;">üìå Clic para seleccionar</span>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
    });

    if (!html) {
        return `
            <div style="text-align: center; padding: 20px; color: #6b7280;">
                <p style="margin: 0; font-size: 14px;">Sin preguntas en los temas del oponente</p>
            </div>
        `;
    }

    return html;
}

// PASO 4: ACTUALIZAR funci√≥n toggleTopicQuestions para manejar prefijos
const originalToggleTopicQuestions = window.toggleTopicQuestions || function(topicKey) {
    const questionsDiv = document.getElementById(`questions-${topicKey}`);
    if (questionsDiv) {
        questionsDiv.style.display = questionsDiv.style.display === 'none' ? 'block' : 'none';
    }
};

function toggleTopicQuestions(fullTopicKey) {
    // Detectar si es "my-" o "opponent-" y manejar acordemente
    let questionsId;
    
    if (fullTopicKey.startsWith('my-')) {
        const topicKey = fullTopicKey.replace('my-', '');
        questionsId = `my-questions-${topicKey}`;
    } else if (fullTopicKey.startsWith('opponent-')) {
        const topicKey = fullTopicKey.replace('opponent-', '');
        questionsId = `opponent-questions-${topicKey}`;
    } else {
        // Fallback al comportamiento original
        questionsId = `questions-${fullTopicKey}`;
    }
    
    const questionsDiv = document.getElementById(questionsId);
    if (questionsDiv) {
        questionsDiv.style.display = questionsDiv.style.display === 'none' ? 'block' : 'none';
    }
}

// Reemplazar la funci√≥n global
window.toggleTopicQuestions = toggleTopicQuestions;

// PASO 5: MEJORAR funci√≥n de selecci√≥n de pregunta
const originalSelectQuestionFromOpponent = window.selectQuestionFromOpponent || function(topicKey, questionFirebaseKey) {
    console.log('Funci√≥n selectQuestionFromOpponent no implementada');
};

function selectQuestionFromOpponent(topicKey, questionFirebaseKey) {
    if (!multiplayerState.myTurn) {
        showMessage('No es tu turno para seleccionar preguntas', 'warning');
        return;
    }

    const opponentBank = getOpponentQuestionBank();
    if (!opponentBank[topicKey] || !opponentBank[topicKey].questions) {
        console.error('‚ùå Tema no encontrado:', topicKey);
        showMessage('Error: Tema no encontrado', 'error');
        return;
    }

    const question = opponentBank[topicKey].questions.find(q => q.firebaseKey === questionFirebaseKey);
    if (!question) {
        console.error('‚ùå Pregunta no encontrada:', questionFirebaseKey);
        showMessage('Error: Pregunta no encontrada', 'error');
        return;
    }

    console.log('üéØ Enviando pregunta al oponente:', {
        topic: opponentBank[topicKey].name,
        question: question.question.substring(0, 50) + '...'
    });

    // Actualizar Firebase con la pregunta seleccionada
    database.ref('rooms/' + multiplayerState.currentRoom).update({
        'gameData/currentQuestionData': question,
        'gameData/currentTurn': multiplayerState.isHost ? 'guest' : 'host',
        lastActivity: firebase.database.ServerValue.TIMESTAMP
    }).then(() => {
        showMessage(`Pregunta enviada: ${question.question.substring(0, 30)}...`, 'success');
    }).catch(error => {
        console.error('‚ùå Error enviando pregunta:', error);
        showMessage('Error al enviar la pregunta', 'error');
    });
}

// Reemplazar la funci√≥n global
window.selectQuestionFromOpponent = selectQuestionFromOpponent;

console.log('‚úÖ CORRECCI√ìN COMPLETA aplicada correctamente');
console.log('üéÆ Nuevas caracter√≠sticas:');
console.log(' - Franja izquierda: Siempre el usuario actual + sus temas');
console.log(' - Franja derecha: Siempre el oponente + sus temas (seleccionables en tu turno)');
console.log(' - Visualizaci√≥n correcta de todos los temas (host y guest)');
console.log(' - Selecci√≥n mejorada con indicadores visuales');
console.log(' - Funci√≥n toggleTopicQuestions mejorada con prefijos');
console.log(' - Funci√≥n selectQuestionFromOpponent mejorada con validaciones');
</script>
    <!--
CORRECCI√ìN OBLIGATORIA: FORZAR VISUALIZACI√ìN DE TEMAS DEL INVITADO
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
Esta correcci√≥n OBLIGA a que se vean los temas tanto del anfitri√≥n como del invitado
-->
<script>
// ========== CORRECCI√ìN OBLIGATORIA - TEMAS DEL INVITADO ==========
console.log('üîß FORZANDO visualizaci√≥n de temas del invitado...');

// PASO 1: FUNCI√ìN MEJORADA para obtener MI banco de preguntas (CON FALLBACK OBLIGATORIO)
function getMyQuestionBank() {
    let myBank;
    
    if (multiplayerState.isHost) {
        myBank = multiplayerState.hostQuestionBank || {};
    } else {
        myBank = multiplayerState.guestQuestionBank || {};
    }
    
    // FALLBACK OBLIGATORIO: Si no hay banco, crearlo desde mis preguntas locales
    if (!myBank || Object.keys(myBank).length === 0) {
        console.warn('‚ö†Ô∏è Mi banco est√° vac√≠o, creando desde preguntas locales...');
        const verifiedQuestions = state.questions.filter(q => q.isVerified);
        myBank = organizeQuestionsForFirebase(verifiedQuestions, state.topics);
        
        // Guardar en el estado local inmediatamente
        if (multiplayerState.isHost) {
            multiplayerState.hostQuestionBank = myBank;
        } else {
            multiplayerState.guestQuestionBank = myBank;
        }
        
        console.log('‚úÖ Banco reconstruido:', {
            topics: Object.keys(myBank).length,
            questions: Object.values(myBank).reduce((total, topic) => total + (topic.questions ? topic.questions.length : 0), 0)
        });
    }
    
    return myBank;
}

// PASO 2: FUNCI√ìN MEJORADA para obtener banco del oponente (CON VALIDACI√ìN)
function getOpponentQuestionBank() {
    let opponentBank;
    
    if (multiplayerState.isHost) {
        opponentBank = multiplayerState.guestQuestionBank || {};
    } else {
        opponentBank = multiplayerState.hostQuestionBank || {};
    }
    
    console.log('üîç Banco del oponente:', {
        topics: Object.keys(opponentBank).length,
        isEmpty: Object.keys(opponentBank).length === 0
    });
    
    return opponentBank;
}

// PASO 3: FUNCI√ìN OBLIGATORIA para sincronizar banco del invitado en Firebase
function forceSyncGuestBank() {
    if (!multiplayerState.isHost && multiplayerState.currentRoom) {
        const verifiedQuestions = state.questions.filter(q => q.isVerified);
        if (verifiedQuestions.length > 0) {
            const guestBank = organizeQuestionsForFirebase(verifiedQuestions, state.topics);
            
            console.log('üîÑ FORZANDO sincronizaci√≥n del banco del invitado:', guestBank);
            
            // Actualizar Firebase OBLIGATORIAMENTE
            database.ref('rooms/' + multiplayerState.currentRoom + '/questionBanks/guest').set(guestBank)
                .then(() => {
                    console.log('‚úÖ Banco del invitado sincronizado en Firebase');
                    multiplayerState.guestQuestionBank = guestBank;
                    render(); // Re-renderizar para mostrar cambios
                })
                .catch(error => {
                    console.error('‚ùå Error sincronizando banco del invitado:', error);
                });
        }
    }
}

// PASO 4: REEMPLAZAR renderDuelInterface con VERIFICACI√ìN OBLIGATORIA
function renderDuelInterface() {
    const isHost = multiplayerState.isHost;
    const opponent = multiplayerState.opponent;
    const myTurn = multiplayerState.myTurn;
    const myFailures = multiplayerState.myFailures || 0;
    const opponentFailures = multiplayerState.opponentFailures || 0;

    // OBTENER BANCOS CON VERIFICACI√ìN OBLIGATORIA
    let myBank = getMyQuestionBank();
    let opponentBank = getOpponentQuestionBank();
    
    // VERIFICACI√ìN CR√çTICA: Si el invitado no tiene temas, forzar sincronizaci√≥n
    if (!isHost && (!myBank || Object.keys(myBank).length === 0)) {
        console.warn('‚ö†Ô∏è INVITADO SIN TEMAS - Forzando sincronizaci√≥n...');
        forceSyncGuestBank();
        // Crear banco temporal mientras se sincroniza
        const verifiedQuestions = state.questions.filter(q => q.isVerified);
        myBank = organizeQuestionsForFirebase(verifiedQuestions, state.topics);
    }
    
    // Datos de la pregunta actual si existe
    const currentQuestion = multiplayerState.currentRoomData?.gameData?.currentQuestionData || null;

    console.log('üéÆ ESTADO VERIFICADO del duelo:', {
        isHost,
        myTurn,
        myBankTopics: Object.keys(myBank).length,
        opponentBankTopics: Object.keys(opponentBank).length,
        myBankData: myBank
    });

    return `
    <div style="max-width: 1400px; margin: 0 auto; padding: 20px; min-height: calc(100vh - 200px);">
        <!-- Header del duelo -->
        <div style="text-align: center; margin-bottom: 25px; background: linear-gradient(135deg, #dc2626, #7f1d1d); color: white; padding: 20px; border-radius: 16px;">
            <h1 style="margin: 0 0 10px 0; font-size: 2rem; font-weight: 800;">‚öîÔ∏è Duelo de Preguntas</h1>
            <div style="font-size: 1.8rem; font-weight: bold; letter-spacing: 2px; margin: 5px 0;">
                ${multiplayerState.roomCode}
            </div>
            <p style="margin: 0; opacity: 0.9; font-size: 14px;">
                ${myTurn ? 'Tu turno: Selecciona una pregunta del oponente' : 'Turno del oponente: Espera su pregunta'}
            </p>
        </div>

        <!-- DEBUG INFO (temporal) -->
        <div style="background: #f3f4f6; padding: 10px; margin-bottom: 20px; border-radius: 8px; font-size: 12px;">
            <strong>DEBUG:</strong> 
            Mi banco: ${Object.keys(myBank).length} temas | 
            Banco oponente: ${Object.keys(opponentBank).length} temas | 
            Rol: ${isHost ? 'Anfitri√≥n' : 'Invitado'}
        </div>

        <!-- Interfaz de 3 franjas CORREGIDA -->
        <div style="display: grid; grid-template-columns: 300px 1fr 300px; gap: 20px; min-height: 500px;">
            
            <!-- FRANJA IZQUIERDA: SIEMPRE EL USUARIO ACTUAL + SUS TEMAS -->
            <div style="background: #f0fdf4; border: 2px solid #22c55e; border-radius: 12px; overflow-y: auto; max-height: 600px;">
                <div style="padding: 15px; border-bottom: 2px solid #22c55e; background: #22c55e; color: white; text-align: center;">
                    <h3 style="margin: 0; font-size: 16px;">${isHost ? 'üëë ANFITRI√ìN' : 'üë§ INVITADO'}</h3>
                    <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.9;">${state.currentUser.name} (T√ö)</p>
                    <div style="margin-top: 8px;">
                        <span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 10px; font-size: 12px;">
                            ‚ùå ${myFailures}/3 Fallos
                        </span>
                    </div>
                </div>
                <div style="padding: 15px;">
                    <div style="font-size: 13px; color: #16a34a; margin-bottom: 15px; text-align: center; font-weight: 600;">
                        Mis Temas: (${Object.keys(myBank).length})
                    </div>
                    ${renderMyTopics(myBank)}
                </div>
            </div>

            <!-- FRANJA CENTRAL: Pregunta actual -->
            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; display: flex; flex-direction: column;">
                <div style="padding: 20px; border-bottom: 2px solid #e2e8f0; background: linear-gradient(135deg, #f8fafc, #e2e8f0); text-align: center;">
                    <h3 style="margin: 0; color: #374151; font-size: 18px;">üìã Pregunta Actual</h3>
                </div>
                <div style="flex: 1; padding: 25px; display: flex; align-items: center; justify-content: center;">
                    ${currentQuestion ? renderCurrentQuestion(currentQuestion, !myTurn) : `
                        <div style="text-align: center; color: #9ca3af;">
                            <div style="font-size: 4rem; margin-bottom: 20px;">üéØ</div>
                            <h3 style="color: #6b7280; margin: 0 0 10px 0;">Esperando pregunta</h3>
                            <p style="margin: 0; font-size: 14px;">
                                ${myTurn ? 'Selecciona una pregunta de los temas del oponente (panel derecho)' : 'Tu oponente est√° seleccionando una pregunta'}
                            </p>
                        </div>
                    `}
                </div>
            </div>

            <!-- FRANJA DERECHA: SIEMPRE EL OPONENTE + SUS TEMAS -->
            <div style="background: ${myTurn ? '#fef3c7' : '#f8fafc'}; border: 2px solid ${myTurn ? '#f59e0b' : '#e2e8f0'}; border-radius: 12px; overflow-y: auto; max-height: 600px;">
                <div style="padding: 15px; border-bottom: 2px solid ${myTurn ? '#f59e0b' : '#e2e8f0'}; background: ${myTurn ? '#f59e0b' : '#6b7280'}; color: white; text-align: center;">
                    <h3 style="margin: 0; font-size: 16px;">${!isHost ? 'üëë ANFITRI√ìN' : 'üë§ INVITADO'}</h3>
                    <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.9;">${opponent ? opponent.name : 'Oponente'}</p>
                    <div style="margin-top: 8px;">
                        <span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 10px; font-size: 12px;">
                            ‚ùå ${opponentFailures}/3 Fallos
                        </span>
                    </div>
                </div>
                <div style="padding: 15px;">
                    <div style="font-size: 13px; color: ${myTurn ? '#92400e' : '#6b7280'}; margin-bottom: 15px; text-align: center; font-weight: 600;">
                        ${myTurn ? 'Selecciona una pregunta:' : 'Temas del oponente:'} (${Object.keys(opponentBank).length})
                    </div>
                    ${renderOpponentTopicsForSelection(opponentBank, myTurn)}
                </div>
            </div>
        </div>

        <!-- Bot√≥n salir -->
        <div style="text-align: center; margin-top: 25px;">
            <button onclick="leaveRoom()" class="btn btn-danger" style="padding: 12px 24px;">
                üö™ Salir del Duelo
            </button>
            <!-- Bot√≥n debug temporal -->
            <button onclick="debugBanks()" class="btn btn-info" style="padding: 8px 16px; margin-left: 10px;">
                üîç Debug Bancos
            </button>
        </div>
    </div>
    `;
}

// PASO 5: FUNCI√ìN renderMyTopics MEJORADA (con fallback obligatorio)
function renderMyTopics(questionBank) {
    // Si no hay banco, intentar crear desde preguntas locales
    if (!questionBank || Object.keys(questionBank).length === 0) {
        console.warn('‚ö†Ô∏è renderMyTopics: Banco vac√≠o, intentando reconstruir...');
        const verifiedQuestions = state.questions.filter(q => q.isVerified);
        
        if (verifiedQuestions.length === 0) {
            return `
                <div style="text-align: center; padding: 20px; color: #dc2626;">
                    <p style="margin: 0; font-size: 14px;"><strong>‚ö†Ô∏è Sin preguntas verificadas</strong></p>
                    <p style="margin: 5px 0 0 0; font-size: 12px;">Ve a "Preguntas" y verifica algunas</p>
                </div>
            `;
        }
        
        questionBank = organizeQuestionsForFirebase(verifiedQuestions, state.topics);
        
        // Forzar sincronizaci√≥n si soy invitado
        if (!multiplayerState.isHost) {
            forceSyncGuestBank();
        }
    }

    let html = '';
    Object.keys(questionBank).forEach(topicKey => {
        const topic = questionBank[topicKey];
        if (topic.questions && topic.questions.length > 0) {
            html += `
                <div style="margin-bottom: 15px; border: 1px solid #16a34a; border-radius: 8px; overflow: hidden; background: rgba(22, 163, 74, 0.05);">
                    <div style="background: #dcfce7; padding: 10px; border-bottom: 1px solid #16a34a; cursor: pointer;" onclick="toggleTopicQuestions('my-${topicKey}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 500; color: #15803d; font-size: 13px;">${topic.name}</span>
                            <span style="background: #16a34a; color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px;">
                                ${topic.questions.length}
                            </span>
                        </div>
                    </div>
                    <div id="my-questions-${topicKey}" style="display: none; max-height: 200px; overflow-y: auto;">
                        ${topic.questions.map((question, index) => `
                            <div style="padding: 8px 12px; border-bottom: 1px solid #f3f4f6; font-size: 12px; line-height: 1.4; color: #374151;">
                                <strong style="color: #16a34a;">P${index + 1}:</strong> ${question.question.substring(0, 60)}...
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
    });

    return html || `
        <div style="text-align: center; padding: 20px; color: #dc2626;">
            <p style="margin: 0; font-size: 14px;"><strong>‚ö†Ô∏è ERROR: Sin temas</strong></p>
            <button onclick="forceSyncGuestBank()" style="margin-top: 10px; padding: 5px 10px; background: #dc2626; color: white; border: none; border-radius: 4px;">
                üîÑ Forzar Sincronizaci√≥n
            </button>
        </div>
    `;
}

// PASO 6: FUNCI√ìN renderOpponentTopicsForSelection MEJORADA
function renderOpponentTopicsForSelection(questionBank, canSelect) {
    if (!questionBank || Object.keys(questionBank).length === 0) {
        return `
            <div style="text-align: center; padding: 20px; color: #6b7280;">
                <p style="margin: 0; font-size: 14px;">‚è≥ Esperando temas del oponente...</p>
            </div>
        `;
    }

    let html = '';
    Object.keys(questionBank).forEach(topicKey => {
        const topic = questionBank[topicKey];
        if (topic.questions && topic.questions.length > 0) {
            html += `
                <div style="margin-bottom: 15px; border: 1px solid ${canSelect ? '#f59e0b' : '#d1d5db'}; border-radius: 8px; overflow: hidden; ${canSelect ? 'box-shadow: 0 2px 4px rgba(245,158,11,0.2);' : ''}">
                    <div style="background: ${canSelect ? '#fef3c7' : '#f9fafb'}; padding: 10px; border-bottom: 1px solid ${canSelect ? '#f59e0b' : '#d1d5db'}; cursor: pointer;" onclick="toggleTopicQuestions('opponent-${topicKey}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 500; color: ${canSelect ? '#92400e' : '#374151'}; font-size: 13px;">${topic.name}</span>
                            <span style="background: ${canSelect ? '#f59e0b' : '#e5e7eb'}; color: ${canSelect ? 'white' : '#374151'}; padding: 2px 6px; border-radius: 10px; font-size: 11px;">
                                ${topic.questions.length}
                            </span>
                        </div>
                    </div>
                    <div id="opponent-questions-${topicKey}" style="display: none; max-height: 200px; overflow-y: auto;">
                        ${topic.questions.map((question, index) => `
                            <div style="padding: 8px 12px; border-bottom: 1px solid #f3f4f6; ${canSelect ? 'cursor: pointer;' : ''} font-size: 12px; line-height: 1.4; ${canSelect ? 'transition: background-color 0.2s;' : ''}"
                                 ${canSelect ? `onclick="selectQuestionFromOpponent('${topicKey}', '${question.firebaseKey}')" 
                                               onmouseover="this.style.backgroundColor='${canSelect ? '#fef3c7' : 'inherit'}'"
                                               onmouseout="this.style.backgroundColor='transparent'"` : ''}>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong style="color: ${canSelect ? '#92400e' : '#6b7280'};">P${index + 1}:</strong> 
                                        <span style="color: ${canSelect ? '#374151' : '#6b7280'};">${question.question.substring(0, 50)}...</span>
                                    </div>
                                    ${canSelect ? `<span style="color: #f59e0b; font-size: 10px;">üìå Clic para seleccionar</span>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
    });

    if (!html) {
        return `
            <div style="text-align: center; padding: 20px; color: #6b7280;">
                <p style="margin: 0; font-size: 14px;">Sin preguntas disponibles</p>
            </div>
        `;
    }

    return html;
}

// PASO 7: FUNCI√ìN DEBUG para verificar bancos
window.debugBanks = function() {
    console.log('üîç DEBUG COMPLETO - Bancos de preguntas:');
    console.log('State completo:', multiplayerState);
    console.log('Mi banco:', getMyQuestionBank());
    console.log('Banco oponente:', getOpponentQuestionBank());
    console.log('Preguntas locales verificadas:', state.questions.filter(q => q.isVerified));
    console.log('Temas locales:', state.topics);
    
    // Mostrar en alerta para el usuario
    const myBank = getMyQuestionBank();
    const opponentBank = getOpponentQuestionBank();
    alert(`DEBUG BANCOS:
Mi banco: ${Object.keys(myBank).length} temas
Banco oponente: ${Object.keys(opponentBank).length} temas
Rol: ${multiplayerState.isHost ? 'Anfitri√≥n' : 'Invitado'}
Preguntas locales: ${state.questions.filter(q => q.isVerified).length}
Ver consola para detalles completos`);
};

// PASO 8: FUNCIONES DE TOGGLE Y SELECCI√ìN (mantenidas del c√≥digo anterior)
function toggleTopicQuestions(fullTopicKey) {
    let questionsId;
    
    if (fullTopicKey.startsWith('my-')) {
        const topicKey = fullTopicKey.replace('my-', '');
        questionsId = `my-questions-${topicKey}`;
    } else if (fullTopicKey.startsWith('opponent-')) {
        const topicKey = fullTopicKey.replace('opponent-', '');
        questionsId = `opponent-questions-${topicKey}`;
    } else {
        questionsId = `questions-${fullTopicKey}`;
    }
    
    const questionsDiv = document.getElementById(questionsId);
    if (questionsDiv) {
        questionsDiv.style.display = questionsDiv.style.display === 'none' ? 'block' : 'none';
    }
}

function selectQuestionFromOpponent(topicKey, questionFirebaseKey) {
    if (!multiplayerState.myTurn) {
        showMessage('No es tu turno para seleccionar preguntas', 'warning');
        return;
    }

    const opponentBank = getOpponentQuestionBank();
    if (!opponentBank[topicKey] || !opponentBank[topicKey].questions) {
        console.error('‚ùå Tema no encontrado:', topicKey);
        showMessage('Error: Tema no encontrado', 'error');
        return;
    }

    const question = opponentBank[topicKey].questions.find(q => q.firebaseKey === questionFirebaseKey);
    if (!question) {
        console.error('‚ùå Pregunta no encontrada:', questionFirebaseKey);
        showMessage('Error: Pregunta no encontrada', 'error');
        return;
    }

    console.log('üéØ Enviando pregunta al oponente:', {
        topic: opponentBank[topicKey].name,
        question: question.question.substring(0, 50) + '...'
    });

    database.ref('rooms/' + multiplayerState.currentRoom).update({
        'gameData/currentQuestionData': question,
        'gameData/currentTurn': multiplayerState.isHost ? 'guest' : 'host',
        lastActivity: firebase.database.ServerValue.TIMESTAMP
    }).then(() => {
        showMessage(`Pregunta enviada: ${question.question.substring(0, 30)}...`, 'success');
    }).catch(error => {
        console.error('‚ùå Error enviando pregunta:', error);
        showMessage('Error al enviar la pregunta', 'error');
    });
}

// REEMPLAZAR FUNCIONES GLOBALES
window.getMyQuestionBank = getMyQuestionBank;
window.getOpponentQuestionBank = getOpponentQuestionBank;
window.toggleTopicQuestions = toggleTopicQuestions;
window.selectQuestionFromOpponent = selectQuestionFromOpponent;
window.forceSyncGuestBank = forceSyncGuestBank;

// PASO 9: FORZAR SINCRONIZACI√ìN AL CARGAR
setTimeout(() => {
    if (multiplayerState.gameState === 'playing' && !multiplayerState.isHost) {
        forceSyncGuestBank();
    }
}, 2000);

console.log('‚úÖ CORRECCI√ìN OBLIGATORIA aplicada - Los temas del invitado DEBEN aparecer');
console.log('üõ†Ô∏è Funciones debug disponibles:');
console.log(' - debugBanks(): Ver estado completo de bancos');
console.log(' - forceSyncGuestBank(): Forzar sincronizaci√≥n del invitado');
</script>
    <!--
SOLUCI√ìN DEFINITIVA: SINCRONIZACI√ìN BIDIRECCIONAL FORZADA
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
Esta soluci√≥n OBLIGA a que ambos usuarios vean los bancos del otro en tiempo real
-->
<script>
// ========== SOLUCI√ìN DEFINITIVA - SINCRONIZACI√ìN BIDIRECCIONAL ==========
console.log('üöÄ APLICANDO SOLUCI√ìN DEFINITIVA para sincronizaci√≥n bidireccional...');

// PASO 1: LISTENER MEJORADO que FUERZA la sincronizaci√≥n bidireccional
function setupBidirectionalSync() {
    if (!multiplayerState.currentRoom || !database) return;
    
    console.log('üîÑ Configurando sincronizaci√≥n bidireccional para sala:', multiplayerState.currentRoom);
    
    // Listener para cambios en questionBanks
    database.ref('rooms/' + multiplayerState.currentRoom + '/questionBanks').on('value', (snapshot) => {
        const questionBanks = snapshot.val() || {};
        console.log('üìö Bancos recibidos desde Firebase:', questionBanks);
        
        // Actualizar bancos locales
        multiplayerState.hostQuestionBank = questionBanks.host || {};
        multiplayerState.guestQuestionBank = questionBanks.guest || {};
        
        console.log('‚úÖ Bancos actualizados localmente:', {
            hostTopics: Object.keys(multiplayerState.hostQuestionBank).length,
            guestTopics: Object.keys(multiplayerState.guestQuestionBank).length
        });
        
        // Re-renderizar si estamos en duelo
        if (multiplayerState.gameState === 'playing') {
            render();
        }
    });
    
    // Listener para cambios en la informaci√≥n de jugadores
    database.ref('rooms/' + multiplayerState.currentRoom + '/guest').on('value', (snapshot) => {
        const guestData = snapshot.val();
        if (guestData) {
            multiplayerState.opponent = guestData;
            console.log('üë§ Informaci√≥n del invitado actualizada:', guestData);
        }
    });
}

// PASO 2: FUNCI√ìN que OBLIGA la sincronizaci√≥n inmediata al unirse/crear sala
function forceImmediateSync() {
    if (!multiplayerState.currentRoom || !database) return;
    
    const verifiedQuestions = state.questions.filter(q => q.isVerified);
    if (verifiedQuestions.length === 0) return;
    
    const myBank = organizeQuestionsForFirebase(verifiedQuestions, state.topics);
    const bankKey = multiplayerState.isHost ? 'host' : 'guest';
    
    console.log('‚ö° FORZANDO sincronizaci√≥n inmediata como:', bankKey);
    console.log('üì¶ Mi banco a sincronizar:', myBank);
    
    // Actualizar Firebase INMEDIATAMENTE
    const updates = {};
    updates[`questionBanks/${bankKey}`] = myBank;
    updates['lastActivity'] = firebase.database.ServerValue.TIMESTAMP;
    
    return database.ref('rooms/' + multiplayerState.currentRoom).update(updates)
        .then(() => {
            console.log('‚úÖ Sincronizaci√≥n inmediata completada');
            
            // Actualizar estado local tambi√©n
            if (multiplayerState.isHost) {
                multiplayerState.hostQuestionBank = myBank;
            } else {
                multiplayerState.guestQuestionBank = myBank;
            }
            
            // Configurar listener bidireccional
            setupBidirectionalSync();
            
            return true;
        })
        .catch(error => {
            console.error('‚ùå Error en sincronizaci√≥n inmediata:', error);
            return false;
        });
}

// PASO 3: INTERCEPTAR funciones de crear/unirse a sala para forzar sync
const originalCreateMultiplayerRoom = window.createMultiplayerRoom;
window.createMultiplayerRoom = function() {
    console.log('üè† Interceptando creaci√≥n de sala para sync forzado...');
    
    // Llamar funci√≥n original
    if (originalCreateMultiplayerRoom) {
        originalCreateMultiplayerRoom();
        
        // Forzar sync despu√©s de crear
        setTimeout(() => {
            forceImmediateSync();
        }, 1000);
    }
};

const originalJoinMultiplayerRoom = window.joinMultiplayerRoom;
window.joinMultiplayerRoom = function() {
    console.log('üö™ Interceptando uni√≥n a sala para sync forzado...');
    
    if (!multiplayerEnabled) {
        showMessage('Error: Sistema multijugador no disponible', 'error');
        return;
    }
    
    if (!state.currentUser) {
        showMessage('Debes estar logueado para unirte a una sala', 'error');
        return;
    }
    
    const verifiedQuestions = state.questions.filter(q => q.isVerified);
    if (verifiedQuestions.length < 5) {
        showMessage('Necesitas al menos 5 preguntas verificadas para unirte a una sala', 'error');
        return;
    }
    
    const roomCode = prompt('Ingresa el c√≥digo de la sala (6 caracteres):');
    if (!roomCode || roomCode.length !== 6) {
        showMessage('C√≥digo de sala inv√°lido', 'error');
        return;
    }
    
    const upperRoomCode = roomCode.toUpperCase();
    
    // Organizar preguntas del invitado INMEDIATAMENTE
    const guestQuestionBank = organizeQuestionsForFirebase(verifiedQuestions, state.topics);
    console.log('üìö Banco del invitado preparado:', guestQuestionBank);
    
    database.ref('rooms/' + upperRoomCode).once('value')
        .then((snapshot) => {
            if (!snapshot.exists()) {
                showMessage('La sala no existe', 'error');
                return;
            }
            
            const roomData = snapshot.val();
            if (roomData.status !== 'waiting') {
                showMessage('La sala no est√° disponible', 'error');
                return;
            }
            
            if (roomData.guest !== null) {
                showMessage('La sala est√° llena', 'error');
                return;
            }
            
            if (roomData.host.username === state.currentUser.username) {
                showMessage('No puedes unirte a tu propia sala', 'error');
                return;
            }
            
            const guestData = {
                username: state.currentUser.username,
                name: state.currentUser.name,
                questions: verifiedQuestions.length,
                ready: false
            };
            
            // ACTUALIZACI√ìN COMPLETA con banco del invitado
            const updates = {
                guest: guestData,
                'questionBanks/guest': guestQuestionBank,  // BANCO DEL INVITADO
                lastActivity: firebase.database.ServerValue.TIMESTAMP
            };
            
            return database.ref('rooms/' + upperRoomCode).update(updates);
        })
        .then(() => {
            console.log('‚úÖ Invitado unido con banco sincronizado:', upperRoomCode);
            
            // Actualizar estado local
            multiplayerState.currentRoom = upperRoomCode;
            multiplayerState.isHost = false;
            multiplayerState.roomCode = upperRoomCode;
            multiplayerState.gameState = 'waiting';
            multiplayerState.guestQuestionBank = guestQuestionBank;
            
            // Configurar listeners
            listenToRoom(upperRoomCode);
            setupBidirectionalSync();
            
            render();
            showMessage(`Te has unido a la sala: ${upperRoomCode}`, 'success');
            
            // Verificaci√≥n adicional despu√©s de 2 segundos
            setTimeout(() => {
                console.log('üîç Verificaci√≥n post-uni√≥n:', {
                    myBank: Object.keys(multiplayerState.guestQuestionBank || {}).length,
                    hostBank: Object.keys(multiplayerState.hostQuestionBank || {}).length
                });
            }, 2000);
        })
        .catch((error) => {
            console.error('‚ùå Error uni√©ndose a sala:', error);
            showMessage('Error al unirse a la sala: ' + error.message, 'error');
        });
};

// PASO 4: FUNCI√ìN de verificaci√≥n y resincronizaci√≥n manual
window.forceResync = function() {
    console.log('üîÑ FORZANDO resincronizaci√≥n completa...');
    
    if (!multiplayerState.currentRoom) {
        alert('No est√°s en una sala');
        return;
    }
    
    // Obtener datos completos de Firebase
    database.ref('rooms/' + multiplayerState.currentRoom).once('value')
        .then(snapshot => {
            const roomData = snapshot.val();
            if (!roomData) {
                alert('Error: Sala no encontrada');
                return;
            }
            
            console.log('üì° Datos completos de Firebase:', roomData);
            
            // Actualizar bancos locales
            if (roomData.questionBanks) {
                multiplayerState.hostQuestionBank = roomData.questionBanks.host || {};
                multiplayerState.guestQuestionBank = roomData.questionBanks.guest || {};
            }
            
            // Actualizar informaci√≥n de jugadores
            multiplayerState.opponent = multiplayerState.isHost ? roomData.guest : roomData.host;
            
            console.log('‚úÖ Resincronizaci√≥n completada:', {
                hostBank: Object.keys(multiplayerState.hostQuestionBank).length,
                guestBank: Object.keys(multiplayerState.guestQuestionBank).length,
                opponent: multiplayerState.opponent?.name || 'No encontrado'
            });
            
            render();
            alert(`Resincronizaci√≥n completada:
Host: ${Object.keys(multiplayerState.hostQuestionBank).length} temas
Invitado: ${Object.keys(multiplayerState.guestQuestionBank).length} temas`);
        })
        .catch(error => {
            console.error('‚ùå Error en resincronizaci√≥n:', error);
            alert('Error en resincronizaci√≥n: ' + error.message);
        });
};

// PASO 5: FUNCI√ìN getMyQuestionBank mejorada con verificaci√≥n
function getMyQuestionBank() {
    let myBank;
    
    if (multiplayerState.isHost) {
        myBank = multiplayerState.hostQuestionBank || {};
    } else {
        myBank = multiplayerState.guestQuestionBank || {};
    }
    
    // Si est√° vac√≠o, intentar reconstruir
    if (!myBank || Object.keys(myBank).length === 0) {
        console.warn('‚ö†Ô∏è Mi banco vac√≠o, reconstruyendo...');
        const verifiedQuestions = state.questions.filter(q => q.isVerified);
        if (verifiedQuestions.length > 0) {
            myBank = organizeQuestionsForFirebase(verifiedQuestions, state.topics);
            
            // Actualizar estado local
            if (multiplayerState.isHost) {
                multiplayerState.hostQuestionBank = myBank;
            } else {
                multiplayerState.guestQuestionBank = myBank;
            }
        }
    }
    
    return myBank;
}

// PASO 6: FUNCI√ìN getOpponentQuestionBank mejorada
function getOpponentQuestionBank() {
    let opponentBank;
    
    if (multiplayerState.isHost) {
        opponentBank = multiplayerState.guestQuestionBank || {};
    } else {
        opponentBank = multiplayerState.hostQuestionBank || {};
    }
    
    console.log('üéØ Banco del oponente:', {
        role: multiplayerState.isHost ? 'host viendo guest' : 'guest viendo host',
        topics: Object.keys(opponentBank).length,
        bank: opponentBank
    });
    
    return opponentBank;
}

// PASO 7: RENDERIZADO con informaci√≥n de sincronizaci√≥n
function renderDuelInterface() {
    const isHost = multiplayerState.isHost;
    const opponent = multiplayerState.opponent;
    const myTurn = multiplayerState.myTurn;
    const myFailures = multiplayerState.myFailures || 0;
    const opponentFailures = multiplayerState.opponentFailures || 0;

    const myBank = getMyQuestionBank();
    const opponentBank = getOpponentQuestionBank();
    const currentQuestion = multiplayerState.currentRoomData?.gameData?.currentQuestionData || null;

    return `
    <div style="max-width: 1400px; margin: 0 auto; padding: 20px; min-height: calc(100vh - 200px);">
        <!-- Header del duelo -->
        <div style="text-align: center; margin-bottom: 25px; background: linear-gradient(135deg, #dc2626, #7f1d1d); color: white; padding: 20px; border-radius: 16px;">
            <h1 style="margin: 0 0 10px 0; font-size: 2rem; font-weight: 800;">‚öîÔ∏è Duelo de Preguntas</h1>
            <div style="font-size: 1.8rem; font-weight: bold; letter-spacing: 2px; margin: 5px 0;">
                ${multiplayerState.roomCode}
            </div>
            <p style="margin: 0; opacity: 0.9; font-size: 14px;">
                ${myTurn ? 'Tu turno: Selecciona una pregunta del oponente' : 'Turno del oponente: Espera su pregunta'}
            </p>
        </div>

        <!-- Panel de SINCRONIZACI√ìN -->
        <div style="background: linear-gradient(135deg, #1f2937, #374151); color: white; padding: 15px; margin-bottom: 20px; border-radius: 12px; border: 2px solid #4f46e5;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div style="font-weight: bold; color: #a5b4fc;">üîÑ ESTADO DE SINCRONIZACI√ìN</div>
                <button onclick="forceResync()" style="padding: 5px 12px; background: #4f46e5; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                    ‚Üª Resincronizar
                </button>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 13px;">
                <div style="text-align: center;">
                    <div style="color: #22c55e; font-weight: bold;">MIS TEMAS</div>
                    <div style="font-size: 18px; margin: 5px 0;">${Object.keys(myBank).length}</div>
                    <div style="color: #a1a1aa;">${isHost ? 'Anfitri√≥n' : 'Invitado'}</div>
                </div>
                <div style="text-align: center; border-left: 1px solid #4b5563; border-right: 1px solid #4b5563;">
                    <div style="color: #f59e0b; font-weight: bold;">OPONENTE</div>
                    <div style="font-size: 18px; margin: 5px 0;">${opponent ? opponent.name : 'N/A'}</div>
                    <div style="color: #a1a1aa;">${opponent ? (!isHost ? 'Anfitri√≥n' : 'Invitado') : 'Desconocido'}</div>
                </div>
                <div style="text-align: center;">
                    <div style="color: #ef4444; font-weight: bold;">SUS TEMAS</div>
                    <div style="font-size: 18px; margin: 5px 0;">${Object.keys(opponentBank).length}</div>
                    <div style="color: ${Object.keys(opponentBank).length > 0 ? '#22c55e' : '#ef4444'};">
                        ${Object.keys(opponentBank).length > 0 ? '‚úì Sincronizado' : '‚úó Sin sync'}
                    </div>
                </div>
            </div>
        </div>

        <!-- Interfaz de 3 franjas -->
        <div style="display: grid; grid-template-columns: 350px 1fr 350px; gap: 20px; min-height: 500px;">
            
            <!-- FRANJA IZQUIERDA: MIS TEMAS -->
            <div style="background: linear-gradient(135deg, #f0fdf4, #ecfdf5); border: 2px solid #22c55e; border-radius: 12px; overflow-y: auto; max-height: 600px;">
                <div style="padding: 15px; border-bottom: 2px solid #22c55e; background: linear-gradient(135deg, #22c55e, #16a34a); color: white; text-align: center;">
                    <h3 style="margin: 0; font-size: 16px;">${isHost ? 'üëë ANFITRI√ìN' : 'üë§ INVITADO'}</h3>
                    <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.9;">${state.currentUser.name} (T√ö)</p>
                    <div style="margin-top: 8px;">
                        <span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 10px; font-size: 12px;">
                            ‚ùå ${myFailures}/3 Fallos
                        </span>
                    </div>
                </div>
                <div style="padding: 15px;">
                    <div style="font-size: 13px; color: #16a34a; margin-bottom: 15px; text-align: center; font-weight: 600; text-transform: uppercase;">
                        Mis Temas (${Object.keys(myBank).length})
                    </div>
                    ${renderMyTopics(myBank)}
                </div>
            </div>

            <!-- FRANJA CENTRAL: Pregunta actual -->
            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; display: flex; flex-direction: column;">
                <div style="padding: 20px; border-bottom: 2px solid #e2e8f0; background: linear-gradient(135deg, #f8fafc, #e2e8f0); text-align: center;">
                    <h3 style="margin: 0; color: #374151; font-size: 18px;">üìã Pregunta Actual</h3>
                </div>
                <div style="flex: 1; padding: 25px; display: flex; align-items: center; justify-content: center;">
                    ${currentQuestion ? renderCurrentQuestion(currentQuestion, !myTurn) : `
                        <div style="text-align: center; color: #9ca3af;">
                            <div style="font-size: 4rem; margin-bottom: 20px;">üéØ</div>
                            <h3 style="color: #6b7280; margin: 0 0 10px 0;">Esperando pregunta</h3>
                            <p style="margin: 0; font-size: 14px;">
                                ${myTurn ? 'Selecciona una pregunta de los temas del oponente (panel derecho)' : 'Tu oponente est√° seleccionando una pregunta'}
                            </p>
                        </div>
                    `}
                </div>
            </div>

            <!-- FRANJA DERECHA: TEMAS DEL OPONENTE -->
            <div style="background: ${myTurn ? 'linear-gradient(135deg, #fef3c7, #fbbf24)' : 'linear-gradient(135deg, #f8fafc, #e2e8f0)'}; border: 2px solid ${myTurn ? '#f59e0b' : '#9ca3af'}; border-radius: 12px; overflow-y: auto; max-height: 600px;">
                <div style="padding: 15px; border-bottom: 2px solid ${myTurn ? '#f59e0b' : '#9ca3af'}; background: ${myTurn ? 'linear-gradient(135deg, #f59e0b, #d97706)' : 'linear-gradient(135deg, #6b7280, #4b5563)'}; color: white; text-align: center;">
                    <h3 style="margin: 0; font-size: 16px;">${!isHost ? 'üëë ANFITRI√ìN' : 'üë§ INVITADO'}</h3>
                    <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.9;">${opponent ? opponent.name : 'Oponente'}</p>
                    <div style="margin-top: 8px;">
                        <span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 10px; font-size: 12px;">
                            ‚ùå ${opponentFailures}/3 Fallos
                        </span>
                    </div>
                </div>
                <div style="padding: 15px;">
                    <div style="font-size: 13px; color: ${myTurn ? '#92400e' : '#6b7280'}; margin-bottom: 15px; text-align: center; font-weight: 600; text-transform: uppercase;">
                        ${myTurn ? 'üéØ Selecciona pregunta' : 'Temas del oponente'} (${Object.keys(opponentBank).length})
                    </div>
                    ${Object.keys(opponentBank).length === 0 ? `
                        <div style="text-align: center; padding: 40px 20px; color: #dc2626;">
                            <div style="font-size: 2rem; margin-bottom: 15px;">‚ö†Ô∏è</div>
                            <p style="margin: 0; font-size: 14px; font-weight: bold;">Sin temas del oponente</p>
                            <p style="margin: 10px 0; font-size: 12px;">Problema de sincronizaci√≥n</p>
                            <button onclick="forceResync()" style="padding: 8px 16px; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                üîÑ Resincronizar
                            </button>
                        </div>
                    ` : renderOpponentTopicsForSelection(opponentBank, myTurn)}
                </div>
            </div>
        </div>

        <!-- Botones de control -->
        <div style="text-align: center; margin-top: 25px;">
            <button onclick="leaveRoom()" class="btn btn-danger" style="padding: 12px 24px; margin-right: 10px;">
                üö™ Salir del Duelo
            </button>
            <button onclick="forceResync()" class="btn btn-info" style="padding: 12px 24px;">
                üîÑ Forzar Resync
            </button>
        </div>
    </div>
    `;
}

// PASO 8: Funciones de renderizado (mantenidas)
function renderMyTopics(questionBank) {
    if (!questionBank || Object.keys(questionBank).length === 0) {
        return `
            <div style="text-align: center; padding: 30px 20px; color: #dc2626;">
                <div style="font-size: 2rem; margin-bottom: 10px;">‚ö†Ô∏è</div>
                <p style="margin: 0; font-size: 14px; font-weight: bold;">Sin temas disponibles</p>
                <p style="margin: 10px 0 0 0; font-size: 12px;">Crea y verifica preguntas primero</p>
            </div>
        `;
    }

    let html = '';
    Object.keys(questionBank).forEach(topicKey => {
        const topic = questionBank[topicKey];
        if (topic.questions && topic.questions.length > 0) {
            html += `
                <div style="margin-bottom: 12px; border: 2px solid #16a34a; border-radius: 10px; overflow: hidden; background: rgba(34, 197, 94, 0.1);">
                    <div style="background: linear-gradient(135deg, #dcfce7, #bbf7d0); padding: 12px; border-bottom: 1px solid #16a34a; cursor: pointer;" onclick="toggleTopicQuestions('my-${topicKey}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; color: #15803d; font-size: 14px;">${topic.name}</span>
                            <span style="background: #16a34a; color: white; padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                ${topic.questions.length}
                            </span>
                        </div>
                    </div>
                    <div id="my-questions-${topicKey}" style="display: none; max-height: 200px; overflow-y: auto; background: white;">
                        ${topic.questions.map((question, index) => `
                            <div style="padding: 10px 12px; border-bottom: 1px solid #f3f4f6; font-size: 12px; line-height: 1.5;">
                                <div style="display: flex; align-items: flex-start; gap: 8px;">
                                    <span style="background: #16a34a; color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 10px; min-width: 24px; text-align: center;">P${index + 1}</span>
                                    <span style="color: #374151; flex: 1;">${question.question.length > 80 ? question.question.substring(0, 80) + '...' : question.question}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
    });

    return html;
}

function renderOpponentTopicsForSelection(questionBank, canSelect) {
    if (!questionBank || Object.keys(questionBank).length === 0) {
        return `
            <div style="text-align: center; padding: 40px 20px; color: #6b7280;">
                <div style="font-size: 2rem; margin-bottom: 15px;">‚è≥</div>
                <p style="margin: 0; font-size: 14px;">Esperando temas del oponente...</p>
                <p style="margin: 10px 0 0 0; font-size: 12px; opacity: 0.7;">Puede tardar unos segundos</p>
            </div>
        `;
    }

    let html = '';
    Object.keys(questionBank).forEach(topicKey => {
        const topic = questionBank[topicKey];
        if (topic.questions && topic.questions.length > 0) {
            html += `
                <div style="margin-bottom: 12px; border: 2px solid ${canSelect ? '#f59e0b' : '#d1d5db'}; border-radius: 10px; overflow: hidden; ${canSelect ? 'box-shadow: 0 4px 8px rgba(245,158,11,0.3);' : ''}">
                    <div style="background: ${canSelect ? 'linear-gradient(135deg, #fef3c7, #fde68a)' : 'linear-gradient(135deg, #f9fafb, #f3f4f6)'}; padding: 12px; border-bottom: 1px solid ${canSelect ? '#f59e0b' : '#d1d5db'}; cursor: pointer;" onclick="toggleTopicQuestions('opponent-${topicKey}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; color: ${canSelect ? '#92400e' : '#374151'}; font-size: 14px;">${topic.name}</span>
                            <span style="background: ${canSelect ? '#f59e0b' : '#9ca3af'}; color: white; padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                ${topic.questions.length}
                            </span>
                        </div>
                        ${canSelect ? `<div style="margin-top: 5px; font-size: 11px; color: #92400e; opacity: 0.8;">üëÜ Clic para expandir y seleccionar preguntas</div>` : ''}
                    </div>
                    <div id="opponent-questions-${topicKey}" style="display: none; max-height: 250px; overflow-y: auto; background: white;">
                        ${topic.questions.map((question, index) => `
                            <div style="padding: 10px 12px; border-bottom: 1px solid #f3f4f6; ${canSelect ? 'cursor: pointer; transition: all 0.2s;' : ''} font-size: 12px; line-height: 1.5;"
                                 ${canSelect ? `onclick="selectQuestionFromOpponent('${topicKey}', '${question.firebaseKey}')" 
                                               onmouseover="this.style.backgroundColor='#fef3c7'; this.style.transform='scale(1.02)'"
                                               onmouseout="this.style.backgroundColor='white'; this.style.transform='scale(1)'"` : ''}>
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 8px;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: flex-start; gap: 8px;">
                                            <span style="background: ${canSelect ? '#f59e0b' : '#9ca3af'}; color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 10px; min-width: 24px; text-align: center;">P${index + 1}</span>
                                            <span style="color: ${canSelect ? '#374151' : '#6b7280'}; flex: 1;">${question.question.length > 70 ? question.question.substring(0, 70) + '...' : question.question}</span>
                                        </div>
                                    </div>
                                    ${canSelect ? `
                                        <div style="text-align: center; margin-left: 8px;">
                                            <div style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: bold; white-space: nowrap;">
                                                ‚û§ SELECCIONAR
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
    });

    return html;
}

// PASO 9: Funciones de control (mantenidas con mejoras)
function toggleTopicQuestions(fullTopicKey) {
    let questionsId;
    
    if (fullTopicKey.startsWith('my-')) {
        const topicKey = fullTopicKey.replace('my-', '');
        questionsId = `my-questions-${topicKey}`;
    } else if (fullTopicKey.startsWith('opponent-')) {
        const topicKey = fullTopicKey.replace('opponent-', '');
        questionsId = `opponent-questions-${topicKey}`;
    } else {
        questionsId = `questions-${fullTopicKey}`;
    }
    
    const questionsDiv = document.getElementById(questionsId);
    if (questionsDiv) {
        const isVisible = questionsDiv.style.display !== 'none';
        questionsDiv.style.display = isVisible ? 'none' : 'block';
        
        // Animaci√≥n suave
        if (!isVisible) {
            questionsDiv.style.opacity = '0';
            questionsDiv.style.transform = 'translateY(-10px)';
            setTimeout(() => {
                questionsDiv.style.transition = 'all 0.3s ease';
                questionsDiv.style.opacity = '1';
                questionsDiv.style.transform = 'translateY(0)';
            }, 10);
        }
    }
}

function selectQuestionFromOpponent(topicKey, questionFirebaseKey) {
    if (!multiplayerState.myTurn) {
        showMessage('No es tu turno para seleccionar preguntas', 'warning');
        return;
    }

    const opponentBank = getOpponentQuestionBank();
    if (!opponentBank[topicKey] || !opponentBank[topicKey].questions) {
        console.error('‚ùå Tema no encontrado:', topicKey);
        showMessage('Error: Tema no encontrado', 'error');
        return;
    }

    const question = opponentBank[topicKey].questions.find(q => q.firebaseKey === questionFirebaseKey);
    if (!question) {
        console.error('‚ùå Pregunta no encontrada:', questionFirebaseKey);
        showMessage('Error: Pregunta no encontrada', 'error');
        return;
    }

    console.log('üéØ Enviando pregunta al oponente:', {
        topic: opponentBank[topicKey].name,
        question: question.question.substring(0, 50) + '...'
    });

    database.ref('rooms/' + multiplayerState.currentRoom).update({
        'gameData/currentQuestionData': question,
        'gameData/currentTurn': multiplayerState.isHost ? 'guest' : 'host',
        lastActivity: firebase.database.ServerValue.TIMESTAMP
    }).then(() => {
        showMessage(`‚úÖ Pregunta enviada: ${question.question.substring(0, 40)}...`, 'success');
    }).catch(error => {
        console.error('‚ùå Error enviando pregunta:', error);
        showMessage('Error al enviar la pregunta', 'error');
    });
}

// REEMPLAZAR TODAS LAS FUNCIONES GLOBALES
window.getMyQuestionBank = getMyQuestionBank;
window.getOpponentQuestionBank = getOpponentQuestionBank;
window.toggleTopicQuestions = toggleTopicQuestions;
window.selectQuestionFromOpponent = selectQuestionFromOpponent;
window.setupBidirectionalSync = setupBidirectionalSync;
window.forceImmediateSync = forceImmediateSync;

console.log('‚úÖ SOLUCI√ìN DEFINITIVA aplicada correctamente');
console.log('üîÑ Funciones disponibles:');
console.log(' - forceResync(): Resincronizaci√≥n manual completa');
console.log(' - setupBidirectionalSync(): Configurar listeners');
console.log(' - forceImmediateSync(): Sincronizaci√≥n inmediata');
</script>
    <!--
SOLUCI√ìN SUPER AGRESIVA: FORZAR SINCRONIZACI√ìN DIRECTA
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
Esta soluci√≥n VA DIRECTO A FIREBASE sin rodeos ni listeners complicados
-->
<script>
// ========== SOLUCI√ìN SUPER AGRESIVA - ESCRITURA/LECTURA DIRECTA ==========
console.log('üíÄ APLICANDO SOLUCI√ìN SUPER AGRESIVA para sincronizaci√≥n...');

// PASO 1: FUNCI√ìN SUPER AGRESIVA para ESCRIBIR bancos en Firebase
window.forceWriteBankToFirebase = function(isHost) {
    if (!multiplayerState.currentRoom || !database) {
        console.error('‚ùå No hay sala o database');
        return Promise.reject('No hay sala o database');
    }
    
    const verifiedQuestions = state.questions.filter(q => q.isVerified);
    if (verifiedQuestions.length === 0) {
        console.error('‚ùå No hay preguntas verificadas');
        return Promise.reject('No hay preguntas verificadas');
    }
    
    const bankData = organizeQuestionsForFirebase(verifiedQuestions, state.topics);
    const bankKey = isHost ? 'host' : 'guest';
    const roomPath = 'rooms/' + multiplayerState.currentRoom;
    
    console.log('üíæ ESCRIBIENDO BANCO DIRECTAMENTE EN FIREBASE:', {
        bankKey,
        roomPath,
        bankData
    });
    
    // ESCRITURA SUPER DIRECTA - Sin update, con SET
    return database.ref(roomPath + '/questionBanks/' + bankKey).set(bankData)
        .then(() => {
            console.log('‚úÖ Banco escrito correctamente en Firebase:', bankKey);
            
            // Verificar que realmente se escribi√≥
            return database.ref(roomPath + '/questionBanks/' + bankKey).once('value');
        })
        .then((snapshot) => {
            const writtenData = snapshot.val();
            console.log('üîç VERIFICACI√ìN - Datos escritos en Firebase:', writtenData);
            
            if (!writtenData || Object.keys(writtenData).length === 0) {
                throw new Error('Los datos NO se escribieron correctamente');
            }
            
            // Actualizar estado local INMEDIATAMENTE
            if (isHost) {
                multiplayerState.hostQuestionBank = bankData;
            } else {
                multiplayerState.guestQuestionBank = bankData;
            }
            
            return bankData;
        })
        .catch(error => {
            console.error('‚ùå ERROR ESCRIBIENDO BANCO:', error);
            throw error;
        });
};

// PASO 2: FUNCI√ìN SUPER AGRESIVA para LEER todos los bancos desde Firebase
window.forceReadAllBanksFromFirebase = function() {
    if (!multiplayerState.currentRoom || !database) {
        console.error('‚ùå No hay sala o database');
        return Promise.reject('No hay sala o database');
    }
    
    const roomPath = 'rooms/' + multiplayerState.currentRoom;
    
    console.log('üìñ LEYENDO TODOS LOS BANCOS DIRECTAMENTE DESDE FIREBASE...');
    
    return database.ref(roomPath).once('value')
        .then((snapshot) => {
            const roomData = snapshot.val();
            if (!roomData) {
                throw new Error('Sala no encontrada en Firebase');
            }
            
            console.log('üì° DATOS COMPLETOS DE LA SALA:', roomData);
            
            // Extraer bancos
            const hostBank = roomData.questionBanks?.host || {};
            const guestBank = roomData.questionBanks?.guest || {};
            
            console.log('üìö BANCOS LE√çDOS:', {
                hostBank: Object.keys(hostBank),
                guestBank: Object.keys(guestBank),
                hostTopics: Object.keys(hostBank).length,
                guestTopics: Object.keys(guestBank).length
            });
            
            // Actualizar estado local FORZOSAMENTE
            multiplayerState.hostQuestionBank = hostBank;
            multiplayerState.guestQuestionBank = guestBank;
            multiplayerState.opponent = multiplayerState.isHost ? roomData.guest : roomData.host;
            multiplayerState.currentRoomData = roomData;
            
            // Re-renderizar INMEDIATAMENTE
            if (multiplayerState.gameState === 'playing') {
                render();
            }
            
            return {
                hostBank,
                guestBank,
                opponent: multiplayerState.opponent
            };
        })
        .catch(error => {
            console.error('‚ùå ERROR LEYENDO BANCOS:', error);
            throw error;
        });
};

// PASO 3: REEMPLAZAR COMPLETAMENTE joinMultiplayerRoom con escritura agresiva
window.joinMultiplayerRoom = function() {
    console.log('üö™ UNI√ìN SUPER AGRESIVA iniciada...');
    
    if (!multiplayerEnabled) {
        showMessage('Error: Sistema multijugador no disponible', 'error');
        return;
    }
    
    if (!state.currentUser) {
        showMessage('Debes estar logueado para unirte a una sala', 'error');
        return;
    }
    
    const verifiedQuestions = state.questions.filter(q => q.isVerified);
    if (verifiedQuestions.length < 5) {
        showMessage('Necesitas al menos 5 preguntas verificadas para unirte a una sala', 'error');
        return;
    }
    
    const roomCode = prompt('Ingresa el c√≥digo de la sala (6 caracteres):');
    if (!roomCode || roomCode.length !== 6) {
        showMessage('C√≥digo de sala inv√°lido', 'error');
        return;
    }
    
    const upperRoomCode = roomCode.toUpperCase();
    
    showMessage('Uni√©ndose a la sala...', 'info');
    
    // PASO 1: Verificar que la sala existe
    database.ref('rooms/' + upperRoomCode).once('value')
        .then((snapshot) => {
            if (!snapshot.exists()) {
                throw new Error('La sala no existe');
            }
            
            const roomData = snapshot.val();
            if (roomData.status !== 'waiting') {
                throw new Error('La sala no est√° disponible');
            }
            
            if (roomData.guest !== null) {
                throw new Error('La sala est√° llena');
            }
            
            if (roomData.host.username === state.currentUser.username) {
                throw new Error('No puedes unirte a tu propia sala');
            }
            
            console.log('‚úÖ Sala v√°lida, procediendo con uni√≥n...');
            
            // PASO 2: Preparar datos del invitado
            const guestData = {
                username: state.currentUser.username,
                name: state.currentUser.name,
                questions: verifiedQuestions.length,
                ready: false
            };
            
            // PASO 3: Actualizar informaci√≥n del invitado en Firebase (SIN banco a√∫n)
            return database.ref('rooms/' + upperRoomCode + '/guest').set(guestData);
        })
        .then(() => {
            console.log('‚úÖ Informaci√≥n del invitado guardada, actualizando estado local...');
            
            // Actualizar estado local
            multiplayerState.currentRoom = upperRoomCode;
            multiplayerState.isHost = false;
            multiplayerState.roomCode = upperRoomCode;
            multiplayerState.gameState = 'waiting';
            
            // Configurar listener b√°sico para la sala
            listenToRoom(upperRoomCode);
            
            render();
            showMessage(`Te has unido a la sala: ${upperRoomCode}`, 'success');
            
            // PASO 4: ESCRIBIR BANCO DEL INVITADO DE FORMA AGRESIVA (despu√©s de unirse)
            console.log('üíæ ESCRIBIENDO BANCO DEL INVITADO DE FORMA AGRESIVA...');
            return forceWriteBankToFirebase(false); // false = invitado
        })
        .then(() => {
            console.log('‚úÖ Banco del invitado escrito correctamente');
            showMessage('Banco de preguntas sincronizado correctamente', 'success');
            
            // Verificar lectura inmediata
            setTimeout(() => {
                forceReadAllBanksFromFirebase()
                    .then(() => {
                        console.log('‚úÖ Verificaci√≥n post-uni√≥n completada');
                    });
            }, 2000);
        })
        .catch((error) => {
            console.error('‚ùå Error en uni√≥n agresiva:', error);
            showMessage('Error: ' + error.message, 'error');
        });
};

// PASO 4: REEMPLAZAR COMPLETAMENTE createMultiplayerRoom con escritura agresiva
window.createMultiplayerRoom = function() {
    console.log('üè† CREACI√ìN SUPER AGRESIVA iniciada...');
    
    if (!multiplayerEnabled) {
        showMessage('Error: Sistema multijugador no disponible', 'error');
        return;
    }
    
    if (!state.currentUser) {
        showMessage('Debes estar logueado para crear una sala', 'error');
        return;
    }
    
    const verifiedQuestions = state.questions.filter(q => q.isVerified);
    if (verifiedQuestions.length < 5) {
        showMessage('Necesitas al menos 5 preguntas verificadas para crear una sala', 'error');
        return;
    }
    
    const roomCode = generateRoomCode();
    
    showMessage('Creando sala...', 'info');
    
    // PASO 1: Crear sala b√°sica SIN bancos de preguntas
    const roomData = {
        code: roomCode,
        host: {
            username: state.currentUser.username,
            name: state.currentUser.name,
            questions: verifiedQuestions.length,
            ready: false
        },
        guest: null,
        hostReady: false,
        guestReady: false,
        status: 'waiting',
        questionBanks: {}, // Vac√≠o inicialmente
        gameData: {
            currentQuestion: 0,
            currentTurn: 'host',
            hostFailures: 0,
            guestFailures: 0,
            currentQuestionData: null,
            hostAnswers: {},
            guestAnswers: {},
            winner: null
        },
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        lastActivity: firebase.database.ServerValue.TIMESTAMP
    };
    
    database.ref('rooms/' + roomCode).set(roomData)
        .then(() => {
            console.log('‚úÖ Sala b√°sica creada, actualizando estado local...');
            
            // Actualizar estado local
            multiplayerState.currentRoom = roomCode;
            multiplayerState.isHost = true;
            multiplayerState.roomCode = roomCode;
            multiplayerState.gameState = 'waiting';
            
            // Configurar listener b√°sico
            listenToRoom(roomCode);
            
            render();
            showMessage(`Sala creada con c√≥digo: ${roomCode}`, 'success');
            
            // PASO 2: ESCRIBIR BANCO DEL ANFITRI√ìN DE FORMA AGRESIVA
            console.log('üíæ ESCRIBIENDO BANCO DEL ANFITRI√ìN DE FORMA AGRESIVA...');
            return forceWriteBankToFirebase(true); // true = anfitri√≥n
        })
        .then(() => {
            console.log('‚úÖ Banco del anfitri√≥n escrito correctamente');
            showMessage('Banco de preguntas del anfitri√≥n sincronizado', 'success');
        })
        .catch((error) => {
            console.error('‚ùå Error en creaci√≥n agresiva:', error);
            showMessage('Error al crear la sala: ' + error.message, 'error');
        });
};

// PASO 5: FUNCI√ìN de resincronizaci√≥n SUPER AGRESIVA
window.forceResync = function() {
    console.log('üîÑ RESINCRONIZACI√ìN SUPER AGRESIVA iniciada...');
    
    if (!multiplayerState.currentRoom) {
        alert('‚ùå No est√°s en una sala');
        return;
    }
    
    showMessage('Resincronizando...', 'info');
    
    // PASO 1: Escribir mi banco
    forceWriteBankToFirebase(multiplayerState.isHost)
        .then(() => {
            console.log('‚úÖ Mi banco reescrito');
            
            // PASO 2: Leer todos los bancos
            return forceReadAllBanksFromFirebase();
        })
        .then((result) => {
            console.log('‚úÖ Todos los bancos rele√≠dos:', result);
            
            const myBankCount = multiplayerState.isHost ? 
                Object.keys(result.hostBank).length : 
                Object.keys(result.guestBank).length;
            
            const opponentBankCount = multiplayerState.isHost ? 
                Object.keys(result.guestBank).length : 
                Object.keys(result.hostBank).length;
            
            showMessage(`Resincronizaci√≥n completada: Mis temas: ${myBankCount}, Oponente: ${opponentBankCount}`, 'success');
            
            alert(`üîÑ RESINCRONIZACI√ìN COMPLETADA
            
Mis temas: ${myBankCount}
Temas del oponente: ${opponentBankCount}
Oponente: ${result.opponent?.name || 'No encontrado'}

${opponentBankCount > 0 ? '‚úÖ Sincronizaci√≥n exitosa' : '‚ùå A√∫n sin temas del oponente'}`);
        })
        .catch(error => {
            console.error('‚ùå Error en resincronizaci√≥n:', error);
            showMessage('Error en resincronizaci√≥n: ' + error.message, 'error');
            alert('‚ùå Error en resincronizaci√≥n: ' + error.message);
        });
};

// PASO 6: POLLING AGRESIVO cada 10 segundos si estamos en duelo
let pollingInterval = null;

function startAggressivePolling() {
    if (pollingInterval) clearInterval(pollingInterval);
    
    pollingInterval = setInterval(() => {
        if (multiplayerState.gameState === 'playing' && multiplayerState.currentRoom) {
            console.log('üîÑ Polling agresivo - leyendo bancos...');
            
            forceReadAllBanksFromFirebase()
                .then(() => {
                    console.log('‚úÖ Polling exitoso');
                })
                .catch(error => {
                    console.warn('‚ö†Ô∏è Error en polling:', error.message);
                });
        }
    }, 10000); // Cada 10 segundos
}

function stopAggressivePolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
    }
}

// PASO 7: INTERFAZ MEJORADA con informaci√≥n de estado
function renderDuelInterface() {
    const isHost = multiplayerState.isHost;
    const opponent = multiplayerState.opponent;
    const myTurn = multiplayerState.myTurn;
    const myFailures = multiplayerState.myFailures || 0;
    const opponentFailures = multiplayerState.opponentFailures || 0;
    const myBank = multiplayerState.isHost ? 
        (multiplayerState.hostQuestionBank || {}) : 
        (multiplayerState.guestQuestionBank || {});
    
    const opponentBank = multiplayerState.isHost ? 
        (multiplayerState.guestQuestionBank || {}) : 
        (multiplayerState.hostQuestionBank || {});
    const currentQuestion = multiplayerState.currentRoomData?.gameData?.currentQuestionData || null;
    
    // Iniciar polling si no est√° activo
    if (!pollingInterval) startAggressivePolling();
    
    return `
    <div style="max-width: 1400px; margin: 0 auto; padding: 20px; min-height: calc(100vh - 200px);">
        <!-- Header del duelo -->
        <div style="text-align: center; margin-bottom: 25px; background: linear-gradient(135deg, #dc2626, #7f1d1d); color: white; padding: 20px; border-radius: 16px;">
            <h1 style="margin: 0 0 10px 0; font-size: 2rem; font-weight: 800;">‚öîÔ∏è Duelo de Preguntas</h1>
            <div style="font-size: 1.8rem; font-weight: bold; letter-spacing: 2px; margin: 5px 0;">
                ${multiplayerState.roomCode}
            </div>
            <p style="margin: 0; opacity: 0.9; font-size: 14px;">
                ${myTurn ? 'Tu turno: Selecciona una pregunta del oponente' : 'Esperando respuesta del oponente'}
            </p>
        </div>
        
        <!-- Panel de turnos simple -->
        <div style="background: linear-gradient(135deg, #f8fafc, #e2e8f0); padding: 20px; margin-bottom: 20px; border-radius: 12px; border: 2px solid #e2e8f0;">
            <div style="text-align: center;">
                ${(() => {
                    const gameData = multiplayerState.currentRoomData?.gameData;
                    const waitingForAnswer = gameData?.waitingForAnswer;
                    const showingResult = gameData?.showingResult;
                    const currentResponse = gameData?.currentResponse;
                    
                    // Si se est√° mostrando el resultado de una respuesta
                    if (showingResult && currentResponse) {
                        const resultColor = currentResponse.isCorrect ? '#10b981' : '#ef4444';
                        const resultIcon = currentResponse.isCorrect ? '‚úÖ' : '‚ùå';
                        const resultText = currentResponse.isCorrect ? 'RESPUESTA CORRECTA' : 'RESPUESTA INCORRECTA';
                        
                        return `
                            <div style="display: inline-block; background: ${resultColor}; color: white; padding: 15px 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                                <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">${resultIcon} ${resultText}</div>
                                <div style="font-size: 14px; opacity: 0.9;">Cambiando turno en unos segundos...</div>
                            </div>
                        `;
                    }
                    
                    // Si se est√° esperando respuesta a una pregunta
                    if (waitingForAnswer) {
                        return `
                            <div style="display: inline-block; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 15px 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">
                                <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">‚è≥ ESPERANDO RESPUESTA</div>
                                <div style="font-size: 14px; opacity: 0.9;">${opponent ? opponent.name : 'Tu oponente'} est√° respondiendo la pregunta</div>
                            </div>
                        `;
                    }
                    
                    // Estados normales de turno
                    if (myTurn) {
                        return `
                            <div style="display: inline-block; background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 15px 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                                <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">üéØ ES TU TURNO</div>
                                <div style="font-size: 14px; opacity: 0.9;">Selecciona una pregunta del panel derecho para ${opponent ? opponent.name : 'tu oponente'}</div>
                            </div>
                        `;
                    } else {
                        return `
                            <div style="display: inline-block; background: linear-gradient(135deg, #6b7280, #4b5563); color: white; padding: 15px 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);">
                                <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">‚è≥ TURNO DEL OPONENTE</div>
                                <div style="font-size: 14px; opacity: 0.9;">${opponent ? opponent.name : 'Tu oponente'} est√° seleccionando una pregunta</div>
                            </div>
                        `;
                    }
                })()}
            </div>
        </div>

        <!-- Layout de 3 franjas -->
        <div style="display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 25px; align-items: start;">
            
            <!-- FRANJA IZQUIERDA: Informaci√≥n del anfitri√≥n/invitado -->
            <div style="background: ${isHost ? 'linear-gradient(135deg, #22c55e, #16a34a)' : 'linear-gradient(135deg, #6b7280, #4b5563)'}; color: white; padding: 20px; border-radius: 16px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                <div style="text-align: center;">
                    <div style="font-size: 2rem; margin-bottom: 10px;">${isHost ? 'üëë' : 'üéÆ'}</div>
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">${isHost ? 'ANFITRI√ìN' : 'INVITADO'}</div>
                    <div style="font-size: 16px; margin-bottom: 15px; opacity: 0.9;">${state.currentUser.name}</div>
                    <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 12px;">
                        <div style="font-size: 14px; opacity: 0.8; margin-bottom: 5px;">Fallos</div>
                        <div style="font-size: 24px; font-weight: bold;">‚ùå ${myFailures}/3</div>
                    </div>
                </div>
                
                ${Object.keys(myBank).length > 0 ? `
                    <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 12px;">
                        <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px; text-align: center;">üìö MIS TEMAS (${Object.keys(myBank).length})</div>
                        ${Object.entries(myBank).map(([topicKey, topic]) => `
                            <div style="margin-bottom: 8px; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 6px; font-size: 12px;">
                                <div style="font-weight: 500;">${topic.name}</div>
                                <div style="opacity: 0.7;">${topic.questions.length} pregunta${topic.questions.length !== 1 ? 's' : ''}</div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
            
            <!-- FRANJA CENTRAL: Pregunta actual -->
            <div style="background: white; border: 2px solid #e5e7eb; border-radius: 16px; padding: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); display: flex; align-items: center; justify-content: center; min-height: 400px;">
                ${currentQuestion ? renderCurrentQuestion(currentQuestion, !myTurn && !multiplayerState.currentRoomData?.gameData?.showingResult) : `
                    <div style="text-align: center; color: #6b7280;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">‚ùì</div>
                        <div style="font-size: 18px; font-weight: 500; margin-bottom: 10px;">No hay pregunta activa</div>
                        <div style="font-size: 14px; opacity: 0.7;">${myTurn ? 'Selecciona una pregunta del panel derecho' : 'Esperando que el oponente seleccione una pregunta'}</div>
                    </div>
                `}
            </div>
            
            <!-- FRANJA DERECHA: Informaci√≥n del oponente -->
            <div style="background: ${!isHost ? 'linear-gradient(135deg, #f59e0b, #d97706)' : 'linear-gradient(135deg, #6b7280, #4b5563)'}; color: white; padding: 20px; border-radius: 16px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                <div style="text-align: center;">
                    <div style="font-size: 2rem; margin-bottom: 10px;">${!isHost ? 'üëë' : 'üéÆ'}</div>
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">${!isHost ? 'ANFITRI√ìN' : 'INVITADO'}</div>
                    <div style="font-size: 16px; margin-bottom: 15px; opacity: 0.9;">${opponent ? opponent.name : 'Esperando...'}</div>
                    <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 12px;">
                        <div style="font-size: 14px; opacity: 0.8; margin-bottom: 5px;">Fallos</div>
                        <div style="font-size: 24px; font-weight: bold;">‚ùå ${opponentFailures}/3</div>
                    </div>
                </div>
                
                ${Object.keys(opponentBank).length > 0 ? `
                    <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 12px;">
                        <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px; text-align: center; color: ${myTurn ? '#ffffff' : '#cccccc'};">
                            ${myTurn ? 'üéØ' : 'üîí'} ${myTurn ? 'SELECCIONA PREGUNTA' : 'SUS TEMAS'} (${Object.keys(opponentBank).length})
                        </div>
                        ${Object.entries(opponentBank).map(([topicKey, topic]) => {
                            const canSelect = myTurn && !multiplayerState.currentRoomData?.gameData?.waitingForAnswer;
                            return `
                                <div style="margin-bottom: 8px; opacity: ${canSelect ? '1' : '0.5'};">
                                    <div style="padding: 8px; background: rgba(255,255,255,0.1); border-radius: 6px; cursor: ${canSelect ? 'pointer' : 'default'};" 
                                         ${canSelect ? `onclick="toggleTopicQuestions('${topicKey}')"` : ''}>
                                        <div style="display: flex; align-items: center; justify-content: space-between; font-size: 12px;">
                                            <span style="font-weight: 500;">${topic.name}</span>
                                            <span style="background: #ffffff20; padding: 2px 6px; border-radius: 10px;">${topic.questions.length}</span>
                                        </div>
                                    </div>
                                    <div id="questions-${topicKey}" style="display: none; margin-top: 5px; max-height: 150px; overflow-y: auto;">
                                        ${topic.questions.map((question, index) => {
                                            const questionCanSelect = canSelect;
                                            return `
                                                <div style="padding: 6px 8px; background: rgba(255,255,255,0.05); border-radius: 4px; margin-bottom: 3px; cursor: ${questionCanSelect ? 'pointer' : 'default'}; font-size: 10px; line-height: 1.3;" 
                                                     ${questionCanSelect ? `onclick="selectQuestionFromOpponent('${topicKey}', '${question.firebaseKey}')"` : ''}
                                                     ${questionCanSelect ? `onmouseover="this.style.background='rgba(255,255,255,0.15)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'"` : ''}>
                                                    <div style="display: flex; align-items: center; gap: 6px;">
                                                        <span style="background: ${questionCanSelect ? '#f59e0b' : '#9ca3af'}; color: white; padding: 3px 6px; border-radius: 4px; font-weight: bold; font-size: 9px; min-width: 20px; text-align: center;">P${index + 1}</span>
                                                        <span style="color: ${questionCanSelect ? '#ffffff' : '#cccccc'}; flex: 1; font-size: 9px;">${question.question.length > 50 ? question.question.substring(0, 50) + '...' : question.question}</span>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : ''}
            </div>
        </div>
        
        <!-- Botones de control -->
        <div style="text-align: center; margin-top: 30px; display: flex; justify-content: center; gap: 15px;">
            <button onclick="leaveRoom()" class="btn btn-danger" style="padding: 12px 25px; font-size: 16px;">
                üö™ Salir del Duelo
            </button>
            <button onclick="forceResync()" class="btn btn-secondary" style="padding: 12px 25px; font-size: 16px;">
                üîÑ Resync Agresivo
            </button>
            <button onclick="diagnoseRoom()" class="btn btn-info" style="padding: 12px 25px; font-size: 16px;">
                üîç Leer Firebase
            </button>
        </div>
    </div>
    `;
}

// PASO 8: Funciones de renderizado (b√°sicas, sin cambios)
function renderMyTopics(questionBank) {
    if (!questionBank || Object.keys(questionBank).length === 0) {
        return `
            <div style="text-align: center; padding: 40px 20px; color: #dc2626;">
                <div style="font-size: 3rem; margin-bottom: 15px;">‚ö†Ô∏è</div>
                <p style="margin: 0; font-size: 16px; font-weight: bold;">Sin temas disponibles</p>
                <p style="margin: 15px 0 0 0; font-size: 14px;">Crea y verifica preguntas primero</p>
            </div>
        `;
    }

    let html = '';
    Object.keys(questionBank).forEach(topicKey => {
        const topic = questionBank[topicKey];
        if (topic.questions && topic.questions.length > 0) {
            html += `
                <div style="margin-bottom: 15px; border: 2px solid #22c55e; border-radius: 12px; overflow: hidden; background: rgba(34, 197, 94, 0.1); box-shadow: 0 2px 8px rgba(34, 197, 94, 0.2);">
                    <div style="background: linear-gradient(135deg, #dcfce7, #bbf7d0); padding: 15px; border-bottom: 1px solid #22c55e; cursor: pointer;" onclick="toggleTopicQuestions('my-${topicKey}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 700; color: #15803d; font-size: 15px;">${topic.name}</span>
                            <span style="background: #22c55e; color: white; padding: 4px 10px; border-radius: 14px; font-size: 13px; font-weight: bold;">
                                ${topic.questions.length}
                            </span>
                        </div>
                    </div>
                    <div id="my-questions-${topicKey}" style="display: none; max-height: 220px; overflow-y: auto; background: white;">
                        ${topic.questions.map((question, index) => `
                            <div style="padding: 12px 15px; border-bottom: 1px solid #f3f4f6; font-size: 13px; line-height: 1.6;">
                                <div style="display: flex; align-items: flex-start; gap: 10px;">
                                    <span style="background: #22c55e; color: white; padding: 3px 8px; border-radius: 6px; font-weight: bold; font-size: 11px; min-width: 28px; text-align: center;">P${index + 1}</span>
                                    <span style="color: #374151; flex: 1;">${question.question.length > 85 ? question.question.substring(0, 85) + '...' : question.question}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
    });

    return html;
}

function renderOpponentTopicsForSelection(questionBank, canSelect) {
    if (!questionBank || Object.keys(questionBank).length === 0) {
        return `
            <div style="text-align: center; padding: 50px 20px; color: #6b7280;">
                <div style="font-size: 4rem; margin-bottom: 20px;">‚è≥</div>
                <p style="margin: 0; font-size: 18px; font-weight: bold;">Esperando temas del oponente...</p>
                <p style="margin: 15px 0 0 0; font-size: 14px; opacity: 0.8;">La sincronizaci√≥n puede tardar unos segundos</p>
            </div>
        `;
    }

    let html = '';
    Object.keys(questionBank).forEach(topicKey => {
        const topic = questionBank[topicKey];
        if (topic.questions && topic.questions.length > 0) {
            html += `
                <div style="margin-bottom: 15px; border: 2px solid ${canSelect ? '#f59e0b' : '#d1d5db'}; border-radius: 12px; overflow: hidden; ${canSelect ? 'box-shadow: 0 4px 12px rgba(245,158,11,0.4);' : 'box-shadow: 0 2px 8px rgba(0,0,0,0.1);'}">
                    <div style="background: ${canSelect ? 'linear-gradient(135deg, #fef3c7, #fde68a)' : 'linear-gradient(135deg, #f9fafb, #f3f4f6)'}; padding: 15px; border-bottom: 1px solid ${canSelect ? '#f59e0b' : '#d1d5db'}; cursor: pointer;" onclick="toggleTopicQuestions('opponent-${topicKey}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 700; color: ${canSelect ? '#92400e' : '#374151'}; font-size: 15px;">${topic.name}</span>
                            <span style="background: ${canSelect ? '#f59e0b' : '#9ca3af'}; color: white; padding: 4px 10px; border-radius: 14px; font-size: 13px; font-weight: bold;">
                                ${topic.questions.length}
                            </span>
                        </div>
                        ${canSelect ? `<div style="margin-top: 8px; font-size: 12px; color: #92400e; opacity: 0.9; font-weight: 600;">üëÜ Clic para expandir y seleccionar preguntas</div>` : ''}
                    </div>
                    <div id="opponent-questions-${topicKey}" style="display: none; max-height: 280px; overflow-y: auto; background: white;">
                        ${topic.questions.map((question, index) => `
                            <div style="padding: 12px 15px; border-bottom: 1px solid #f3f4f6; ${canSelect ? 'cursor: pointer; transition: all 0.2s;' : ''} font-size: 13px; line-height: 1.6;"
                                 ${canSelect ? `onclick="selectQuestionFromOpponent('${topicKey}', '${question.firebaseKey}')" 
                                               onmouseover="this.style.backgroundColor='#fef3c7'; this.style.transform='scale(1.02)'"
                                               onmouseout="this.style.backgroundColor='white'; this.style.transform='scale(1)'"` : ''}>
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 10px;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: flex-start; gap: 10px;">
                                            <span style="background: ${canSelect ? '#f59e0b' : '#9ca3af'}; color: white; padding: 3px 8px; border-radius: 6px; font-weight: bold; font-size: 11px; min-width: 28px; text-align: center;">P${index + 1}</span>
                                            <span style="color: ${canSelect ? '#374151' : '#6b7280'}; flex: 1;">${question.question.length > 75 ? question.question.substring(0, 75) + '...' : question.question}</span>
                                        </div>
                                    </div>
                                    ${canSelect ? `
                                        <div style="text-align: center; margin-left: 10px;">
                                            <div style="background: #f59e0b; color: white; padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: bold; white-space: nowrap;">
                                                ‚û§ SELECCIONAR
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
    });

    return html;
}

// PASO 9: Funciones de control (b√°sicas)
function toggleTopicQuestions(fullTopicKey) {
    let questionsId;
    
    if (fullTopicKey.startsWith('my-')) {
        const topicKey = fullTopicKey.replace('my-', '');
        questionsId = `my-questions-${topicKey}`;
    } else if (fullTopicKey.startsWith('opponent-')) {
        const topicKey = fullTopicKey.replace('opponent-', '');
        questionsId = `opponent-questions-${topicKey}`;
    } else {
        questionsId = `questions-${fullTopicKey}`;
    }
    
    const questionsDiv = document.getElementById(questionsId);
    if (questionsDiv) {
        questionsDiv.style.display = questionsDiv.style.display === 'none' ? 'block' : 'none';
    }
}

function selectQuestionFromOpponent(topicKey, questionFirebaseKey) {
    if (!multiplayerState.myTurn) {
        showMessage('No es tu turno para seleccionar preguntas', 'warning');
        return;
    }

    const opponentBank = multiplayerState.isHost ? 
        (multiplayerState.guestQuestionBank || {}) : 
        (multiplayerState.hostQuestionBank || {});
    
    if (!opponentBank[topicKey] || !opponentBank[topicKey].questions) {
        console.error('‚ùå Tema no encontrado:', topicKey);
        showMessage('Error: Tema no encontrado', 'error');
        return;
    }

    const question = opponentBank[topicKey].questions.find(q => q.firebaseKey === questionFirebaseKey);
    if (!question) {
        console.error('‚ùå Pregunta no encontrada:', questionFirebaseKey);
        showMessage('Error: Pregunta no encontrada', 'error');
        return;
    }

    console.log('üéØ Enviando pregunta al oponente:', {
        topic: opponentBank[topicKey].name,
        question: question.question.substring(0, 50) + '...'
    });

    // CAMBIO CLAVE: No cambiar el turno, solo poner la pregunta y marcar que est√° esperando respuesta
    database.ref('rooms/' + multiplayerState.currentRoom).update({
        'gameData/currentQuestionData': question,
        'gameData/waitingForAnswer': true, // Nuevo campo para indicar que se espera respuesta
        'gameData/questionAsker': multiplayerState.isHost ? 'host' : 'guest', // Quien hizo la pregunta
        lastActivity: firebase.database.ServerValue.TIMESTAMP
    }).then(() => {
        showMessage(`‚úÖ Pregunta enviada: ${question.question.substring(0, 40)}...`, 'success');
    }).catch(error => {
        console.error('‚ùå Error enviando pregunta:', error);
        showMessage('Error al enviar la pregunta', 'error');
    });
}

// REEMPLAZAR TODAS LAS FUNCIONES GLOBALES
window.toggleTopicQuestions = toggleTopicQuestions;
window.selectQuestionFromOpponent = selectQuestionFromOpponent;

// Al salir de la sala, detener polling
const originalLeaveRoom = window.leaveRoom;
window.leaveRoom = function() {
    stopAggressivePolling();
    if (originalLeaveRoom) originalLeaveRoom();
};

console.log('üíÄ SOLUCI√ìN SUPER AGRESIVA aplicada correctamente');
console.log('üõ†Ô∏è Funciones agresivas disponibles:');
console.log(' - forceWriteBankToFirebase(isHost): Escribir banco directo');
console.log(' - forceReadAllBanksFromFirebase(): Leer todos los bancos');
console.log(' - forceResync(): Resincronizaci√≥n completa');
console.log(' - Polling autom√°tico cada 10 segundos');
</script>
    <!--
CORRECCI√ìN R√ÅPIDA: Error "Sala est√° llena" 
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
Esta correcci√≥n arregla la validaci√≥n de sala llena
-->
<script>
// ========== CORRECCI√ìN: VALIDACI√ìN DE SALA MEJORADA ==========
console.log('üîß Aplicando correcci√≥n para error "Sala est√° llena"...');

// REEMPLAZAR joinMultiplayerRoom con validaci√≥n mejorada
window.joinMultiplayerRoom = function() {
    console.log('üö™ UNI√ìN MEJORADA iniciada...');
    
    if (!multiplayerEnabled) {
        showMessage('Error: Sistema multijugador no disponible', 'error');
        return;
    }
    
    if (!state.currentUser) {
        showMessage('Debes estar logueado para unirte a una sala', 'error');
        return;
    }
    
    const verifiedQuestions = state.questions.filter(q => q.isVerified);
    if (verifiedQuestions.length < 5) {
        showMessage('Necesitas al menos 5 preguntas verificadas para unirte a una sala', 'error');
        return;
    }
    
    const roomCode = prompt('Ingresa el c√≥digo de la sala (6 caracteres):');
    if (!roomCode || roomCode.length !== 6) {
        showMessage('C√≥digo de sala inv√°lido', 'error');
        return;
    }
    
    const upperRoomCode = roomCode.toUpperCase();
    
    showMessage('Verificando sala...', 'info');
    
    // VALIDACI√ìN MEJORADA - menos restrictiva
    database.ref('rooms/' + upperRoomCode).once('value')
        .then((snapshot) => {
            if (!snapshot.exists()) {
                throw new Error('La sala no existe');
            }
            
            const roomData = snapshot.val();
            console.log('üì° Datos de la sala encontrada:', roomData);
            
            // Validaciones m√°s flexibles
            if (roomData.status === 'finished') {
                throw new Error('La sala ya termin√≥');
            }
            
            if (roomData.host.username === state.currentUser.username) {
                throw new Error('No puedes unirte a tu propia sala');
            }
            
            // VALIDACI√ìN MEJORADA - permitir re-uni√≥n si es el mismo usuario
            if (roomData.guest && roomData.guest.username !== state.currentUser.username) {
                throw new Error('La sala ya tiene otro jugador');
            }
            
            console.log('‚úÖ Sala v√°lida para uni√≥n, procediendo...');
            
            // PASO 2: Preparar datos del invitado (SIEMPRE actualizar)
            const guestData = {
                username: state.currentUser.username,
                name: state.currentUser.name,
                questions: verifiedQuestions.length,
                ready: false
            };
            
            // PASO 3: ACTUALIZAR INVITADO (permitir sobreescribir)
            const updates = {
                guest: guestData,
                guestReady: false, // Resetear estado ready
                status: roomData.status === 'ready' ? 'waiting' : roomData.status, // Si estaba ready, volver a waiting
                lastActivity: firebase.database.ServerValue.TIMESTAMP
            };
            
            return database.ref('rooms/' + upperRoomCode).update(updates);
        })
        .then(() => {
            console.log('‚úÖ Informaci√≥n del invitado actualizada, configurando estado local...');
            
            // Actualizar estado local
            multiplayerState.currentRoom = upperRoomCode;
            multiplayerState.isHost = false;
            multiplayerState.roomCode = upperRoomCode;
            multiplayerState.gameState = 'waiting';
            
            // Configurar listener b√°sico para la sala
            listenToRoom(upperRoomCode);
            
            render();
            showMessage(`Te has unido a la sala: ${upperRoomCode}`, 'success');
            
            // PASO 4: ESCRIBIR BANCO DEL INVITADO DE FORMA AGRESIVA
            console.log('üíæ ESCRIBIENDO BANCO DEL INVITADO...');
            return forceWriteBankToFirebase(false); // false = invitado
        })
        .then(() => {
            console.log('‚úÖ Banco del invitado escrito correctamente');
            showMessage('Banco de preguntas sincronizado correctamente', 'success');
            
            // Verificar lectura inmediata
            setTimeout(() => {
                forceReadAllBanksFromFirebase()
                    .then(() => {
                        console.log('‚úÖ Verificaci√≥n post-uni√≥n completada');
                        showMessage('Sincronizaci√≥n completa exitosa', 'success');
                    })
                    .catch(error => {
                        console.warn('‚ö†Ô∏è Error en verificaci√≥n post-uni√≥n:', error);
                    });
            }, 3000);
        })
        .catch((error) => {
            console.error('‚ùå Error en uni√≥n mejorada:', error);
            showMessage('Error: ' + error.message, 'error');
        });
};

// FUNCI√ìN AUXILIAR para limpiar sala (por si hay datos residuales)
window.cleanRoom = function(roomCode) {
    if (!roomCode) {
        roomCode = prompt('C√≥digo de sala a limpiar:');
        if (!roomCode) return;
    }
    
    const upperRoomCode = roomCode.toUpperCase();
    
    if (confirm(`¬øLimpiar datos residuales de la sala ${upperRoomCode}?`)) {
        database.ref('rooms/' + upperRoomCode).once('value')
            .then(snapshot => {
                if (!snapshot.exists()) {
                    alert('La sala no existe');
                    return;
                }
                
                const roomData = snapshot.val();
                console.log('üßπ Limpiando datos residuales:', roomData);
                
                // Solo limpiar si el usuario actual es el host o guest
                const userCanClean = 
                    roomData.host?.username === state.currentUser.username ||
                    roomData.guest?.username === state.currentUser.username;
                
                if (!userCanClean) {
                    alert('No tienes permisos para limpiar esta sala');
                    return;
                }
                
                // Limpiar invitado si soy el invitado, o toda la sala si soy el host
                if (roomData.host?.username === state.currentUser.username) {
                    // Soy el host - eliminar toda la sala
                    return database.ref('rooms/' + upperRoomCode).remove();
                } else {
                    // Soy el invitado - solo limpiar datos del invitado
                    const cleanUpdates = {
                        guest: null,
                        guestReady: false,
                        'questionBanks/guest': null,
                        status: 'waiting',
                        lastActivity: firebase.database.ServerValue.TIMESTAMP
                    };
                    return database.ref('rooms/' + upperRoomCode).update(cleanUpdates);
                }
            })
            .then(() => {
                alert('Sala limpiada correctamente');
                console.log('‚úÖ Sala limpiada');
                
                // Resetear estado local si est√°bamos en esa sala
                if (multiplayerState.roomCode === upperRoomCode) {
                    multiplayerState.currentRoom = null;
                    multiplayerState.roomCode = null;
                    multiplayerState.gameState = null;
                    multiplayerState.isHost = false;
                    multiplayerState.opponent = null;
                    render();
                }
            })
            .catch(error => {
                console.error('‚ùå Error limpiando sala:', error);
                alert('Error limpiando sala: ' + error.message);
            });
    }
};

// FUNCI√ìN DE DIAGN√ìSTICO mejorada
window.diagnoseRoom = function(roomCode) {
    if (!roomCode) {
        roomCode = multiplayerState.roomCode || prompt('C√≥digo de sala a diagnosticar:');
        if (!roomCode) return;
    }
    
    const upperRoomCode = roomCode.toUpperCase();
    
    database.ref('rooms/' + upperRoomCode).once('value')
        .then(snapshot => {
            if (!snapshot.exists()) {
                alert('‚ùå La sala no existe en Firebase');
                return;
            }
            
            const roomData = snapshot.val();
            console.log('üîç DIAGN√ìSTICO COMPLETO DE LA SALA:', roomData);
            
            const diagnosis = `üîç DIAGN√ìSTICO DE SALA ${upperRoomCode}:

üìä ESTADO GENERAL:
- Status: ${roomData.status || 'undefined'}
- Creada: ${roomData.createdAt ? new Date(roomData.createdAt).toLocaleString() : 'Unknown'}
- √öltima actividad: ${roomData.lastActivity ? new Date(roomData.lastActivity).toLocaleString() : 'Unknown'}

üëë ANFITRI√ìN:
- Usuario: ${roomData.host?.username || 'undefined'}
- Nombre: ${roomData.host?.name || 'undefined'}  
- Preguntas: ${roomData.host?.questions || 0}
- Ready: ${roomData.hostReady || false}

üë§ INVITADO:
- Usuario: ${roomData.guest?.username || 'null'}
- Nombre: ${roomData.guest?.name || 'null'}
- Preguntas: ${roomData.guest?.questions || 0}
- Ready: ${roomData.guestReady || false}

üìö BANCOS DE PREGUNTAS:
- Banco Host: ${roomData.questionBanks?.host ? Object.keys(roomData.questionBanks.host).length + ' temas' : 'null'}
- Banco Guest: ${roomData.questionBanks?.guest ? Object.keys(roomData.questionBanks.guest).length + ' temas' : 'null'}

üéÆ DATOS DE JUEGO:
- Turno actual: ${roomData.gameData?.currentTurn || 'undefined'}
- Pregunta actual: ${roomData.gameData?.currentQuestionData ? 'S√≠' : 'No'}

üîß ESTADO LOCAL:
- Mi usuario: ${state.currentUser?.username || 'undefined'}
- Mi rol: ${multiplayerState.isHost ? 'Host' : 'Guest'}
- En sala: ${multiplayerState.roomCode || 'null'}`;

            alert(diagnosis);
        })
        .catch(error => {
            console.error('‚ùå Error en diagn√≥stico:', error);
            alert('Error en diagn√≥stico: ' + error.message);
        });
};


console.log('‚úÖ Correcci√≥n "Sala est√° llena" aplicada correctamente');
console.log('üõ†Ô∏è Nuevas funciones disponibles:');
console.log(' - cleanRoom(roomCode): Limpiar datos residuales de una sala');
console.log(' - diagnoseRoom(roomCode): Diagnosticar estado completo de una sala');
console.log(' - Validaci√≥n mejorada que permite re-uni√≥n del mismo usuario');
</script>
<script>
console.log('üîß SOLUCI√ìN RADICAL: Eliminando scroll de forma agresiva...');

// INTERCEPTAR renderDuelInterface y usar ALTURA FIJA CALCULADA
const originalRenderDuelInterface = window.renderDuelInterface;

window.renderDuelInterface = function() {
    const isHost = multiplayerState.isHost;
    const opponent = multiplayerState.opponent;
    const myTurn = multiplayerState.myTurn;
    const myFailures = multiplayerState.myFailures || 0;
    const opponentFailures = multiplayerState.opponentFailures || 0;
    
    // Obtener bancos de preguntas
    const opponentBank = getOpponentQuestionBank();
    let myBank = getMyQuestionBank();
    
    if (Object.keys(myBank).length === 0 && state.questions) {
        const verifiedQuestions = state.questions.filter(q => q.isVerified);
        myBank = organizeQuestionsForFirebase(verifiedQuestions, state.topics);
    }
    
    // Datos de la pregunta actual
    const currentQuestion = multiplayerState.currentRoomData?.gameData?.currentQuestionData || null;
    const gameData = multiplayerState.currentRoomData?.gameData;
    const waitingForAnswer = gameData?.waitingForAnswer;
    const showingResult = gameData?.showingResult;
    const canAnswer = currentQuestion && !myTurn && !showingResult && waitingForAnswer;
    
    // ========== VERIFICAR FIN DEL JUEGO ==========
    const gameEnded = gameData?.gameEnded || false;
    if (gameEnded) {
        return renderGameEndedScreen(gameData);
    }
    
    // ========== SISTEMA DE COLORES DIN√ÅMICO ==========
    // VERDE: Turno de preguntar (myTurn = true)
    // ROJO: Turno de responder (canAnswer = true o esperando)
    const isMyTurnToAsk = myTurn; // Turno de hacer pregunta = VERDE
    const isMyTurnToAnswer = canAnswer; // Turno de responder = ROJO
    const isWaitingOrResult = !isMyTurnToAsk && !isMyTurnToAnswer; // Estado neutral
    
    // Colores del HEADER
    const headerBgColor = isMyTurnToAsk ? 
        'linear-gradient(135deg, #22c55e, #16a34a)' : // VERDE para preguntar
        'linear-gradient(135deg, #dc2626, #7f1d1d)';   // ROJO para responder/esperar
    
    const headerShadow = isMyTurnToAsk ? 
        'rgba(34, 197, 94, 0.3)' : 
        'rgba(220, 38, 38, 0.3)';
    
    // Colores de la FRANJA DEL USUARIO (izquierda)
    const userFrameBg = isMyTurnToAsk ? 
        'linear-gradient(135deg, #f0fdf4, #ecfdf5)' : // VERDE claro para preguntar
        'linear-gradient(135deg, #fef2f2, #fee2e2)';   // ROJO claro para responder/esperar
    
    const userFrameBorder = isMyTurnToAsk ? 
        '#22c55e' : // VERDE para preguntar
        '#dc2626';  // ROJO para responder/esperar
    
    const userHeaderBg = isMyTurnToAsk ? 
        '#22c55e' : // VERDE para preguntar
        '#dc2626';  // ROJO para responder/esperar
    
    // Mensaje de estado simplificado con palabras grandes
    let statusMessage = '';
    if (showingResult && gameData?.currentResponse) {
        const isCorrect = gameData.currentResponse.isCorrect;
        statusMessage = `${isCorrect ? '‚úÖ CORRECTO' : '‚ùå INCORRECTO'} - Cambiando turno...`;
    } else if (canAnswer) {
        statusMessage = 'RESPONDER';
    } else if (currentQuestion && waitingForAnswer) {
        statusMessage = '‚è≥ ESPERANDO RESPUESTA - Tu oponente est√° respondiendo';
    } else if (myTurn) {
        statusMessage = 'PREGUNTAR';
    } else {
        statusMessage = '‚è≥ TURNO DEL OPONENTE - Est√° seleccionando una pregunta';
    }

    // NUEVA funci√≥n para renderizar pregunta con resultado
    function renderCurrentQuestionWithResult(question, canAnswer) {
        const gameData = multiplayerState.currentRoomData?.gameData;
        const showingResult = gameData?.showingResult;
        const currentResponse = gameData?.currentResponse;
        
        if (showingResult && currentResponse) {
            // Mostrar resultado durante 5 segundos - SOLO emoji y palabra
            const isCorrect = currentResponse.isCorrect;
            
            return `
                <div style="text-align: center; padding: 20px;">
                    <!-- Mensaje simple: SOLO emoji y palabra -->
                    <div style="margin-bottom: 40px;">
                        <div style="font-size: 4rem; margin-bottom: 10px;">${isCorrect ? 'üéâ' : 'üòî'}</div>
                        <div style="font-size: 3rem; font-weight: bold; color: ${isCorrect ? '#16a34a' : '#dc2626'};">
                            ${isCorrect ? '¬°CORRECTO!' : 'INCORRECTO'}
                        </div>
                    </div>
                    
                    <!-- Pregunta con opciones coloreadas (en segundo plano) -->
                    <div style="opacity: 0.6;">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 20px; color: #374151;">
                            ${question.question}
                        </div>
                        <div style="display: grid; gap: 12px;">
                            ${question.options.map((option, index) => {
                                let bgColor = '#f8fafc';
                                let borderColor = '#e2e8f0';
                                let textColor = '#374151';
                                
                                if (index === currentResponse.selectedIndex) {
                                    if (isCorrect) {
                                        bgColor = '#dcfce7';
                                        borderColor = '#22c55e';
                                        textColor = '#16a34a';
                                    } else {
                                        bgColor = '#fee2e2';
                                        borderColor = '#dc2626';
                                        textColor = '#dc2626';
                                    }
                                } else if (index === question.correctAnswer && !isCorrect) {
                                    bgColor = '#dcfce7';
                                    borderColor = '#22c55e';
                                    textColor = '#16a34a';
                                }
                                
                                const icon = index === question.correctAnswer ? '‚úÖ' : 
                                           (index === currentResponse.selectedIndex && !isCorrect ? '‚ùå' : '');
                                
                                return `
                                    <div style="padding: 15px; background: ${bgColor}; border: 2px solid ${borderColor}; 
                                                border-radius: 10px; text-align: left; color: ${textColor}; font-weight: 500;">
                                        ${icon} ${option}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Mostrar pregunta normal
        if (!question) {
            return `
                <div style="text-align: center; padding: 60px 20px; color: #6b7280;">
                    <div style="font-size: 3rem; margin-bottom: 15px;">üìù</div>
                    <p style="margin: 0; font-size: 16px;">Esperando pregunta...</p>
                </div>
            `;
        }
        
        return `
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 18px; font-weight: bold; margin-bottom: 25px; color: #374151; line-height: 1.4;">
                    ${question.question}
                </div>
                <div style="display: grid; gap: 12px; max-width: 500px; margin: 0 auto;">
                    ${question.options.map((option, index) => `
                        <button 
                            onclick="${canAnswer ? `answerCurrentQuestion(${index})` : ''}" 
                            style="padding: 15px; background: ${canAnswer ? '#f8fafc hover:bg-blue-50' : '#f3f4f6'}; 
                                   border: 2px solid ${canAnswer ? '#0ea5e9' : '#d1d5db'}; border-radius: 10px; 
                                   text-align: left; cursor: ${canAnswer ? 'pointer' : 'not-allowed'}; 
                                   color: ${canAnswer ? '#374151' : '#9ca3af'}; font-weight: 500;
                                   transition: all 0.2s;"
                            ${canAnswer ? '' : 'disabled'}>
                            ${option}
                        </button>
                    `).join('')}
                </div>
            </div>
        `;
    }

    // FUNCI√ìN para mostrar MIS temas (solo para visualizaci√≥n, sin selecci√≥n)
    function renderMyTopicsForDisplay(questionBank) {
        if (!questionBank || Object.keys(questionBank).length === 0) {
            return `
                <div style="text-align: center; padding: 20px; color: #6b7280;">
                    <div style="font-size: 2rem; margin-bottom: 10px;">üìö</div>
                    <p style="margin: 0; font-size: 14px;">Sin temas disponibles</p>
                </div>
            `;
        }

        let html = '';
        Object.keys(questionBank).forEach(topicKey => {
            const topic = questionBank[topicKey];
            if (topic.questions && topic.questions.length > 0) {
                html += `
                    <div style="margin-bottom: 12px; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                        <div style="background: #f9fafb; padding: 12px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 500; color: #374151; font-size: 13px;">${topic.name}</span>
                            <span style="background: #22c55e; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">
                                ${topic.questions.length}
                            </span>
                        </div>
                    </div>
                `;
            }
        });

        return html || `
            <div style="text-align: center; padding: 20px; color: #6b7280;">
                <p style="margin: 0; font-size: 14px;">Sin preguntas en tus temas</p>
            </div>
        `;
    }
    
    // Aplicar estilo agresivo anti-scroll
    document.documentElement.style.overflow = 'hidden';
    document.body.style.overflow = 'hidden';
    
    // Renderizar interfaz completa
    return `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999; 
                    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); 
                    display: flex; flex-direction: column;">
        
            <!-- HEADER CON COLORES DIN√ÅMICOS -->
            <div style="background: ${headerBgColor}; 
                        padding: 20px; text-align: center; color: white; 
                        box-shadow: 0 4px 20px ${headerShadow};
                        display: flex; justify-content: space-between; align-items: center;">
                
                <!-- Espadas y DUELO a la izquierda -->
                <div style="display: flex; align-items: center; font-size: 18px; font-weight: bold;">
                    ‚öîÔ∏è DUELO
                </div>
                
                <!-- Mensaje central -->
                <div style="text-align: center; flex: 1;">
                    <p style="margin: 0; font-size: ${statusMessage === 'PREGUNTAR' || statusMessage === 'RESPONDER' ? '2.5rem' : '18px'}; 
                              font-weight: bold;">
                        ${statusMessage}
                    </p>
                </div>
                
                <!-- Bot√≥n de salir -->
                <button onclick="exitDuelMode()" style="background: rgba(255,255,255,0.2); color: white; 
                        border: 2px solid rgba(255,255,255,0.4); padding: 10px 20px; border-radius: 8px; 
                        cursor: pointer; font-weight: bold;">
                    ‚ùå Salir
                </button>
            </div>

            <!-- Contenido principal -->
            <div style="flex: 1; padding: 25px; overflow: hidden;">
                
                <!-- Interfaz de 3 franjas M√ÅS ANCHAS -->
                <div style="display: grid; grid-template-columns: 450px 1fr 450px; gap: 20px; height: calc(100vh - 120px);">
                    
                    <!-- FRANJA IZQUIERDA: Usuario con colores din√°micos - SOLO MIS TEMAS (sin selecci√≥n) -->
                    <div style="background: ${userFrameBg}; border: 2px solid ${userFrameBorder}; 
                                border-radius: 12px; display: flex; flex-direction: column; position: relative;">
                        
                        <!-- Header del usuario -->
                        <div style="padding: 15px; border-bottom: 2px solid ${userFrameBorder}; 
                                    background: ${userHeaderBg}; color: white; text-align: center;">
                            <!-- Nombre grande e invitado peque√±o -->
                            <div style="font-size: 16px; font-weight: bold; margin-bottom: 2px;">
                                ${state.currentUser?.name?.toUpperCase() || 'USUARIO'}
                            </div>
                            <div style="font-size: 10px; opacity: 0.8;">
                                üë§ ${isHost ? 'ANFITRI√ìN' : 'INVITADO'}
                            </div>
                        </div>
                        
                        <!-- Contenido con scroll - SOLO MIS TEMAS (sin selecci√≥n) -->
                        <div style="flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 50px;">
                            <div style="font-size: 13px; color: ${userHeaderBg}; margin-bottom: 15px; text-align: center; font-weight: 600; text-transform: uppercase;">
                                Mis Temas (${Object.keys(myBank).length})
                            </div>
                            ${renderMyTopicsForDisplay(myBank)}
                        </div>
                        
                        <!-- Contador fijo en la parte inferior -->
                        <div style="position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); 
                                    background: white; padding: 8px 16px; border-radius: 20px; 
                                    box-shadow: 0 2px 8px rgba(0,0,0,0.15); font-size: 18px; font-weight: bold; 
                                    color: ${userHeaderBg};">
                            ${myFailures}/3
                        </div>
                    </div>
                    
                    <!-- FRANJA CENTRAL: Pregunta actual -->
                    <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; display: flex; flex-direction: column;">
                        <div style="padding: 20px; border-bottom: 2px solid #e2e8f0; background: linear-gradient(135deg, #f8fafc, #e2e8f0); text-align: center;">
                            <h3 style="margin: 0; color: #374151; font-size: 18px;">üìã Pregunta Actual</h3>
                        </div>
                        
                        <div style="flex: 1; display: flex; align-items: center; justify-content: center; overflow-y: auto;">
                            ${renderCurrentQuestionWithResult(currentQuestion, canAnswer)}
                        </div>
                    </div>
                    
                    <!-- FRANJA DERECHA: Oponente reformado - SIEMPRE AZUL OSCURA -->
                    <div style="background: linear-gradient(135deg, #1e3a8a, #1e40af); border: 2px solid #1e40af; 
                                border-radius: 12px; display: flex; flex-direction: column; position: relative;">
                        
                        <!-- Header del oponente reformado - SIEMPRE AZUL -->
                        <div style="padding: 15px; border-bottom: 2px solid #1e40af; 
                                    background: linear-gradient(135deg, #1e40af, #1d4ed8); 
                                    color: white; text-align: center;">
                            <!-- Nombre grande e invitado/anfitri√≥n peque√±o -->
                            <div style="font-size: 16px; font-weight: bold; margin-bottom: 2px;">
                                ${opponent ? opponent.name.toUpperCase() : 'OPONENTE'}
                            </div>
                            <div style="font-size: 10px; opacity: 0.8;">
                                ${!isHost ? 'üëë ANFITRI√ìN' : 'üë§ INVITADO'}
                            </div>
                        </div>
                        
                        <!-- Contenido con scroll - TEMAS DEL OPONENTE SELECCIONABLES -->
                        <div style="flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 50px;">
                            <div style="font-size: 13px; color: #bfdbfe; margin-bottom: 15px; text-align: center; font-weight: 600; text-transform: uppercase;">
                                ${myTurn ? 'üéØ Selecciona pregunta' : 'Temas del oponente'} (${Object.keys(opponentBank).length})
                            </div>
                            ${renderOpponentTopicsForSelection(opponentBank, myTurn)}
                        </div>
                        
                        <!-- Contador fijo en la parte inferior del oponente -->
                        <div style="position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); 
                                    background: white; padding: 8px 16px; border-radius: 20px; 
                                    box-shadow: 0 2px 8px rgba(0,0,0,0.15); font-size: 18px; font-weight: bold; 
                                    color: #1e40af;">
                            ${opponentFailures}/3
                        </div>
                    </div>
                </div>

                <!-- Botones de control -->
                <div style="text-align: center; margin-top: 25px;">
                    <button onclick="leaveRoom()" class="btn btn-danger" style="padding: 12px 24px; margin-right: 10px;">
                        üö™ Salir del Duelo
                    </button>
                    <button onclick="forceResync()" class="btn btn-info" style="padding: 12px 24px;">
                        üîÑ Forzar Resync
                    </button>
                </div>
            </div>
        </div>
    `;
};

// Funci√≥n mejorada para salir del modo duelo
window.exitDuelMode = function() {
    if (confirm('¬øEst√°s seguro de que quieres abandonar el duelo?')) 
    {
        // Restaurar scroll normal
        document.documentElement.style.overflow = '';
        document.body.style.overflow = '';
        
        // Salir de la sala
        if (typeof exitMultiplayerMode === 'function') {
            exitMultiplayerMode();
        } else {
            multiplayerState.gameState = 'idle';
            multiplayerState.roomCode = null;
            render();
        }
    }
};

// NUEVA funci√≥n para manejar respuestas con visualizaci√≥n en la pregunta
window.answerCurrentQuestion = function(optionIndex) {
    console.log('üéØ Respondiendo pregunta con opci√≥n:', optionIndex);
    
    // Verificar que hay una pregunta actual
    const currentQuestion = multiplayerState.currentRoomData?.gameData?.currentQuestionData;
    if (!currentQuestion) {
        showMessage('No hay pregunta actual para responder', 'warning');
        return;
    }
    
    // Verificar que no estoy esperando una respuesta ya procesada
    if (!multiplayerState.currentRoomData?.gameData?.waitingForAnswer) {
        showMessage('Esta pregunta ya fue respondida', 'warning');
        return;
    }
    
    // Verificar que es mi turno para responder (es el turno del otro)
    if (multiplayerState.myTurn) {
        showMessage('No es tu turno para responder', 'warning');
        return;
    }
    
    // Determinar si la respuesta es correcta
    const isCorrect = optionIndex === currentQuestion.correctAnswer;
    const selectedOption = currentQuestion.options[optionIndex];
    
    console.log('üìä Procesando respuesta:', {
        selectedIndex: optionIndex,
        correctIndex: currentQuestion.correctAnswer,
        isCorrect: isCorrect,
        selectedOption: selectedOption
    });
    
    // Preparar datos de la respuesta
    const responseData = {
        'gameData/currentResponse': {
            selectedIndex: optionIndex,
            isCorrect: isCorrect,
            selectedOption: selectedOption,
            answeredBy: multiplayerState.isHost ? 'host' : 'guest',
            timestamp: Date.now()
        },
        'gameData/waitingForAnswer': false, // Ya no esperamos respuesta
        'gameData/showingResult': true, // Mostrar resultado por 5 segundos
        lastActivity: firebase.database.ServerValue.TIMESTAMP
    };
    
    // Si la respuesta es incorrecta, incrementar fallos del que responde
    if (!isCorrect) {
        const failuresPath = multiplayerState.isHost ? 'gameData/hostFailures' : 'gameData/guestFailures';
        const currentFailures = multiplayerState.isHost ? 
            (multiplayerState.myFailures || 0) : 
            (multiplayerState.myFailures || 0);
        
        const newFailures = currentFailures + 1;
        responseData[failuresPath] = newFailures;
        
        // ‚úÖ GUARDAR PREGUNTA FALLADA EN EL SISTEMA DE REPASO
        saveMultiplayerFailedQuestion(currentQuestion, selectedOption);
        
        // VERIFICAR SI EL JUEGO TERMINA (3 fallos)
        if (newFailures >= 3) {
            responseData['gameData/gameEnded'] = true;
            responseData['gameData/winner'] = multiplayerState.isHost ? 'guest' : 'host'; // El que NO fall√≥ gana
            responseData['gameData/loser'] = multiplayerState.isHost ? 'host' : 'guest';
            responseData['gameData/endReason'] = 'maxFailures';
        }
    }
    
    // Actualizar Firebase con la respuesta
    database.ref('rooms/' + multiplayerState.currentRoom).update(responseData).then(() => {
        const resultMessage = isCorrect ? 
            `‚úÖ ¬°Correcto! ${selectedOption}` : 
            `‚ùå Incorrecto. Era: ${currentQuestion.options[currentQuestion.correctAnswer]}`;
        
        console.log('üéâ Resultado mostrado en la pregunta durante 5 segundos');
        
        // Despu√©s de 5 segundos, cambiar el turno y limpiar la pregunta
        setTimeout(() => {
            // Verificar si el juego termin√≥ antes de cambiar turno
            const updatedGameData = multiplayerState.currentRoomData?.gameData;
            if (updatedGameData?.gameEnded) {
                console.log('üèÅ Juego terminado - No cambiar turno');
                return;
            }
            changeToNextTurn();
        }, 5000);
        
    }).catch(error => {
        console.error('‚ùå Error enviando respuesta:', error);
        showMessage('Error al enviar la respuesta', 'error');
    });
};

// FUNCI√ìN AUXILIAR para cambiar al siguiente turno - CORREGIDA ‚úÖ
function changeToNextTurn() {
    // OBTENER EL TURNO ACTUAL desde Firebase
    const currentTurn = multiplayerState.currentRoomData?.gameData?.currentTurn;
    
    // ALTERNAR al turno CONTRARIO
    const nextTurn = currentTurn === 'host' ? 'guest' : 'host';
    
    console.log('üîÑ Cambiando turno:', {
        currentTurn: currentTurn,
        nextTurn: nextTurn,
        myRole: multiplayerState.isHost ? 'host' : 'guest'
    });
    
    const nextTurnData = {
        'gameData/currentQuestionData': null, // Limpiar pregunta actual
        'gameData/currentResponse': null, // Limpiar respuesta
        'gameData/showingResult': false, // No mostrar resultado
        'gameData/questionAsker': null, // Limpiar quien pregunt√≥
        'gameData/currentTurn': nextTurn, // ‚úÖ CORREGIDO: Alternar al turno contrario
        lastActivity: firebase.database.ServerValue.TIMESTAMP
    };
    
    database.ref('rooms/' + multiplayerState.currentRoom).update(nextTurnData).then(() => {
        console.log('üîÑ Turno cambiado correctamente de', currentTurn, 'a', nextTurn);
        showMessage('Turno cambiado', 'info');
    }).catch(error => {
        console.error('‚ùå Error cambiando turno:', error);
    });
}

console.log('‚úÖ C√ìDIGO CORREGIDO - Solo se pueden seleccionar preguntas del OPONENTE');
console.log('üéØ Estructura corregida:');
console.log('   - Franja izquierda: MIS temas (solo visualizaci√≥n)');
console.log('   - Franja derecha: TEMAS DEL OPONENTE (seleccionables solo en mi turno)');
console.log('   - La funci√≥n renderOpponentTopicsForSelection maneja los clickables');
console.log('   - Imposible preguntarse a uno mismo');
console.log('   - Franjas m√°s anchas (450px) para preguntas completas');

// MEJORAR LA FUNCI√ìN renderOpponentTopicsForSelection EXISTENTE
// Esta funci√≥n sobrescribe la versi√≥n existente para mostrar preguntas completas
window.renderOpponentTopicsForSelection = function(questionBank, canSelect) {
    if (!questionBank || Object.keys(questionBank).length === 0) {
        return `
            <div style="text-align: center; padding: 50px 20px; color: #bfdbfe;">
                <div style="font-size: 4rem; margin-bottom: 20px;">‚è≥</div>
                <p style="margin: 0; font-size: 18px; font-weight: bold;">Esperando temas del oponente...</p>
                <p style="margin: 15px 0 0 0; font-size: 14px; opacity: 0.8;">La sincronizaci√≥n puede tardar unos segundos</p>
            </div>
        `;
    }

    let html = '';
    Object.keys(questionBank).forEach(topicKey => {
        const topic = questionBank[topicKey];
        if (topic.questions && topic.questions.length > 0) {
            html += `
                <div style="margin-bottom: 15px; border: 2px solid ${canSelect ? '#fbbf24' : 'rgba(255,255,255,0.2)'}; 
                            border-radius: 12px; overflow: hidden; background: rgba(255,255,255,0.1);
                            ${canSelect ? 'box-shadow: 0 4px 12px rgba(251,191,36,0.4);' : 'box-shadow: 0 2px 8px rgba(0,0,0,0.1);'}">
                    
                    <div style="background: ${canSelect ? 'linear-gradient(135deg, #fbbf24, #f59e0b)' : 'rgba(255,255,255,0.1)'}; 
                                padding: 15px; border-bottom: 1px solid ${canSelect ? '#f59e0b' : 'rgba(255,255,255,0.2)'}; 
                                cursor: pointer;" onclick="toggleTopicQuestions('opponent-${topicKey}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 700; color: ${canSelect ? '#92400e' : '#bfdbfe'}; font-size: 15px; text-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                                ${topic.name}
                            </span>
                            <span style="background: ${canSelect ? '#f59e0b' : 'rgba(255,255,255,0.2)'}; 
                                         color: ${canSelect ? 'white' : '#bfdbfe'}; padding: 4px 10px; border-radius: 14px; 
                                         font-size: 13px; font-weight: bold;">
                                ${topic.questions.length}
                            </span>
                        </div>
                        ${canSelect ? `<div style="margin-top: 8px; font-size: 12px; color: #92400e; opacity: 0.9; font-weight: 600;">üëÜ Clic para expandir y seleccionar preguntas</div>` : ''}
                    </div>
                    
                    <div id="opponent-questions-${topicKey}" style="display: none; max-height: 300px; overflow-y: auto; 
                                background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);">
                        ${topic.questions.map((question, index) => `
                            <div style="padding: 15px; border-bottom: 1px solid #f3f4f6; 
                                       ${canSelect ? 'cursor: pointer; transition: all 0.2s;' : ''} 
                                       font-size: 14px; line-height: 1.6; word-wrap: break-word; 
                                       white-space: normal; max-width: 100%;"
                                 ${canSelect ? `onclick="selectQuestionFromOpponent('${topicKey}', '${question.firebaseKey}')" 
                                               onmouseover="this.style.backgroundColor='#fef3c7'; this.style.transform='scale(1.02)';"
                                               onmouseout="this.style.backgroundColor='transparent'; this.style.transform='scale(1)';"` : ''}>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                                        <strong style="color: ${canSelect ? '#f59e0b' : '#6b7280'}; min-width: 30px; font-size: 13px;">
                                            P${index + 1}:
                                        </strong>
                                        <span style="color: ${canSelect ? '#374151' : '#6b7280'}; flex: 1; 
                                                     word-wrap: break-word; white-space: normal; line-height: 1.5;">
                                            ${question.question}
                                        </span>
                                    </div>
                                    ${canSelect ? `<div style="text-align: right; margin-top: 5px;">
                                        <span style="background: #f59e0b; color: white; padding: 4px 8px; 
                                                     border-radius: 6px; font-size: 11px; font-weight: bold;">
                                            üéØ SELECCIONAR
                                        </span>
                                    </div>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
    });

    return html;
};

// FUNCI√ìN PARA MOSTRAR PANTALLA DE FINAL DEL JUEGO
function renderGameEndedScreen(gameData) {
    const winner = gameData.winner;
    const loser = gameData.loser;
    const myRole = multiplayerState.isHost ? 'host' : 'guest';
    const opponent = multiplayerState.opponent;
    
    const iAmWinner = winner === myRole;
    const winnerName = winner === 'host' 
        ? (multiplayerState.isHost ? state.currentUser?.name || 'T√∫' : opponent?.name || 'Anfitri√≥n')
        : (multiplayerState.isHost ? opponent?.name || 'Invitado' : state.currentUser?.name || 'T√∫');
    
    const loserName = loser === 'host'
        ? (multiplayerState.isHost ? state.currentUser?.name || 'T√∫' : opponent?.name || 'Anfitri√≥n')
        : (multiplayerState.isHost ? opponent?.name || 'Invitado' : state.currentUser?.name || 'T√∫');

    // Aplicar estilo anti-scroll
    document.documentElement.style.overflow = 'hidden';
    document.body.style.overflow = 'hidden';

    // REPRODUCIR SONIDOS INMEDIATAMENTE AL MOSTRAR LA PANTALLA
    // CADA USUARIO ESCUCHA SOLO SU SONIDO CORRESPONDIENTE
    if (iAmWinner) {
        playVictorySound(); // SOLO ovaci√≥n para el ganador
        console.log('üèÜ SOY EL GANADOR - Reproduciendo ovaci√≥n');
    } else {
        playDefeatSound(); // SOLO pedo para el perdedor
        console.log('üí© SOY EL PERDEDOR - Reproduciendo pedo');
    }

    return `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999; 
                    background: linear-gradient(135deg, ${iAmWinner ? '#10b981, #059669' : '#dc2626, #991b1b'}); 
                    display: flex; align-items: center; justify-content: center; color: white;">
            
            <div style="text-align: center; max-width: 600px; padding: 40px;">
                
                <!-- Emoji y resultado principal -->
                <div style="font-size: 8rem; margin-bottom: 30px;">
                    ${iAmWinner ? 'üèÜ' : 'üí©'}
                </div>
                
                <!-- Mensaje principal -->
                <h1 style="font-size: 4rem; font-weight: bold; margin: 0 0 20px 0; text-shadow: 0 4px 8px rgba(0,0,0,0.3);">
                    ${iAmWinner ? '¬°VICTORIA!' : 'DERROTA'}
                </h1>
                
                <!-- Subt√≠tulo -->
                <h2 style="font-size: 2rem; font-weight: 600; margin: 0 0 30px 0; opacity: 0.9;">
                    ${iAmWinner ? 'Has ganado el duelo' : 'Has perdido el duelo'}
                </h2>
                
                <!-- Detalles del resultado -->
                <div style="background: rgba(255,255,255,0.1); border-radius: 16px; padding: 30px; margin-bottom: 40px; backdrop-filter: blur(10px);">
                    <div style="font-size: 1.5rem; margin-bottom: 15px; font-weight: 600;">
                        üìä Resultado Final
                    </div>
                    <div style="font-size: 1.2rem; line-height: 1.6;">
                        <div style="margin-bottom: 10px;">
                            üèÜ <strong>Ganador:</strong> ${winnerName}
                        </div>
                        <div style="margin-bottom: 10px;">
                            üíî <strong>Perdedor:</strong> ${loserName}
                        </div>
                        <div>
                            ‚ùå <strong>Motivo:</strong> 3 respuestas incorrectas
                        </div>
                    </div>
                </div>
                
                <!-- Estad√≠sticas -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px;">
                    <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; backdrop-filter: blur(5px);">
                        <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">
                            ${multiplayerState.isHost ? 'üëë Anfitri√≥n' : 'üë§ Invitado'} (T√∫)
                        </div>
                        <div style="font-size: 2rem; font-weight: bold;">
                            ${multiplayerState.myFailures || 0}/3
                        </div>
                        <div style="font-size: 0.9rem; opacity: 0.8;">Fallos</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; backdrop-filter: blur(5px);">
                        <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">
                            ${!multiplayerState.isHost ? 'üëë Anfitri√≥n' : 'üë§ Invitado'}
                        </div>
                        <div style="font-size: 2rem; font-weight: bold;">
                            ${multiplayerState.opponentFailures || 0}/3
                        </div>
                        <div style="font-size: 0.9rem; opacity: 0.8;">Fallos</div>
                    </div>
                </div>
                
                <!-- Botones -->
                <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                    <button onclick="restartGame()" style="background: rgba(255,255,255,0.2); color: white; 
                            border: 2px solid rgba(255,255,255,0.4); padding: 15px 30px; border-radius: 12px; 
                            cursor: pointer; font-weight: bold; font-size: 16px; transition: all 0.2s;
                            backdrop-filter: blur(10px);">
                        üîÑ Jugar de Nuevo
                    </button>
                    <button onclick="exitToMainMenu()" style="background: rgba(255,255,255,0.2); color: white; 
                            border: 2px solid rgba(255,255,255,0.4); padding: 15px 30px; border-radius: 12px; 
                            cursor: pointer; font-weight: bold; font-size: 16px; transition: all 0.2s;
                            backdrop-filter: blur(10px);">
                        üè† Men√∫ Principal
                    </button>
                </div>
            </div>
        </div>
    `;
}

// FUNCI√ìN PARA REINICIAR EL JUEGO
window.restartGame = function() {
    const restartData = {
        'gameData/hostFailures': 0,
        'gameData/guestFailures': 0,
        'gameData/currentQuestionData': null,
        'gameData/currentResponse': null,
        'gameData/showingResult': false,
        'gameData/waitingForAnswer': false,
        'gameData/gameEnded': false,
        'gameData/winner': null,
        'gameData/loser': null,
        'gameData/endReason': null,
        'gameData/currentTurn': 'host', // El anfitri√≥n empieza
        lastActivity: firebase.database.ServerValue.TIMESTAMP
    };
    
    database.ref('rooms/' + multiplayerState.currentRoom).update(restartData).then(() => {
        showMessage('üéÆ Juego reiniciado - ¬°Nueva partida!', 'success');
    }).catch(error => {
        console.error('‚ùå Error reiniciando juego:', error);
        showMessage('Error al reiniciar el juego', 'error');
    });
};

// FUNCI√ìN PARA SALIR AL MEN√ö PRINCIPAL
window.exitToMainMenu = function() {
    // Restaurar scroll normal
    document.documentElement.style.overflow = '';
    document.body.style.overflow = '';
    
    // Salir de la sala completamente
    if (typeof exitMultiplayerMode === 'function') {
        exitMultiplayerMode();
    } else {
        multiplayerState.gameState = 'idle';
        multiplayerState.roomCode = null;
        multiplayerState.currentRoom = null;
        multiplayerState.opponent = null;
        render();
    }
    
    showMessage('üëã Has salido del duelo', 'info');
};

// ‚úÖ FUNCI√ìN PARA GUARDAR PREGUNTAS FALLADAS DEL MULTIJUGADOR
function saveMultiplayerFailedQuestion(question, userAnswer) {
    try {
        console.log('üíæ Guardando pregunta fallada del duelo multijugador:', question.question.substring(0, 50) + '...');
        
        // Crear un resultado de test simulado para el sistema de preguntas falladas
        const now = new Date();
        const timestamp = now.getTime();
        
        const multiplayerTestResult = {
            id: timestamp,
            name: `Duelo Multijugador - ${now.toLocaleDateString('es-ES')} ${now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}`,
            date: now.toISOString(),
            score: 0, // Marcamos como fallada
            totalQuestions: 1,
            correctAnswers: 0,
            detailedResults: [{
                question: question,
                userAnswer: userAnswer,
                correctAnswer: question.options[question.correctAnswer],
                isCorrect: false,
                timeSpent: 0
            }],
            isMultiplayerResult: true // Marcador para identificar que viene del multijugador
        };
        
        // A√±adir al historial de tests para que sea detectado por el sistema de preguntas falladas
        if (!state.testResults) {
            state.testResults = [];
        }
        
        state.testResults.push(multiplayerTestResult);
        
        // Guardar en localStorage
        localStorage.setItem('testResults', JSON.stringify(state.testResults));
        
        console.log('‚úÖ Pregunta fallada guardada correctamente en el sistema de repaso');
        
        // Mostrar notificaci√≥n al usuario
        setTimeout(() => {
            showMessage('üìù Pregunta fallada a√±adida al test de repaso', 'info');
        }, 6000); // Mostrar despu√©s del resultado de la pregunta
        
    } catch (error) {
        console.error('‚ùå Error guardando pregunta fallada:', error);
    }
}

// FUNCI√ìN PARA REPRODUCIR SONIDOS CON FALLBACK VISUAL
function playVictorySound() {
    // REPRODUCIR OVACI√ìN INMEDIATAMENTE - SIN ESPERAS
    try {
        // PRIMER SONIDO - Ovaci√≥n de multitud - INMEDIATO
        const audio1 = new Audio('https://www.myinstants.com/media/sounds/applause-01.mp3');
        audio1.volume = 0.7;
        audio1.play().catch(() => {
            console.log('Primer sonido de victoria fall√≥');
        });

        // SEGUNDO SONIDO EN PARALELO - Gritos de victoria - INMEDIATO
        const audio2 = new Audio('https://www.freesoundslibrary.com/wp-content/uploads/2017/11/crowd-cheering-sound-effect.mp3');
        audio2.volume = 0.6;
        audio2.play().catch(() => {
            console.log('Segundo sonido de victoria fall√≥');
        });

        // TERCER SONIDO DE BACKUP - INMEDIATO
        setTimeout(() => {
            try {
                const audio3 = new Audio('https://www.soundboard.com/handler/DownLoadTrack.ashx?cliptitle=Crowd+Cheering&filename=mz/Mzg1ODIxNTIzMzg1ODI3_JzthsfvUY24.MP3');
                audio3.volume = 0.5;
                audio3.play().catch(() => {
                    // Si todos fallan, efecto visual inmediato
                    showSoundEffect('üéâüëèüéâ', '¬°OVACI√ìN!');
                });
            } catch (error) {
                showSoundEffect('üéâüëèüéâ', '¬°OVACI√ìN!');
            }
        }, 0); // Sin delay - inmediato

        console.log('üéâüëè ¬°OVACI√ìN √âPICA ACTIVADA!');
        
    } catch (error) {
        // Fallback visual inmediato
        showSoundEffect('üéâüëèüéâ', '¬°OVACI√ìN!');
    }
}

function playDefeatSound() {
    // REPRODUCIR SONIDO DE PEDO INMEDIATAMENTE - SIN ESPERAS
    try {
        // PRIMER SONIDO - Tromb√≥n de derrota (tipo pedo) - INMEDIATO
        const audio1 = new Audio('https://www.soundjay.com/misc/sounds/fail-trombone-01.wav');
        audio1.volume = 0.6;
        audio1.playbackRate = 0.7; // M√°s grave = m√°s c√≥mico
        audio1.play().catch(() => {
            console.log('Primer sonido de derrota fall√≥');
        });

        // SEGUNDO SONIDO EN PARALELO - Sonido de "fail" c√≥mico - INMEDIATO
        const audio2 = new Audio('https://www.myinstants.com/media/sounds/sad-trombone.mp3');
        audio2.volume = 0.5;
        audio2.play().catch(() => {
            console.log('Segundo sonido de derrota fall√≥');
        });

        // TERCER SONIDO DE BACKUP - INMEDIATO
        setTimeout(() => {
            try {
                const audio3 = new Audio('https://www.freesoundslibrary.com/wp-content/uploads/2018/01/fart-sound-effect.mp3');
                audio3.volume = 0.4;
                audio3.play().catch(() => {
                    // Si todos fallan, efecto visual inmediato
                    showSoundEffect('üí®üí©üí®', '¬°PPPPRRRRRR!');
                });
            } catch (error) {
                showSoundEffect('üí®üí©üí®', '¬°PPPPRRRRRR!');
            }
        }, 0); // Sin delay - inmediato

        console.log('üí®üí© ¬°PEDOS DE LA DERROTA ACTIVADOS!');
        
    } catch (error) {
        // Fallback visual inmediato
        showSoundEffect('üí®üí©üí®', '¬°PPPPRRRRRR!');
    }
}

// EFECTO VISUAL CUANDO NO HAY SONIDO
function showSoundEffect(emoji, text) {
    const effect = document.createElement('div');
    effect.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        font-size: 4rem; z-index: 99999; color: yellow; text-shadow: 2px 2px 4px black;
        animation: bounce 0.5s ease-in-out 3; pointer-events: none;
    `;
    effect.innerHTML = `${emoji}<br><span style="font-size: 2rem;">${text}</span>`;
    
    // Agregar animaci√≥n CSS
    const style = document.createElement('style');
    style.textContent = `
        @keyframes bounce {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
        }
    `;
    document.head.appendChild(style);
    document.body.appendChild(effect);
    
    // Quitar despu√©s de 2 segundos
    setTimeout(() => {
        if (effect.parentNode) effect.parentNode.removeChild(effect);
        if (style.parentNode) style.parentNode.removeChild(style);
    }, 2000);
}
</script>
</script>
<!-- 
PARCHE DEFINITIVO: SUBIR ARCHIVOS WORD/TXT - VERSI√ìN COMPLETA
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
Este es el parche completo y definitivo que incluye toda la funcionalidad
-->

<script>
// ========== PARCHE DEFINITIVO: ARCHIVOS WORD/TXT ==========
console.log('üìÅ Aplicando PARCHE DEFINITIVO para archivos Word/TXT...');

// 1. INICIALIZAR ESTADO PARA ARCHIVOS
if (!state.selectedFiles) {
    state.selectedFiles = [];
}

// 2. GUARDAR FUNCI√ìN ORIGINAL Y REEMPLAZAR
const originalRenderUploadTabDef = renderUploadTab;

renderUploadTab = function() {
    return `
        <div class="three-column">
            <!-- PRIMERA COLUMNA: IM√ÅGENES -->
            <div class="column">
                <h3 style="margin-bottom: 15px;">üì§ Subir Im√°genes</h3>
                <div class="upload-area" onclick="document.getElementById('imageInput').click()">
                    <div>üìÅ Seleccionar im√°genes</div>
                    <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Hasta 10 im√°genes</div>
                    <div style="margin-top: 10px; color: #4f46e5; font-weight: 500;">
                        ${state.selectedImages.length}/10 archivos
                    </div>
                </div>
                <input type="file" id="imageInput" style="display: none;" accept="image/*" multiple>
                
                ${state.selectedImages.length > 0 ? `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                        ${state.selectedImages.map((file, i) => `
                            <div style="position: relative; text-align: center; padding: 10px; background: #f3f4f6; border-radius: 8px;">
                                <button onclick="removeImage(${i})" style="position: absolute; top: 5px; right: 5px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer;">√ó</button>
                                <div style="font-size: 10px; word-break: break-all;">${file.name}</div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>

            <!-- SEGUNDA COLUMNA: ARCHIVOS -->
            <div class="column">
                <h3 style="margin-bottom: 15px;">üìÑ Subir Archivos</h3>
                <div class="upload-area" onclick="document.getElementById('fileInputDef').click()">
                    <div>üìé Seleccionar archivos</div>
                    <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Word (.docx) y Texto (.txt)</div>
                    <div style="margin-top: 10px; color: #4f46e5; font-weight: 500;">
                        ${state.selectedFiles.length}/5 archivos
                    </div>
                </div>
                <input type="file" id="fileInputDef" style="display: none;" accept=".docx,.txt" multiple>
                
                ${state.selectedFiles.length > 0 ? `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                        ${state.selectedFiles.map((file, i) => `
                            <div style="position: relative; text-align: center; padding: 10px; background: #f3f4f6; border-radius: 8px;">
                                <button onclick="removeFileDef(${i})" style="position: absolute; top: 5px; right: 5px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer;">√ó</button>
                                <div style="font-size: 10px; word-break: break-all;">${file.name}</div>
                                <div style="font-size: 8px; color: #9ca3af;">${file.name.toLowerCase().endsWith('.docx') ? 'DOCX' : 'TXT'}</div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>

            <!-- TERCERA COLUMNA: TEXTO TRANSCRITO -->
            <div class="column">
                <h3 style="margin-bottom: 15px;">üìù Texto Transcrito</h3>
                <textarea id="cleanedText" class="textarea" placeholder="El texto procesado aparecer√° aqu√≠..." readonly>${state.cleanedText}</textarea>
                
                <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px;">
                    <h4 style="color: #92400e; margin-bottom: 10px;">üè∑Ô∏è Gesti√≥n de Temas</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <button onclick="createTopic()" class="btn btn-info" style="width: 100%; padding: 8px; font-size: 13px;">
                            üÜï Crear Tema
                        </button>
                        
                        <div style="position: relative;">
                            <select id="topic-selector" onchange="updateSelectedTopic()" style="width: 100%; padding: 8px; border: none; background: #f59e0b; color: white; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer;" ${state.topics.length === 0 ? 'disabled' : ''}>
                                <option value="">üè∑Ô∏è Seleccionar Tema</option>
                                ${state.topics.map(topic => `
                                    <option value="${topic.id}" ${state.selectedTopicForNewQuestions === topic.id ? 'selected' : ''}>
                                        ${topic.name} (${getTopicQuestionCountDef(topic.id)})
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                    </div>
                    
                    ${state.topics.length === 0 ? `
                        <div style="text-align: center; color: #92400e; font-size: 12px; margin-bottom: 10px;">
                            ‚ö†Ô∏è Crea un tema primero para organizar tus preguntas
                        </div>
                    ` : ''}
                    
                    <button onclick="addToQuestions()" class="btn btn-success" style="width: 100%;" ${!state.cleanedText ? 'disabled' : ''}>
                        ${getAddButtonTextDef()}
                    </button>
                </div>
            </div>
        </div>
        
        <!-- BOT√ìN CENTRAL DE TRANSCRIPCI√ìN -->
        <div style="text-align: center; margin: 20px 0;">
            <button onclick="transcribeAllContentDef()" class="btn btn-primary" style="padding: 15px 40px; font-size: 18px; font-weight: bold;" ${(state.selectedImages.length === 0 && state.selectedFiles.length === 0) || !state.apiKey ? 'disabled' : ''}>
                ü§ñ 1. Transcribir y Procesar
            </button>
            
            ${state.transcribedText && !state.cleanedText ? `
                <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; display: inline-block;">
                    <span style="color: #92400e;">üìÑ Procesando texto autom√°ticamente...</span>
                </div>
            ` : ''}
        </div>
    `;
};

// 3. FUNCIONES AUXILIARES
function removeFileDef(index) {
    state.selectedFiles.splice(index, 1);
    render();
    if (typeof showMessage === 'function') {
        showMessage('Archivo eliminado', 'success');
    }
}

function getTopicQuestionCountDef(topicId) {
    if (typeof getTopicQuestionCount === 'function') {
        return getTopicQuestionCount(topicId);
    }
    return state.questions.filter(q => q.topicId && q.topicId.toString() === topicId.toString()).length;
}

function getAddButtonTextDef() {
    if (typeof getAddButtonText === 'function') {
        return getAddButtonText();
    }
    if (!state.selectedTopicForNewQuestions) {
        return '‚úÖ 2. A√±adir al Banco';
    } else {
        const topicName = getTopicNameDef(state.selectedTopicForNewQuestions);
        return `‚úÖ 2. Asignar a "${topicName}"`;
    }
}

function getTopicNameDef(topicId) {
    if (typeof getTopicName === 'function') {
        return getTopicName(topicId);
    }
    const topic = state.topics.find(t => t.id == topicId);
    return topic ? topic.name : 'Tema no encontrado';
}

// 4. LISTENER PARA ARCHIVOS
document.addEventListener('change', function(e) {
    if (e.target && e.target.id === 'fileInputDef') {
        const files = Array.from(e.target.files);
        const validFiles = files.filter(file => 
            file.name.toLowerCase().endsWith('.docx') || 
            file.name.toLowerCase().endsWith('.txt')
        );
        
        if (validFiles.length > 0) {
            const maxFiles = 5;
            const availableSlots = maxFiles - state.selectedFiles.length;
            const filesToAdd = validFiles.slice(0, availableSlots);
            
            state.selectedFiles.push(...filesToAdd);
            render();
            
            if (typeof showMessage === 'function') {
                showMessage(`${filesToAdd.length} archivo(s) seleccionado(s)`, 'success');
            }
        }
        
        e.target.value = '';
    }
});

// 5. FUNCI√ìN PRINCIPAL DE TRANSCRIPCI√ìN (USANDO PROXY)
window.transcribeAllContentDef = async function() {
    if (!state.apiKey) {
        if (typeof showMessage === 'function') {
            showMessage('Configura tu API key primero', 'error');
        }
        return;
    }

    if (state.selectedImages.length === 0 && state.selectedFiles.length === 0) {
        if (typeof showMessage === 'function') {
            showMessage('Selecciona al menos una imagen o archivo', 'error');
        }
        return;
    }

    if (typeof showMessage === 'function') {
        showMessage('Procesando contenido...', 'success');
    }
    
    try {
        let allTranscriptions = [];
        
        // PROCESAR IM√ÅGENES
        if (state.selectedImages.length > 0) {
            if (typeof showMessage === 'function') {
                showMessage('Transcribiendo im√°genes...', 'success');
            }
            
            for (let i = 0; i < state.selectedImages.length; i++) {
                const file = state.selectedImages[i];
                const base64 = await fileToBase64Def(file);
                
                const messageContent = [
                    {
                        type: "image",
                        source: {
                            type: "base64",
                            media_type: file.type,
                            data: base64
                        }
                    },
                    {
                        type: "text",
                        text: `Act√∫a como un transcriptor de texto para una persona ciega. Analiza esta imagen y extrae todo el texto visible de manera secuencial.

INSTRUCCIONES CR√çTICAS:
- Solo dicta las palabras que ves, como si estuvieras hablando en voz alta
- Encuentra las preguntas numeradas y sus opciones de respuesta
- CONSERVA y DESCRIBE todos los s√≠mbolos visuales de respuesta correcta que veas
- MANT√âN s√≠mbolos como: ‚úì, ‚úî, checkmarks, asteriscos, vi√±etas, flechas
- DESCRIBE elementos visuales importantes: "opci√≥n marcada en verde", "con tick", "con check", "respuesta correcta", "marcada"
- PRESERVA cualquier indicaci√≥n visual de que una opci√≥n es la correcta

IMPORTANTE: NO elimines s√≠mbolos de respuesta correcta - los necesitamos para el siguiente paso.

Responde con el texto extra√≠do conservando TODOS los s√≠mbolos y marcas visuales.`
                    }
                ];

                try {
                    const response = await fetch("/api/anthropic", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "x-api-key": state.apiKey,
                        },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 4000,
                            messages: [{
                                role: "user",
                                content: messageContent
                            }]
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        allTranscriptions.push(`IMAGEN ${i + 1}:\n${data.content[0].text}`);
                    } else {
                        allTranscriptions.push(`IMAGEN ${i + 1}:\nERROR: No se pudo procesar (${response.status})`);
                    }
                } catch (error) {
                    allTranscriptions.push(`IMAGEN ${i + 1}:\nERROR: ${error.message}`);
                }
            }
        }
        
        // PROCESAR ARCHIVOS
        if (state.selectedFiles.length > 0) {
            if (typeof showMessage === 'function') {
                showMessage('Procesando archivos...', 'success');
            }
            
            for (let i = 0; i < state.selectedFiles.length; i++) {
                const file = state.selectedFiles[i];
                let textContent = '';
                
                try {
                    if (file.name.toLowerCase().endsWith('.txt')) {
                        textContent = await readTextFileDef(file);
                    } else if (file.name.toLowerCase().endsWith('.docx')) {
                        textContent = await readDocxFileDef(file);
                    }
                    
                    // PROCESAR CONTENIDO DEL ARCHIVO CON IA
                    const response = await fetch("/api/anthropic", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "x-api-key": state.apiKey,
                        },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 4000,
                            messages: [{
                                role: "user",
                                content: `Analiza este contenido de archivo y organiza la informaci√≥n de manera estructurada.

INSTRUCCIONES:
- Si encuentras preguntas de examen, organ√≠zalas claramente
- CONSERVA todos los s√≠mbolos y marcas de respuestas correctas
- Mant√©n la numeraci√≥n original de las preguntas
- Preserva el formato de opciones m√∫ltiples si existe
- NO elimines informaci√≥n importante

CONTENIDO DEL ARCHIVO "${file.name}":
${textContent}`
                            }]
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        allTranscriptions.push(`ARCHIVO: ${file.name}\n${data.content[0].text}`);
                    } else {
                        allTranscriptions.push(`ARCHIVO: ${file.name}\nERROR: No se pudo procesar con IA`);
                    }
                } catch (error) {
                    allTranscriptions.push(`ARCHIVO: ${file.name}\nERROR: ${error.message}`);
                }
            }
        }
        
        // COMBINAR TRANSCRIPCIONES
        const combinedText = allTranscriptions.join('\n\n=== SEPARADOR DE CONTENIDO ===\n\n');
        state.transcribedText = combinedText;
        render();
        
        if (typeof showMessage === 'function') {
            showMessage('Contenido transcrito. Limpiando y procesando...', 'success');
        }
        
        // LIMPIAR TEXTO AUTOM√ÅTICAMENTE
        await cleanTextDef();
        
    } catch (error) {
        console.error('Error completo:', error);
        if (typeof showMessage === 'function') {
            showMessage(`Error general: ${error.message}`, 'error');
        }
    }
};

// 6. FUNCIONES DE LECTURA DE ARCHIVOS
function fileToBase64Def(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
    });
}

function readTextFileDef(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsText(file, 'UTF-8');
    });
}

async function readDocxFileDef(file) {
    try {
        // Cargar mammoth si no est√° disponible
        if (typeof window.mammoth === 'undefined') {
            await loadMammothDef();
        }
        
        const arrayBuffer = await readArrayBufferDef(file);
        const result = await window.mammoth.extractRawText({arrayBuffer: arrayBuffer});
        return result.value;
    } catch (error) {
        return `ERROR: No se pudo leer el archivo DOCX. ${error.message}`;
    }
}

function readArrayBufferDef(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
    });
}

function loadMammothDef() {
    return new Promise((resolve, reject) => {
        if (typeof window.mammoth !== 'undefined') {
            resolve();
            return;
        }
        
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js';
        script.onload = () => {
            console.log('‚úÖ Mammoth.js cargado exitosamente');
            resolve();
        };
        script.onerror = () => {
            console.error('‚ùå Error cargando mammoth.js');
            reject(new Error('No se pudo cargar mammoth.js'));
        };
        document.head.appendChild(script);
    });
}

// 7. FUNCI√ìN DE LIMPIEZA DE TEXTO
async function cleanTextDef() {
    if (!state.transcribedText) return;
    
    try {
        const response = await fetch("/api/anthropic", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "x-api-key": state.apiKey,
            },
            body: JSON.stringify({
                model: "claude-sonnet-4-20250514",
                max_tokens: 4000,
                messages: [{
                    role: "user",
                    content: `Limpia este texto extra√≠do de m√∫ltiples im√°genes y archivos, convirti√©ndolo en formato de preguntas para banco de preguntas:

TEXTO A LIMPIAR:
${state.transcribedText}

INSTRUCCIONES CR√çTICAS PARA DETECTAR RESPUESTAS CORRECTAS:
- Busca s√≠mbolos visuales: ‚úì, ‚úî, *, ‚Ä¢, ‚Üí, >, checkmarks, ticks
- Busca descripciones: "marcada", "marcada en verde", "respuesta correcta", "con tick", "con check"
- Busca colores mencionados: "verde", "resaltada", "seleccionada"
- MARCA EN NEGRITA las opciones que tengan cualquiera de estos indicadores usando **texto**
- Elimina los s√≠mbolos y descripciones visuales DESPU√âS de identificar las correctas
- Extrae solo las preguntas y opciones de respuesta
- Numera las preguntas secuencialmente

FORMATO DE SALIDA ESTRICTO:
PREGUNTA: [texto de la pregunta]
OPCION_A: [opci√≥n a normal]
OPCION_B: **[opci√≥n b si tiene s√≠mbolo/marca de correcta]**
OPCION_C: [opci√≥n c normal]
OPCION_D: **[opci√≥n d si tiene s√≠mbolo/marca de correcta]**

IMPORTANTE: Cualquier opci√≥n con s√≠mbolo, marca visual, color verde, o descripci√≥n de "correcta" debe ir en **negritas**.`
                }]
            })
        });

        if (response.ok) {
            const data = await response.json();
            state.cleanedText = data.content[0].text;
            render();
            
            if (typeof showMessage === 'function') {
                showMessage('¬°Texto procesado y listo para a√±adir al banco!', 'success');
            }
        } else {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
    } catch (error) {
        if (typeof showMessage === 'function') {
            showMessage(`Error en limpieza: ${error.message}`, 'error');
        }
    }
}

// 8. LIMPIAR ESTADOS AL VOLVER AL MEN√ö (si existe la funci√≥n)
if (typeof goToMainMenuUnified === 'function') {
    const originalGoToMainMenuUnified = goToMainMenuUnified;
    goToMainMenuUnified = function() {
        state.selectedFiles = [];
        originalGoToMainMenuUnified();
    };
}

console.log('‚úÖ PARCHE DEFINITIVO aplicado correctamente');
console.log('üéØ Funcionalidades completas:');
console.log('   - ‚úÖ Subir im√°genes (original)');
console.log('   - ‚úÖ Subir archivos .docx y .txt');
console.log('   - ‚úÖ Interfaz de dos columnas');
console.log('   - ‚úÖ Bot√≥n centralizado de procesamiento');
console.log('   - ‚úÖ API proxy sin CORS');
console.log('   - ‚úÖ Procesamiento IA inteligente');
console.log('   - ‚úÖ Compatible con c√≥digo existente');
console.log('   - ‚úÖ Manejo robusto de errores');
console.log('üìÅ Sistema listo para procesar im√°genes y archivos');
</script>
    <!-- 
PARCHE RESPONSIVE: ADAPTACI√ìN M√ìVIL Y TABLET
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
Este parche hace la web completamente responsive
-->

<style>
/* ========== PARCHE RESPONSIVE ========== */

/* RESET DE ALTURA PARA PERMITIR SCROLL */
html, body {
    height: auto !important;
    min-height: 100vh;
    overflow-x: hidden;
    overflow-y: auto !important;
}

#app {
    min-height: 100vh;
    height: auto !important;
    overflow: visible !important;
}

.container {
    min-height: 100vh;
    height: auto !important;
    padding: 10px;
    box-sizing: border-box;
}

/* GRID RESPONSIVO MEJORADO */
.three-column {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
}

/* TABLET - 768px a 1024px */
@media (max-width: 1024px) {
    .three-column {
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }
    
    .three-column .column:last-child {
        grid-column: 1 / -1;
    }
    
    .container {
        padding: 15px;
    }
    
    /* Ajustar navegaci√≥n */
    .nav-tabs {
        flex-wrap: wrap;
        gap: 5px;
    }
    
    .nav-tab {
        font-size: 12px !important;
        padding: 8px 12px !important;
        min-width: auto;
    }
}

/* M√ìVIL - hasta 768px */
@media (max-width: 768px) {
    .three-column {
        grid-template-columns: 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .container {
        padding: 10px;
    }
    
    /* NAVEGACI√ìN M√ìVIL */
    .nav-tabs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 15px;
    }
    
    .nav-tab {
        font-size: 11px !important;
        padding: 10px 8px !important;
        text-align: center;
        line-height: 1.2;
        border-radius: 8px !important;
    }
    
    /* HEADER M√ìVIL */
    .header {
        flex-direction: column;
        gap: 10px;
        text-align: center;
        padding: 15px 10px;
    }
    
    .title {
        font-size: 1.5rem !important;
        margin-bottom: 10px;
    }
    
    /* COLUMNAS M√ìVIL */
    .column {
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .column h3 {
        font-size: 1.1rem !important;
        margin-bottom: 12px !important;
    }
    
    /* √ÅREAS DE SUBIDA M√ìVIL */
    .upload-area {
        padding: 25px 15px !important;
        margin-bottom: 15px !important;
    }
    
    .upload-area div:first-child {
        font-size: 14px !important;
    }
    
    .upload-area div:nth-child(2) {
        font-size: 11px !important;
    }
    
    .upload-area div:nth-child(3) {
        font-size: 16px !important;
        font-weight: 600 !important;
        margin-top: 8px !important;
    }
    
    /* GRIDS DE ARCHIVOS M√ìVIL */
    .column div[style*="grid-template-columns: repeat(3, 1fr)"] {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 8px !important;
    }
    
    .column div[style*="grid-template-columns: repeat(2, 1fr)"] {
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 8px !important;
    }
    
    /* TEXTAREA M√ìVIL */
    .textarea {
        min-height: 200px !important;
        font-size: 13px !important;
        padding: 12px !important;
    }
    
    /* BOTONES M√ìVIL */
    .btn {
        padding: 12px 16px !important;
        font-size: 14px !important;
        border-radius: 8px !important;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        line-height: 1.3;
        margin-bottom: 8px;
    }
    
    /* BOT√ìN PRINCIPAL M√ìVIL */
    button[onclick="transcribeAllContent()"] {
        padding: 16px 20px !important;
        font-size: 16px !important;
        font-weight: bold !important;
        min-height: 56px !important;
        border-radius: 12px !important;
        margin: 20px 0 !important;
        width: 100% !important;
        max-width: none !important;
    }
    
    /* GESTI√ìN DE TEMAS M√ìVIL */
    .column div[style*="background: #fef3c7"] {
        padding: 12px !important;
        border-radius: 8px !important;
    }
    
    .column div[style*="background: #fef3c7"] h4 {
        font-size: 14px !important;
        margin-bottom: 8px !important;
    }
    
    .column div[style*="display: grid; grid-template-columns: 1fr 1fr"] {
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 8px !important;
        margin-bottom: 12px !important;
    }
    
    /* SELECT Y INPUTS M√ìVIL */
    select, input[type="text"] {
        padding: 12px !important;
        font-size: 14px !important;
        border-radius: 6px !important;
        min-height: 44px !important;
    }
    
    /* MENSAJES M√ìVIL */
    #messages .message {
        padding: 10px 15px;
        font-size: 14px;
        border-radius: 8px;
        margin-bottom: 10px;
    }
}

/* M√ìVIL PEQUE√ëO - hasta 480px */
@media (max-width: 480px) {
    .container {
        padding: 8px;
    }
    
    .nav-tabs {
        grid-template-columns: 1fr;
        gap: 6px;
    }
    
    .nav-tab {
        font-size: 12px !important;
        padding: 12px 10px !important;
    }
    
    .column {
        padding: 12px;
    }
    
    .upload-area {
        padding: 20px 12px !important;
    }
    
    .textarea {
        min-height: 180px !important;
        font-size: 12px !important;
    }
    
    button[onclick="transcribeAllContent()"] {
        font-size: 15px !important;
        padding: 14px 16px !important;
    }
    
    /* Archivos en una sola columna */
    .column div[style*="grid-template-columns"] {
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 6px !important;
    }
}

/* PANTALLAS GRANDES - m√°s de 1200px */
@media (min-width: 1200px) {
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .three-column {
        gap: 25px;
    }
    
    .textarea {
        min-height: 350px;
    }
}

/* FIXES ADICIONALES PARA SCROLL */
.three-column .column {
    overflow: visible;
    height: auto;
}

/* TEXTO TRANSCRITO SCROLLABLE */
.textarea {
    resize: vertical;
    max-height: 400px;
    overflow-y: auto;
}

/* BOTONES SIEMPRE VISIBLES */
.btn {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* CONTENEDOR PRINCIPAL SIN ALTURA FIJA */
body > div, #app > div {
    min-height: auto !important;
    height: auto !important;
}

/* FORZAR VISIBILIDAD DE SCROLL */
body {
    -webkit-overflow-scrolling: touch;
}

/* MEJORAR TOUCH EN M√ìVILES */
@media (max-width: 768px) {
    .upload-area, .btn, select, input {
        -webkit-tap-highlight-color: rgba(0,0,0,0.1);
        cursor: pointer;
    }
    
    /* Espaciado entre elementos */
    .column > * {
        margin-bottom: 12px;
    }
    
    .column > *:last-child {
        margin-bottom: 0;
    }
}

/* CENTRAJE DEL BOT√ìN PRINCIPAL */
div[style*="text-align: center; margin: 20px 0"] {
    text-align: center !important;
    margin: 20px 0 !important;
    padding: 0 10px;
}

@media (max-width: 768px) {
    div[style*="text-align: center; margin: 20px 0"] {
        margin: 15px 0 !important;
        padding: 0 5px;
    }
}
</style>

<script>
// ========== PARCHE RESPONSIVE JAVASCRIPT ==========
console.log('üì± Aplicando parche responsive...');

// FUNCI√ìN PARA DETECTAR TAMA√ëO DE PANTALLA
function getScreenSize() {
    const width = window.innerWidth;
    if (width <= 480) return 'mobile-small';
    if (width <= 768) return 'mobile';
    if (width <= 1024) return 'tablet';
    return 'desktop';
}

// AJUSTAR ALTURA DE TEXTAREA SEG√öN PANTALLA
function adjustTextareaHeight() {
    const textareas = document.querySelectorAll('.textarea');
    const screenSize = getScreenSize();
    
    textareas.forEach(textarea => {
        switch(screenSize) {
            case 'mobile-small':
                textarea.style.minHeight = '180px';
                break;
            case 'mobile':
                textarea.style.minHeight = '200px';
                break;
            case 'tablet':
                textarea.style.minHeight = '250px';
                break;
            default:
                textarea.style.minHeight = '300px';
        }
    });
}

// LISTENER PARA CAMBIOS DE ORIENTACI√ìN/TAMA√ëO
window.addEventListener('resize', function() {
    setTimeout(() => {
        adjustTextareaHeight();
        
        // Forzar scroll si es necesario
        if (getScreenSize() !== 'desktop') {
            document.body.style.overflowY = 'auto';
            document.documentElement.style.overflowY = 'auto';
        }
    }, 100);
});

// APLICAR AL CARGAR
document.addEventListener('DOMContentLoaded', function() {
    adjustTextareaHeight();
});

// INTERCEPTAR RENDER PARA APLICAR RESPONSIVE
const originalRenderResponsive = window.render;
if (originalRenderResponsive) {
    window.render = function() {
        originalRenderResponsive.call(this);
        
        // Aplicar ajustes despu√©s del render
        setTimeout(() => {
            adjustTextareaHeight();
            
            // Asegurar scroll visible
            document.body.style.height = 'auto';
            document.body.style.overflowY = 'auto';
            
            const app = document.getElementById('app');
            if (app) {
                app.style.height = 'auto';
                app.style.minHeight = '100vh';
            }
        }, 50);
    };
}

console.log('‚úÖ Parche responsive aplicado correctamente');
console.log('üì± Funcionalidades a√±adidas:');
console.log('   - Dise√±o responsive completo');
console.log('   - Adaptaci√≥n m√≥vil y tablet');
console.log('   - Scroll habilitado');
console.log('   - Botones y elementos visibles');
console.log('   - Touch optimizado para m√≥viles');
</script>
    <!-- 
PARCHE RESPONSIVE: ADAPTACI√ìN M√ìVIL Y TABLET
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
Este parche hace la web completamente responsive
-->

<style>
/* ========== PARCHE RESPONSIVE ========== */

/* RESET DE ALTURA PARA PERMITIR SCROLL */
html, body {
    height: auto !important;
    min-height: 100vh;
    overflow-x: hidden;
    overflow-y: auto !important;
}

#app {
    min-height: 100vh;
    height: auto !important;
    overflow: visible !important;
}

.container {
    min-height: 100vh;
    height: auto !important;
    padding: 10px;
    box-sizing: border-box;
}

/* GRID RESPONSIVO MEJORADO */
.three-column {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
}

/* TABLET - 768px a 1024px */
@media (max-width: 1024px) {
    .three-column {
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }
    
    .three-column .column:last-child {
        grid-column: 1 / -1;
    }
    
    .container {
        padding: 15px;
    }
    
    /* Ajustar navegaci√≥n */
    .nav-tabs {
        flex-wrap: wrap;
        gap: 5px;
    }
    
    .nav-tab {
        font-size: 12px !important;
        padding: 8px 12px !important;
        min-width: auto;
    }
}

/* M√ìVIL - hasta 768px */
@media (max-width: 768px) {
    .three-column {
        grid-template-columns: 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .container {
        padding: 10px;
    }
    
    /* NAVEGACI√ìN M√ìVIL */
    .nav-tabs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 15px;
    }
    
    .nav-tab {
        font-size: 11px !important;
        padding: 10px 8px !important;
        text-align: center;
        line-height: 1.2;
        border-radius: 8px !important;
    }
    
    /* HEADER M√ìVIL */
    .header {
        flex-direction: column;
        gap: 10px;
        text-align: center;
        padding: 15px 10px;
    }
    
    .title {
        font-size: 1.5rem !important;
        margin-bottom: 10px;
    }
    
    /* COLUMNAS M√ìVIL */
    .column {
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .column h3 {
        font-size: 1.1rem !important;
        margin-bottom: 12px !important;
    }
    
    /* √ÅREAS DE SUBIDA M√ìVIL */
    .upload-area {
        padding: 25px 15px !important;
        margin-bottom: 15px !important;
    }
    
    .upload-area div:first-child {
        font-size: 14px !important;
    }
    
    .upload-area div:nth-child(2) {
        font-size: 11px !important;
    }
    
    .upload-area div:nth-child(3) {
        font-size: 16px !important;
        font-weight: 600 !important;
        margin-top: 8px !important;
    }
    
    /* GRIDS DE ARCHIVOS M√ìVIL */
    .column div[style*="grid-template-columns: repeat(3, 1fr)"] {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 8px !important;
    }
    
    .column div[style*="grid-template-columns: repeat(2, 1fr)"] {
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 8px !important;
    }
    
    /* TEXTAREA M√ìVIL */
    .textarea {
        min-height: 200px !important;
        font-size: 13px !important;
        padding: 12px !important;
    }
    
    /* BOTONES M√ìVIL */
    .btn {
        padding: 12px 16px !important;
        font-size: 14px !important;
        border-radius: 8px !important;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        line-height: 1.3;
        margin-bottom: 8px;
    }
    
    /* BOT√ìN PRINCIPAL M√ìVIL */
    button[onclick="transcribeAllContent()"] {
        padding: 16px 20px !important;
        font-size: 16px !important;
        font-weight: bold !important;
        min-height: 56px !important;
        border-radius: 12px !important;
        margin: 20px 0 !important;
        width: 100% !important;
        max-width: none !important;
    }
    
    /* GESTI√ìN DE TEMAS M√ìVIL */
    .column div[style*="background: #fef3c7"] {
        padding: 12px !important;
        border-radius: 8px !important;
    }
    
    .column div[style*="background: #fef3c7"] h4 {
        font-size: 14px !important;
        margin-bottom: 8px !important;
    }
    
    .column div[style*="display: grid; grid-template-columns: 1fr 1fr"] {
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 8px !important;
        margin-bottom: 12px !important;
    }
    
    /* SELECT Y INPUTS M√ìVIL */
    select, input[type="text"] {
        padding: 12px !important;
        font-size: 14px !important;
        border-radius: 6px !important;
        min-height: 44px !important;
    }
    
    /* MENSAJES M√ìVIL */
    #messages .message {
        padding: 10px 15px;
        font-size: 14px;
        border-radius: 8px;
        margin-bottom: 10px;
    }
}

/* M√ìVIL PEQUE√ëO - hasta 480px */
@media (max-width: 480px) {
    .container {
        padding: 8px;
    }
    
    .nav-tabs {
        grid-template-columns: 1fr;
        gap: 6px;
    }
    
    .nav-tab {
        font-size: 12px !important;
        padding: 12px 10px !important;
    }
    
    .column {
        padding: 12px;
    }
    
    .upload-area {
        padding: 20px 12px !important;
    }
    
    .textarea {
        min-height: 180px !important;
        font-size: 12px !important;
    }
    
    button[onclick="transcribeAllContent()"] {
        font-size: 15px !important;
        padding: 14px 16px !important;
    }
    
    /* Archivos en una sola columna */
    .column div[style*="grid-template-columns"] {
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 6px !important;
    }
}

/* PANTALLAS GRANDES - m√°s de 1200px */
@media (min-width: 1200px) {
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .three-column {
        gap: 25px;
    }
    
    .textarea {
        min-height: 350px;
    }
}

/* FIXES ADICIONALES PARA SCROLL */
.three-column .column {
    overflow: visible;
    height: auto;
}

/* TEXTO TRANSCRITO SCROLLABLE */
.textarea {
    resize: vertical;
    max-height: 400px;
    overflow-y: auto;
}

/* BOTONES SIEMPRE VISIBLES */
.btn {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* CONTENEDOR PRINCIPAL SIN ALTURA FIJA */
body > div, #app > div {
    min-height: auto !important;
    height: auto !important;
}

/* FORZAR VISIBILIDAD DE SCROLL */
body {
    -webkit-overflow-scrolling: touch;
}

/* MEJORAR TOUCH EN M√ìVILES */
@media (max-width: 768px) {
    .upload-area, .btn, select, input {
        -webkit-tap-highlight-color: rgba(0,0,0,0.1);
        cursor: pointer;
    }
    
    /* Espaciado entre elementos */
    .column > * {
        margin-bottom: 12px;
    }
    
    .column > *:last-child {
        margin-bottom: 0;
    }
}

/* CENTRAJE DEL BOT√ìN PRINCIPAL */
div[style*="text-align: center; margin: 20px 0"] {
    text-align: center !important;
    margin: 20px 0 !important;
    padding: 0 10px;
}

@media (max-width: 768px) {
    div[style*="text-align: center; margin: 20px 0"] {
        margin: 15px 0 !important;
        padding: 0 5px;
    }
}
</style>
    <!-- 
PARCHE SIMPLE: BOT√ìN ELIMINAR EN HEADER DE TEMA
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
Este parche a√±ade un bot√≥n de eliminar directamente en el header de cada tema
-->

<script>
// ========== PARCHE SIMPLE: BOT√ìN ELIMINAR EN HEADER ==========
console.log('üóëÔ∏è Aplicando parche simple: bot√≥n eliminar en header...');

// GUARDAR LA FUNCI√ìN ORIGINAL
const originalRenderQuestionsByTopicSimple = renderQuestionsByTopic;

// REEMPLAZAR renderQuestionsByTopic
renderQuestionsByTopic = function() {
    const questionsWithoutTopic = state.questions.filter(q => !q.topicId);
    
    let html = '';
    
    // Mostrar preguntas por cada tema que TENGA preguntas
    state.topics.forEach(topic => {
        const topicQuestions = state.questions.filter(q => q.topicId && q.topicId.toString() === topic.id.toString());
        if (topicQuestions.length > 0) {
            html += `
                <div style="margin-bottom: 30px;">
                    <h3 style="background: #4f46e5; color: white; padding: 10px 15px; border-radius: 8px 8px 0 0; margin: 0; display: flex; justify-content: space-between; align-items: center;">
                        <span>üìÅ ${topic.name}</span>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 14px; opacity: 0.9;">${topicQuestions.length} preguntas</span>
                            <button onclick="deleteTopicSimple('${topic.id}')" class="btn btn-danger" style="padding: 4px 8px; font-size: 12px; background: #dc2626; border: none; border-radius: 4px; color: white; cursor: pointer;" title="Eliminar tema">
                                üóëÔ∏è
                            </button>
                        </div>
                    </h3>
                    <div style="border: 1px solid #4f46e5; border-top: none; border-radius: 0 0 8px 8px; background: white;">
                        ${topicQuestions.map(q => {
                            const actualIndex = state.questions.findIndex(question => question.id === q.id);
                            return renderSingleQuestionSimple(q, actualIndex);
                        }).join('')}
                    </div>
                </div>
            `;
        }
    });
    
    // Mostrar preguntas sin tema asignado SI existen
    if (questionsWithoutTopic.length > 0) {
        html += `
            <div style="margin-bottom: 30px;">
                <h3 style="background: #6b7280; color: white; padding: 10px 15px; border-radius: 8px 8px 0 0; margin: 0; display: flex; justify-content: space-between; align-items: center;">
                    <span>üìÇ Sin tema asignado</span>
                    <span style="font-size: 14px; opacity: 0.9;">${questionsWithoutTopic.length} preguntas</span>
                </h3>
                <div style="border: 1px solid #6b7280; border-top: none; border-radius: 0 0 8px 8px; background: white;">
                    ${questionsWithoutTopic.map(q => {
                        const actualIndex = state.questions.findIndex(question => question.id === q.id);
                        return renderSingleQuestionSimple(q, actualIndex);
                    }).join('')}
                </div>
            </div>
        `;
    }
    
    // Si no hay preguntas en absoluto
    if (html === '') {
        return '<div style="padding: 40px; text-align: center; color: #9ca3af;">No hay preguntas disponibles en el banco</div>';
    }
    
    return html;
};

// FUNCI√ìN PARA ELIMINAR TEMA
window.deleteTopicSimple = function(topicId) {
    // Encontrar el tema
    const topicToDelete = state.topics.find(t => t.id == topicId);
    if (!topicToDelete) {
        if (typeof showMessage === 'function') {
            showMessage('Tema no encontrado', 'error');
        }
        return;
    }
    
    // Contar preguntas del tema
    const questionsInTopic = state.questions.filter(q => q.topicId && q.topicId.toString() === topicId.toString());
    const questionCount = questionsInTopic.length;
    
    // Confirmaci√≥n
    let confirmMessage = `¬øEliminar el tema "${topicToDelete.name}"?`;
    if (questionCount > 0) {
        confirmMessage += `\n\nEsto eliminar√° tambi√©n ${questionCount} pregunta${questionCount === 1 ? '' : 's'}.`;
    }
    confirmMessage += '\n\nEsta acci√≥n no se puede deshacer.';
    
    if (confirm(confirmMessage)) {
        // Eliminar tema
        state.topics = state.topics.filter(t => t.id != topicId);
        
        // Eliminar preguntas del tema
        const originalCount = state.questions.length;
        state.questions = state.questions.filter(q => !q.topicId || q.topicId.toString() !== topicId.toString());
        const deletedQuestions = originalCount - state.questions.length;
        
        // Guardar cambios
        localStorage.setItem('topics', JSON.stringify(state.topics));
        localStorage.setItem('questions', JSON.stringify(state.questions));
        
        // Re-renderizar
        render();
        
        // Mensaje de √©xito
        if (typeof showMessage === 'function') {
            if (deletedQuestions > 0) {
                showMessage(`Tema "${topicToDelete.name}" eliminado junto con ${deletedQuestions} pregunta${deletedQuestions === 1 ? '' : 's'}`, 'success');
            } else {
                showMessage(`Tema "${topicToDelete.name}" eliminado`, 'success');
            }
        }
    }
};

// FUNCI√ìN AUXILIAR PARA RENDERIZAR PREGUNTA INDIVIDUAL
function renderSingleQuestionSimple(q, actualIndex) {
    // Si existe la funci√≥n original, usarla
    if (typeof renderSingleQuestion === 'function') {
        return renderSingleQuestion(q, actualIndex);
    }
    
    // Fallback b√°sico
    const topicName = q.topicId ? getTopicNameSimple(q.topicId) : null;
    
    return `
        <div style="padding: 15px; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between;">
            <div style="flex: 1;">
                <div style="font-weight: 500; margin-bottom: 8px;">
                    ${q.question}
                    ${topicName && state.selectedTopicFilter === 'all' ? `<span style="background: #e0e7ff; color: #4f46e5; padding: 2px 6px; border-radius: 8px; font-size: 11px; margin-left: 8px;">${topicName}</span>` : ''}
                </div>
                <ul style="list-style: none; margin: 0; padding: 0;">
                    ${q.options.map((opt, optIndex) => `
                        <li style="padding: 2px 0; color: ${q.correctAnswer === optIndex ? '#10b981' : '#6b7280'};">
                            ${String.fromCharCode(97 + optIndex)}) ${opt} ${q.correctAnswer === optIndex ? '‚úì' : ''}
                        </li>
                    `).join('')}
                </ul>
            </div>
            <div style="display: flex; gap: 5px; flex-shrink: 0; margin-left: 15px;">
                <button onclick="editQuestion(${actualIndex})" class="btn btn-warning" style="padding: 5px 10px; font-size: 12px;">Editar</button>
                <button onclick="deleteQuestion(${actualIndex})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">Eliminar</button>
            </div>
        </div>
    `;
}

// FUNCI√ìN AUXILIAR PARA OBTENER NOMBRE DE TEMA
function getTopicNameSimple(topicId) {
    if (typeof getTopicName === 'function') {
        return getTopicName(topicId);
    }
    const topic = state.topics.find(t => t.id == topicId);
    return topic ? topic.name : 'Sin tema';
}

console.log('‚úÖ Parche simple aplicado correctamente');
console.log('üóëÔ∏è Funcionalidad a√±adida:');
console.log('   - Bot√≥n eliminar (üóëÔ∏è) en header de cada tema');
console.log('   - Aparece al lado del n√∫mero de preguntas');
console.log('   - Elimina tema + todas sus preguntas');
console.log('   - Confirmaci√≥n antes de eliminar');
console.log('   - Compatible con c√≥digo existente');
</script>
    <script>
// ========== DIAGN√ìSTICO Y CORRECCI√ìN CREATETOPIC ==========
console.log('üîß Aplicando diagn√≥stico y correcci√≥n de createTopic...');

// PASO 1: VERIFICAR QUE LA FUNCI√ìN EXISTE
console.log('üìã Estado inicial:');
console.log('- createTopic existe?', typeof window.createTopic);
console.log('- state.topics:', state.topics ? state.topics.length : 'undefined');
console.log('- render existe?', typeof window.render);

// PASO 2: FUNCI√ìN createTopic CORREGIDA Y ROBUSTA
window.createTopic = function() {
    console.log('üéØ Ejecutando createTopic...');
    
    try {
        // Solicitar nombre del tema
        const name = prompt('Nombre del nuevo tema:');
        
        if (!name) {
            console.log('‚ùå Cancelado - No se proporcion√≥ nombre');
            return;
        }
        
        if (name.trim().length === 0) {
            alert('El nombre no puede estar vac√≠o');
            console.log('‚ùå Nombre vac√≠o');
            return;
        }
        
        // Verificar que state.topics existe
        if (!state.topics) {
            console.log('‚ö†Ô∏è state.topics no existe, inicializando...');
            state.topics = [];
        }
        
        // Verificar si ya existe un tema con ese nombre
        const existingTopic = state.topics.find(t => t.name.toLowerCase() === name.trim().toLowerCase());
        if (existingTopic) {
            alert('Ya existe un tema con ese nombre');
            console.log('‚ùå Tema duplicado:', name);
            return;
        }
        
        // Generar ID √∫nico
        const newId = Date.now();
        
        // Crear nuevo tema
        const newTopic = {
            id: newId,
            name: name.trim(),
            createdAt: new Date().toISOString()
        };
        
        console.log('‚úÖ Creando tema:', newTopic);
        
        // Agregar al array de temas
        state.topics.push(newTopic);
        
        // Guardar en localStorage
        try {
            localStorage.setItem('topics', JSON.stringify(state.topics));
            console.log('üíæ Guardado en localStorage exitoso');
        } catch (error) {
            console.error('‚ùå Error guardando en localStorage:', error);
        }
        
        // Seleccionar autom√°ticamente el nuevo tema
        state.selectedTopicForNewQuestions = newId;
        console.log('üéØ Tema seleccionado autom√°ticamente:', newId);
        
        // Re-renderizar
        if (typeof window.render === 'function') {
            console.log('üîÑ Ejecutando render...');
            render();
        } else {
            console.error('‚ùå Funci√≥n render no existe');
        }
        
        // Mostrar mensaje de √©xito
        if (typeof showMessage === 'function') {
            showMessage(`Tema "${name}" creado exitosamente`, 'success');
        }
        
        console.log('‚úÖ Tema creado exitosamente');
        console.log('üìä Total de temas ahora:', state.topics.length);
        
    } catch (error) {
        console.error('‚ùå Error en createTopic:', error);
        alert('Error al crear el tema: ' + error.message);
    }
};

// PASO 3: VERIFICAR Y CORREGIR updateSelectedTopic
window.updateSelectedTopic = function() {
    console.log('üîÑ Ejecutando updateSelectedTopic...');
    
    try {
        const selector = document.getElementById('topic-selector');
        console.log('üìã Selector encontrado:', !!selector);
        
        if (!selector) {
            console.error('‚ùå No se encontr√≥ el selector topic-selector');
            return;
        }
        
        console.log('üéØ Valor seleccionado:', selector.value);
        
        if (selector.value) {
            const selectedValue = selector.value;
            const selectedTopic = state.topics.find(t => t.id == selectedValue);
            
            if (selectedTopic) {
                state.selectedTopicForNewQuestions = selectedTopic.id;
                console.log('‚úÖ Tema seleccionado:', selectedTopic.name);
                
                if (typeof showMessage === 'function') {
                    showMessage(`Tema "${selectedTopic.name}" seleccionado`, 'success');
                }
            } else {
                state.selectedTopicForNewQuestions = selectedValue;
                console.log('‚ö†Ô∏è Tema no encontrado, usando valor directo:', selectedValue);
            }
        } else {
            state.selectedTopicForNewQuestions = null;
            console.log('üö´ Ning√∫n tema seleccionado');
        }
        
        // Re-renderizar
        if (typeof window.render === 'function') {
            render();
        }
        
    } catch (error) {
        console.error('‚ùå Error en updateSelectedTopic:', error);
    }
};

// PASO 4: FUNCI√ìN DE DIAGN√ìSTICO COMPLETO
window.debugTopicSystem = function() {
    console.log('üîç DIAGN√ìSTICO COMPLETO DEL SISTEMA DE TEMAS:');
    console.log('==========================================');
    
    // Estado general
    console.log('üìä Estado general:');
    console.log('  - state definido:', typeof state);
    console.log('  - state.topics:', state.topics ? state.topics.length + ' temas' : 'undefined');
    console.log('  - selectedTopicForNewQuestions:', state.selectedTopicForNewQuestions);
    
    // Funciones
    console.log('üîß Funciones disponibles:');
    console.log('  - createTopic:', typeof window.createTopic);
    console.log('  - updateSelectedTopic:', typeof window.updateSelectedTopic);
    console.log('  - render:', typeof window.render);
    console.log('  - showMessage:', typeof window.showMessage);
    
    // DOM
    console.log('üåê Elementos DOM:');
    const createBtn = document.querySelector('button[onclick="createTopic()"]');
    const selector = document.getElementById('topic-selector');
    console.log('  - Bot√≥n crear tema:', !!createBtn);
    console.log('  - Selector tema:', !!selector);
    
    if (selector) {
        console.log('  - Opciones en selector:', selector.options.length);
        console.log('  - Selector habilitado:', !selector.disabled);
        console.log('  - Valor actual:', selector.value);
    }
    
    // LocalStorage
    console.log('üíæ LocalStorage:');
    try {
        const storedTopics = localStorage.getItem('topics');
        console.log('  - topics en localStorage:', storedTopics ? 'S√≠ (' + JSON.parse(storedTopics).length + ')' : 'No');
    } catch (error) {
        console.log('  - Error leyendo localStorage:', error.message);
    }
    
    // Lista de temas
    if (state.topics && state.topics.length > 0) {
        console.log('üìã Temas actuales:');
        state.topics.forEach((topic, index) => {
            console.log(`  ${index + 1}. ${topic.name} (ID: ${topic.id})`);
        });
    }
    
    console.log('==========================================');
    console.log('üí° Para probar: debugTopicSystem() en la consola');
};

// PASO 5: EJECUTAR DIAGN√ìSTICO INICIAL
setTimeout(() => {
    console.log('üöÄ Ejecutando diagn√≥stico inicial...');
    debugTopicSystem();
    
    // Verificar si el problema persiste
    console.log('üß™ PRUEBA R√ÅPIDA:');
    console.log('Ejecuta createTopic() en la consola para probar manualmente');
}, 1000);

console.log('‚úÖ Diagn√≥stico y correcci√≥n aplicados');
console.log('üîß Funciones de debugging disponibles:');
console.log('   - debugTopicSystem() - Diagn√≥stico completo');
console.log('   - createTopic() - Crear tema manualmente');
</script>

<script>
// Estado simple para carpetas colapsadas
let collapsedTopics = JSON.parse(localStorage.getItem('collapsedTopics') || '{}');

// Funci√≥n para alternar visibilidad de un tema
window.toggleTopicVisibility = function(topicId) {
    collapsedTopics[topicId] = !collapsedTopics[topicId];
    localStorage.setItem('collapsedTopics', JSON.stringify(collapsedTopics));
    
    // Cambiar visibilidad del div
    const contentDiv = document.getElementById('topic-content-' + topicId);
    const button = document.getElementById('toggle-btn-' + topicId);
    
    if (contentDiv) {
        if (collapsedTopics[topicId]) {
            contentDiv.style.display = 'none';
            button.textContent = '‚ñ∂';
            button.title = 'Mostrar preguntas';
        } else {
            contentDiv.style.display = 'block';
            button.textContent = '‚ñº';
            button.title = 'Ocultar preguntas';
        }
    }
};

// FUNCI√ìN PARA EDITAR TEMA
window.editTopicSimple = function(topicId) {
    // Encontrar el tema
    const topicToEdit = state.topics.find(t => t.id == topicId);
    if (!topicToEdit) {
        if (typeof showMessage === 'function') {
            showMessage('Tema no encontrado', 'error');
        }
        return;
    }
    
    // Solicitar nuevo nombre
    const newName = prompt('Nuevo nombre del tema:', topicToEdit.name);
    
    if (!newName) return; // Cancelado
    
    if (newName.trim().length === 0) {
        alert('El nombre no puede estar vac√≠o');
        return;
    }
    
    // Verificar si ya existe otro tema con ese nombre
    const existingTopic = state.topics.find(t => t.id != topicId && t.name.toLowerCase() === newName.trim().toLowerCase());
    if (existingTopic) {
        alert('Ya existe un tema con ese nombre');
        return;
    }
    
    // Actualizar el nombre
    topicToEdit.name = newName.trim();
    
    // Guardar cambios
    localStorage.setItem('topics', JSON.stringify(state.topics));
    
    // Re-renderizar
    render();
    
    // Mensaje de √©xito
    if (typeof showMessage === 'function') {
        showMessage(`Tema renombrado a "${newName.trim()}"`, 'success');
    }
};

// REEMPLAZAR renderQuestionsByTopic manteniendo eliminar tema
renderQuestionsByTopic = function() {
    const questionsWithoutTopic = state.questions.filter(q => !q.topicId);
    
    let html = '';
    
    // Mostrar preguntas por cada tema que TENGA preguntas
    state.topics.forEach(topic => {
        const topicQuestions = state.questions.filter(q => q.topicId && q.topicId.toString() === topic.id.toString());
        if (topicQuestions.length > 0) {
            const topicId = topic.id.toString();
            const isCollapsed = collapsedTopics[topicId] || false;
            
            html += `
                <div style="margin-bottom: 30px;">
                    <h3 style="background: #4f46e5; color: white; padding: 10px 15px; border-radius: 8px 8px 0 0; margin: 0; display: flex; justify-content: space-between; align-items: center;">
                        <span>üìÅ ${topic.name}</span>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 14px; opacity: 0.9;">${topicQuestions.length} preguntas</span>
                            <button id="toggle-btn-${topicId}" onclick="toggleTopicVisibility('${topicId}')" 
                                    style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold;"
                                    title="${isCollapsed ? 'Mostrar preguntas' : 'Ocultar preguntas'}">
                                ${isCollapsed ? '‚ñ∂' : '‚ñº'}
                            </button>
                            <button onclick="editTopicSimple('${topic.id}')" class="btn btn-warning" style="padding: 4px 8px; font-size: 12px; background: #f59e0b; border: none; border-radius: 4px; color: white; cursor: pointer;" title="Editar tema">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="deleteTopicSimple('${topic.id}')" class="btn btn-danger" style="padding: 4px 8px; font-size: 12px; background: #dc2626; border: none; border-radius: 4px; color: white; cursor: pointer;" title="Eliminar tema">
                                üóëÔ∏è
                            </button>
                        </div>
                    </h3>
                    <div id="topic-content-${topicId}" style="border: 1px solid #4f46e5; border-top: none; border-radius: 0 0 8px 8px; background: white; display: ${isCollapsed ? 'none' : 'block'};">
                        ${topicQuestions.map(q => {
                            const actualIndex = state.questions.findIndex(question => question.id === q.id);
                            return renderSingleQuestion(q, actualIndex);
                        }).join('')}
                    </div>
                </div>
            `;
        }
    });
    
    // Mostrar preguntas sin tema asignado SI existen
    if (questionsWithoutTopic.length > 0) {
        const topicId = 'sin-tema';
        const isCollapsed = collapsedTopics[topicId] || false;
        
        html += `
            <div style="margin-bottom: 30px;">
                <h3 style="background: #6b7280; color: white; padding: 10px 15px; border-radius: 8px 8px 0 0; margin: 0; display: flex; justify-content: space-between; align-items: center;">
                    <span>üìÇ Sin tema asignado</span>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 14px; opacity: 0.9;">${questionsWithoutTopic.length} preguntas</span>
                        <button id="toggle-btn-${topicId}" onclick="toggleTopicVisibility('${topicId}')" 
                                style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold;"
                                title="${isCollapsed ? 'Mostrar preguntas' : 'Ocultar preguntas'}">
                            ${isCollapsed ? '‚ñ∂' : '‚ñº'}
                        </button>
                    </div>
                </h3>
                <div id="topic-content-${topicId}" style="border: 1px solid #6b7280; border-top: none; border-radius: 0 0 8px 8px; background: white; display: ${isCollapsed ? 'none' : 'block'};">
                    ${questionsWithoutTopic.map(q => {
                        const actualIndex = state.questions.findIndex(question => question.id === q.id);
                        return renderSingleQuestion(q, actualIndex);
                    }).join('')}
                </div>
            </div>
        `;
    }
    
    // Si no hay preguntas en absoluto
    if (html === '') {
        return '<div style="padding: 40px; text-align: center; color: #9ca3af;">No hay preguntas disponibles en el banco</div>';
    }
    
    return html;
};

console.log('‚úÖ Triangulito colapsar a√±adido + bot√≥n eliminar tema mantenido');
console.log('‚úèÔ∏è Bot√≥n editar tema a√±adido con sincronizaci√≥n autom√°tica');
</script>
<script>

// Esperar a que todo el sistema est√© cargado
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        initializePhraseEditor();
    }, 1000);
});

// Backup por si no funciona DOMContentLoaded
setTimeout(function() {
    if (typeof summarySystemState !== 'undefined') {
        initializePhraseEditor();
    }
}, 2000);

function initializePhraseEditor() {
    console.log('üöÄ Inicializando editor de frases...');
    
    // Estado global para el editor de frases
    window.phraseEditor = {
        isActive: false,
        phrases: [],
        originalContent: '',
        initialized: false
    };
    
    // Detectar qu√© funci√≥n usar para renderizar la vista del resumen
    let renderFunction = null;
    let functionName = '';
    
    if (typeof renderViewSummaryEnhanced === 'function') {
        renderFunction = renderViewSummaryEnhanced;
        functionName = 'renderViewSummaryEnhanced';
    } else if (typeof renderViewSummary === 'function') {
        renderFunction = renderViewSummary;
        functionName = 'renderViewSummary';
    }
    
    if (!renderFunction) {
        console.error('‚ùå No se encontr√≥ funci√≥n de renderizado de resumen');
        return;
    }
    
    console.log('‚úÖ Usando funci√≥n:', functionName);
    
    // Guardar la funci√≥n original
    const originalFunction = renderFunction;
    
    // Reemplazar la funci√≥n detectada
    if (functionName === 'renderViewSummaryEnhanced') {
        window.renderViewSummaryEnhanced = createEnhancedRenderer(originalFunction);
    } else {
        window.renderViewSummary = createEnhancedRenderer(originalFunction);
    }
    
    phraseEditor.initialized = true;
    console.log('‚úÖ Editor de frases inicializado correctamente');
}

// Crear la funci√≥n de renderizado mejorada
function createEnhancedRenderer(originalFunction) {
    return function() {
        // Si estamos en modo edici√≥n de frases, mostrar el editor
        if (phraseEditor.isActive) {
            return renderPhraseEditMode();
        }
        
        // Si no, llamar a la funci√≥n original y a√±adir el bot√≥n
        let originalHTML = originalFunction.call(this);
        
        // A√±adir el bot√≥n "Editar Frases" si no existe
        if (originalHTML && originalHTML.includes && !originalHTML.includes('Editar Frases')) {
            // Buscar donde est√°n los botones de acci√≥n y a√±adir el nuestro
            const buttonSectionRegex = /(<div style="margin-top: 30px; display: flex; justify-content: center; gap: 15px;">)(.*?)(<\/div>)/s;
            
            if (buttonSectionRegex.test(originalHTML)) {
                originalHTML = originalHTML.replace(buttonSectionRegex, (match, openDiv, buttonsContent, closeDiv) => {
                    const editPhraseButton = `
                        <button onclick="startPhraseEditor()" class="btn btn-primary" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; font-weight: 600; border-radius: 8px; transition: all 0.2s ease;">
                            ‚úèÔ∏è Editar Frases
                        </button>
                    `;
                    return openDiv + editPhraseButton + buttonsContent + closeDiv;
                });
            } else {
                // Si no se encuentra el patr√≥n espec√≠fico, a√±adir al final
                originalHTML += `
                    <div style="margin-top: 30px; display: flex; justify-content: center; gap: 15px;">
                        <button onclick="startPhraseEditor()" class="btn btn-primary" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; font-weight: 600; border-radius: 8px; transition: all 0.2s ease;">
                            ‚úèÔ∏è Editar Frases
                        </button>
                    </div>
                `;
            }
        }
        
        return originalHTML;
    };
}

// üéØ Funci√≥n para iniciar el modo edici√≥n
window.startPhraseEditor = function() {
    if (!phraseEditor.initialized) {
        alert('‚ö†Ô∏è Editor de frases no inicializado. Espera unos segundos e intenta de nuevo.');
        return;
    }
    
    const summary = summarySystemState.viewingSummary;
    if (!summary) {
        alert('‚ùå No hay resumen seleccionado');
        return;
    }
    
    console.log('üöÄ Iniciando editor de frases...');
    
    // Guardamos el contenido original
    phraseEditor.originalContent = summary.content;
    
    // Dividimos el contenido en frases/p√°rrafos
    phraseEditor.phrases = summary.content
        .split(/\n\s*\n|\. (?=[A-Z])/)
        .map(text => text.trim())
        .filter(text => text.length > 0)
        .map((text, index) => ({
            id: index,
            text: text,
            isBold: false,
            isDeleted: false,
            isEditing: false
        }));
    
    // Activamos el modo edici√≥n
    phraseEditor.isActive = true;
    
    // Re-renderizamos
    render();
    
    console.log('‚úÖ Editor de frases iniciado con', phraseEditor.phrases.length, 'frases');
};

// üéØ Funci√≥n para renderizar el modo de edici√≥n
function renderPhraseEditMode() {
    const summary = summarySystemState.viewingSummary;
    if (!summary) return '<div>Error: No hay resumen para editar</div>';
    
    const activePhrases = phraseEditor.phrases.filter(p => !p.isDeleted);
    const deletedPhrases = phraseEditor.phrases.filter(p => p.isDeleted);
    const boldPhrases = phraseEditor.phrases.filter(p => p.isBold && !p.isDeleted);
    
    return `
        <div style="max-width: 1000px; margin: 0 auto;">
            <!-- Header del editor -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px 30px; border-radius: 12px; margin-bottom: 30px; color: white;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 style="margin: 0; font-size: 1.8rem;">‚úèÔ∏è EDITANDO FRASES</h1>
                        <p style="margin: 5px 0 0 0; opacity: 0.9;">${summary.title}</p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="savePhraseEdits()" class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 16px; border-radius: 6px;">
                            üíæ Guardar Cambios
                        </button>
                        <button onclick="cancelPhraseEditor()" class="btn" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 16px; border-radius: 6px;">
                            üö´ Cancelar
                        </button>
                    </div>
                </div>
                
                <!-- Estad√≠sticas -->
                <div style="margin-top: 15px; display: flex; gap: 20px; font-size: 14px; opacity: 0.9;">
                    <span>üìÑ ${activePhrases.length} frases activas</span>
                    <span>üóëÔ∏è ${deletedPhrases.length} eliminadas</span>
                    <span>üî§ ${boldPhrases.length} en negrita</span>
                </div>
            </div>
            
            <!-- Ayuda contextual -->
            <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 15px; margin-bottom: 25px;">
                <div style="display: flex; align-items: center; gap: 10px; color: #0c4a6e;">
                    <span style="font-size: 18px;">üí°</span>
                    <div style="font-size: 14px;">
                        <strong>Instrucciones:</strong>
                        ‚úèÔ∏è = Editar texto ‚Ä¢ 
                        <strong>B</strong> = Negrita ‚Ä¢ 
                        üóëÔ∏è = Eliminar ‚Ä¢ 
                        Los cambios se guardan autom√°ticamente
                    </div>
                </div>
            </div>
            
            <!-- Lista de frases editables -->
            <div>
                ${phraseEditor.phrases.map((phrase, index) => renderEditablePhrase(phrase, index)).join('')}
            </div>
            
            <!-- Frases eliminadas (si hay alguna) -->
            ${deletedPhrases.length > 0 ? `
                <div style="margin-top: 30px; padding: 20px; background: #fef2f2; border: 1px solid #fca5a5; border-radius: 8px;">
                    <h3 style="color: #dc2626; margin: 0 0 15px 0;">üóëÔ∏è Frases Eliminadas (${deletedPhrases.length})</h3>
                    ${deletedPhrases.map((phrase, index) => `
                        <div style="padding: 10px; background: white; border-radius: 6px; margin-bottom: 10px; opacity: 0.7;">
                            <div style="text-decoration: line-through; color: #6b7280; margin-bottom: 8px;">${phrase.text}</div>
                            <button onclick="restorePhrase(${phrase.id})" class="btn btn-success" style="padding: 4px 8px; font-size: 12px; border-radius: 4px;">
                                ‚Ü©Ô∏è Restaurar
                            </button>
                        </div>
                    `).join('')}
                </div>
            ` : ''}
        </div>
    `;
}

// üéØ Funci√≥n para renderizar cada frase editable
function renderEditablePhrase(phrase, index) {
    if (phrase.isDeleted) return '';
    
    const isEditing = phrase.isEditing;
    const textStyle = phrase.isBold ? 'font-weight: bold;' : '';
    const boldButtonStyle = phrase.isBold ? 
        'background: #16a34a; color: white;' : 
        'background: #f3f4f6; color: #374151;';
    
    return `
        <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 15px; position: relative;">
            
            <!-- N√∫mero de frase -->
            <div style="position: absolute; top: -12px; left: 15px; background: #667eea; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                Frase ${index + 1}
            </div>
            
            ${isEditing ? `
                <!-- Modo de edici√≥n -->
                <div style="margin-top: 10px;">
                    <textarea id="phrase-edit-${phrase.id}" style="width: 100%; min-height: 100px; padding: 12px; border: 2px solid #3b82f6; border-radius: 8px; font-size: 16px; line-height: 1.6; resize: vertical; font-family: inherit;" placeholder="Escribe el texto de la frase...">${phrase.text}</textarea>
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        <button onclick="savePhrase(${phrase.id})" class="btn btn-success" style="padding: 8px 16px; border-radius: 6px;">
                            ‚úÖ Guardar
                        </button>
                        <button onclick="cancelPhrase(${phrase.id})" class="btn btn-secondary" style="padding: 8px 16px; border-radius: 6px;">
                            ‚ùå Cancelar
                        </button>
                    </div>
                </div>
            ` : `
                <!-- Modo de vista -->
                <div style="margin-top: 10px; margin-bottom: 15px;">
                    <p style="margin: 0; line-height: 1.6; font-size: 16px; color: #374151; ${textStyle}">
                        ${phrase.text}
                    </p>
                </div>
                
                <!-- Botones de acci√≥n -->
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="editPhrase(${phrase.id})" class="btn" style="padding: 6px 12px; background: #3b82f6; color: white; font-size: 12px; border: none; border-radius: 4px; cursor: pointer;">
                        ‚úèÔ∏è Editar
                    </button>
                    <button onclick="toggleBold(${phrase.id})" class="btn" style="padding: 6px 12px; font-size: 12px; font-weight: bold; border: none; border-radius: 4px; cursor: pointer; ${boldButtonStyle}">
                        B
                    </button>
                    <button onclick="deletePhrase(${phrase.id})" class="btn btn-danger" style="padding: 6px 12px; font-size: 12px; border: none; border-radius: 4px; cursor: pointer;">
                        üóëÔ∏è
                    </button>
                </div>
            `}
        </div>
    `;
}

// üéØ Funciones de control del editor

window.editPhrase = function(phraseId) {
    const phrase = phraseEditor.phrases.find(p => p.id === phraseId);
    if (phrase) {
        phrase.isEditing = true;
        render();
        
        // Focus en el textarea despu√©s del render
        setTimeout(() => {
            const textarea = document.getElementById(`phrase-edit-${phraseId}`);
            if (textarea) {
                textarea.focus();
                textarea.setSelectionRange(textarea.value.length, textarea.value.length);
            }
        }, 100);
    }
};

window.savePhrase = function(phraseId) {
    const phrase = phraseEditor.phrases.find(p => p.id === phraseId);
    const textarea = document.getElementById(`phrase-edit-${phraseId}`);
    
    if (phrase && textarea) {
        const newText = textarea.value.trim();
        if (newText.length === 0) {
            alert('El texto no puede estar vac√≠o');
            return;
        }
        
        phrase.text = newText;
        phrase.isEditing = false;
        render();
        
        console.log('‚úÖ Frase guardada:', phraseId);
    }
};

window.cancelPhrase = function(phraseId) {
    const phrase = phraseEditor.phrases.find(p => p.id === phraseId);
    if (phrase) {
        phrase.isEditing = false;
        render();
    }
};

window.toggleBold = function(phraseId) {
    const phrase = phraseEditor.phrases.find(p => p.id === phraseId);
    if (phrase) {
        phrase.isBold = !phrase.isBold;
        render();
        console.log(phrase.isBold ? 'üî§ Negrita aplicada' : 'üî§ Negrita quitada');
    }
};

window.deletePhrase = function(phraseId) {
    const phrase = phraseEditor.phrases.find(p => p.id === phraseId);
    if (phrase) {
        if (confirm('¬øEliminar esta frase? (Se puede restaurar despu√©s)')) {
            phrase.isDeleted = true;
            render();
            console.log('üóëÔ∏è Frase eliminada:', phraseId);
        }
    }
};

window.restorePhrase = function(phraseId) {
    const phrase = phraseEditor.phrases.find(p => p.id === phraseId);
    if (phrase) {
        phrase.isDeleted = false;
        render();
        console.log('‚Ü©Ô∏è Frase restaurada:', phraseId);
    }
};

// üéØ Funciones para guardar y cancelar
window.savePhraseEdits = function() {
    const summary = summarySystemState.viewingSummary;
    if (!summary) return;
    
    // Construir nuevo contenido con las frases editadas
    const activePhrases = phraseEditor.phrases.filter(p => !p.isDeleted);
    const newContent = activePhrases
        .map(phrase => {
            let text = phrase.text;
            if (phrase.isBold) {
                text = `**${text}**`;
            }
            return text;
        })
        .join('\n\n');
    
    // Actualizar el resumen
    const summaryIndex = summarySystemState.savedSummaries.findIndex(s => s.id === summary.id);
    if (summaryIndex !== -1) {
        summarySystemState.savedSummaries[summaryIndex].content = newContent;
        summarySystemState.viewingSummary.content = newContent;
        
        // Guardar en localStorage
        localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
        
        // Salir del modo edici√≥n
        phraseEditor.isActive = false;
        render();
        
        alert('‚úÖ Cambios guardados correctamente');
        console.log('üíæ Resumen actualizado con', activePhrases.length, 'frases');
    }
};

window.cancelPhraseEditor = function() {
    if (confirm('¬øCancelar edici√≥n? Se perder√°n todos los cambios no guardados.')) {
        phraseEditor.isActive = false;
        phraseEditor.phrases = [];
        render();
        console.log('üö´ Edici√≥n cancelada');
    }
};

console.log('‚úÖ PARCHE DE EDITOR DE FRASES CARGADO - Inicializando...');
</script>
<script>
// ========== PARCHE: RENDERIZADO DE MARKDOWN ==========
// A√±adir este c√≥digo AL FINAL del archivo index.html, dentro de <script> tags
// DESPU√âS del parche anterior del editor de frases

// Funci√≥n para convertir markdown b√°sico a HTML
function convertMarkdownToHTML(content) {
    if (!content) return content;
    
    // Convertir **texto** a negrita con estilos en l√≠nea
    let processed = content.replace(/\*\*(.*?)\*\*/g, '<strong style="font-weight: bold; color: #1a202c;">$1</strong>');
    
    // Preservar saltos de l√≠nea
    processed = processed.replace(/\n/g, '<br>');
    
    return processed;
}

// Interceptar las funciones que renderizan contenido de res√∫menes
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        initializeMarkdownRenderer();
    }, 1500);
});

// Backup de inicializaci√≥n
setTimeout(function() {
    if (typeof summarySystemState !== 'undefined') {
        initializeMarkdownRenderer();
    }
}, 3000);

function initializeMarkdownRenderer() {
    console.log('üé® Inicializando renderizado de markdown...');
    
    // Detectar y interceptar la funci√≥n de renderizado correcta
    let renderFunction = null;
    let functionName = '';
    
    if (typeof renderViewSummaryEnhanced === 'function') {
        renderFunction = renderViewSummaryEnhanced;
        functionName = 'renderViewSummaryEnhanced';
    } else if (typeof renderViewSummary === 'function') {
        renderFunction = renderViewSummary;
        functionName = 'renderViewSummary';
    } else if (typeof renderViewSummaryWithEditor === 'function') {
        renderFunction = renderViewSummaryWithEditor;
        functionName = 'renderViewSummaryWithEditor';
    }
    
    if (!renderFunction) {
        console.error('‚ùå No se encontr√≥ funci√≥n de renderizado para interceptar');
        return;
    }
    
    console.log('‚úÖ Interceptando funci√≥n:', functionName);
    
    // Crear versi√≥n mejorada que procese markdown y modifique la interfaz
    const enhancedRenderer = createMarkdownEnhancedRenderer(renderFunction);
    
    // Reemplazar la funci√≥n correspondiente
    if (functionName === 'renderViewSummaryEnhanced') {
        window.renderViewSummaryEnhanced = enhancedRenderer;
    } else if (functionName === 'renderViewSummary') {
        window.renderViewSummary = enhancedRenderer;
    } else if (functionName === 'renderViewSummaryWithEditor') {
        window.renderViewSummaryWithEditor = enhancedRenderer;
    }
    
    console.log('‚úÖ Renderizado de markdown inicializado correctamente');
}

// Crear funci√≥n de renderizado mejorada que procese markdown y modifique interfaz
function createMarkdownEnhancedRenderer(originalFunction) {
    return function() {
        // Si estamos en modo edici√≥n de frases, no modificar nada
        if (window.phraseEditor && phraseEditor.isActive) {
            return originalFunction.call(this);
        }
        
        // Llamar a la funci√≥n original
        let html = originalFunction.call(this);
        
        // MODIFICAR LA CABECERA AZUL para a√±adir el bot√≥n "Editar" arriba
        // Buscar la cabecera con el fondo degradado azul/morado
        const headerPattern = /(<div[^>]*background:[^>]*linear-gradient[^>]*>[^<]*<h[12][^>]*>[^<]*<\/h[12]>)/i;
        
        if (headerPattern.test(html)) {
            html = html.replace(headerPattern, (match) => {
                // Solo a√±adir si no existe ya el bot√≥n
                if (!match.includes('startPhraseEditor')) {
                    const editButton = `
                        <button onclick="startPhraseEditor()" class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 600; transition: all 0.2s ease; margin-left: 20px; margin-top: 10px; display: inline-block;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                            ‚úèÔ∏è Editar
                        </button>
                    `;
                    return match + editButton;
                }
                return match;
            });
        } else {
            // Si no encuentra el patr√≥n espec√≠fico, buscar cualquier cabecera azul
            const simpleHeaderPattern = /(<h1[^>]*>[^<]*El rey[^<]*<\/h1>)/i;
            if (simpleHeaderPattern.test(html)) {
                html = html.replace(simpleHeaderPattern, (match) => {
                    if (!html.includes('startPhraseEditor')) {
                        const editButton = `
                            <div style="position: absolute; top: 20px; right: 20px;">
                                <button onclick="startPhraseEditor()" class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 600; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                    ‚úèÔ∏è Editar
                                </button>
                            </div>
                        `;
                        // Buscar el div contenedor de la cabecera y a√±adirle posici√≥n relativa
                        html = html.replace(/(<div[^>]*background:[^>]*linear-gradient[^>]*)(style="[^"]*)/i, '$1$2; position: relative');
                        return match + editButton;
                    }
                    return match;
                });
            }
        }
        
        // QUITAR cualquier bot√≥n "Editar Frases" del final (si existe)
        html = html.replace(/(<button[^>]*onclick="startPhraseEditor\(\)"[^>]*>[\s\S]*?<\/button>)/g, '');
        
        // Procesar el contenido para convertir markdown
        const summary = summarySystemState.viewingSummary;
        if (summary && summary.content) {
            // Convertir el markdown del contenido
            const markdownProcessed = convertMarkdownToHTML(summary.content);
            
            // Reemplazar el contenido original con el procesado
            // Buscar y reemplazar el contenido en diferentes patrones
            
            // Patr√≥n 1: white-space: pre-wrap
            const preWrapPattern = /(<div style="[^"]*white-space:\s*pre-wrap[^"]*">)\s*([^<]*(?:<br>[^<]*)*)\s*(<\/div>)/g;
            if (preWrapPattern.test(html)) {
                html = html.replace(preWrapPattern, (match, openTag, content, closeTag) => {
                    // Solo procesar si el contenido coincide con el resumen
                    if (content.trim().replace(/<br>/g, '\n') === summary.content.trim()) {
                        return openTag + markdownProcessed + closeTag;
                    }
                    return match;
                });
            }
            
            // Patr√≥n 2: Contenido directo del resumen
            const directContentPattern = new RegExp(escapeRegExp(summary.content.substring(0, 100)), 'g');
            if (directContentPattern.test(html)) {
                html = html.replace(new RegExp(escapeRegExp(summary.content), 'g'), markdownProcessed);
            }
            
            // Patr√≥n 3: formatSummaryContent o formatSummaryContentAdvanced
            const formatContentPattern = /formatSummaryContent(?:Advanced)?\(summary\.content\)/g;
            html = html.replace(formatContentPattern, `"${markdownProcessed}"`);
            
        }
        
        return html;
    };
}

// MODIFICAR la funci√≥n renderEditablePhrase para quitar el bot√≥n de negrita
const originalRenderEditablePhrase = window.renderEditablePhrase;
if (typeof renderEditablePhrase === 'function') {
    window.renderEditablePhrase = function(phrase, index) {
        if (phrase.isDeleted) return '';
        
        const isEditing = phrase.isEditing;
        const textStyle = phrase.text.includes('**') ? 'font-weight: 500; background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 3px 6px; border-radius: 4px;' : '';
        
        return `
            <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 15px; position: relative;">
                
                <!-- N√∫mero de frase -->
                <div style="position: absolute; top: -12px; left: 15px; background: #667eea; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                    Frase ${index + 1}
                </div>
                
                ${isEditing ? `
                    <!-- Modo de edici√≥n -->
                    <div style="margin-top: 10px;">
                        <div style="margin-bottom: 10px; font-size: 12px; color: #6b7280;">
                            üí° <strong>Tip:</strong> Usa **texto** para negrita. Ejemplo: **palabra importante**
                        </div>
                        <textarea id="phrase-edit-${phrase.id}" style="width: 100%; min-height: 100px; padding: 12px; border: 2px solid #3b82f6; border-radius: 8px; font-size: 16px; line-height: 1.6; resize: vertical; font-family: inherit;" placeholder="Escribe el texto de la frase... Usa **texto** para negrita">${phrase.text}</textarea>
                        <div style="margin-top: 10px; display: flex; gap: 10px;">
                            <button onclick="savePhrase(${phrase.id})" class="btn btn-success" style="padding: 8px 16px; border-radius: 6px;">
                                ‚úÖ Guardar
                            </button>
                            <button onclick="cancelPhrase(${phrase.id})" class="btn btn-secondary" style="padding: 8px 16px; border-radius: 6px;">
                                ‚ùå Cancelar
                            </button>
                        </div>
                    </div>
                ` : `
                    <!-- Modo de vista -->
                    <div style="margin-top: 10px; margin-bottom: 15px;">
                        <p style="margin: 0; line-height: 1.6; font-size: 16px; color: #374151; ${textStyle}">
                            ${phrase.text}
                        </p>
                        ${phrase.text.includes('**') ? `
                            <div style="margin-top: 8px; font-size: 12px; color: #059669; background: #d1fae5; padding: 4px 8px; border-radius: 4px; display: inline-block;">
                                üìù Contiene formato markdown
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Botones de acci√≥n SIN BOT√ìN DE NEGRITA -->
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="editPhrase(${phrase.id})" class="btn" style="padding: 6px 12px; background: #3b82f6; color: white; font-size: 12px; border: none; border-radius: 4px; cursor: pointer;">
                            ‚úèÔ∏è Editar
                        </button>
                        <button onclick="deletePhrase(${phrase.id})" class="btn btn-danger" style="padding: 6px 12px; font-size: 12px; border: none; border-radius: 4px; cursor: pointer;">
                            üóëÔ∏è
                        </button>
                    </div>
                `}
            </div>
        `;
    };
}

// MODIFICAR renderPhraseEditMode para actualizar estad√≠sticas
const originalRenderPhraseEditMode = window.renderPhraseEditMode;
if (typeof renderPhraseEditMode === 'function') {
    window.renderPhraseEditMode = function() {
        const summary = summarySystemState.viewingSummary;
        if (!summary) return '<div>Error: No hay resumen para editar</div>';
        
        const activePhrases = phraseEditor.phrases.filter(p => !p.isDeleted);
        const deletedPhrases = phraseEditor.phrases.filter(p => p.isDeleted);
        const markdownPhrases = phraseEditor.phrases.filter(p => p.text.includes('**') && !p.isDeleted);
        
        return `
            <div style="max-width: 1000px; margin: 0 auto;">
                <!-- Header del editor -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px 30px; border-radius: 12px; margin-bottom: 30px; color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h1 style="margin: 0; font-size: 1.8rem;">‚úèÔ∏è EDITANDO FRASES</h1>
                            <p style="margin: 5px 0 0 0; opacity: 0.9;">${summary.title}</p>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="savePhraseEdits()" class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 16px; border-radius: 6px;">
                                üíæ Guardar Cambios
                            </button>
                            <button onclick="cancelPhraseEditor()" class="btn" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 16px; border-radius: 6px;">
                                üö´ Cancelar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Estad√≠sticas actualizadas -->
                    <div style="margin-top: 15px; display: flex; gap: 20px; font-size: 14px; opacity: 0.9;">
                        <span>üìÑ ${activePhrases.length} frases activas</span>
                        <span>üóëÔ∏è ${deletedPhrases.length} eliminadas</span>
                        <span>üìù ${markdownPhrases.length} con negrita markdown</span>
                    </div>
                </div>
                
                <!-- Ayuda contextual actualizada -->
                <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 15px; margin-bottom: 25px;">
                    <div style="display: flex; align-items: center; gap: 10px; color: #0c4a6e;">
                        <span style="font-size: 18px;">üí°</span>
                        <div style="font-size: 14px;">
                            <strong>Instrucciones:</strong>
                            ‚úèÔ∏è = Editar texto ‚Ä¢ 
                            üóëÔ∏è = Eliminar ‚Ä¢ 
                            Para negrita usa: **texto** ‚Ä¢ 
                            Los cambios se guardan al final
                        </div>
                    </div>
                </div>
                
                <!-- Lista de frases editables -->
                <div>
                    ${phraseEditor.phrases.map((phrase, index) => renderEditablePhrase(phrase, index)).join('')}
                </div>
                
                <!-- Frases eliminadas -->
                ${deletedPhrases.length > 0 ? `
                    <div style="margin-top: 40px;">
                        <h3 style="color: #dc2626; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #fee2e2;">
                            üóëÔ∏è Frases Eliminadas (${deletedPhrases.length})
                        </h3>
                        <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 20px;">
                            ${deletedPhrases.map(phrase => `
                                <div style="margin-bottom: 15px; padding: 15px; background: white; border-radius: 6px; border-left: 4px solid #dc2626;">
                                    <p style="margin: 0 0 10px 0; opacity: 0.7; text-decoration: line-through;">${phrase.text}</p>
                                    <button onclick="restorePhrase(${phrase.id})" class="btn btn-success" style="padding: 6px 12px; font-size: 12px;">
                                        ‚Ü©Ô∏è Restaurar
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            </div>
        `;
    };
}

// Funci√≥n auxiliar para escapar caracteres especiales en regex
function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// Funci√≥n mejorada para formatear contenido (reemplazo directo)
function formatSummaryContentWithMarkdown(content) {
    if (!content) return '';
    
    // Convertir markdown a HTML
    const processed = convertMarkdownToHTML(content);
    
    // Dividir en p√°rrafos y formatear
    const paragraphs = processed.split('<br><br>').filter(p => p.trim());
    
    return paragraphs.map(paragraph => {
        const trimmed = paragraph.trim();
        if (!trimmed) return '';
        
        // Detectar t√≠tulos (l√≠neas que terminan con ":" o son cortas)
        if (trimmed.endsWith(':') && trimmed.length < 150) {
            return `<h3 style="color: #1f2937; font-size: 1.2rem; font-weight: 700; margin: 25px 0 15px 0; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0;">${trimmed}</h3>`;
        }
        
        // Detectar listas
        if (trimmed.match(/^[‚Ä¢\-\*]\s+/) || trimmed.match(/^\d+\.\s+/)) {
            return `<div style="margin: 8px 0; padding-left: 20px; border-left: 3px solid #e2e8f0; color: #4b5563;">${trimmed}</div>`;
        }
        
        // P√°rrafos normales
        return `<p style="margin: 15px 0; text-align: justify; line-height: 1.7;">${trimmed}</p>`;
        
    }).join('');
}

// Interceptar funciones de formato si existen
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        // Reemplazar formatSummaryContent si existe
        if (typeof window.formatSummaryContent === 'function') {
            const originalFormatSummaryContent = window.formatSummaryContent;
            window.formatSummaryContent = function(content) {
                const processed = convertMarkdownToHTML(content);
                return originalFormatSummaryContent(processed);
            };
        } else {
            // Crear la funci√≥n si no existe
            window.formatSummaryContent = formatSummaryContentWithMarkdown;
        }
        
        // Reemplazar formatSummaryContentAdvanced si existe
        if (typeof window.formatSummaryContentAdvanced === 'function') {
            const originalFormatSummaryContentAdvanced = window.formatSummaryContentAdvanced;
            window.formatSummaryContentAdvanced = function(content) {
                const processed = convertMarkdownToHTML(content);
                return originalFormatSummaryContentAdvanced(processed);
            };
        } else {
            // Crear la funci√≥n si no existe
            window.formatSummaryContentAdvanced = formatSummaryContentWithMarkdown;
        }
        
        console.log('‚úÖ Funciones de formato interceptadas para markdown');
    }, 2000);
});

// Funci√≥n para forzar re-renderizado despu√©s de guardar cambios en el editor
const originalSavePhraseEdits = window.savePhraseEdits;
if (originalSavePhraseEdits) {
    window.savePhraseEdits = function() {
        // Llamar a la funci√≥n original
        originalSavePhraseEdits.call(this);
        
        // Forzar re-renderizado despu√©s de un peque√±o delay
        setTimeout(() => {
            console.log('üîÑ Forzando re-renderizado para mostrar markdown');
            render();
        }, 100);
    };
}

// Funci√≥n de prueba para verificar que el markdown funciona
window.testMarkdownRendering = function() {
    const testContent = "Este es un texto **en negrita** y este es normal.\n\nOtro p√°rrafo con **m√°s texto en negrita**.";
    console.log('üìù Texto original:', testContent);
    console.log('üé® Texto procesado:', convertMarkdownToHTML(testContent));
};

console.log('‚úÖ PARCHE DE RENDERIZADO DE MARKDOWN MODIFICADO');
console.log('üéØ Cambios aplicados:');
console.log('  - ‚ùå Bot√≥n de negrita (B) eliminado');
console.log('  - ‚úÖ Solo funciona negrita con **texto**');
console.log('  - ‚¨ÜÔ∏è Bot√≥n "Editar" movido a cabecera azul');
console.log('  - üìù Ayuda mejorada sobre markdown');
console.log('üß™ Prueba con: testMarkdownRendering()');
</script>
<script>
// ========== PARCHE: BOT√ìN EDITAR TEXTO COMPLETO EN ENCABEZADO ==========
console.log('üîß Corrigiendo bot√≥n para llamar al editor de frases completo...');

// Funci√≥n mejorada para editar desde el encabezado
function editSummaryFromEncabezado() {
    const summary = summarySystemState.viewingSummary;
    if (!summary) return;
    
    // Verificar si existe startPhraseEditor (editor completo)
    if (typeof startPhraseEditor === 'function') {
        // Usar el editor de frases avanzado
        startPhraseEditor();
    } else {
        // Fallback: mostrar opciones de edici√≥n
        const opciones = `
        ¬øQu√© deseas editar?
        
        1. T√≠tulo √∫nicamente
        2. Contenido completo
        3. Ambos (t√≠tulo y contenido)
        
        Escribe 1, 2 o 3:`;
        
        const opcion = prompt(opciones);
        
        if (opcion === '1') {
            // Solo editar t√≠tulo
            const newTitle = prompt('Nuevo t√≠tulo:', summary.title);
            if (newTitle && newTitle.trim()) {
                const index = summarySystemState.savedSummaries.findIndex(s => s.id === summary.id);
                if (index !== -1) {
                    summarySystemState.savedSummaries[index].title = newTitle.trim();
                    summarySystemState.viewingSummary.title = newTitle.trim();
                    localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
                    render();
                    showMessage('T√≠tulo actualizado', 'success');
                }
            }
        } else if (opcion === '2') {
            // Solo editar contenido
            const newContent = prompt('Nuevo contenido:', summary.content);
            if (newContent && newContent.trim()) {
                const index = summarySystemState.savedSummaries.findIndex(s => s.id === summary.id);
                if (index !== -1) {
                    summarySystemState.savedSummaries[index].content = newContent.trim();
                    summarySystemState.viewingSummary.content = newContent.trim();
                    localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
                    render();
                    showMessage('Contenido actualizado', 'success');
                }
            }
        } else if (opcion === '3') {
            // Editar ambos
            const newTitle = prompt('Nuevo t√≠tulo:', summary.title);
            if (newTitle && newTitle.trim()) {
                const newContent = prompt('Nuevo contenido:', summary.content);
                if (newContent && newContent.trim()) {
                    const index = summarySystemState.savedSummaries.findIndex(s => s.id === summary.id);
                    if (index !== -1) {
                        summarySystemState.savedSummaries[index].title = newTitle.trim();
                        summarySystemState.savedSummaries[index].content = newContent.trim();
                        summarySystemState.viewingSummary.title = newTitle.trim();
                        summarySystemState.viewingSummary.content = newContent.trim();
                        localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
                        render();
                        showMessage('T√≠tulo y contenido actualizados', 'success');
                    }
                }
            }
        }
    }
}

// Reemplazar TODAS las versiones de renderViewSummary
function renderViewSummaryFixed() {
    const summary = summarySystemState.viewingSummary;
    if (!summary) {
        summarySystemState.currentView = 'library';
        return renderSummaryLibrary();
    }
    
    const topicName = summary.topicId ? getSummaryTopicName(summary.topicId) : 'Sin tema';
    
    return `
        <div style="max-width: 1000px; margin: 0 auto;">
            <!-- Bot√≥n volver -->
            <button onclick="closeSummaryView()" class="btn btn-secondary" style="margin-bottom: 20px;">
                ‚Üê Volver a la Biblioteca
            </button>
            
            <!-- ENCABEZADO CON BOT√ìN EDITAR INTEGRADO -->
            <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 25px 30px; border-radius: 12px 12px 0 0; margin-bottom: 0; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div style="flex: 1; min-width: 300px;">
                        <h1 style="color: white; margin: 0 0 10px 0; font-size: 2rem; font-weight: 700;">
                            ${summary.title}
                        </h1>
                        <div style="display: flex; align-items: center; gap: 20px; color: rgba(255,255,255,0.9); font-size: 14px; flex-wrap: wrap;">
                            <span style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px;">üìÇ ${topicName}</span>
                            <span style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px;">üìÖ ${summary.createdAt}</span>
                            <span style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px;">üìù ${summary.content.length} caracteres</span>
                        </div>
                    </div>
                    <!-- BOT√ìN EDITAR TEXTO COMPLETO EN EL ENCABEZADO -->
                    <button onclick="editSummaryFromEncabezado()" class="btn" style="background: rgba(255,255,255,0.9); color: #667eea; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s; min-width: 140px;">
                        ‚úèÔ∏è Editar Texto
                    </button>
                </div>
            </div>
            
            <!-- CONTENIDO DEL RESUMEN -->
            <div style="background: white; border: 2px solid #e2e8f0; border-top: none; border-radius: 0 0 12px 12px; padding: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
                <div style="prose max-w-none;">
                    <div style="white-space: pre-wrap; line-height: 1.7; color: #374151; font-size: 16px;">
                        ${summary.content}
                    </div>
                </div>
            </div>
            
            <!-- BOTONES INFERIORES (SIN EDITAR) -->
            <div style="margin-top: 30px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                <button onclick="copySummaryContentToClipboard('${summary.id}')" class="btn btn-info" style="padding: 12px 24px;">
                    üìã Copiar Contenido
                </button>
                <button onclick="deleteSummaryFromView('${summary.id}')" class="btn btn-danger" style="padding: 12px 24px;">
                    üóëÔ∏è Eliminar Resumen
                </button>
            </div>
        </div>
    `;
}

// Reemplazar TODAS las versiones posibles
window.renderViewSummary = renderViewSummaryFixed;
window.renderViewSummaryEnhanced = renderViewSummaryFixed;
window.renderViewSummaryWithEditor = renderViewSummaryFixed;

console.log('‚úÖ Bot√≥n "Editar Texto" configurado para opciones completas');
console.log('üéØ Ahora lleva al editor de frases o modal con opciones');
</script>
<!-- 
PARCHE ULTRA SIMPLE - DETECCI√ìN DIRECTA DE )** 
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
BORRA todos los parches anteriores y usa SOLO este c√≥digo
-->

<script>
// ========== PARCHE ULTRA SIMPLE ==========
console.log('üî• Aplicando PARCHE ULTRA SIMPLE...');

// Estados simples
window.isInBulkMode = false;
window.isInManualMode = false;
window.bulkText = '';
window.detectedQuestions = [];

// Interceptar renderUploadTab
const originalUploadRender = renderUploadTab;
window.renderUploadTab = function() {
    if (window.isInBulkMode) return showBulkEditor();
    if (window.isInManualMode) return showManualEditor();
    
    let content = originalUploadRender.call(this);
    const buttonHtml = `
                    <div style="border-top: 2px solid #f59e0b; margin-top: 15px; padding-top: 15px;">
                        <div style="text-align: center; margin-bottom: 10px; color: #92400e; font-weight: bold;">
                            üìù CREAR SIN IA
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button onclick="goManual()" style="background: #8b5cf6; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer;">‚úèÔ∏è Una</button>
                            <button onclick="goBulk()" style="background: #059669; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer;">üìã M√∫ltiples</button>
                        </div>
                    </div>`;
    
    const insertAt = content.lastIndexOf('</div>\n        </div>\n        \n        <!-- BOT√ìN CENTRAL');
    if (insertAt > -1) {
        content = content.substring(0, insertAt) + buttonHtml + '\n                </div>\n            </div>\n        </div>' + content.substring(insertAt);
    }
    return content;
};

// Funci√≥n para ir a m√∫ltiples
window.goBulk = function() {
    window.isInBulkMode = true;
    window.bulkText = '';
    window.detectedQuestions = [];
    render();
};

// Funci√≥n para ir a manual
window.goManual = function() {
    alert('Editor individual: Funcionalidad b√°sica implementada.\nUsa el editor m√∫ltiple para el patr√≥n )** espec√≠fico.');
};

// Editor m√∫ltiple simple
function showBulkEditor() {
    return `
        <div style="max-width: 1000px; margin: 0 auto; padding: 20px;">
            <div style="background: #059669; color: white; padding: 20px; border-radius: 12px 12px 0 0; text-align: center;">
                <h2 style="margin: 0;">üìã Editor M√∫ltiple - Detecci√≥n )** </h2>
                <p style="margin: 10px 0 0 0; opacity: 0.9;">Detecta autom√°ticamente B)**, C)**, etc. como correctas</p>
            </div>
            
            <div style="background: white; border: 2px solid #059669; border-top: none; border-radius: 0 0 12px 12px; padding: 30px;">
                
                <div style="margin-bottom: 20px;">
                    <label style="font-weight: bold;">üè∑Ô∏è Tema:</label>
                    <select id="bulk-tema" style="width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 6px;">
                        <option value="">Sin tema</option>
                        ${state.topics.map(t => `<option value="${t.id}">${t.name}</option>`).join('')}
                    </select>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="font-weight: bold;">üìù Texto:</label>
                    <textarea id="bulk-texto" placeholder="61. Tu pregunta:
A) Opci√≥n normal
B)**Opci√≥n correcta (detectar√° esta)
C) Opci√≥n normal
D) Opci√≥n normal" style="width: 100%; height: 200px; padding: 15px; margin-top: 5px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace;" oninput="procesarTexto()">${window.bulkText}</textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>Preguntas detectadas: ${window.detectedQuestions.length}</h4>
                    <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; padding: 15px; max-height: 300px; overflow-y: auto;">
                        ${mostrarPreview()}
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <button onclick="cancelarBulk()" style="padding: 12px 24px; margin-right: 10px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">Cancelar</button>
                    <button onclick="guardarBulk()" style="padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;" ${window.detectedQuestions.length === 0 ? 'disabled' : ''}>Guardar ${window.detectedQuestions.length} Preguntas</button>
                </div>
            </div>
        </div>
    `;
}

// Procesar texto con detecci√≥n ultra espec√≠fica
window.procesarTexto = function() {
    const textarea = document.getElementById('bulk-texto');
    if (!textarea) return;
    
    window.bulkText = textarea.value;
    window.detectedQuestions = parseTextoSimple(textarea.value);
    
    // Actualizar preview
    const preview = document.querySelector('div[style*="max-height: 300px"]');
    if (preview) {
        preview.innerHTML = mostrarPreview();
    }
    
    // Actualizar bot√≥n
    const btn = document.querySelector('button[onclick="guardarBulk()"]');
    if (btn) {
        btn.textContent = `Guardar ${window.detectedQuestions.length} Preguntas`;
        btn.disabled = window.detectedQuestions.length === 0;
    }
};

// Parser ultra espec√≠fico para el patr√≥n )**
function parseTextoSimple(texto) {
    if (!texto.trim()) return [];
    
    const preguntas = [];
    const lineas = texto.split('\n');
    
    let preguntaActual = null;
    let opciones = [];
    let respuestaCorrecta = null;
    
    for (let i = 0; i < lineas.length; i++) {
        const linea = lineas[i].trim();
        if (!linea) continue;
        
        // Detectar nueva pregunta (n√∫mero.)
        if (/^\d+\s+\.\s+.*[:\?]\s*$/.test(linea)) {
            // Guardar pregunta anterior
            if (preguntaActual && opciones.length >= 2) {
                preguntas.push({
                    id: Date.now() + Math.random(),
                    question: preguntaActual,
                    options: opciones.slice(),
                    correctAnswer: respuestaCorrecta !== null ? respuestaCorrecta : 0,
                    topicId: null,
                    isVerified: true,
                    source: 'bulk_simple'
                });
            }
            
            // Nueva pregunta
            preguntaActual = linea.replace(/^\d+\s+\.\s*/, '');
            opciones = [];
            respuestaCorrecta = null;
        }
        // Detectar opciones
        else if (/^[A-D]\)/.test(linea)) {
            // DETECCI√ìN ULTRA ESPEC√çFICA: buscar )** en la l√≠nea
            const esCorrecta = /^[A-D]\)\*\*/.test(linea);
            
            if (esCorrecta) {
                respuestaCorrecta = opciones.length;
                console.log(`üéØ Detectada correcta: ${linea}`);
            }
            
            // Limpiar texto (quitar letra) y asteriscos)
            let textoOpcion = linea.replace(/^[A-D]\)/, '').trim();
            textoOpcion = textoOpcion.replace(/^\*+/, '').trim(); // Quitar asteriscos del inicio
            
            opciones.push(textoOpcion);
        }
    }
    
    // Guardar √∫ltima pregunta
    if (preguntaActual && opciones.length >= 2) {
        preguntas.push({
            id: Date.now() + Math.random(),
            question: preguntaActual,
            options: opciones.slice(),
            correctAnswer: respuestaCorrecta !== null ? respuestaCorrecta : 0,
            topicId: null,
            isVerified: true,
            source: 'bulk_simple'
        });
    }
    
    console.log(`üìä Detectadas ${preguntas.length} preguntas`);
    return preguntas;
}

// Mostrar preview
function mostrarPreview() {
    if (window.detectedQuestions.length === 0) {
        return '<em style="color: #999;">Pega preguntas para ver preview</em>';
    }
    
    return window.detectedQuestions.map((q, i) => `
        <div style="margin-bottom: 20px; padding-bottom: 15px; ${i < window.detectedQuestions.length - 1 ? 'border-bottom: 1px solid #ddd;' : ''}">
            <strong>P${i + 1}: ${q.question}</strong><br><br>
            ${q.options.map((opt, oi) => {
                const esCorrecto = q.correctAnswer === oi;
                return `${String.fromCharCode(65 + oi)}) <span style="color: ${esCorrecto ? '#28a745' : 'black'}; font-weight: ${esCorrecto ? 'bold' : 'normal'};">${opt} ${esCorrecto ? '‚úÖ' : ''}</span><br>`;
            }).join('')}
        </div>
    `).join('');
}

// Cancelar
window.cancelarBulk = function() {
    if (window.bulkText.trim() && !confirm('¬øCancelar? Se perder√°n los cambios.')) return;
    window.isInBulkMode = false;
    render();
};

// Guardar
window.guardarBulk = function() {
    if (window.detectedQuestions.length === 0) {
        alert('No hay preguntas para guardar');
        return;
    }
    
    // Obtener tema seleccionado
    const selectorTema = document.getElementById('bulk-tema');
    const temaId = selectorTema ? (selectorTema.value || null) : null;
    
    // Asignar tema a todas las preguntas
    window.detectedQuestions.forEach(q => {
        q.topicId = temaId;
    });
    
    // A√±adir al banco
    state.questions.push(...window.detectedQuestions);
    localStorage.setItem('questions', JSON.stringify(state.questions));
    
    // Volver
    window.isInBulkMode = false;
    render();
    
    if (typeof showMessage === 'function') {
        const nombreTema = temaId ? (state.topics.find(t => t.id == temaId)?.name || 'Sin tema') : 'Sin tema';
        showMessage(`‚úÖ ${window.detectedQuestions.length} preguntas guardadas en "${nombreTema}"`, 'success');
    }
};

// Editor manual simple (placeholder)
function showManualEditor() {
    return '<div style="padding: 50px; text-align: center;"><h2>Editor Individual</h2><p>Funcionalidad b√°sica - usa el editor m√∫ltiple para )** </p><button onclick="window.isInManualMode = false; render();">Volver</button></div>';
}

console.log('üî• PARCHE ULTRA SIMPLE aplicado');
console.log('üéØ Detecci√≥n espec√≠fica: A)**, B)****, C)**, etc.');
console.log('üß™ Prueba pegando texto con el patr√≥n )**');
</script>
<!-- 
PARCHE: DETECTOR DE PREGUNTAS REPETIDAS + B√öSQUEDA MEJORADA
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
-->

<style>
/* Estilos para la b√∫squeda */
#search-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
}

#search-input:hover {
    border-color: #9ca3af;
}

/* Resaltar t√©rminos encontrados */
.search-highlight {
    background-color: #fef08a;
    padding: 1px 2px;
    border-radius: 2px;
    font-weight: 600;
}

/* Mejorar disposici√≥n de filtros */
.filter-container {
    display: flex;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 20px;
}

@media (max-width: 768px) {
    .filter-container {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
    }
    
    #search-input {
        width: 100% !important;
    }
}
</style>

<script>
// ========== DETECTOR DE PREGUNTAS REPETIDAS ==========
console.log('üîç Aplicando detector de preguntas repetidas...');

// Estado del detector
window.duplicateDetectorState = {
    isShowing: false,
    duplicateGroups: [],
    detectionMode: 'similar' // 'exact' o 'similar'
};

// Funci√≥n principal para detectar duplicados
window.detectDuplicates = function() {
    console.log('üîç Iniciando detecci√≥n de duplicados...');
    
    if (state.questions.length === 0) {
        alert('No hay preguntas en el banco para analizar');
        return;
    }
    
    // Detectar grupos de preguntas duplicadas
    const duplicateGroups = findDuplicateGroups();
    
    if (duplicateGroups.length === 0) {
        showMessage('‚úÖ No se encontraron preguntas repetidas', 'success');
        return;
    }
    
    // Mostrar interfaz de gesti√≥n de duplicados
    window.duplicateDetectorState.duplicateGroups = duplicateGroups;
    window.duplicateDetectorState.isShowing = true;
    render();
    
    // Scroll al top para ver la interfaz
    window.scrollTo(0, 0);
};

// Funci√≥n para encontrar grupos de preguntas duplicadas
function findDuplicateGroups() {
    const groups = [];
    const processed = new Set();
    
    for (let i = 0; i < state.questions.length; i++) {
        if (processed.has(i)) continue;
        
        const currentQuestion = state.questions[i];
        const duplicates = [i];
        
        // Buscar preguntas similares
        for (let j = i + 1; j < state.questions.length; j++) {
            if (processed.has(j)) continue;
            
            const compareQuestion = state.questions[j];
            
            if (areQuestionsSimilar(currentQuestion, compareQuestion)) {
                duplicates.push(j);
                processed.add(j);
            }
        }
        
        // Si hay duplicados, a√±adir al grupo
        if (duplicates.length > 1) {
            groups.push({
                id: Date.now() + Math.random(),
                questions: duplicates.map(index => ({
                    index: index,
                    question: state.questions[index]
                })),
                selectedToKeep: duplicates[0] // Por defecto mantener la primera
            });
        }
        
        processed.add(i);
    }
    
    return groups;
}

// Funci√≥n para comparar si dos preguntas son similares
function areQuestionsSimilar(q1, q2) {
    // Limpiar y normalizar texto para comparaci√≥n
    const normalize = (text) => {
        return text.toLowerCase()
            .replace(/[^\w\s]/g, ' ') // Quitar puntuaci√≥n
            .replace(/\s+/g, ' ')     // Normalizar espacios
            .trim();
    };
    
    const text1 = normalize(q1.question);
    const text2 = normalize(q2.question);
    
    // Comparaci√≥n exacta
    if (text1 === text2) return true;
    
    // Si est√° en modo exacto, solo devolver true para coincidencias exactas
    if (window.duplicateDetectorState.detectionMode === 'exact') {
        return false;
    }
    
    // Comparaci√≥n por similitud (al menos 85% similar) solo en modo 'similar'
    const similarity = calculateSimilarity(text1, text2);
    return similarity > 0.85;
}

// Funci√≥n para calcular similitud entre dos textos
function calculateSimilarity(str1, str2) {
    const longer = str1.length > str2.length ? str1 : str2;
    const shorter = str1.length > str2.length ? str2 : str1;
    
    if (longer.length === 0) return 1.0;
    
    const editDistance = levenshteinDistance(longer, shorter);
    return (longer.length - editDistance) / longer.length;
}

// Algoritmo de distancia de Levenshtein
function levenshteinDistance(str1, str2) {
    const matrix = [];
    
    for (let i = 0; i <= str2.length; i++) {
        matrix[i] = [i];
    }
    
    for (let j = 0; j <= str1.length; j++) {
        matrix[0][j] = j;
    }
    
    for (let i = 1; i <= str2.length; i++) {
        for (let j = 1; j <= str1.length; j++) {
            if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                matrix[i][j] = matrix[i - 1][j - 1];
            } else {
                matrix[i][j] = Math.min(
                    matrix[i - 1][j - 1] + 1,
                    matrix[i][j - 1] + 1,
                    matrix[i - 1][j] + 1
                );
            }
        }
    }
    
    return matrix[str2.length][str1.length];
}

// Interceptar renderQuestionsTab para mostrar interfaz de duplicados
const originalRenderQuestionsTab = renderQuestionsTab;
renderQuestionsTab = function() {
    // Si se est√° mostrando el detector, mostrar esa interfaz
    if (window.duplicateDetectorState.isShowing) {
        return renderDuplicateDetectorInterface();
    }
    
    // A√ëADIDO: Si no est√° el detector, mostrar con b√∫squeda
    const filteredQuestions = getFilteredQuestions();
    
    function getQuestionsTitle() {
        let title = '';
        
        // Determinar t√≠tulo base
        if (state.selectedTopicFilter === 'all') {
            title = 'TODAS LAS PREGUNTAS DEL BANCO';
        } else {
            const topic = state.topics.find(t => t.id == state.selectedTopicFilter);
            if (topic) {
                title = `PREGUNTAS ${topic.name.toUpperCase()}`;
            } else {
                title = 'PREGUNTAS DEL TEMA SELECCIONADO';
            }
        }
        
        // A√±adir informaci√≥n de b√∫squeda si est√° activa
        if (state.searchQuery && state.searchQuery.length > 0) {
            title += ` - B√öSQUEDA: "${state.searchQuery.toUpperCase()}"`;
        }
        
        return `${title} (${filteredQuestions.length})`;
    }
    
    return `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
            <h2>${getQuestionsTitle()}</h2>
            <div style="display: flex; gap: 10px;">
                <button onclick="detectDuplicates()" class="btn btn-warning">üîç Detectar Repetidas</button>
                <button onclick="clearQuestions()" class="btn btn-danger">Limpiar Todo</button>
            </div>
        </div>

        <!-- SECCI√ìN DE FILTROS CON B√öSQUEDA -->
        <div class="filter-container">
            <!-- Filtro por tema existente -->
            ${state.topics.length > 0 ? `
                <div>
                    <label style="margin-right: 10px; font-weight: 500;">üìÅ Filtrar por tema:</label>
                    <select onchange="filterByTopic(this.value)" style="padding: 8px; border-radius: 6px; border: 1px solid #d1d5db;">
                        <option value="all" ${state.selectedTopicFilter === 'all' ? 'selected' : ''}>Todos los temas (${state.questions.length})</option>
                        ${state.topics.map(topic => `
                            <option value="${topic.id}" ${state.selectedTopicFilter == topic.id ? 'selected' : ''}>
                                ${topic.name} (${getTopicQuestionCount(topic.id)})
                            </option>
                        `).join('')}
                    </select>
                </div>
            ` : ''}
            
            <!-- Input de b√∫squeda -->
            <div>
                <label style="margin-right: 10px; font-weight: 500;">üîç Buscar:</label>
                <input 
                    type="text" 
                    id="search-input" 
                    placeholder="Escribe para buscar preguntas..." 
                    oninput="searchQuestionsSmooth(this.value)"
                    style="padding: 8px 12px; border-radius: 6px; border: 1px solid #d1d5db; width: 250px; font-size: 14px;"
                    value="${state.searchQuery || ''}"
                />
                ${state.searchQuery ? `
                    <button onclick="clearSearchSmooth()" style="margin-left: 5px; padding: 6px 10px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Limpiar b√∫squeda">
                        ‚úñ
                    </button>
                ` : ''}
            </div>
            
            <!-- Indicador de resultados -->
            ${state.searchQuery ? `
                <div id="search-results-indicator" style="color: #059669; font-weight: 500; font-size: 14px;">
                    üìä ${filteredQuestions.length} resultado${filteredQuestions.length === 1 ? '' : 's'} encontrado${filteredQuestions.length === 1 ? '' : 's'}
                </div>
            ` : ''}
        </div>

        <!-- Contenedor de preguntas que se actualiza sin render completo -->
        <div id="questions-container">
            ${state.topics.length > 0 && state.selectedTopicFilter === 'all' && !state.searchQuery ? 
                renderQuestionsByTopic() : 
                renderQuestionsFilteredWithSearch(filteredQuestions)
            }
        </div>
    `;
};

// Renderizar la interfaz del detector de duplicados
function renderDuplicateDetectorInterface() {
    const groups = window.duplicateDetectorState.duplicateGroups;
    const totalDuplicates = groups.reduce((sum, group) => sum + group.questions.length - 1, 0);
    const mode = window.duplicateDetectorState.detectionMode;
    
    return `
        <div style="max-width: 1200px; margin: 0 auto;">
            <!-- Header -->
            <div style="background: #f59e0b; color: white; padding: 20px; border-radius: 12px 12px 0 0; text-align: center;">
                <h2 style="margin: 0 0 10px 0;">üîç Detector de Preguntas Repetidas</h2>
                <p style="margin: 0; opacity: 0.9;">
                    Encontrados ${groups.length} ${groups.length === 1 ? 'tema con' : 'temas con'} preguntas ${mode === 'exact' ? 'exactas' : 'similares'} (${totalDuplicates} duplicados para eliminar)
                </p>
            </div>
            
            <!-- Controles -->
            <div style="background: white; border: 2px solid #f59e0b; border-top: none; padding: 20px;">
                <!-- Selector de modo -->
                <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                    <div style="background: #f3f4f6; border-radius: 8px; padding: 4px; display: flex; gap: 4px;">
                        <button onclick="changeDetectionMode('exact')" style="padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; ${mode === 'exact' ? 'background: #3b82f6; color: white;' : 'background: transparent; color: #6b7280;'}">
                            üéØ Solo Exactas
                        </button>
                        <button onclick="changeDetectionMode('similar')" style="padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; ${mode === 'similar' ? 'background: #3b82f6; color: white;' : 'background: transparent; color: #6b7280;'}">
                            üîç Similares (85%+)
                        </button>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <button onclick="selectAllFirst()" class="btn btn-secondary" style="margin-right: 10px;">
                            üìÑ Mantener Primeras
                        </button>
                        <button onclick="selectAllVerified()" class="btn btn-secondary">
                            ‚≠ê Mantener Verificadas
                        </button>
                    </div>
                    <div>
                        <button onclick="closeDuplicateDetector()" class="btn btn-secondary" style="margin-right: 10px;">
                            ‚ùå Cancelar
                        </button>
                        <button onclick="removeDuplicates()" class="btn btn-danger">
                            üóëÔ∏è Eliminar Duplicados (${totalDuplicates})
                        </button>
                    </div>
                </div>
                
                <!-- Lista de grupos duplicados por tema -->
                <div style="max-height: 600px; overflow-y: auto;">
                    ${groups.map((group, groupIndex) => {
                        const topicName = getTopicNameForGroup(group);
                        return `
                        <div style="border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 20px; overflow: hidden;">
                            <div style="background: #4f46e5; color: white; padding: 12px 15px; border-bottom: 1px solid #e5e7eb;">
                                <strong>üìÅ ${topicName}</strong> - ${group.questions.length} preguntas ${mode === 'exact' ? 'id√©nticas' : 'similares'}
                            </div>
                            <div style="padding: 15px;">
                                ${group.questions.map((item, questionIndex) => {
                                    const q = item.question;
                                    const isSelected = group.selectedToKeep === item.index;
                                    
                                    return `
                                        <div style="border: 2px solid ${isSelected ? '#10b981' : '#e5e7eb'}; border-radius: 6px; padding: 15px; margin-bottom: 10px; background: ${isSelected ? '#f0fdf4' : 'white'}; cursor: pointer;" onclick="selectQuestionToKeep(${groupIndex}, ${item.index})">
                                            <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 10px;">
                                                <div style="flex: 1;">
                                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                                        <span style="background: ${isSelected ? '#10b981' : '#6b7280'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                                            ${isSelected ? '‚úÖ MANTENER' : 'ELIMINAR'}
                                                        </span>
                                                        ${q.isVerified ? '<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">‚≠ê Verificada</span>' : ''}
                                                    </div>
                                                    <strong>${q.question}</strong>
                                                </div>
                                            </div>
                                            <div style="font-size: 14px; color: #6b7280;">
                                                ${q.options.map((opt, i) => `
                                                    <div style="margin-bottom: 3px;">
                                                        ${String.fromCharCode(65 + i)}) ${opt} ${i === q.correctAnswer ? '‚úÖ' : ''}
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;}).join('')}
                </div>
            </div>
        </div>
    `;
}

// Funci√≥n para cambiar el modo de detecci√≥n
window.changeDetectionMode = function(newMode) {
    window.duplicateDetectorState.detectionMode = newMode;
    
    // Re-detectar con el nuevo modo
    const duplicateGroups = findDuplicateGroups();
    window.duplicateDetectorState.duplicateGroups = duplicateGroups;
    
    // Re-renderizar
    render();
    
    if (typeof showMessage === 'function') {
        const modeText = newMode === 'exact' ? 'solo exactas' : 'similares (85%+)';
        showMessage(`Modo cambiado a: ${modeText}. Encontrados ${duplicateGroups.length} grupos.`, 'info');
    }
};

// Funci√≥n para obtener el nombre del tema de un grupo de duplicados
function getTopicNameForGroup(group) {
    // Obtener el tema de la primera pregunta del grupo
    const firstQuestion = group.questions[0].question;
    
    if (!firstQuestion.topicId) {
        return 'Sin tema asignado';
    }
    
    const topic = state.topics.find(t => t.id == firstQuestion.topicId);
    return topic ? topic.name : 'Tema desconocido';
}

window.selectQuestionToKeep = function(groupIndex, questionIndex) {
    window.duplicateDetectorState.duplicateGroups[groupIndex].selectedToKeep = questionIndex;
    render(); // Re-renderizar para actualizar la interfaz
};

// Funci√≥n para seleccionar todas las primeras preguntas
window.selectAllFirst = function() {
    window.duplicateDetectorState.duplicateGroups.forEach(group => {
        group.selectedToKeep = group.questions[0].index;
    });
    render();
};

// Funci√≥n para seleccionar todas las verificadas (o primera si ninguna est√° verificada)
window.selectAllVerified = function() {
    window.duplicateDetectorState.duplicateGroups.forEach(group => {
        const verifiedQuestion = group.questions.find(item => item.question.isVerified);
        group.selectedToKeep = verifiedQuestion ? verifiedQuestion.index : group.questions[0].index;
    });
    render();
};

// Funci√≥n para cerrar el detector
window.closeDuplicateDetector = function() {
    window.duplicateDetectorState.isShowing = false;
    render();
};

// Funci√≥n para eliminar los duplicados seleccionados
window.removeDuplicates = function() {
    const groups = window.duplicateDetectorState.duplicateGroups;
    const toRemove = [];
    
    // Recopilar √≠ndices a eliminar
    groups.forEach(group => {
        group.questions.forEach(item => {
            if (item.index !== group.selectedToKeep) {
                toRemove.push(item.index);
            }
        });
    });
    
    if (toRemove.length === 0) {
        alert('No hay duplicados para eliminar');
        return;
    }
    
    const confirmMessage = `¬øEliminar ${toRemove.length} preguntas duplicadas?\n\nEsta acci√≥n no se puede deshacer.`;
    
    if (!confirm(confirmMessage)) return;
    
    // Ordenar √≠ndices de mayor a menor para eliminar correctamente
    toRemove.sort((a, b) => b - a);
    
    // Eliminar preguntas
    toRemove.forEach(index => {
        state.questions.splice(index, 1);
    });
    
    // Guardar cambios
    localStorage.setItem('questions', JSON.stringify(state.questions));
    
    // Cerrar detector y mostrar resultado
    window.duplicateDetectorState.isShowing = false;
    render();
    
    if (typeof showMessage === 'function') {
        showMessage(`üóëÔ∏è ${toRemove.length} preguntas duplicadas eliminadas`, 'success');
    }
    
    console.log(`üóëÔ∏è Eliminadas ${toRemove.length} preguntas duplicadas`);
};

// ========== FUNCIONALIDAD DE B√öSQUEDA MEJORADA ==========

// A√±adir variable de b√∫squeda al estado
if (typeof state !== 'undefined') {
    state.searchQuery = state.searchQuery || '';
}

// NUEVA: Funci√≥n de b√∫squeda suave (sin render completo)
window.searchQuestionsSmooth = function(query) {
    if (typeof state !== 'undefined') {
        state.searchQuery = query.trim();
        console.log('üîç Buscando:', query);
        
        // Actualizar solo el contenido, no re-renderizar todo
        updateQuestionsContent();
        updateSearchIndicator();
        updatePageTitle();
    }
};

// NUEVA: Funci√≥n de limpiar b√∫squeda suave
window.clearSearchSmooth = function() {
    if (typeof state !== 'undefined') {
        state.searchQuery = '';
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.value = '';
            searchInput.focus(); // Mantener foco
        }
        console.log('üîç B√∫squeda limpiada');
        
        // Actualizar contenido sin render completo
        updateQuestionsContent();
        updateSearchIndicator();
        updatePageTitle();
    }
};

// NUEVA: Actualizar solo el contenido de preguntas
function updateQuestionsContent() {
    const questionsContainer = document.getElementById('questions-container');
    if (questionsContainer) {
        const filteredQuestions = getFilteredQuestions();
        
        const newContent = state.topics.length > 0 && state.selectedTopicFilter === 'all' && !state.searchQuery ? 
            renderQuestionsByTopic() : 
            renderQuestionsFilteredWithSearch(filteredQuestions);
            
        questionsContainer.innerHTML = newContent;
    }
}

// NUEVA: Actualizar solo el indicador de resultados
function updateSearchIndicator() {
    const indicator = document.getElementById('search-results-indicator');
    const filteredQuestions = getFilteredQuestions();
    
    if (state.searchQuery && state.searchQuery.length > 0) {
        if (!indicator) {
            // Crear indicador si no existe
            const filterContainer = document.querySelector('.filter-container');
            if (filterContainer) {
                const indicatorDiv = document.createElement('div');
                indicatorDiv.id = 'search-results-indicator';
                indicatorDiv.style.cssText = 'color: #059669; font-weight: 500; font-size: 14px;';
                filterContainer.appendChild(indicatorDiv);
            }
        }
        const indicatorElement = document.getElementById('search-results-indicator');
        if (indicatorElement) {
            indicatorElement.innerHTML = `üìä ${filteredQuestions.length} resultado${filteredQuestions.length === 1 ? '' : 's'} encontrado${filteredQuestions.length === 1 ? '' : 's'}`;
        }
    } else {
        if (indicator) {
            indicator.remove();
        }
    }
}

// NUEVA: Actualizar solo el t√≠tulo de la p√°gina
function updatePageTitle() {
    const titleElement = document.querySelector('h2');
    if (titleElement) {
        const filteredQuestions = getFilteredQuestions();
        let title = '';
        
        if (state.selectedTopicFilter === 'all') {
            title = 'TODAS LAS PREGUNTAS DEL BANCO';
        } else {
            const topic = state.topics.find(t => t.id == state.selectedTopicFilter);
            if (topic) {
                title = `PREGUNTAS ${topic.name.toUpperCase()}`;
            } else {
                title = 'PREGUNTAS DEL TEMA SELECCIONADO';
            }
        }
        
        if (state.searchQuery && state.searchQuery.length > 0) {
            title += ` - B√öSQUEDA: "${state.searchQuery.toUpperCase()}"`;
        }
        
        titleElement.textContent = `${title} (${filteredQuestions.length})`;
    }
}

// Funci√≥n para resaltar texto encontrado
window.highlightSearchTerm = function(text, searchTerm) {
    if (!searchTerm || !text) return text;
    
    // Escapar caracteres especiales para regex
    const escapedTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regex = new RegExp(`(${escapedTerm})`, 'gi');
    return text.replace(regex, '<span class="search-highlight">$1</span>');
};

// MEJORADA: Sobrescribir getFilteredQuestions para b√∫squeda secuencial
const originalGetFilteredQuestions = window.getFilteredQuestions;

window.getFilteredQuestions = function() {
    let filtered = state.questions;
    
    // 1. Filtrar por tema (funcionalidad existente)
    if (state.selectedTopicFilter !== 'all') {
        filtered = filtered.filter(q => {
            return q.topicId && q.topicId.toString() === state.selectedTopicFilter.toString();
        });
    }
    
    // 2. MEJORADO: Filtrar por b√∫squeda secuencial
    if (state.searchQuery && state.searchQuery.length > 0) {
        const searchTerm = state.searchQuery.toLowerCase().trim();
        
        filtered = filtered.filter(q => {
            // Buscar la frase completa en orden secuencial
            const questionText = q.question ? q.question.toLowerCase() : '';
            const questionMatch = questionText.includes(searchTerm);
            
            // Buscar en las opciones de respuesta (tambi√©n secuencial)
            const optionsMatch = q.options && q.options.some(option => 
                option && option.toLowerCase().includes(searchTerm)
            );
            
            // Buscar en el nombre del tema (tambi√©n secuencial)
            let topicMatch = false;
            if (q.topicId) {
                const topic = state.topics.find(t => t.id == q.topicId);
                topicMatch = topic && topic.name.toLowerCase().includes(searchTerm);
            }
            
            return questionMatch || optionsMatch || topicMatch;
        });
    }
    
    return filtered;
};

// Funci√≥n mejorada para renderizar preguntas filtradas con b√∫squeda
window.renderQuestionsFilteredWithSearch = function(questions) {
    if (questions.length === 0) {
        let message = 'No hay preguntas disponibles';
        
        if (state.searchQuery && state.searchQuery.length > 0) {
            message = `No se encontraron preguntas que contengan "${state.searchQuery}"`;
        } else if (state.selectedTopicFilter !== 'all') {
            const topic = state.topics.find(t => t.id == state.selectedTopicFilter);
            message = `No hay preguntas en el tema "${topic ? topic.name : 'seleccionado'}"`;
        }
        
        return `
            <div style="text-align: center; padding: 60px 20px; color: #6b7280;">
                <div style="font-size: 3rem; margin-bottom: 20px;">üîç</div>
                <h3 style="margin: 0 0 10px 0; color: #374151;">${message}</h3>
                ${state.searchQuery ? `
                    <p style="margin: 10px 0; font-size: 14px;">Intenta con otros t√©rminos de b√∫squeda</p>
                    <button onclick="clearSearchSmooth()" class="btn btn-primary" style="margin-top: 15px;">
                        ‚úñ Limpiar B√∫squeda
                    </button>
                ` : ''}
            </div>
        `;
    }
    
    return `
        <div style="border: 1px solid #e5e7eb; border-radius: 8px; background: white;">
            ${questions.map((q, index) => {
                const actualIndex = state.questions.findIndex(question => question.id === q.id);
                return renderSingleQuestionWithSearch(q, actualIndex);
            }).join('')}
        </div>
    `;
};

// Funci√≥n para renderizar pregunta individual con resaltado de b√∫squeda
function renderSingleQuestionWithSearch(q, actualIndex) {
    const topicName = q.topicId ? getTopicName(q.topicId) : null;
    const searchTerm = state.searchQuery || '';
    
    // Resaltar t√©rminos en pregunta y opciones si hay b√∫squeda activa
    let displayQuestion = q.question;
    let displayOptions = q.options;
    
    if (searchTerm.length > 0) {
        displayQuestion = highlightSearchTerm(q.question, searchTerm);
        displayOptions = q.options.map(opt => highlightSearchTerm(opt, searchTerm));
    }
    
    return `
        <div style="padding: 15px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: flex-start;">
            <div style="flex: 1; margin-right: 15px;">
                <div style="margin-bottom: 8px; display: flex; align-items: center; flex-wrap: wrap; gap: 8px;">
                    <strong style="color: #1f2937;">P${actualIndex + 1}:</strong>
                    ${topicName ? `<span style="background: #e0e7ff; color: #4f46e5; padding: 2px 6px; border-radius: 8px; font-size: 11px;">${topicName}</span>` : ''}
                    ${q.isVerified ? '<span style="background: #d1fae5; color: #065f46; padding: 2px 6px; border-radius: 8px; font-size: 11px;">‚úì Verificada</span>' : ''}
                </div>
                <div style="font-weight: 500; margin-bottom: 8px; color: #374151; line-height: 1.4;">
                    ${displayQuestion}
                </div>
                <ul style="list-style: none; margin: 0; padding: 0;">
                    ${displayOptions.map((opt, optIndex) => `
                        <li style="padding: 2px 0; color: ${q.correctAnswer === optIndex ? '#10b981' : '#6b7280'}; font-size: 14px;">
                            ${String.fromCharCode(97 + optIndex)}) ${opt} ${q.correctAnswer === optIndex ? '‚úÖ' : ''}
                        </li>
                    `).join('')}
                </ul>
            </div>
            <div style="display: flex; gap: 5px; flex-shrink: 0; margin-left: 15px;">
                <button onclick="editQuestion(${actualIndex})" class="btn btn-warning" style="padding: 5px 10px; font-size: 12px;">Editar</button>
                <button onclick="deleteQuestion(${actualIndex})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">Eliminar</button>
            </div>
        </div>
    `;
}

console.log('‚úÖ Detector de preguntas repetidas aplicado');
console.log('üîç Funcionalidades:');
console.log('   - Detecta preguntas exactas y similares (85%+)');
console.log('   - Interfaz visual para seleccionar cu√°les mantener');
console.log('   - Botones r√°pidos: mantener primeras/verificadas');
console.log('   - Vista previa antes de eliminar');
console.log('   - Preserva preguntas verificadas autom√°ticamente');
console.log('üîç MEJORADO: B√∫squeda fluida y secuencial');
console.log('   - ‚úÖ Cursor NO se sale del input al escribir');
console.log('   - ‚úÖ B√∫squeda secuencial respeta orden de palabras');
console.log('   - ‚úÖ Actualizaci√≥n suave sin render completo');
console.log('   - ‚úÖ Resalta t√©rminos encontrados en amarillo');
console.log('   - ‚úÖ Combinable con filtro por tema');
console.log('   - ‚úÖ Bot√≥n limpiar b√∫squeda mantiene foco');
</script>
 <!-- 
PARCHE: ESTRELLITAS INTERACTIVAS EN PREGUNTAS FILTRADAS
A√±adir este c√≥digo al final del archivo index.html, justo antes de </body>
Este parche permite validar preguntas con estrella mientras usas el buscador
-->

<script>
console.log('‚≠ê Aplicando parche: Estrellitas interactivas en b√∫squeda...');

// REEMPLAZAR completamente la funci√≥n renderSingleQuestionWithSearch
function renderSingleQuestionWithSearch(q, actualIndex) {
    const topicName = q.topicId ? getTopicName(q.topicId) : null;
    const searchTerm = state.searchQuery || '';
    
    // Resaltar t√©rminos en pregunta y opciones si hay b√∫squeda activa
    let displayQuestion = q.question;
    let displayOptions = q.options;
    
    if (searchTerm.length > 0) {
        displayQuestion = highlightSearchTerm(q.question, searchTerm);
        displayOptions = q.options.map(opt => highlightSearchTerm(opt, searchTerm));
    }
    
    return `
        <div style="padding: 15px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: flex-start;">
            <div style="flex: 1; margin-right: 15px;">
                <div style="margin-bottom: 8px; display: flex; align-items: center; flex-wrap: wrap; gap: 8px;">
                    <strong style="color: #1f2937;">P${actualIndex + 1}:</strong>
                    ${topicName ? `<span style="background: #e0e7ff; color: #4f46e5; padding: 2px 6px; border-radius: 8px; font-size: 11px;">${topicName}</span>` : ''}
                    ${q.isVerified ? '<span style="background: #d1fae5; color: #065f46; padding: 2px 6px; border-radius: 8px; font-size: 11px;">‚úì Verificada</span>' : ''}
                </div>
                <div style="font-weight: 500; margin-bottom: 8px; color: #374151; line-height: 1.4;">
                    ${displayQuestion}
                </div>
                <ul style="list-style: none; margin: 0; padding: 0;">
                    ${displayOptions.map((opt, optIndex) => `
                        <li style="padding: 2px 0; color: ${q.correctAnswer === optIndex ? '#10b981' : '#6b7280'}; font-size: 14px;">
                            ${String.fromCharCode(97 + optIndex)}) ${opt} ${q.correctAnswer === optIndex ? '‚úÖ' : ''}
                        </li>
                    `).join('')}
                </ul>
            </div>
            <div style="display: flex; gap: 5px; flex-shrink: 0; margin-left: 15px;">
                <button onclick="toggleVerified(${actualIndex})" class="btn ${q.isVerified ? 'btn-primary' : 'btn-secondary'}" style="padding: 4px 8px; font-size: 14px; ${q.isVerified ? 'background: linear-gradient(135deg, #3b82f6, #1d4ed8);' : ''}" title="${q.isVerified ? 'Pregunta verificada - Click para desmarcar' : 'Marcar como verificada'}">
                    ${q.isVerified ? '‚≠ê' : '‚òÜ'}
                </button>
                <button onclick="editQuestion(${actualIndex})" class="btn btn-warning" style="padding: 5px 10px; font-size: 12px;">Editar</button>
                <button onclick="deleteQuestion(${actualIndex})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">Eliminar</button>
            </div>
        </div>
    `;
}

// VERIFICAR que la funci√≥n toggleVerified existe (deber√≠a existir ya)
if (typeof window.toggleVerified !== 'function') {
    console.log('‚ö†Ô∏è Creando funci√≥n toggleVerified...');
    
    window.toggleVerified = function(index) {
        if (state.questions[index]) {
            state.questions[index].isVerified = !state.questions[index].isVerified;
            localStorage.setItem('questions', JSON.stringify(state.questions));
            render();
            
            const message = state.questions[index].isVerified ? 
                '‚≠ê Pregunta verificada' : 
                '‚òÜ Verificaci√≥n removida';
            showMessage(message, 'success');
        }
    };
}

// MEJORAR tambi√©n la actualizaci√≥n suave del contenedor de preguntas
// Para que las estrellas funcionen sin perder el foco del buscador
function updateQuestionsContainerSmooth() {
    const container = document.getElementById('questions-container');
    if (!container) {
        console.log('üìã Container no encontrado, usando render completo');
        render();
        return;
    }
    
    const filteredQuestions = getFilteredQuestions();
    
    // Determinar qu√© vista usar
    let newHTML;
    if (state.topics.length > 0 && state.selectedTopicFilter === 'all' && !state.searchQuery) {
        newHTML = renderQuestionsByTopic();
    } else {
        newHTML = renderQuestionsFilteredWithSearch(filteredQuestions);
    }
    
    // Actualizar el contenido
    container.innerHTML = newHTML;
    
    // Actualizar tambi√©n el indicador de resultados si existe
    const indicator = document.getElementById('search-results-indicator');
    if (indicator && state.searchQuery && state.searchQuery.length > 0) {
        indicator.innerHTML = `üìä ${filteredQuestions.length} resultado${filteredQuestions.length === 1 ? '' : 's'} encontrado${filteredQuestions.length === 1 ? '' : 's'}`;
    }
}

// SOBRESCRIBIR la funci√≥n de b√∫squeda para usar actualizaci√≥n suave
function performSearchSmooth() {
    const searchInput = document.getElementById('search-input');
    if (!searchInput) return;
    
    const newQuery = searchInput.value.trim();
    state.searchQuery = newQuery;
    
    // Guardar en localStorage para persistencia
    if (newQuery.length > 0) {
        localStorage.setItem('searchQuery', newQuery);
    } else {
        localStorage.removeItem('searchQuery');
    }
    
    // Actualizar vista suavemente SIN render completo
    updateQuestionsContainerSmooth();
}

// ASEGURAR que los eventos de b√∫squeda usen la actualizaci√≥n suave
document.addEventListener('input', function(e) {
    if (e.target && e.target.id === 'search-input') {
        // Usar un peque√±o delay para evitar demasiadas actualizaciones
        if (window.searchTimeout) {
            clearTimeout(window.searchTimeout);
        }
        
        window.searchTimeout = setTimeout(function() {
            performSearchSmooth();
        }, 150); // 150ms de delay
    }
});

// MEJORAR tambi√©n la funci√≥n clearSearchSmooth para mantener consistencia
function clearSearchSmooth() {
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.value = '';
        searchInput.focus(); // Mantener el foco
    }
    
    state.searchQuery = '';
    localStorage.removeItem('searchQuery');
    
    // Actualizar suavemente
    updateQuestionsContainerSmooth();
    
    showMessage('üîç B√∫squeda limpiada', 'info');
}

console.log('‚úÖ Parche aplicado correctamente');
console.log('‚≠ê Funcionalidades a√±adidas:');
console.log('   - Bot√≥n de estrella interactivo en preguntas filtradas');
console.log('   - Validaci√≥n/desvalidaci√≥n sin perder el foco del buscador');
console.log('   - Actualizaci√≥n suave del contenedor de preguntas');
console.log('   - Preserva todo el resaltado de b√∫squeda existente');
console.log('   - Compatible con todos los filtros y b√∫squedas');
</script>
<!-- 
PARCHE COMPLETO: EXPORTACI√ìN SELECTIVA + IMPORTACI√ìN CON TEMA
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
-->

<script>
    // ========== SISTEMA COMPLETO: EXPORTACI√ìN SELECTIVA + IMPORTACI√ìN CON TEMA ==========
    console.log('üöÄ Implementando sistema completo de exportaci√≥n/importaci√≥n...');
    
    // REDEFINIR funci√≥n de exportaci√≥n con modal selectivo
    window.exportContentDataOnly = function() {
        if (!state.currentUser) {
            showMessage('‚ùå Error: No hay usuario logueado', 'error');
            return;
        }
        showExportSelectionModal();
    };
    
    // Funci√≥n para mostrar modal de exportaci√≥n
    function showExportSelectionModal() {
        const existingModal = document.getElementById('export-modal-selector');
        if (existingModal) existingModal.remove();
        
        const modalHTML = `
            <div id="export-modal-selector" style="
                position: fixed; 
                top: 0; 
                left: 0; 
                width: 100%; 
                height: 100%; 
                background: rgba(0,0,0,0.85); 
                z-index: 15000;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease;
            ">
                <style>
                    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                    @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
                    .export-option { transition: all 0.3s ease; }
                    .export-option:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
                </style>
                <div style="
                    background: white;
                    border-radius: 20px;
                    padding: 35px;
                    max-width: 600px;
                    width: 90%;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 25px 70px rgba(0,0,0,0.4);
                    animation: slideIn 0.4s ease;
                ">
                    <h2 style="margin: 0 0 15px 0; color: #1a202c; text-align: center; font-size: 1.5rem; font-weight: 700;">
                        üíæ Exportar Datos Selectivos
                    </h2>
                    
                    <div style="background: linear-gradient(135deg, #e3f2fd, #f3e5f5); border-radius: 12px; padding: 20px; margin-bottom: 25px; border-left: 5px solid #2196f3;">
                        <p style="margin: 0; color: #1565c0; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.2rem;">üåê</span> 
                            <strong>Archivos 100% portables:</strong> Funcionan en cualquier cuenta, sin datos personales.
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #374151; margin-bottom: 20px; font-size: 1.2rem; font-weight: 600;">Elige qu√© exportar:</h3>
                        
                        <div style="display: grid; gap: 15px;">
                            <label class="export-option" style="
                                display: flex; 
                                align-items: center; 
                                padding: 18px; 
                                border-radius: 12px; 
                                cursor: pointer; 
                                background: #f8fafc;
                                border: 2px solid #e2e8f0;
                            ">
                                <input type="checkbox" id="export-only-questions" style="margin-right: 15px; transform: scale(1.3);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #1f2937; font-size: 1.1rem; margin-bottom: 4px;">
                                        üìù Solo Preguntas
                                    </div>
                                    <div style="font-size: 0.9rem; color: #6b7280;">
                                        Exportar √∫nicamente las ${state.questions ? state.questions.length : 0} preguntas generadas
                                    </div>
                                </div>
                            </label>
                            
                            <label class="export-option" style="
                                display: flex; 
                                align-items: center; 
                                padding: 18px; 
                                border-radius: 12px; 
                                cursor: pointer; 
                                background: #f8fafc;
                                border: 2px solid #e2e8f0;
                            ">
                                <input type="checkbox" id="export-topics-questions" style="margin-right: 15px; transform: scale(1.3);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #1f2937; font-size: 1.1rem; margin-bottom: 4px;">
                                        üìö Temas + Preguntas
                                    </div>
                                    <div style="font-size: 0.9rem; color: #6b7280;">
                                        Exportar ${state.topics ? state.topics.length : 0} temas y ${state.questions ? state.questions.length : 0} preguntas asociadas
                                    </div>
                                </div>
                            </label>
                            
                            <label class="export-option" style="
                                display: flex; 
                                align-items: center; 
                                padding: 18px; 
                                border-radius: 12px; 
                                cursor: pointer; 
                                background: #f8fafc;
                                border: 2px solid #e2e8f0;
                            ">
                                <input type="checkbox" id="export-only-summaries" style="margin-right: 15px; transform: scale(1.3);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #1f2937; font-size: 1.1rem; margin-bottom: 4px;">
                                        üìÑ Solo Res√∫menes
                                    </div>
                                    <div style="font-size: 0.9rem; color: #6b7280;">
                                        Exportar ${typeof summarySystemState !== 'undefined' && summarySystemState.savedSummaries ? summarySystemState.savedSummaries.length : 0} res√∫menes generados
                                    </div>
                                </div>
                            </label>
                            
                            <label class="export-option" style="
                                display: flex; 
                                align-items: center; 
                                padding: 18px; 
                                border-radius: 12px; 
                                cursor: pointer; 
                                background: #f8fafc;
                                border: 2px solid #e2e8f0;
                            ">
                                <input type="checkbox" id="export-progress-data" style="margin-right: 15px; transform: scale(1.3);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #1f2937; font-size: 1.1rem; margin-bottom: 4px;">
                                        üìä Progreso de Estudio
                                    </div>
                                    <div style="font-size: 0.9rem; color: #6b7280;">
                                        Exportar configuraci√≥n de temas y progreso de estudio
                                    </div>
                                </div>
                            </label>
                            
                            <label class="export-option" style="
                                display: flex; 
                                align-items: center; 
                                padding: 18px; 
                                border-radius: 12px; 
                                cursor: pointer; 
                                background: #f8fafc;
                                border: 2px solid #e2e8f0;
                            ">
                                <input type="checkbox" id="export-test-results" style="margin-right: 15px; transform: scale(1.3);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #1f2937; font-size: 1.1rem; margin-bottom: 4px;">
                                        üß™ Tests Realizados
                                    </div>
                                    <div style="font-size: 0.9rem; color: #6b7280;">
                                        Exportar historial de ${state.testResults ? state.testResults.length : 0} tests realizados
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        <button onclick="processExportSelection()" style="
                            flex: 1;
                            background: linear-gradient(135deg, #10b981, #059669);
                            color: white;
                            border: none;
                            padding: 15px 25px;
                            border-radius: 12px;
                            font-weight: 700;
                            font-size: 1rem;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
                        " onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(16, 185, 129, 0.4)'" 
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(16, 185, 129, 0.3)'">
                            üíæ Exportar Seleccionados
                        </button>
                        
                        <button onclick="closeExportModal()" style="
                            flex: 0.7;
                            background: #6b7280;
                            color: white;
                            border: none;
                            padding: 15px 25px;
                            border-radius: 12px;
                            font-weight: 700;
                            font-size: 1rem;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'">
                            ‚ùå Cancelar
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center; display: flex; gap: 10px; justify-content: center;">
                        <button onclick="selectAllExportOptions()" style="
                            background: transparent;
                            color: #0ea5e9;
                            border: 2px solid #0ea5e9;
                            padding: 10px 18px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 0.9rem;
                            font-weight: 600;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='#0ea5e9'; this.style.color='white'" 
                           onmouseout="this.style.background='transparent'; this.style.color='#0ea5e9'">
                            ‚úÖ Seleccionar Todo
                        </button>
                        
                        <button onclick="clearAllExportOptions()" style="
                            background: transparent;
                            color: #ef4444;
                            border: 2px solid #ef4444;
                            padding: 10px 18px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 0.9rem;
                            font-weight: 600;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='#ef4444'; this.style.color='white'" 
                           onmouseout="this.style.background='transparent'; this.style.color='#ef4444'">
                            ‚ùå Limpiar Todo
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        document.addEventListener('keydown', function handleEscape(e) {
            if (e.key === 'Escape') {
                closeExportModal();
                document.removeEventListener('keydown', handleEscape);
            }
        });
        
        console.log('üíæ Modal de exportaci√≥n selectiva mostrado');
    }
    
    function closeExportModal() {
        const modal = document.getElementById('export-modal-selector');
        if (modal) {
            modal.style.opacity = '0';
            setTimeout(() => modal.remove(), 300);
        }
    }
    
    function selectAllExportOptions() {
        const checkboxes = ['export-only-questions', 'export-topics-questions', 'export-only-summaries', 'export-progress-data', 'export-test-results'];
        checkboxes.forEach(id => {
            const checkbox = document.getElementById(id);
            if (checkbox) checkbox.checked = true;
        });
    }
    
    function clearAllExportOptions() {
        const checkboxes = ['export-only-questions', 'export-topics-questions', 'export-only-summaries', 'export-progress-data', 'export-test-results'];
        checkboxes.forEach(id => {
            const checkbox = document.getElementById(id);
            if (checkbox) checkbox.checked = false;
        });
    }
    
    function processExportSelection() {
        const selections = {
            onlyQuestions: document.getElementById('export-only-questions')?.checked || false,
            topicsAndQuestions: document.getElementById('export-topics-questions')?.checked || false,
            onlySummaries: document.getElementById('export-only-summaries')?.checked || false,
            progressData: document.getElementById('export-progress-data')?.checked || false,
            testResults: document.getElementById('export-test-results')?.checked || false
        };
        
        const hasSelection = Object.values(selections).some(selected => selected);
        if (!hasSelection) {
            showMessage('‚ö†Ô∏è Selecciona al menos una opci√≥n para exportar', 'error');
            return;
        }
        
        closeExportModal();
        executeSelectiveExport(selections);
    }
    
    function executeSelectiveExport(selections) {
        try {
            const username = state.currentUser.username;
            
            const exportData = {
                version: "5.0",
                exportDate: new Date().toISOString(),
                exportTimestamp: Date.now(),
                exportType: "selective_portable",
                originalUser: username,
                selectedOptions: selections,
                data: {},
                stats: {}
            };
            
            let exportedItems = [];
            let totalItems = 0;
            let fileNameParts = [];
            
            if (selections.onlyQuestions && state.questions && state.questions.length > 0) {
                exportData.data.questions = state.questions;
                exportData.stats.totalQuestions = state.questions.length;
                exportedItems.push(`üìù ${state.questions.length} preguntas`);
                totalItems += state.questions.length;
                fileNameParts.push('preguntas');
            }
            
            if (selections.topicsAndQuestions) {
                if (state.topics && state.topics.length > 0) {
                    exportData.data.topics = state.topics;
                    exportData.stats.totalTopics = state.topics.length;
                    exportedItems.push(`üìö ${state.topics.length} temas`);
                    totalItems += state.topics.length;
                }
                
                if (state.questions && state.questions.length > 0) {
                    exportData.data.questions = state.questions;
                    exportData.stats.totalQuestions = state.questions.length;
                    exportedItems.push(`üìù ${state.questions.length} preguntas asociadas`);
                    totalItems += state.questions.length;
                }
                fileNameParts.push('temas');
            }
            
            if (selections.onlySummaries && typeof summarySystemState !== 'undefined') {
                if (summarySystemState.summaryTopics && summarySystemState.summaryTopics.length > 0) {
                    exportData.data.summaryTopics = summarySystemState.summaryTopics;
                }
                
                if (summarySystemState.savedSummaries && summarySystemState.savedSummaries.length > 0) {
                    exportData.data.savedSummaries = summarySystemState.savedSummaries;
                    exportData.stats.totalSummaries = summarySystemState.savedSummaries.length;
                    exportedItems.push(`üìÑ ${summarySystemState.savedSummaries.length} res√∫menes`);
                    totalItems += summarySystemState.savedSummaries.length;
                    fileNameParts.push('resumenes');
                }
            }
            
            if (selections.progressData && typeof progressState !== 'undefined' && progressState.studyTopics) {
                exportData.data.progressTopics = progressState.studyTopics;
                exportData.stats.totalProgressTopics = progressState.studyTopics.length;
                exportedItems.push(`üìä Progreso de ${progressState.studyTopics.length} temas`);
                totalItems += progressState.studyTopics.length;
                fileNameParts.push('progreso');
            }
            
            if (selections.testResults && state.testResults && state.testResults.length > 0) {
                exportData.data.testResults = state.testResults;
                exportData.stats.totalTests = state.testResults.length;
                exportedItems.push(`üß™ ${state.testResults.length} tests`);
                totalItems += state.testResults.length;
                fileNameParts.push('tests');
            }
            
            if (totalItems === 0) {
                showMessage('‚ö†Ô∏è No hay datos disponibles para exportar con las opciones seleccionadas', 'error');
                return;
            }
            
            const dateStr = new Date().toISOString().split('T')[0];
            const timeStr = new Date().toLocaleTimeString('es-ES').replace(/:/g, '');
            const fileName = `export_${fileNameParts.join('_')}_${dateStr}_${timeStr}.json`;
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage(`
‚úÖ EXPORTACI√ìN COMPLETADA
üìÅ Archivo: ${fileName}

üìä EXPORTADO:
${exportedItems.join('\n')}

üîê Archivo 100% portable
üåê Funciona en cualquier cuenta
            `.trim(), 'success');
            
            console.log('‚úÖ Exportaci√≥n selectiva completada:', fileName);
            
        } catch (error) {
            console.error('‚ùå Error en exportaci√≥n:', error);
            showMessage('‚ùå Error al exportar: ' + error.message, 'error');
        }
    }
    
    // REDEFINIR funci√≥n de importaci√≥n con selecci√≥n de tema
    window.importContentFromFile = function() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                showMessage('‚ùå Selecciona un archivo .json v√°lido', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importedData = JSON.parse(event.target.result);
                    
                    if (!importedData.data && !importedData.contentData && !importedData.userData) {
                        throw new Error('Archivo no v√°lido: estructura no reconocida');
                    }
                    
                    let sourceData;
                    let fileType = "desconocido";
                    
                    if (importedData.data) {
                        sourceData = importedData.data;
                        fileType = "exportaci√≥n selectiva";
                    } else if (importedData.contentData) {
                        sourceData = importedData.contentData;
                        fileType = "contenido portable";
                    } else if (importedData.userData) {
                        sourceData = importedData.userData;
                        fileType = "backup completo";
                    }
                    
                    showImportModal(importedData, sourceData, fileType);
                    
                } catch (error) {
                    console.error('‚ùå Error al procesar archivo:', error);
                    showMessage('‚ùå Error al leer archivo: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
        };
        
        input.click();
    };
    
    function showImportModal(importedData, sourceData, fileType) {
        const existingModal = document.getElementById('import-modal-selector');
        if (existingModal) existingModal.remove();
        
        const questionsCount = sourceData.questions?.length || 0;
        const topicsCount = sourceData.topics?.length || 0;
        const testsCount = sourceData.testResults?.length || 0;
        const summariesCount = sourceData.savedSummaries?.length || 0;
        const progressCount = sourceData.progressTopics?.length || 0;
        
        const existingTopics = state.topics || [];
        let topicSelectOptions = '';
        existingTopics.forEach(topic => {
            topicSelectOptions += `<option value="${topic.name}">${topic.name}</option>`;
        });
        
        const modalHTML = `
            <div id="import-modal-selector" style="
                position: fixed; 
                top: 0; 
                left: 0; 
                width: 100%; 
                height: 100%; 
                background: rgba(0,0,0,0.85); 
                z-index: 15000;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease;
            ">
                <div style="
                    background: white;
                    border-radius: 20px;
                    padding: 35px;
                    max-width: 650px;
                    width: 90%;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 25px 70px rgba(0,0,0,0.4);
                    animation: slideIn 0.4s ease;
                ">
                    <h2 style="margin: 0 0 20px 0; color: #1a202c; text-align: center; font-size: 1.5rem; font-weight: 700;">
                        üì• Importar Contenido
                    </h2>
                    
                    <div style="background: linear-gradient(135deg, #e8f5e8, #f0f9ff); border-radius: 12px; padding: 20px; margin-bottom: 25px; border-left: 5px solid #10b981;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 1.3rem;">üìÇ</span>
                            <strong style="color: #059669; font-size: 1.1rem;">Tipo:</strong>
                            <span style="color: #065f46; font-weight: 600;">${fileType}</span>
                        </div>
                        
                        <div style="margin-left: 35px; color: #047857;">
                            ${importedData.originalUser ? `<div><strong>Usuario original:</strong> ${importedData.originalUser}</div>` : ''}
                            ${importedData.exportDate ? `<div><strong>Fecha:</strong> ${new Date(importedData.exportDate).toLocaleDateString('es-ES')}</div>` : ''}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #374151; margin-bottom: 15px; font-size: 1.2rem;">üìä Contenido disponible:</h3>
                        
                        <div style="display: grid; gap: 10px;">
                            ${questionsCount > 0 ? `
                                <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8fafc; border-radius: 8px;">
                                    <span style="font-size: 1.2rem;">üìù</span>
                                    <span><strong>${questionsCount}</strong> preguntas</span>
                                </div>
                            ` : ''}
                            
                            ${topicsCount > 0 ? `
                                <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8fafc; border-radius: 8px;">
                                    <span style="font-size: 1.2rem;">üìö</span>
                                    <span><strong>${topicsCount}</strong> temas</span>
                                </div>
                            ` : ''}
                            
                            ${summariesCount > 0 ? `
                                <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8fafc; border-radius: 8px;">
                                    <span style="font-size: 1.2rem;">üìÑ</span>
                                    <span><strong>${summariesCount}</strong> res√∫menes</span>
                                </div>
                            ` : ''}
                            
                            ${testsCount > 0 ? `
                                <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8fafc; border-radius: 8px;">
                                    <span style="font-size: 1.2rem;">üß™</span>
                                    <span><strong>${testsCount}</strong> tests</span>
                                </div>
                            ` : ''}
                            
                            ${progressCount > 0 ? `
                                <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8fafc; border-radius: 8px;">
                                    <span style="font-size: 1.2rem;">üìä</span>
                                    <span><strong>${progressCount}</strong> temas de progreso</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    ${(questionsCount > 0 || summariesCount > 0) ? `
                        <div style="margin-bottom: 25px; padding: 20px; background: #fffbeb; border-radius: 12px; border-left: 5px solid #f59e0b;">
                            <h4 style="margin: 0 0 15px 0; color: #92400e; font-size: 1.1rem; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.2rem;">üéØ</span>
                                Asignar a tema
                            </h4>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px; color: #78350f; font-weight: 600;">
                                    Elige d√≥nde importar las preguntas/res√∫menes:
                                </label>
                                
                                <select id="theme-selector" style="
                                    width: 100%;
                                    padding: 12px;
                                    border-radius: 8px;
                                    border: 2px solid #fbbf24;
                                    background: white;
                                    font-size: 1rem;
                                    color: #92400e;
                                ">
                                    <option value="create-new">üÜï Crear nuevo tema</option>
                                    ${existingTopics.length > 0 ? `<option value="" disabled>‚îÄ‚îÄ Temas existentes ‚îÄ‚îÄ</option>` : ''}
                                    ${topicSelectOptions}
                                </select>
                            </div>
                            
                            <div id="new-theme-input" style="display: none;">
                                <label style="display: block; margin-bottom: 8px; color: #78350f; font-weight: 600;">
                                    Nombre del nuevo tema:
                                </label>
                                <input type="text" id="new-theme-name" placeholder="Ej: Historia de Espa√±a" style="
                                    width: 100%;
                                    padding: 12px;
                                    border-radius: 8px;
                                    border: 2px solid #fbbf24;
                                    font-size: 1rem;
                                ">
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 25px;">
                        <h4 style="margin: 0 0 15px 0; color: #374151; font-size: 1.1rem;">‚öôÔ∏è Opciones de importaci√≥n:</h4>
                        
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 10px;">
                            <input type="checkbox" id="avoid-duplicates" checked style="transform: scale(1.2);">
                            <span style="color: #4b5563;">Evitar duplicados autom√°ticamente</span>
                        </label>
                        
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="merge-content" checked style="transform: scale(1.2);">
                            <span style="color: #4b5563;">Agregar a contenido existente (no reemplazar)</span>
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        <button onclick="processImportWithTheme()" style="
                            flex: 1;
                            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
                            color: white;
                            border: none;
                            padding: 15px 25px;
                            border-radius: 12px;
                            font-weight: 700;
                            font-size: 1rem;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
                        " onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                            üì• Importar Contenido
                        </button>
                        
                        <button onclick="closeImportModal()" style="
                            flex: 0.7;
                            background: #6b7280;
                            color: white;
                            border: none;
                            padding: 15px 25px;
                            border-radius: 12px;
                            font-weight: 700;
                            font-size: 1rem;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'">
                            ‚ùå Cancelar
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        window.pendingImportData = { importedData, sourceData, fileType };
        
        setTimeout(() => {
            const themeSelector = document.getElementById('theme-selector');
            const newThemeInput = document.getElementById('new-theme-input');
            
            if (themeSelector && newThemeInput) {
                themeSelector.onchange = function() {
                    if (this.value === 'create-new') {
                        newThemeInput.style.display = 'block';
                        document.getElementById('new-theme-name').focus();
                    } else {
                        newThemeInput.style.display = 'none';
                    }
                };
            }
        }, 100);
        
        document.addEventListener('keydown', function handleEscape(e) {
            if (e.key === 'Escape') {
                closeImportModal();
                document.removeEventListener('keydown', handleEscape);
            }
        });
        
        console.log('üì• Modal de importaci√≥n mostrado');
    }
    
    function closeImportModal() {
        const modal = document.getElementById('import-modal-selector');
        if (modal) {
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.remove();
                delete window.pendingImportData;
            }, 300);
        }
    }
    
    function processImportWithTheme() {
        if (!window.pendingImportData) {
            showMessage('‚ùå Error: No hay datos pendientes de importaci√≥n', 'error');
            return;
        }
        
        const { importedData, sourceData, fileType } = window.pendingImportData;
        
        const themeSelector = document.getElementById('theme-selector');
        const newThemeName = document.getElementById('new-theme-name');
        const avoidDuplicates = document.getElementById('avoid-duplicates')?.checked || true;
        const mergeContent = document.getElementById('merge-content')?.checked || true;
        
        let targetTheme = null;
        
        if (themeSelector && (sourceData.questions?.length > 0 || sourceData.savedSummaries?.length > 0)) {
            if (themeSelector.value === 'create-new') {
                const newName = newThemeName?.value?.trim();
                if (!newName) {
                    showMessage('‚ùå Debes escribir el nombre del nuevo tema', 'error');
                    return;
                }
                
                const existingTheme = state.topics?.find(t => t.name.toLowerCase() === newName.toLowerCase());
                if (existingTheme) {
                    showMessage('‚ùå Ya existe un tema con ese nombre', 'error');
                    return;
                }
                
                targetTheme = newName;
            } else if (themeSelector.value) {
                targetTheme = themeSelector.value;
            }
        }
        
        closeImportModal();
        executeImportWithTheme(sourceData, targetTheme, { avoidDuplicates, mergeContent });
    }
    
    function executeImportWithTheme(sourceData, targetTheme, options) {
        try {
            showMessage('üì• Importando contenido...', 'info');
            
            let importedItems = [];
            let totalItemsImported = 0;
            
            const currentQuestions = state.questions || [];
            const currentTopics = state.topics || [];
            const currentTests = state.testResults || [];
            
            if (sourceData.questions && sourceData.questions.length > 0) {
                let questionsToAdd = [...sourceData.questions];
                
                if (targetTheme) {
                    questionsToAdd = questionsToAdd.map(q => ({
                        ...q,
                        topic: targetTheme
                    }));
                    
                    const themeExists = currentTopics.find(t => t.name === targetTheme);
                    if (!themeExists) {
                        const newTopic = {
                            id: 'topic_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            name: targetTheme,
                            questions: questionsToAdd.length
                        };
                        state.topics = [...currentTopics, newTopic];
                        console.log('üÜï Nuevo tema creado:', targetTheme);
                    }
                }
                
                if (options.avoidDuplicates) {
                    const existingIds = new Set(currentQuestions.map(q => q.id));
                    questionsToAdd = questionsToAdd.filter(q => !existingIds.has(q.id));
                }
                
                if (options.mergeContent) {
                    state.questions = [...currentQuestions, ...questionsToAdd];
                } else {
                    state.questions = questionsToAdd;
                }
                
                importedItems.push(`üìù ${questionsToAdd.length} preguntas`);
                totalItemsImported += questionsToAdd.length;
            }
            
            if (sourceData.topics && sourceData.topics.length > 0) {
                let topicsToAdd = [...sourceData.topics];
                
                if (options.avoidDuplicates) {
                    const existingNames = new Set(currentTopics.map(t => t.name.toLowerCase()));
                    topicsToAdd = topicsToAdd.filter(t => !existingNames.has(t.name.toLowerCase()));
                }
                
                topicsToAdd.forEach(topic => {
                    if (!topic.id) {
                        topic.id = 'topic_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    }
                });
                
                if (options.mergeContent) {
                    state.topics = [...currentTopics, ...topicsToAdd];
                } else {
                    state.topics = topicsToAdd;
                }
                
                importedItems.push(`üìö ${topicsToAdd.length} temas`);
                totalItemsImported += topicsToAdd.length;
            }
            
            if (sourceData.testResults && sourceData.testResults.length > 0) {
                if (options.mergeContent) {
                    state.testResults = [...currentTests, ...sourceData.testResults];
                } else {
                    state.testResults = sourceData.testResults;
                }
                
                importedItems.push(`üß™ ${sourceData.testResults.length} tests`);
                totalItemsImported += sourceData.testResults.length;
            }
            
            if (sourceData.savedSummaries && sourceData.savedSummaries.length > 0 && typeof summarySystemState !== 'undefined') {
                let summariesToAdd = [...sourceData.savedSummaries];
                
                if (targetTheme) {
                    summariesToAdd = summariesToAdd.map(s => ({
                        ...s,
                        topic: targetTheme
                    }));
                }
                
                const currentSummaries = summarySystemState.savedSummaries || [];
                
                if (options.mergeContent) {
                    summarySystemState.savedSummaries = [...currentSummaries, ...summariesToAdd];
                } else {
                    summarySystemState.savedSummaries = summariesToAdd;
                }
                
                if (sourceData.summaryTopics) {
                    const currentSummaryTopics = summarySystemState.summaryTopics || [];
                    if (options.mergeContent) {
                        summarySystemState.summaryTopics = [...currentSummaryTopics, ...sourceData.summaryTopics];
                    } else {
                        summarySystemState.summaryTopics = sourceData.summaryTopics;
                    }
                }
                
                importedItems.push(`üìÑ ${summariesToAdd.length} res√∫menes`);
                totalItemsImported += summariesToAdd.length;
            }
            
            if (sourceData.progressTopics && typeof progressState !== 'undefined') {
                if (options.mergeContent) {
                    const currentProgress = progressState.studyTopics || [];
                    progressState.studyTopics = [...currentProgress, ...sourceData.progressTopics];
                } else {
                    progressState.studyTopics = sourceData.progressTopics;
                }
                
                importedItems.push(`üìä Progreso de ${sourceData.progressTopics.length} temas`);
                totalItemsImported += sourceData.progressTopics.length;
            }
            
            // GUARDAR CAMBIOS - CR√çTICO
            console.log('üíæ Guardando cambios en localStorage...');
            
            if (typeof RealDataManager !== 'undefined' && state.currentUser) {
                console.log(`üíæ Usando RealDataManager para usuario: ${state.currentUser.username}`);
                RealDataManager.saveFromGlobalData(state.currentUser.username);
                console.log('‚úÖ Datos guardados con RealDataManager');
            } else {
                // Fallback manual si RealDataManager no existe
                console.log('üíæ Usando guardado manual (fallback)');
                const username = state.currentUser?.username;
                if (username) {
                    localStorage.setItem(`testbank_${username}`, JSON.stringify({
                        questions: state.questions || [],
                        topics: state.topics || [],
                        testResults: state.testResults || [],
                        apiKey: state.apiKey || ''
                    }));
                    console.log('‚úÖ Datos guardados manualmente');
                }
            }
            
            // VERIFICACI√ìN FINAL COMPLETA Y MEJORADA
            setTimeout(() => {
                console.log('üîç VERIFICACI√ìN FINAL COMPLETA:');
                console.log(`üìä Total preguntas en state: ${state.questions?.length || 0}`);
                console.log(`üìö Total temas en state: ${state.topics?.length || 0}`);
                
                // Verificar cu√°ntas preguntas est√°n asignadas al tema objetivo
                if (targetTheme && state.questions) {
                    const questionsInTargetTheme = state.questions.filter(q => q.topic === targetTheme);
                    console.log(`üéØ Preguntas en tema "${targetTheme}": ${questionsInTargetTheme.length}`);
                    
                    // Mostrar muestra de preguntas del tema
                    console.log('üìã Muestra de preguntas del tema:');
                    questionsInTargetTheme.slice(0, 3).forEach((q, i) => {
                        console.log(`  ${i+1}. "${q.question?.substring(0, 50)}..." (Topic: "${q.topic}")`);
                    });
                    
                    // Verificar el tema en el array de temas
                    const themeInState = state.topics?.find(t => t.name === targetTheme);
                    if (themeInState) {
                        console.log(`üìö Tema en state: "${themeInState.name}" - Contador: ${themeInState.questions}`);
                        
                        // VERIFICAR SINCRONIZACI√ìN
                        if (themeInState.questions !== questionsInTargetTheme.length) {
                            console.log(`‚ö†Ô∏è DESINCRONIZACI√ìN DETECTADA: Contador=${themeInState.questions}, Real=${questionsInTargetTheme.length}`);
                            
                            // CORRECCI√ìN AUTOM√ÅTICA
                            themeInState.questions = questionsInTargetTheme.length;
                            console.log(`üîß Contador corregido autom√°ticamente: ${themeInState.questions}`);
                            
                            // Guardar correcci√≥n
                            if (typeof RealDataManager !== 'undefined' && state.currentUser) {
                                RealDataManager.saveFromGlobalData(state.currentUser.username);
                                console.log('üíæ Correcci√≥n guardada');
                            }
                            
                            // Re-renderizar con correcci√≥n
                            if (typeof render === 'function') {
                                render();
                                console.log('üîÑ Interfaz actualizada con correcci√≥n');
                            }
                        } else {
                            console.log('‚úÖ Contador sincronizado correctamente');
                        }
                    }
                }
                
                // Verificar localStorage con m√°s detalle
                const username = state.currentUser?.username;
                if (username) {
                    const savedData = localStorage.getItem(`testbank_${username}`);
                    if (savedData) {
                        const parsed = JSON.parse(savedData);
                        console.log(`üíæ localStorage - Preguntas: ${parsed.questions?.length || 0}, Temas: ${parsed.topics?.length || 0}`);
                        
                        // Verificar preguntas del tema en localStorage
                        if (targetTheme && parsed.questions) {
                            const savedQuestionsInTheme = parsed.questions.filter(q => q.topic === targetTheme);
                            console.log(`üíæ Preguntas del tema en localStorage: ${savedQuestionsInTheme.length}`);
                            
                            // Verificar tema en localStorage
                            const savedTheme = parsed.topics?.find(t => t.name === targetTheme);
                            if (savedTheme) {
                                console.log(`üíæ Contador del tema en localStorage: ${savedTheme.questions}`);
                            }
                        }
                    }
                }
                
                console.log('üéâ Verificaci√≥n final completada');
            }, 800);
            
            // Actualizar interfaz - FORZAR RE-RENDERIZADO
            console.log('üîÑ Actualizando interfaz...');
            if (typeof render === 'function') {
                render();
                console.log('‚úÖ Interfaz actualizada con render()');
            }
            
            // Forzar actualizaci√≥n de contadores si estamos en banco de preguntas
            setTimeout(() => {
                if (state.currentTab === 'upload') {
                    console.log('üîÑ Forzando actualizaci√≥n de contadores...');
                    render();
                }
            }, 200);
            
            const themeInfo = targetTheme ? `\nüéØ Asignado al tema: "${targetTheme}"` : '';
            
            showMessage(`
‚úÖ IMPORTACI√ìN COMPLETADA

üìä CONTENIDO IMPORTADO:
${importedItems.join('\n')}${themeInfo}

üìà Total: ${totalItemsImported} elementos
üîÑ ${options.mergeContent ? 'Agregado a contenido existente' : 'Contenido reemplazado'}
            `.trim(), 'success');
            
            console.log('‚úÖ Importaci√≥n completada:', {
                items: importedItems,
                targetTheme,
                totalItems: totalItemsImported
            });
            
        } catch (error) {
            console.error('‚ùå Error en importaci√≥n:', error);
            showMessage('‚ùå Error al importar: ' + error.message, 'error');
        }
    }
    
    // Hacer funciones globales
    window.showExportSelectionModal = showExportSelectionModal;
    window.closeExportModal = closeExportModal;
    window.selectAllExportOptions = selectAllExportOptions;
    window.clearAllExportOptions = clearAllExportOptions;
    window.processExportSelection = processExportSelection;
    window.executeSelectiveExport = executeSelectiveExport;
    window.showImportModal = showImportModal;
    window.closeImportModal = closeImportModal;
    window.processImportWithTheme = processImportWithTheme;
    window.executeImportWithTheme = executeImportWithTheme;
    
    // Interceptar clics en botones existentes (SOLO del men√∫ principal, no de modales)
    document.addEventListener('click', function(event) {
        const target = event.target;
        
        // Verificar que NO estemos dentro de un modal
        const isInsideModal = target.closest('#export-modal-selector') || target.closest('#import-modal-selector');
        if (isInsideModal) {
            // Si estamos dentro de un modal, NO interceptar
            return;
        }
        
        // Solo interceptar botones del men√∫ principal
        if (target.textContent && target.textContent.includes('Exportar Contenido')) {
            event.preventDefault();
            event.stopPropagation();
            console.log('üîÑ Interceptando clic en bot√≥n de exportar del men√∫');
            window.exportContentDataOnly();
            return false;
        }
        
        if (target.textContent && target.textContent.includes('Importar Contenido') && !target.onclick) {
            event.preventDefault();
            event.stopPropagation();
            console.log('üîÑ Interceptando clic en bot√≥n de importar del men√∫');
            window.importContentFromFile();
            return false;
        }
    }, true);
    
    // Aplicar estilos CSS
    if (!document.getElementById('export-import-styles')) {
        const styles = document.createElement('style');
        styles.id = 'export-import-styles';
        styles.textContent = `
            .export-option:hover {
                background: #f3f4f6 !important;
                border-color: #60a5fa !important;
            }
            
            .export-option input[type="checkbox"]:checked + div {
                color: #1d4ed8 !important;
            }
            
            input[type="checkbox"] {
                accent-color: #3b82f6 !important;
            }
            
            select {
                background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
                background-repeat: no-repeat;
                background-position: right 12px center;
                background-size: 16px;
                padding-right: 40px !important;
            }
        `;
        document.head.appendChild(styles);
    }
    
    console.log('‚úÖ SISTEMA COMPLETO IMPLEMENTADO');
    console.log('üéØ Funcionalidades:');
    console.log('  üì§ Exportaci√≥n selectiva con modal interactivo');
    console.log('  üì• Importaci√≥n con selecci√≥n/creaci√≥n de tema');
    console.log('  üé® Interfaz moderna y responsive');
    console.log('  üîê Archivos 100% portables entre cuentas');
    console.log('  üö´ Sin exportaci√≥n de datos de usuario');
    console.log('  ‚ö° Evita duplicados autom√°ticamente');
    console.log('  üîÑ Compatible con todos los formatos existentes');
    
    setTimeout(() => {
        console.log('üöÄ SISTEMA LISTO PARA USAR');
        console.log('üí° Haz clic en "Exportar Contenido" para probar la nueva funcionalidad');
    }, 1000);
</script>
</body>
</html>


















































































































































