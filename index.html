<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Ex√°menes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .title {
            font-size: 2rem;
            font-weight: bold;
            color: #2d3748;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            margin: 5px;
        }

        .btn-primary { background: #4f46e5; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-info { background: #0ea5e9; color: white; }

        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

        .nav-tabs {
            display: flex;
            margin-bottom: 30px;
            background: #f8fafc;
            border-radius: 12px;
            padding: 5px;
        }

        .nav-tab {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: white;
            color: #4f46e5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            font-weight: 500;
            margin-bottom: 5px;
            color: #374151;
            display: block;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .success { 
            background: #d1fae5; 
            color: #065f46; 
            border-color: #10b981; 
        }

        .error { 
            background: #fee2e2; 
            color: #991b1b; 
            border-color: #ef4444; 
        }

        .three-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .column {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e2e8f0;
        }

        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
        }

        /* Nuevos estilos para checkboxes personalizados */
        .custom-checkbox {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .custom-checkbox:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .custom-checkbox.selected {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .custom-checkbox input[type="checkbox"] {
            transform: scale(1.3);
            accent-color: #3b82f6;
        }

        @media (max-width: 768px) {
            .three-column {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Variables globales
        let state = {
            currentUser: null,
            currentTab: 'upload',
            apiKey: localStorage.getItem('anthropic_api_key') || '',
            questions: JSON.parse(localStorage.getItem('questions') || '[]'),
            topics: JSON.parse(localStorage.getItem('topics') || '[]'),
            selectedImages: [],
            transcribedText: '',
            cleanedText: '',
            selectedTopicForNewQuestions: null,
            selectedTopicFilter: 'all',
            currentTest: null,
            testResults: JSON.parse(localStorage.getItem('testResults') || '[]'),
            currentViewingResult: null
        };

        const users = {
            'demo': { password: 'demo123', name: 'Usuario Demo' }
        };

        // Funci√≥n principal de renderizado
        function render() {
            const app = document.getElementById('app');
            
            if (!state.currentUser) {
                app.innerHTML = `
                    <div class="container">
                        <div class="login-form">
                            <h2 style="text-align: center; margin-bottom: 30px;">Iniciar Sesi√≥n</h2>
                            <div class="form-group">
                                <label class="form-label">Usuario</label>
                                <input type="text" id="username" class="form-input" placeholder="demo">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contrase√±a</label>
                                <input type="password" id="password" class="form-input" placeholder="demo123">
                            </div>
                            <button onclick="login()" class="btn btn-primary" style="width: 100%;">
                                Iniciar Sesi√≥n
                            </button>
                            <div style="text-align: center; margin-top: 15px; color: #6b7280; font-size: 14px;">
                                Usuario: demo | Contrase√±a: demo123
                            </div>
                        </div>
                    </div>
                `;
            } else {
                app.innerHTML = `
                    <div class="container">
                        <div class="header">
                            <div class="title">${state.currentTab === 'questions' ? 'Banco de Preguntas' : (state.currentTab === 'results' ? 'Resultados del Test' : 'Sistema de Ex√°menes')}</div>
                            <div>
                                <span style="color: ${state.apiKey ? '#10b981' : '#ef4444'};">
                                    ${state.apiKey ? '‚úÖ API Configurada' : '‚ùå Sin API'}
                                </span>
                                <button onclick="configureAPI()" class="btn btn-secondary">API</button>
                                <span style="color: #f59e0b;">üë§ ${state.currentUser.name}</span>
                                <button onclick="logout()" class="btn btn-danger">Salir</button>
                            </div>
                        </div>

                        <div class="nav-tabs">
                            <button class="nav-tab ${state.currentTab === 'upload' ? 'active' : ''}" onclick="setTab('upload')">
                                üì§ Subir Test
                            </button>
                            <button class="nav-tab ${state.currentTab === 'questions' ? 'active' : ''}" onclick="setTab('questions')">
                                üìã Banco de Preguntas (${getFilteredQuestions().length})
                            </button>
                            <button class="nav-tab ${state.currentTab === 'test' ? 'active' : ''}" onclick="setTab('test')">
                                üéØ Test Aleatorio
                            </button>
                            <button class="nav-tab ${state.currentTab === 'results' ? 'active' : ''}" onclick="setTab('results')">
                                üìä Resultados (${state.testResults.length})
                            </button>
                        </div>

                        <div id="messages"></div>

                        ${renderTabContent()}
                    </div>
                `;
            }
        }

        function renderTabContent() {
            switch(state.currentTab) {
                case 'upload':
                    return renderUploadTab();
                case 'questions':
                    return renderQuestionsTab();
                case 'test':
                    return renderTestTab();
                case 'results':
                    return renderResultsTab();
                default:
                    return '<div>Error: Pesta√±a no encontrada</div>';
            }
        }

        function renderUploadTab() {
            return `
                <div class="three-column">
                    <div class="column">
                        <h3 style="margin-bottom: 15px;">üì§ Subir Im√°genes</h3>
                        <div class="upload-area" onclick="document.getElementById('imageInput').click()">
                            <div>üìÅ Seleccionar im√°genes</div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Hasta 10 im√°genes</div>
                            <div style="margin-top: 10px; color: #4f46e5; font-weight: 500;">
                                ${state.selectedImages.length}/10 archivos
                            </div>
                        </div>
                        <input type="file" id="imageInput" style="display: none;" accept="image/*" multiple>
                        
                        ${state.selectedImages.length > 0 ? `
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                                ${state.selectedImages.map((file, i) => `
                                    <div style="position: relative; text-align: center; padding: 10px; background: #f3f4f6; border-radius: 8px;">
                                        <button onclick="removeImage(${i})" style="position: absolute; top: 5px; right: 5px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer;">√ó</button>
                                        <div style="font-size: 10px; word-break: break-all;">${file.name}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <button onclick="transcribeImages()" class="btn btn-primary" style="width: 100%;" ${state.selectedImages.length === 0 || !state.apiKey ? 'disabled' : ''}>
                            ü§ñ 1. Transcribir y Procesar
                        </button>
                        
                        ${state.transcribedText && !state.cleanedText ? `
                            <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; text-align: center;">
                                <span style="color: #92400e;">üîÑ Procesando texto autom√°ticamente...</span>
                            </div>
                        ` : ''}
                    </div>

                    <div class="column">
                        <h3 style="margin-bottom: 15px;">üìù Texto Transcrito</h3>
                        <textarea id="cleanedText" class="textarea" placeholder="El texto procesado aparecer√° aqu√≠..." readonly>${state.cleanedText}</textarea>
                        
                        <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px;">
                            <h4 style="color: #92400e; margin-bottom: 10px;">üè∑Ô∏è Gesti√≥n de Temas</h4>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <button onclick="createTopic()" class="btn btn-info" style="width: 100%; padding: 8px; font-size: 13px;">
                                    üÜï Crear Tema
                                </button>
                                
                                <div style="position: relative;">
                                    <select id="topic-selector" onchange="updateSelectedTopic()" style="width: 100%; padding: 8px; border: none; background: #f59e0b; color: white; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer;" ${state.topics.length === 0 ? 'disabled' : ''}>
                                        <option value="">üè∑Ô∏è Seleccionar Tema</option>
                                        ${state.topics.map(topic => `
                                            <option value="${topic.id}" ${state.selectedTopicForNewQuestions === topic.id ? 'selected' : ''}>
                                                ${topic.name} (${getTopicQuestionCount(topic.id)})
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            ${state.topics.length === 0 ? `
                                <div style="font-size: 12px; color: #78350f; font-style: italic; text-align: center;">
                                    Crea un tema para organizar tus preguntas
                                </div>
                            ` : ''}
                        </div>
                        
                        <button onclick="addToQuestions()" class="btn btn-success" style="width: 100%; margin-top: 10px;" ${!state.cleanedText ? 'disabled' : ''}>
                            ${getAddButtonText()}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderQuestionsTab() {
            const filteredQuestions = getFilteredQuestions();
            
            function getQuestionsTitle() {
                if (state.selectedTopicFilter === 'all') {
                    return 'TODAS LAS PREGUNTAS DEL BANCO';
                } else {
                    const topic = state.topics.find(t => t.id == state.selectedTopicFilter);
                    if (topic) {
                        return `PREGUNTAS ${topic.name.toUpperCase()}`;
                    } else {
                        return 'PREGUNTAS DEL TEMA SELECCIONADO';
                    }
                }
            }
            
            return `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>${getQuestionsTitle()} (${filteredQuestions.length})</h2>
                    <button onclick="clearQuestions()" class="btn btn-danger">Limpiar Todo</button>
                </div>

                ${state.topics.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <label style="margin-right: 10px; font-weight: 500;">Filtrar por tema:</label>
                        <select onchange="filterByTopic(this.value)" style="padding: 8px; border-radius: 6px; border: 1px solid #d1d5db;">
                            <option value="all" ${state.selectedTopicFilter === 'all' ? 'selected' : ''}>Todos los temas (${state.questions.length})</option>
                            ${state.topics.map(topic => `
                                <option value="${topic.id}" ${state.selectedTopicFilter == topic.id ? 'selected' : ''}>
                                    ${topic.name} (${getTopicQuestionCount(topic.id)})
                                </option>
                            `).join('')}
                        </select>
                    </div>
                ` : ''}

                ${state.topics.length > 0 && state.selectedTopicFilter === 'all' ? 
                    renderQuestionsByTopic() : 
                    renderQuestionsFiltered(filteredQuestions)
                }
            `;
        }

        function renderQuestionsByTopic() {
            const questionsWithoutTopic = state.questions.filter(q => !q.topicId);
            
            let html = '';
            
            // Mostrar preguntas por cada tema que TENGA preguntas
            state.topics.forEach(topic => {
                const topicQuestions = state.questions.filter(q => q.topicId && q.topicId.toString() === topic.id.toString());
                if (topicQuestions.length > 0) {
                    html += `
                        <div style="margin-bottom: 30px;">
                            <h3 style="background: #4f46e5; color: white; padding: 10px 15px; border-radius: 8px 8px 0 0; margin: 0; display: flex; justify-content: space-between; align-items: center;">
                                <span>üìÅ ${topic.name}</span>
                                <span style="font-size: 14px; opacity: 0.9;">${topicQuestions.length} preguntas</span>
                            </h3>
                            <div style="border: 1px solid #4f46e5; border-top: none; border-radius: 0 0 8px 8px; background: white;">
                                ${topicQuestions.map(q => {
                                    const actualIndex = state.questions.findIndex(question => question.id === q.id);
                                    return renderSingleQuestion(q, actualIndex);
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
            });
            
            // Mostrar preguntas sin tema asignado SI existen
            if (questionsWithoutTopic.length > 0) {
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="background: #6b7280; color: white; padding: 10px 15px; border-radius: 8px 8px 0 0; margin: 0; display: flex; justify-content: space-between; align-items: center;">
                            <span>üìÇ Sin tema asignado</span>
                            <span style="font-size: 14px; opacity: 0.9;">${questionsWithoutTopic.length} preguntas</span>
                        </h3>
                        <div style="border: 1px solid #6b7280; border-top: none; border-radius: 0 0 8px 8px; background: white;">
                            ${questionsWithoutTopic.map(q => {
                                const actualIndex = state.questions.findIndex(question => question.id === q.id);
                                return renderSingleQuestion(q, actualIndex);
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Si no hay preguntas en absoluto
            if (html === '') {
                return '<div style="padding: 40px; text-align: center; color: #9ca3af;">No hay preguntas disponibles en el banco</div>';
            }
            
            return html;
        }

        function renderQuestionsFiltered(filteredQuestions) {
            return `
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; background: white;">
                    ${filteredQuestions.length === 0 ? 
                        '<div style="padding: 40px; text-align: center; color: #9ca3af;">No hay preguntas disponibles</div>' :
                        filteredQuestions.map(q => {
                            const actualIndex = state.questions.findIndex(question => question.id === q.id);
                            return renderSingleQuestion(q, actualIndex);
                        }).join('')
                    }
                </div>
            `;
        }

        function renderSingleQuestion(q, actualIndex) {
            const topicName = q.topicId ? getTopicName(q.topicId) : null;
            
            return `
                <div style="padding: 15px; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between;">
                    <div style="flex: 1; display: flex; gap: 8px;">
                        ${q.isVerified ? '<span style="color: #3b82f6; font-size: 16px; filter: drop-shadow(0 0 2px rgba(59, 130, 246, 0.5)); flex-shrink: 0; margin-top: 2px;" title="Pregunta verificada">‚≠ê</span>' : '<span style="width: 16px; flex-shrink: 0;"></span>'}
                        <div style="flex: 1;">
                            <div style="font-weight: 500; margin-bottom: 8px;">
                                ${q.question}
                                ${topicName && state.selectedTopicFilter === 'all' && state.selectedTopicFilter !== q.topicId ? `<span style="background: #e0e7ff; color: #4f46e5; padding: 2px 6px; border-radius: 8px; font-size: 11px; margin-left: 8px;">${topicName}</span>` : ''}
                            </div>
                            <ul style="list-style: none; margin: 0; padding: 0;">
                                ${q.options.map((opt, optIndex) => `
                                    <li style="padding: 2px 0; color: ${q.correctAnswer === optIndex ? '#059669' : '#6b7280'}; ${q.correctAnswer === optIndex ? 'font-weight: 500;' : ''}">
                                        ${String.fromCharCode(97 + optIndex)}) ${opt}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                    <div style="display: flex; gap: 5px; align-items: flex-start;">
                        <button onclick="toggleVerified(${actualIndex})" class="btn ${q.isVerified ? 'btn-primary' : 'btn-secondary'}" style="padding: 4px 8px; font-size: 14px; ${q.isVerified ? 'background: linear-gradient(135deg, #3b82f6, #1d4ed8);' : ''}" title="${q.isVerified ? 'Pregunta verificada - Click para desmarcar' : 'Marcar como verificada'}">
                            ${q.isVerified ? '‚≠ê' : '‚òÜ'}
                        </button>
                        <button onclick="editQuestion(${actualIndex})" class="btn btn-warning" style="padding: 5px 10px; font-size: 12px;">Editar</button>
                        <button onclick="deleteQuestion(${actualIndex})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">Eliminar</button>
                    </div>
                </div>
            `;
        }

        function renderTestTab() {
            if (state.questions.length === 0) {
                return '<div style="text-align: center; padding: 40px;">A√±ade preguntas al banco para generar tests</div>';
            }

            if (!state.currentTest) {
                return `
                    <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="color: #0c4a6e; margin-bottom: 15px;">üéØ Configuraci√≥n del Test</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">N√∫mero de preguntas:</label>
                                <select id="test-questions-count" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <option value="5">5 preguntas</option>
                                    <option value="10" selected>10 preguntas</option>
                                    <option value="15">15 preguntas</option>
                                    <option value="20">20 preguntas</option>
                                    <option value="all">Todas las preguntas disponibles</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Duraci√≥n:</label>
                                <select id="test-duration" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <option value="300">5 minutos</option>
                                    <option value="600" selected>10 minutos</option>
                                    <option value="900">15 minutos</option>
                                    <option value="1200">20 minutos</option>
                                    <option value="1800">30 minutos</option>
                                    <option value="0">Sin l√≠mite de tiempo</option>
                                </select>
                            </div>
                        </div>

                        ${state.topics.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 15px; font-weight: 500;">Selecci√≥n de temas:</label>
                                <div style="display: grid; gap: 8px;">
                                    <div class="custom-checkbox" onclick="toggleGeneralTest()">
                                        <input type="checkbox" id="test-general" onchange="handleGeneralTestChange(this)" checked>
                                        <span style="font-weight: 500;">Test General (${state.questions.length} preguntas)</span>
                                    </div>
                                    ${state.topics.map(topic => `
                                        <div class="custom-checkbox" onclick="toggleTopicTest('${topic.id}')">
                                            <input type="checkbox" class="topic-checkbox" data-topic-id="${topic.id}" onchange="handleTopicChange()">
                                            <span>${topic.name} (${getTopicQuestionCount(topic.id)} preguntas)</span>
                                        </div>
                                    `).join('')}
                                </div>
                                <div style="margin-top: 15px; padding: 10px; background: #f3f4f6; border-radius: 6px; font-size: 14px; color: #6b7280;">
                                    üí° <strong>Consejo:</strong> Puedes seleccionar m√∫ltiples temas para crear un test combinado, o elegir "Test General" para incluir todas las preguntas.
                                </div>
                            </div>
                        ` : ''}

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Nombre del test:</label>
                            <input type="text" id="test-name" placeholder="Ej: Test de Matem√°ticas - Sesi√≥n 1" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                            <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                                Si no especificas un nombre, se generar√° autom√°ticamente
                            </div>
                        </div>
                    </div>

                    <div style="text-align: center; padding: 40px;">
                        <button onclick="startTest()" class="btn btn-primary" style="font-size: 1.2rem; padding: 15px 30px;">
                            üéØ Comenzar Test
                        </button>
                    </div>
                `;
            }

            return renderCurrentTest();
        }

        function renderCurrentTest() {
            const duration = state.currentTest.duration;
            const hasTimer = duration > 0;
            
            return `
                <div style="max-width: 1000px; margin: 0 auto; position: relative;">
                    ${hasTimer ? `
                        <div id="timer" style="position: fixed; top: 20px; right: 20px; background: white; padding: 15px 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: bold; color: #ef4444; font-size: 1.2rem; z-index: 1000; border: 2px solid #fecaca;">
                            ‚è±Ô∏è ${formatTime(state.currentTest.timeLeft)}
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 20px; background: #f8fafc; border-radius: 12px;">
                        <div>
                            <h2 style="margin: 0; color: #1f2937;">${state.currentTest.name}</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280; font-size: 14px;">${state.currentTest.questions.length} preguntas</p>
                            <p style="margin: 5px 0 0 0; color: #6b7280; font-size: 14px;">${state.currentTest.testTypeText}</p>
                        </div>
                        ${hasTimer ? `<div style="color: #6b7280; font-size: 14px;">El tiempo se muestra arriba a la derecha</div>` : ''}
                    </div>
                    
                    <form id="test-form">
                        ${state.currentTest.questions.map((question, questionIndex) => `
                            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; color: #1f2937; flex-wrap: nowrap;">
                                    <span style="color: #4f46e5; flex-shrink: 0;">#${questionIndex + 1}</span>
                                    <span style="flex: 1; min-width: 0;">${question.question}</span>
                                    ${question.isVerified ? '<span style="color: #3b82f6; font-size: 16px; filter: drop-shadow(0 0 2px rgba(59, 130, 246, 0.5)); flex-shrink: 0;" title="Pregunta verificada">‚≠ê</span>' : ''}
                                    ${question.topicId && state.currentTest.testType !== question.topicId.toString() ? `<span style="background: #f3f4f6; color: #6b7280; padding: 2px 6px; border-radius: 6px; font-size: 11px; font-weight: 400; flex-shrink: 0; white-space: nowrap;" title="Tema de la pregunta">${getTopicName(question.topicId)}</span>` : ''}
                                </div>
                                
                                <div style="display: grid; gap: 12px;">
                                    ${question.options.map((option, optionIndex) => `
                                        <label style="display: flex; align-items: center; gap: 12px; padding: 15px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 15px;" 
                                               onmouseover="this.style.backgroundColor='#f3f4f6'; this.style.borderColor='#d1d5db';" 
                                               onmouseout="this.style.backgroundColor='#f9fafb'; this.style.borderColor='#e5e7eb';">
                                            <input type="radio" name="question-${questionIndex}" value="${optionIndex}" style="transform: scale(1.2);">
                                            <span><strong>${String.fromCharCode(97 + optionIndex)})</strong> ${option}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </form>
                    
                    <div style="text-align: center; padding: 30px;">
                        <button onclick="finishTest()" class="btn btn-primary" style="font-size: 1.2rem; padding: 15px 40px;">
                            üèÅ Finalizar Test
                        </button>
                    </div>
                </div>
            `;
        }

        function renderResultsTab() {
            if (state.currentViewingResult) {
                // Mostrar resultado espec√≠fico
                return renderSpecificResult(state.currentViewingResult);
            }

            // Mostrar lista de resultados
            if (state.testResults.length === 0) {
                return `
                    <div style="text-align: center; padding: 60px; color: #9ca3af;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">üìä</div>
                        <h3 style="color: #6b7280; margin-bottom: 10px;">No hay resultados disponibles</h3>
                        <p style="color: #9ca3af;">Realiza tu primer test para ver los resultados aqu√≠</p>
                    </div>
                `;
            }

            return `
                <div style="max-width: 1000px; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="color: #1f2937; margin: 0;">üìä Historial de Tests (${state.testResults.length})</h2>
                        <button onclick="clearTestHistory()" class="btn btn-danger">
                            üóëÔ∏è Limpiar Historial
                        </button>
                    </div>

                    <div style="display: grid; gap: 20px;">
                        ${state.testResults.map((result, index) => {
                            const percentage = Math.round((result.correct / result.total) * 100);
                            let scoreColor = '#ef4444';
                            let scoreIcon = 'üìâ';
                            
                            if (percentage >= 90) {
                                scoreColor = '#059669';
                                scoreIcon = 'üåü';
                            } else if (percentage >= 70) {
                                scoreColor = '#0ea5e9';
                                scoreIcon = 'üëç';
                            } else if (percentage >= 50) {
                                scoreColor = '#f59e0b';
                                scoreIcon = '‚ö°';
                            }

                            return `
                                <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative;" 
                                     onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" 
                                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
                                    
                                    <!-- Bot√≥n eliminar individual -->
                                    <button onclick="event.stopPropagation(); deleteIndividualTest(${index})" 
                                            style="position: absolute; top: 10px; right: 10px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.7; transition: opacity 0.2s;" 
                                            onmouseover="this.style.opacity='1'" 
                                            onmouseout="this.style.opacity='0.7'" 
                                            title="Eliminar este test">√ó</button>
                                    
                                    <div onclick="viewTestResult(${index})" style="width: 100%;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                            <h3 style="margin: 0; color: #1f2937; display: flex; align-items: center; gap: 10px; padding-right: 30px;">
                                                <span style="font-size: 1.2em;">${scoreIcon}</span>
                                                ${result.name}
                                            </h3>
                                            <div style="background: ${scoreColor}; color: white; padding: 6px 12px; border-radius: 20px; font-weight: bold; font-size: 1.1rem;">
                                                ${percentage}%
                                            </div>
                                        </div>

                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                            <div style="text-align: center;">
                                                <div style="font-size: 1.5rem; font-weight: bold; color: #059669;">${result.correct}</div>
                                                <div style="font-size: 12px; color: #6b7280;">Correctas</div>
                                            </div>
                                            <div style="text-align: center;">
                                                <div style="font-size: 1.5rem; font-weight: bold; color: #ef4444;">${result.incorrect}</div>
                                                <div style="font-size: 12px; color: #6b7280;">Incorrectas</div>
                                            </div>
                                            <div style="text-align: center;">
                                                <div style="font-size: 1.5rem; font-weight: bold; color: #f59e0b;">${result.unanswered}</div>
                                                <div style="font-size: 12px; color: #6b7280;">Sin responder</div>
                                            </div>
                                            <div style="text-align: center;">
                                                <div style="font-size: 1.5rem; font-weight: bold; color: #6b7280;">${result.total}</div>
                                                <div style="font-size: 12px; color: #6b7280;">Total</div>
                                            </div>
                                        </div>

                                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: #6b7280;">
                                            <span>${result.testType}</span>
                                            <span>${result.date}</span>
                                        </div>
                                        
                                        ${result.timeUsedText ? `
                                            <div style="font-size: 12px; color: #9ca3af; margin-top: 5px; text-align: right;">
                                                ${result.timeUsedText}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).reverse().join('')}
                    </div>
                </div>
            `;
        }

        function renderSpecificResult(result) {
            const percentage = Math.round((result.correct / result.total) * 100);
            
            // Determinar color y mensaje seg√∫n porcentaje
            let scoreColor = '#ef4444'; // Rojo por defecto
            let scoreMessage = '¬°Sigue practicando! üí™';
            let scoreIcon = 'üìâ';
            
            if (percentage >= 90) {
                scoreColor = '#059669';
                scoreMessage = '¬°Excelente trabajo! üèÜ';
                scoreIcon = 'üåü';
            } else if (percentage >= 70) {
                scoreColor = '#0ea5e9';
                scoreMessage = '¬°Buen desempe√±o! üëè';
                scoreIcon = 'üëç';
            } else if (percentage >= 50) {
                scoreColor = '#f59e0b';
                scoreMessage = '¬°Puedes mejorar! üìö';
                scoreIcon = '‚ö°';
            }

            return `
                <div style="max-width: 1000px; margin: 0 auto;">
                    <!-- Bot√≥n Volver -->
                    <div style="margin-bottom: 20px;">
                        <button onclick="state.currentViewingResult = null; render();" class="btn btn-secondary">
                            ‚Üê Volver al Historial
                        </button>
                    </div>

                    <!-- Header de Resultados -->
                    <div style="text-align: center; background: linear-gradient(135deg, ${scoreColor}15, ${scoreColor}05); border: 2px solid ${scoreColor}30; border-radius: 20px; padding: 40px; margin-bottom: 30px;">
                        <div style="font-size: 4rem; margin-bottom: 15px;">${scoreIcon}</div>
                        <h1 style="color: ${scoreColor}; font-size: 2.5rem; margin: 0 0 10px 0;">${percentage}%</h1>
                        <p style="color: ${scoreColor}; font-size: 1.3rem; font-weight: 600; margin: 0 0 15px 0;">${scoreMessage}</p>
                        <h2 style="color: #6b7280; font-size: 1.2rem; margin: 0;">${result.name}</h2>
                        <p style="color: #6b7280; font-size: 1rem; margin: 5px 0 0 0;">${result.testType}</p>
                        ${result.timeUsedText ? `<p style="color: #6b7280; font-size: 0.9rem; margin: 5px 0 0 0;">${result.timeUsedText}</p>` : ''}
                        <p style="color: #9ca3af; font-size: 0.85rem; margin: 10px 0 0 0;">${result.date}</p>
                    </div>

                    <!-- M√©tricas Generales -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="font-size: 2rem; color: #0ea5e9; margin-bottom: 10px;">‚úÖ</div>
                            <div style="font-size: 1.8rem; font-weight: bold; color: #0c4a6e; margin-bottom: 5px;">${result.correct}</div>
                            <div style="color: #0369a1; font-weight: 500;">Correctas</div>
                        </div>

                        <div style="background: #fef2f2; border: 2px solid #ef4444; border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="font-size: 2rem; color: #ef4444; margin-bottom: 10px;">‚ùå</div>
                            <div style="font-size: 1.8rem; font-weight: bold; color: #991b1b; margin-bottom: 5px;">${result.incorrect}</div>
                            <div style="color: #dc2626; font-weight: 500;">Incorrectas</div>
                        </div>

                        <div style="background: #fffbeb; border: 2px solid #f59e0b; border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="font-size: 2rem; color: #f59e0b; margin-bottom: 10px;">‚è≠Ô∏è</div>
                            <div style="font-size: 1.8rem; font-weight: bold; color: #92400e; margin-bottom: 5px;">${result.unanswered}</div>
                            <div style="color: #d97706; font-weight: 500;">Sin responder</div>
                        </div>

                        <div style="background: #f0fdf4; border: 2px solid #22c55e; border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="font-size: 2rem; color: #22c55e; margin-bottom: 10px;">üìä</div>
                            <div style="font-size: 1.8rem; font-weight: bold; color: #166534; margin-bottom: 5px;">${result.total}</div>
                            <div style="color: #16a34a; font-weight: 500;">Total</div>
                        </div>
                    </div>

                    <!-- Barra de Progreso Visual -->
                    <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px; margin-bottom: 30px;">
                        <h3 style="margin: 0 0 20px 0; color: #374151;">üìà Distribuci√≥n de Respuestas</h3>
                        <div style="background: #f3f4f6; border-radius: 10px; overflow: hidden; height: 30px; display: flex; margin-bottom: 15px;">
                            <div style="background: #22c55e; width: ${(result.correct/result.total)*100}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
                                ${result.correct > 0 ? `${result.correct}‚úì` : ''}
                            </div>
                            <div style="background: #ef4444; width: ${(result.incorrect/result.total)*100}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
                                ${result.incorrect > 0 ? `${result.incorrect}‚úó` : ''}
                            </div>
                            <div style="background: #f59e0b; width: ${(result.unanswered/result.total)*100}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
                                ${result.unanswered > 0 ? `${result.unanswered}?` : ''}
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 14px; color: #6b7280;">
                            <span>0%</span>
                            <span>50%</span>
                            <span>100%</span>
                        </div>
                    </div>

                    <!-- Revisi√≥n Detallada -->
                    <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px; margin-bottom: 30px;">
                        <h3 style="margin: 0 0 20px 0; color: #374151;">üîç Revisi√≥n Detallada</h3>
                        ${result.detailedResults.map((resultItem, index) => `
                            <div style="border: 2px solid ${resultItem.isCorrect ? '#22c55e' : (resultItem.userAnswer !== null ? '#ef4444' : '#f59e0b')}; border-radius: 8px; margin-bottom: 15px; overflow: hidden;">
                                <div style="background: ${resultItem.isCorrect ? '#22c55e' : (resultItem.userAnswer !== null ? '#ef4444' : '#f59e0b')}; color: white; padding: 12px 15px; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 1.1em;">
                                        ${resultItem.isCorrect ? '‚úÖ' : (resultItem.userAnswer !== null ? '‚ùå' : '‚è≠Ô∏è')}
                                    </span>
                                    <span>Pregunta ${index + 1}</span>
                                    ${resultItem.question.isVerified ? '<span style="filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.8));" title="Pregunta verificada">‚≠ê</span>' : ''}
                                </div>
                                <div style="padding: 15px;">
                                    <p style="font-weight: 500; margin: 0 0 15px 0; color: #374151;">${resultItem.question.question}</p>
                                    <div style="display: grid; gap: 8px;">
                                        ${resultItem.question.options.map((option, optIndex) => {
                                            let bgColor = '#f9fafb';
                                            let textColor = '#374151';
                                            let border = '#e5e7eb';
                                            let prefix = '';
                                            
                                            if (optIndex === resultItem.question.correctAnswer) {
                                                bgColor = '#dcfce7';
                                                textColor = '#166534';
                                                border = '#22c55e';
                                                prefix = '‚úì ';
                                            }
                                            
                                            if (resultItem.userAnswer === optIndex && optIndex !== resultItem.question.correctAnswer) {
                                                bgColor = '#fee2e2';
                                                textColor = '#991b1b';
                                                border = '#ef4444';
                                                prefix = '‚úó ';
                                            }
                                            
                                            return `
                                                <div style="background: ${bgColor}; border: 1px solid ${border}; border-radius: 6px; padding: 10px; color: ${textColor};">
                                                    <strong>${String.fromCharCode(97 + optIndex)})</strong> ${prefix}${option}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                    ${resultItem.userAnswer === null ? `
                                        <div style="background: #fffbeb; border: 1px solid #f59e0b; border-radius: 6px; padding: 10px; margin-top: 10px; color: #92400e; text-align: center; font-style: italic;">
                                            No respondida
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Acciones -->
                    <div style="text-align: center; padding: 20px;">
                        <button onclick="startNewTest()" class="btn btn-primary" style="font-size: 1.1rem; padding: 15px 30px; margin: 0 10px;">
                            üéØ Nuevo Test
                        </button>
                        <button onclick="state.currentViewingResult = null; render();" class="btn btn-secondary" style="font-size: 1.1rem; padding: 15px 30px; margin: 0 10px;">
                            üìä Ver Historial
                        </button>
                    </div>
                </div>
            `;
        }

        // Event handlers
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (users[username] && users[username].password === password) {
                state.currentUser = users[username];
                render();
                showMessage(`Bienvenido ${users[username].name}`, 'success');
            } else {
                showMessage('Usuario o contrase√±a incorrectos', 'error');
            }
        }

        function logout() {
            state.currentUser = null;
            state.currentTab = 'upload';
            render();
        }

        function configureAPI() {
            const key = prompt('Ingresa tu API key de Anthropic:');
            if (key && key.trim()) {
                state.apiKey = key.trim();
                localStorage.setItem('anthropic_api_key', key.trim());
                render();
                showMessage('API key configurada correctamente', 'success');
            }
        }

        function setTab(tab) {
            state.currentTab = tab;
            state.currentViewingResult = null;
            render();
        }

        function createTopic() {
            const name = prompt('Nombre del nuevo tema:');
            if (name && name.trim()) {
                const newTopic = {
                    id: Date.now() + Math.random(),
                    name: name.trim(),
                    createdAt: new Date().toISOString()
                };
                
                state.topics.push(newTopic);
                localStorage.setItem('topics', JSON.stringify(state.topics));
                render();
                showMessage(`Tema "${name}" creado exitosamente`, 'success');
            }
        }

        function updateSelectedTopic() {
            const selector = document.getElementById('topic-selector');
            if (selector && selector.value) {
                // Convertir el valor del selector al tipo correcto
                const selectedValue = selector.value;
                // Buscar el tema para obtener el ID en su formato original
                const selectedTopic = state.topics.find(t => t.id == selectedValue);
                if (selectedTopic) {
                    state.selectedTopicForNewQuestions = selectedTopic.id;
                    showMessage(`Tema "${selectedTopic.name}" seleccionado`, 'success');
                } else {
                    state.selectedTopicForNewQuestions = selectedValue;
                }
            } else {
                state.selectedTopicForNewQuestions = null;
            }
            render();
        }

        function getAddButtonText() {
            if (!state.selectedTopicForNewQuestions) {
                return '‚úÖ 2. A√±adir al Banco';
            } else {
                const topicName = getTopicName(state.selectedTopicForNewQuestions);
                return `‚úÖ 2. Asignar a "${topicName}"`;
            }
        }

        function removeImage(index) {
            state.selectedImages.splice(index, 1);
            render();
            showMessage('Imagen eliminada', 'success');
        }

        async function transcribeImages() {
            if (!state.apiKey) {
                showMessage('Configura tu API key primero', 'error');
                return;
            }

            if (state.selectedImages.length === 0) {
                showMessage('Selecciona al menos una imagen', 'error');
                return;
            }

            showMessage('Transcribiendo im√°genes...', 'success');
            
            try {
                let allTranscriptions = [];
                
                const batchSize = 5;
                for (let i = 0; i < state.selectedImages.length; i += batchSize) {
                    const batch = state.selectedImages.slice(i, i + batchSize);
                    
                    const imageContents = await Promise.all(
                        batch.map(async (file) => {
                            const base64 = await fileToBase64(file);
                            return {
                                type: "image",
                                source: {
                                    type: "base64",
                                    media_type: file.type,
                                    data: base64
                                }
                            };
                        })
                    );

                    const messageContent = [
                        ...imageContents,
                        {
                            type: "text",
                            text: `Act√∫a como un transcriptor de texto para una persona ciega. Analiza ${batch.length > 1 ? 'estas im√°genes' : 'esta imagen'} y extrae todo el texto visible de manera secuencial.

INSTRUCCIONES CR√çTICAS:
- Solo dicta las palabras que ves, como si estuvieras hablando en voz alta
- Encuentra las preguntas numeradas y sus opciones de respuesta
- CONSERVA y DESCRIBE todos los s√≠mbolos visuales de respuesta correcta que veas
- MANT√âN s√≠mbolos como: ‚úì, ‚úî, checkmarks, asteriscos, vi√±etas, flechas
- DESCRIBE elementos visuales importantes: "opci√≥n marcada en verde", "con tick", "con check", "respuesta correcta", "marcada"
- PRESERVA cualquier indicaci√≥n visual de que una opci√≥n es la correcta
- Si hay m√∫ltiples im√°genes, procesa cada una en orden
- Separa claramente el contenido de cada imagen

IMPORTANTE: NO elimines s√≠mbolos de respuesta correcta - los necesitamos para el siguiente paso.

Responde con el texto extra√≠do conservando TODOS los s√≠mbolos y marcas visuales.`
                        }
                    ];

                    const response = await fetch("/api/anthropic", {
    method: "POST",
    headers: {
        "Content-Type": "application/json",
        "x-api-key": state.apiKey,
    },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 4000,
                            messages: [{
                                role: "user",
                                content: messageContent
                            }]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Error ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    allTranscriptions.push(data.content[0].text);
                }

                state.transcribedText = allTranscriptions.join('\n\n--- SIGUIENTE IMAGEN ---\n\n');
                
                render();
                showMessage(`Transcripci√≥n completada. Procesando texto...`, 'success');
                
                // Autom√°ticamente limpiar el texto despu√©s de transcribir
                await cleanText();
                
            } catch (error) {
                showMessage(`Error en la transcripci√≥n: ${error.message}`, 'error');
            }
        }

        async function cleanText() {
            if (!state.transcribedText) {
                showMessage('Primero transcribe las im√°genes', 'error');
                return;
            }

            if (!state.apiKey) {
                showMessage('Configura tu API key primero', 'error');
                return;
            }

            render(); // Mostrar el indicador de procesamiento
            
            try {
                const response = await fetch("/api/anthropic", {
    method: "POST",
    headers: {
        "Content-Type": "application/json",
        "x-api-key": state.apiKey,
    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 4000,
                        messages: [{
                            role: "user",
                            content: `Limpia este texto extra√≠do de m√∫ltiples im√°genes y convi√©rtelo en formato de preguntas para banco de preguntas:

TEXTO A LIMPIAR:
${state.transcribedText}

INSTRUCCIONES CR√çTICAS PARA DETECTAR RESPUESTAS CORRECTAS:
- Busca s√≠mbolos visuales: ‚úì, ‚úî, *, ‚Ä¢, ‚Üí, >, checkmarks, ticks
- Busca descripciones: "marcada", "marcada en verde", "respuesta correcta", "con tick", "con check"
- Busca colores mencionados: "verde", "resaltada", "seleccionada"
- MARCA EN NEGRITA las opciones que tengan cualquiera de estos indicadores usando **texto**
- Elimina los s√≠mbolos y descripciones visuales DESPU√âS de identificar las correctas
- Extrae solo las preguntas y opciones de respuesta
- Numera las preguntas secuencialmente

FORMATO DE SALIDA ESTRICTO:
PREGUNTA: [texto de la pregunta]
OPCION_A: [opci√≥n a normal]
OPCION_B: **[opci√≥n b si tiene s√≠mbolo/marca de correcta]**
OPCION_C: [opci√≥n c normal]
OPCION_D: **[opci√≥n d si tiene s√≠mbolo/marca de correcta]**

IMPORTANTE: Cualquier opci√≥n con s√≠mbolo, marca visual, color verde, o descripci√≥n de "correcta" debe ir en **negritas**.`
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                state.cleanedText = data.content[0].text;
                
                render();
                showMessage('¬°Texto procesado y listo para a√±adir al banco!', 'success');
                
            } catch (error) {
                showMessage(`Error en la limpieza: ${error.message}`, 'error');
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        function addToQuestions() {
            if (!state.cleanedText) {
                showMessage('Primero procesa el texto', 'error');
                return;
            }

            try {
                const newQuestions = parseCleanedText(state.cleanedText);
                if (newQuestions.length === 0) {
                    showMessage('No se pudieron extraer preguntas del texto limpio', 'error');
                    return;
                }

                if (state.selectedTopicForNewQuestions) {
                    newQuestions.forEach(question => {
                        question.topicId = state.selectedTopicForNewQuestions;
                    });
                    const topicName = getTopicName(state.selectedTopicForNewQuestions);
                    showMessage(`¬°Se a√±adieron ${newQuestions.length} preguntas al tema "${topicName}"!`, 'success');
                } else {
                    showMessage(`¬°Se a√±adieron ${newQuestions.length} preguntas al banco!`, 'success');
                }

                state.questions.push(...newQuestions);
                localStorage.setItem('questions', JSON.stringify(state.questions));
                
                state.selectedImages = [];
                state.transcribedText = '';
                state.cleanedText = '';
                state.selectedTopicForNewQuestions = null;
                
                render();
                
            } catch (error) {
                showMessage(`Error al procesar preguntas: ${error.message}`, 'error');
            }
        }

        function parseCleanedText(text) {
            const questions = [];
            const sections = text.split(/PREGUNTA:/i).filter(section => section.trim());
            
            sections.forEach(section => {
                const lines = section.trim().split('\n').filter(line => line.trim());
                if (lines.length === 0) return;
                
                const questionText = lines[0].trim();
                const options = [];
                let correctAnswer = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line.match(/^OPCION_[A-D]:/i)) {
                        let optionText = line.replace(/^OPCION_[A-D]:/i, '').trim();
                        
                        if (optionText.startsWith('**') && optionText.endsWith('**')) {
                            optionText = optionText.slice(2, -2);
                            correctAnswer = options.length;
                        }
                        
                        if (optionText) {
                            options.push(optionText);
                        }
                    }
                }
                
                if (questionText && options.length >= 2) {
                    questions.push({
                        id: Date.now() + Math.random(),
                        question: questionText,
                        options: options,
                        correctAnswer: correctAnswer,
                        topicId: null
                    });
                }
            });
            
            return questions;
        }

        function toggleVerified(index) {
            if (state.questions[index]) {
                state.questions[index].isVerified = !state.questions[index].isVerified;
                localStorage.setItem('questions', JSON.stringify(state.questions));
                render();
                showMessage(`Pregunta ${state.questions[index].isVerified ? 'verificada' : 'sin verificar'}`, 'success');
            }
        }

        function clearQuestions() {
            if (confirm('¬øEliminar todas las preguntas?')) {
                state.questions = [];
                localStorage.setItem('questions', JSON.stringify(state.questions));
                render();
            }
        }

        function deleteQuestion(index) {
            if (confirm('¬øEliminar esta pregunta?')) {
                state.questions.splice(index, 1);
                localStorage.setItem('questions', JSON.stringify(state.questions));
                render();
                showMessage('Pregunta eliminada', 'success');
            }
        }

        function editQuestion(index) {
            const question = state.questions[index];
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); display: flex; justify-content: center;
                align-items: center; z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 20px;">Editar Pregunta</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Pregunta:</label>
                        <textarea id="edit-question" style="width: 100%; height: 60px; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">${question.question}</textarea>
                    </div>
                    
                    ${state.topics.length > 0 ? `
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Tema:</label>
                            <select id="edit-topic" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="">Sin tema</option>
                                ${state.topics.map(topic => `
                                    <option value="${topic.id}" ${question.topicId === topic.id ? 'selected' : ''}>
                                        ${topic.name}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 500;">Opciones:</label>
                        ${question.options.map((option, i) => `
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <input type="radio" name="correct" value="${i}" ${question.correctAnswer === i ? 'checked' : ''}>
                                <span style="font-weight: 500; min-width: 20px;">${String.fromCharCode(97 + i)})</span>
                                <input type="text" id="edit-option-${i}" value="${option}" style="flex: 1; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" style="padding: 10px 20px; border: none; background: #6b7280; color: white; border-radius: 6px; cursor: pointer;">
                            Cancelar
                        </button>
                        <button onclick="saveEdit(${index})" style="padding: 10px 20px; border: none; background: #4f46e5; color: white; border-radius: 6px; cursor: pointer;">
                            Guardar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            window.saveEdit = function(qIndex) {
                try {
                    const newQuestion = document.getElementById('edit-question').value.trim();
                    const newOptions = [];
                    
                    for (let i = 0; i < question.options.length; i++) {
                        const optInput = document.getElementById(`edit-option-${i}`);
                        if (optInput && optInput.value.trim()) {
                            newOptions.push(optInput.value.trim());
                        }
                    }
                    
                    const correctRadio = modal.querySelector('input[name="correct"]:checked');
                    const newCorrect = correctRadio ? parseInt(correctRadio.value) : 0;
                    
                    let newTopicId = null;
                    const topicSelect = modal.querySelector('#edit-topic');
                    if (topicSelect && topicSelect.value) {
                        newTopicId = topicSelect.value;
                    }
                    
                    if (!newQuestion || newOptions.length < 2) {
                        alert('Completa todos los campos requeridos');
                        return;
                    }
                    
                    state.questions[qIndex] = {
                        ...state.questions[qIndex],
                        question: newQuestion,
                        options: newOptions,
                        correctAnswer: newCorrect,
                        topicId: newTopicId
                    };
                    
                    localStorage.setItem('questions', JSON.stringify(state.questions));
                    modal.remove();
                    render();
                    showMessage('Pregunta actualizada', 'success');
                    
                } catch (error) {
                    showMessage('Error al guardar: ' + error.message, 'error');
                }
            };
        }

        function filterByTopic(topicId) {
            state.selectedTopicFilter = topicId;
            render(); // Importante: re-renderizar para actualizar el t√≠tulo
        }

        function getFilteredQuestions() {
            if (state.selectedTopicFilter === 'all') {
                return state.questions;
            }
            return state.questions.filter(q => q.topicId && q.topicId.toString() === state.selectedTopicFilter.toString());
        }

        function getTopicName(topicId) {
            if (!topicId) return 'Sin tema';
            const topic = state.topics.find(t => t.id.toString() === topicId.toString());
            return topic ? topic.name : 'Tema no encontrado';
        }

        function getTopicQuestionCount(topicId) {
            return state.questions.filter(q => q.topicId && q.topicId.toString() === topicId.toString()).length;
        }

        // Nuevas funciones para manejar la selecci√≥n m√∫ltiple de temas
        function toggleGeneralTest() {
            const generalCheckbox = document.getElementById('test-general');
            const topicCheckboxes = document.querySelectorAll('.topic-checkbox');
            
            if (generalCheckbox.checked) {
                // Si se marca "Test General", desmarcar todos los temas
                topicCheckboxes.forEach(cb => {
                    cb.checked = false;
                    cb.closest('.custom-checkbox').classList.remove('selected');
                });
                generalCheckbox.closest('.custom-checkbox').classList.add('selected');
            } else {
                generalCheckbox.closest('.custom-checkbox').classList.remove('selected');
            }
        }

        function toggleTopicTest(topicId) {
            const topicCheckbox = document.querySelector(`.topic-checkbox[data-topic-id="${topicId}"]`);
            const generalCheckbox = document.getElementById('test-general');
            
            if (topicCheckbox.checked) {
                topicCheckbox.checked = false;
                topicCheckbox.closest('.custom-checkbox').classList.remove('selected');
            } else {
                topicCheckbox.checked = true;
                topicCheckbox.closest('.custom-checkbox').classList.add('selected');
                // Si se marca alg√∫n tema, desmarcar "Test General"
                if (generalCheckbox.checked) {
                    generalCheckbox.checked = false;
                    generalCheckbox.closest('.custom-checkbox').classList.remove('selected');
                }
            }
        }

        function handleGeneralTestChange(checkbox) {
            const topicCheckboxes = document.querySelectorAll('.topic-checkbox');
            
            if (checkbox.checked) {
                // Si se marca "Test General", desmarcar todos los temas
                topicCheckboxes.forEach(cb => {
                    cb.checked = false;
                    cb.closest('.custom-checkbox').classList.remove('selected');
                });
                checkbox.closest('.custom-checkbox').classList.add('selected');
            } else {
                checkbox.closest('.custom-checkbox').classList.remove('selected');
            }
        }

        function handleTopicChange() {
            const topicCheckboxes = document.querySelectorAll('.topic-checkbox');
            const generalCheckbox = document.getElementById('test-general');
            const anyTopicSelected = Array.from(topicCheckboxes).some(cb => cb.checked);
            
            // Actualizar estilos visuales para cada checkbox de tema
            topicCheckboxes.forEach(cb => {
                if (cb.checked) {
                    cb.closest('.custom-checkbox').classList.add('selected');
                } else {
                    cb.closest('.custom-checkbox').classList.remove('selected');
                }
            });
            
            // Si hay alg√∫n tema seleccionado, desmarcar "Test General"
            if (anyTopicSelected && generalCheckbox.checked) {
                generalCheckbox.checked = false;
                generalCheckbox.closest('.custom-checkbox').classList.remove('selected');
            }
        }

        function startTest() {
            const generalCheckbox = document.getElementById('test-general');
            const topicCheckboxes = document.querySelectorAll('.topic-checkbox');
            
            let availableQuestions = [];
            let testTypeText = '';
            let selectedTopics = [];
            
            if (generalCheckbox && generalCheckbox.checked) {
                // Test general
                availableQuestions = state.questions;
                testTypeText = 'Test General';
            } else {
                // Test de temas espec√≠ficos
                const selectedTopicIds = Array.from(topicCheckboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.getAttribute('data-topic-id'));
                
                if (selectedTopicIds.length === 0) {
                    showMessage('Selecciona al menos un tema o marca "Test General"', 'error');
                    return;
                }
                
                selectedTopics = selectedTopicIds.map(id => getTopicName(id));
                
                // Filtrar preguntas por los temas seleccionados
                availableQuestions = state.questions.filter(q => 
                    q.topicId && selectedTopicIds.includes(q.topicId.toString())
                );
                
                if (selectedTopics.length === 1) {
                    testTypeText = `Test de ${selectedTopics[0]}`;
                } else {
                    testTypeText = `Test Combinado: ${selectedTopics.join(', ')}`;
                }
            }

            if (availableQuestions.length === 0) {
                showMessage('No hay preguntas disponibles para la selecci√≥n actual', 'error');
                return;
            }

            // Obtener configuraciones
            const questionsCountSelect = document.getElementById('test-questions-count');
            const durationSelect = document.getElementById('test-duration');
            const testNameInput = document.getElementById('test-name');
            
            const questionsCount = questionsCountSelect.value === 'all' ? availableQuestions.length : parseInt(questionsCountSelect.value);
            const duration = parseInt(durationSelect.value);

            // Generar nombre del test
            let testName = testNameInput.value.trim();
            if (!testName) {
                const now = new Date();
                const dateStr = now.toLocaleDateString('es-ES');
                const timeStr = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                
                if (selectedTopics.length === 1) {
                    testName = `Test ${selectedTopics[0]} - ${dateStr} ${timeStr}`;
                } else if (selectedTopics.length > 1) {
                    testName = `Test Combinado - ${dateStr} ${timeStr}`;
                } else {
                    testName = `Test General - ${dateStr} ${timeStr}`;
                }
            }

            const finalQuestionsCount = Math.min(questionsCount, availableQuestions.length);
            const shuffled = [...availableQuestions].sort(() => Math.random() - 0.5);
            
            state.currentTest = {
                name: testName,
                questions: shuffled.slice(0, finalQuestionsCount),
                answers: {},
                duration: duration,
                timeLeft: duration,
                timer: null,
                testType: generalCheckbox && generalCheckbox.checked ? 'all' : 'multiple',
                testTypeText: testTypeText,
                selectedTopics: selectedTopics,
                startTime: Date.now()
            };
            
            // Solo iniciar timer si hay duraci√≥n
            if (duration > 0) {
                state.currentTest.timer = setInterval(() => {
                    state.currentTest.timeLeft--;
                    if (state.currentTest.timeLeft <= 0) {
                        finishTest();
                    } else {
                        const timerElement = document.getElementById('timer');
                        if (timerElement) {
                            timerElement.textContent = `‚è±Ô∏è ${formatTime(state.currentTest.timeLeft)}`;
                        }
                    }
                }, 1000);
            }
            
            render();
        }

        function finishTest() {
            if (!state.currentTest) return;
            
            // Detener timer si existe
            if (state.currentTest.timer) {
                clearInterval(state.currentTest.timer);
            }
            
            // Recoger respuestas del formulario
            const form = document.getElementById('test-form');
            let correct = 0;
            let incorrect = 0;
            let unanswered = 0;
            const answers = {};
            const detailedResults = [];
            
            state.currentTest.questions.forEach((question, index) => {
                const selectedOption = form.querySelector(`input[name="question-${index}"]:checked`);
                let userAnswer = null;
                let isCorrect = false;
                
                if (selectedOption) {
                    userAnswer = parseInt(selectedOption.value);
                    answers[index] = userAnswer;
                    if (userAnswer === question.correctAnswer) {
                        correct++;
                        isCorrect = true;
                    } else {
                        incorrect++;
                    }
                } else {
                    unanswered++;
                }
                
                detailedResults.push({
                    question: question,
                    userAnswer: userAnswer,
                    isCorrect: isCorrect
                });
            });
            
            const totalQuestions = state.currentTest.questions.length;
            
            // Calcular tiempo usado
            let timeUsedText = '';
            if (state.currentTest.duration > 0) {
                const timeUsed = state.currentTest.duration - state.currentTest.timeLeft;
                timeUsedText = `Tiempo empleado: ${formatTime(timeUsed)} de ${formatTime(state.currentTest.duration)}`;
            }
            
            // Crear objeto de resultado
            const testResult = {
                name: state.currentTest.name,
                correct: correct,
                incorrect: incorrect,
                unanswered: unanswered,
                total: totalQuestions,
                testType: state.currentTest.testTypeText,
                timeUsedText: timeUsedText,
                detailedResults: detailedResults,
                date: new Date().toLocaleString('es-ES'),
                id: Date.now()
            };
            
            // A√±adir al historial
            state.testResults.push(testResult);
            localStorage.setItem('testResults', JSON.stringify(state.testResults));
            
            // Mostrar el resultado espec√≠fico
            state.currentViewingResult = testResult;
            
            // Limpiar test actual y cambiar a pesta√±a de resultados
            state.currentTest = null;
            state.currentTab = 'results';
            render();
            
            // Hacer scroll al inicio de la p√°gina despu√©s de renderizar
            setTimeout(() => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 100);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function startNewTest() {
            state.currentTab = 'test';
            state.currentViewingResult = null;
            render();
        }

        function viewTestResult(index) {
            state.currentViewingResult = state.testResults[index];
            render();
        }

        function clearTestHistory() {
            if (confirm('¬øEliminar todo el historial de tests? Esta acci√≥n no se puede deshacer.')) {
                state.testResults = [];
                state.currentViewingResult = null;
                localStorage.setItem('testResults', JSON.stringify(state.testResults));
                render();
                showMessage('Historial de tests eliminado', 'success');
            }
        }

        function deleteIndividualTest(index) {
            const testName = state.testResults[index].name;
            if (confirm(`¬øEliminar el test "${testName}"? Esta acci√≥n no se puede deshacer.`)) {
                state.testResults.splice(index, 1);
                localStorage.setItem('testResults', JSON.stringify(state.testResults));
                
                // Si est√°bamos viendo el test que se elimin√≥, volver al historial
                if (state.currentViewingResult && state.currentViewingResult.id === state.testResults[index]?.id) {
                    state.currentViewingResult = null;
                }
                
                render();
                showMessage('Test eliminado correctamente', 'success');
            }
        }

        function showMessage(message, type) {
            const messagesDiv = document.getElementById('messages');
            if (messagesDiv) {
                messagesDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
                setTimeout(() => {
                    messagesDiv.innerHTML = '';
                }, 5000);
            }
        }

        function initializeApp() {
            console.log('Sistema iniciando...');
            
            document.addEventListener('change', function(e) {
                if (e.target && e.target.id === 'imageInput') {
                    const files = Array.from(e.target.files);
                    const imageFiles = files.filter(file => file.type.startsWith('image/')).slice(0, 10);
                    
                    if (imageFiles.length > 0) {
                        state.selectedImages = imageFiles;
                        render();
                        showMessage(`${imageFiles.length} imagen(es) seleccionada(s)`, 'success');
                    }
                }
            });
            
            render();
            console.log('Sistema cargado correctamente');
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
    <!-- 
PARCHE PARA PREGUNTAS FALLADAS
A√±adir este c√≥digo al final del archivo index.html, justo antes de </body>
Sin tocar nada del c√≥digo existente
-->

<script>
    // ========== PARCHE: SISTEMA DE PREGUNTAS FALLADAS ==========
    
    // Funci√≥n para actualizar preguntas falladas (sin tocar c√≥digo original)
    function updateFailedQuestionsData() {
        const failedQuestions = [];
        
        state.testResults.forEach(result => {
            if (result.detailedResults) {
                result.detailedResults.forEach(detail => {
                    if (!detail.isCorrect && detail.userAnswer !== null) {
                        const questionId = detail.question.id;
                        
                        let existingFailed = failedQuestions.find(fq => fq.questionId === questionId);
                        
                        if (!existingFailed) {
                            existingFailed = {
                                questionId: questionId,
                                question: detail.question,
                                failedCount: 0,
                                lastFailedDate: null,
                                isResolved: false
                            };
                            failedQuestions.push(existingFailed);
                        }
                        
                        existingFailed.failedCount++;
                        existingFailed.lastFailedDate = result.date;
                    }
                });
            }
        });

        // Verificar preguntas resueltas
        failedQuestions.forEach(failedQ => {
            const laterResults = state.testResults
                .filter(result => new Date(result.date) > new Date(failedQ.lastFailedDate))
                .reverse();

            for (let result of laterResults) {
                if (result.detailedResults) {
                    const correctAnswer = result.detailedResults.find(detail => 
                        detail.question.id === failedQ.questionId && detail.isCorrect
                    );
                    
                    if (correctAnswer) {
                        failedQ.isResolved = true;
                        break;
                    }
                }
            }
        });

        return failedQuestions;
    }

    // Funci√≥n para obtener preguntas falladas no resueltas
    function getUnresolvedFailedQuestions() {
        const failedQuestions = updateFailedQuestionsData();
        return failedQuestions.filter(fq => !fq.isResolved);
    }

    // Funci√≥n para iniciar test de preguntas falladas
    function startFailedQuestionsTest() {
        const unresolvedFailed = getUnresolvedFailedQuestions();
        
        if (unresolvedFailed.length === 0) {
            showMessage('No tienes preguntas falladas para repasar üéâ', 'success');
            return;
        }

        const questions = unresolvedFailed.map(fq => fq.question);
        const duration = Math.max(300, questions.length * 60);
        
        const now = new Date();
        const dateStr = now.toLocaleDateString('es-ES');
        const timeStr = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        const testName = `Test de Repaso - ${dateStr} ${timeStr}`;

        state.currentTest = {
            name: testName,
            questions: questions,
            answers: {},
            duration: duration,
            timeLeft: duration,
            timer: null,
            testType: 'failed',
            testTypeText: `Repaso de Preguntas Falladas (${questions.length} preguntas)`,
            startTime: Date.now(),
            isFailedQuestionsTest: true
        };
        
        // Iniciar timer
        state.currentTest.timer = setInterval(() => {
            state.currentTest.timeLeft--;
            if (state.currentTest.timeLeft <= 0) {
                finishTest();
            } else {
                const timerElement = document.getElementById('timer');
                if (timerElement) {
                    timerElement.textContent = `‚è±Ô∏è ${formatTime(state.currentTest.timeLeft)}`;
                }
            }
        }, 1000);
        
        render();
        showMessage(`Test de repaso iniciado con ${questions.length} preguntas`, 'success');
    }

    // Extender la funci√≥n renderTestTab original
    const originalRenderTestTab = renderTestTab;
    renderTestTab = function() {
        if (state.questions.length === 0) {
            return '<div style="text-align: center; padding: 40px;">A√±ade preguntas al banco para generar tests</div>';
        }

        if (!state.currentTest) {
            const unresolvedFailed = getUnresolvedFailedQuestions();
            
            return `
                <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #0c4a6e; margin-bottom: 15px;">üéØ Configuraci√≥n del Test</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">N√∫mero de preguntas:</label>
                            <select id="test-questions-count" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="5">5 preguntas</option>
                                <option value="10" selected>10 preguntas</option>
                                <option value="15">15 preguntas</option>
                                <option value="20">20 preguntas</option>
                                <option value="all">Todas las preguntas disponibles</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Duraci√≥n:</label>
                            <select id="test-duration" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="300">5 minutos</option>
                                <option value="600" selected>10 minutos</option>
                                <option value="900">15 minutos</option>
                                <option value="1200">20 minutos</option>
                                <option value="1800">30 minutos</option>
                                <option value="0">Sin l√≠mite de tiempo</option>
                            </select>
                        </div>
                    </div>

                    ${state.topics.length > 0 ? `
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 15px; font-weight: 500;">Selecci√≥n de temas:</label>
                            <div style="display: grid; gap: 8px;">
                                <div class="custom-checkbox" onclick="toggleGeneralTest()">
                                    <input type="checkbox" id="test-general" onchange="handleGeneralTestChange(this)" checked>
                                    <span style="font-weight: 500;">Test General (${state.questions.length} preguntas)</span>
                                </div>
                                ${state.topics.map(topic => `
                                    <div class="custom-checkbox" onclick="toggleTopicTest('${topic.id}')">
                                        <input type="checkbox" class="topic-checkbox" data-topic-id="${topic.id}" onchange="handleTopicChange()">
                                        <span>${topic.name} (${getTopicQuestionCount(topic.id)} preguntas)</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div style="margin-top: 15px; padding: 10px; background: #f3f4f6; border-radius: 6px; font-size: 14px; color: #6b7280;">
                                üí° <strong>Consejo:</strong> Puedes seleccionar m√∫ltiples temas para crear un test combinado, o elegir "Test General" para incluir todas las preguntas.
                            </div>
                        </div>
                    ` : ''}

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Nombre del test:</label>
                        <input type="text" id="test-name" placeholder="Ej: Test de Matem√°ticas - Sesi√≥n 1" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                        <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                            Si no especificas un nombre, se generar√° autom√°ticamente
                        </div>
                    </div>
                </div>

                ${unresolvedFailed.length > 0 ? `
                    <div style="background: #fef2f2; border: 2px solid #ef4444; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="color: #dc2626; margin-bottom: 15px;">üîÑ Test de Repaso Disponible</h3>
                        <p style="color: #991b1b; margin-bottom: 15px;">
                            Tienes <strong>${unresolvedFailed.length} pregunta${unresolvedFailed.length === 1 ? '' : 's'}</strong> fallada${unresolvedFailed.length === 1 ? '' : 's'} esperando repaso.
                        </p>
                        <div style="text-align: center;">
                            <button onclick="startFailedQuestionsTest()" class="btn btn-danger" style="font-size: 1.1rem; padding: 12px 25px;">
                                üîÑ Test de Repaso (${unresolvedFailed.length} preguntas)
                            </button>
                        </div>
                        <div style="margin-top: 10px; font-size: 12px; color: #6b7280; text-align: center;">
                            Repasa solo las preguntas que has fallado anteriormente
                        </div>
                    </div>
                ` : ''}

                <div style="text-align: center; padding: 40px;">
                    <button onclick="startTest()" class="btn btn-primary" style="font-size: 1.2rem; padding: 15px 30px;">
                        üéØ Comenzar Test
                    </button>
                </div>
            `;
        }

        return renderCurrentTest();
    };

    // Extender la funci√≥n finishTest para manejar tests de repaso
    const originalFinishTest = finishTest;
    finishTest = function() {
        if (!state.currentTest) return;
        
        // Detener timer si existe
        if (state.currentTest.timer) {
            clearInterval(state.currentTest.timer);
        }
        
        // Recoger respuestas del formulario
        const form = document.getElementById('test-form');
        let correct = 0;
        let incorrect = 0;
        let unanswered = 0;
        const answers = {};
        const detailedResults = [];
        
        state.currentTest.questions.forEach((question, index) => {
            const selectedOption = form.querySelector(`input[name="question-${index}"]:checked`);
            let userAnswer = null;
            let isCorrect = false;
            
            if (selectedOption) {
                userAnswer = parseInt(selectedOption.value);
                answers[index] = userAnswer;
                if (userAnswer === question.correctAnswer) {
                    correct++;
                    isCorrect = true;
                } else {
                    incorrect++;
                }
            } else {
                unanswered++;
            }
            
            detailedResults.push({
                question: question,
                userAnswer: userAnswer,
                isCorrect: isCorrect
            });
        });
        
        const totalQuestions = state.currentTest.questions.length;
        
        // Calcular tiempo usado
        let timeUsedText = '';
        if (state.currentTest.duration > 0) {
            const timeUsed = state.currentTest.duration - state.currentTest.timeLeft;
            timeUsedText = `Tiempo empleado: ${formatTime(timeUsed)} de ${formatTime(state.currentTest.duration)}`;
        }
        
        // Crear objeto de resultado
        const testResult = {
            name: state.currentTest.name,
            correct: correct,
            incorrect: incorrect,
            unanswered: unanswered,
            total: totalQuestions,
            testType: state.currentTest.testTypeText,
            timeUsedText: timeUsedText,
            detailedResults: detailedResults,
            date: new Date().toLocaleString('es-ES'),
            id: Date.now(),
            isFailedQuestionsTest: state.currentTest.isFailedQuestionsTest || false
        };
        
        // A√±adir al historial
        state.testResults.push(testResult);
        localStorage.setItem('testResults', JSON.stringify(state.testResults));
        
        // Mostrar el resultado espec√≠fico
        state.currentViewingResult = testResult;
        
        // Mensaje especial para tests de repaso
        if (state.currentTest.isFailedQuestionsTest) {
            const resolvedCount = detailedResults.filter(r => r.isCorrect).length;
            if (resolvedCount > 0) {
                showMessage(`¬°Excelente! Has superado ${resolvedCount} pregunta${resolvedCount === 1 ? '' : 's'} que anteriormente hab√≠as fallado üéâ`, 'success');
            }
        }
        
        // Limpiar test actual y cambiar a pesta√±a de resultados
        state.currentTest = null;
        state.currentTab = 'results';
        render();
        
        // Hacer scroll al inicio de la p√°gina despu√©s de renderizar
        setTimeout(() => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 100);
    };

    console.log('‚úÖ Parche de preguntas falladas aplicado correctamente');
</script>
   
<script>
    // ========== CORRECCI√ìN FINAL: SISTEMA ROBUSTO DE PREGUNTAS FALLADAS ==========
    
    // REEMPLAZAR completamente la funci√≥n updateFailedQuestionsData
    function updateFailedQuestionsData() {
        const failedQuestions = [];
        
        console.log('üîç Analizando historial de tests...');
        
        // Paso 1: Recopilar todas las preguntas falladas con timestamps
        state.testResults.forEach((result, resultIndex) => {
            if (result.detailedResults) {
                result.detailedResults.forEach(detail => {
                    if (!detail.isCorrect && detail.userAnswer !== null) {
                        const questionId = detail.question.id;
                        
                        let existingFailed = failedQuestions.find(fq => fq.questionId === questionId);
                        
                        if (!existingFailed) {
                            existingFailed = {
                                questionId: questionId,
                                question: detail.question,
                                failedCount: 0,
                                failedTests: [],
                                isResolved: false,
                                resolvedTest: null
                            };
                            failedQuestions.push(existingFailed);
                        }
                        
                        existingFailed.failedCount++;
                        existingFailed.failedTests.push({
                            testName: result.name,
                            date: result.date,
                            timestamp: result.id,
                            resultIndex: resultIndex
                        });
                    }
                });
            }
        });

        console.log(`üìã Encontradas ${failedQuestions.length} preguntas √∫nicas falladas`);

        // Paso 2: Verificar resoluciones usando timestamps (m√°s confiable que fechas)
        failedQuestions.forEach(failedQ => {
            // Obtener el timestamp de la primera falla
            const firstFailTimestamp = Math.min(...failedQ.failedTests.map(ft => ft.timestamp));
            
            // Buscar tests posteriores a la primera falla
            const laterTests = state.testResults
                .filter(result => result.id > firstFailTimestamp)
                .sort((a, b) => a.id - b.id); // Ordenar por timestamp

            console.log(`üîç Pregunta ${failedQ.questionId}: Primera falla en timestamp ${firstFailTimestamp}, revisando ${laterTests.length} tests posteriores`);

            for (let result of laterTests) {
                if (result.detailedResults) {
                    const correctAnswer = result.detailedResults.find(detail => 
                        detail.question.id === failedQ.questionId && detail.isCorrect
                    );
                    
                    if (correctAnswer) {
                        failedQ.isResolved = true;
                        failedQ.resolvedTest = {
                            testName: result.name,
                            date: result.date,
                            timestamp: result.id
                        };
                        console.log(`‚úÖ Pregunta ${failedQ.questionId} RESUELTA en test "${result.name}" (timestamp: ${result.id})`);
                        break;
                    }
                }
            }
            
            if (!failedQ.isResolved) {
                console.log(`‚ùå Pregunta ${failedQ.questionId} A√öN PENDIENTE`);
            }
        });

        return failedQuestions;
    }

    // REEMPLAZAR la funci√≥n getUnresolvedFailedQuestions
    function getUnresolvedFailedQuestions() {
        const failedQuestions = updateFailedQuestionsData();
        const unresolved = failedQuestions.filter(fq => !fq.isResolved);
        
        console.log(`üìä RESUMEN FINAL:`);
        console.log(`   üî¥ Total preguntas falladas: ${failedQuestions.length}`);
        console.log(`   ‚úÖ Resueltas: ${failedQuestions.length - unresolved.length}`);
        console.log(`   ‚è≥ Pendientes: ${unresolved.length}`);
        
        if (unresolved.length > 0) {
            console.log(`üìù Preguntas pendientes:`);
            unresolved.forEach(fq => {
                console.log(`   - ID ${fq.questionId}: "${fq.question.question.substring(0, 50)}..."`);
            });
        }
        
        return unresolved;
    }

    // REEMPLAZAR finishTest con versi√≥n mejorada
    const originalFinishTestRobust = finishTest;
    finishTest = function() {
        if (!state.currentTest) return;
        
        const isFailedQuestionsTest = state.currentTest.isFailedQuestionsTest;
        
        console.log(`üèÅ Finalizando test: "${state.currentTest.name}" (Tipo: ${isFailedQuestionsTest ? 'REPASO' : 'NORMAL'})`);
        
        // Llamar a la funci√≥n original
        originalFinishTestRobust();
        
        // Si era un test de repaso, hacer an√°lisis completo
        if (isFailedQuestionsTest) {
            console.log('üîÑ AN√ÅLISIS POST-REPASO:');
            
            // Esperar un poco y luego actualizar
            setTimeout(() => {
                console.log('üìä Actualizando estado de preguntas falladas...');
                const unresolvedAfter = getUnresolvedFailedQuestions();
                
                // Si estamos en la pesta√±a de test, re-renderizar
                if (state.currentTab === 'test') {
                    console.log('üîÑ Re-renderizando interfaz...');
                    render();
                }
                
                // Mostrar resultado al usuario
                if (unresolvedAfter.length === 0) {
                    showMessage('üéâ ¬°Felicidades! Has superado todas tus preguntas falladas', 'success');
                } else {
                    showMessage(`‚ú® Progreso: Ahora tienes ${unresolvedAfter.length} pregunta${unresolvedAfter.length === 1 ? '' : 's'} pendiente${unresolvedAfter.length === 1 ? '' : 's'}`, 'success');
                }
                
            }, 500); // Dar tiempo para que se guarde el test
        }
    };

    // Funci√≥n de diagn√≥stico (opcional - para debugging)
    window.diagnosticarPreguntas = function() {
        console.log('üî¨ DIAGN√ìSTICO COMPLETO:');
        console.log('Tests en el historial:', state.testResults.length);
        state.testResults.forEach((test, i) => {
            console.log(`Test ${i}: "${test.name}" - ID: ${test.id} - Fecha: ${test.date}`);
        });
        
        const failed = updateFailedQuestionsData();
        console.log('An√°lisis de preguntas falladas completado');
    };

    console.log('üîß Correcci√≥n FINAL aplicada - Sistema robusto activado');
    console.log('üí° Puedes usar diagnosticarPreguntas() en la consola para debugging');
</script>
    <!-- 
PARCHE: SISTEMA DE CARPETAS COLAPSABLES EN BANCO DE PREGUNTAS
A√±adir este c√≥digo al final del archivo index.html, justo antes de </body>
Este parche permite ocultar/mostrar las carpetas de temas individualmente
-->

<script>
    // ========== PARCHE: SISTEMA DE CARPETAS COLAPSABLES ==========
    
    // Estado para controlar qu√© carpetas est√°n colapsadas
    let collapsedFolders = JSON.parse(localStorage.getItem('collapsedFolders') || '{}');
    
    // Funci√≥n para alternar el estado de una carpeta
    function toggleFolder(topicId) {
        collapsedFolders[topicId] = !collapsedFolders[topicId];
        localStorage.setItem('collapsedFolders', JSON.stringify(collapsedFolders));
        render();
    }
    
    // Funci√≥n para colapsar todas las carpetas
    function collapseAllFolders() {
        const allTopicIds = state.topics.map(t => t.id.toString());
        allTopicIds.forEach(id => {
            collapsedFolders[id] = true;
        });
        localStorage.setItem('collapsedFolders', JSON.stringify(collapsedFolders));
        render();
    }
    
    // Funci√≥n para expandir todas las carpetas
    function expandAllFolders() {
        collapsedFolders = {};
        localStorage.setItem('collapsedFolders', JSON.stringify(collapsedFolders));
        render();
    }
    
    // REEMPLAZAR la funci√≥n renderQuestionsByTopic con versi√≥n colapsable
    const originalRenderQuestionsByTopic = renderQuestionsByTopic;
    renderQuestionsByTopic = function() {
        const questionsWithoutTopic = state.questions.filter(q => !q.topicId);
        
        let html = '';
        
        // Botones de control global
        const hasTopicsWithQuestions = state.topics.some(topic => {
            return state.questions.filter(q => q.topicId && q.topicId.toString() === topic.id.toString()).length > 0;
        });
        
        if (hasTopicsWithQuestions) {
            html += `
                <div style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 2px solid #e2e8f0;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span style="font-weight: 500; color: #374151; margin-right: 10px;">Control de carpetas:</span>
                        <button onclick="expandAllFolders()" class="btn btn-info" style="padding: 6px 12px; font-size: 12px;">
                            üìÇ Expandir Todas
                        </button>
                        <button onclick="collapseAllFolders()" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;">
                            üìÅ Contraer Todas
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Mostrar preguntas por cada tema que TENGA preguntas
        state.topics.forEach(topic => {
            const topicQuestions = state.questions.filter(q => q.topicId && q.topicId.toString() === topic.id.toString());
            if (topicQuestions.length > 0) {
                const isCollapsed = collapsedFolders[topic.id.toString()];
                const chevronIcon = isCollapsed ? '‚ñ∂Ô∏è' : 'üîΩ';
                
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 onclick="toggleFolder('${topic.id}')" style="background: #4f46e5; color: white; padding: 10px 15px; border-radius: 8px 8px 0 0; margin: 0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; transition: all 0.2s;" 
                            onmouseover="this.style.background='#4338ca'" 
                            onmouseout="this.style.background='#4f46e5'">
                            <span style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 14px;">${chevronIcon}</span>
                                <span>üìÅ ${topic.name}</span>
                            </span>
                            <span style="font-size: 14px; opacity: 0.9;">${topicQuestions.length} pregunta${topicQuestions.length === 1 ? '' : 's'}</span>
                        </h3>
                        <div style="border: 1px solid #4f46e5; border-top: none; border-radius: 0 0 8px 8px; background: white; ${isCollapsed ? 'display: none;' : ''}">
                            ${topicQuestions.map(q => {
                                const actualIndex = state.questions.findIndex(question => question.id === q.id);
                                return renderSingleQuestion(q, actualIndex);
                            }).join('')}
                        </div>
                    </div>
                `;
            }
        });
        
        // Mostrar preguntas sin tema asignado SI existen
        if (questionsWithoutTopic.length > 0) {
            const noTopicCollapsed = collapsedFolders['no-topic'];
            const chevronIcon = noTopicCollapsed ? '‚ñ∂Ô∏è' : 'üîΩ';
            
            html += `
                <div style="margin-bottom: 30px;">
                    <h3 onclick="toggleFolder('no-topic')" style="background: #6b7280; color: white; padding: 10px 15px; border-radius: 8px 8px 0 0; margin: 0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; transition: all 0.2s;" 
                        onmouseover="this.style.background='#4b5563'" 
                        onmouseout="this.style.background='#6b7280'">
                        <span style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 14px;">${chevronIcon}</span>
                            <span>üìÇ Sin tema asignado</span>
                        </span>
                        <span style="font-size: 14px; opacity: 0.9;">${questionsWithoutTopic.length} pregunta${questionsWithoutTopic.length === 1 ? '' : 's'}</span>
                    </h3>
                    <div style="border: 1px solid #6b7280; border-top: none; border-radius: 0 0 8px 8px; background: white; ${noTopicCollapsed ? 'display: none;' : ''}">
                        ${questionsWithoutTopic.map(q => {
                            const actualIndex = state.questions.findIndex(question => question.id === q.id);
                            return renderSingleQuestion(q, actualIndex);
                        }).join('')}
                    </div>
                </div>
            `;
        }
        
        // Si no hay preguntas en absoluto
        if (html === '' || (!hasTopicsWithQuestions && questionsWithoutTopic.length === 0)) {
            return '<div style="padding: 40px; text-align: center; color: #9ca3af;">No hay preguntas disponibles en el banco</div>';
        }
        
        return html;
    };

    console.log('‚úÖ Parche de carpetas colapsables aplicado correctamente');
</script>
<!-- 
PARCHE: PANTALLA INTERMEDIA DESPU√âS DEL LOGIN
A√±adir este c√≥digo al final del archivo index.html, justo antes de </body>
Este parche a√±ade una pantalla de selecci√≥n entre login y las funciones principales
-->

<script>
    // ========== PARCHE: PANTALLA INTERMEDIA ==========
    
    // Nuevo estado para controlar la pantalla intermedia
    let showIntermediateScreen = false;
    
    // Interceptar la funci√≥n de login original
    const originalLogin = login;
    login = function() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        if (users[username] && users[username].password === password) {
            state.currentUser = users[username];
            showIntermediateScreen = true; // Mostrar pantalla intermedia
            render();
            showMessage(`Bienvenido ${users[username].name}`, 'success');
        } else {
            showMessage('Usuario o contrase√±a incorrectos', 'error');
        }
    };
    
    // Funci√≥n para ir a realizar tests
    function goToTests() {
        showIntermediateScreen = false;
        state.currentTab = 'upload';
        render();
    }
    
    // Funci√≥n para ir a ver res√∫menes
    function goToSummaries() {
        showIntermediateScreen = false;
        state.currentTab = 'results';
        render();
    }
    
    // Funci√≥n para renderizar la pantalla intermedia
    function renderIntermediateScreen() {
        return `
            <div style="min-height: 80vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: -30px; border-radius: 20px;">
                <div style="background: white; border-radius: 24px; padding: 60px; box-shadow: 0 25px 50px rgba(0,0,0,0.15); max-width: 600px; width: 100%; text-align: center; position: relative; overflow: hidden;">
                    
                    <!-- Decoraci√≥n de fondo -->
                    <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: linear-gradient(135deg, #667eea20, #764ba220); border-radius: 50%; z-index: 0;"></div>
                    <div style="position: absolute; bottom: -30px; left: -30px; width: 100px; height: 100px; background: linear-gradient(135deg, #764ba220, #667eea20); border-radius: 50%; z-index: 0;"></div>
                    
                    <!-- Contenido principal -->
                    <div style="position: relative; z-index: 1;">
                        <!-- Icono principal -->
                        <div style="background: linear-gradient(135deg, #667eea, #764ba2); width: 80px; height: 80px; border-radius: 20px; margin: 0 auto 30px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);">
                            <span style="font-size: 2.5rem; filter: drop-shadow(0 2px 4px rgba(255,255,255,0.3));">üéØ</span>
                        </div>
                        
                        <!-- T√≠tulo principal -->
                        <h1 style="font-size: 2.8rem; font-weight: 700; margin: 0 0 15px 0; background: linear-gradient(135deg, #2d3748, #4a5568); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                            ¬°Bienvenido!
                        </h1>
                        
                        <!-- Subt√≠tulo -->
                        <p style="font-size: 1.3rem; color: #6b7280; margin: 0 0 50px 0; font-weight: 400; line-height: 1.5;">
                            Selecciona qu√© te gustar√≠a hacer hoy
                        </p>
                        
                        <!-- Botones principales -->
                        <div style="display: grid; gap: 25px; margin-bottom: 40px;">
                            
                            <!-- Bot√≥n Realizar Tests -->
                            <button onclick="goToTests()" style="
                                background: linear-gradient(135deg, #4f46e5, #7c3aed); 
                                border: none; 
                                border-radius: 16px; 
                                padding: 25px 40px; 
                                color: white; 
                                font-size: 1.3rem; 
                                font-weight: 600; 
                                cursor: pointer; 
                                transition: all 0.3s ease; 
                                box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);
                                position: relative;
                                overflow: hidden;
                                border: 2px solid transparent;
                                "
                                onmouseover="
                                    this.style.transform='translateY(-5px)'; 
                                    this.style.boxShadow='0 20px 40px rgba(79, 70, 229, 0.4)';
                                    this.style.background='linear-gradient(135deg, #6366f1, #8b5cf6)';
                                " 
                                onmouseout="
                                    this.style.transform='translateY(0)'; 
                                    this.style.boxShadow='0 10px 25px rgba(79, 70, 229, 0.3)';
                                    this.style.background='linear-gradient(135deg, #4f46e5, #7c3aed)';
                                ">
                                
                                <!-- Icono y texto -->
                                <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                                    <span style="font-size: 1.8rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));">üìö</span>
                                    <div style="text-align: left;">
                                        <div style="font-size: 1.3rem; font-weight: 700; margin-bottom: 3px;">Realizar Tests</div>
                                        <div style="font-size: 0.9rem; opacity: 0.9; font-weight: 400;">Crear y gestionar ex√°menes</div>
                                    </div>
                                </div>
                                
                                <!-- Efecto de brillo al hover -->
                                <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s ease;"></div>
                            </button>
                            
                            <!-- Bot√≥n Ver Res√∫menes -->
                            <button onclick="goToSummaries()" style="
                                background: linear-gradient(135deg, #059669, #0ea5e9); 
                                border: none; 
                                border-radius: 16px; 
                                padding: 25px 40px; 
                                color: white; 
                                font-size: 1.3rem; 
                                font-weight: 600; 
                                cursor: pointer; 
                                transition: all 0.3s ease; 
                                box-shadow: 0 10px 25px rgba(5, 150, 105, 0.3);
                                position: relative;
                                overflow: hidden;
                                border: 2px solid transparent;
                                "
                                onmouseover="
                                    this.style.transform='translateY(-5px)'; 
                                    this.style.boxShadow='0 20px 40px rgba(5, 150, 105, 0.4)';
                                    this.style.background='linear-gradient(135deg, #10b981, #06b6d4)';
                                " 
                                onmouseout="
                                    this.style.transform='translateY(0)'; 
                                    this.style.boxShadow='0 10px 25px rgba(5, 150, 105, 0.3)';
                                    this.style.background='linear-gradient(135deg, #059669, #0ea5e9)';
                                ">
                                
                                <!-- Icono y texto -->
                                <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                                    <span style="font-size: 1.8rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));">üìä</span>
                                    <div style="text-align: left;">
                                        <div style="font-size: 1.3rem; font-weight: 700; margin-bottom: 3px;">Ver Res√∫menes</div>
                                        <div style="font-size: 0.9rem; opacity: 0.9; font-weight: 400;">Analizar resultados y estad√≠sticas</div>
                                    </div>
                                </div>
                                
                                <!-- Efecto de brillo al hover -->
                                <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s ease;"></div>
                            </button>
                        </div>
                        
                        <!-- Footer info -->
                        <div style="border-top: 1px solid #e5e7eb; padding-top: 25px; color: #9ca3af; font-size: 0.9rem;">
                            <p style="margin: 0;">Sistema de Ex√°menes ‚Ä¢ Usuario: ${state.currentUser.name}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Interceptar la funci√≥n render original para mostrar la pantalla intermedia
    const originalRender = render;
    render = function() {
        if (showIntermediateScreen && state.currentUser) {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <div class="title">Sistema de Ex√°menes</div>
                        <div>
                            <span style="color: ${state.apiKey ? '#10b981' : '#ef4444'};">
                                ${state.apiKey ? '‚úÖ API Configurada' : '‚ùå Sin API'}
                            </span>
                            <button onclick="configureAPI()" class="btn btn-secondary">API</button>
                            <span style="color: #f59e0b;">üë§ ${state.currentUser.name}</span>
                            <button onclick="logout()" class="btn btn-danger">Salir</button>
                        </div>
                    </div>
                    ${renderIntermediateScreen()}
                </div>
            `;
        } else {
            // Usar la funci√≥n render original
            originalRender();
        }
    };
    
    // Interceptar logout para resetear la pantalla intermedia
    const originalLogout = logout;
    logout = function() {
        showIntermediateScreen = false;
        originalLogout();
    };
    
    console.log('‚úÖ Parche de pantalla intermedia aplicado correctamente');
</script>    
    <!-- 
PARCHE: PANTALLA DE RES√öMENES CON IA
A√±adir este c√≥digo al final del archivo index.html, justo antes de </body>
Este parche a√±ade una nueva funcionalidad para generar res√∫menes de im√°genes
-->

<script>
    // ========== PARCHE: SISTEMA DE RES√öMENES CON IA ==========
    
    // Nuevo estado para la funcionalidad de res√∫menes
    let summaryState = {
        selectedImages: [],
        generatedSummary: '',
        isProcessing: false
    };
    
    // Interceptar la funci√≥n goToSummaries para redirigir a la nueva pesta√±a
    const originalGoToSummaries = goToSummaries;
    goToSummaries = function() {
        showIntermediateScreen = false;
        state.currentTab = 'summary'; // Nueva pesta√±a
        render();
    };
    
    // Extender la funci√≥n renderTabContent para incluir la nueva pesta√±a
    const originalRenderTabContent = renderTabContent;
    renderTabContent = function() {
        switch(state.currentTab) {
            case 'upload':
                return renderUploadTab();
            case 'questions':
                return renderQuestionsTab();
            case 'test':
                return renderTestTab();
            case 'results':
                return renderResultsTab();
            case 'summary':
                return renderSummaryTab();
            default:
                return '<div>Error: Pesta√±a no encontrada</div>';
        }
    };
    
    // Funci√≥n para renderizar la pesta√±a de res√∫menes
    function renderSummaryTab() {
        return `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h2 style="color: #1f2937; margin: 0;">üìÑ Generador de Res√∫menes con IA</h2>
                    <p style="color: #6b7280; margin: 5px 0 0 0; font-size: 14px;">Sube una imagen y obt√©n un resumen inteligente del contenido</p>
                </div>
                <button onclick="backToIntermediateScreen()" class="btn btn-secondary">
                    ‚Üê Volver al Men√∫ Principal
                </button>
            </div>
            
            <div class="three-column">
                <div class="column">
                    <h3 style="margin-bottom: 15px;">üì§ Subir Imagen para Resumir</h3>
                    <div class="upload-area" onclick="document.getElementById('summaryImageInput').click()">
                        <div>üì∑ Seleccionar imagen</div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Una imagen por vez</div>
                        <div style="margin-top: 10px; color: #4f46e5; font-weight: 500;">
                            ${summaryState.selectedImages.length}/1 archivo
                        </div>
                    </div>
                    <input type="file" id="summaryImageInput" style="display: none;" accept="image/*">
                    
                    ${summaryState.selectedImages.length > 0 ? `
                        <div style="margin-bottom: 15px; padding: 15px; background: #f3f4f6; border-radius: 8px; text-align: center;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 12px; word-break: break-all; flex: 1;">${summaryState.selectedImages[0].name}</div>
                                <button onclick="removeSummaryImage()" style="background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; cursor: pointer; margin-left: 10px;">√ó</button>
                            </div>
                        </div>
                    ` : ''}
                    
                    <button onclick="generateSummary()" class="btn btn-primary" style="width: 100%;" ${summaryState.selectedImages.length === 0 || !state.apiKey || summaryState.isProcessing ? 'disabled' : ''}>
                        ${summaryState.isProcessing ? 'üîÑ Generando Resumen...' : 'ü§ñ Generar Resumen'}
                    </button>
                    
                    ${summaryState.isProcessing ? `
                        <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; text-align: center;">
                            <span style="color: #92400e;">üîÑ Procesando imagen y generando resumen...</span>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px;">
                        <h4 style="color: #0c4a6e; margin-bottom: 10px;">üí° Consejos para mejores res√∫menes</h4>
                        <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #0369a1;">
                            <li>Usa im√°genes con texto claro y legible</li>
                            <li>Evita im√°genes muy peque√±as o borrosas</li>
                            <li>Funciona mejor con documentos, art√≠culos, o capturas de pantalla</li>
                            <li>El resumen se adaptar√° al tipo de contenido detectado</li>
                        </ul>
                    </div>
                </div>

                <div class="column">
                    <h3 style="margin-bottom: 15px;">üìù Resumen Generado</h3>
                    <textarea id="generatedSummary" class="textarea" placeholder="El resumen aparecer√° aqu√≠ una vez que proceses una imagen..." readonly>${summaryState.generatedSummary}</textarea>
                    
                    ${summaryState.generatedSummary ? `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                            <button onclick="copySummaryToClipboard()" class="btn btn-info" style="width: 100%; padding: 8px; font-size: 13px;">
                                üìã Copiar al Portapapeles
                            </button>
                            <button onclick="clearSummary()" class="btn btn-secondary" style="width: 100%; padding: 8px; font-size: 13px;">
                                üóëÔ∏è Limpiar Resumen
                            </button>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 15px; background: #f0fdf4; border: 2px solid #22c55e; border-radius: 8px;">
                            <h4 style="color: #166534; margin-bottom: 10px;">‚úÖ ¬°Resumen generado exitosamente!</h4>
                            <p style="margin: 0; font-size: 13px; color: #16a34a;">
                                Puedes copiar el texto, procesarlo nuevamente, o subir una nueva imagen.
                            </p>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    // Funci√≥n para volver a la pantalla intermedia
    function backToIntermediateScreen() {
        showIntermediateScreen = true;
        state.currentTab = 'upload'; // Reset tab
        render();
    }
    
    // Funci√≥n para manejar la selecci√≥n de imagen
    function handleSummaryImageSelection() {
        document.addEventListener('change', function(e) {
            if (e.target && e.target.id === 'summaryImageInput') {
                const files = Array.from(e.target.files);
                const imageFile = files.filter(file => file.type.startsWith('image/'))[0];
                
                if (imageFile) {
                    summaryState.selectedImages = [imageFile];
                    summaryState.generatedSummary = ''; // Limpiar resumen anterior
                    render();
                    showMessage('Imagen seleccionada correctamente', 'success');
                }
            }
        });
    }
    
    // Funci√≥n para eliminar la imagen seleccionada
    function removeSummaryImage() {
        summaryState.selectedImages = [];
        summaryState.generatedSummary = '';
        render();
        showMessage('Imagen eliminada', 'success');
    }
    
    // Funci√≥n principal para generar resumen
    async function generateSummary() {
        if (!state.apiKey) {
            showMessage('Configura tu API key primero', 'error');
            return;
        }

        if (summaryState.selectedImages.length === 0) {
            showMessage('Selecciona una imagen primero', 'error');
            return;
        }

        summaryState.isProcessing = true;
        render();
        showMessage('Generando resumen...', 'success');
        
        try {
            const file = summaryState.selectedImages[0];
            const base64 = await fileToBase64(file);
            
            const messageContent = [
                {
                    type: "image",
                    source: {
                        type: "base64",
                        media_type: file.type,
                        data: base64
                    }
                },
                {
                    type: "text",
                    text: `Act√∫a como un asistente experto en an√°lisis y s√≠ntesis de informaci√≥n. Analiza esta imagen y genera un resumen completo e inteligente del contenido.

INSTRUCCIONES PARA EL RESUMEN:

üéØ OBJETIVO: Crear un resumen estructurado, claro y √∫til que capture la esencia del contenido

üìã FORMATO DEL RESUMEN:
‚Ä¢ Comienza con una breve descripci√≥n del tipo de documento/contenido
‚Ä¢ Organiza la informaci√≥n en secciones l√≥gicas con encabezados
‚Ä¢ Usa vi√±etas y numeraci√≥n cuando sea apropiado
‚Ä¢ Incluye los puntos m√°s importantes y relevantes
‚Ä¢ Termina con conclusiones o puntos clave si es relevante

üîç QU√â INCLUIR:
- Ideas principales y conceptos clave
- Datos importantes, cifras, fechas relevantes
- Argumentos o puntos de vista presentados
- Conclusiones o recomendaciones si las hay
- Cualquier informaci√≥n pr√°ctica o accionable

‚ú® ESTILO:
- Lenguaje claro y profesional
- Oraciones concisas pero informativas  
- Estructura f√°cil de leer y escanear
- Adapta el tono al tipo de contenido (acad√©mico, empresarial, t√©cnico, etc.)

üö´ EVITA:
- Repetir informaci√≥n innecesaria
- Incluir detalles muy t√©cnicos a menos que sean cruciales
- Hacer el resumen demasiado largo (m√°ximo 500 palabras)
- Copiar texto textualmente sin reorganizar

Genera un resumen que sea verdaderamente √∫til para alguien que quiere entender r√°pidamente el contenido esencial del documento.`
                }
            ];

            const response = await fetch("/api/anthropic", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-api-key": state.apiKey,
                },
                body: JSON.stringify({
                    model: "claude-sonnet-4-20250514",
                    max_tokens: 2000,
                    messages: [{
                        role: "user",
                        content: messageContent
                    }]
                })
            });

            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            summaryState.generatedSummary = data.content[0].text;
            summaryState.isProcessing = false;
            
            render();
            showMessage('¬°Resumen generado exitosamente!', 'success');
            
        } catch (error) {
            summaryState.isProcessing = false;
            render();
            showMessage(`Error al generar resumen: ${error.message}`, 'error');
        }
    }
    
    // Funci√≥n para copiar el resumen al portapapeles
    async function copySummaryToClipboard() {
        try {
            await navigator.clipboard.writeText(summaryState.generatedSummary);
            showMessage('Resumen copiado al portapapeles', 'success');
        } catch (error) {
            // Fallback para navegadores que no soportan clipboard API
            const textArea = document.createElement('textarea');
            textArea.value = summaryState.generatedSummary;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showMessage('Resumen copiado al portapapeles', 'success');
            } catch (err) {
                showMessage('Error al copiar. Selecciona y copia manualmente', 'error');
            }
            document.body.removeChild(textArea);
        }
    }
    
    // Funci√≥n para limpiar el resumen
    function clearSummary() {
        if (confirm('¬øLimpiar el resumen generado?')) {
            summaryState.generatedSummary = '';
            render();
            showMessage('Resumen limpiado', 'success');
        }
    }
    
    // Extender la funci√≥n setTab para incluir la nueva pesta√±a
    const originalSetTab = setTab;
    setTab = function(tab) {
        state.currentTab = tab;
        state.currentViewingResult = null;
        
        // Si vamos a summary, asegurar que no se muestre la pantalla intermedia
        if (tab === 'summary') {
            showIntermediateScreen = false;
        }
        
        render();
    };
    
    // Extender el sistema de navegaci√≥n para incluir la nueva pesta√±a
    const originalRender = render;
    render = function() {
        if (showIntermediateScreen && state.currentUser) {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <div class="title">Sistema de Ex√°menes</div>
                        <div>
                            <span style="color: ${state.apiKey ? '#10b981' : '#ef4444'};">
                                ${state.apiKey ? '‚úÖ API Configurada' : '‚ùå Sin API'}
                            </span>
                            <button onclick="configureAPI()" class="btn btn-secondary">API</button>
                            <span style="color: #f59e0b;">üë§ ${state.currentUser.name}</span>
                            <button onclick="logout()" class="btn btn-danger">Salir</button>
                        </div>
                    </div>
                    ${renderIntermediateScreen()}
                </div>
            `;
        } else if (state.currentUser) {
            const app = document.getElementById('app');
            
            // Determinar el t√≠tulo seg√∫n la pesta√±a actual
            let pageTitle = 'Sistema de Ex√°menes';
            if (state.currentTab === 'questions') pageTitle = 'Banco de Preguntas';
            else if (state.currentTab === 'results') pageTitle = 'Resultados del Test';
            else if (state.currentTab === 'summary') pageTitle = 'Generador de Res√∫menes';
            
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <div class="title">${pageTitle}</div>
                        <div>
                            <span style="color: ${state.apiKey ? '#10b981' : '#ef4444'};">
                                ${state.apiKey ? '‚úÖ API Configurada' : '‚ùå Sin API'}
                            </span>
                            <button onclick="configureAPI()" class="btn btn-secondary">API</button>
                            <span style="color: #f59e0b;">üë§ ${state.currentUser.name}</span>
                            <button onclick="logout()" class="btn btn-danger">Salir</button>
                        </div>
                    </div>

                    ${state.currentTab !== 'summary' ? `
                        <div class="nav-tabs">
                            <button class="nav-tab ${state.currentTab === 'upload' ? 'active' : ''}" onclick="setTab('upload')">
                                üì§ Subir Test
                            </button>
                            <button class="nav-tab ${state.currentTab === 'questions' ? 'active' : ''}" onclick="setTab('questions')">
                                üìã Banco de Preguntas (${getFilteredQuestions().length})
                            </button>
                            <button class="nav-tab ${state.currentTab === 'test' ? 'active' : ''}" onclick="setTab('test')">
                                üéØ Test Aleatorio
                            </button>
                            <button class="nav-tab ${state.currentTab === 'results' ? 'active' : ''}" onclick="setTab('results')">
                                üìä Resultados (${state.testResults.length})
                            </button>
                        </div>
                    ` : ''}

                    <div id="messages"></div>

                    ${renderTabContent()}
                </div>
            `;
        } else {
            // Usuario no logueado - mostrar login
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <div class="login-form">
                        <h2 style="text-align: center; margin-bottom: 30px;">Iniciar Sesi√≥n</h2>
                        <div class="form-group">
                            <label class="form-label">Usuario</label>
                            <input type="text" id="username" class="form-input" placeholder="demo">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contrase√±a</label>
                            <input type="password" id="password" class="form-input" placeholder="demo123">
                        </div>
                        <button onclick="login()" class="btn btn-primary" style="width: 100%;">
                            Iniciar Sesi√≥n
                        </button>
                        <div style="text-align: center; margin-top: 15px; color: #6b7280; font-size: 14px;">
                            Usuario: demo | Contrase√±a: demo123
                        </div>
                    </div>
                </div>
            `;
        }
    };
    
    // Inicializar el event listener para im√°genes de resumen
    handleSummaryImageSelection();
    
    console.log('‚úÖ Parche de pantalla de res√∫menes aplicado correctamente');
</script>
    <!-- 
PARCHE CORRECCI√ìN: REDIRECCI√ìN CORRECTA A PANTALLA DE RES√öMENES
A√±adir este c√≥digo al final del archivo index.html, justo antes de </body>
Este parche corrige el problema de redirecci√≥n a la pantalla de res√∫menes
-->

<script>
    // ========== CORRECCI√ìN: REDIRECCI√ìN A RES√öMENES ==========
    
    // Forzar la redefinici√≥n correcta de goToSummaries
    goToSummaries = function() {
        showIntermediateScreen = false;
        state.currentTab = 'summary';
        render();
    };
    
    console.log('‚úÖ Parche de correcci√≥n de res√∫menes aplicado correctamente');
</script>
    <!-- 
PARCHE CORRECCI√ìN FINAL: FUNCI√ìN RENDERTABCONTENT COMPLETA
A√±adir este c√≥digo al final del archivo index.html, justo antes de </body>
Este parche REEMPLAZA completamente la funci√≥n renderTabContent para incluir 'summary'
-->

<script>
    // ========== CORRECCI√ìN FINAL: REEMPLAZAR RENDERTABCONTENT ==========
    
    // REEMPLAZAR completamente la funci√≥n renderTabContent
    renderTabContent = function() {
        switch(state.currentTab) {
            case 'upload':
                return renderUploadTab();
            case 'questions':
                return renderQuestionsTab();
            case 'test':
                return renderTestTab();
            case 'results':
                return renderResultsTab();
            case 'summary':
                return renderSummaryTab();
            default:
                return '<div>Error: Pesta√±a no encontrada - ' + state.currentTab + '</div>';
        }
    };
    
    // ASEGURAR que goToSummaries funcione correctamente
    goToSummaries = function() {
        showIntermediateScreen = false;
        state.currentTab = 'summary';
        console.log('Cambiando a pesta√±a summary');
        render();
    };
    
    console.log('‚úÖ Correcci√≥n FINAL aplicada - Pesta√±a summary habilitada');
</script>
    <!-- 
PARCHE URGENTE: DEFINIR FUNCI√ìN RENDERSUMMARYTAB
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
Este parche define la funci√≥n renderSummaryTab que falta
-->

<script>
    // ========== PARCHE URGENTE: FUNCI√ìN RENDERSUMMARYTAB ==========
    
    // Definir la funci√≥n renderSummaryTab globalmente
    function renderSummaryTab() {
        return `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h2 style="color: #1f2937; margin: 0;">üìÑ Generador de Res√∫menes con IA</h2>
                    <p style="color: #6b7280; margin: 5px 0 0 0; font-size: 14px;">Sube una imagen y obt√©n un resumen inteligente del contenido</p>
                </div>
                <button onclick="backToIntermediateScreen()" class="btn btn-secondary">
                    ‚Üê Volver al Men√∫ Principal
                </button>
            </div>
            
            <div class="three-column">
                <div class="column">
                    <h3 style="margin-bottom: 15px;">üì§ Subir Imagen para Resumir</h3>
                    <div class="upload-area" onclick="document.getElementById('summaryImageInput').click()">
                        <div>üì∑ Seleccionar imagen</div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Una imagen por vez</div>
                        <div style="margin-top: 10px; color: #4f46e5; font-weight: 500;">
                            ${summaryState.selectedImages.length}/1 archivo
                        </div>
                    </div>
                    <input type="file" id="summaryImageInput" style="display: none;" accept="image/*">
                    
                    ${summaryState.selectedImages.length > 0 ? `
                        <div style="margin-bottom: 15px; padding: 15px; background: #f3f4f6; border-radius: 8px; text-align: center;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 12px; word-break: break-all; flex: 1;">${summaryState.selectedImages[0].name}</div>
                                <button onclick="removeSummaryImage()" style="background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; cursor: pointer; margin-left: 10px;">√ó</button>
                            </div>
                        </div>
                    ` : ''}
                    
                    <button onclick="generateSummary()" class="btn btn-primary" style="width: 100%;" ${summaryState.selectedImages.length === 0 || !state.apiKey || summaryState.isProcessing ? 'disabled' : ''}>
                        ${summaryState.isProcessing ? 'üîÑ Generando Resumen...' : 'ü§ñ Generar Resumen'}
                    </button>
                    
                    ${summaryState.isProcessing ? `
                        <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; text-align: center;">
                            <span style="color: #92400e;">üîÑ Procesando imagen y generando resumen...</span>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px;">
                        <h4 style="color: #0c4a6e; margin-bottom: 10px;">üí° Consejos para mejores res√∫menes</h4>
                        <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #0369a1;">
                            <li>Usa im√°genes con texto claro y legible</li>
                            <li>Evita im√°genes muy peque√±as o borrosas</li>
                            <li>Funciona mejor con documentos, art√≠culos, o capturas de pantalla</li>
                            <li>El resumen se adaptar√° al tipo de contenido detectado</li>
                        </ul>
                    </div>
                </div>

                <div class="column">
                    <h3 style="margin-bottom: 15px;">üìù Resumen Generado</h3>
                    <textarea id="generatedSummary" class="textarea" placeholder="El resumen aparecer√° aqu√≠ una vez que proceses una imagen..." readonly>${summaryState.generatedSummary}</textarea>
                    
                    ${summaryState.generatedSummary ? `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                            <button onclick="copySummaryToClipboard()" class="btn btn-info" style="width: 100%; padding: 8px; font-size: 13px;">
                                üìã Copiar al Portapapeles
                            </button>
                            <button onclick="clearSummary()" class="btn btn-secondary" style="width: 100%; padding: 8px; font-size: 13px;">
                                üóëÔ∏è Limpiar Resumen
                            </button>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 15px; background: #f0fdf4; border: 2px solid #22c55e; border-radius: 8px;">
                            <h4 style="color: #166534; margin-bottom: 10px;">‚úÖ ¬°Resumen generado exitosamente!</h4>
                            <p style="margin: 0; font-size: 13px; color: #16a34a;">
                                Puedes copiar el texto, procesarlo nuevamente, o subir una nueva imagen.
                            </p>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    // Asegurar que las funciones auxiliares est√©n definidas
    function backToIntermediateScreen() {
        showIntermediateScreen = true;
        state.currentTab = 'upload';
        render();
    }
    
    function removeSummaryImage() {
        summaryState.selectedImages = [];
        summaryState.generatedSummary = '';
        render();
        showMessage('Imagen eliminada', 'success');
    }
    
    async function generateSummary() {
        if (!state.apiKey) {
            showMessage('Configura tu API key primero', 'error');
            return;
        }

        if (summaryState.selectedImages.length === 0) {
            showMessage('Selecciona una imagen primero', 'error');
            return;
        }

        summaryState.isProcessing = true;
        render();
        showMessage('Generando resumen...', 'success');
        
        try {
            const file = summaryState.selectedImages[0];
            const base64 = await fileToBase64(file);
            
            const messageContent = [
                {
                    type: "image",
                    source: {
                        type: "base64",
                        media_type: file.type,
                        data: base64
                    }
                },
                {
                    type: "text",
                    text: `Act√∫a como un asistente experto en an√°lisis y s√≠ntesis de informaci√≥n. Analiza esta imagen y genera un resumen completo e inteligente del contenido.

INSTRUCCIONES PARA EL RESUMEN:

üéØ OBJETIVO: Crear un resumen estructurado, claro y √∫til que capture la esencia del contenido

üìã FORMATO DEL RESUMEN:
‚Ä¢ Comienza con una breve descripci√≥n del tipo de documento/contenido
‚Ä¢ Organiza la informaci√≥n en secciones l√≥gicas con encabezados
‚Ä¢ Usa vi√±etas y numeraci√≥n cuando sea apropiado
‚Ä¢ Incluye los puntos m√°s importantes y relevantes
‚Ä¢ Termina con conclusiones o puntos clave si es relevante

üîç QU√â INCLUIR:
- Ideas principales y conceptos clave
- Datos importantes, cifras, fechas relevantes
- Argumentos o puntos de vista presentados
- Conclusiones o recomendaciones si las hay
- Cualquier informaci√≥n pr√°ctica o accionable

‚ú® ESTILO:
- Lenguaje claro y profesional
- Oraciones concisas pero informativas  
- Estructura f√°cil de leer y escanear
- Adapta el tono al tipo de contenido (acad√©mico, empresarial, t√©cnico, etc.)

üö´ EVITA:
- Repetir informaci√≥n innecesaria
- Incluir detalles muy t√©cnicos a menos que sean cruciales
- Hacer el resumen demasiado largo (m√°ximo 500 palabras)
- Copiar texto textualmente sin reorganizar

Genera un resumen que sea verdaderamente √∫til para alguien que quiere entender r√°pidamente el contenido esencial del documento.`
                }
            ];

            const response = await fetch("/api/anthropic", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-api-key": state.apiKey,
                },
                body: JSON.stringify({
                    model: "claude-sonnet-4-20250514",
                    max_tokens: 2000,
                    messages: [{
                        role: "user",
                        content: messageContent
                    }]
                })
            });

            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            summaryState.generatedSummary = data.content[0].text;
            summaryState.isProcessing = false;
            
            render();
            showMessage('¬°Resumen generado exitosamente!', 'success');
            
        } catch (error) {
            summaryState.isProcessing = false;
            render();
            showMessage(`Error al generar resumen: ${error.message}`, 'error');
        }
    }
    
    async function copySummaryToClipboard() {
        try {
            await navigator.clipboard.writeText(summaryState.generatedSummary);
            showMessage('Resumen copiado al portapapeles', 'success');
        } catch (error) {
            const textArea = document.createElement('textarea');
            textArea.value = summaryState.generatedSummary;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showMessage('Resumen copiado al portapapeles', 'success');
            } catch (err) {
                showMessage('Error al copiar. Selecciona y copia manualmente', 'error');
            }
            document.body.removeChild(textArea);
        }
    }
    
    function clearSummary() {
        if (confirm('¬øLimpiar el resumen generado?')) {
            summaryState.generatedSummary = '';
            render();
            showMessage('Resumen limpiado', 'success');
        }
    }
    
    // Asegurar que summaryState est√© definido
    if (typeof summaryState === 'undefined') {
        window.summaryState = {
            selectedImages: [],
            generatedSummary: '',
            isProcessing: false
        };
    }
    
    // Event listener para selecci√≥n de im√°genes
    document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'summaryImageInput') {
            const files = Array.from(e.target.files);
            const imageFile = files.filter(file => file.type.startsWith('image/'))[0];
            
            if (imageFile) {
                summaryState.selectedImages = [imageFile];
                summaryState.generatedSummary = '';
                render();
                showMessage('Imagen seleccionada correctamente', 'success');
            }
        }
    });
    
    console.log('üîß PARCHE URGENTE aplicado - Funci√≥n renderSummaryTab definida correctamente');
</script>
    <!-- 
PARCHE COMPLETO: SISTEMA DE RES√öMENES INDEPENDIENTE CON TEMAS
A√±adir este c√≥digo AL FINAL del archivo index.html, justo antes de </body>
Este parche reemplaza el sistema de res√∫menes con uno completo e independiente
-->

<script>
    // ========== PARCHE COMPLETO: SISTEMA DE RES√öMENES CON TEMAS ==========
    
    // Estado espec√≠fico para el sistema de res√∫menes
    let summarySystemState = {
        selectedImages: [],
        generatedSummary: '',
        isProcessing: false,
        summaryTopics: JSON.parse(localStorage.getItem('summaryTopics') || '[]'),
        savedSummaries: JSON.parse(localStorage.getItem('savedSummaries') || '[]'),
        selectedTopicForSummary: null,
        currentView: 'create', // 'create' | 'library'
        viewingSummary: null
    };
    
    // REEMPLAZAR completamente la funci√≥n renderSummaryTab
    function renderSummaryTab() {
        if (summarySystemState.currentView === 'library') {
            return renderSummaryLibrary();
        } else if (summarySystemState.viewingSummary) {
            return renderViewSummary();
        } else {
            return renderCreateSummary();
        }
    }
    
    // Funci√≥n para renderizar la creaci√≥n de res√∫menes
    function renderCreateSummary() {
        return `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h2 style="color: #1f2937; margin: 0;">üìÑ Crear Nuevo Resumen</h2>
                    <p style="color: #6b7280; margin: 5px 0 0 0; font-size: 14px;">Sube una imagen y obt√©n un resumen inteligente del contenido</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="showSummaryLibrary()" class="btn btn-info">
                        üìö Ver Biblioteca
                    </button>
                    <button onclick="backToIntermediateScreen()" class="btn btn-secondary">
                        ‚Üê Volver al Men√∫ Principal
                    </button>
                </div>
            </div>
            
            <div class="three-column">
                <div class="column">
                    <h3 style="margin-bottom: 15px;">üì§ Subir Imagen para Resumir</h3>
                    <div class="upload-area" onclick="document.getElementById('summaryImageInput').click()">
                        <div>üì∑ Seleccionar imagen</div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Una imagen por vez</div>
                        <div style="margin-top: 10px; color: #4f46e5; font-weight: 500;">
                            ${summarySystemState.selectedImages.length}/1 archivo
                        </div>
                    </div>
                    <input type="file" id="summaryImageInput" style="display: none;" accept="image/*">
                    
                    ${summarySystemState.selectedImages.length > 0 ? `
                        <div style="margin-bottom: 15px; padding: 15px; background: #f3f4f6; border-radius: 8px; text-align: center;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 12px; word-break: break-all; flex: 1;">${summarySystemState.selectedImages[0].name}</div>
                                <button onclick="removeSummaryImage()" style="background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; cursor: pointer; margin-left: 10px;">√ó</button>
                            </div>
                        </div>
                    ` : ''}
                    
                    <button onclick="generateSummary()" class="btn btn-primary" style="width: 100%; margin-bottom: 15px;" ${summarySystemState.selectedImages.length === 0 || !state.apiKey || summarySystemState.isProcessing ? 'disabled' : ''}>
                        ${summarySystemState.isProcessing ? 'üîÑ Generando Resumen...' : 'ü§ñ Generar Resumen'}
                    </button>
                    
                    ${summarySystemState.isProcessing ? `
                        <div style="margin-bottom: 15px; padding: 15px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; text-align: center;">
                            <span style="color: #92400e;">üîÑ Procesando imagen y generando resumen...</span>
                        </div>
                    ` : ''}
                    
                    <!-- Gesti√≥n de Temas para Res√∫menes -->
                    <div style="padding: 15px; background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px;">
                        <h4 style="color: #0c4a6e; margin-bottom: 15px;">üè∑Ô∏è Organizar por Temas</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <button onclick="createSummaryTopic()" class="btn btn-info" style="width: 100%; padding: 8px; font-size: 13px;">
                                üÜï Crear Tema
                            </button>
                            
                            <select id="summary-topic-selector" onchange="updateSelectedSummaryTopic()" style="width: 100%; padding: 8px; border: none; background: #0ea5e9; color: white; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer;" ${summarySystemState.summaryTopics.length === 0 ? 'disabled' : ''}>
                                <option value="">üìÇ Seleccionar Tema</option>
                                ${summarySystemState.summaryTopics.map(topic => `
                                    <option value="${topic.id}" ${summarySystemState.selectedTopicForSummary === topic.id ? 'selected' : ''}>
                                        ${topic.name} (${getSummaryTopicCount(topic.id)})
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        ${summarySystemState.summaryTopics.length === 0 ? `
                            <div style="font-size: 12px; color: #0c4a6e; font-style: italic; text-align: center;">
                                Crea temas para organizar tus res√∫menes
                            </div>
                        ` : ''}
                    </div>
                </div>

                <div class="column">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">üìù Resumen Generado</h3>
                        ${summarySystemState.generatedSummary ? `
                            <button onclick="saveSummaryToLibrary()" class="btn btn-success" style="padding: 6px 12px; font-size: 12px;">
                                üíæ Guardar
                            </button>
                        ` : ''}
                    </div>
                    
                    <textarea id="generatedSummary" class="textarea" placeholder="El resumen aparecer√° aqu√≠ una vez que proceses una imagen..." readonly>${summarySystemState.generatedSummary}</textarea>
                    
                    ${summarySystemState.generatedSummary ? `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                            <button onclick="copySummaryToClipboard()" class="btn btn-info" style="width: 100%; padding: 8px; font-size: 13px;">
                                üìã Copiar al Portapapeles
                            </button>
                            <button onclick="clearCurrentSummary()" class="btn btn-secondary" style="width: 100%; padding: 8px; font-size: 13px;">
                                üóëÔ∏è Limpiar Resumen
                            </button>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 15px; background: #f0fdf4; border: 2px solid #22c55e; border-radius: 8px;">
                            <h4 style="color: #166534; margin-bottom: 10px;">‚úÖ ¬°Resumen generado exitosamente!</h4>
                            <p style="margin: 0; font-size: 13px; color: #16a34a;">
                                Puedes guardar este resumen, copiarlo al portapapeles, o crear uno nuevo.
                            </p>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    // Funci√≥n para renderizar la biblioteca de res√∫menes
    function renderSummaryLibrary() {
        return `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h2 style="color: #1f2937; margin: 0;">üìö Biblioteca de Res√∫menes</h2>
                    <p style="color: #6b7280; margin: 5px 0 0 0; font-size: 14px;">Explora tus res√∫menes organizados por temas</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="showCreateSummary()" class="btn btn-primary">
                        ‚ûï Crear Nuevo
                    </button>
                    <button onclick="backToIntermediateScreen()" class="btn btn-secondary">
                        ‚Üê Volver al Men√∫ Principal
                    </button>
                </div>
            </div>
            
            ${summarySystemState.savedSummaries.length === 0 ? `
                <div style="text-align: center; padding: 80px; color: #9ca3af;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üìÑ</div>
                    <h3 style="color: #6b7280; margin-bottom: 15px;">No hay res√∫menes guardados</h3>
                    <p style="color: #9ca3af; margin-bottom: 30px;">Crea tu primer resumen para comenzar tu biblioteca</p>
                    <button onclick="showCreateSummary()" class="btn btn-primary" style="font-size: 1.1rem; padding: 15px 30px;">
                        üìÑ Crear Primer Resumen
                    </button>
                </div>
            ` : renderSummariesByTopic()}
        `;
    }
    
    // Funci√≥n para renderizar res√∫menes agrupados por tema
    function renderSummariesByTopic() {
        const summariesWithoutTopic = summarySystemState.savedSummaries.filter(s => !s.topicId);
        let html = '';
        
        // Control de temas
        if (summarySystemState.summaryTopics.length > 0) {
            html += `
                <div style="margin-bottom: 30px; padding: 20px; background: #f8fafc; border-radius: 12px; border: 2px solid #e2e8f0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="color: #374151; margin: 0 0 5px 0;">Control de Biblioteca</h3>
                            <p style="color: #6b7280; margin: 0; font-size: 14px;">Tienes ${summarySystemState.savedSummaries.length} res√∫men${summarySystemState.savedSummaries.length === 1 ? '' : 'es'} en ${summarySystemState.summaryTopics.length} tema${summarySystemState.summaryTopics.length === 1 ? '' : 's'}</p>
                        </div>
                        <button onclick="clearAllSummaries()" class="btn btn-danger" style="padding: 8px 16px;">
                            üóëÔ∏è Limpiar Todo
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Mostrar res√∫menes por cada tema que TENGA res√∫menes
        summarySystemState.summaryTopics.forEach(topic => {
            const topicSummaries = summarySystemState.savedSummaries.filter(s => s.topicId && s.topicId.toString() === topic.id.toString());
            if (topicSummaries.length > 0) {
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="background: linear-gradient(135deg, #059669, #0ea5e9); color: white; padding: 15px 20px; border-radius: 12px 12px 0 0; margin: 0; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <span style="display: flex; align-items: center; gap: 10px;">
                                <span>üìÇ</span>
                                <span>${topic.name}</span>
                            </span>
                            <span style="font-size: 14px; opacity: 0.9; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px;">
                                ${topicSummaries.length} res√∫men${topicSummaries.length === 1 ? '' : 'es'}
                            </span>
                        </h3>
                        <div style="background: white; border: 2px solid #e2e8f0; border-top: none; border-radius: 0 0 12px 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <div style="display: grid; gap: 0;">
                                ${topicSummaries.map((summary, index) => renderSingleSummary(summary, index)).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
        });
        
        // Mostrar res√∫menes sin tema asignado SI existen
        if (summariesWithoutTopic.length > 0) {
            html += `
                <div style="margin-bottom: 30px;">
                    <h3 style="background: #6b7280; color: white; padding: 15px 20px; border-radius: 12px 12px 0 0; margin: 0; display: flex; justify-content: space-between; align-items: center;">
                        <span style="display: flex; align-items: center; gap: 10px;">
                            <span>üìÑ</span>
                            <span>Sin tema asignado</span>
                        </span>
                        <span style="font-size: 14px; opacity: 0.9; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px;">
                            ${summariesWithoutTopic.length} res√∫men${summariesWithoutTopic.length === 1 ? '' : 'es'}
                        </span>
                    </h3>
                    <div style="background: white; border: 2px solid #e2e8f0; border-top: none; border-radius: 0 0 12px 12px;">
                        <div style="display: grid; gap: 0;">
                            ${summariesWithoutTopic.map((summary, index) => renderSingleSummary(summary, index)).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        if (html === '') {
            return '<div style="padding: 40px; text-align: center; color: #9ca3af;">No hay res√∫menes disponibles en la biblioteca</div>';
        }
        
        return html;
    }
    
    // Funci√≥n para renderizar un resumen individual
    function renderSingleSummary(summary, index) {
        const actualIndex = summarySystemState.savedSummaries.findIndex(s => s.id === summary.id);
        const topicName = summary.topicId ? getSummaryTopicName(summary.topicId) : null;
        
        return `
            <div style="padding: 20px; border-bottom: 1px solid #f3f4f6; transition: all 0.2s; cursor: pointer;" 
                 onmouseover="this.style.backgroundColor='#f9fafb';" 
                 onmouseout="this.style.backgroundColor='white';"
                 onclick="viewSummary(${actualIndex})">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1; margin-right: 15px;">
                        <h4 style="margin: 0 0 8px 0; color: #1f2937; font-size: 16px; font-weight: 600;">
                            ${summary.title}
                        </h4>
                        <p style="margin: 0 0 8px 0; color: #6b7280; font-size: 14px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                            ${summary.content.substring(0, 120)}...
                        </p>
                        <div style="display: flex; align-items: center; gap: 15px; font-size: 12px; color: #9ca3af;">
                            <span>üìÖ ${summary.createdAt}</span>
                            ${topicName && !summary.topicId ? `` : ''}
                            <span>${summary.content.length} caracteres</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: flex-start;">
                        <button onclick="event.stopPropagation(); editSummary(${actualIndex})" class="btn btn-warning" style="padding: 6px 12px; font-size: 11px;" title="Editar resumen">
                            ‚úèÔ∏è
                        </button>
                        <button onclick="event.stopPropagation(); deleteSummary(${actualIndex})" class="btn btn-danger" style="padding: 6px 12px; font-size: 11px;" title="Eliminar resumen">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Funci√≥n para renderizar la visualizaci√≥n de un resumen espec√≠fico
    function renderViewSummary() {
        const summary = summarySystemState.viewingSummary;
        const topicName = summary.topicId ? getSummaryTopicName(summary.topicId) : 'Sin tema';
        
        return `
            <div style="max-width: 1000px; margin: 0 auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <div>
                        <button onclick="closeSummaryView()" class="btn btn-secondary" style="margin-bottom: 15px;">
                            ‚Üê Volver a la Biblioteca
                        </button>
                        <h1 style="color: #1f2937; margin: 0; font-size: 2rem;">${summary.title}</h1>
                        <div style="margin-top: 10px; display: flex; align-items: center; gap: 20px; color: #6b7280; font-size: 14px;">
                            <span>üìÇ ${topicName}</span>
                            <span>üìÖ ${summary.createdAt}</span>
                            <span>üìù ${summary.content.length} caracteres</span>
                        </div>
                    </div>
                </div>
                
                <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
                    <div style="prose max-w-none;">
                        <div style="white-space: pre-wrap; line-height: 1.7; color: #374151; font-size: 16px;">
                            ${summary.content}
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px; display: flex; justify-content: center; gap: 15px;">
                    <button onclick="copySummaryContentToClipboard('${summary.id}')" class="btn btn-info" style="padding: 12px 24px;">
                        üìã Copiar Contenido
                    </button>
                    <button onclick="editSummaryFromView()" class="btn btn-warning" style="padding: 12px 24px;">
                        ‚úèÔ∏è Editar Resumen
                    </button>
                    <button onclick="deleteSummaryFromView('${summary.id}')" class="btn btn-danger" style="padding: 12px 24px;">
                        üóëÔ∏è Eliminar Resumen
                    </button>
                </div>
            </div>
        `;
    }
    
    // ========== FUNCIONES DE GESTI√ìN ==========
    
    function showCreateSummary() {
        summarySystemState.currentView = 'create';
        summarySystemState.viewingSummary = null;
        render();
    }
    
    function showSummaryLibrary() {
        summarySystemState.currentView = 'library';
        summarySystemState.viewingSummary = null;
        render();
    }
    
    function createSummaryTopic() {
        const name = prompt('Nombre del nuevo tema de res√∫menes:');
        if (name && name.trim()) {
            const newTopic = {
                id: Date.now() + Math.random(),
                name: name.trim(),
                createdAt: new Date().toLocaleString('es-ES')
            };
            
            summarySystemState.summaryTopics.push(newTopic);
            localStorage.setItem('summaryTopics', JSON.stringify(summarySystemState.summaryTopics));
            render();
            showMessage(`Tema "${name}" creado exitosamente`, 'success');
        }
    }
    
    function updateSelectedSummaryTopic() {
        const selector = document.getElementById('summary-topic-selector');
        if (selector && selector.value) {
            const selectedValue = selector.value;
            const selectedTopic = summarySystemState.summaryTopics.find(t => t.id == selectedValue);
            if (selectedTopic) {
                summarySystemState.selectedTopicForSummary = selectedTopic.id;
                showMessage(`Tema "${selectedTopic.name}" seleccionado`, 'success');
            } else {
                summarySystemState.selectedTopicForSummary = selectedValue;
            }
        } else {
            summarySystemState.selectedTopicForSummary = null;
        }
    }
    
    function getSummaryTopicName(topicId) {
        if (!topicId) return 'Sin tema';
        const topic = summarySystemState.summaryTopics.find(t => t.id.toString() === topicId.toString());
        return topic ? topic.name : 'Tema no encontrado';
    }
    
    function getSummaryTopicCount(topicId) {
        return summarySystemState.savedSummaries.filter(s => s.topicId && s.topicId.toString() === topicId.toString()).length;
    }
    
    function saveSummaryToLibrary() {
        if (!summarySystemState.generatedSummary) {
            showMessage('No hay resumen para guardar', 'error');
            return;
        }
        
        const title = prompt('T√≠tulo para el resumen:') || 'Resumen sin t√≠tulo';
        if (!title.trim()) return;
        
        const newSummary = {
            id: Date.now() + Math.random(),
            title: title.trim(),
            content: summarySystemState.generatedSummary,
            topicId: summarySystemState.selectedTopicForSummary,
            createdAt: new Date().toLocaleString('es-ES')
        };
        
        summarySystemState.savedSummaries.push(newSummary);
        localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
        
        const topicName = summarySystemState.selectedTopicForSummary ? getSummaryTopicName(summarySystemState.selectedTopicForSummary) : 'sin tema';
        showMessage(`Resumen "${title}" guardado en ${topicName}`, 'success');
        
        // Limpiar formulario despu√©s de guardar
        summarySystemState.selectedImages = [];
        summarySystemState.generatedSummary = '';
        summarySystemState.selectedTopicForSummary = null;
        render();
    }
    
    function viewSummary(index) {
        summarySystemState.viewingSummary = summarySystemState.savedSummaries[index];
        render();
    }
    
    function closeSummaryView() {
        summarySystemState.viewingSummary = null;
        summarySystemState.currentView = 'library';
        render();
    }
    
    function editSummary(index) {
        // Implementaci√≥n de edici√≥n de resumen
        const summary = summarySystemState.savedSummaries[index];
        const newTitle = prompt('Nuevo t√≠tulo:', summary.title);
        if (newTitle && newTitle.trim()) {
            summarySystemState.savedSummaries[index].title = newTitle.trim();
            localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
            render();
            showMessage('Resumen actualizado', 'success');
        }
    }
    
    function deleteSummary(index) {
        const summary = summarySystemState.savedSummaries[index];
        if (confirm(`¬øEliminar el resumen "${summary.title}"?`)) {
            summarySystemState.savedSummaries.splice(index, 1);
            localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
            render();
            showMessage('Resumen eliminado', 'success');
        }
    }
    
    function clearAllSummaries() {
        if (confirm('¬øEliminar todos los res√∫menes y temas? Esta acci√≥n no se puede deshacer.')) {
            summarySystemState.savedSummaries = [];
            summarySystemState.summaryTopics = [];
            localStorage.setItem('savedSummaries', JSON.stringify(summarySystemState.savedSummaries));
            localStorage.setItem('summaryTopics', JSON.stringify(summarySystemState.summaryTopics));
            render();
            showMessage('Biblioteca de res√∫menes limpiada', 'success');
        }
    }
    
    function copySummaryContentToClipboard(summaryId) {
        const summary = summarySystemState.savedSummaries.find(s => s.id == summaryId);
        if (summary) {
            navigator.clipboard.writeText(summary.content).then(() => {
                showMessage('Contenido copiado al portapapeles', 'success');
            }).catch(() => {
                showMessage('Error al copiar', 'error');
            });
        }
    }
    
    // Funciones auxiliares redefinidas
    function removeSummaryImage() {
        summarySystemState.selectedImages = [];
        summarySystemState.generatedSummary = '';
        render();
        showMessage('Imagen eliminada', 'success');
    }
    
    function clearCurrentSummary() {
        if (confirm('¬øLimpiar el resumen actual?')) {
            summarySystemState.generatedSummary = '';
            render();
            showMessage('Resumen limpiado', 'success');
        }
    }
    
    async function generateSummary() {
        if (!state.apiKey) {
            showMessage('Configura tu API key primero', 'error');
            return;
        }

        if (summarySystemState.selectedImages.length === 0) {
            showMessage('Selecciona una imagen primero', 'error');
            return;
        }

        summarySystemState.isProcessing = true;
        render();
        showMessage('Generando resumen...', 'success');
        
        try {
            const file = summarySystemState.selectedImages[0];
            const base64 = await fileToBase64(file);
            
            const messageContent = [
                {
                    type: "image",
                    source: {
                        type: "base64",
                        media_type: file.type,
                        data: base64
                    }
                },
                {
                    type: "text",
                    text: `Act√∫a como un asistente experto en an√°lisis y s√≠ntesis de informaci√≥n. Analiza esta imagen y genera un resumen completo e inteligente del contenido.

INSTRUCCIONES PARA EL RESUMEN:

üéØ OBJETIVO: Crear un resumen estructurado, claro y √∫til que capture la esencia del contenido

üìã FORMATO DEL RESUMEN:
‚Ä¢ Comienza con una breve descripci√≥n del tipo de documento/contenido
‚Ä¢ Organiza la informaci√≥n en secciones l√≥gicas con encabezados
‚Ä¢ Usa vi√±etas y numeraci√≥n cuando sea apropiado
‚Ä¢ Incluye los puntos m√°s importantes y relevantes
‚Ä¢ Termina con conclusiones o puntos clave si es relevante

üîç QU√â INCLUIR:
- Ideas principales y conceptos clave
- Datos importantes, cifras, fechas relevantes
- Argumentos o puntos de vista presentados
- Conclusiones o recomendaciones si las hay
- Cualquier informaci√≥n pr√°ctica o accionable

‚ú® ESTILO:
- Lenguaje claro y profesional
- Oraciones concisas pero informativas  
- Estructura f√°cil de leer y escanear
- Adapta el tono al tipo de contenido (acad√©mico, empresarial, t√©cnico, etc.)

üö´ EVITA:
- Repetir informaci√≥n innecesaria
- Incluir detalles muy t√©cnicos a menos que sean cruciales
- Hacer el resumen demasiado largo (m√°ximo 500 palabras)
- Copiar texto textualmente sin reorganizar

Genera un resumen que sea verdaderamente √∫til para alguien que quiere entender r√°pidamente el contenido esencial del documento.`
                }
            ];

            const response = await fetch("/api/anthropic", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-api-key": state.apiKey,
                },
                body: JSON.stringify({
                    model: "claude-sonnet-4-20250514",
                    max_tokens: 2000,
                    messages: [{
                        role: "user",
                        content: messageContent
                    }]
                })
            });

            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            summarySystemState.generatedSummary = data.content[0].text;
            summarySystemState.isProcessing = false;
            
            render();
            showMessage('¬°Resumen generado exitosamente!', 'success');
            
        } catch (error) {
            summarySystemState.isProcessing = false;
            render();
            showMessage(`Error al generar resumen: ${error.message}`, 'error');
        }
    }
    
    async function copySummaryToClipboard() {
        try {
            await navigator.clipboard.writeText(summarySystemState.generatedSummary);
            showMessage('Resumen copiado al portapapeles', 'success');
        } catch (error) {
            const textArea = document.createElement('textarea');
            textArea.value = summarySystemState.generatedSummary;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showMessage('Resumen copiado al portapapeles', 'success');
            } catch (err) {
                showMessage('Error al copiar', 'error');
            }
            document.body.removeChild(textArea);
        }
    }
    
    // Event listener para selecci√≥n de im√°genes (actualizado)
    document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'summaryImageInput') {
            const files = Array.from(e.target.files);
            const imageFile = files.filter(file => file.type.startsWith('image/'))[0];
            
            if (imageFile) {
                summarySystemState.selectedImages = [imageFile];
                summarySystemState.generatedSummary = '';
                render();
                showMessage('Imagen seleccionada correctamente', 'success');
            }
        }
    });
    
    console.log('‚úÖ Sistema de Res√∫menes Completo con Temas aplicado correctamente');
</script>
</body>
</html>










