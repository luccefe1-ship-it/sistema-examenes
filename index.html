<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Ex√°menes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .title {
            font-size: 2rem;
            font-weight: bold;
            color: #2d3748;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            margin: 5px;
        }

        .btn-primary { background: #4f46e5; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-info { background: #0ea5e9; color: white; }

        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

        .nav-tabs {
            display: flex;
            margin-bottom: 30px;
            background: #f8fafc;
            border-radius: 12px;
            padding: 5px;
        }

        .nav-tab {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: white;
            color: #4f46e5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            font-weight: 500;
            margin-bottom: 5px;
            color: #374151;
            display: block;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .success { 
            background: #d1fae5; 
            color: #065f46; 
            border-color: #10b981; 
        }

        .error { 
            background: #fee2e2; 
            color: #991b1b; 
            border-color: #ef4444; 
        }

        .topic-section {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .three-column {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .column {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e2e8f0;
        }

        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .three-column {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Variables globales
        let state = {
            currentUser: null,
            currentTab: 'upload',
            apiKey: localStorage.getItem('anthropic_api_key') || '',
            questions: JSON.parse(localStorage.getItem('questions') || '[]'),
            topics: JSON.parse(localStorage.getItem('topics') || '[]'),
            selectedImages: [],
            transcribedText: '',
            cleanedText: '',
            selectedTopicForNewQuestions: null,
            selectedTopicFilter: 'all',
            currentTest: null
        };

        const users = {
            'demo': { password: 'demo123', name: 'Usuario Demo' }
        };

        // Funci√≥n principal de renderizado
        function render() {
            const app = document.getElementById('app');
            
            if (!state.currentUser) {
                app.innerHTML = `
                    <div class="container">
                        <div class="login-form">
                            <h2 style="text-align: center; margin-bottom: 30px;">Iniciar Sesi√≥n</h2>
                            <div class="form-group">
                                <label class="form-label">Usuario</label>
                                <input type="text" id="username" class="form-input" placeholder="demo">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contrase√±a</label>
                                <input type="password" id="password" class="form-input" placeholder="demo123">
                            </div>
                            <button onclick="login()" class="btn btn-primary" style="width: 100%;">
                                Iniciar Sesi√≥n
                            </button>
                            <div style="text-align: center; margin-top: 15px; color: #6b7280; font-size: 14px;">
                                Usuario: demo | Contrase√±a: demo123
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <div class="title">Sistema de Ex√°menes</div>
                        <div>
                            <span style="color: ${state.apiKey ? '#10b981' : '#ef4444'};">
                                ${state.apiKey ? '‚úÖ API Configurada' : '‚ùå Sin API'}
                            </span>
                            <button onclick="configureAPI()" class="btn btn-secondary">API</button>
                            <span style="color: #f59e0b;">üë§ ${state.currentUser.name}</span>
                            <button onclick="logout()" class="btn btn-danger">Salir</button>
                        </div>
                    </div>

                    <div class="nav-tabs">
                        <button class="nav-tab ${state.currentTab === 'upload' ? 'active' : ''}" onclick="setTab('upload')">
                            üì§ Subir Test
                        </button>
                        <button class="nav-tab ${state.currentTab === 'questions' ? 'active' : ''}" onclick="setTab('questions')">
                            üìã Preguntas (${getFilteredQuestions().length})
                        </button>
                        <button class="nav-tab ${state.currentTab === 'test' ? 'active' : ''}" onclick="setTab('test')">
                            üéØ Test Aleatorio
                        </button>
                    </div>

                    <div id="messages"></div>

                    ${renderTabContent()}
                </div>
            `;
        }

        function renderTabContent() {
            switch(state.currentTab) {
                case 'upload':
                    return renderUploadTab();
                case 'questions':
                    return renderQuestionsTab();
                case 'test':
                    return renderTestTab();
                default:
                    return '<div>Error: Pesta√±a no encontrada</div>';
            }
        }

        function renderUploadTab() {
            return `
                <div class="three-column">
                    <div class="column">
                        <h3 style="margin-bottom: 15px;">üì§ Subir Im√°genes</h3>
                        <div class="upload-area" onclick="document.getElementById('imageInput').click()">
                            <div>üìÅ Seleccionar im√°genes</div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Hasta 10 im√°genes</div>
                            <div style="margin-top: 10px; color: #4f46e5; font-weight: 500;">
                                ${state.selectedImages.length}/10 archivos
                            </div>
                        </div>
                        <input type="file" id="imageInput" style="display: none;" accept="image/*" multiple>
                        
                        ${state.selectedImages.length > 0 ? `
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                                ${state.selectedImages.map((file, i) => `
                                    <div style="position: relative; text-align: center; padding: 10px; background: #f3f4f6; border-radius: 8px;">
                                        <button onclick="removeImage(${i})" style="position: absolute; top: 5px; right: 5px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer;">√ó</button>
                                        <div style="font-size: 10px; word-break: break-all;">${file.name}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <button onclick="transcribeImages()" class="btn btn-primary" style="width: 100%;" ${state.selectedImages.length === 0 || !state.apiKey ? 'disabled' : ''}>
                            ü§ñ 1. Transcribir Im√°genes
                        </button>
                    </div>

                    <div class="column">
                        <h3 style="margin-bottom: 15px;">üìù Texto Extra√≠do</h3>
                        <textarea id="transcribedText" class="textarea" placeholder="El texto transcrito aparecer√° aqu√≠..." readonly>${state.transcribedText}</textarea>
                        <button onclick="cleanText()" class="btn btn-primary" style="width: 100%; margin-top: 10px;" ${!state.transcribedText || !state.apiKey ? 'disabled' : ''}>
                            üßπ 2. Limpiar Texto
                        </button>
                    </div>

                    <div class="column">
                        <h3 style="margin-bottom: 15px;">‚ú® Texto Limpio</h3>
                        <textarea id="cleanedText" class="textarea" placeholder="El texto limpio aparecer√° aqu√≠..." readonly>${state.cleanedText}</textarea>
                        
                        <!-- NUEVA SECCI√ìN DE GESTI√ìN DE TEMAS -->
                        <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px;">
                            <h4 style="color: #92400e; margin-bottom: 10px;">üè∑Ô∏è Gesti√≥n de Temas</h4>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                <button onclick="createTopic()" class="btn btn-info" style="width: 100%; padding: 8px; font-size: 13px;">
                                    üÜï Crear Tema
                                </button>
                                <button onclick="showTopicAssignmentModal()" class="btn btn-warning" style="width: 100%; padding: 8px; font-size: 13px;" ${!state.cleanedText || state.topics.length === 0 ? 'disabled' : ''}>
                                    üè∑Ô∏è Asignar Tema
                                </button>
                            </div>
                            
                            ${state.topics.length > 0 ? `
                                <div style="font-size: 12px; color: #78350f;">
                                    <strong>Temas creados:</strong><br>
                                    ${state.topics.map(topic => `‚Ä¢ ${topic.name} (${getTopicQuestionCount(topic.id)} preguntas)`).join('<br>')}
                                </div>
                            ` : `
                                <div style="font-size: 12px; color: #78350f; font-style: italic;">
                                    No hay temas creados. Crea uno para organizar tus preguntas.
                                </div>
                            `}
                        </div>
                        
                        <button onclick="addToQuestions()" class="btn btn-success" style="width: 100%; margin-top: 10px;" ${!state.cleanedText ? 'disabled' : ''}>
                            ‚úÖ 3. A√±adir al Banco
                        </button>
                    </div>
                </div>
            `;
        }

        function renderQuestionsTab() {
            const filteredQuestions = getFilteredQuestions();
            
            return `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Banco de Preguntas (${filteredQuestions.length})</h2>
                    <button onclick="clearQuestions()" class="btn btn-danger">Limpiar Todo</button>
                </div>

                ${state.topics.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <label style="margin-right: 10px; font-weight: 500;">Filtrar por tema:</label>
                        <select onchange="filterByTopic(this.value)" style="padding: 8px; border-radius: 6px; border: 1px solid #d1d5db;">
                            <option value="all" ${state.selectedTopicFilter === 'all' ? 'selected' : ''}>Todos los temas (${state.questions.length})</option>
                            ${state.topics.map(topic => `
                                <option value="${topic.id}" ${state.selectedTopicFilter === topic.id ? 'selected' : ''}>
                                    ${topic.name} (${getTopicQuestionCount(topic.id)})
                                </option>
                            `).join('')}
                        </select>
                    </div>
                ` : ''}

                <!-- NUEVA: Mostrar preguntas organizadas por tema -->
                ${state.topics.length > 0 && state.selectedTopicFilter === 'all' ? 
                    renderQuestionsByTopic() : 
                    renderQuestionsFiltered(filteredQuestions)
                }
            `;
        }

        function renderQuestionsByTopic() {
            // Preguntas sin tema
            const questionsWithoutTopic = state.questions.filter(q => !q.topicId);
            
            let html = '';
            
            // Mostrar cada tema con sus preguntas
            state.topics.forEach(topic => {
                const topicQuestions = state.questions.filter(q => q.topicId === topic.id);
                if (topicQuestions.length > 0) {
                    html += `
                        <div style="margin-bottom: 30px;">
                            <h3 style="background: #4f46e5; color: white; padding: 10px 15px; border-radius: 8px 8px 0 0; margin: 0; display: flex; justify-content: space-between; align-items: center;">
                                <span>üìÅ ${topic.name}</span>
                                <span style="font-size: 14px; opacity: 0.9;">${topicQuestions.length} preguntas</span>
                            </h3>
                            <div style="border: 1px solid #4f46e5; border-top: none; border-radius: 0 0 8px 8px; background: white;">
                                ${topicQuestions.map(q => {
                                    const actualIndex = state.questions.findIndex(question => question.id === q.id);
                                    return renderSingleQuestion(q, actualIndex);
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
            });
            
            // Preguntas sin tema al final
            if (questionsWithoutTopic.length > 0) {
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="background: #6b7280; color: white; padding: 10px 15px; border-radius: 8px 8px 0 0; margin: 0; display: flex; justify-content: space-between; align-items: center;">
                            <span>üìÇ Sin tema asignado</span>
                            <span style="font-size: 14px; opacity: 0.9;">${questionsWithoutTopic.length} preguntas</span>
                        </h3>
                        <div style="border: 1px solid #6b7280; border-top: none; border-radius: 0 0 8px 8px; background: white;">
                            ${questionsWithoutTopic.map(q => {
                                const actualIndex = state.questions.findIndex(question => question.id === q.id);
                                return renderSingleQuestion(q, actualIndex);
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            return html || '<div style="padding: 40px; text-align: center; color: #9ca3af;">No hay preguntas disponibles</div>';
        }

        function renderQuestionsFiltered(filteredQuestions) {
            return `
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; background: white;">
                    ${filteredQuestions.length === 0 ? 
                        '<div style="padding: 40px; text-align: center; color: #9ca3af;">No hay preguntas disponibles</div>' :
                        filteredQuestions.map(q => {
                            const actualIndex = state.questions.findIndex(question => question.id === q.id);
                            return renderSingleQuestion(q, actualIndex);
                        }).join('')
                    }
                </div>
            `;
        }

        function renderSingleQuestion(q, actualIndex) {
            const topicName = q.topicId ? getTopicName(q.topicId) : null;
            
            return `
                <div style="padding: 15px; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between;">
                    <div style="flex: 1;">
                        <div style="font-weight: 500; margin-bottom: 8px;">
                            ${q.question}
                            ${topicName && state.selectedTopicFilter !== q.topicId ? `<span style="background: #e0e7ff; color: #4f46e5; padding: 2px 6px; border-radius: 8px; font-size: 11px; margin-left: 8px;">${topicName}</span>` : ''}
                        </div>
                        <ul style="list-style: none; margin: 0; padding: 0;">
                            ${q.options.map((opt, optIndex) => `
                                <li style="padding: 2px 0; color: ${q.correctAnswer === optIndex ? '#059669' : '#6b7280'}; ${q.correctAnswer === optIndex ? 'font-weight: 500;' : ''}">
                                    ${String.fromCharCode(97 + optIndex)}) ${opt}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button onclick="editQuestion(${actualIndex})" class="btn btn-warning" style="padding: 5px 10px; font-size: 12px;">Editar</button>
                        <button onclick="deleteQuestion(${actualIndex})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">Eliminar</button>
                    </div>
                </div>
            `;
        }

        function showTopicAssignmentModal() {
            if (!state.cleanedText) {
                showMessage('Primero procesa el texto para poder asignar temas', 'error');
                return;
            }

            if (state.topics.length === 0) {
                showMessage('Primero crea al menos un tema', 'error');
                return;
            }

            // Crear modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); display: flex; justify-content: center;
                align-items: center; z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">
                    <h3 style="margin-bottom: 20px; color: #2d3748;">üè∑Ô∏è Asignar Tema a Preguntas</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <p style="color: #6b7280; margin-bottom: 15px;">
                            Selecciona el tema para las preguntas que ser√°n procesadas:
                        </p>
                        
                        <select id="topic-dropdown" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                            <option value="">-- Seleccionar tema --</option>
                            ${state.topics.map(topic => `
                                <option value="${topic.id}">
                                    ${topic.name} (${getTopicQuestionCount(topic.id)} preguntas existentes)
                                </option>
                            `).join('')}
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" class="btn btn-secondary">
                            Cancelar
                        </button>
                        <button onclick="confirmTopicAssignment()" class="btn btn-primary">
                            Asignar Tema
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Funci√≥n para confirmar asignaci√≥n
            window.confirmTopicAssignment = function() {
                const selectedTopicId = document.getElementById('topic-dropdown').value;
                if (!selectedTopicId) {
                    alert('Selecciona un tema');
                    return;
                }
                
                const topicName = getTopicName(selectedTopicId);
                state.selectedTopicForNewQuestions = selectedTopicId;
                
                modal.remove();
                showMessage(`Tema "${topicName}" seleccionado. Las preguntas se asignar√°n a este tema cuando las a√±adas al banco.`, 'success');
            };
        }

        function renderTestTab() {
            if (state.questions.length === 0) {
                return '<div style="text-align: center; padding: 40px;">A√±ade preguntas al banco para generar tests</div>';
            }

            if (!state.currentTest) {
                return `
                    ${state.topics.length > 0 ? `
                        <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <h3 style="color: #0c4a6e; margin-bottom: 15px;">üéØ Tipo de Test</h3>
                            <div style="display: grid; gap: 10px;">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="radio" name="test-type" value="all" checked>
                                    <span>Test General (${state.questions.length} preguntas)</span>
                                </label>
                                ${state.topics.map(topic => `
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="radio" name="test-type" value="${topic.id}">
                                        <span>${topic.name} (${getTopicQuestionCount(topic.id)} preguntas)</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div style="text-align: center; padding: 40px;">
                        <button onclick="startTest()" class="btn btn-primary" style="font-size: 1.2rem; padding: 15px 30px;">
                            üéØ Comenzar Test
                        </button>
                    </div>
                `;
            }

            return renderCurrentTest();
        }

        function renderCurrentTest() {
            const question = state.currentTest.questions[state.currentTest.currentQuestion];
            return `
                <div style="max-width: 800px; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                        <div>Pregunta ${state.currentTest.currentQuestion + 1} de ${state.currentTest.questions.length}</div>
                        <div id="timer" style="font-weight: bold; color: #ef4444;">‚è±Ô∏è ${formatTime(state.currentTest.timeLeft)}</div>
                    </div>
                    
                    <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="font-size: 1.1rem; font-weight: 500; margin-bottom: 15px;">
                            ${question.question}
                        </div>
                        
                        <div style="display: grid; gap: 10px;">
                            ${question.options.map((option, index) => `
                                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 8px; cursor: pointer; border: 1px solid #e5e7eb;">
                                    <input type="radio" name="answer" value="${index}" onchange="selectAnswer(${index})">
                                    <span>${String.fromCharCode(97 + index)}) ${option}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between;">
                        <button onclick="previousQuestion()" class="btn btn-secondary" ${state.currentTest.currentQuestion === 0 ? 'disabled' : ''}>
                            ‚Üê Anterior
                        </button>
                        <button onclick="nextQuestion()" class="btn btn-primary">
                            ${state.currentTest.currentQuestion === state.currentTest.questions.length - 1 ? 'Finalizar Test' : 'Siguiente ‚Üí'}
                        </button>
                    </div>
                </div>
            `;
        }

        // Event handlers
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (users[username] && users[username].password === password) {
                state.currentUser = users[username];
                render();
            } else {
                showMessage('Usuario o contrase√±a incorrectos', 'error');
            }
        }

        function logout() {
            state.currentUser = null;
            render();
        }

        function configureAPI() {
            const key = prompt('Ingresa tu API key de Anthropic:');
            if (key) {
                state.apiKey = key;
                localStorage.setItem('anthropic_api_key', key);
                render();
            }
        }

        function setTab(tab) {
            state.currentTab = tab;
            render();
        }

        function createTopic() {
            const name = prompt('Nombre del nuevo tema:');
            if (name && name.trim()) {
                const newTopic = {
                    id: Date.now() + Math.random(),
                    name: name.trim(),
                    createdAt: new Date().toISOString()
                };
                
                state.topics.push(newTopic);
                localStorage.setItem('topics', JSON.stringify(state.topics));
                render();
                showMessage(`Tema "${name}" creado exitosamente`, 'success');
            }
        }

        function assignTopic() {
            // Esta funci√≥n ya no se usa, se reemplaz√≥ por showTopicAssignmentModal()
            showTopicAssignmentModal();
        }

        // Inicializar cuando se sube archivo
        document.addEventListener('DOMContentLoaded', function() {
            // Manejar subida de archivos
            document.addEventListener('change', function(e) {
                if (e.target.id === 'imageInput') {
                    const files = Array.from(e.target.files);
                    const imageFiles = files.filter(file => file.type.startsWith('image/')).slice(0, 10);
                    
                    if (imageFiles.length > 0) {
                        state.selectedImages = imageFiles;
                        render();
                    }
                }
            });
        });

        function removeImage(index) {
            state.selectedImages.splice(index, 1);
            render();
        }

        async function transcribeImages() {
            if (!state.apiKey) {
                showMessage('Configura tu API key primero', 'error');
                return;
            }

            if (state.selectedImages.length === 0) {
                showMessage('Selecciona al menos una imagen', 'error');
                return;
            }

            showMessage('Transcribiendo im√°genes...', 'success');
            
            try {
                let allTranscriptions = [];
                
                // Procesar im√°genes en lotes de 5 para evitar l√≠mites de la API
                const batchSize = 5;
                for (let i = 0; i < state.selectedImages.length; i += batchSize) {
                    const batch = state.selectedImages.slice(i, i + batchSize);
                    
                    // Convertir im√°genes del lote a base64
                    const imageContents = await Promise.all(
                        batch.map(async (file) => {
                            const base64 = await fileToBase64(file);
                            return {
                                type: "image",
                                source: {
                                    type: "base64",
                                    media_type: file.type,
                                    data: base64
                                }
                            };
                        })
                    );

                    // Crear contenido del mensaje con todas las im√°genes del lote
                    const messageContent = [
                        ...imageContents,
                        {
                            type: "text",
                            text: `Act√∫a como un transcriptor de texto para una persona ciega. Analiza ${batch.length > 1 ? 'estas im√°genes' : 'esta imagen'} y extrae todo el texto visible de manera secuencial.

INSTRUCCIONES CR√çTICAS:
- Solo dicta las palabras que ves, como si estuvieras hablando en voz alta
- Encuentra las preguntas numeradas y sus opciones de respuesta
- CONSERVA y DESCRIBE todos los s√≠mbolos visuales de respuesta correcta que veas
- MANT√âN s√≠mbolos como: ‚úì, ‚úî, checkmarks, asteriscos, vi√±etas, flechas
- DESCRIBE elementos visuales importantes: "opci√≥n marcada en verde", "con tick", "con check", "respuesta correcta", "marcada"
- PRESERVA cualquier indicaci√≥n visual de que una opci√≥n es la correcta
- Si hay m√∫ltiples im√°genes, procesa cada una en orden
- Separa claramente el contenido de cada imagen

IMPORTANTE: NO elimines s√≠mbolos de respuesta correcta - los necesitamos para el siguiente paso.

Ejemplo de lo que S√ç debes incluir:
- "a) Madrid"
- "b) ‚úì Par√≠s" 
- "c) Londres"
- "d) Roma"

O:
- "a) Madrid"
- "b) Par√≠s (marcada en verde)"
- "c) Londres" 
- "d) Roma"

Responde con el texto extra√≠do conservando TODOS los s√≠mbolos y marcas visuales.`
                        }
                    ];

                    const response = await fetch("https://api.anthropic.com/v1/messages", {
                        method: "POST",
                        headers: {
                            "x-api-key": state.apiKey,
                            "anthropic-version": "2023-06-01",
                            "content-type": "application/json",
                            "anthropic-dangerous-direct-browser-access": "true"
                        },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 4000,
                            messages: [{
                                role: "user",
                                content: messageContent
                            }]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Error ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    allTranscriptions.push(data.content[0].text);
                }

                // Combinar todas las transcripciones
                state.transcribedText = allTranscriptions.join('\n\n--- SIGUIENTE IMAGEN ---\n\n');
                
                render();
                showMessage(`¬°Transcripci√≥n completada exitosamente! Procesadas ${state.selectedImages.length} im√°genes.`, 'success');
                
            } catch (error) {
                showMessage(`Error en la transcripci√≥n: ${error.message}`, 'error');
            }
        }

        async function cleanText() {
            if (!state.transcribedText) {
                showMessage('Primero transcribe las im√°genes', 'error');
                return;
            }

            if (!state.apiKey) {
                showMessage('Configura tu API key primero', 'error');
                return;
            }

            showMessage('Limpiando texto...', 'success');
            
            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "x-api-key": state.apiKey,
                        "anthropic-version": "2023-06-01",
                        "content-type": "application/json",
                        "anthropic-dangerous-direct-browser-access": "true"
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 4000,
                        messages: [{
                            role: "user",
                            content: `Limpia este texto extra√≠do de m√∫ltiples im√°genes y convi√©rtelo en formato de preguntas para banco de preguntas:

TEXTO A LIMPIAR:
${state.transcribedText}

INSTRUCCIONES CR√çTICAS PARA DETECTAR RESPUESTAS CORRECTAS:
- Busca s√≠mbolos visuales: ‚úì, ‚úî, *, ‚Ä¢, ‚Üí, >, checkmarks, ticks
- Busca descripciones: "marcada", "marcada en verde", "respuesta correcta", "con tick", "con check"
- Busca colores mencionados: "verde", "resaltada", "seleccionada"
- MARCA EN NEGRITA las opciones que tengan cualquiera de estos indicadores usando **texto**
- Elimina los s√≠mbolos y descripciones visuales DESPU√âS de identificar las correctas
- Extrae solo las preguntas y opciones de respuesta
- Numera las preguntas secuencialmente

FORMATO DE SALIDA ESTRICTO:
PREGUNTA: [texto de la pregunta]
OPCION_A: [opci√≥n a normal]
OPCION_B: **[opci√≥n b si tiene s√≠mbolo/marca de correcta]**
OPCION_C: [opci√≥n c normal]
OPCION_D: **[opci√≥n d si tiene s√≠mbolo/marca de correcta]**

EJEMPLOS DE LO QUE DETECTAR:
- "b) ‚úì Par√≠s" ‚Üí "OPCION_B: **Par√≠s**"
- "c) Londres (marcada)" ‚Üí "OPCION_C: **Londres**"
- "a) Madrid marcada en verde" ‚Üí "OPCION_A: **Madrid**"
- "d) ‚úî Roma" ‚Üí "OPCION_D: **Roma**"
- "b) * Par√≠s" ‚Üí "OPCION_B: **Par√≠s**"
- "c) ‚Üí Londres" ‚Üí "OPCION_C: **Londres**"
- "a) Madrid respuesta correcta" ‚Üí "OPCION_A: **Madrid**"

IMPORTANTE: Cualquier opci√≥n con s√≠mbolo, marca visual, color verde, o descripci√≥n de "correcta" debe ir en **negritas**.`
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                state.cleanedText = data.content[0].text;
                
                render();
                showMessage('¬°Texto limpiado exitosamente!', 'success');
                
            } catch (error) {
                showMessage(`Error en la limpieza: ${error.message}`, 'error');
            }
        }

        // Funci√≥n auxiliar para convertir archivos a base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        function addToQuestions() {
            if (!state.cleanedText) return;

            try {
                const newQuestions = parseCleanedText(state.cleanedText);
                
                if (state.selectedTopicForNewQuestions) {
                    newQuestions.forEach(q => q.topicId = state.selectedTopicForNewQuestions);
                    const topicName = getTopicName(state.selectedTopicForNewQuestions);
                    showMessage(`${newQuestions.length} preguntas a√±adidas al tema "${topicName}"`, 'success');
                } else {
                    showMessage(`${newQuestions.length} preguntas a√±adidas al banco`, 'success');
                }

                state.questions.push(...newQuestions);
                localStorage.setItem('questions', JSON.stringify(state.questions));
                
                // Limpiar formulario
                state.selectedImages = [];
                state.transcribedText = '';
                state.cleanedText = '';
                state.selectedTopicForNewQuestions = null;
                
                render();
            } catch (error) {
                showMessage('Error al procesar preguntas: ' + error.message, 'error');
            }
        }

        function parseCleanedText(text) {
            const questions = [];
            const sections = text.split(/PREGUNTA:/i).filter(section => section.trim());
            
            sections.forEach(section => {
                const lines = section.trim().split('\n').filter(line => line.trim());
                if (lines.length === 0) return;
                
                const questionText = lines[0].trim();
                const options = [];
                let correctAnswer = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line.match(/^OPCION_[A-D]:/i)) {
                        let optionText = line.replace(/^OPCION_[A-D]:/i, '').trim();
                        
                        if (optionText.startsWith('**') && optionText.endsWith('**')) {
                            optionText = optionText.slice(2, -2);
                            correctAnswer = options.length;
                        }
                        
                        if (optionText) {
                            options.push(optionText);
                        }
                    }
                }
                
                if (questionText && options.length >= 2) {
                    questions.push({
                        id: Date.now() + Math.random(),
                        question: questionText,
                        options: options,
                        correctAnswer: correctAnswer,
                        topicId: null
                    });
                }
            });
            
            return questions;
        }

        function clearQuestions() {
            if (confirm('¬øEliminar todas las preguntas?')) {
                state.questions = [];
                localStorage.setItem('questions', JSON.stringify(state.questions));
                render();
            }
        }

        function deleteQuestion(index) {
            if (confirm('¬øEliminar esta pregunta?')) {
                state.questions.splice(index, 1);
                localStorage.setItem('questions', JSON.stringify(state.questions));
                render();
                showMessage('Pregunta eliminada', 'success');
            }
        }

        function editQuestion(index) {
            const question = state.questions[index];
            
            // Crear modal simple
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); display: flex; justify-content: center;
                align-items: center; z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 20px;">Editar Pregunta</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Pregunta:</label>
                        <textarea id="edit-question" style="width: 100%; height: 60px; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">${question.question}</textarea>
                    </div>
                    
                    ${state.topics.length > 0 ? `
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Tema:</label>
                            <select id="edit-topic" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="">Sin tema</option>
                                ${state.topics.map(topic => `
                                    <option value="${topic.id}" ${question.topicId === topic.id ? 'selected' : ''}>
                                        ${topic.name}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 500;">Opciones:</label>
                        ${question.options.map((option, i) => `
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <input type="radio" name="correct" value="${i}" ${question.correctAnswer === i ? 'checked' : ''}>
                                <span style="font-weight: 500; min-width: 20px;">${String.fromCharCode(97 + i)})</span>
                                <input type="text" id="edit-option-${i}" value="${option}" style="flex: 1; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" style="padding: 10px 20px; border: none; background: #6b7280; color: white; border-radius: 6px; cursor: pointer;">
                            Cancelar
                        </button>
                        <button onclick="saveEdit(${index})" style="padding: 10px 20px; border: none; background: #4f46e5; color: white; border-radius: 6px; cursor: pointer;">
                            Guardar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Funci√≥n para guardar cambios
            window.saveEdit = function(qIndex) {
                try {
                    const newQuestion = document.getElementById('edit-question').value.trim();
                    const newOptions = [];
                    
                    for (let i = 0; i < question.options.length; i++) {
                        const optInput = document.getElementById(`edit-option-${i}`);
                        if (optInput && optInput.value.trim()) {
                            newOptions.push(optInput.value.trim());
                        }
                    }
                    
                    const correctRadio = modal.querySelector('input[name="correct"]:checked');
                    const newCorrect = correctRadio ? parseInt(correctRadio.value) : 0;
                    
                    let newTopicId = null;
                    const topicSelect = modal.querySelector('#edit-topic');
                    if (topicSelect && topicSelect.value) {
                        newTopicId = topicSelect.value;
                    }
                    
                    if (!newQuestion || newOptions.length < 2) {
                        alert('Completa todos los campos requeridos');
                        return;
                    }
                    
                    state.questions[qIndex] = {
                        ...state.questions[qIndex],
                        question: newQuestion,
                        options: newOptions,
                        correctAnswer: newCorrect,
                        topicId: newTopicId
                    };
                    
                    localStorage.setItem('questions', JSON.stringify(state.questions));
                    modal.remove();
                    render();
                    showMessage('Pregunta actualizada', 'success');
                    
                } catch (error) {
                    showMessage('Error al guardar: ' + error.message, 'error');
                }
            };
        }

        function filterByTopic(topicId) {
            state.selectedTopicFilter = topicId;
            render();
        }

        function getFilteredQuestions() {
            if (state.selectedTopicFilter === 'all') {
                return state.questions;
            }
            return state.questions.filter(q => q.topicId === state.selectedTopicFilter);
        }

        function getTopicName(topicId) {
            const topic = state.topics.find(t => t.id === topicId);
            return topic ? topic.name : 'Sin tema';
        }

        function getTopicQuestionCount(topicId) {
            return state.questions.filter(q => q.topicId === topicId).length;
        }

        function startTest() {
            let availableQuestions = state.questions;
            
            // Verificar si hay selecci√≥n de tema espec√≠fico
            const selectedTestType = document.querySelector('input[name="test-type"]:checked');
            if (selectedTestType && selectedTestType.value !== 'all') {
                availableQuestions = state.questions.filter(q => q.topicId === selectedTestType.value);
            }

            if (availableQuestions.length === 0) {
                showMessage('No hay preguntas disponibles para este tipo de test', 'error');
                return;
            }

            // Mezclar preguntas y tomar hasta 10
            const shuffled = [...availableQuestions].sort(() => Math.random() - 0.5);
            
            state.currentTest = {
                questions: shuffled.slice(0, Math.min(10, availableQuestions.length)),
                currentQuestion: 0,
                answers: {},
                timeLeft: 600, // 10 minutos
                timer: null,
                testType: selectedTestType ? selectedTestType.value : 'all'
            };
            
            // Iniciar temporizador
            state.currentTest.timer = setInterval(() => {
                state.currentTest.timeLeft--;
                if (state.currentTest.timeLeft <= 0) {
                    finishTest();
                } else {
                    const timerElement = document.getElementById('timer');
                    if (timerElement) {
                        timerElement.textContent = `‚è±Ô∏è ${formatTime(state.currentTest.timeLeft)}`;
                    }
                }
            }, 1000);
            
            render();
        }

        function selectAnswer(answerIndex) {
            if (state.currentTest) {
                state.currentTest.answers[state.currentTest.currentQuestion] = answerIndex;
            }
        }

        function previousQuestion() {
            if (state.currentTest && state.currentTest.currentQuestion > 0) {
                state.currentTest.currentQuestion--;
                render();
            }
        }

        function nextQuestion() {
            if (!state.currentTest) return;
            
            if (state.currentTest.currentQuestion === state.currentTest.questions.length - 1) {
                finishTest();
            } else {
                state.currentTest.currentQuestion++;
                render();
            }
        }

        function finishTest() {
            if (!state.currentTest) return;
            
            clearInterval(state.currentTest.timer);
            
            let correct = 0;
            state.currentTest.questions.forEach((q, i) => {
                if (state.currentTest.answers[i] === q.correctAnswer) {
                    correct++;
                }
            });
            
            const percentage = Math.round((correct / state.currentTest.questions.length) * 100);
            
            let testTypeText = 'Test General';
            if (state.currentTest.testType !== 'all') {
                const topicName = getTopicName(state.currentTest.testType);
                testTypeText = `Test de ${topicName}`;
            }
            
            alert(`${testTypeText} completado!\n\nRespuestas correctas: ${correct}/${state.currentTest.questions.length}\nPorcentaje: ${percentage}%`);
            
            state.currentTest = null;
            render();
        }

        // Funciones de utilidad
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function showMessage(message, type) {
            const messagesDiv = document.getElementById('messages');
            if (messagesDiv) {
                messagesDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
                setTimeout(() => {
                    messagesDiv.innerHTML = '';
                }, 5000);
            }
        }

        // Inicializar aplicaci√≥n
        console.log('Sistema iniciando...');
        render();
        console.log('Sistema cargado correctamente');
    </script>
</body>
</html>
