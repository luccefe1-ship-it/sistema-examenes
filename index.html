<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Ex√°menes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .title {
            font-size: 2rem;
            font-weight: bold;
            color: #2d3748;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary { background: #4f46e5; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-info { background: #0ea5e9; color: white; }

        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

        .nav-tabs {
            display: flex;
            margin-bottom: 30px;
            background: #f8fafc;
            border-radius: 12px;
            padding: 5px;
        }

        .nav-tab {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: white;
            color: #4f46e5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #10b981;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #ef4444;
        }

        .three-column-layout {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .three-column-layout {
                grid-template-columns: 1fr;
            }
        }

        .column {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e2e8f0;
        }

        .column-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            background: white;
        }

        .upload-area:hover {
            border-color: #4f46e5;
            background: #f7fafc;
        }

        .upload-area.has-file {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .file-input {
            display: none;
        }

        .upload-text {
            color: #64748b;
            margin-bottom: 10px;
        }

        .images-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .image-preview {
            position: relative;
            background: #f3f4f6;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }

        .image-preview img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .image-preview .filename {
            font-size: 10px;
            color: #6b7280;
            word-break: break-all;
        }

        .image-preview .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-counter {
            color: #4f46e5;
            font-weight: 500;
            font-size: 14px;
        }

        .textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            resize: vertical;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 500;
            margin-bottom: 5px;
            color: #374151;
        }

        .form-input {
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .questions-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
        }

        .question-item {
            padding: 15px;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .question-content {
            flex: 1;
        }

        .question-text {
            font-weight: 500;
            margin-bottom: 8px;
            color: #1f2937;
        }

        .question-options {
            list-style: none;
            margin: 8px 0;
        }

        .question-options li {
            padding: 4px 0;
            color: #6b7280;
        }

        .question-options li.correct {
            color: #059669;
            font-weight: 500;
        }

        .question-actions {
            display: flex;
            gap: 5px;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .login-title {
            text-align: center;
            font-size: 1.8rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 30px;
        }

        .step-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .step-button {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .step-button:hover {
            background: #f7fafc;
            border-color: #4f46e5;
        }

        .progress-bar {
            background: #f3f4f6;
            border-radius: 6px;
            height: 6px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-bar-fill {
            background: #4f46e5;
            height: 100%;
            transition: width 0.3s ease;
        }

        /* NUEVOS ESTILOS PARA TEMAS */
        .topic-section {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .topic-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .topic-filter {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .topic-tag {
            background: #4f46e5;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
        }

        .topic-badge {
            background: #e0e7ff;
            color: #4f46e5;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
        }

        .test-topic-selector {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <div class="title">Sistema de Ex√°menes</div>
                <div style="color: #10b981; font-weight: 500;">‚úÖ Sistema Funcionando</div>
            </div>
            <div style="text-align: center; padding: 40px;">
                <h2>Cargando sistema...</h2>
                <p>Si no se carga en unos segundos, hay un error en el JavaScript.</p>
            </div>
        </div>
    </div>

    <script>
        // Estado global
        let currentUser = null;
        let questions = JSON.parse(localStorage.getItem('questions') || '[]');
        let topics = JSON.parse(localStorage.getItem('topics') || '[]');
        let currentTest = null;
        let apiKey = localStorage.getItem('anthropic_api_key') || '';
        let transcribedText = '';
        let cleanedText = '';
        let selectedImages = [];
        let currentTab = 'upload';
        let selectedTopicFilter = 'all';

        // Usuarios predefinidos
        const users = {
            'demo': { password: 'demo123', name: 'Usuario Demo' }
        };

        // Funci√≥n principal de renderizado
        function renderApp() {
            const app = document.getElementById('app');
            
            if (!currentUser) {
                app.innerHTML = renderLogin();
            } else {
                app.innerHTML = renderMainApp();
            }
        }

        function renderLogin() {
            return `
                <div class="container">
                    <div class="login-form">
                        <div class="login-title">Iniciar Sesi√≥n</div>
                        <div class="form-group">
                            <label class="form-label">Usuario</label>
                            <input type="text" id="username" class="form-input" placeholder="Ingresa tu usuario">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contrase√±a</label>
                            <input type="password" id="password" class="form-input" placeholder="Ingresa tu contrase√±a">
                        </div>
                        <button onclick="login()" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                            Iniciar Sesi√≥n
                        </button>
                        <div style="text-align: center; margin-top: 15px; color: #6b7280; font-size: 14px;">
                            Usuario: demo | Contrase√±a: demo123
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMainApp() {
            return `
                <div class="container">
                    <div class="header">
                        <div class="title">Sistema de Ex√°menes</div>
                        <div class="header-controls">
                            <span style="color: #10b981; font-weight: 500;">‚úÖ API ${apiKey ? 'configurada' : 'no configurada'}</span>
                            <button onclick="configureAPI()" class="btn btn-secondary btn-sm">Configurar API</button>
                            <button onclick="deleteAPI()" class="btn btn-danger btn-sm">Eliminar</button>
                            <span style="color: #f59e0b;">üìù ${currentUser.name}</span>
                            <button onclick="logout()" class="btn btn-danger">Cerrar Sesi√≥n</button>
                        </div>
                    </div>

                    <div class="nav-tabs">
                        <button class="nav-tab ${currentTab === 'upload' ? 'active' : ''}" onclick="showTab('upload')">üì§ Subir Test</button>
                        <button class="nav-tab ${currentTab === 'questions' ? 'active' : ''}" onclick="showTab('questions')">üìã Banco de Preguntas</button>
                        <button class="nav-tab ${currentTab === 'test' ? 'active' : ''}" onclick="showTab('test')">üéØ Test Aleatorio</button>
                    </div>

                    <div id="upload-tab" class="tab-content ${currentTab === 'upload' ? 'active' : ''}">
                        <div id="success-message" style="display: none;"></div>
                        <div id="error-message" style="display: none;"></div>
                        
                        <!-- SECCI√ìN DE TEMAS -->
                        <div class="topic-section">
                            <div style="font-size: 1.1rem; font-weight: bold; color: #92400e; margin-bottom: 10px;">üè∑Ô∏è Gesti√≥n de Temas</div>
                            <div style="color: #78350f; font-size: 14px; margin-bottom: 15px;">
                                Organiza tus preguntas por temas. Primero crea o selecciona un tema, luego podr√°s asignar las preguntas procesadas a ese tema.
                            </div>
                            <div class="topic-buttons">
                                <button onclick="createTopic()" class="btn btn-info">
                                    üÜï Crear Nuevo Tema
                                </button>
                                <button onclick="assignTopic()" class="btn btn-warning" ${cleanedText ? '' : 'disabled'}>
                                    üè∑Ô∏è Asignar Tema a Preguntas
                                </button>
                            </div>
                            ${topics.length > 0 ? `
                                <div style="margin-top: 15px;">
                                    <div style="font-weight: 500; color: #92400e; margin-bottom: 8px;">Temas disponibles:</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        ${topics.map(topic => `<span class="topic-tag">${topic.name} (${getTopicQuestionCount(topic.id)} preguntas)</span>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Layout de 3 columnas -->
                        <div class="three-column-layout">
                            <!-- Columna 1: Subir Im√°genes -->
                            <div class="column">
                                <div class="column-title">üì§ Subir Im√°genes</div>
                                <div class="upload-area" id="upload-area" onclick="document.getElementById('imageInput').click()">
                                    <div class="upload-text">üìÅ Arrastra im√°genes aqu√≠ o haz clic para seleccionar</div>
                                    <div style="color: #9ca3af; font-size: 12px;">Hasta 10 im√°genes ‚Ä¢ Formatos: JPG, PNG, WebP</div>
                                    <div class="file-counter" id="file-counter" style="margin-top: 10px;">0/10 archivos</div>
                                </div>
                                <input type="file" id="imageInput" class="file-input" accept="image/*" multiple onchange="handleImagesUpload(event)">
                                
                                <!-- Vista previa de im√°genes -->
                                <div class="images-preview" id="images-preview"></div>
                                
                                <div class="step-buttons">
                                    <button id="transcribeBtn" class="step-button" onclick="transcribeImages()" disabled>
                                        ü§ñ 1. Transcribir Im√°genes
                                    </button>
                                </div>
                            </div>

                            <!-- Columna 2: Texto Extra√≠do -->
                            <div class="column">
                                <div class="column-title">üìù Texto Extra√≠do</div>
                                <div style="margin-bottom: 10px; font-weight: 500;">Transcripci√≥n Autom√°tica:</div>
                                <div class="progress-bar" id="transcription-progress" style="display: none;">
                                    <div class="progress-bar-fill" id="progress-fill"></div>
                                </div>
                                <textarea id="transcribedText" class="textarea" placeholder="El texto transcrito aparecer√° aqu√≠..." readonly></textarea>
                                
                                <div class="step-buttons">
                                    <button id="cleanBtn" class="step-button" onclick="cleanText()" disabled>
                                        üßπ 2. Limpiar Texto
                                    </button>
                                </div>
                            </div>

                            <!-- Columna 3: Texto Sin S√≠mbolos -->
                            <div class="column">
                                <div class="column-title">‚ú® Texto Sin S√≠mbolos</div>
                                <div style="margin-bottom: 10px; font-weight: 500;">Texto Limpio:</div>
                                <textarea id="cleanedText" class="textarea" placeholder="El texto limpio aparecer√° aqu√≠..." readonly></textarea>
                                
                                <div class="step-buttons">
                                    <button id="addBtn" class="step-button" onclick="addToQuestions()" disabled>
                                        ‚úÖ 3. A√±adir al Banco de Preguntas
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="questions-tab" class="tab-content ${currentTab === 'questions' ? 'active' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                            <h2>Banco de Preguntas (${getFilteredQuestions().length})</h2>
                            <button onclick="clearQuestions()" class="btn btn-danger">Limpiar Todo</button>
                        </div>
                        
                        <!-- Filtro por temas -->
                        <div class="topic-filter">
                            <span style="font-weight: 500; color: #374151;">Filtrar por tema:</span>
                            <select id="topic-filter" onchange="filterByTopic(this.value)" class="form-input" style="width: auto;">
                                <option value="all">Todos los temas (${questions.length})</option>
                                ${topics.map(topic => `
                                    <option value="${topic.id}" ${selectedTopicFilter === topic.id ? 'selected' : ''}>
                                        ${topic.name} (${getTopicQuestionCount(topic.id)})
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="questions-list" id="questions-list">
                            ${renderQuestionsList()}
                        </div>
                    </div>

                    <div id="test-tab" class="tab-content ${currentTab === 'test' ? 'active' : ''}">
                        <h2>Test Aleatorio</h2>
                        
                        <!-- Selecci√≥n de tema para test -->
                        ${topics.length > 0 ? `
                            <div class="test-topic-selector">
                                <div style="font-weight: bold; color: #0c4a6e; margin-bottom: 15px;">üéØ Seleccionar Tipo de Test</div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                    <div>
                                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                            <input type="radio" name="test-type" value="all" checked onchange="updateTestType()">
                                            <span style="font-weight: 500;">Test General (${questions.length} preguntas disponibles)</span>
                                        </label>
                                        <div style="color: #6b7280; font-size: 13px; margin-left: 25px;">Incluye preguntas de todos los temas</div>
                                    </div>
                                    ${topics.map(topic => `
                                        <div>
                                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                                <input type="radio" name="test-type" value="${topic.id}" onchange="updateTestType()">
                                                <span style="font-weight: 500;">${topic.name} (${getTopicQuestionCount(topic.id)} preguntas)</span>
                                            </label>
                                            <div style="color: #6b7280; font-size: 13px; margin-left: 25px;">Solo preguntas de ${topic.name}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div id="test-content">
                            ${renderTestContent()}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderQuestionsList() {
            const filteredQuestions = getFilteredQuestions();
            
            if (filteredQuestions.length === 0) {
                const filterText = selectedTopicFilter === 'all' ? 'No hay preguntas en el banco' : 'No hay preguntas en este tema';
                return `<div style="text-align: center; padding: 40px; color: #9ca3af;">${filterText}</div>`;
            }

            return filteredQuestions.map((q) => {
                const actualIndex = questions.findIndex(question => question.id === q.id);
                const topicName = q.topicId ? getTopicName(q.topicId) : null;
                
                return `
                    <div class="question-item">
                        <div class="question-content">
                            <div class="question-text">
                                ${q.question}
                                ${topicName ? `<span class="topic-badge">${topicName}</span>` : ''}
                            </div>
                            <ul class="question-options">
                                ${q.options.map((opt, i) => `
                                    <li class="${q.correctAnswer === i ? 'correct' : ''}">
                                        ${String.fromCharCode(97 + i)}) ${opt}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        <div class="question-actions">
                            <button onclick="editQuestion(${actualIndex})" class="btn btn-warning btn-sm">Editar</button>
                            <button onclick="deleteQuestion(${actualIndex})" class="btn btn-danger btn-sm">Eliminar</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderTestContent() {
            if (questions.length === 0) {
                return '<div style="text-align: center; padding: 40px; color: #9ca3af;">A√±ade preguntas al banco para poder generar tests</div>';
            }

            if (!currentTest) {
                return `
                    <div style="text-align: center; padding: 40px;">
                        <button onclick="startRandomTest()" class="btn btn-primary" style="font-size: 1.2rem; padding: 15px 30px;">
                            üéØ Comenzar Test Aleatorio
                        </button>
                        <div style="margin-top: 15px; color: #6b7280;" id="available-questions-count">
                            ${getAvailableQuestionsText()}
                        </div>
                    </div>
                `;
            }

            return renderCurrentTest();
        }

        function renderCurrentTest() {
            const question = currentTest.questions[currentTest.currentQuestion];
            return `
                <div style="max-width: 800px; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>Pregunta ${currentTest.currentQuestion + 1} de ${currentTest.questions.length}</div>
                        <div id="timer" style="font-weight: bold; color: #ef4444;">‚è±Ô∏è ${formatTime(currentTest.timeLeft)}</div>
                    </div>
                    
                    <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="font-size: 1.1rem; font-weight: 500; margin-bottom: 15px;">
                            ${question.question}
                        </div>
                        
                        <div style="display: grid; gap: 10px;">
                            ${question.options.map((option, index) => `
                                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 8px; cursor: pointer; border: 1px solid #e5e7eb;">
                                    <input type="radio" name="answer" value="${index}" onchange="selectAnswer(${index})">
                                    <span>${String.fromCharCode(97 + index)}) ${option}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; gap: 10px;">
                        <button onclick="previousQuestion()" class="btn btn-secondary" ${currentTest.currentQuestion === 0 ? 'disabled' : ''}>
                            ‚Üê Anterior
                        </button>
                        <button onclick="nextQuestion()" class="btn btn-primary">
                            ${currentTest.currentQuestion === currentTest.questions.length - 1 ? 'Finalizar Test' : 'Siguiente ‚Üí'}
                        </button>
                    </div>
                </div>
            `;
        }

        // Funciones de autenticaci√≥n
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (users[username] && users[username].password === password) {
                currentUser = users[username];
                renderApp();
            } else {
                alert('Usuario o contrase√±a incorrectos');
            }
        }

        function logout() {
            currentUser = null;
            renderApp();
        }

        // Funciones de API
        function configureAPI() {
            const key = prompt('Ingresa tu API key de Anthropic:');
            if (key) {
                apiKey = key;
                localStorage.setItem('anthropic_api_key', key);
                renderApp();
            }
        }

        function deleteAPI() {
            apiKey = '';
            localStorage.removeItem('anthropic_api_key');
            renderApp();
        }

        // Funciones de navegaci√≥n
        function showTab(tabName) {
            currentTab = tabName;
            renderApp();
        }

        // FUNCIONES PARA MANEJO DE TEMAS
        function createTopic() {
            const topicName = prompt('Ingresa el nombre del nuevo tema:');
            if (topicName && topicName.trim()) {
                const newTopic = {
                    id: Date.now() + Math.random(),
                    name: topicName.trim(),
                    createdAt: new Date().toISOString()
                };
                
                topics.push(newTopic);
                localStorage.setItem('topics', JSON.stringify(topics));
                renderApp();
                showSuccess(`Tema "${topicName}" creado exitosamente`);
            }
        }

        function assignTopic() {
            if (!cleanedText) {
                showError('Primero procesa el texto para poder asignar temas');
                return;
            }

            if (topics.length === 0) {
                showError('Primero crea al menos un tema');
                return;
            }

            showTopicSelectionModal();
        }

        function showTopicSelectionModal() {
            const modal = document.createElement('div');
            modal.id = 'topic-selection-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;

            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 16px;
                    padding: 30px;
                    max-width: 500px;
                    width: 90%;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #2d3748; margin: 0;">üè∑Ô∏è Seleccionar Tema</h3>
                        <button onclick="closeTopicModal()" style="
                            background: #ef4444;
                            color: white;
                            border: none;
                            border-radius: 50%;
                            width: 30px;
                            height: 30px;
                            cursor: pointer;
                            font-size: 16px;
                        ">√ó</button>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <div style="color: #6b7280; margin-bottom: 15px;">
                            Selecciona el tema para las preguntas que ser√°n procesadas:
                        </div>
                        
                        <div style="display: grid; gap: 10px;">
                            ${topics.map(topic => `
                                <label style="
                                    display: flex;
                                    align-items: center;
                                    gap: 10px;
                                    padding: 15px;
                                    border: 2px solid #e5e7eb;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    transition: all 0.2s ease;
                                " onmouseover="this.style.borderColor='#4f46e5'" onmouseout="this.style.borderColor='#e5e7eb'">
                                    <input type="radio" name="selected-topic" value="${topic.id}" style="transform: scale(1.2);">
                                    <div>
                                        <div style="font-weight: 500; color: #1f2937;">${topic.name}</div>
                                        <div style="font-size: 12px; color: #6b7280;">${getTopicQuestionCount(topic.id)} preguntas existentes</div>
                                    </div>
                                </label>
                            `).join('')}
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeTopicModal()" class="btn btn-secondary">Cancelar</button>
                        <button onclick="confirmTopicAssignment()" class="btn btn-primary">Asignar Tema</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeTopicModal();
                }
            });
        }

        function closeTopicModal() {
            const modal = document.getElementById('topic-selection-modal');
            if (modal) {
                modal.remove();
            }
        }

        function confirmTopicAssignment() {
            const selectedRadio = document.querySelector('input[name="selected-topic"]:checked');
            if (!selectedRadio) {
                alert('Selecciona un tema');
                return;
            }

            const selectedTopicId = selectedRadio.value;
            const topicName = getTopicName(selectedTopicId);
            
            window.selectedTopicForNewQuestions = selectedTopicId;
            
            closeTopicModal();
            showSuccess(`Tema "${topicName}" seleccionado. Las preguntas se asignar√°n a este tema cuando las a√±adas al banco.`);
        }

        function getTopicName(topicId) {
            const topic = topics.find(t => t.id == topicId);
            return topic ? topic.name : 'Sin tema';
        }

        function getTopicQuestionCount(topicId) {
            return questions.filter(q => q.topicId == topicId).length;
        }

        function filterByTopic(topicId) {
            selectedTopicFilter = topicId;
            renderApp();
        }

        function getFilteredQuestions() {
            if (selectedTopicFilter === 'all') {
                return questions;
            }
            return questions.filter(q => q.topicId == selectedTopicFilter);
        }

        function updateTestType() {
            const selectedType = document.querySelector('input[name="test-type"]:checked');
            if (selectedType) {
                const countElement = document.getElementById('available-questions-count');
                if (countElement) {
                    countElement.textContent = getAvailableQuestionsText();
                }
            }
        }

        function getAvailableQuestionsText() {
            const selectedType = document.querySelector('input[name="test-type"]:checked');
            if (!selectedType) return `Preguntas disponibles: ${questions.length}`;
            
            if (selectedType.value === 'all') {
                return `Preguntas disponibles: ${questions.length}`;
            } else {
                const topicName = getTopicName(selectedType.value);
                const count = getTopicQuestionCount(selectedType.value);
                return `Preguntas disponibles en ${topicName}: ${count}`;
            }
        }

        // Funciones de upload y transcripci√≥n
        function handleImagesUpload(event) {
            const files = Array.from(event.target.files);
            
            const imageFiles = files.filter(file => file.type.startsWith('image/')).slice(0, 10);
            
            if (imageFiles.length === 0) {
                showError('Selecciona al menos una imagen v√°lida');
                return;
            }

            selectedImages = imageFiles;
            updateImagesPreview();
            updateFileCounter();
            
            document.getElementById('transcribeBtn').disabled = false;
        }

        function updateImagesPreview() {
            const preview = document.getElementById('images-preview');
            
            if (selectedImages.length === 0) {
                preview.innerHTML = '';
                return;
            }

            preview.innerHTML = selectedImages.map((file, index) => {
                const url = URL.createObjectURL(file);
                return `
                    <div class="image-preview">
                        <button class="remove-btn" onclick="removeImage(${index})">√ó</button>
                        <img src="${url}" alt="${file.name}">
                        <div class="filename">${file.name}</div>
                    </div>
                `;
            }).join('');
        }

        function updateFileCounter() {
            const counter = document.getElementById('file-counter');
            const uploadArea = document.getElementById('upload-area');
            
            counter.textContent = `${selectedImages.length}/10 archivos`;
            
            if (selectedImages.length > 0) {
                uploadArea.classList.add('has-file');
                const uploadText = document.querySelector('.upload-text');
                uploadText.textContent = `‚úÖ ${selectedImages.length} imagen${selectedImages.length > 1 ? 'es' : ''} seleccionada${selectedImages.length > 1 ? 's' : ''}`;
            } else {
                uploadArea.classList.remove('has-file');
                const uploadText = document.querySelector('.upload-text');
                uploadText.textContent = 'üìÅ Arrastra im√°genes aqu√≠ o haz clic para seleccionar';
            }
        }

        function removeImage(index) {
            selectedImages.splice(index, 1);
            updateImagesPreview();
            updateFileCounter();
            
            if (selectedImages.length === 0) {
                document.getElementById('transcribeBtn').disabled = true;
            }
        }

        async function transcribeImages() {
            if (!apiKey) {
                showError('Configura tu API key primero');
                return;
            }

            if (selectedImages.length === 0) {
                showError('Selecciona al menos una imagen');
                return;
            }

            const progressBar = document.getElementById('transcription-progress');
            const progressFill = document.getElementById('progress-fill');
            progressBar.style.display = 'block';
            
            document.getElementById('transcribeBtn').textContent = 'ü§ñ Transcribiendo...';
            document.getElementById('transcribeBtn').disabled = true;

            try {
                let allTranscriptions = [];
                
                const batchSize = 5;
                for (let i = 0; i < selectedImages.length; i += batchSize) {
                    const batch = selectedImages.slice(i, i + batchSize);
                    
                    const imageContents = await Promise.all(
                        batch.map(async (file) => {
                            const base64 = await fileToBase64(file);
                            return {
                                type: "image",
                                source: {
                                    type: "base64",
                                    media_type: file.type,
                                    data: base64
                                }
                            };
                        })
                    );

                    const messageContent = [
                        ...imageContents,
                        {
                            type: "text",
                            text: `Act√∫a como un transcriptor de texto para una persona ciega. Analiza ${batch.length > 1 ? 'estas im√°genes' : 'esta imagen'} y extrae todo el texto visible de manera secuencial.

INSTRUCCIONES CR√çTICAS:
- Solo dicta las palabras que ves, como si estuvieras hablando en voz alta
- Encuentra las preguntas numeradas y sus opciones de respuesta
- CONSERVA y DESCRIBE todos los s√≠mbolos visuales de respuesta correcta que veas
- MANT√âN s√≠mbolos como: ‚úì, ‚úî, checkmarks, asteriscos, vi√±etas, flechas
- DESCRIBE elementos visuales importantes: "opci√≥n marcada en verde", "con tick", "con check", "respuesta correcta", "marcada"
- PRESERVA cualquier indicaci√≥n visual de que una opci√≥n es la correcta
- Si hay m√∫ltiples im√°genes, procesa cada una en orden
- Separa claramente el contenido de cada imagen

IMPORTANTE: NO elimines s√≠mbolos de respuesta correcta - los necesitamos para el siguiente paso.

Responde con el texto extra√≠do conservando TODOS los s√≠mbolos y marcas visuales.`
                        }
                    ];

                    const response = await fetch("https://api.anthropic.com/v1/messages", {
                        method: "POST",
                        headers: {
                            "x-api-key": apiKey,
                            "anthropic-version": "2023-06-01",
                            "content-type": "application/json",
                            "anthropic-dangerous-direct-browser-access": "true"
                        },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 4000,
                            messages: [{
                                role: "user",
                                content: messageContent
                            }]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Error ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    allTranscriptions.push(data.content[0].text);
                    
                    const progress = ((i + batch.length) / selectedImages.length) * 100;
                    progressFill.style.width = progress + '%';
                }

                transcribedText = allTranscriptions.join('\n\n--- SIGUIENTE IMAGEN ---\n\n');
                
                document.getElementById('transcribedText').value = transcribedText;
                document.getElementById('cleanBtn').disabled = false;
                
                showSuccess(`¬°Transcripci√≥n completada exitosamente! Procesadas ${selectedImages.length} im√°genes.`);
                
            } catch (error) {
                showError(`Error en la transcripci√≥n: ${error.message}`);
            } finally {
                progressBar.style.display = 'none';
                document.getElementById('transcribeBtn').textContent = 'ü§ñ 1. Transcribir Im√°genes';
                document.getElementById('transcribeBtn').disabled = false;
            }
        }

        async function cleanText() {
            if (!transcribedText) {
                showError('Primero transcribe las im√°genes');
                return;
            }

            document.getElementById('cleanBtn').textContent = 'üßπ Limpiando...';
            document.getElementById('cleanBtn').disabled = true;

            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "x-api-key": apiKey,
                        "anthropic-version": "2023-06-01",
                        "content-type": "application/json",
                        "anthropic-dangerous-direct-browser-access": "true"
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 4000,
                        messages: [{
                            role: "user",
                            content: `Limpia este texto extra√≠do de m√∫ltiples im√°genes y convi√©rtelo en formato de preguntas para banco de preguntas:

TEXTO A LIMPIAR:
${transcribedText}

INSTRUCCIONES CR√çTICAS PARA DETECTAR RESPUESTAS CORRECTAS:
- Busca s√≠mbolos visuales: ‚úì, ‚úî, *, ‚Ä¢, ‚Üí, >, checkmarks, ticks
- Busca descripciones: "marcada", "marcada en verde", "respuesta correcta", "con tick", "con check"
- Busca colores mencionados: "verde", "resaltada", "seleccionada"
- MARCA EN NEGRITA las opciones que tengan cualquiera de estos indicadores usando **texto**
- Elimina los s√≠mbolos y descripciones visuales DESPU√âS de identificar las correctas
- Extrae solo las preguntas y opciones de respuesta
- Numera las preguntas secuencialmente

FORMATO DE SALIDA ESTRICTO:
PREGUNTA: [texto de la pregunta]
OPCION_A: [opci√≥n a normal]
OPCION_B: **[opci√≥n b si tiene s√≠mbolo/marca de correcta]**
OPCION_C: [opci√≥n c normal]
OPCION_D: **[opci√≥n d si tiene s√≠mbolo/marca de correcta]**

IMPORTANTE: Cualquier opci√≥n con s√≠mbolo, marca visual, color verde, o descripci√≥n de "correcta" debe ir en **negritas**.`
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                cleanedText = data.content[0].text;
                
                document.getElementById('cleanedText').value = cleanedText;
                document.getElementById('addBtn').disabled = false;
                
                showSuccess('¬°Texto limpiado exitosamente!');
                
            } catch (error) {
                showError(`Error en la limpieza: ${error.message}`);
            } finally {
                document.getElementById('cleanBtn').textContent = 'üßπ 2. Limpiar Texto';
                document.getElementById('cleanBtn').disabled = false;
            }
        }

        function addToQuestions() {
            if (!cleanedText) {
                showError('Primero limpia el texto');
                return;
            }

            try {
                const newQuestions = parseCleanedText(cleanedText);
                if (newQuestions.length === 0) {
                    showError('No se pudieron extraer preguntas del texto limpio');
                    return;
                }

                if (window.selectedTopicForNewQuestions) {
                    newQuestions.forEach(question => {
                        question.topicId = window.selectedTopicForNewQuestions;
                    });
                    const topicName = getTopicName(window.selectedTopicForNewQuestions);
                    showSuccess(`¬°Se a√±adieron ${newQuestions.length} preguntas al tema "${topicName}"! Total de im√°genes procesadas: ${selectedImages.length}`);
                } else {
                    showSuccess(`¬°Se a√±adieron ${newQuestions.length} preguntas al banco! Total de im√°genes procesadas: ${selectedImages.length}`);
                }

                questions.push(...newQuestions);
                localStorage.setItem('questions', JSON.stringify(questions));
                
                resetUploadForm();
                renderApp();
                
            } catch (error) {
                showError(`Error al procesar preguntas: ${error.message}`);
            }
        }

        function resetUploadForm() {
            document.getElementById('transcribedText').value = '';
            document.getElementById('cleanedText').value = '';
            transcribedText = '';
            cleanedText = '';
            
            selectedImages = [];
            updateImagesPreview();
            updateFileCounter();
            
            document.getElementById('cleanBtn').disabled = true;
            document.getElementById('addBtn').disabled = true;
            document.getElementById('transcribeBtn').disabled = true;
            
            document.getElementById('imageInput').value = '';
            
            window.selectedTopicForNewQuestions = null;
        }

        function parseCleanedText(text) {
            const questions = [];
            const sections = text.split(/PREGUNTA:/i).filter(section => section.trim());
            
            sections.forEach(section => {
                const lines = section.trim().split('\n').filter(line => line.trim());
                if (lines.length === 0) return;
                
                const questionText = lines[0].trim();
                const options = [];
                let correctAnswer = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line.match(/^OPCION_[A-D]:/i)) {
                        let optionText = line.replace(/^OPCION_[A-D]:/i, '').trim();
                        
                        if (optionText.startsWith('**') && optionText.endsWith('**')) {
                            optionText = optionText.slice(2, -2);
                            correctAnswer = options.length;
                        }
                        
                        if (optionText) {
                            options.push(optionText);
                        }
                    }
                }
                
                if (questionText && options.length >= 2) {
                    questions.push({
                        id: Date.now() + Math.random(),
                        question: questionText,
                        options: options,
                        correctAnswer: correctAnswer,
                        topicId: null
                    });
                }
            });
            
            return questions;
        }

        // Funciones del banco de preguntas
        function clearQuestions() {
            if (confirm('¬øEst√°s seguro de que quieres eliminar todas las preguntas?')) {
                questions = [];
                localStorage.setItem('questions', JSON.stringify(questions));
                currentTab = 'questions';
                renderApp();
            }
        }

        function deleteQuestion(index) {
            if (confirm('¬øEliminar esta pregunta?')) {
                questions.splice(index, 1);
                localStorage.setItem('questions', JSON.stringify(questions));
                currentTab = 'questions';
                renderApp();
                showSuccess('Pregunta eliminada exitosamente');
            }
        }

        function editQuestion(index) {
            const question = questions[index];
            showEditModal(question, index);
        }

        function showEditModal(question, index) {
            const modal = document.createElement('div');
            modal.id = 'edit-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;

            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 16px;
                    padding: 30px;
                    max-width: 600px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #2d3748; margin: 0;">Editar Pregunta</h3>
                        <button onclick="closeEditModal()" style="
                            background: #ef4444;
                            color: white;
                            border: none;
                            border-radius: 50%;
                            width: 30px;
                            height: 30px;
                            cursor: pointer;
                            font-size: 16px;
                        ">√ó</button>
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="form-label">Pregunta:</label>
                        <textarea id="edit-question-text" class="form-input" style="height: 80px; resize: vertical;">${question.question}</textarea>
                    </div>

                    ${topics.length > 0 ? `
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label class="form-label">Tema:</label>
                            <select id="edit-question-topic" class="form-input">
                                <option value="">Sin tema</option>
                                ${topics.map(topic => `
                                    <option value="${topic.id}" ${question.topicId == topic.id ? 'selected' : ''}>
                                        ${topic.name}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                    ` : ''}

                    <div style="margin-bottom: 20px;">
                        <label class="form-label">Opciones de Respuesta:</label>
                        ${question.options.map((option, i) => `
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <input type="radio" name="correct-answer" value="${i}" ${question.correctAnswer === i ? 'checked' : ''} 
                                       style="cursor: pointer;">
                                <label style="font-weight: 500; color: #4f46e5; min-width: 20px;">${String.fromCharCode(97 + i)})</label>
                                <input type="text" id="edit-option-${i}" value="${option}" class="form-input" style="flex: 1;">
                            </div>
                        `).join('')}
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeEditModal()" class="btn btn-secondary">Cancelar</button>
                        <button onclick="saveEditedQuestion(${index})" class="btn btn-primary">Guardar Cambios</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeEditModal();
                }
            });
        }

        function closeEditModal() {
            const modal = document.getElementById('edit-modal');
            if (modal) {
                modal.remove();
            }
        }

        function saveEditedQuestion(index) {
            try {
                const questionText = document.getElementById('edit-question-text').value.trim();
                const options = [];
                
                for (let i = 0; i < 4; i++) {
                    const optionInput = document.getElementById(`edit-option-${i}`);
                    if (optionInput) {
                        const optionText = optionInput.value.trim();
                        if (optionText) {
                            options.push(optionText);
                        }
                    }
                }

                const correctAnswerRadio = document.querySelector('input[name="correct-answer"]:checked');
                const correctAnswer = correctAnswerRadio ? parseInt(correctAnswerRadio.value) : 0;

                let selectedTopicId = null;
                const topicSelect = document.getElementById('edit-question-topic');
                if (topicSelect && topicSelect.value) {
                    selectedTopicId = topicSelect.value;
                }

                if (!questionText) {
                    alert('La pregunta no puede estar vac√≠a');
                    return;
                }

                if (options.length < 2) {
                    alert('Debe haber al menos 2 opciones de respuesta');
                    return;
                }

                if (correctAnswer >= options.length) {
                    alert('Selecciona una respuesta correcta v√°lida');
                    return;
                }

                questions[index] = {
                    ...questions[index],
                    question: questionText,
                    options: options,
                    correctAnswer: correctAnswer,
                    topicId: selectedTopicId
                };

                localStorage.setItem('questions', JSON.stringify(questions));

                closeEditModal();
                currentTab = 'questions';
                renderApp();
                
                showSuccess('¬°Pregunta actualizada exitosamente!');

            } catch (error) {
                showError(`Error al guardar: ${error.message}`);
            }
        }

        // Funciones del test
        function startRandomTest() {
            let availableQuestions = questions;
            const selectedTestType = document.querySelector('input[name="test-type"]:checked');
            
            if (selectedTestType && selectedTestType.value !== 'all') {
                availableQuestions = questions.filter(q => q.topicId == selectedTestType.value);
            }

            if (availableQuestions.length === 0) {
                showError('No hay preguntas disponibles para el tipo de test seleccionado');
                return;
            }

            const shuffled = [...availableQuestions].sort(() => Math.random() - 0.5);
            currentTest = {
                questions: shuffled.slice(0, Math.min(10, availableQuestions.length)),
                currentQuestion: 0,
                answers: {},
                timeLeft: 600,
                timer: null,
                testType: selectedTestType ? selectedTestType.value : 'all'
            };
            
            currentTest.timer = setInterval(() => {
                currentTest.timeLeft--;
                if (currentTest.timeLeft <= 0) {
                    finishTest();
                } else {
                    const timerElement = document.getElementById('timer');
                    if (timerElement) {
                        timerElement.textContent = `‚è±Ô∏è ${formatTime(currentTest.timeLeft)}`;
                    }
                }
            }, 1000);
            
            currentTab = 'test';
            renderApp();
        }

        function selectAnswer(answerIndex) {
            currentTest.answers[currentTest.currentQuestion] = answerIndex;
        }

        function previousQuestion() {
            if (currentTest.currentQuestion > 0) {
                currentTest.currentQuestion--;
                currentTab = 'test';
                renderApp();
            }
        }

        function nextQuestion() {
            if (currentTest.currentQuestion === currentTest.questions.length - 1) {
                finishTest();
            } else {
                currentTest.currentQuestion++;
                currentTab = 'test';
                renderApp();
            }
        }

        function finishTest() {
            clearInterval(currentTest.timer);
            
            let correct = 0;
            currentTest.questions.forEach((q, i) => {
                if (currentTest.answers[i] === q.correctAnswer) {
                    correct++;
                }
            });
            
            const percentage = Math.round((correct / currentTest.questions.length) * 100);
            
            let testTypeText = 'Test General';
            if (currentTest.testType !== 'all') {
                const topicName = getTopicName(currentTest.testType);
                testTypeText = `Test de ${topicName}`;
            }
            
            alert(`${testTypeText} completado!\n\nRespuestas correctas: ${correct}/${currentTest.questions.length}\nPorcentaje: ${percentage}%`);
            
            currentTest = null;
            currentTab = 'test';
            renderApp();
        }

        // Funciones de utilidad
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function showSuccess(message) {
            const element = document.getElementById('success-message');
            if (element) {
                element.className = 'success-message';
                element.textContent = message;
                element.style.display = 'block';
                setTimeout(() => element.style.display = 'none', 5000);
            }
        }

        function showError(message) {
            const element = document.getElementById('error-message');
            if (element) {
                element.className = 'error-message';
                element.textContent = message;
                element.style.display = 'block';
                setTimeout(() => element.style.display = 'none',
